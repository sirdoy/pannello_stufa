# Requirements Archive: v1.0 Push Notifications System

**Archived:** 2026-01-26
**Status:** ✅ SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: Pannello Stufa - Push Notifications

**Defined:** 2026-01-23
**Core Value:** Dispositivi riconosciuti automaticamente dopo riavvio browser, notifiche arrivano sempre (100% delivery rate).

## v1 Requirements

Requirements for production-grade push notification system. Each maps to roadmap phases.

### Token Management

- [x] **TOKEN-01**: Token FCM persiste automaticamente dopo chiusura browser e riavvio — ✅ v1.0 (Phase 1)
- [x] **TOKEN-02**: Sistema verifica validità token all'avvio app e lo rigenera se necessario (refresh mensile minimo) — ✅ v1.0 (Phase 1)
- [x] **TOKEN-03**: Token invalidati vengono automaticamente rimossi dal database (on FCM NotRegistered error) — ✅ v1.0 (Phase 1)
- [x] **TOKEN-04**: Cleanup automatico token inattivi > 90 giorni (stale token detection) — ✅ v1.0 (Phase 1)
- [x] **TOKEN-05**: Supporto multi-device: utente riceve notifiche su tutti i dispositivi registrati — ✅ v1.0 (Phase 1)
- [x] **TOKEN-06**: Device fingerprinting: ogni dispositivo identificato univocamente (hash userAgent + platform) — ✅ v1.0 (Phase 1)

### Monitoring & Observability

- [x] **MONITOR-01**: Tracking delivery status: Sent/Delivered/Displayed per ogni notifica — ✅ v1.0 (Phase 2)
- [x] **MONITOR-02**: Error logging: fallimenti FCM salvati in Firebase con timestamp e device info — ✅ v1.0 (Phase 2)
- [x] **MONITOR-03**: Dashboard admin con metriche delivery rate (target 85%+) — ✅ v1.0 (Phase 2)
- [x] **MONITOR-04**: Lista dispositivi attivi con status (Active/Invalid/Revoked) e last-used timestamp — ✅ v1.0 (Phase 2)
- [x] **MONITOR-05**: Test send capability: admin può inviare notifica di test a dispositivo specifico — ✅ v1.0 (Phase 2)
- [x] **MONITOR-06**: Visualizzazioni Recharts: delivery rate charts, error trends, device activity — ✅ v1.0 (Phase 2)

### User Preferences

- [x] **PREF-01**: Controlli granulari per tipo notifica (scheduler, errors, maintenance) — ✅ v1.0 (Phase 3)
- [x] **PREF-02**: Do Not Disturb hours: utente imposta ore silenziose con timezone awareness — ✅ v1.0 (Phase 3)
- [x] **PREF-03**: Rate limiting: max 1 notifica per categoria ogni 5 minuti (previene spam) — ✅ v1.0 (Phase 3)
- [x] **PREF-04**: Preferenze sincronizzate tra tutti i dispositivi utente — ✅ v1.0 (Phase 3)
- [x] **PREF-05**: Default conservativi: solo CRITICAL + ERROR enabled inizialmente — ✅ v1.0 (Phase 3)

### Notification History

- [x] **HIST-01**: Storage cronologia notifiche in Firestore (30-90 giorni retention) — ✅ v1.0 (Phase 2, Phase 4)
- [x] **HIST-02**: UI in-app inbox: utente vede cronologia notifiche ricevute — ✅ v1.0 (Phase 4)
- [x] **HIST-03**: Paginazione: infinite scroll con 50 items per pagina — ✅ v1.0 (Phase 4)
- [x] **HIST-04**: Filtri: per data, tipo notifica, delivery status — ✅ v1.0 (Phase 4)
- [x] **HIST-05**: Auto-cleanup notifiche > 90 giorni per GDPR compliance — ✅ v1.0 (Phase 4)

### Device Management

- [x] **DEVICE-01**: Device naming: utente può etichettare dispositivi ("Kitchen iPad", "Bedroom Phone") — ✅ v1.0 (Phase 4)
- [x] **DEVICE-02**: Device status tracking: stato Active/Invalid/Revoked visibile in UI — ✅ v1.0 (Phase 4)
- [x] **DEVICE-03**: Remove device: utente può de-registrare dispositivo specifico — ✅ v1.0 (Phase 4)
- [x] **DEVICE-04**: Device list UI: utente vede tutti dispositivi registrati con last-used timestamp — ✅ v1.0 (Phase 4)

### Testing & Validation

- [x] **TEST-01**: Pannello admin per test notifications — ✅ v1.0 (Phase 2, Phase 5)
- [x] **TEST-02**: Selezione target: test su singolo dispositivo o broadcast a tutti — ✅ v1.0 (Phase 2)
- [x] **TEST-03**: Verifica delivery immediata con feedback visivo — ✅ v1.0 (Phase 2)
- [x] **TEST-04**: Playwright E2E tests per service worker lifecycle — ✅ v1.0 (Phase 5)

### Integration & Infrastructure

- [x] **INFRA-01**: Firestore per notification history (queries complesse) — ✅ v1.0 (Phase 2, Phase 4)
- [x] **INFRA-02**: Realtime Database per FCM tokens (bassa latency) — ✅ v1.0 (Phase 1)
- [x] **INFRA-03**: React Hook Form + Zod per validation preferences — ✅ v1.0 (Phase 3)
- [x] **INFRA-04**: Recharts per dashboard visualizations — ✅ v1.0 (Phase 2)
- [x] **INFRA-05**: date-fns per timestamp formatting — ✅ v1.0 (Phase 2, Phase 4)
- [x] **INFRA-06**: Cron job settimanale per token cleanup automation — ✅ v1.0 (Phase 5, operational setup pending)

## v2 Requirements

Deferred to future release. Tracked but not in current roadmap.

### Advanced Analytics

- **ANALYTICS-01**: Real-Time Delivery Dashboard (HIGH complexity, requires BigQuery + WebSocket)
- **ANALYTICS-02**: Delivery Rate Trends (needs 90+ days data volume)
- **ANALYTICS-03**: Notification Categories visual grouping
- **ANALYTICS-04**: User engagement metrics (open rate, dismiss rate)

### Enhanced User Experience

- **UX-01**: Custom notification sounds per type (browser API limitations)
- **UX-02**: Notification editing/recall capability (FCM doesn't support)
- **UX-03**: Rich media notifications (images, videos)
- **UX-04**: Interactive notification actions (buttons, quick reply)

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Real-Time Read Receipts | Privacy concerns + battery drain, not core value |
| Unlimited History Retention | Database bloat + GDPR liability (90-day max sufficient) |
| Silent Background Sync | iOS PWA unsupported, unreliable cross-platform |
| Guaranteed Delivery | FCM doesn't guarantee delivery, creates false expectations |
| Custom notification sounds (per-device) | Browser API limitations, inconsistent support |
| Email notifications fallback | Out of scope, focus on push only |
| SMS notifications fallback | Cost prohibitive, not needed |
| Notification scheduling by users | Scheduler already handles automated timing |
| Per-notification priority overrides | System-level DND handling sufficient |

## Traceability

Which phases cover which requirements. Final status after v1.0 completion.

| Requirement | Phase | Status |
|-------------|-------|--------|
| TOKEN-01 | Phase 1 | ✅ Complete |
| TOKEN-02 | Phase 1 | ✅ Complete |
| TOKEN-03 | Phase 1 | ✅ Complete |
| TOKEN-04 | Phase 1 | ✅ Complete |
| TOKEN-05 | Phase 1 | ✅ Complete |
| TOKEN-06 | Phase 1 | ✅ Complete |
| MONITOR-01 | Phase 2 | ✅ Complete |
| MONITOR-02 | Phase 2 | ✅ Complete |
| MONITOR-03 | Phase 2 | ✅ Complete |
| MONITOR-04 | Phase 2 | ✅ Complete |
| MONITOR-05 | Phase 2 | ✅ Complete |
| MONITOR-06 | Phase 2 | ✅ Complete |
| PREF-01 | Phase 3 | ✅ Complete |
| PREF-02 | Phase 3 | ✅ Complete |
| PREF-03 | Phase 3 | ✅ Complete |
| PREF-04 | Phase 3 | ✅ Complete |
| PREF-05 | Phase 3 | ✅ Complete |
| HIST-01 | Phase 2, Phase 4 | ✅ Complete |
| HIST-02 | Phase 4 | ✅ Complete |
| HIST-03 | Phase 4 | ✅ Complete |
| HIST-04 | Phase 4 | ✅ Complete |
| HIST-05 | Phase 4 | ✅ Complete |
| DEVICE-01 | Phase 4 | ✅ Complete |
| DEVICE-02 | Phase 4 | ✅ Complete |
| DEVICE-03 | Phase 4 | ✅ Complete |
| DEVICE-04 | Phase 4 | ✅ Complete |
| TEST-01 | Phase 2, Phase 5 | ✅ Complete |
| TEST-02 | Phase 2 | ✅ Complete |
| TEST-03 | Phase 2 | ✅ Complete |
| TEST-04 | Phase 5 | ✅ Complete |
| INFRA-01 | Phase 2, Phase 4 | ✅ Complete |
| INFRA-02 | Phase 1 | ✅ Complete |
| INFRA-03 | Phase 3 | ✅ Complete |
| INFRA-04 | Phase 2 | ✅ Complete |
| INFRA-05 | Phase 2, Phase 4 | ✅ Complete |
| INFRA-06 | Phase 5 | ✅ Complete (operational setup pending) |

**Coverage:**
- v1 requirements: 31 total
- Shipped in v1.0: 31 (100%)
- Unmapped: 0

**Phase Distribution:**
- Phase 1 (Token Lifecycle Foundation): 7 requirements
- Phase 2 (Production Monitoring Infrastructure): 9 requirements
- Phase 3 (User Preferences & Control): 6 requirements
- Phase 4 (Notification History & Devices): 11 requirements
- Phase 5 (Automation & Testing): 5 requirements

---

## Milestone Summary

**Shipped:** 31 of 31 v1 requirements (100%)

**Adjusted During Implementation:**
- PREF-05: Default approach changed from "CRITICAL + ERROR only" to "Alerts + System enabled" for better balance (validated during Phase 3)
- INFRA-01: Originally planned for Firestore only, extended to Phase 4 for history UI integration

**Dropped:** None

**Scope Changes:**
- Phase 3: Database migrated from Firestore to RTDB for architectural consistency (better aligns with existing project structure)
- Phase 5: INFRA-06 implementation complete but requires operational setup (cron-job.org configuration, 15-30 min user action)

**Technical Debt:**
- Cron automation endpoint ready but not operational (user setup required)
- Rate limiter in-memory only (consider Redis for multi-instance deployments in v2)
- E2E Auth0 mock is placeholder (acceptable for v1, improve in v2)
- Firestore indexes require manual deployment command

**Success Metrics:**
- All 5 phase goals achieved
- 23/25 success criteria verified (92% - 2 operational gaps)
- 100% requirements coverage
- 100% cross-phase integration wired
- 4/4 E2E user flows complete
- 0 broken flows or orphaned code

---

*Requirements defined: 2026-01-23*
*Milestone completed: 2026-01-26*
*Archived: 2026-01-26 as part of v1.0 milestone completion*
