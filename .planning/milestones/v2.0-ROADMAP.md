# Milestone v2.0: Netatmo Complete Control & Stove Monitoring

**Status:** ✅ SHIPPED 2026-01-28
**Phases:** 6-10
**Total Plans:** 21

## Overview

Controllo completo del termostato Netatmo con gestione schedule settimanali e monitoring automatico della stufa per rilevare anomalie.

**Target features achieved:**
- Netatmo schedule management (visualizzare, switchare schedules, manual overrides)
- Stove-thermostat integration correction (setpoint override, not schedule modification)
- Stove health monitoring via cron (health check, state verification, error detection)
- Alerting system (dashboard + push notifications)

## Phases

### Phase 6: Netatmo Schedule API Infrastructure

**Goal**: Backend infrastructure for Netatmo schedule operations with caching and rate limiting
**Depends on**: Nothing (starts v2.0)
**Plans**: 3 plans

Plans:
- [x] 06-01: Firebase-based cache service with 5-minute TTL
- [x] 06-02: Per-user Netatmo API rate limiter (400/500 calls/hour)
- [x] 06-03: Schedule API routes (GET list, POST switch)

**Details:**

**Requirements covered**: SCHED-01, SCHED-02, SCHED-04, SCHED-05, SCHED-06, INFRA-01, INFRA-02

**Success Criteria** (what must be TRUE):
1. System can fetch current active weekly schedule from Netatmo API ✅
2. System can list all available pre-configured schedules for user's home ✅
3. System enforces 60-second minimum polling interval and tracks 500 calls/hour limit ✅
4. Schedule data caches in Firebase with 5-minute TTL to avoid rate limiting ✅
5. OAuth token refresh works atomically without invalidating active sessions ✅

**Delivered:**
- netatmoCacheService.js (121 lines) - Firebase RTDB cache with 5-minute TTL
- netatmoRateLimiter.js (212 lines) - Conservative 400/hr limit with 100 buffer
- app/api/netatmo/schedules/route.js (120 lines) - GET list + POST switch
- parseSchedules helper in netatmoApi.js - Filters undefined for Firebase
- 30+ unit/integration tests passing

**Completion:** 2026-01-27

---

### Phase 7: Stove Health Monitoring Backend

**Goal**: Automated stove health checks and monitoring infrastructure via cron
**Depends on**: Phase 6
**Plans**: 2 plans

Plans:
- [x] 07-01: Health check core logic and Firestore logging service
- [x] 07-02: Cron endpoint, dead man's switch, environment validation

**Details:**

**Requirements covered**: MONITOR-01, MONITOR-02, MONITOR-03, MONITOR-04, MONITOR-05, INFRA-03, INFRA-04, INFRA-05

**Success Criteria** (what must be TRUE):
1. System verifies stove connection status every minute via cron job ✅
2. System detects when stove is in unexpected state (scheduled ON but actually OFF) ✅
3. System logs all monitoring events to Firestore with timestamp and status ✅
4. Dead man's switch alerts if cron hasn't executed in 10+ minutes ✅
5. Cron execution logs include timestamp, duration, and success/failure status ✅

**Delivered:**
- healthMonitoring.js (310 lines) - Connection status, state mismatch detection, parallel fetching
- healthLogger.js (255 lines) - Firestore parent/subcollection logging with fire-and-forget
- healthDeadManSwitch.js (135 lines) - RTDB timestamp tracking, 10-min threshold alerting
- envValidator.js (115 lines) - Environment variable validation (dev/prod detection)
- app/api/health-monitoring/check/route.js (92 lines) - HMAC-secured cron endpoint
- 61 unit tests passing

**Completion:** 2026-01-27

---

### Phase 8: Stove-Thermostat Integration Correction

**Goal**: Verify and enhance stove-thermostat coordination using temporary setpoint overrides (not schedule modifications)
**Depends on**: Phase 7
**Plans**: 6 plans

Plans:
- [x] 08-01: Coordination state service and user preferences with Zod schema
- [x] 08-02: Debounce timer and global notification throttle services
- [x] 08-03: User intent detection and schedule-aware pause calculation
- [x] 08-04: Enhanced netatmoStoveSync with boost mode and setpoint restoration
- [x] 08-04b: Coordination orchestrator with full workflow integration
- [x] 08-05: Cron endpoint and Firestore event logging

**Details:**

**Requirements covered**: INTEG-01, INTEG-02, INTEG-03, INTEG-04, INTEG-05, INFRA-06

**Success Criteria** (what must be TRUE):
1. Stove ignition triggers temporary Netatmo setpoint boost without modifying underlying schedule ✅
2. User manual thermostat changes pause automation for 30 minutes (respect user intent) ✅
3. System applies 2-minute debouncing before triggering setpoint override (avoid rapid cycles) ✅
4. Multi-room thermostat zones coordinate properly when stove is active ✅
5. Alert deduplication prevents notification spam (max 1 per alert type per 30 minutes) ✅

**Delivered:**
- coordinationState.js (123 lines) - State management (stoveOn, automationPaused, pendingDebounce)
- coordinationPreferences.js (138 lines) - User preferences with Zod validation
- coordinationDebounce.js (248 lines) - 2-min timer with 30s retry on early shutoff
- coordinationNotificationThrottle.js (131 lines) - GLOBAL 30-min throttle window
- coordinationUserIntent.js (151 lines) - 0.5°C tolerance setpoint detection, mode tracking
- coordinationPauseCalculator.js (195 lines) - Schedule-aware pause (until next slot, not fixed 30min)
- coordinationOrchestrator.js (533 lines) - Complete workflow integration
- coordinationEventLogger.js (197 lines) - Firestore logging with fire-and-forget
- app/api/coordination/enforce/route.js (236 lines) - HMAC-secured cron endpoint
- netatmoStoveSync.js updated - setRoomsToBoostMode with mode='manual' + 8-hour endtime
- 130 coordination tests passing

**Completion:** 2026-01-27

---

### Phase 9: Schedule Management UI

**Goal**: User interface for viewing, switching schedules, and creating temporary overrides
**Depends on**: Phase 6
**Plans**: 5 plans

Plans:
- [x] 09-01: Schedule data hooks and helper utilities
- [x] 09-02: Weekly timeline visualization component
- [x] 09-03: Schedule page and selector dropdown
- [x] 09-04: Manual override bottom sheet with duration/temperature pickers
- [x] 09-05: Active override badge and navigation integration

**Details:**

**Requirements covered**: SCHED-01, SCHED-02, SCHED-03

**Success Criteria** (what must be TRUE):
1. User can view current active weekly schedule with day/time/temperature slots in dashboard ✅
2. User can switch between pre-configured schedules via dropdown selector ✅
3. User can create temporary override (manual boost) with duration picker (5 min to 12 hours) ✅
4. Schedule UI clearly distinguishes between permanent schedules and temporary overrides ✅

**Delivered:**
- useScheduleData hook (94 lines) - Schedule fetching with cache integration
- scheduleHelpers.js (180 lines) - parseTimelineSlots, tempToColor, formatters (20 tests passing)
- app/schedule/page.js (164 lines) - Main schedule management page
- ScheduleSelector component (112 lines) - Two-step change pattern (select → apply)
- WeeklyTimeline component (98 lines) - 7-day timeline with horizontal scroll
- TimelineSlot component (62 lines) - Color gradient, temperature text, hover tooltip
- ManualOverrideSheet component (179 lines) - Duration/temperature pickers, POST to setroomthermpoint
- DurationPicker (81 lines) - Logarithmic scale 5-720 min with snap-to-nice-values
- TemperaturePicker (86 lines) - +/- buttons, 5-30°C range, 0.5° steps
- ActiveOverrideBadge (128 lines) - Tap opens ConfirmDialog, cancel sends mode='home'
- Navigation link from /thermostat page
- WCAG 2.1 AA accessibility compliance (cyan-yellow-red gradient, 40px touch targets)

**Completion:** 2026-01-27

---

### Phase 10: Monitoring Dashboard & Alerts UI

**Goal**: Dashboard for stove health status with visual indicators and push notification alerts
**Depends on**: Phase 7
**Plans**: 5 plans

Plans:
- [x] 10-01: API routes for health monitoring (logs, stats, DMS status)
- [x] 10-02: Status cards (connection status, dead man's switch panel)
- [x] 10-03: Timeline & event components (infinite scroll, filters, expandable items)
- [x] 10-04: Monitoring page & navigation integration
- [x] 10-05: Health alert notification wiring (gap closure)

**Details:**

**Requirements covered**: MONITOR-01, MONITOR-04, MONITOR-05, Push Notifications (implicit)

**Success Criteria** (what must be TRUE):
1. User can view stove connection status (online/offline/last-seen) in dashboard ✅
2. Dashboard displays monitoring status with last check time and status indicator ✅
3. System triggers push notifications for critical health issues (connection lost, unexpected state) ✅
4. Monitoring history shows past 7 days of cron execution logs and issues ✅

**Delivered:**
- app/api/health-monitoring/logs/route.js (150 lines) - Cursor-based pagination
- app/api/health-monitoring/stats/route.js (65 lines) - 7-day aggregates
- app/api/health-monitoring/dead-man-switch/route.js (66 lines) - DMS status endpoint
- ConnectionStatusCard (147 lines) - Uptime %, status badge (≥95% online, ≥80% degraded, <80% offline)
- DeadManSwitchPanel (205 lines) - Cron health with 30-second auto-refresh
- EventFilters (68 lines) - Type/severity filtering
- HealthEventItem (132 lines) - Expandable accordion with check details
- MonitoringTimeline (213 lines) - Infinite scroll with MAX_EVENTS=200 memory safeguard
- app/monitoring/page.js (94 lines) - Main monitoring dashboard
- MONITORING in GLOBAL_SECTIONS - Cross-cutting concern navigation
- Health notification types (3 types: connection_lost, state_mismatch, stove_error)
- Cron notification integration with 30-minute throttle and fire-and-forget pattern
- 22 tests passing (15 UI + 7 notification)

**Completion:** 2026-01-28

---

## Milestone Summary

**Key Decisions:**

- 5-minute cache TTL balances schedule freshness with API rate limit prevention (Phase 6)
- Conservative 400 calls/hour limit provides 100-call safety buffer vs Netatmo's 500/hr (Phase 6)
- Promise.allSettled for parallel API fetching with graceful degradation (Phase 7)
- STARTING states have 15-min grace period to avoid false alerts during stove startup (Phase 7)
- Firestore parent/subcollection structure enables efficient queries (aggregated summary + drill-down) (Phase 7)
- 10-minute threshold for dead man's switch (10 missed cron runs = admin alert) (Phase 7)
- 2-minute debounce for stove ON events prevents premature coordination (Phase 8)
- 30-second retry timer for early shutoff handles quick stove restarts (Phase 8)
- GLOBAL 30-minute notification throttle across ALL coordination events (not per-type) (Phase 8)
- 0.5°C setpoint tolerance prevents false positives from Netatmo API rounding (Phase 8)
- Pause until next schedule slot (not fixed duration) respects user workflow (Phase 8)
- Temporary setpoint override with mode='manual' + 8-hour endtime preserves underlying schedule (Phase 8)
- Logarithmic duration picker scale (5-720 min) with snap-to-nice-values for UX (Phase 9)
- Cyan-yellow-red gradient for timeline visualization (colorblind accessibility) (Phase 9)
- Horizontal scroll for timeline (better mobile UX for day-view scanning) (Phase 9)
- Two-step schedule change (select → apply) prevents accidental switches (Phase 9)
- Cursor-based pagination for monitoring logs (same pattern as notifications/history) (Phase 10)
- 7-day default filter for logs balances relevance with completeness (Phase 10)
- Status thresholds: ≥95% online, ≥80% degraded, <80% offline (industry-standard uptime metrics) (Phase 10)
- Fire-and-forget notification pattern prevents blocking cron response (Phase 10)

**Issues Resolved:**

- Netatmo API rate limiting handled with conservative 400/hr limit and caching (Phase 6)
- Cache invalidation after schedule switch ensures frontend consistency (Phase 6)
- Dead man's switch timestamp updated FIRST before any logic that could fail (Phase 7)
- STARTING state grace period prevents false alerts during stove ignition (Phase 7)
- Environment validation logs warnings but continues (partial functionality better than complete failure) (Phase 7)
- User intent detection respects manual thermostat changes with schedule-aware pause (Phase 8)
- Debounce handles early shutoff with 30-second retry timer (Phase 8)
- Global notification throttle prevents spam across all coordination events (Phase 8)
- Multi-zone coordination with per-zone enabled flags and optional boost overrides (Phase 8)
- Schedule timeline correctly parses m_offset as minutes from Monday 00:00 (Phase 9)
- Manual override endtime calculated in SECONDS (not milliseconds) per Netatmo API (Phase 9)
- Active override badge tap opens confirmation dialog (prevents accidental cancellation) (Phase 9)
- Monitoring page added to global navigation sections (cross-cutting concern) (Phase 10)
- DMS polling interval (30 seconds) balances responsiveness with API load (Phase 10)
- Health alert notification triggering wired in cron with throttle integration (Phase 10)

**Technical Debt Incurred:**

- TODO: Track STARTING state entry time for grace period (Phase 7, low priority - manual observation sufficient)
- Warning: DMS polling continues when page backgrounded (Phase 10, should use Page Visibility API)
- Coordination orchestrator bypasses Netatmo rate limiter (low risk - single API call per minute, documented)

---

_For current project status, see .planning/ROADMAP.md_

_Archived: 2026-01-28 as part of v2.0 milestone completion_
