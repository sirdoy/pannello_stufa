# Milestone v3.2: Dashboard Customization & Weather

**Status:** SHIPPED 2026-02-03
**Phases:** 25-29
**Total Plans:** 13

## Overview

v3.2 adds weather display and dashboard customization to the Pannello Stufa PWA. Users can see outdoor weather conditions on the home page and reorder/hide cards to personalize their dashboard. The milestone builds foundational infrastructure (API, storage, geolocation), then layers UI components, then integrates everything on the home page.

## Phases

### Phase 25: Weather Foundation

**Goal**: Infrastructure for weather data and user preferences is operational
**Depends on**: Nothing (first phase of v3.2)
**Plans**: 3 plans

Plans:
- [x] 25-01-PLAN.md — Weather API client (Open-Meteo wrapper), cache utility, forecast route
- [x] 25-02-PLAN.md — Geolocation utility with iOS fallback, location service for Firebase
- [x] 25-03-PLAN.md — Dashboard preferences service, dashboard API route, weather cache tests

**Details:**
- Open-Meteo API wrapper with fetchWeatherForecast and WMO code interpretation
- In-memory weather cache with 15-minute TTL and stale-while-revalidate pattern
- Geolocation utility with 10-second timeout and iOS PWA error handling
- Location service for Firebase RTDB (client + server)
- Dashboard preferences service with DEFAULT_CARD_ORDER (5 cards)
- 5 unit tests for weather cache

**Completed:** 2026-02-02

### Phase 26: Weather Component

**Goal**: Users can view weather information in a card matching the existing design system
**Depends on**: Phase 25 (API route must exist)
**Plans**: 4 plans

Plans:
- [x] 26-01-PLAN.md — WeatherIcon component and weather helpers (WMO code mapping, temperature formatting)
- [x] 26-02-PLAN.md — WeatherCard core with CurrentConditions and Skeleton.WeatherCard
- [x] 26-03-PLAN.md — ForecastRow, ForecastDayCard, and ForecastDaySheet with bottom sheet details
- [x] 26-04-PLAN.md — Barrel export, integration, and visual verification

**Details:**
- WeatherIcon with 26 WMO code mappings, day/night variants, filled Lucide style
- CurrentConditions with temperature, feels like, details grid (humidity, wind, UV, AQI)
- Indoor/outdoor temperature comparison with Italian text
- ForecastRow with horizontal snap scroll, ForecastDayCard with high/low temps
- ForecastDaySheet bottom sheet with extended daily stats
- Skeleton.WeatherCard for loading state
- Error state with Italian message and retry button
- "Aggiornato X minuti fa" timestamp badge

**Completed:** 2026-02-02

### Phase 27: Location Settings

**Goal**: Users can configure their home location for weather display
**Depends on**: Phase 25 (geolocation utility), Phase 26 (WeatherCard shows location)
**Plans**: 3 plans

Plans:
- [x] 27-01-PLAN.md — Geocoding API routes and useDebounce hook
- [x] 27-02-PLAN.md — Location settings page with city search and geolocation
- [x] 27-03-PLAN.md — WeatherCard location display and temperature trend indicator

**Details:**
- Geocoding search API with Open-Meteo proxy (city autocomplete)
- Reverse geocoding API for coordinate-to-city lookup
- useDebounce hook with 300ms default
- LocationSearch component with autocomplete and geolocation
- Location settings page at /settings/location
- WeatherCard location name display in header
- Temperature trend indicator (TrendingUp/TrendingDown icons)
- getTemperatureTrend helper with 6-hour analysis, 1°C threshold

**Completed:** 2026-02-03

### Phase 28: Dashboard Customization

**Goal**: Users can personalize their home page card layout
**Depends on**: Nothing (parallel track)
**Plans**: 2 plans

Plans:
- [x] 28-01-PLAN.md — Per-user infrastructure: refactor API + service for user-specific storage, add menu item
- [x] 28-02-PLAN.md — Dashboard settings page with reorder and visibility controls

**Details:**
- Per-user dashboard preferences at users/${userId}/dashboardPreferences
- Dashboard settings page at /settings/dashboard
- Up/down buttons for card reordering with array swap logic
- Switch toggles for card visibility
- Save to Firebase RTDB with adminDbSet
- Menu entry "Personalizza home" in settings menu

**Completed:** 2026-02-03

### Phase 29: Home Page Integration

**Goal**: Home page renders cards according to user's saved preferences
**Depends on**: Phase 26 (WeatherCard exists), Phase 28 (dashboard preferences exist)
**Plans**: 1 plan

Plans:
- [x] 29-01-PLAN.md — WeatherCardWrapper + home page card rendering from dashboard preferences

**Details:**
- WeatherCardWrapper client component with location subscription and weather fetch
- CARD_COMPONENTS registry mapping card IDs to React components
- Server-side preferences fetch via adminDbGet (faster than API route)
- Card filtering by visibility (visible !== false)
- Fallback to DEFAULT_CARD_ORDER for new users
- Net -18 lines through registry pattern refactor

**Completed:** 2026-02-03

---

## Milestone Summary

**Key Decisions:**

- Open-Meteo API for weather (free, no API key required)
- In-memory cache with 15-minute TTL (no Redis needed for single-instance)
- Stale-while-revalidate pattern for seamless UX
- Firebase RTDB for dashboard preferences (not localStorage - iOS eviction)
- Menu-based reordering (up/down buttons, not drag-drop - simpler, more accessible)
- Per-user preferences at users/${userId} path
- Server-side preferences fetch for performance
- Client wrapper pattern for cards needing real-time data

**Issues Resolved:**

- iOS PWA geolocation hanging resolved with 10s timeout
- Weather cache key collisions prevented with 4-decimal coordinate precision
- Home page rendering simplified with registry pattern

**Issues Deferred:**

- Drag-drop reordering (DASH-F01) - future enhancement
- Weather alerts (WEATHER-F02) - future milestone
- Hourly forecast (WEATHER-F01) - future milestone

**Technical Debt Incurred:**

- None

---

_For current project status, see .planning/PROJECT.md_
