---
phase: 63-wan-status-device-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/network/types.ts
  - app/network/components/WanStatusCard.tsx
  - app/network/components/CopyableIp.tsx
  - app/network/__tests__/components/WanStatusCard.test.tsx
  - app/network/__tests__/components/CopyableIp.test.tsx
autonomous: true

must_haves:
  truths:
    - "User can see WAN connection status badge (online/offline)"
    - "User can see external IP address with copy-to-clipboard button"
    - "User can see uptime, gateway, DNS, and connection type info"
    - "Copy button shows visual checkmark feedback after copying"
  artifacts:
    - path: "app/network/components/WanStatusCard.tsx"
      provides: "WAN status card with InfoBox grid"
      min_lines: 60
    - path: "app/network/components/CopyableIp.tsx"
      provides: "Clipboard copy with visual feedback"
      min_lines: 25
    - path: "app/components/devices/network/types.ts"
      provides: "Extended WanData and DeviceData types"
      contains: "dns"
  key_links:
    - from: "app/network/components/WanStatusCard.tsx"
      to: "app/components/devices/network/types.ts"
      via: "WanData import"
      pattern: "import.*WanData.*from.*types"
    - from: "app/network/components/WanStatusCard.tsx"
      to: "app/network/components/CopyableIp.tsx"
      via: "CopyableIp import"
      pattern: "import.*CopyableIp"
---

<objective>
Build the WAN status card component with full connection details and clipboard copy functionality for the external IP address.

Purpose: Satisfies WAN-01 (external IP with copy), WAN-02 (WAN status with uptime), WAN-03 (DNS/connection type info). These are the top section of the /network page.

Output: WanStatusCard, CopyableIp components + extended types + unit tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-wan-status-device-list/63-RESEARCH.md

@app/components/devices/network/types.ts
@app/components/ui/InfoBox.tsx
@app/components/ui/Badge.tsx
@app/components/ui/Card.tsx
@app/components/ui/index.ts
@lib/fritzbox/fritzboxClient.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend network types and build CopyableIp component</name>
  <files>
    app/components/devices/network/types.ts
    app/network/components/CopyableIp.tsx
    app/network/__tests__/components/CopyableIp.test.tsx
  </files>
  <action>
**Step 1: Extend types in `app/components/devices/network/types.ts`**

Add missing fields to WanData and DeviceData needed by the /network page:

```typescript
// WanData — add these optional fields after linkSpeed:
dns?: string;             // DNS server(s), e.g. "8.8.8.8, 8.8.4.4"
gateway?: string;         // Default gateway IP
connectionType?: string;  // 'DHCP' | 'PPPoE' | 'Static'
```

```typescript
// DeviceData — add these optional fields after type:
bandwidth?: number;    // Mbps (may not be available yet)
lastSeen?: number;     // Unix timestamp ms when last active
```

These are optional fields so existing code won't break. The Fritz!Box API may or may not provide them; the UI will show "N/A" or fallback values when missing.

**Step 2: Create `app/network/components/CopyableIp.tsx`**

Create directory `app/network/components/` first.

Implement CopyableIp component:
- Props: `{ ip: string }`
- 'use client' directive
- Use `navigator.clipboard.writeText(ip)` on click with try/catch
- State: `copied` boolean, defaults false
- On successful copy: set `copied = true`, `setTimeout(() => setCopied(false), 2000)`
- Visual: show IP in `font-mono text-slate-100` with a button next to it
- Button shows `Copy` icon (from lucide-react) normally, switches to `Check` icon with `text-sage-400` when copied
- Button has `aria-label` that changes between "Copia IP" and "IP copiato"
- Use `Button` from design system with `variant="ghost"` and `size="sm"`
- Handle clipboard errors gracefully (just console.error, don't crash)

**Step 3: Create `app/network/__tests__/components/CopyableIp.test.tsx`**

Create directory `app/network/__tests__/components/` first.

Tests:
- Renders IP text correctly
- Calls navigator.clipboard.writeText on button click (mock clipboard API)
- Shows Check icon and "IP copiato" aria-label after successful copy
- Reverts to Copy icon after 2s (use jest.advanceTimersByTime)
- Handles clipboard error gracefully without throwing
  </action>
  <verify>
    `npx tsc --noEmit` passes with no new errors.
    `npx jest app/network/__tests__/components/CopyableIp.test.tsx --passWithNoTests` passes.
  </verify>
  <done>
    CopyableIp component renders IP with working copy-to-clipboard and visual feedback.
    WanData type extended with dns, gateway, connectionType fields.
    DeviceData type extended with bandwidth, lastSeen fields.
    All existing tests still pass (types are backward-compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Build WanStatusCard component with tests</name>
  <files>
    app/network/components/WanStatusCard.tsx
    app/network/__tests__/components/WanStatusCard.test.tsx
  </files>
  <action>
**Create `app/network/components/WanStatusCard.tsx`**

'use client' directive. Import from design system: Card, InfoBox, Badge, Text. Import CopyableIp from './CopyableIp'. Import WanData from network types.

Props interface:
```typescript
interface WanStatusCardProps {
  wan: WanData | null;
  isStale: boolean;
  lastUpdated: number | null;
}
```

Implementation:
1. If `wan` is null, return null (data not loaded yet).

2. **Status banner** (full-width colored bar at top of card):
   - Green background (`bg-sage-500/20 border border-sage-500/40`) when `wan.connected` is true
   - Red background (`bg-danger-500/20 border border-danger-500/40`) when false
   - Contains Badge with `variant="sage"` or `variant="danger"` showing "WAN Online" or "WAN Offline"
   - If stale, show "Aggiornato X fa" text using `formatDistanceToNow` from date-fns with Italian locale (`import { it } from 'date-fns/locale'`)
   - Claude's discretion on WAN offline: use red badge only (not full-width banner) — the colored background already communicates severity

3. **External IP section** below banner:
   - Label: "IP Esterno" in `text-sm text-slate-400 uppercase tracking-wide`
   - CopyableIp component with `ip={wan.externalIp || 'N/A'}`

4. **InfoBox grid** — 2 columns (`grid grid-cols-2 gap-3`):
   - Uptime: icon "clock emoji", label "Uptime", value formatted as:
     - days > 0: `${days}g ${hours}h`
     - hours > 0: `${hours}h ${minutes}m`
     - else: `${minutes}m`
     - Create local `formatUptime(seconds: number): string` function
     - variant="sage"
   - Gateway: icon "globe emoji", label "Gateway", value `wan.gateway || 'N/A'`, variant="ocean"
   - DNS: icon "satellite emoji", label "DNS", value `wan.dns || 'Auto'`, variant="ocean"
   - Connection type: icon "link emoji", label "Tipo", value `wan.connectionType || 'DHCP'`, variant="neutral"

5. Wrap everything in `<Card variant="elevated" className="space-y-4 p-4 sm:p-6">`.

**Create `app/network/__tests__/components/WanStatusCard.test.tsx`**

Tests:
- Returns null when wan is null
- Shows "WAN Online" badge with sage variant when connected
- Shows "WAN Offline" badge with danger variant when disconnected
- Shows external IP with CopyableIp
- Shows formatted uptime (test with 90061 seconds = 1g 1h)
- Shows gateway value, falls back to "N/A"
- Shows DNS value, falls back to "Auto"
- Shows connection type, falls back to "DHCP"
- Shows staleness indicator when isStale=true and lastUpdated is provided
  </action>
  <verify>
    `npx tsc --noEmit` passes with no new errors.
    `npx jest app/network/__tests__/components/WanStatusCard.test.tsx --passWithNoTests` passes.
  </verify>
  <done>
    WanStatusCard shows WAN connection status badge, external IP with copy button, uptime, gateway, DNS, and connection type in InfoBox grid.
    All 8+ tests passing. Component handles null/missing data gracefully with fallback values.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no new TypeScript errors
2. `npx jest app/network/ --passWithNoTests` — all tests pass
3. WanStatusCard renders with mock WanData showing all 6 fields
4. CopyableIp clipboard mock works in test environment
5. Extended types are backward-compatible (no breaks in Phase 62 code)
</verification>

<success_criteria>
- WanStatusCard component exists with full WAN details display
- CopyableIp component exists with clipboard + visual feedback
- WanData/DeviceData types extended with new optional fields
- 12+ unit tests passing
- Requirements WAN-01, WAN-02, WAN-03 satisfied at component level
</success_criteria>

<output>
After completion, create `.planning/phases/63-wan-status-device-list/63-01-SUMMARY.md`
</output>
