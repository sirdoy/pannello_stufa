---
phase: 63-wan-status-device-list
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/network/components/DeviceStatusBadge.tsx
  - app/network/components/DeviceListTable.tsx
  - app/network/__tests__/components/DeviceStatusBadge.test.tsx
  - app/network/__tests__/components/DeviceListTable.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees device list with name, IP, MAC, online/offline status, and bandwidth columns"
    - "Online devices appear above offline devices in the list"
    - "User can sort device list by any column"
    - "User can search devices by name, IP, or MAC address"
    - "Device list paginated at 25 per page"
    - "Offline devices show last seen timestamp"
  artifacts:
    - path: "app/network/components/DeviceListTable.tsx"
      provides: "DataTable wrapper with columns, search, sort, pagination"
      min_lines: 80
    - path: "app/network/components/DeviceStatusBadge.tsx"
      provides: "Online/offline badge with last seen timestamp"
      min_lines: 25
  key_links:
    - from: "app/network/components/DeviceListTable.tsx"
      to: "app/components/ui/DataTable.tsx"
      via: "DataTable import"
      pattern: "import.*DataTable.*from.*ui"
    - from: "app/network/components/DeviceListTable.tsx"
      to: "app/network/components/DeviceStatusBadge.tsx"
      via: "cell renderer import"
      pattern: "import.*DeviceStatusBadge"
    - from: "app/network/components/DeviceListTable.tsx"
      to: "app/components/devices/network/types.ts"
      via: "DeviceData import"
      pattern: "import.*DeviceData.*from.*types"
---

<objective>
Build the device list table component with search, sort, pagination, and online/offline status badges with "last seen" timestamps.

Purpose: Satisfies DEV-01 (device list), DEV-02 (column sorting), DEV-03 (search/filter), DEV-04 (pagination), DEV-05 (last seen timestamp). This is the bottom section of the /network page.

Output: DeviceListTable, DeviceStatusBadge components + unit tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-wan-status-device-list/63-RESEARCH.md

@app/components/devices/network/types.ts
@app/components/ui/DataTable.tsx
@app/components/ui/DataTableToolbar.tsx
@app/components/ui/Badge.tsx
@app/components/ui/Text.tsx
@app/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build DeviceStatusBadge component with tests</name>
  <files>
    app/network/components/DeviceStatusBadge.tsx
    app/network/__tests__/components/DeviceStatusBadge.test.tsx
  </files>
  <action>
**Create `app/network/components/DeviceStatusBadge.tsx`**

'use client' directive. Import Badge from design system. Import `formatDistanceToNow` from 'date-fns' and `{ it }` from 'date-fns/locale'.

Props interface:
```typescript
interface DeviceStatusBadgeProps {
  active: boolean;
  lastSeen?: number;  // Unix timestamp ms
}
```

Implementation:
- **Online state:** Return `<Badge variant="sage" size="sm">Online</Badge>`
  - Claude's discretion: use badge chip style (not dot+text) — consistent with NetworkCard badges
- **Offline state:** Return a vertical flex container with:
  1. `<Badge variant="danger" size="sm">Offline</Badge>`
  2. If `lastSeen` exists: `<span className="text-xs text-slate-400">Visto {formatDistanceToNow(new Date(lastSeen), { addSuffix: true, locale: it })}</span>`
  3. If no `lastSeen`: `<span className="text-xs text-slate-500">Mai connesso</span>`
  - Claude's discretion on "Last seen" format: use relative only (`formatDistanceToNow`) — simpler and more human-readable than absolute+relative

**Create `app/network/__tests__/components/DeviceStatusBadge.test.tsx`**

Tests:
- Shows "Online" badge with sage variant when active=true
- Shows "Offline" badge with danger variant when active=false
- Shows relative "last seen" text when active=false and lastSeen provided
- Shows "Mai connesso" when active=false and no lastSeen
- Does NOT show last seen text when active=true (even if lastSeen provided)
  </action>
  <verify>
    `npx tsc --noEmit` passes with no new errors.
    `npx jest app/network/__tests__/components/DeviceStatusBadge.test.tsx --passWithNoTests` passes.
  </verify>
  <done>
    DeviceStatusBadge renders online badge or offline badge with relative "last seen" timestamp.
    All 5 tests passing. Italian locale used for date formatting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build DeviceListTable component with DataTable integration and tests</name>
  <files>
    app/network/components/DeviceListTable.tsx
    app/network/__tests__/components/DeviceListTable.test.tsx
  </files>
  <action>
**Create `app/network/components/DeviceListTable.tsx`**

'use client' directive. Import from React: useMemo. Import DataTable from '@/app/components/ui'. Import type ColumnDef from '@tanstack/react-table'. Import DeviceStatusBadge. Import DeviceData from network types. Import Card, Heading, Text from design system.

Props interface:
```typescript
interface DeviceListTableProps {
  devices: DeviceData[];
  isStale: boolean;
}
```

Implementation:

1. **Column definitions** (useMemo, no deps):
   Define `columns: ColumnDef<DeviceData>[]`:

   - **Name column:** `accessorKey: 'name'`, header: 'Nome', `enableSorting: true`, `enableGlobalFilter: true`. Cell renderer: show `row.original.name` in `font-medium` — if name is empty or equals IP, show IP only.

   - **IP column:** `accessorKey: 'ip'`, header: 'Indirizzo IP', `enableSorting: true`, `enableGlobalFilter: true`. Cell: `<span className="font-mono text-sm text-slate-400">{row.original.ip}</span>`.

   - **MAC column:** `accessorKey: 'mac'`, header: 'MAC', `enableSorting: true`, `enableGlobalFilter: true`. Cell: `<span className="font-mono text-xs text-slate-500">{row.original.mac}</span>`.

   - **Status column:** `accessorKey: 'active'`, header: 'Stato', `enableSorting: true`, `enableGlobalFilter: false`. Cell: `<DeviceStatusBadge active={row.original.active} lastSeen={row.original.lastSeen} />`. **Sort function:** sort by boolean (online first) — use `sortingFn: (rowA, rowB) => { ... }` where active=true sorts before active=false.

   - **Bandwidth column:** `accessorKey: 'bandwidth'`, header: 'Banda', `enableSorting: true`, `enableGlobalFilter: false`. Cell: show `${row.original.bandwidth || 0} Mbps` — format to 1 decimal if > 0, show "-" if null/undefined/0.

2. **Sort devices** (useMemo, [devices]):
   Pre-sort: online devices first (`active === true`), then offline. Secondary sort: alphabetical by name (using `localeCompare('it')`).

3. **Render:**
   Wrap in `<Card variant="elevated" className="p-4 sm:p-6 space-y-4">`:
   - Header: `<Heading level={2} size="lg">Dispositivi</Heading>` with a count badge showing total device count
   - DataTable with props:
     - `columns={columns}`
     - `data={sortedDevices}`
     - `enableFiltering={true}` (enables search toolbar)
     - `enablePagination={true}`
     - `pageSize={25}`
     - `density="default"`
     - `striped={true}`
     - `variant="default"`
   - Claude's discretion: Add status filter tabs (All/Online/Offline) above the search bar using a simple `useState` filter. Three text buttons, selected one highlighted with ember underline. Filters the data array before passing to DataTable. This is a small addition that significantly improves UX alongside search.

**Create `app/network/__tests__/components/DeviceListTable.test.tsx`**

Mock the DataTable component to avoid TanStack Table setup complexity in unit tests:
```typescript
jest.mock('@/app/components/ui', () => ({
  ...jest.requireActual('@/app/components/ui'),
  DataTable: jest.fn(({ data, columns, enableFiltering, enablePagination, pageSize }) => (
    <div data-testid="data-table" data-rows={data.length} data-columns={columns.length} data-filtering={enableFiltering} data-pagination={enablePagination} data-page-size={pageSize}>
      {data.map((d: any, i: number) => <div key={i} data-testid={`row-${i}`} data-name={d.name} data-active={d.active} />)}
    </div>
  )),
}));
```

Tests:
- Renders DataTable with enableFiltering=true and enablePagination=true and pageSize=25
- Passes all 5 columns to DataTable
- Sorts online devices before offline devices in the data array
- Handles empty device list (passes empty array to DataTable)
- Shows "Dispositivi" heading with device count
- Name, IP, MAC columns have enableGlobalFilter=true (verify column definitions)
- Status and bandwidth columns have enableGlobalFilter=false
  </action>
  <verify>
    `npx tsc --noEmit` passes with no new errors.
    `npx jest app/network/__tests__/components/DeviceListTable.test.tsx --passWithNoTests` passes.
  </verify>
  <done>
    DeviceListTable renders DataTable with 5 columns (name, IP, MAC, status, bandwidth), search on name/IP/MAC, sorting on all columns, pagination at 25/page.
    Online devices sorted above offline. Status filter tabs provide All/Online/Offline quick filtering.
    All 7+ tests passing.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no new TypeScript errors
2. `npx jest app/network/ --passWithNoTests` — all tests pass
3. DeviceListTable renders 5 columns with correct headers
4. DeviceStatusBadge shows Italian "Visto X fa" for offline devices
5. Pre-sorting places online devices above offline
6. DataTable configured with enableFiltering, enablePagination, pageSize=25
</verification>

<success_criteria>
- DeviceListTable component exists with full DataTable integration
- DeviceStatusBadge component exists with online/offline + last seen display
- Search works on name, IP, MAC columns
- Sorting enabled on all 5 columns
- Pagination set to 25 per page
- 12+ unit tests passing
- Requirements DEV-01 through DEV-05 satisfied at component level
</success_criteria>

<output>
After completion, create `.planning/phases/63-wan-status-device-list/63-02-SUMMARY.md`
</output>
