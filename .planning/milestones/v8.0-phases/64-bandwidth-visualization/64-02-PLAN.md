---
phase: 64-bandwidth-visualization
plan: 02
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - app/network/components/BandwidthChart.tsx
  - app/network/components/TimeRangeSelector.tsx
  - app/network/page.tsx
  - app/network/__tests__/components/BandwidthChart.test.tsx
  - app/network/__tests__/components/TimeRangeSelector.test.tsx
  - app/network/__tests__/page.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees real-time bandwidth chart with separate upload and download lines"
    - "User can switch time ranges (1h, 24h, 7d) and chart updates accordingly"
    - "Empty state shown when no data collected yet with collecting message"
    - "Chart renders with Recharts LineChart, dots disabled, animations disabled for performance"
    - "Page orchestrator wires useBandwidthHistory to useNetworkData bandwidth updates"
  artifacts:
    - path: "app/network/components/BandwidthChart.tsx"
      provides: "Recharts LineChart with dual download/upload lines and custom tooltip"
      exports: ["default"]
      min_lines: 80
    - path: "app/network/components/TimeRangeSelector.tsx"
      provides: "Button.Group for 1h/24h/7d time range selection"
      exports: ["default"]
      min_lines: 30
    - path: "app/network/page.tsx"
      provides: "Updated page orchestrator with BandwidthChart section"
      contains: "BandwidthChart"
    - path: "app/network/__tests__/components/BandwidthChart.test.tsx"
      provides: "Chart component tests"
      min_lines: 50
    - path: "app/network/__tests__/components/TimeRangeSelector.test.tsx"
      provides: "Time range selector tests"
      min_lines: 40
  key_links:
    - from: "app/network/components/BandwidthChart.tsx"
      to: "recharts"
      via: "import LineChart"
      pattern: "import.*LineChart.*from.*recharts"
    - from: "app/network/components/BandwidthChart.tsx"
      to: "app/network/components/TimeRangeSelector.tsx"
      via: "import TimeRangeSelector"
      pattern: "import.*TimeRangeSelector"
    - from: "app/network/page.tsx"
      to: "app/network/hooks/useBandwidthHistory.ts"
      via: "import useBandwidthHistory"
      pattern: "import.*useBandwidthHistory"
    - from: "app/network/page.tsx"
      to: "app/network/components/BandwidthChart.tsx"
      via: "import BandwidthChart"
      pattern: "import.*BandwidthChart"
---

<objective>
Create the bandwidth visualization UI: BandwidthChart with Recharts LineChart (dual upload/download lines), TimeRangeSelector with Button.Group (1h/24h/7d), and integrate into the /network page orchestrator.

Purpose: Deliver the user-facing bandwidth monitoring experience. Users see real-time download/upload trends with time range controls. This completes all 4 Phase 64 requirements (BW-01 through BW-04).

Output: Complete bandwidth visualization section on /network page with chart, time range controls, and empty/collecting states.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-bandwidth-visualization/64-RESEARCH.md
@.planning/phases/64-bandwidth-visualization/64-01-SUMMARY.md
@app/network/page.tsx
@app/network/hooks/useBandwidthHistory.ts
@app/components/devices/network/hooks/useNetworkData.ts
@app/components/devices/network/types.ts
@app/components/analytics/ConsumptionChart.tsx
@app/components/ui/Button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BandwidthChart and TimeRangeSelector components with tests</name>
  <files>
    app/network/components/BandwidthChart.tsx
    app/network/components/TimeRangeSelector.tsx
    app/network/__tests__/components/BandwidthChart.test.tsx
    app/network/__tests__/components/TimeRangeSelector.test.tsx
  </files>
  <action>
**TimeRangeSelector component:**

Create `app/network/components/TimeRangeSelector.tsx`:

Props interface:
```typescript
import type { BandwidthTimeRange } from '@/app/components/devices/network/types';

interface TimeRangeSelectorProps {
  value: BandwidthTimeRange;
  onChange: (range: BandwidthTimeRange) => void;
}
```

Implementation:
- Use `Button.Group` from `@/app/components/ui` with 3 buttons (1h, 24h, 7d)
- Active button uses `variant="ember"`, inactive uses `variant="subtle"`, all `size="sm"`
- Include a `Text` label "Intervallo:" (Italian) with `variant="secondary" size="sm"` before the button group
- Wrap in `<div className="flex items-center gap-2">`

**BandwidthChart component:**

Create `app/network/components/BandwidthChart.tsx`:

Props interface:
```typescript
import type { BandwidthHistoryPoint, BandwidthTimeRange } from '@/app/components/devices/network/types';

interface BandwidthChartProps {
  data: BandwidthHistoryPoint[];
  timeRange: BandwidthTimeRange;
  onTimeRangeChange: (range: BandwidthTimeRange) => void;
  isEmpty: boolean;
  isCollecting: boolean;
  pointCount: number;
}
```

Implementation:
1. **Empty state** (isEmpty=true): Show centered message in 300px container: "Raccolta dati banda in corso... Torna tra qualche minuto" (Collecting bandwidth data... Check back in a few minutes)

2. **Collecting state** (isCollecting=true): Show chart area with faded overlay message: "Raccolta dati: {pointCount}/10 punti" (Collecting data: N/10 points). Still render the chart if data.length > 0 so user sees progress.

3. **Chart** (normal): Use Recharts components following ConsumptionChart.tsx pattern:
   - `ResponsiveContainer` width="100%" height={300}
   - `LineChart` with data and margins `{ top: 10, right: 30, left: 0, bottom: 0 }`
   - `CartesianGrid` with `strokeDasharray="3 3"` stroke="currentColor" className="opacity-10"
   - `XAxis` dataKey="time" with tickFormatter based on timeRange:
     - '1h' and '24h': `format(timestamp, 'HH:mm')` from date-fns
     - '7d': `format(timestamp, 'dd/MM')` from date-fns
   - `YAxis` with label "Mbps" (same pattern as ConsumptionChart)
   - `Tooltip` with custom tooltip component (see below)
   - `Legend` with `wrapperStyle={{ fontSize: '12px' }}` iconType="line"
   - Download `Line`: type="monotone" dataKey="download" stroke="rgb(52, 211, 153)" (emerald-400) strokeWidth={2} dot={false} name="Download" isAnimationActive={false}
   - Upload `Line`: type="monotone" dataKey="upload" stroke="rgb(45, 212, 191)" (teal-400) strokeWidth={2} dot={false} name="Upload" isAnimationActive={false}

4. **CustomTooltip**: Follow ConsumptionChart tooltip pattern:
   - Dark bg with border: `bg-slate-900 [html:not(.dark)_&]:bg-white border border-white/10 [html:not(.dark)_&]:border-black/10 rounded-lg p-3 shadow-xl`
   - Format time using `format(label, 'HH:mm:ss')` at top
   - Show download and upload values with colored dots, formatted to 1 decimal: `{value.toFixed(1)} Mbps`
   - Download dot color: emerald-400 (#34d399), Upload dot color: teal-400 (#2dd4bf)

5. **Header area**: Flex row with `<Heading level={2} size="lg">Banda</Heading>` on left, `<TimeRangeSelector>` on right.

6. Wrap entire component in a card-like container: `<div className="bg-slate-800/30 [html:not(.dark)_&]:bg-white rounded-2xl p-6">`

**Tests:**

Create `app/network/__tests__/components/TimeRangeSelector.test.tsx`:
1. Renders three buttons (1h, 24h, 7d)
2. Active button has ember variant styling
3. Calls onChange with correct range when clicked
4. Shows "Intervallo:" label

Create `app/network/__tests__/components/BandwidthChart.test.tsx`:
Mock Recharts components (`jest.mock('recharts', ...)`) to render simple divs — do NOT test Recharts internals. Test:
1. Shows empty state message when isEmpty=true
2. Shows collecting state with point count when isCollecting=true
3. Renders chart container when data provided (check for ResponsiveContainer mock)
4. Renders TimeRangeSelector with correct value and onChange
5. Shows "Banda" heading
6. Passes correct data to LineChart (via mock props inspection)
  </action>
  <verify>
Run `npx jest app/network/__tests__/components/BandwidthChart.test.tsx app/network/__tests__/components/TimeRangeSelector.test.tsx --passWithNoTests` — all tests pass.
Run `npx tsc --noEmit` — no new TypeScript errors.
  </verify>
  <done>
BandwidthChart renders Recharts LineChart with dual download/upload lines, custom tooltip, empty/collecting states. TimeRangeSelector provides 1h/24h/7d toggle with Button.Group. All component tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate BandwidthChart into /network page orchestrator with tests</name>
  <files>
    app/network/page.tsx
    app/network/__tests__/page.test.tsx
  </files>
  <action>
**Update /network page orchestrator:**

Edit `app/network/page.tsx` to add bandwidth chart section:

1. Import useBandwidthHistory: `import { useBandwidthHistory } from './hooks/useBandwidthHistory';`
2. Import BandwidthChart: `import BandwidthChart from './components/BandwidthChart';`
3. Initialize hook in component: `const bandwidthHistory = useBandwidthHistory();`
4. Wire data from useNetworkData to useBandwidthHistory using useEffect:
```typescript
import { useEffect } from 'react';

// Feed bandwidth data from polling into history buffer
useEffect(() => {
  if (networkData.bandwidth) {
    bandwidthHistory.addDataPoint(networkData.bandwidth);
  }
}, [networkData.bandwidth]); // eslint-disable-line react-hooks/exhaustive-deps
```
NOTE: `addDataPoint` is stable (useCallback with no deps) so it's safe to omit from dependency array. Add the eslint-disable comment per project pattern.

5. Add BandwidthChart below DeviceListTable in the page layout:
```tsx
{/* Bandwidth Chart - below device list */}
<BandwidthChart
  data={bandwidthHistory.chartData}
  timeRange={bandwidthHistory.timeRange}
  onTimeRangeChange={bandwidthHistory.setTimeRange}
  isEmpty={bandwidthHistory.isEmpty}
  isCollecting={bandwidthHistory.isCollecting}
  pointCount={bandwidthHistory.pointCount}
/>
```

6. Also add a third skeleton block for the chart in the loading state:
```tsx
<Skeleton className="h-[380px] rounded-2xl" />
```

**Update page tests:**

Edit `app/network/__tests__/page.test.tsx`:

Add mock for useBandwidthHistory:
```typescript
jest.mock('../hooks/useBandwidthHistory', () => ({
  useBandwidthHistory: jest.fn(() => ({
    chartData: [],
    timeRange: '24h',
    setTimeRange: jest.fn(),
    addDataPoint: jest.fn(),
    pointCount: 0,
    isEmpty: true,
    isCollecting: false,
  })),
}));
```

Add mock for BandwidthChart component (same pattern as existing WanStatusCard/DeviceListTable mocks).

Add these new tests (keep all existing tests):
1. Renders BandwidthChart component on page
2. Passes bandwidth history data to BandwidthChart
3. Calls addDataPoint when networkData.bandwidth updates (test useEffect wiring)
4. Loading skeleton includes chart skeleton (3 skeleton blocks total)

Ensure all existing 7 page tests still pass — do not break them.
  </action>
  <verify>
Run `npx jest app/network/__tests__/ --passWithNoTests` — all tests pass (existing 41 + new chart/selector tests + updated page tests).
Run `npx tsc --noEmit` — no new TypeScript errors.
Verify BandwidthChart import exists in page.tsx.
Verify useBandwidthHistory import exists in page.tsx.
Verify useEffect wiring exists in page.tsx (bandwidthHistory.addDataPoint called with networkData.bandwidth).
  </verify>
  <done>
/network page displays BandwidthChart below device list. Page orchestrator wires useNetworkData bandwidth updates into useBandwidthHistory via useEffect. Loading skeleton includes chart placeholder. All page tests pass (existing + new). No duplicate polling — single useNetworkData loop feeds both sparklines and full chart.
  </done>
</task>

</tasks>

<verification>
1. `npx jest app/network/ --passWithNoTests` — all tests pass (41 existing + new chart/selector/page tests)
2. `npx tsc --noEmit` — no new TypeScript errors
3. BandwidthChart visible on /network page below device list table
4. TimeRangeSelector shows 1h/24h/7d with active state highlighting
5. Empty state shown when no bandwidth data collected
6. Chart shows download (emerald) and upload (teal) lines when data available
7. No duplicate fetch() calls in network tab (single useNetworkData polling loop)
</verification>

<success_criteria>
- BandwidthChart renders Recharts LineChart with dual lines (BW-01)
- TimeRangeSelector toggles between 1h/24h/7d with chart updating (BW-02)
- Data decimation wired via useBandwidthHistory from Plan 01 (BW-03)
- Adaptive polling via useNetworkData reuse — 30s visible, 5min hidden (BW-04)
- All 4 Phase 64 requirements satisfied
- All tests green, TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/64-bandwidth-visualization/64-02-SUMMARY.md`
</output>
