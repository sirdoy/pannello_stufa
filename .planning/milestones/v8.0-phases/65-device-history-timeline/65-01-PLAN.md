---
phase: 65-device-history-timeline
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/fritzbox/deviceEventLogger.ts
  - lib/fritzbox/__tests__/deviceEventLogger.test.ts
  - lib/fritzbox/index.ts
  - app/components/devices/network/types.ts
autonomous: true

must_haves:
  truths:
    - "Device events can be logged to Firebase RTDB under date-keyed paths"
    - "Device events can be queried by time range (startTime, endTime)"
    - "Device states can be stored and retrieved for change detection"
    - "Date range generation handles multi-day queries correctly"
  artifacts:
    - path: "lib/fritzbox/deviceEventLogger.ts"
      provides: "Event logging, querying, and state tracking utilities"
      exports: ["logDeviceEvent", "getDeviceEvents", "getDeviceStates", "updateDeviceStates", "DeviceEvent"]
    - path: "lib/fritzbox/__tests__/deviceEventLogger.test.ts"
      provides: "Unit tests for all event logger functions"
      min_lines: 80
    - path: "app/components/devices/network/types.ts"
      provides: "DeviceEvent and DeviceHistoryTimeRange types"
      contains: "DeviceEvent"
  key_links:
    - from: "lib/fritzbox/deviceEventLogger.ts"
      to: "lib/firebaseAdmin.ts"
      via: "adminDbSet and adminDbGet imports"
      pattern: "adminDb(Set|Get)"
    - from: "lib/fritzbox/deviceEventLogger.ts"
      to: "lib/environmentHelper.ts"
      via: "getEnvironmentPath for Firebase paths"
      pattern: "getEnvironmentPath"
---

<objective>
Create the device event logging infrastructure: types, Firebase RTDB persistence, and query utilities.

Purpose: This is the data layer foundation. Events logged here are consumed by the history API endpoint (Plan 02) and displayed in the timeline UI (Plan 03). Without reliable event logging and querying, the timeline feature cannot work.

Output: `lib/fritzbox/deviceEventLogger.ts` with full TDD coverage, plus `DeviceEvent` type added to network types.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-device-history-timeline/65-RESEARCH.md

@lib/firebaseAdmin.ts
@lib/environmentHelper.ts
@lib/fritzbox/index.ts
@app/components/devices/network/types.ts
</context>

<feature>
  <name>Device Event Logger with Date-Keyed Firebase Storage</name>
  <files>
    lib/fritzbox/deviceEventLogger.ts
    lib/fritzbox/__tests__/deviceEventLogger.test.ts
    lib/fritzbox/index.ts
    app/components/devices/network/types.ts
  </files>
  <behavior>
    The device event logger provides four core functions:

    1. `logDeviceEvent(event: DeviceEvent): Promise<void>`
       - Writes event to Firebase RTDB at path: `{env}/fritzbox/device_events/{YYYY-MM-DD}/{timestamp}_{mac}_{eventType}`
       - Uses `getEnvironmentPath()` for environment-aware paths
       - Uses `adminDbSet()` for atomic writes
       - Input: `{ deviceMac: 'AA:BB:CC:DD:EE:FF', deviceName: 'iPhone', deviceIp: '192.168.1.10', eventType: 'connected', timestamp: 1708000000000 }`
       - Output: void (writes to Firebase)

    2. `getDeviceEvents(startTime: number, endTime: number): Promise<DeviceEvent[]>`
       - Generates date range from startTime to endTime (YYYY-MM-DD keys)
       - Reads each date node from Firebase RTDB
       - Filters events within exact timestamp range
       - Returns sorted newest-first
       - Input: `(startTime: 1707913600000, endTime: 1708000000000)` (24h range)
       - Output: `DeviceEvent[]` sorted by timestamp desc

    3. `getDeviceStates(): Promise<Map<string, { active: boolean; lastSeen: number }>>`
       - Reads from `{env}/fritzbox/device_states`
       - Returns Map keyed by MAC address
       - Returns empty Map if no states exist yet

    4. `updateDeviceStates(states: Map<string, { active: boolean; lastSeen: number }>): Promise<void>`
       - Writes full state map to `{env}/fritzbox/device_states`
       - Converts Map to plain object for Firebase

    5. Internal: `generateDateRange(startDate: string, endDate: string): string[]`
       - Generates array of YYYY-MM-DD strings between start and end (inclusive)
       - Uses date-fns `eachDayOfInterval` (don't hand-roll per research)

    Cases:
    - logDeviceEvent with connected event -> writes to correct date-keyed path
    - logDeviceEvent with disconnected event -> writes to correct date-keyed path
    - getDeviceEvents spanning 1 day -> reads single date node, filters, sorts desc
    - getDeviceEvents spanning 3 days -> reads 3 date nodes, merges, filters, sorts desc
    - getDeviceEvents with no data -> returns empty array
    - getDeviceStates with no previous state -> returns empty Map
    - getDeviceStates with existing states -> returns populated Map
    - updateDeviceStates -> writes Map as plain object to Firebase
    - generateDateRange same day -> returns single date
    - generateDateRange multi-day -> returns all dates inclusive
  </behavior>
  <implementation>
    1. Add types to `app/components/devices/network/types.ts`:
       ```typescript
       // Device history types (Phase 65)
       export interface DeviceEvent {
         deviceMac: string;
         deviceName: string;
         deviceIp: string;
         eventType: 'connected' | 'disconnected';
         timestamp: number; // Unix timestamp ms
       }

       export type DeviceHistoryTimeRange = '1h' | '24h' | '7d';
       ```

    2. Create `lib/fritzbox/deviceEventLogger.ts`:
       - Import `adminDbSet`, `adminDbGet` from `@/lib/firebaseAdmin`
       - Import `getEnvironmentPath` from `@/lib/environmentHelper`
       - Import `format`, `eachDayOfInterval` from `date-fns`
       - Import `DeviceEvent` from `@/app/components/devices/network/types`
       - Export all four functions
       - Use date-fns `eachDayOfInterval` for `generateDateRange` (not hand-rolled)
       - Firebase path pattern: `fritzbox/device_events/{YYYY-MM-DD}/{timestamp}_{mac}_{eventType}`
       - Replace `:` in MAC addresses with `-` for Firebase key safety (`:` is not allowed in Firebase keys)

    3. Re-export from `lib/fritzbox/index.ts`:
       - Add `export { logDeviceEvent, getDeviceEvents, getDeviceStates, updateDeviceStates } from './deviceEventLogger';`

    4. Mock `@/lib/firebaseAdmin` and `@/lib/environmentHelper` in tests using `jest.mock()`
       - Verify correct paths passed to adminDbSet/adminDbGet
       - Verify correct data shapes written
       - Test empty state handling
       - Test multi-day range generation
       - Test sorting order (newest first)
  </implementation>
</feature>

<verification>
```bash
npx jest lib/fritzbox/__tests__/deviceEventLogger.test.ts --verbose
npx tsc --noEmit --project tsconfig.json 2>&1 | head -20
```
</verification>

<success_criteria>
- All deviceEventLogger tests pass (RED then GREEN)
- DeviceEvent type exported from network types
- deviceEventLogger functions re-exported from lib/fritzbox/index.ts
- Zero TypeScript compilation errors
- MAC address colons replaced with dashes in Firebase keys
</success_criteria>

<output>
After completion, create `.planning/phases/65-device-history-timeline/65-01-SUMMARY.md`
</output>
