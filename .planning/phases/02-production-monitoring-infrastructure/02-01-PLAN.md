---
phase: 02-production-monitoring-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/firebaseAdmin.js
  - lib/notificationLogger.js
autonomous: true

must_haves:
  truths:
    - "Every notification sent is logged to Firestore with timestamp, type, and outcome"
    - "Notification logs are queryable by date range and status"
    - "Dependencies (recharts, date-fns) are available for subsequent plans"
  artifacts:
    - path: "lib/notificationLogger.js"
      provides: "Centralized notification logging functions"
      exports: ["logNotification", "logNotificationError", "getNotificationLogs"]
    - path: "lib/firebaseAdmin.js"
      provides: "Firestore admin initialization"
      contains: "getAdminFirestore"
  key_links:
    - from: "lib/notificationLogger.js"
      to: "lib/firebaseAdmin.js"
      via: "getAdminFirestore import"
      pattern: "import.*getAdminFirestore.*from.*firebaseAdmin"
---

<objective>
Set up monitoring infrastructure foundation: install dependencies, initialize Firestore Admin SDK, and create notification logging system.

Purpose: Enable all subsequent monitoring features by establishing data storage and required libraries.
Output: Notification logging service ready to track every send attempt with outcome.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-monitoring-infrastructure/02-CONTEXT.md
@lib/firebaseAdmin.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure Firestore Admin</name>
  <files>package.json, lib/firebaseAdmin.js</files>
  <action>
    1. Add recharts and date-fns to package.json dependencies section (do NOT run npm install - user handles this):
       - "recharts": "^2.15.0"
       - "date-fns": "^4.1.0"

    2. Update lib/firebaseAdmin.js to add Firestore Admin initialization:
       - Import getFirestore from 'firebase-admin/firestore'
       - Create getAdminFirestore() function that:
         - Calls initializeFirebaseAdmin() to ensure app is initialized
         - Returns getFirestore() instance
       - Export getAdminFirestore

    Pattern to follow (from existing getAdminDatabase):
    ```javascript
    import { getFirestore } from 'firebase-admin/firestore';

    export function getAdminFirestore() {
      initializeFirebaseAdmin();
      return getFirestore();
    }
    ```
  </action>
  <verify>
    - package.json includes recharts and date-fns in dependencies
    - lib/firebaseAdmin.js exports getAdminFirestore function
    - No syntax errors: `npm run lint` passes
  </verify>
  <done>
    Dependencies added to package.json, Firestore Admin SDK accessible via getAdminFirestore()
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notification logging service</name>
  <files>lib/notificationLogger.js</files>
  <action>
    Create lib/notificationLogger.js with functions to log notification events to Firestore.

    Collection: `notificationLogs`

    Document structure:
    ```javascript
    {
      id: auto-generated,
      timestamp: Firestore Timestamp,
      type: 'scheduler' | 'error' | 'maintenance' | 'test' | 'generic',
      status: 'sent' | 'delivered' | 'failed',
      userId: string,
      deviceCount: number,        // How many devices targeted
      successCount: number,       // How many succeeded
      failureCount: number,       // How many failed
      title: string,              // Notification title
      body: string,               // Notification body (truncated to 200 chars)
      fcmErrors: [{               // Array of errors if any
        tokenPrefix: string,      // First 20 chars of token for identification
        errorCode: string,        // FCM error code
        errorMessage: string
      }],
      metadata: {                 // Optional additional context
        source: string,           // What triggered notification (e.g., 'scheduler-check', 'manual-test')
        isTest: boolean           // Whether this was a test notification
      }
    }
    ```

    Functions to implement:

    1. `logNotification(data)` - Log a notification send attempt
       - data: { userId, type, title, body, deviceCount, successCount, failureCount, fcmErrors?, metadata? }
       - Auto-generates timestamp
       - Truncates body to 200 chars
       - Returns document ID

    2. `logNotificationError(data)` - Convenience wrapper for failed notifications
       - data: { userId, type, title, body, errorCode, errorMessage, tokenPrefix, metadata? }
       - Sets status to 'failed', deviceCount/successCount/failureCount appropriately

    3. `getNotificationLogs(options)` - Query logs with filters
       - options: { startDate?, endDate?, status?, type?, limit? }
       - Default limit: 100
       - Order by timestamp descending
       - Returns array of log documents

    4. `getDeliveryStats(hours)` - Get delivery statistics for last N hours
       - hours: number (default 24)
       - Returns: { total, sent, delivered, failed, deliveryRate }

    Use date-fns for date calculations (subHours, startOfHour).

    IMPORTANT: Include 'use server' directive or equivalent for Next.js server-only code.
  </action>
  <verify>
    - lib/notificationLogger.js exists with all 4 functions exported
    - Imports getAdminFirestore from lib/firebaseAdmin
    - Uses Firestore Timestamp for timestamps
    - No syntax errors
  </verify>
  <done>
    Notification logging service ready with logNotification, logNotificationError, getNotificationLogs, getDeliveryStats functions
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate logging into send notification flow</name>
  <files>lib/firebaseAdmin.js</files>
  <action>
    Update sendPushNotification() and sendNotificationToUser() in lib/firebaseAdmin.js to log every notification attempt.

    1. Import logNotification from lib/notificationLogger.js

    2. In sendPushNotification():
       - After sending, call logNotification with:
         - type: extracted from notification.data?.type || 'generic'
         - status: result.successCount > 0 ? 'sent' : 'failed'
         - deviceCount: tokenArray.length
         - successCount: result.successCount
         - failureCount: result.failureCount
         - fcmErrors: array of { tokenPrefix, errorCode, errorMessage } for each failed token
       - Use async call without await (non-blocking logging)

    3. Add userId parameter to sendPushNotification signature:
       - New signature: sendPushNotification(tokens, notification, userId = null)
       - Pass userId to logNotification if available

    4. In sendNotificationToUser():
       - Pass userId to sendPushNotification call

    Pattern for non-blocking logging:
    ```javascript
    // Log asynchronously (don't block response)
    logNotification({
      userId: userId || 'unknown',
      type: notification.data?.type || 'generic',
      title: notification.title,
      body: notification.body,
      status: result.successCount > 0 ? 'sent' : 'failed',
      deviceCount: tokenArray.length,
      successCount: result.successCount,
      failureCount: result.failureCount,
      fcmErrors: errors,
      metadata: { source: 'api', isTest: notification.data?.type === 'test' }
    }).catch(err => console.error('Failed to log notification:', err));
    ```
  </action>
  <verify>
    - sendPushNotification accepts userId parameter
    - Every send attempt triggers logNotification call
    - Logging is non-blocking (uses .catch() pattern, not await)
    - sendNotificationToUser passes userId to sendPushNotification
  </verify>
  <done>
    Every notification send attempt is logged to Firestore automatically
  </done>
</task>

</tasks>

<verification>
1. Review package.json has new dependencies
2. Review lib/firebaseAdmin.js has getAdminFirestore and logging integration
3. Review lib/notificationLogger.js has all required functions
4. Run `npm run lint` to check for syntax errors
</verification>

<success_criteria>
- recharts and date-fns added to package.json dependencies
- getAdminFirestore() function exported from lib/firebaseAdmin.js
- lib/notificationLogger.js created with logNotification, logNotificationError, getNotificationLogs, getDeliveryStats
- sendPushNotification and sendNotificationToUser log every attempt to Firestore
- No blocking calls - logging is fire-and-forget
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-monitoring-infrastructure/02-01-SUMMARY.md`
</output>
