---
phase: 02-production-monitoring-infrastructure
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - app/api/notifications/stats/route.js
  - app/debug/notifications/page.js
autonomous: true

must_haves:
  truths:
    - "Dashboard displays total notifications sent today"
    - "Delivery rate percentage shown with color indicator (85%+ = green)"
    - "Device list shows all registered devices with status"
    - "Manual refresh button updates all metrics"
  artifacts:
    - path: "app/api/notifications/stats/route.js"
      provides: "Delivery statistics API"
      exports: ["GET"]
    - path: "app/debug/notifications/page.js"
      provides: "Admin notifications dashboard page"
      min_lines: 150
  key_links:
    - from: "app/debug/notifications/page.js"
      to: "/api/notifications/stats"
      via: "fetch in useEffect"
      pattern: "fetch.*api/notifications/stats"
---

<objective>
Create admin dashboard with delivery metrics, device list, and manual refresh capability.

Purpose: Give administrators visibility into notification system health at a glance.
Output: Dashboard page at /debug/notifications showing delivery rate, device list, and error summary.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-monitoring-infrastructure/02-CONTEXT.md
@.planning/phases/02-production-monitoring-infrastructure/02-01-SUMMARY.md
@.planning/phases/02-production-monitoring-infrastructure/02-02-SUMMARY.md
@app/debug/page.js
@app/components/ui/Card.js
@app/components/ui/Button.js
@app/components/ui/Heading.js
@app/components/ui/Text.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notifications stats API endpoint</name>
  <files>app/api/notifications/stats/route.js</files>
  <action>
    Create app/api/notifications/stats/route.js to provide dashboard metrics.

    Endpoint: GET /api/notifications/stats

    Query parameters:
    - hours: number (default 24, max 168 for 7 days)

    Response:
    ```javascript
    {
      success: true,
      stats: {
        period: {
          hours: 24,
          start: ISO timestamp,
          end: ISO timestamp
        },
        notifications: {
          total: number,
          sent: number,
          failed: number,
          deliveryRate: number  // Percentage (0-100)
        },
        errors: {
          total: number,
          byCode: {
            'messaging/registration-token-not-registered': 5,
            'messaging/invalid-argument': 2,
            // ... other codes
          }
        },
        devices: {
          total: number,
          active: number,       // Used in last 7 days
          stale: number         // Not used in 30+ days
          byPlatform: {
            ios: number,
            android: number,
            web: number
          }
        }
      },
      generatedAt: ISO timestamp
    }
    ```

    Implementation:

    1. Get notification stats from Firestore (use getDeliveryStats from notificationLogger)
    2. Get error stats from Firebase RTDB (query notificationErrors)
    3. Get device stats from Firebase RTDB (query all users/*/fcmTokens):
       - Count total tokens
       - Count active (lastUsed within 7 days)
       - Count stale (lastUsed > 30 days ago)
       - Group by platform

    Use date-fns for date calculations.

    Require authentication using withAuthAndErrorHandler.
  </action>
  <verify>
    - GET /api/notifications/stats returns comprehensive stats object
    - Includes notifications, errors, and devices breakdown
    - Delivery rate calculated as percentage
    - Requires authentication
  </verify>
  <done>
    Stats API endpoint provides all metrics needed for dashboard display
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notifications dashboard page</name>
  <files>app/debug/notifications/page.js</files>
  <action>
    Create app/debug/notifications/page.js as admin dashboard for notifications.

    Use 'use client' directive.

    Layout (following existing /debug/page.js patterns):

    1. **Header section:**
       - Title: "Notifications Dashboard"
       - Subtitle: "Monitor delivery rate and system health"
       - Refresh button (manual, per 02-CONTEXT.md decision)
       - Loading state indicator

    2. **Primary metrics row (Cards):**
       - **Today's Notifications:** Big number (e.g., "47")
       - **Delivery Rate:** Percentage with color indicator
         - >= 85%: Green (bg-sage-50, text-sage-600)
         - 70-84%: Yellow (bg-warning-50, text-warning-600)
         - < 70%: Red (bg-ember-50, text-ember-600)
       - **Active Devices:** Count with breakdown tooltip

    3. **Error summary section:**
       - Recent errors count (last 24h)
       - Top error codes with counts
       - Link to view all errors

    4. **Device list section:**
       - Table showing registered devices
       - Columns: Device Name, Platform, Last Used, Status
       - Status: Active (green), Stale (yellow), Invalid (red)
       - "View Details" action per device

    5. **Quick actions:**
       - Link to /debug/notifications/test (will be created in 02-04)
       - Link to /debug/notifications/errors (error log viewer)

    Use existing UI components: Card, Button, Heading, Text.
    Follow Ember Noir design system patterns from existing debug pages.

    State management:
    - useState for stats, loading, error
    - useEffect to fetch stats on mount
    - fetchStats function for refresh button

    IMPORTANT: Per 02-CONTEXT.md, use manual refresh only (no auto-polling).
  </action>
  <verify>
    - Page loads at /debug/notifications
    - Shows delivery rate with color coding
    - Shows today's notification count
    - Shows device list with status
    - Manual refresh button works
    - Uses existing UI components consistently
  </verify>
  <done>
    Notifications dashboard displays all metrics with manual refresh
  </done>
</task>

<task type="auto">
  <name>Task 3: Create device list API endpoint</name>
  <files>app/api/notifications/devices/route.js</files>
  <action>
    Create app/api/notifications/devices/route.js to list all registered devices.

    Endpoint: GET /api/notifications/devices

    Response:
    ```javascript
    {
      success: true,
      devices: [{
        id: string,           // tokenKey
        deviceId: string,     // Stable device identifier
        displayName: string,  // "Chrome on Windows"
        platform: string,     // ios, android, web
        browser: string,      // From deviceInfo
        os: string,           // From deviceInfo
        createdAt: ISO string,
        lastUsed: ISO string,
        status: 'active' | 'stale' | 'unknown',
        tokenPrefix: string   // First 20 chars for identification
      }],
      count: number
    }
    ```

    Implementation:
    1. Query current user's fcmTokens from Firebase
    2. Transform each token entry to device format
    3. Calculate status:
       - active: lastUsed within 7 days
       - stale: lastUsed > 30 days ago
       - unknown: no lastUsed timestamp
    4. Sort by lastUsed descending (most recent first)

    Use date-fns for date comparisons.

    IMPORTANT: Only return devices for the authenticated user (not all users).
    Use withAuthAndErrorHandler for authentication.
  </action>
  <verify>
    - GET /api/notifications/devices returns user's registered devices
    - Each device has status calculated (active/stale/unknown)
    - Devices sorted by lastUsed descending
    - Only returns current user's devices
    - Requires authentication
  </verify>
  <done>
    Device list API returns formatted device data with status indicators
  </done>
</task>

</tasks>

<verification>
1. Visit /debug/notifications - page should load with metrics
2. Check delivery rate color matches percentage threshold
3. Device list shows registered devices with correct status
4. Refresh button fetches new data
5. Run `npm run lint` to check for syntax errors
</verification>

<success_criteria>
- /debug/notifications page displays delivery metrics
- Delivery rate color coded (85%+ green, 70-84% yellow, <70% red)
- Device list shows all user's registered devices
- Manual refresh button updates all data
- Uses existing UI components consistently
- No auto-polling (manual refresh only per 02-CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-monitoring-infrastructure/02-03-SUMMARY.md`
</output>
