---
phase: 02-production-monitoring-infrastructure
plan: 04
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - app/debug/notifications/test/page.js
  - app/api/notifications/test/route.js
autonomous: true

must_haves:
  truths:
    - "Admin can select specific device or broadcast to all"
    - "Admin can choose from predefined templates or write custom message"
    - "Test notification received within 5 seconds with delivery confirmation"
    - "Test notifications logged with 'test' tag for filtering"
  artifacts:
    - path: "app/debug/notifications/test/page.js"
      provides: "Test notification panel UI"
      min_lines: 100
    - path: "app/api/notifications/test/route.js"
      provides: "Enhanced test notification endpoint"
      exports: ["POST"]
  key_links:
    - from: "app/debug/notifications/test/page.js"
      to: "/api/notifications/test"
      via: "fetch on form submit"
      pattern: "fetch.*api/notifications/test"
    - from: "app/debug/notifications/test/page.js"
      to: "/api/notifications/devices"
      via: "fetch for device dropdown"
      pattern: "fetch.*api/notifications/devices"
---

<objective>
Create test notification panel with device selection, message templates, and delivery confirmation.

Purpose: Enable admin to quickly test notification delivery to specific devices with instant feedback.
Output: Test panel UI at /debug/notifications/test with full send-and-confirm workflow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-monitoring-infrastructure/02-CONTEXT.md
@.planning/phases/02-production-monitoring-infrastructure/02-01-SUMMARY.md
@.planning/phases/02-production-monitoring-infrastructure/02-02-SUMMARY.md
@app/api/notifications/test/route.js
@app/debug/page.js
@app/components/ui/Card.js
@app/components/ui/Button.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance test notification API with templates and logging</name>
  <files>app/api/notifications/test/route.js</files>
  <action>
    Enhance existing app/api/notifications/test/route.js with:

    1. **Template support:**
       Add predefined templates (from 02-CONTEXT.md and Phase 5 requirements):
       ```javascript
       const TEMPLATES = {
         error_alert: {
           title: 'Errore Stufa',
           body: 'Attenzione: rilevato errore nel sistema. Verifica lo stato della stufa.',
           priority: 'high',
           type: 'error'
         },
         scheduler_success: {
           title: 'Accensione Completata',
           body: 'La stufa e stata accesa automaticamente dallo scheduler.',
           priority: 'normal',
           type: 'scheduler'
         },
         maintenance_reminder: {
           title: 'Promemoria Manutenzione',
           body: 'E il momento di effettuare la pulizia ordinaria della stufa.',
           priority: 'normal',
           type: 'maintenance'
         }
       };
       ```

    2. **Updated request body:**
       ```javascript
       {
         deviceToken?: string,      // Specific device (existing)
         template?: string,         // Template name (new)
         customTitle?: string,      // Custom title (overrides template)
         customBody?: string,       // Custom body (overrides template)
         broadcast?: boolean        // Send to all devices (new)
       }
       ```

    3. **Response with delivery trace:**
       ```javascript
       {
         success: true,
         message: 'Test notification sent',
         trace: {
           sentAt: ISO timestamp,
           targetDevices: number,
           template: string | null,
           deliveryResults: {
             successCount: number,
             failureCount: number,
             errors: [{ tokenPrefix, errorCode }]
           }
         }
       }
       ```

    4. **Ensure logging includes test metadata:**
       - Set metadata.isTest = true
       - Set metadata.source = 'manual-test'
       - Include template name if used

    Logic:
    - If template provided, use template values
    - customTitle/customBody override template values
    - If neither template nor custom, use default test message
    - If broadcast=true, send to all user devices
    - If deviceToken provided, send to that device only
    - If neither, send to all devices (same as broadcast)
  </action>
  <verify>
    - POST /api/notifications/test accepts template parameter
    - Templates error_alert, scheduler_success, maintenance_reminder work
    - Custom title/body override template
    - Response includes delivery trace with timing
    - Broadcast sends to all devices
  </verify>
  <done>
    Test notification API enhanced with templates, broadcast, and delivery trace
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test notification panel UI</name>
  <files>app/debug/notifications/test/page.js</files>
  <action>
    Create app/debug/notifications/test/page.js for test notification sending.

    Use 'use client' directive.

    Layout:

    1. **Header:**
       - Title: "Send Test Notification"
       - Back link to /debug/notifications

    2. **Target selection section:**
       - Radio group: "All Devices" or "Specific Device"
       - Device dropdown (shown when "Specific Device" selected)
         - Fetches from /api/notifications/devices
         - Shows displayName + platform icon
         - Format: "Chrome on Windows (iOS)" or similar

    3. **Message section:**
       - Template dropdown:
         - "Custom Message" (default)
         - "Error Alert"
         - "Scheduler Success"
         - "Maintenance Reminder"
       - Title input (disabled when template selected, unless "Custom Message")
       - Body textarea (disabled when template selected, unless "Custom Message")
       - Shows template preview when template selected

    4. **Send button:**
       - Primary action button
       - Loading state during send
       - Disabled if form invalid

    5. **Results section (shown after send):**
       - Success/failure indicator
       - Delivery trace:
         - Sent at: timestamp
         - Target devices: N
         - Delivered: N / Failed: N
         - Error details if any

    State:
    - targetMode: 'all' | 'specific'
    - selectedDevice: string | null
    - template: 'custom' | 'error_alert' | 'scheduler_success' | 'maintenance_reminder'
    - customTitle: string
    - customBody: string
    - sending: boolean
    - result: object | null

    Form validation:
    - If custom, require title and body
    - If specific device, require device selection
    - Template selection fills preview

    IMPORTANT: After successful send, show "Notification should arrive within 5 seconds" per success criteria.
  </action>
  <verify>
    - Page loads at /debug/notifications/test
    - Device dropdown populated from API
    - Template selection shows preview
    - Custom message allows title/body input
    - Send button triggers notification
    - Results section shows delivery trace
  </verify>
  <done>
    Test notification panel fully functional with device selection, templates, and confirmation
  </done>
</task>

<task type="auto">
  <name>Task 3: Add navigation links between debug pages</name>
  <files>app/debug/notifications/page.js</files>
  <action>
    Update app/debug/notifications/page.js (created in 02-03) to add navigation:

    1. Add "Send Test Notification" button/link in quick actions section
       - Links to /debug/notifications/test
       - Primary or prominent styling

    2. Add breadcrumb or back link to main /debug page

    3. Ensure consistent navigation pattern across debug pages

    Follow existing debug page patterns for navigation styling.
  </action>
  <verify>
    - /debug/notifications has link to /debug/notifications/test
    - Navigation is consistent with other debug pages
    - Back link to /debug exists
  </verify>
  <done>
    Navigation between notification debug pages is complete
  </done>
</task>

</tasks>

<verification>
1. Visit /debug/notifications/test
2. Select "All Devices" and send - should receive notification
3. Select specific device and send - should receive on that device only
4. Use template - should show template content
5. Use custom message - should allow title/body input
6. Check delivery trace shows timing and results
</verification>

<success_criteria>
- Test panel at /debug/notifications/test with full UI
- Device selection dropdown works (single or broadcast)
- Template selection with 3 predefined templates
- Custom message input when "Custom Message" selected
- Send triggers notification with 5-second delivery expectation
- Delivery trace shows success/failure counts
- Test notifications logged with isTest=true
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-monitoring-infrastructure/02-04-SUMMARY.md`
</output>
