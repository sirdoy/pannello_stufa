---
phase: 02-production-monitoring-infrastructure
plan: 05
type: execute
wave: 3
depends_on: [02-03]
files_modified:
  - app/api/notifications/trends/route.js
  - app/debug/notifications/page.js
  - app/debug/notifications/components/DeliveryChart.js
autonomous: true

must_haves:
  truths:
    - "Dashboard charts visualize delivery trends for last 7 days"
    - "Chart shows daily notification counts with success/failure breakdown"
    - "Delivery rate trend line is visible"
  artifacts:
    - path: "app/api/notifications/trends/route.js"
      provides: "7-day trend data API"
      exports: ["GET"]
    - path: "app/debug/notifications/components/DeliveryChart.js"
      provides: "Recharts visualization component"
      min_lines: 50
  key_links:
    - from: "app/debug/notifications/page.js"
      to: "app/debug/notifications/components/DeliveryChart.js"
      via: "component import"
      pattern: "import.*DeliveryChart.*from"
    - from: "app/debug/notifications/components/DeliveryChart.js"
      to: "recharts"
      via: "recharts import"
      pattern: "import.*from 'recharts'"
---

<objective>
Add Recharts visualizations to dashboard showing 7-day delivery trends.

Purpose: Enable admin to identify patterns and issues in notification delivery over time.
Output: Interactive charts on dashboard showing daily notification volume and delivery rate trends.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-monitoring-infrastructure/02-CONTEXT.md
@.planning/phases/02-production-monitoring-infrastructure/02-03-SUMMARY.md
@lib/notificationLogger.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trends API endpoint</name>
  <files>app/api/notifications/trends/route.js</files>
  <action>
    Create app/api/notifications/trends/route.js to provide 7-day trend data.

    Endpoint: GET /api/notifications/trends

    Query parameters:
    - days: number (default 7, max 30)

    Response:
    ```javascript
    {
      success: true,
      trends: {
        daily: [{
          date: "2026-01-24",          // ISO date string
          total: 47,
          sent: 45,
          failed: 2,
          deliveryRate: 95.7          // Percentage
        }, ...],                       // Array of N days, oldest first
        summary: {
          totalNotifications: 312,
          averageDeliveryRate: 94.2,
          trend: 'stable' | 'improving' | 'declining'  // Compare last 3 days to previous 4
        }
      },
      period: {
        start: ISO timestamp,
        end: ISO timestamp,
        days: 7
      }
    }
    ```

    Implementation:

    1. Query notification logs from Firestore for the date range
       - Use getAdminFirestore from lib/firebaseAdmin.js
       - Query notificationLogs collection
       - Filter by timestamp >= startDate

    2. Group by day using date-fns:
       - startOfDay, format, eachDayOfInterval
       - Count sent vs failed per day
       - Calculate daily delivery rate

    3. Calculate summary:
       - Total across all days
       - Average delivery rate
       - Trend: compare average of last 3 days vs previous 4 days
         - If diff > 5%: improving
         - If diff < -5%: declining
         - Otherwise: stable

    4. Ensure days with no notifications return zero counts (not missing)

    Use withAuthAndErrorHandler for authentication.
  </action>
  <verify>
    - GET /api/notifications/trends returns 7 days of data
    - Each day has date, total, sent, failed, deliveryRate
    - Summary includes trend indicator
    - Days with no notifications have zero counts
    - Requires authentication
  </verify>
  <done>
    Trends API provides daily breakdown for chart visualization
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DeliveryChart component with Recharts</name>
  <files>app/debug/notifications/components/DeliveryChart.js</files>
  <action>
    Create app/debug/notifications/components/DeliveryChart.js using Recharts.

    Use 'use client' directive.

    Props:
    - data: Array of { date, total, sent, failed, deliveryRate }
    - loading: boolean

    Chart type: ComposedChart (combines bars and line)
    - Recommended per 02-CONTEXT.md (Claude's discretion for monitoring health)

    Layout:
    - Stacked bar chart for sent (green) + failed (red)
    - Line overlay for delivery rate percentage
    - X-axis: dates (formatted as "Mon", "Tue", etc. or "Jan 24", "Jan 25")
    - Left Y-axis: notification count
    - Right Y-axis: delivery rate percentage (0-100)

    Components from recharts:
    ```javascript
    import {
      ComposedChart,
      Bar,
      Line,
      XAxis,
      YAxis,
      CartesianGrid,
      Tooltip,
      Legend,
      ResponsiveContainer
    } from 'recharts';
    ```

    Styling (Ember Noir theme):
    - Sent bar: #22c55e (sage-500/green)
    - Failed bar: #ef4444 (ember-500/red)
    - Delivery rate line: #3b82f6 (ocean-500/blue)
    - Grid: subtle (opacity 0.1)
    - Dark mode support via CSS variables or conditional colors

    Tooltip:
    - Show date, sent count, failed count, delivery rate
    - Custom formatter for nice display

    Loading state:
    - Show skeleton/placeholder while loading

    Empty state:
    - Show "No data for this period" message

    Responsive:
    - Use ResponsiveContainer with height={300}
  </action>
  <verify>
    - Component renders stacked bar chart with line overlay
    - Uses Recharts ComposedChart
    - Colors match Ember Noir theme
    - Tooltip shows all metrics
    - Handles loading and empty states
    - Responsive to container width
  </verify>
  <done>
    DeliveryChart component visualizes 7-day trends with bars and line
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate chart into dashboard page</name>
  <files>app/debug/notifications/page.js</files>
  <action>
    Update app/debug/notifications/page.js to include the DeliveryChart.

    1. Import DeliveryChart component

    2. Add state for trends data:
       - trends: array
       - trendsLoading: boolean

    3. Fetch trends data alongside stats:
       - Call /api/notifications/trends in fetchData function
       - Store in trends state

    4. Add chart section to layout:
       - After metrics row, before error summary
       - Card wrapper with heading "7-Day Delivery Trends"
       - Summary stats next to chart:
         - Total notifications this week
         - Average delivery rate
         - Trend indicator (arrow up/down/stable)
       - DeliveryChart with trends.daily data

    5. Chart should refresh when manual refresh button clicked

    Layout suggestion:
    ```jsx
    <Card className="p-6">
      <div className="flex items-center justify-between mb-4">
        <Heading level={2}>7-Day Delivery Trends</Heading>
        <div className="flex gap-4 text-sm">
          <span>Total: {summary.totalNotifications}</span>
          <span>Avg Rate: {summary.averageDeliveryRate}%</span>
          <span>{trendIcon} {summary.trend}</span>
        </div>
      </div>
      <DeliveryChart data={trends.daily} loading={trendsLoading} />
    </Card>
    ```

    Trend icons:
    - improving: arrow-up (green)
    - declining: arrow-down (red)
    - stable: minus (gray)
  </action>
  <verify>
    - Dashboard shows 7-day chart
    - Chart data fetched from /api/notifications/trends
    - Summary stats displayed above chart
    - Trend indicator shows direction
    - Refresh button updates chart
  </verify>
  <done>
    Dashboard displays interactive 7-day delivery trends chart
  </done>
</task>

</tasks>

<verification>
1. Visit /debug/notifications
2. Chart should show last 7 days of data
3. Bars show sent (green) and failed (red) counts
4. Line shows delivery rate percentage
5. Tooltip shows details on hover
6. Summary shows total, average, and trend
7. Refresh updates chart data
</verification>

<success_criteria>
- /api/notifications/trends returns 7-day daily breakdown
- DeliveryChart component renders ComposedChart
- Dashboard shows chart with bars (sent/failed) and line (rate)
- Summary shows total notifications and trend direction
- Chart refreshes with manual refresh button
- Handles loading and empty states gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-monitoring-infrastructure/02-05-SUMMARY.md`
</output>
