---
phase: 02-production-monitoring-infrastructure
plan: 06
type: execute
wave: 4
depends_on: [02-05]
files_modified:
  - app/api/notifications/check-rate/route.js
  - lib/notificationLogger.js
  - app/debug/notifications/page.js
autonomous: false

must_haves:
  truths:
    - "Delivery rate below 85% triggers alert notification to admin"
    - "Alert rate-limited to max 1 per hour (prevent fatigue)"
    - "Dashboard shows alert status and last check time"
  artifacts:
    - path: "app/api/notifications/check-rate/route.js"
      provides: "Delivery rate check endpoint for cron"
      exports: ["POST", "GET"]
    - path: "lib/notificationLogger.js"
      provides: "Rate alert tracking"
      contains: "shouldSendRateAlert"
  key_links:
    - from: "app/api/notifications/check-rate/route.js"
      to: "lib/notificationLogger.js"
      via: "getDeliveryStats import"
      pattern: "import.*getDeliveryStats.*from.*notificationLogger"
---

<objective>
Implement low delivery rate alerting and final verification of Phase 2 success criteria.

Purpose: Proactively notify admin when notification system health degrades below threshold.
Output: Automated alerting endpoint ready for cron integration, verified monitoring system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-production-monitoring-infrastructure/02-CONTEXT.md
@.planning/phases/02-production-monitoring-infrastructure/02-05-SUMMARY.md
@lib/notificationLogger.js
@lib/firebaseAdmin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate alert tracking to notificationLogger</name>
  <files>lib/notificationLogger.js</files>
  <action>
    Add rate alert tracking functions to lib/notificationLogger.js.

    1. Track last alert time in Firestore:
       - Collection: `systemConfig`
       - Document: `rateAlert`
       - Fields: { lastAlertSent: timestamp, deliveryRate: number }

    2. Create function `shouldSendRateAlert(currentRate)`:
       - Check if currentRate < 85% (warning threshold from 02-CONTEXT.md: 90%, but success criteria says 85%)
       - Check if last alert was sent > 1 hour ago (rate limiting)
       - Return { shouldAlert: boolean, reason: string }

    3. Create function `recordRateAlert(rate)`:
       - Update systemConfig/rateAlert with current timestamp and rate
       - Called after successfully sending an alert

    4. Create function `getLastRateAlertInfo()`:
       - Return last alert time and rate for dashboard display

    Implementation:
    ```javascript
    const RATE_THRESHOLD = 85;  // Alert if below 85%
    const ALERT_COOLDOWN_MS = 60 * 60 * 1000;  // 1 hour between alerts

    export async function shouldSendRateAlert(currentRate) {
      if (currentRate >= RATE_THRESHOLD) {
        return { shouldAlert: false, reason: 'Rate above threshold' };
      }

      const db = getAdminFirestore();
      const alertDoc = await db.collection('systemConfig').doc('rateAlert').get();

      if (!alertDoc.exists) {
        return { shouldAlert: true, reason: 'First alert check' };
      }

      const lastAlert = alertDoc.data().lastAlertSent?.toDate();
      if (!lastAlert) {
        return { shouldAlert: true, reason: 'No previous alert' };
      }

      const elapsed = Date.now() - lastAlert.getTime();
      if (elapsed < ALERT_COOLDOWN_MS) {
        const remaining = Math.ceil((ALERT_COOLDOWN_MS - elapsed) / 60000);
        return { shouldAlert: false, reason: `Alert cooldown (${remaining}min remaining)` };
      }

      return { shouldAlert: true, reason: 'Cooldown expired' };
    }
    ```
  </action>
  <verify>
    - shouldSendRateAlert returns correct decision based on rate and cooldown
    - recordRateAlert updates Firestore document
    - getLastRateAlertInfo returns last alert details
    - 1-hour cooldown enforced between alerts
  </verify>
  <done>
    Rate alert tracking with cooldown logic implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create delivery rate check endpoint</name>
  <files>app/api/notifications/check-rate/route.js</files>
  <action>
    Create app/api/notifications/check-rate/route.js for scheduled rate checking.

    This endpoint is designed to be called by cron-job.org (like /api/notifications/cleanup).

    Endpoint: POST /api/notifications/check-rate
    Auth: Bearer token via CRON_SECRET env var

    Behavior:
    1. Get delivery stats for last 1 hour (per 02-CONTEXT.md: rolling window)
    2. Calculate delivery rate
    3. Check if alert should be sent using shouldSendRateAlert
    4. If alert needed:
       - Send push notification to admin user
       - Record alert with recordRateAlert
    5. Return status

    Response:
    ```javascript
    {
      success: true,
      check: {
        timestamp: ISO string,
        period: '1 hour',
        deliveryRate: 82.5,
        threshold: 85,
        belowThreshold: true,
        alertSent: true | false,
        alertReason: 'Rate below threshold' | 'Cooldown active'
      }
    }
    ```

    Admin notification content:
    ```javascript
    {
      title: 'Delivery Rate Alert',
      body: `Notification delivery rate dropped to ${rate}% (threshold: 85%). Check dashboard for details.`,
      priority: 'high',
      data: {
        type: 'system_alert',
        url: '/debug/notifications'
      }
    }
    ```

    To identify admin user for alerts:
    - Option 1: Use environment variable ADMIN_USER_ID
    - Option 2: Query all users and send to first one (single-user app)
    - Recommend Option 1 for explicit control

    Also implement GET for health check:
    - GET /api/notifications/check-rate
    - Returns endpoint documentation (same pattern as /api/notifications/cleanup)
  </action>
  <verify>
    - POST /api/notifications/check-rate calculates 1-hour rate
    - Alert sent to admin if rate < 85% and cooldown expired
    - Alert NOT sent if rate >= 85% or cooldown active
    - Response shows check details and alert decision
    - GET returns endpoint documentation
    - Auth via CRON_SECRET bearer token
  </verify>
  <done>
    Rate check endpoint ready for cron integration with alert logic
  </done>
</task>

<task type="auto">
  <name>Task 3: Add alert status to dashboard</name>
  <files>app/debug/notifications/page.js</files>
  <action>
    Update app/debug/notifications/page.js to show rate alert status.

    1. Fetch last rate alert info in fetchData:
       - Call getLastRateAlertInfo or add to /api/notifications/stats response
       - Store in state

    2. Add alert status section to dashboard:
       - Show last alert time (if any)
       - Show current rate vs threshold
       - Visual indicator if rate is below threshold
       - Next alert eligibility time (if in cooldown)

    3. Add info box explaining the alerting system:
       - "Automatic alerts are sent when delivery rate drops below 85%"
       - "Rate limited to max 1 alert per hour"
       - "Endpoint: POST /api/notifications/check-rate"
       - "Schedule with cron-job.org for automated monitoring"

    UI location: After the chart section, before error summary.

    Example layout:
    ```jsx
    <Card className="p-4 bg-warning-50 border-warning-200">
      <div className="flex items-center gap-2">
        <BellIcon />
        <Heading level={3}>Rate Alerting</Heading>
      </div>
      <div className="mt-2 grid grid-cols-2 gap-4">
        <div>
          <Text variant="tertiary">Current Rate</Text>
          <Text size="lg" weight="bold" variant={rate < 85 ? 'ember' : 'sage'}>
            {rate}%
          </Text>
        </div>
        <div>
          <Text variant="tertiary">Last Alert</Text>
          <Text size="lg">{lastAlert || 'Never'}</Text>
        </div>
      </div>
      <Text size="sm" variant="tertiary" className="mt-4">
        Alerts sent when rate drops below 85%. Max 1 per hour.
      </Text>
    </Card>
    ```
  </action>
  <verify>
    - Dashboard shows alert status section
    - Current rate displayed with color coding
    - Last alert time shown (or "Never")
    - Info text explains alerting behavior
  </verify>
  <done>
    Dashboard displays rate alert status and information
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 monitoring infrastructure:
    - Notification logging to Firestore
    - Error tracking with device context
    - Dashboard with delivery metrics and charts
    - Test notification panel with templates
    - 7-day trend visualization
    - Rate alerting with cooldown
  </what-built>
  <how-to-verify>
    **Pre-requisites:**
    1. Run `npm install` to install recharts and date-fns
    2. Ensure Firebase credentials configured

    **Test 1: Dashboard Metrics** (Success Criteria #1)
    1. Visit /debug/notifications
    2. Verify delivery rate percentage displayed with color
    3. Verify 85%+ shows green indicator

    **Test 2: Error Logging** (Success Criteria #2)
    1. Check Firebase Realtime Database for notificationErrors path
    2. If errors exist, verify they have timestamp, errorCode, deviceId

    **Test 3: Test Notification** (Success Criteria #3)
    1. Visit /debug/notifications/test
    2. Select a device and template
    3. Click Send - notification should arrive within 5 seconds
    4. Verify delivery confirmation shown in results

    **Test 4: Charts** (Success Criteria #4)
    1. On /debug/notifications, verify chart section visible
    2. Chart should show bars (sent/failed) and line (rate)
    3. Hover should show tooltip with details

    **Test 5: Rate Alerting** (Success Criteria #5)
    1. Verify /api/notifications/check-rate endpoint exists
    2. If delivery rate below 85%, alert should trigger
    3. Rate limited to 1 per hour

    **All Success Criteria from ROADMAP.md:**
    - [ ] Admin dashboard displays delivery rate percentage with target indicator (85%+ = green)
    - [ ] Failed notification appears in error log with timestamp, FCM error code, and device identifier
    - [ ] Admin clicks "Send Test" button, selects device, receives notification within 5 seconds with delivery confirmation
    - [ ] Dashboard charts visualize delivery trends for last 7 days using Recharts
    - [ ] Delivery rate drops below 85%, admin receives alert notification within 1 minute
  </how-to-verify>
  <resume-signal>Type "verified" if all success criteria pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Verification is performed by the human-verify checkpoint task.
</verification>

<success_criteria>
Phase 2 complete when human verifies all 5 success criteria from ROADMAP.md:
1. Dashboard shows delivery rate with 85%+ green indicator
2. Error logs have timestamp, FCM error code, device identifier
3. Test notification arrives within 5 seconds with confirmation
4. 7-day Recharts visualization working
5. Rate alerting triggers when below 85%
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-monitoring-infrastructure/02-06-SUMMARY.md`
</output>
