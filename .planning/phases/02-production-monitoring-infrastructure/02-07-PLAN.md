---
phase: 02-production-monitoring-infrastructure
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/notifications/devices/route.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Device list API returns status field calculated from lastUsed timestamp"
    - "Device list API returns tokenPrefix field (first 20 chars of token)"
    - "Dashboard device list displays status badge correctly (Active/Stale/Unknown)"
    - "Dashboard device list displays token prefix with ellipsis"
  artifacts:
    - path: "app/api/notifications/devices/route.js"
      provides: "Device list with status and tokenPrefix fields"
      exports: ["GET"]
  key_links:
    - from: "app/api/notifications/devices/route.js"
      to: "app/debug/notifications/page.js"
      via: "status and tokenPrefix fields consumed by dashboard"
      pattern: "device\\.status|device\\.tokenPrefix"
---

<objective>
Fix device list API to include status and tokenPrefix fields that the dashboard expects.

Purpose: Close verification gap - dashboard renders broken UI because API missing required fields.
Output: Updated devices API returning calculated status and extracted tokenPrefix.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-production-monitoring-infrastructure/02-VERIFICATION.md
@app/api/notifications/devices/route.js
@app/debug/notifications/page.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status and tokenPrefix to device list API response</name>
  <files>app/api/notifications/devices/route.js</files>
  <action>
    Update app/api/notifications/devices/route.js to calculate and return the missing fields.

    Current code (lines 35-45) transforms tokens but misses status and tokenPrefix.

    Add to the device object mapping:

    1. **tokenPrefix**: Extract first 20 characters of the token
       ```javascript
       tokenPrefix: tokenData.token?.substring(0, 20) || 'unknown'
       ```

    2. **status**: Calculate based on lastUsed timestamp
       ```javascript
       // Calculate status based on lastUsed
       const calculateStatus = (lastUsed) => {
         if (!lastUsed) return 'unknown';
         const lastUsedDate = new Date(lastUsed);
         const now = new Date();
         const daysDiff = Math.floor((now - lastUsedDate) / (1000 * 60 * 60 * 24));

         if (daysDiff <= 7) return 'active';      // Used within 7 days
         if (daysDiff > 30) return 'stale';       // Not used in 30+ days
         return 'active';                          // 8-30 days still considered active
       };
       ```

    3. **id**: Add id field (tokenKey) for table key prop
       ```javascript
       id: tokenKey,
       ```

    The updated device mapping should include:
    - id (tokenKey)
    - tokenKey
    - token
    - deviceId
    - displayName
    - platform
    - browser
    - os
    - createdAt
    - lastUsed
    - status (calculated)
    - tokenPrefix (extracted)

    Use date arithmetic (no external library needed for simple day calculation).
  </action>
  <verify>
    - Call GET /api/notifications/devices
    - Response includes `status` field with value 'active', 'stale', or 'unknown'
    - Response includes `tokenPrefix` field with first 20 chars of token
    - Response includes `id` field matching tokenKey
  </verify>
  <done>
    Device list API returns all fields expected by dashboard, including calculated status and extracted tokenPrefix
  </done>
</task>

</tasks>

<verification>
1. Call GET /api/notifications/devices and verify response shape:
   ```bash
   curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/notifications/devices | jq '.devices[0] | {id, status, tokenPrefix}'
   ```
2. Visit /debug/notifications and verify device list:
   - Status badges render correctly (Active/Stale/Unknown)
   - Token prefix displays with ellipsis (e.g., "fMkK7x8q9Wzyz123abc...")
   - No "undefined" values in the table
3. Run `npm run lint` to check syntax
</verification>

<success_criteria>
- Device list API returns status field (active/stale/unknown)
- Device list API returns tokenPrefix field (first 20 chars)
- Dashboard device list renders without undefined values
- All verification truths from 02-VERIFICATION.md pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-production-monitoring-infrastructure/02-07-SUMMARY.md`
</output>
