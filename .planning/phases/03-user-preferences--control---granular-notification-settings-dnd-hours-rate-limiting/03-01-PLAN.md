---
phase: 03-user-preferences-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - lib/schemas/notificationPreferences.js
autonomous: true

must_haves:
  truths:
    - "Zod schema validates notification preferences with type-level toggles, DND windows, and rate limits"
    - "Default preferences include Alerts + System enabled, Routine disabled (per CONTEXT.md balanced approach)"
  artifacts:
    - path: "lib/schemas/notificationPreferences.js"
      provides: "Zod schema for preferences validation and type inference"
      exports: ["notificationPreferencesSchema", "getDefaultPreferences", "dndWindowSchema", "rateLimitSchema"]
      min_lines: 60
  key_links: []
---

<objective>
Install React Hook Form + Zod dependencies and create the notification preferences Zod schema with type-level toggles, DND windows, and rate limits.

Purpose: Foundation for type-safe form validation and server-side preference validation. INFRA-03 requirement.
Output: Dependencies installed, Zod schema ready for use by settings UI and server filtering.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-CONTEXT.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-RESEARCH.md
@lib/notificationPreferencesService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Hook Form, Zod, and resolvers</name>
  <files>package.json</files>
  <action>
Add react-hook-form, zod, and @hookform/resolvers to dependencies.

NOTE: Project rule says NO npm install. Create a todo for user to run:
```bash
npm install react-hook-form zod @hookform/resolvers
```

Update package.json manually by adding to dependencies:
- "react-hook-form": "^7.54.2"
- "zod": "^3.24.2"
- "@hookform/resolvers": "^3.9.3"

Use stable Zod 3.x (NOT 4.x beta per RESEARCH.md pitfall). RHF 7.x stable.

After adding, note for user to run npm install.
  </action>
  <verify>grep -E "react-hook-form|zod|@hookform/resolvers" package.json shows all 3 dependencies</verify>
  <done>Dependencies added to package.json (user must run npm install)</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schema for notification preferences</name>
  <files>lib/schemas/notificationPreferences.js</files>
  <action>
Create new file lib/schemas/notificationPreferences.js with:

1. DND window schema:
   - id (uuid for React key)
   - startTime (HH:mm string validated with regex - Zod 3.x uses z.string().regex())
   - endTime (HH:mm string)
   - enabled (boolean default true)
   - deviceId (optional string for per-device DND)

2. Rate limit schema:
   - windowMinutes (integer 1-60, default 5)
   - maxPerWindow (integer 1-10, default 1)

3. Main preferences schema (notificationPreferencesSchema):
   - enabledTypes: Record<string, boolean> for type-level toggles
     Default per CONTEXT.md balanced approach:
     - CRITICAL: true, ERROR: true (Alerts)
     - maintenance: true, updates: true (System)
     - scheduler_success: false, status: false (Routine - opt-in)
   - dndWindows: Array of DND windows (max 5)
   - rateLimits: Record<string, rateLimitSchema> per notification type
   - timezone: string (auto-detected)
   - version: integer for conflict detection
   - updatedAt: ISO datetime string

4. Export getDefaultPreferences() function returning parsed default schema

Match existing NOTIFICATION_CATEGORIES_CONFIG types from lib/notificationPreferencesService.js
  </action>
  <verify>node -e "require('./lib/schemas/notificationPreferences.js')" runs without error</verify>
  <done>Zod schema created with type-level toggles, DND windows, rate limits, and default preferences</done>
</task>

</tasks>

<verification>
1. package.json contains react-hook-form, zod, @hookform/resolvers
2. lib/schemas/notificationPreferences.js exports schema and getDefaultPreferences
3. Schema validates default preferences without error
</verification>

<success_criteria>
- React Hook Form, Zod, and resolvers dependencies present in package.json
- Zod schema file exists with all required exports
- Default preferences match CONTEXT.md balanced approach (Alerts + System enabled)
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-01-SUMMARY.md`
</output>
