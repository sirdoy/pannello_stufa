---
phase: 03-user-preferences-control
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/settings/notifications/NotificationSettingsForm.js
  - app/settings/notifications/page.js
autonomous: true

must_haves:
  truths:
    - "User can toggle notification types on/off via form checkboxes"
    - "User can set DND start/end times via native time inputs"
    - "Form validates input with Zod schema before save"
    - "Advanced settings (rate limits) hidden behind progressive disclosure toggle"
  artifacts:
    - path: "app/settings/notifications/NotificationSettingsForm.js"
      provides: "React Hook Form component with Zod validation for notification preferences"
      exports: ["NotificationSettingsForm"]
      min_lines: 120
  key_links:
    - from: "app/settings/notifications/NotificationSettingsForm.js"
      to: "lib/schemas/notificationPreferences.js"
      via: "zodResolver import"
      pattern: "zodResolver.*notificationPreferencesSchema"
---

<objective>
Create the notification settings form component using React Hook Form + Zod with type-level toggles, DND time inputs, and progressive disclosure for advanced settings.

Purpose: User-facing control interface for notification preferences (PREF-01, PREF-02 requirements)
Output: Form component integrated into existing settings page, ready for Firestore sync
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-CONTEXT.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-RESEARCH.md
@lib/schemas/notificationPreferences.js
@app/settings/notifications/page.js
@app/components/NotificationPreferencesPanel.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationSettingsForm component with React Hook Form</name>
  <files>app/settings/notifications/NotificationSettingsForm.js</files>
  <action>
Create new form component `app/settings/notifications/NotificationSettingsForm.js` with:

1. Import React Hook Form + Zod resolver:
   - useForm from 'react-hook-form'
   - zodResolver from '@hookform/resolvers/zod'
   - notificationPreferencesSchema, getDefaultPreferences from '@/lib/schemas/notificationPreferences'

2. Form structure with three semantic categories (per CONTEXT.md):
   - **Alerts Section**: CRITICAL, ERROR toggles (both default ON)
   - **System Section**: maintenance, updates toggles (both default ON)
   - **Routine Section**: scheduler_success, status toggles (both default OFF - opt-in)

3. DND Hours section:
   - Enable/disable DND toggle
   - Start time input (type="time", native HTML5)
   - End time input (type="time", native HTML5)
   - Display auto-detected timezone (read-only, informational)
   - Use Intl.DateTimeFormat().resolvedOptions().timeZone for detection

4. Progressive disclosure for Advanced Settings:
   - "Show Advanced" button toggles visibility
   - When expanded: per-type rate limit controls (windowMinutes, maxPerWindow)
   - Hidden by default (basic mode)

5. Form state management:
   - useForm with zodResolver(notificationPreferencesSchema)
   - defaultValues from props or getDefaultPreferences()
   - mode: 'onBlur' for validation on blur
   - isDirty tracking for save button state

6. Props interface:
   - initialValues: existing preferences (optional)
   - onSubmit: async (data) => void
   - isLoading: boolean
   - isSaving: boolean

7. Use existing UI components from project:
   - Card, Button, Toggle from '@/app/components/ui'
   - Heading, Text from '@/app/components/ui'
   - Follow Ember Noir design system patterns

8. Error display:
   - Show Zod validation errors inline near each field
   - Use Text variant="ember" for error messages

NOTE: This component only handles form rendering and validation.
Firestore sync is handled by separate hook (03-03).
  </action>
  <verify>node -e "require('./app/settings/notifications/NotificationSettingsForm.js')" - if fails, that's expected for JSX. Visual verification needed.</verify>
  <done>NotificationSettingsForm component exists with RHF + Zod integration, category toggles, DND inputs, and progressive disclosure</done>
</task>

<task type="auto">
  <name>Task 2: Integrate form into settings page</name>
  <files>app/settings/notifications/page.js</files>
  <action>
Modify existing `app/settings/notifications/page.js` to:

1. Import new NotificationSettingsForm component

2. Replace or wrap existing NotificationPreferencesPanel with new form:
   - Keep existing page structure (SettingsLayout, permission checks)
   - Replace the "Preferenze Notifiche" Card section with NotificationSettingsForm
   - Pass placeholder onSubmit for now (console.log - actual Firestore sync in 03-03)

3. Add temporary local state for form demonstration:
   - useState for preferences (will be replaced by Firestore hook in 03-03)
   - handleSubmit that logs data and shows success message

4. Preserve existing functionality:
   - Device list section unchanged
   - Test notification section unchanged
   - iOS info section unchanged
   - Permission status section unchanged

5. Add loading state during form submission:
   - isSaving state for submit button
   - Disable form during save

NOTE: Real Firestore persistence is added in 03-03.
This plan focuses on UI structure and validation.
  </action>
  <verify>Open localhost:3000/settings/notifications and verify form renders with category toggles and DND inputs</verify>
  <done>Settings page uses new NotificationSettingsForm, form validates input, shows advanced settings toggle</done>
</task>

</tasks>

<verification>
1. Form component exists at app/settings/notifications/NotificationSettingsForm.js
2. Form imports and uses React Hook Form with Zod resolver
3. Three category sections render with correct default toggles
4. DND section shows time inputs and auto-detected timezone
5. "Show Advanced" toggle reveals rate limit controls
6. Form validation errors display inline when invalid input provided
7. Settings page loads without errors
</verification>

<success_criteria>
- NotificationSettingsForm component renders category toggles (Alerts, System, Routine)
- DND time inputs accept HH:mm format
- Zod validation prevents invalid submissions
- Progressive disclosure hides advanced settings by default
- Form integrates cleanly with existing settings page structure
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-02-SUMMARY.md`
</output>
