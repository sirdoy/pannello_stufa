---
phase: 03-user-preferences-control
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - hooks/useNotificationPreferences.js
  - app/settings/notifications/page.js
autonomous: true

must_haves:
  truths:
    - "Preferences sync in real-time across devices via Firestore onSnapshot"
    - "User updates on phone immediately reflects on tablet (success criteria #4)"
    - "Listener cleans up on unmount to prevent memory leaks"
    - "New users get default preferences on first load"
  artifacts:
    - path: "hooks/useNotificationPreferences.js"
      provides: "Real-time Firestore sync hook for notification preferences"
      exports: ["useNotificationPreferences"]
      min_lines: 80
  key_links:
    - from: "hooks/useNotificationPreferences.js"
      to: "Firestore users/{userId}/settings/notifications"
      via: "onSnapshot listener"
      pattern: "onSnapshot.*doc.*users"
    - from: "app/settings/notifications/page.js"
      to: "hooks/useNotificationPreferences.js"
      via: "useNotificationPreferences import"
      pattern: "useNotificationPreferences"
---

<objective>
Create Firestore real-time sync hook for notification preferences with cross-device instant updates.

Purpose: Implement cross-device preference sync (success criteria #4: "User updates on phone, immediately sees same settings on tablet")
Output: Hook that provides real-time preferences state and save function, integrated with settings page
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-CONTEXT.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-RESEARCH.md
@lib/schemas/notificationPreferences.js
@lib/firebase.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hooks directory and useNotificationPreferences hook</name>
  <files>hooks/useNotificationPreferences.js</files>
  <action>
Create new file `hooks/useNotificationPreferences.js` with:

1. Imports:
   - useState, useEffect, useCallback from 'react'
   - doc, onSnapshot, setDoc, getDoc from 'firebase/firestore'
   - getFirestore from '@/lib/firebase' (use existing firebase config)
   - getDefaultPreferences from '@/lib/schemas/notificationPreferences'

2. Hook signature:
   ```javascript
   export function useNotificationPreferences(userId) {
     // Returns { prefs, loading, error, savePreferences, resetToDefaults }
   }
   ```

3. State management:
   - prefs: current preferences object (null initially)
   - loading: boolean (true until first snapshot)
   - error: Error object or null
   - isSaving: boolean for save operation

4. Real-time listener with onSnapshot:
   - Path: `users/${userId}/settings/notifications`
   - On snapshot: update prefs state, set loading false
   - On error: set error state, set loading false
   - CRITICAL: Return unsubscribe function from useEffect cleanup

5. Handle missing document (new users):
   - If snapshot.exists() is false, use getDefaultPreferences()
   - Optionally write defaults to Firestore on first access

6. savePreferences function:
   - Accepts full preferences object
   - Uses setDoc with merge: true for partial updates
   - Adds updatedAt timestamp
   - Increments version for conflict detection
   - Returns Promise<void>

7. resetToDefaults function:
   - Writes getDefaultPreferences() to Firestore
   - Resets version to 1

8. Cleanup:
   - useEffect returns unsubscribe function
   - Guard against userId changes (re-subscribe)

9. Error handling:
   - Catch Firestore permission errors
   - Log errors with context (userId, operation)
   - Set error state for UI display

Per RESEARCH.md Pitfall #1: ALWAYS return cleanup function to prevent memory leaks.
  </action>
  <verify>node -e "require('./hooks/useNotificationPreferences.js')" runs without syntax errors</verify>
  <done>Hook created with onSnapshot listener, cleanup function, savePreferences, and resetToDefaults</done>
</task>

<task type="auto">
  <name>Task 2: Wire hook to settings page and form</name>
  <files>app/settings/notifications/page.js</files>
  <action>
Update `app/settings/notifications/page.js` to use real Firestore sync:

1. Import useNotificationPreferences hook:
   ```javascript
   import { useNotificationPreferences } from '@/hooks/useNotificationPreferences';
   ```

2. Replace temporary local state with hook:
   ```javascript
   const { prefs, loading, error, savePreferences, resetToDefaults } =
     useNotificationPreferences(user?.sub);
   ```

3. Update NotificationSettingsForm integration:
   - Pass prefs as initialValues (with reset() when prefs change)
   - Pass savePreferences as onSubmit handler
   - Pass loading state for form disabled state
   - Pass error for error display

4. Handle loading states:
   - Show skeleton while preferences loading
   - Disable form during save operation

5. Handle errors:
   - Display Firestore permission errors
   - Offer retry option

6. Add real-time sync indicator (optional but nice):
   - Small "synced" badge when prefs update from another device
   - Brief flash to indicate cross-device update received

7. Update form reset handler:
   - Call resetToDefaults from hook
   - Show confirmation before reset

8. Ensure preferences survive page refresh:
   - Hook loads from Firestore on mount
   - No dependency on localStorage for preferences
  </action>
  <verify>
1. Open settings page on two devices (or browser tabs)
2. Change a preference on device A
3. Verify change appears on device B within 1-2 seconds
  </verify>
  <done>Settings page uses real-time Firestore sync, changes propagate across devices instantly</done>
</task>

</tasks>

<verification>
1. hooks/useNotificationPreferences.js exists with all exports
2. Hook returns prefs, loading, error, savePreferences, resetToDefaults
3. onSnapshot listener established on component mount
4. Listener cleanup on unmount (no memory leak warnings)
5. Cross-device sync verified: change on one device appears on another
6. New user gets default preferences
7. Save operation updates Firestore and all listeners receive update
</verification>

<success_criteria>
- Real-time Firestore listener syncs preferences across devices
- Changes made on phone immediately visible on tablet (success criteria #4)
- No memory leaks from uncleaned listeners
- New users receive balanced defaults (Alerts + System enabled)
- Error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-03-SUMMARY.md`
</output>
