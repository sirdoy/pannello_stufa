---
phase: 03-user-preferences-control
plan: 06
type: execute
wave: 4
depends_on: ["03-02", "03-03", "03-04", "03-05"]
files_modified:
  - app/settings/notifications/page.js
  - lib/notificationFilter.js
autonomous: false

must_haves:
  truths:
    - "All 5 success criteria from ROADMAP verified and passing"
    - "Settings UI connects to Firestore sync (03-02 + 03-03 wired)"
    - "Server filtering uses rate limiter (03-04 + 03-05 wired)"
    - "End-to-end flow tested: UI change → Firestore → server filter → notification blocked"
  artifacts:
    - path: ".planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-VERIFICATION.md"
      provides: "Verification results for all Phase 3 success criteria"
      min_lines: 50
  key_links:
    - from: "app/settings/notifications/page.js"
      to: "hooks/useNotificationPreferences.js"
      via: "useNotificationPreferences hook"
      pattern: "useNotificationPreferences"
    - from: "lib/firebaseAdmin.js"
      to: "lib/notificationFilter.js"
      via: "filterNotificationByPreferences"
      pattern: "filterNotificationByPreferences"
    - from: "lib/notificationFilter.js"
      to: "lib/rateLimiter.js"
      via: "checkRateLimit"
      pattern: "checkRateLimit"
---

<objective>
Wire all Phase 3 components together and verify all 5 success criteria are met.

Purpose: Integration checkpoint ensuring all PREF requirements work end-to-end
Output: Verified Phase 3 with documented test results for each success criterion
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-CONTEXT.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-02-SUMMARY.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-03-SUMMARY.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-04-SUMMARY.md
@.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Final integration wiring</name>
  <files>app/settings/notifications/page.js, lib/notificationFilter.js</files>
  <action>
Ensure all components are properly wired together:

1. Verify settings page (03-02 + 03-03):
   - NotificationSettingsForm uses useNotificationPreferences hook
   - Form onSubmit calls savePreferences from hook
   - initialValues populated from Firestore prefs
   - Form resets when external prefs update (cross-device sync)

2. Verify server filter chain (03-04 + 03-05):
   - notificationFilter.js imports and calls checkRateLimit
   - firebaseAdmin.js calls filterNotificationByPreferences
   - Filter order: type check → rate limit → DND filter

3. Fix any missing imports or wiring issues discovered during integration

4. Add any missing error handling:
   - Graceful degradation if Firestore unavailable
   - Fallback to defaults if preferences fetch fails
   - Log errors with context for debugging

5. Ensure default preferences align:
   - Schema defaults (lib/schemas/notificationPreferences.js)
   - Hook defaults (hooks/useNotificationPreferences.js)
   - Filter defaults (lib/notificationFilter.js)
   - All should use getDefaultPreferences() for consistency
  </action>
  <verify>npm run dev starts without errors, settings page loads preferences from Firestore</verify>
  <done>All Phase 3 components wired together with consistent defaults and error handling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete notification preferences system:
- Settings UI with category toggles and DND controls
- Firestore real-time sync across devices
- Server-side filtering (type toggles, DND hours)
- Rate limiting per notification type
  </what-built>
  <how-to-verify>
**Success Criteria #1: Type Toggle**
1. Go to /settings/notifications
2. Disable "Scheduler" notifications (toggle OFF)
3. Save preferences
4. Trigger a scheduler event (or use test API)
5. Verify notification NOT received
6. Re-enable scheduler and verify notification IS received

**Success Criteria #2: DND Hours**
1. Set DND hours 22:00-08:00 (or current time range for testing)
2. Save preferences
3. Trigger a non-CRITICAL notification
4. Verify notification NOT received during DND
5. Trigger a CRITICAL notification
6. Verify CRITICAL IS received (bypasses DND)

**Success Criteria #3: Rate Limiting**
1. Ensure scheduler_success notifications enabled
2. Trigger 3 scheduler success events within 4 minutes
3. Verify only 1 notification received (first one)
4. Check logs for "Rate limit hit" messages

**Success Criteria #4: Cross-Device Sync**
1. Open settings on two devices (or browser tabs)
2. Change a preference on device A
3. Verify change appears on device B within 1-2 seconds
4. No page refresh needed on device B

**Success Criteria #5: Default Preferences**
1. Use incognito/new user (clear user data)
2. Go to /settings/notifications
3. Verify defaults: Alerts enabled, System enabled, Routine disabled
4. Verify these match CONTEXT.md "balanced approach"
  </how-to-verify>
  <resume-signal>
Report results for each success criterion:
- #1 Type Toggle: PASS/FAIL
- #2 DND Hours: PASS/FAIL
- #3 Rate Limiting: PASS/FAIL
- #4 Cross-Device Sync: PASS/FAIL
- #5 Default Preferences: PASS/FAIL

If any fail, describe the issue.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create verification document</name>
  <files>.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-VERIFICATION.md</files>
  <action>
Create verification document recording test results:

```markdown
# Phase 3 Verification: User Preferences & Control

**Verified:** [DATE]
**Verifier:** [USER]

## Success Criteria Results

### #1: Type Toggle Filtering
**Requirement:** User disables "Scheduler" notifications → scheduler events no longer trigger push
**Result:** [PASS/FAIL]
**Evidence:** [Description of test and outcome]

### #2: DND Hours Enforcement
**Requirement:** User sets DND 22:00-08:00 Europe/Rome → no notifications during those hours
**Result:** [PASS/FAIL]
**Evidence:** [Description of test and outcome]
**Note:** CRITICAL notifications bypass DND as designed

### #3: Rate Limiting
**Requirement:** Scheduler fires 3 events in 4 min → user receives only 1 notification
**Result:** [PASS/FAIL]
**Evidence:** [Description of test and outcome]

### #4: Cross-Device Sync
**Requirement:** User updates on phone → immediately sees same settings on tablet
**Result:** [PASS/FAIL]
**Evidence:** [Description of test and outcome]

### #5: Default Preferences
**Requirement:** New user sees Alerts + System enabled (balanced approach)
**Result:** [PASS/FAIL]
**Evidence:** [Description of test and outcome]

## Requirements Coverage

| Requirement | Status | Notes |
|-------------|--------|-------|
| PREF-01 | [DONE/PARTIAL/BLOCKED] | Type-level notification toggles |
| PREF-02 | [DONE/PARTIAL/BLOCKED] | DND hours configuration |
| PREF-03 | [DONE/PARTIAL/BLOCKED] | Rate limiting per type |
| PREF-04 | [DONE/PARTIAL/BLOCKED] | Cross-device sync |
| PREF-05 | [DONE/PARTIAL/BLOCKED] | Default preferences |
| INFRA-03 | [DONE/PARTIAL/BLOCKED] | React Hook Form + Zod |

## Known Issues

[List any issues discovered during verification]

## Phase Complete

- [x] All success criteria verified
- [x] All requirements addressed
- [x] No blocking issues
```

Fill in actual test results from checkpoint verification.
  </action>
  <verify>03-VERIFICATION.md exists with all criteria documented</verify>
  <done>Verification document created with all test results</done>
</task>

</tasks>

<verification>
1. All 5 success criteria tested and documented
2. All PREF requirements covered
3. End-to-end flow works: Settings UI → Firestore → Server Filter → Notification
4. Cross-device sync verified (2+ devices)
5. Rate limiting verified (3 events → 1 notification)
6. CRITICAL bypass verified (DND doesn't block CRITICAL)
7. Default preferences match CONTEXT.md balanced approach
</verification>

<success_criteria>
- All 5 ROADMAP success criteria pass verification
- Phase 3 complete with no blocking issues
- 03-VERIFICATION.md documents all test results
- User can control notification behavior end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-preferences--control---granular-notification-settings-dnd-hours-rate-limiting/03-06-SUMMARY.md`
</output>
