---
phase: 04-notification-history-devices
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/notifications/devices/[tokenKey]/route.js
autonomous: true

must_haves:
  truths:
    - "User can rename their devices via PATCH request"
    - "User can remove their devices via DELETE request"
    - "Only device owner can modify their own devices"
    - "Removed device stops receiving notifications"
  artifacts:
    - path: "app/api/notifications/devices/[tokenKey]/route.js"
      provides: "Device naming and removal endpoints"
      exports: ["PATCH", "DELETE"]
  key_links:
    - from: "app/api/notifications/devices/[tokenKey]/route.js"
      to: "lib/firebaseAdmin.js"
      via: "adminDbUpdate, adminDbGet, adminDbRemove"
      pattern: "adminDb(Update|Get|Remove)"
---

<objective>
Create device management API endpoints for naming and removal.

Purpose: Enable users to customize device names and remove devices they no longer use. This implements DEVICE-01 (naming) and DEVICE-03 (removal) requirements.

Output:
- PATCH `/api/notifications/devices/[tokenKey]` - Update device name
- DELETE `/api/notifications/devices/[tokenKey]` - Remove device
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-notification-history-a-devices/04-RESEARCH.md
@app/api/notifications/devices/route.js
@lib/firebaseAdmin.js
@lib/core.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create device management endpoint (PATCH + DELETE)</name>
  <files>app/api/notifications/devices/[tokenKey]/route.js</files>
  <action>
Create dynamic route for device-specific operations:

1. **PATCH handler** - Update device display name:
   - Accept JSON body: `{ displayName: string }`
   - Validate displayName is non-empty string (max 50 chars)
   - Verify tokenKey belongs to authenticated user via `adminDbGet`
   - Update device with new displayName and updatedAt timestamp
   - Return success with updated device info

2. **DELETE handler** - Remove device:
   - Verify tokenKey belongs to authenticated user
   - Remove device from `users/{userId}/fcmTokens/{tokenKey}`
   - Return success with confirmation message

Follow existing patterns from `/api/notifications/devices/route.js`:

```javascript
import {
  withAuthAndErrorHandler,
  success,
  error,
  parseJsonOrThrow,
  validateRequired,
} from '@/lib/core';
import { adminDbGet, adminDbUpdate, adminDbRemove } from '@/lib/firebaseAdmin';

export const dynamic = 'force-dynamic';

// PATCH /api/notifications/devices/[tokenKey]
export const PATCH = withAuthAndErrorHandler(async (request, context, session) => {
  const userId = session.user.sub;
  const { tokenKey } = await context.params;
  const body = await parseJsonOrThrow(request);

  // Validate displayName
  const { displayName } = body;
  if (!displayName || typeof displayName !== 'string') {
    return error('displayName is required', 400);
  }
  if (displayName.length > 50) {
    return error('displayName must be 50 characters or less', 400);
  }

  // Verify device belongs to user
  const devicePath = `users/${userId}/fcmTokens/${tokenKey}`;
  const device = await adminDbGet(devicePath);
  if (!device) {
    return error('Device not found', 404);
  }

  // Update device name
  await adminDbUpdate(devicePath, {
    displayName: displayName.trim(),
    updatedAt: new Date().toISOString(),
  });

  return success({
    message: 'Device name updated',
    displayName: displayName.trim(),
    tokenKey,
  });
}, 'Notifications/DeviceName');

// DELETE /api/notifications/devices/[tokenKey]
export const DELETE = withAuthAndErrorHandler(async (request, context, session) => {
  const userId = session.user.sub;
  const { tokenKey } = await context.params;

  // Verify device belongs to user
  const devicePath = `users/${userId}/fcmTokens/${tokenKey}`;
  const device = await adminDbGet(devicePath);
  if (!device) {
    return error('Device not found', 404);
  }

  // Remove device
  await adminDbRemove(devicePath);

  return success({
    message: 'Device removed successfully',
    tokenKey,
  });
}, 'Notifications/DeviceRemove');
```

Security considerations:
- Always verify device ownership before modification
- Use `context.params` with await (Next.js 15 requirement)
- Trim displayName to prevent whitespace-only names
  </action>
  <verify>
Check file exists with both handlers:
```bash
grep -q "export const PATCH" app/api/notifications/devices/\[tokenKey\]/route.js && \
grep -q "export const DELETE" app/api/notifications/devices/\[tokenKey\]/route.js && \
echo "OK"
```
  </verify>
  <done>
Device management endpoint exists at `/api/notifications/devices/[tokenKey]` with:
- PATCH handler for updating displayName (validates ownership, max 50 chars)
- DELETE handler for removing device (validates ownership, removes from Firebase)
- Both return appropriate success/error responses
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify adminDbRemove exists in firebaseAdmin.js</name>
  <files>lib/firebaseAdmin.js</files>
  <action>
Check if `adminDbRemove` function exists in `firebaseAdmin.js`. If not, add it:

```javascript
/**
 * Remove a value from Firebase Realtime Database
 * @param {string} path - Database path
 * @returns {Promise<void>}
 */
export async function adminDbRemove(path) {
  const db = getAdminDatabase();
  await db.ref(path).remove();
  console.log(`üóëÔ∏è Firebase RTDB removed: ${path}`);
}
```

This follows the existing patterns:
- `adminDbGet(path)` - reads data
- `adminDbSet(path, data)` - writes data
- `adminDbUpdate(path, data)` - updates data
- `adminDbRemove(path)` - removes data (NEW)

Only add if not already present. Check with:
```bash
grep "adminDbRemove" lib/firebaseAdmin.js
```
  </action>
  <verify>
Function exists:
```bash
grep -q "export.*function adminDbRemove" lib/firebaseAdmin.js || \
grep -q "export async function adminDbRemove" lib/firebaseAdmin.js && \
echo "OK"
```
  </verify>
  <done>
`adminDbRemove` function exists in `firebaseAdmin.js` and can be imported by the device endpoint.
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. `/api/notifications/devices/[tokenKey]` route file exists
2. PATCH handler updates device displayName
3. DELETE handler removes device from database
4. `adminDbRemove` function available in firebaseAdmin.js
</verification>

<success_criteria>
- PATCH request with `{ displayName: "Kitchen iPad" }` updates device name
- DELETE request removes device from user's fcmTokens
- Unauthorized users cannot modify other users' devices
- Invalid tokenKey returns 404 error
</success_criteria>

<output>
After completion, create `.planning/phases/04-notification-history-a-devices/04-02-SUMMARY.md`
</output>
