---
phase: 04-notification-history-devices
plan: 04
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - app/settings/notifications/devices/page.js
  - components/notifications/DeviceListItem.js
autonomous: true

must_haves:
  truths:
    - "User sees list of registered devices with custom names"
    - "User can rename devices inline"
    - "User can remove devices with confirmation"
    - "Device status (Active/Stale/Unknown) is clearly visible"
    - "Last used timestamp shown for each device"
  artifacts:
    - path: "app/settings/notifications/devices/page.js"
      provides: "FCM device management page"
      min_lines: 100
    - path: "components/notifications/DeviceListItem.js"
      provides: "Device row with rename/remove actions"
      min_lines: 80
  key_links:
    - from: "app/settings/notifications/devices/page.js"
      to: "/api/notifications/devices"
      via: "fetch GET"
      pattern: "fetch.*api/notifications/devices"
    - from: "components/notifications/DeviceListItem.js"
      to: "/api/notifications/devices/[tokenKey]"
      via: "fetch PATCH/DELETE"
      pattern: "fetch.*api/notifications/devices"
---

<objective>
Create enhanced device management UI with naming and removal capabilities.

Purpose: Enable users to manage their registered FCM devices - rename for identification and remove unwanted devices. This implements DEVICE-01, DEVICE-02, DEVICE-03, DEVICE-04 requirements.

Output:
- Device management page at `/settings/notifications/devices`
- DeviceListItem component with inline rename and remove actions
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-notification-history-a-devices/04-RESEARCH.md
@.planning/phases/04-notification-history-a-devices/04-02-SUMMARY.md
@app/settings/notifications/page.js
@app/api/notifications/devices/route.js
@app/components/ui/Card.js
@app/components/ui/Button.js
@app/components/ui/Input.js
@app/components/SettingsLayout.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DeviceListItem component</name>
  <files>components/notifications/DeviceListItem.js</files>
  <action>
Create component for device row with rename/remove actions:

```javascript
'use client';

import { useState } from 'react';
import { formatDistanceToNow } from 'date-fns';
import { it } from 'date-fns/locale';
import { Card, Button, Input, Text } from '@/app/components/ui';

/**
 * Get status styling
 */
const getStatusStyle = (status) => {
  const styles = {
    active: {
      text: 'Attivo',
      className: 'bg-sage-500/20 text-sage-400 [html:not(.dark)_&]:bg-sage-100 [html:not(.dark)_&]:text-sage-700',
    },
    stale: {
      text: 'Inattivo',
      className: 'bg-copper-500/20 text-copper-400 [html:not(.dark)_&]:bg-copper-100 [html:not(.dark)_&]:text-copper-700',
    },
    unknown: {
      text: 'Sconosciuto',
      className: 'bg-slate-500/20 text-slate-400 [html:not(.dark)_&]:bg-slate-200 [html:not(.dark)_&]:text-slate-600',
    },
  };
  return styles[status] || styles.unknown;
};

/**
 * Get device icon
 */
const getDeviceIcon = (platform, browser) => {
  if (platform === 'ios') return 'üì±';
  if (platform === 'android') return 'üì±';
  if (browser?.toLowerCase().includes('safari')) return 'üß≠';
  if (browser?.toLowerCase().includes('chrome')) return 'üåê';
  if (browser?.toLowerCase().includes('firefox')) return 'ü¶ä';
  return 'üíª';
};

export default function DeviceListItem({
  device,
  isCurrentDevice,
  onUpdate,
  onRemove,
}) {
  const [isEditing, setIsEditing] = useState(false);
  const [editName, setEditName] = useState(device.displayName || '');
  const [isSaving, setIsSaving] = useState(false);
  const [isRemoving, setIsRemoving] = useState(false);
  const [error, setError] = useState(null);

  const statusStyle = getStatusStyle(device.status);

  // Handle save name
  const handleSave = async () => {
    if (!editName.trim()) {
      setError('Il nome non pu√≤ essere vuoto');
      return;
    }
    if (editName.length > 50) {
      setError('Il nome deve essere massimo 50 caratteri');
      return;
    }

    setIsSaving(true);
    setError(null);

    const previousName = device.displayName;

    // Optimistic update
    onUpdate(device.tokenKey, { displayName: editName.trim() });
    setIsEditing(false);

    try {
      const res = await fetch(`/api/notifications/devices/${device.tokenKey}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ displayName: editName.trim() }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Errore nel salvataggio');
      }
    } catch (err) {
      // Rollback on failure
      onUpdate(device.tokenKey, { displayName: previousName });
      setEditName(previousName);
      setError(err.message);
      setIsEditing(true);
    } finally {
      setIsSaving(false);
    }
  };

  // Handle remove with confirmation
  const handleRemove = async () => {
    const confirmed = window.confirm(
      `Rimuovere "${device.displayName || 'Dispositivo'}"?\n\nQuesto dispositivo non ricever√† pi√π notifiche.`
    );

    if (!confirmed) return;

    setIsRemoving(true);
    setError(null);

    try {
      const res = await fetch(`/api/notifications/devices/${device.tokenKey}`, {
        method: 'DELETE',
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Errore nella rimozione');
      }

      // Notify parent to remove from list
      onRemove(device.tokenKey);
    } catch (err) {
      setError(err.message);
      setIsRemoving(false);
    }
  };

  // Handle cancel edit
  const handleCancel = () => {
    setEditName(device.displayName || '');
    setIsEditing(false);
    setError(null);
  };

  return (
    <div className="p-4 bg-slate-800/50 [html:not(.dark)_&]:bg-slate-50 border border-slate-700/50 [html:not(.dark)_&]:border-slate-200 rounded-xl">
      <div className="flex flex-col sm:flex-row sm:items-start gap-4">
        {/* Device info */}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-2">
            {/* Icon */}
            <span className="text-xl flex-shrink-0">
              {getDeviceIcon(device.platform, device.browser)}
            </span>

            {/* Name - editable or display */}
            {isEditing ? (
              <div className="flex-1 flex items-center gap-2">
                <Input
                  value={editName}
                  onChange={(e) => setEditName(e.target.value)}
                  placeholder="Nome dispositivo"
                  size="sm"
                  maxLength={50}
                  autoFocus
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') handleSave();
                    if (e.key === 'Escape') handleCancel();
                  }}
                  className="flex-1"
                />
                <Button
                  variant="primary"
                  size="sm"
                  onClick={handleSave}
                  disabled={isSaving}
                >
                  {isSaving ? '...' : '‚úì'}
                </Button>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={handleCancel}
                  disabled={isSaving}
                >
                  ‚úï
                </Button>
              </div>
            ) : (
              <button
                onClick={() => setIsEditing(true)}
                className="text-left flex-1 min-w-0 group"
              >
                <Text weight="medium" className="truncate group-hover:text-ember-400 transition-colors">
                  {device.displayName || 'Dispositivo senza nome'}
                </Text>
                <span className="ml-2 opacity-0 group-hover:opacity-100 text-xs text-ember-400 transition-opacity">
                  ‚úé
                </span>
              </button>
            )}

            {/* Current device badge */}
            {isCurrentDevice && (
              <span className="px-2 py-0.5 text-xs font-medium bg-ocean-500/20 text-ocean-400 [html:not(.dark)_&]:bg-ocean-100 [html:not(.dark)_&]:text-ocean-700 rounded-full flex-shrink-0">
                Questo dispositivo
              </span>
            )}

            {/* Status badge */}
            <span className={`px-2 py-0.5 text-xs font-medium rounded-full flex-shrink-0 ${statusStyle.className}`}>
              {statusStyle.text}
            </span>
          </div>

          {/* Device details */}
          <div className="ml-8 space-y-1">
            <Text variant="secondary" size="sm">
              {device.browser || 'Browser'} ‚Ä¢ {device.os || 'Sistema'}
            </Text>
            <Text variant="tertiary" size="xs">
              Ultimo utilizzo:{' '}
              {device.lastUsed
                ? formatDistanceToNow(new Date(device.lastUsed), {
                    addSuffix: true,
                    locale: it,
                  })
                : 'Mai'}
            </Text>
            {device.tokenPrefix && (
              <Text variant="tertiary" size="xs" className="font-mono">
                Token: {device.tokenPrefix}...
              </Text>
            )}
          </div>

          {/* Error message */}
          {error && (
            <div className="ml-8 mt-2">
              <Text variant="ember" size="sm">
                {error}
              </Text>
            </div>
          )}
        </div>

        {/* Actions */}
        <div className="flex gap-2 sm:flex-col">
          <Button
            variant="ghost"
            size="sm"
            onClick={handleRemove}
            disabled={isRemoving || isCurrentDevice}
            className="text-ember-400 hover:text-ember-300 [html:not(.dark)_&]:text-ember-600 [html:not(.dark)_&]:hover:text-ember-700"
          >
            {isRemoving ? 'Rimozione...' : 'Rimuovi'}
          </Button>
        </div>
      </div>

      {/* Warning for current device removal */}
      {isCurrentDevice && (
        <div className="mt-3 ml-8">
          <Text variant="tertiary" size="xs">
            Non puoi rimuovere il dispositivo corrente
          </Text>
        </div>
      )}
    </div>
  );
}
```

Key features:
- Inline editing with Enter/Escape support
- Optimistic update with rollback on failure
- Confirmation dialog before removal (Pitfall #4)
- Current device badge and removal protection
- Status badge with color variants
- Token prefix display for debugging
  </action>
  <verify>
Component file exists:
```bash
test -f components/notifications/DeviceListItem.js && echo "OK"
```
  </verify>
  <done>
DeviceListItem component displays device with editable name, status badge, last used timestamp, and remove button with confirmation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create device management page</name>
  <files>app/settings/notifications/devices/page.js</files>
  <action>
Create dedicated FCM device management page:

```javascript
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useUser } from '@auth0/nextjs-auth0/client';
import SettingsLayout from '@/app/components/SettingsLayout';
import { Card, Button, Heading, Text, Skeleton, EmptyState, Banner } from '@/app/components/ui';
import DeviceListItem from '@/components/notifications/DeviceListItem';
import { checkStoredToken } from '@/lib/notificationService';

export default function DeviceManagementPage() {
  const { user, isLoading: userLoading } = useUser();
  const [devices, setDevices] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [currentToken, setCurrentToken] = useState(null);

  // Fetch devices
  const fetchDevices = useCallback(async () => {
    try {
      setError(null);
      const res = await fetch('/api/notifications/devices');

      if (!res.ok) {
        throw new Error('Errore nel caricamento dei dispositivi');
      }

      const data = await res.json();
      setDevices(data.devices || []);
    } catch (err) {
      console.error('Error fetching devices:', err);
      setError(err.message);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Get current device token
  useEffect(() => {
    const loadCurrentToken = async () => {
      try {
        const result = await checkStoredToken();
        if (result.token) {
          setCurrentToken(result.token);
        }
      } catch (err) {
        console.error('Error loading current token:', err);
      }
    };

    if (user?.sub) {
      loadCurrentToken();
      fetchDevices();
    }
  }, [user?.sub, fetchDevices]);

  // Handle device update (optimistic)
  const handleDeviceUpdate = (tokenKey, updates) => {
    setDevices(prev =>
      prev.map(d =>
        d.tokenKey === tokenKey ? { ...d, ...updates } : d
      )
    );
  };

  // Handle device removal
  const handleDeviceRemove = (tokenKey) => {
    setDevices(prev => prev.filter(d => d.tokenKey !== tokenKey));
  };

  // Loading state
  if (userLoading || (isLoading && !devices.length)) {
    return (
      <SettingsLayout title="Dispositivi Notifiche" icon="üì±">
        <div className="space-y-4">
          <Skeleton className="h-24 w-full rounded-xl" />
          <Skeleton className="h-24 w-full rounded-xl" />
          <Skeleton className="h-24 w-full rounded-xl" />
        </div>
      </SettingsLayout>
    );
  }

  // Not authenticated
  if (!user) {
    return (
      <SettingsLayout title="Dispositivi Notifiche" icon="üì±">
        <Card liquid className="p-8 text-center">
          <div className="text-6xl mb-4">üîê</div>
          <Heading level={2} size="xl" className="mb-2">
            Autenticazione Richiesta
          </Heading>
          <Text variant="secondary" className="mb-6">
            Devi effettuare il login per gestire i dispositivi
          </Text>
          <Button
            liquid
            variant="primary"
            onClick={() => (window.location.href = '/auth/login')}
          >
            Accedi
          </Button>
        </Card>
      </SettingsLayout>
    );
  }

  // Error state
  if (error && devices.length === 0) {
    return (
      <SettingsLayout title="Dispositivi Notifiche" icon="üì±">
        <Card liquid className="p-8 text-center">
          <div className="text-6xl mb-4">‚ùå</div>
          <Heading level={2} size="xl" className="mb-2">
            Errore
          </Heading>
          <Text variant="secondary" className="mb-6">
            {error}
          </Text>
          <Button variant="secondary" onClick={fetchDevices}>
            Riprova
          </Button>
        </Card>
      </SettingsLayout>
    );
  }

  return (
    <SettingsLayout title="Dispositivi Notifiche" icon="üì±">
      {/* Description */}
      <div className="space-y-2 mb-6">
        <Text variant="secondary" size="sm">
          Gestisci i dispositivi registrati per le notifiche push.
          Puoi rinominare i dispositivi per identificarli facilmente o rimuovere quelli non pi√π in uso.
        </Text>
      </div>

      {/* Info banner */}
      <Banner
        variant="info"
        description="I dispositivi rimossi non riceveranno pi√π notifiche. I dispositivi inattivi da oltre 30 giorni sono evidenziati come 'Inattivo'."
      />

      {/* Device count */}
      <div className="flex items-center justify-between">
        <Heading level={2} size="lg">
          Dispositivi Registrati
        </Heading>
        <Text variant="secondary" size="sm">
          {devices.length} {devices.length === 1 ? 'dispositivo' : 'dispositivi'}
        </Text>
      </div>

      {/* Device list or empty state */}
      {devices.length === 0 ? (
        <Card liquid className="p-8">
          <EmptyState
            icon="üì±"
            title="Nessun dispositivo registrato"
            description="Abilita le notifiche su questo dispositivo per iniziare a ricevere aggiornamenti"
          />
          <div className="mt-6 text-center">
            <Button
              variant="primary"
              onClick={() => (window.location.href = '/settings/notifications')}
            >
              Vai alle impostazioni notifiche
            </Button>
          </div>
        </Card>
      ) : (
        <div className="space-y-3">
          {devices.map(device => (
            <DeviceListItem
              key={device.tokenKey}
              device={device}
              isCurrentDevice={device.token === currentToken}
              onUpdate={handleDeviceUpdate}
              onRemove={handleDeviceRemove}
            />
          ))}
        </div>
      )}

      {/* Refresh button */}
      {devices.length > 0 && (
        <div className="flex justify-center">
          <Button
            variant="ghost"
            size="sm"
            onClick={fetchDevices}
            disabled={isLoading}
          >
            {isLoading ? 'Aggiornamento...' : '‚Üª Aggiorna lista'}
          </Button>
        </div>
      )}

      {/* Back link */}
      <Card liquid className="p-4 mt-6">
        <div className="flex items-center justify-between">
          <Text variant="secondary" size="sm">
            Torna alle impostazioni notifiche
          </Text>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => (window.location.href = '/settings/notifications')}
          >
            ‚Üê Indietro
          </Button>
        </div>
      </Card>
    </SettingsLayout>
  );
}
```

Key features:
- Fetches devices from existing API
- Identifies current device for special handling
- Optimistic UI updates for rename
- Removes device from list on successful delete
- Manual refresh capability
- Loading, error, and empty states
  </action>
  <verify>
Page file exists:
```bash
test -f app/settings/notifications/devices/page.js && echo "OK"
```
  </verify>
  <done>
Device management page at `/settings/notifications/devices` shows device list with rename/remove capabilities, status badges, and current device identification.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add links to device and history pages from main notifications page</name>
  <files>app/settings/notifications/page.js</files>
  <action>
Add navigation links to the main notifications settings page for history and device management:

Find the "Debug Logs Link" Card section at the end of the page and add two more cards BEFORE it:

```javascript
{/* Notification History Link */}
<Card liquid className="p-4 sm:p-6">
  <div className="flex items-center justify-between gap-4">
    <div className="flex items-center gap-3 flex-1 min-w-0">
      <div className="text-xl flex-shrink-0">üì¨</div>
      <div className="min-w-0">
        <Text weight="medium">Cronologia Notifiche</Text>
        <Text variant="tertiary" size="sm">
          Visualizza tutte le notifiche inviate
        </Text>
      </div>
    </div>
    <Button
      liquid
      variant="ghost"
      size="sm"
      onClick={() => (window.location.href = '/settings/notifications/history')}
    >
      Apri
    </Button>
  </div>
</Card>

{/* Device Management Link */}
<Card liquid className="p-4 sm:p-6">
  <div className="flex items-center justify-between gap-4">
    <div className="flex items-center gap-3 flex-1 min-w-0">
      <div className="text-xl flex-shrink-0">üì±</div>
      <div className="min-w-0">
        <Text weight="medium">Gestione Dispositivi</Text>
        <Text variant="tertiary" size="sm">
          Rinomina o rimuovi dispositivi registrati
        </Text>
      </div>
    </div>
    <Button
      liquid
      variant="ghost"
      size="sm"
      onClick={() => (window.location.href = '/settings/notifications/devices')}
    >
      Apri
    </Button>
  </div>
</Card>
```

These should be placed after the "Dispositivi Registrati" Card and before the "Info iOS" Card.
  </action>
  <verify>
Links added to page:
```bash
grep -q "notifications/history" app/settings/notifications/page.js && \
grep -q "notifications/devices" app/settings/notifications/page.js && \
echo "OK"
```
  </verify>
  <done>
Main notifications page includes navigation links to history and device management pages.
  </done>
</task>

</tasks>

<verification>
All tasks complete when:
1. DeviceListItem component renders device with rename/remove
2. Device management page accessible at /settings/notifications/devices
3. Navigation links added to main notifications settings page
4. Users can rename devices inline
5. Users can remove devices with confirmation
</verification>

<success_criteria>
- Device list shows all registered devices with status badges
- Clicking device name enables inline editing
- Saving name calls PATCH API and updates UI optimistically
- Remove button shows confirmation dialog
- Confirmed removal calls DELETE API and removes from list
- Current device cannot be removed
- Navigation from main settings page works
</success_criteria>

<output>
After completion, create `.planning/phases/04-notification-history-a-devices/04-04-SUMMARY.md`
</output>
