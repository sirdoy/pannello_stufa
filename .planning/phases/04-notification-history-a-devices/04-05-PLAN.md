---
phase: 04-notification-history-devices
plan: 05
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User opens notification history and sees chronological list with infinite scroll"
    - "User filters by Error type and sees only error notifications"
    - "User views device list with named devices"
    - "User removes device and it disappears from list"
    - "90-day GDPR filter working (old notifications not shown)"
  artifacts: []
  key_links: []
---

<objective>
Integration checkpoint to verify all Phase 4 success criteria are met.

Purpose: Validate that notification history and device management features work correctly end-to-end. This is the final verification before marking Phase 4 complete.

Output:
- Verification that all 5 success criteria pass
- Documentation of any issues found
- Phase completion status
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-notification-history-a-devices/04-RESEARCH.md
@.planning/phases/04-notification-history-a-devices/04-01-SUMMARY.md
@.planning/phases/04-notification-history-a-devices/04-02-SUMMARY.md
@.planning/phases/04-notification-history-a-devices/04-03-SUMMARY.md
@.planning/phases/04-notification-history-a-devices/04-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify API endpoints work correctly</name>
  <files></files>
  <action>
Test all API endpoints created in Phase 4:

1. **History API** (`/api/notifications/history`):
   - GET returns paginated list (check response structure)
   - Cursor pagination works for next page
   - Type filter returns only matching types
   - Status filter returns only matching statuses
   - 90-day filter excludes old notifications

2. **Device Management API** (`/api/notifications/devices/[tokenKey]`):
   - PATCH updates displayName successfully
   - PATCH rejects empty or too-long names
   - DELETE removes device from database
   - Both endpoints verify ownership

Start dev server and run curl tests:
```bash
# Start server if not running
npm run dev &

# Wait for server
sleep 3

# Test history endpoint (requires authentication - manual browser test)
echo "Manual test required: Visit /settings/notifications/history in browser"

# Check API route files exist
ls -la app/api/notifications/history/route.js
ls -la app/api/notifications/devices/\[tokenKey\]/route.js
```

Note: Full API testing requires authentication, which must be done in browser.
  </action>
  <verify>
API files exist:
```bash
test -f app/api/notifications/history/route.js && \
test -f app/api/notifications/devices/\[tokenKey\]/route.js && \
echo "API files OK"
```
  </verify>
  <done>
All API endpoints exist and have correct structure for history pagination and device management.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 4 notification history and device management features:

1. **Notification History** (`/settings/notifications/history`)
   - Infinite scroll list of notifications
   - Type filter (Error, Scheduler, Maintenance, Test, System)
   - Status filter (Sent, Delivered, Failed)
   - 90-day GDPR compliant retention

2. **Device Management** (`/settings/notifications/devices`)
   - List of registered FCM devices
   - Inline device renaming
   - Device removal with confirmation
   - Status badges (Active/Stale/Unknown)

3. **Navigation links** from main notifications settings page
  </what-built>

  <how-to-verify>
**Pre-requisite:** Ensure `npm run dev` is running and you have notification history data.

**Test 1: Notification History - Infinite Scroll** (Success Criteria #1)
1. Navigate to `/settings/notifications/history`
2. Verify list shows notifications in chronological order (newest first)
3. Scroll to bottom and verify more notifications load automatically
4. Expected: 50 notifications per page, seamless infinite scroll

**Test 2: Notification History - Type Filter** (Success Criteria #2)
1. On history page, select "Errori" from Type filter dropdown
2. Verify only error-type notifications are displayed
3. Select "Scheduler" and verify only scheduler notifications shown
4. Clear filters and verify all types return
5. Expected: Filters work correctly, list resets on filter change

**Test 3: Device Management - Device List** (Success Criteria #3)
1. Navigate to `/settings/notifications/devices`
2. Verify list shows all registered devices
3. Verify each device shows: name, browser, OS, status badge, last used
4. Expected: Devices displayed with custom names if set

**Test 4: Device Management - Rename Device** (Success Criteria #3)
1. Click on a device name to edit
2. Change name to "Kitchen iPad" (or similar)
3. Press Enter or click checkmark to save
4. Refresh page and verify name persisted
5. Expected: Name updates immediately and survives refresh

**Test 5: Device Management - Remove Device** (Success Criteria #4)
1. Click "Rimuovi" on a non-current device
2. Verify confirmation dialog appears
3. Confirm removal
4. Verify device disappears from list
5. Expected: Device removed from list and no longer receives notifications

**Test 6: GDPR Compliance** (Success Criteria #5)
1. Check notification history - no notifications older than 90 days should appear
2. If you have older test data, verify it's filtered out
3. Expected: Only recent notifications shown

**Test 7: Navigation**
1. From `/settings/notifications`, click "Cronologia Notifiche" link
2. Verify it opens history page
3. Click back link to return
4. Click "Gestione Dispositivi" link
5. Verify it opens device management page
6. Expected: All navigation works correctly
  </how-to-verify>

  <resume-signal>
Type one of:
- "all tests pass" - Phase 4 complete, proceed to documentation
- "issue: [description]" - Describe any failing tests for gap analysis
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document Phase 4 completion</name>
  <files></files>
  <action>
After successful verification, update project documentation:

1. Update STATE.md:
   - Set Phase 4 status to Complete
   - Update Current Position to Phase 4 complete
   - Add any new decisions made during Phase 4
   - Update velocity metrics

2. Update ROADMAP.md:
   - Mark Phase 4 as complete with date
   - Update progress table

3. Create VERIFICATION.md documenting all test results:
```markdown
# Phase 4 Verification Results

**Date:** [current date]
**Status:** PASS / FAIL

## Success Criteria Results

| # | Criterion | Result | Notes |
|---|-----------|--------|-------|
| 1 | Infinite scroll pagination | PASS/FAIL | |
| 2 | Error type filter | PASS/FAIL | |
| 3 | Device list with names | PASS/FAIL | |
| 4 | Device removal | PASS/FAIL | |
| 5 | 90-day GDPR cleanup | PASS/FAIL | |

## Requirements Coverage

| Requirement | Status |
|-------------|--------|
| HIST-01 (Firestore storage) | Complete (Phase 2 foundation) |
| HIST-02 (In-app inbox) | Complete |
| HIST-03 (Pagination) | Complete |
| HIST-04 (Filters) | Complete |
| HIST-05 (90-day cleanup) | Complete |
| DEVICE-01 (Device naming) | Complete |
| DEVICE-02 (Status tracking) | Complete |
| DEVICE-03 (Remove device) | Complete |
| DEVICE-04 (Device list UI) | Complete |

## Phase Complete
All success criteria verified. Phase 4 ready to close.
```
  </action>
  <verify>
Documentation files updated - manual verification after checkpoint passes.
  </verify>
  <done>
Phase 4 documentation complete with verification results and requirement coverage.
  </done>
</task>

</tasks>

<verification>
Phase 4 complete when:
1. All 5 success criteria pass user verification
2. STATE.md updated with Phase 4 completion
3. ROADMAP.md progress updated
4. VERIFICATION.md documents test results
</verification>

<success_criteria>
- User can view notification history with infinite scroll
- Type and status filters work correctly
- Device list shows named devices with status
- Device removal works with confirmation
- 90-day GDPR filter active
- All navigation links functional
</success_criteria>

<output>
After completion, create `.planning/phases/04-notification-history-a-devices/04-05-SUMMARY.md`
</output>
