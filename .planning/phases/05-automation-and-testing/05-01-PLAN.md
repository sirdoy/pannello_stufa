---
phase: 05-automation-and-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.ts
  - e2e/fixtures/authenticated.ts
  - e2e/fixtures/notifications.ts
  - e2e/pages/AdminNotifications.ts
  - e2e/pages/NotificationHistory.ts
  - e2e/pages/Settings.ts
  - e2e/utils/db-helpers.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Playwright runs tests against localhost:3000"
    - "Tests can authenticate via fixture"
    - "Page Objects encapsulate selectors for admin pages"
    - "IndexedDB helpers enable token persistence testing"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with 3 browsers"
      contains: "chromium.*firefox.*webkit"
    - path: "e2e/fixtures/authenticated.ts"
      provides: "Pre-authenticated browser context"
      exports: ["test"]
    - path: "e2e/pages/AdminNotifications.ts"
      provides: "Page Object for admin test panel"
      exports: ["AdminNotifications"]
  key_links:
    - from: "playwright.config.ts"
      to: "e2e/tests/*.spec.ts"
      via: "testDir configuration"
      pattern: "testDir.*e2e/tests"
    - from: "e2e/fixtures/authenticated.ts"
      to: "@playwright/test"
      via: "base.extend"
      pattern: "base\\.extend"
---

<objective>
Set up Playwright E2E testing infrastructure with Page Object Model pattern and authentication fixtures.

Purpose: Establish the foundation for comprehensive E2E tests that will verify token persistence, service worker lifecycle, and notification delivery across Chromium, Firefox, and WebKit browsers.

Output: Complete Playwright configuration, Page Object classes for admin pages, authentication fixtures, and IndexedDB test utilities.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-automation-and-testing/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Playwright and Configure Project</name>
  <files>
    - package.json
    - playwright.config.ts
  </files>
  <action>
Install Playwright dependencies. The project already uses Jest for unit tests, so Playwright will coexist for E2E testing.

1. Add to package.json devDependencies:
   - "@playwright/test": "^1.52.0"

2. Add npm scripts to package.json:
   - "test:e2e": "playwright test"
   - "test:e2e:ui": "playwright test --ui"
   - "test:e2e:headed": "playwright test --headed"

3. Create playwright.config.ts with:
   - testDir: './e2e/tests'
   - fullyParallel: true (required for efficient sharding)
   - forbidOnly: !!process.env.CI
   - retries: process.env.CI ? 2 : 0
   - workers: process.env.CI ? 1 : undefined
   - reporter: process.env.CI ? 'blob' : 'html'
   - baseURL: 'http://localhost:3000'
   - trace: 'on-first-retry'
   - screenshot: 'only-on-failure'
   - video: 'retain-on-failure'
   - projects for chromium, firefox, webkit using devices
   - webServer command: 'npm run build && npm run start' (production mode required for Serwist)
   - webServer url: 'http://localhost:3000'
   - webServer timeout: 120000 (2 minutes for build)
   - webServer reuseExistingServer: !process.env.CI

NOTE: Do NOT run `npm install` per CLAUDE.md rules. User will do this manually.
  </action>
  <verify>
    - playwright.config.ts exists with correct structure
    - package.json has @playwright/test in devDependencies
    - npm scripts test:e2e, test:e2e:ui, test:e2e:headed exist
  </verify>
  <done>Playwright configured for 3 browsers with production webServer</done>
</task>

<task type="auto">
  <name>Task 2: Create Page Objects and Fixtures</name>
  <files>
    - e2e/fixtures/authenticated.ts
    - e2e/fixtures/notifications.ts
    - e2e/pages/AdminNotifications.ts
    - e2e/pages/NotificationHistory.ts
    - e2e/pages/Settings.ts
    - e2e/utils/db-helpers.ts
  </files>
  <action>
Create Page Object Model classes and test fixtures following Playwright best practices.

1. Create e2e/fixtures/authenticated.ts:
   - Extend base test from @playwright/test
   - Add authenticatedPage fixture that:
     - Navigates to /api/auth/login (Auth0 flow)
     - For testing, use page.route() to mock Auth0 callback with test user
     - Saves storageState for reuse
   - Export extended test object

2. Create e2e/fixtures/notifications.ts:
   - Fixture to grant notification permissions: context.grantPermissions(['notifications'])
   - Fixture to mock Push API (prevent real FCM calls in tests)
   - Use page.addInitScript to override PushManager.subscribe with mock endpoint

3. Create e2e/pages/AdminNotifications.ts (Page Object for /debug/notifications/test):
   - Locators using data-testid:
     - templateDropdown: '[data-testid="test-template"]'
     - deviceSelector: '[data-testid="device-selector"]'
     - prioritySelector: '[data-testid="priority-selector"]'
     - sendButton: '[data-testid="send-test-notification"]'
     - deliveryStatus: '[data-testid="delivery-status"]'
   - Methods:
     - selectTemplate(template: string)
     - selectDevice(deviceName: string)
     - selectPriority(priority: string)
     - sendTestNotification()
     - getDeliveryResult(): Promise<string>

4. Create e2e/pages/NotificationHistory.ts:
   - Locators for history page (/settings/notifications/history)
   - Methods for filtering, scrolling, checking notification items

5. Create e2e/pages/Settings.ts:
   - Locators for notification settings page
   - Methods for toggling preferences, DND settings

6. Create e2e/utils/db-helpers.ts:
   - clearIndexedDB(page, dbName): Clear database for test isolation
   - getTokenFromIndexedDB(page): Read FCM token from Dexie database
   - Helper to verify token persistence after context reload
  </action>
  <verify>
    - All files exist in e2e/ directory
    - TypeScript compiles without errors
    - Page Objects use data-testid selectors (stable)
  </verify>
  <done>Page Objects and fixtures ready for test authoring</done>
</task>

<task type="auto">
  <name>Task 3: Add data-testid Attributes to UI Components</name>
  <files>
    - app/debug/notifications/test/page.js
    - app/settings/notifications/history/page.js
    - app/settings/notifications/devices/page.js
  </files>
  <action>
Add data-testid attributes to UI elements for stable E2E selectors.

1. In app/debug/notifications/test/page.js, add data-testid to:
   - Template dropdown: data-testid="test-template"
   - Device selector: data-testid="device-selector"
   - Send button: data-testid="send-test-notification"
   - Result container: data-testid="delivery-status"
   - Target mode radios: data-testid="target-all", data-testid="target-specific"
   - Custom title input: data-testid="custom-title"
   - Custom body textarea: data-testid="custom-body"

2. In app/settings/notifications/history/page.js, add data-testid to:
   - Filter dropdown: data-testid="history-filter"
   - Notification list container: data-testid="notification-list"
   - Load more trigger: data-testid="load-more"
   - Individual notification items: data-testid="notification-item"

3. In app/settings/notifications/devices/page.js, add data-testid to:
   - Device list container: data-testid="device-list"
   - Device items: data-testid="device-item"
   - Remove buttons: data-testid="remove-device"
   - Rename inputs: data-testid="device-name-input"
  </action>
  <verify>
    - data-testid attributes present in all specified files
    - Selectors match Page Object locators
  </verify>
  <done>UI components have stable data-testid selectors for E2E tests</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify playwright.config.ts structure:
   ```bash
   cat playwright.config.ts | grep -E "(testDir|projects|webServer)"
   ```

2. Verify e2e directory structure:
   ```bash
   ls -la e2e/fixtures/ e2e/pages/ e2e/utils/
   ```

3. Verify data-testid attributes added:
   ```bash
   grep -r "data-testid" app/debug/notifications/test/page.js
   grep -r "data-testid" app/settings/notifications/history/page.js
   ```

4. Verify package.json scripts:
   ```bash
   cat package.json | grep "test:e2e"
   ```
</verification>

<success_criteria>
- Playwright configuration exists with 3 browser projects
- Page Objects created for admin notifications, history, settings
- Authentication fixture extends base test
- Notification permission fixture mocks Push API
- IndexedDB helpers enable token persistence testing
- UI components have data-testid attributes for stable selectors
</success_criteria>

<output>
After completion, create `.planning/phases/05-automation-and-testing/05-01-SUMMARY.md`
</output>
