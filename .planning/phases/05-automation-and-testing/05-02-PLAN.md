---
phase: 05-automation-and-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/cron/cleanup-tokens/route.ts
  - .env.example
autonomous: true
user_setup:
  - service: cron-job.org
    why: "External cron service for automated weekly cleanup"
    env_vars:
      - name: CRON_WEBHOOK_SECRET
        source: "Generate a secure random string (32+ chars): openssl rand -hex 32"
    dashboard_config:
      - task: "Create free account at cron-job.org"
        location: "https://cron-job.org/en/signup/"
      - task: "Create cron job with POST to /api/cron/cleanup-tokens"
        location: "cron-job.org Dashboard -> Create Cronjob"
      - task: "Set schedule to weekly (Sunday 3:00 AM)"
        location: "Schedule settings"
      - task: "Add header: x-cron-signature with HMAC-SHA256 of body using CRON_WEBHOOK_SECRET"
        location: "Advanced settings -> Custom headers"

must_haves:
  truths:
    - "Cron endpoint validates HMAC signature before cleanup"
    - "Invalid signatures return 401 Unauthorized"
    - "Cleanup removes tokens with lastUsed > 90 days"
    - "Cleanup response includes count of removed tokens"
  artifacts:
    - path: "app/api/cron/cleanup-tokens/route.ts"
      provides: "HMAC-secured cleanup webhook endpoint"
      exports: ["POST"]
    - path: ".env.example"
      provides: "Documentation of required env vars"
      contains: "CRON_WEBHOOK_SECRET"
  key_links:
    - from: "app/api/cron/cleanup-tokens/route.ts"
      to: "firebase-admin"
      via: "getAdminDatabase() import"
      pattern: "getAdminDatabase"
    - from: "app/api/cron/cleanup-tokens/route.ts"
      to: "crypto"
      via: "HMAC signature verification"
      pattern: "createHmac.*timingSafeEqual"
---

<objective>
Create a secure webhook endpoint for cron-job.org to trigger automated token cleanup with HMAC signature verification.

Purpose: Enable zero-touch token hygiene through weekly automated cleanup of stale tokens (>90 days), eliminating manual intervention and ensuring consistent delivery rates.

Output: HMAC-secured API endpoint at /api/cron/cleanup-tokens that can be triggered by external cron service, plus documentation for cron-job.org configuration.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-automation-and-testing/05-RESEARCH.md
@app/api/notifications/cleanup/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HMAC-Secured Cron Webhook Endpoint</name>
  <files>
    - app/api/cron/cleanup-tokens/route.ts
  </files>
  <action>
Create a new webhook endpoint specifically for cron-job.org with proper HMAC signature verification.

NOTE: The existing /api/notifications/cleanup uses Bearer token auth. This new endpoint uses HMAC for webhook security (more appropriate for external cron services).

1. Create app/api/cron/cleanup-tokens/route.ts with:
   - export const dynamic = 'force-dynamic'
   - export const maxDuration = 60 (60 seconds for cleanup operation)

2. Implement signature verification:
   ```typescript
   import { createHmac, timingSafeEqual } from 'crypto';
   ```
   - Read raw body as text (needed for HMAC calculation)
   - Get signature from header: x-cron-signature
   - Compute HMAC-SHA256 of body using CRON_WEBHOOK_SECRET
   - Use timingSafeEqual for constant-time comparison (prevents timing attacks)
   - Return 401 if signature missing or invalid

3. Implement cleanup logic (similar to existing cleanup/route.js but in TypeScript):
   - STALE_THRESHOLD_MS = 90 * 24 * 60 * 60 * 1000
   - Query all users from Firebase RTDB
   - For each fcmToken, check lastUsed or createdAt timestamp
   - If age > 90 days, mark for deletion
   - Batch update to delete all stale tokens
   - Also cleanup error logs > 30 days (reuse logic from cleanup/route.js)

4. Return JSON response:
   ```typescript
   {
     success: true,
     tokensRemoved: number,
     tokensScanned: number,
     errorsRemoved: number,
     executionMs: number,
     timestamp: string
   }
   ```

5. Add GET handler for health check (no auth required):
   ```typescript
   export async function GET() {
     return Response.json({
       endpoint: '/api/cron/cleanup-tokens',
       method: 'POST',
       auth: 'HMAC-SHA256 signature in x-cron-signature header',
       purpose: 'Weekly automated token cleanup (>90 days stale)',
       schedule: 'Sunday 3:00 AM via cron-job.org'
     });
   }
   ```
  </action>
  <verify>
    - File exists at app/api/cron/cleanup-tokens/route.ts
    - HMAC signature verification using timingSafeEqual
    - Returns 401 for missing/invalid signature
    - Cleanup logic removes tokens > 90 days old
  </verify>
  <done>HMAC-secured cron webhook endpoint ready for cron-job.org</done>
</task>

<task type="auto">
  <name>Task 2: Update Environment Configuration</name>
  <files>
    - .env.example
  </files>
  <action>
Document the new environment variable for cron webhook security.

1. Add to .env.example (create if doesn't exist):
   ```
   # Cron Webhook Security (for cron-job.org integration)
   # Generate with: openssl rand -hex 32
   CRON_WEBHOOK_SECRET=your_secure_random_string_here
   ```

2. The secret should be:
   - At least 32 characters
   - Randomly generated
   - Never committed to git
   - Same value configured in cron-job.org dashboard

3. Add comment explaining the two cleanup endpoints:
   ```
   # Token Cleanup Authentication
   # /api/notifications/cleanup uses: Bearer CRON_SECRET
   # /api/cron/cleanup-tokens uses: HMAC-SHA256 with CRON_WEBHOOK_SECRET
   ```
  </action>
  <verify>
    - .env.example contains CRON_WEBHOOK_SECRET documentation
    - Comments explain how to generate the secret
  </verify>
  <done>Environment configuration documented for cron webhook</done>
</task>

<task type="auto">
  <name>Task 3: Create Setup Documentation</name>
  <files>
    - docs/cron-cleanup-setup.md
  </files>
  <action>
Create documentation for setting up cron-job.org automation.

1. Create docs/cron-cleanup-setup.md with:

   # Automated Token Cleanup Setup

   ## Overview
   Weekly automated cleanup of stale FCM tokens (>90 days inactive) using cron-job.org external cron service.

   ## Prerequisites
   - Vercel deployment with CRON_WEBHOOK_SECRET env var configured
   - Free cron-job.org account

   ## Step 1: Generate Webhook Secret
   ```bash
   openssl rand -hex 32
   ```
   Copy the output and add to Vercel Environment Variables as CRON_WEBHOOK_SECRET.

   ## Step 2: Configure cron-job.org
   1. Create account at https://cron-job.org/en/signup/
   2. Create new cronjob:
      - Title: "Pannello Stufa Token Cleanup"
      - URL: https://your-domain.vercel.app/api/cron/cleanup-tokens
      - Schedule: Weekly, Sunday, 03:00 (any timezone)
      - Request method: POST
      - Request body: {} (empty JSON object)
      - Content-Type: application/json

   3. Add custom header for HMAC signature:
      - Header name: x-cron-signature
      - Header value: HMAC-SHA256 signature of body

   Note: cron-job.org may not support dynamic HMAC generation.
   Alternative: Use a fixed body and pre-compute the signature:
   ```bash
   echo -n '{}' | openssl dgst -sha256 -hmac "YOUR_CRON_WEBHOOK_SECRET"
   ```
   Use the resulting hex string as x-cron-signature header value.

   ## Step 3: Test the Webhook
   ```bash
   # Generate signature for empty body
   SECRET="your-secret-here"
   BODY='{}'
   SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$SECRET" | awk '{print $2}')

   curl -X POST https://your-domain.vercel.app/api/cron/cleanup-tokens \
     -H "Content-Type: application/json" \
     -H "x-cron-signature: $SIGNATURE" \
     -d "$BODY"
   ```

   ## Monitoring
   - Check cron-job.org dashboard for execution history
   - Review Vercel function logs for cleanup results
   - Enable email notifications in cron-job.org for failures
  </action>
  <verify>
    - docs/cron-cleanup-setup.md exists with complete setup instructions
    - Includes steps for generating secret, configuring cron-job.org
    - Includes test command example
  </verify>
  <done>Cron cleanup setup documentation complete</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify endpoint structure:
   ```bash
   cat app/api/cron/cleanup-tokens/route.ts | head -50
   ```

2. Verify HMAC implementation:
   ```bash
   grep -E "(createHmac|timingSafeEqual)" app/api/cron/cleanup-tokens/route.ts
   ```

3. Verify .env.example updated:
   ```bash
   grep "CRON_WEBHOOK_SECRET" .env.example
   ```

4. Verify documentation created:
   ```bash
   ls -la docs/cron-cleanup-setup.md
   ```
</verification>

<success_criteria>
- HMAC-secured webhook endpoint at /api/cron/cleanup-tokens
- Signature verification using crypto.timingSafeEqual (prevents timing attacks)
- Cleanup removes tokens > 90 days old
- Environment variable documented in .env.example
- Setup documentation includes step-by-step cron-job.org configuration
</success_criteria>

<output>
After completion, create `.planning/phases/05-automation-and-testing/05-02-SUMMARY.md`
</output>
