---
phase: 05-automation-and-testing
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/debug/notifications/test/page.js
  - app/api/notifications/test/route.js
autonomous: true

must_haves:
  truths:
    - "Admin can select notification priority level"
    - "Admin can send bulk test to all devices"
    - "Test notifications appear in notification history"
    - "Templates dropdown shows predefined options"
  artifacts:
    - path: "app/debug/notifications/test/page.js"
      provides: "Enhanced admin test panel UI"
      contains: "data-testid.*priority"
    - path: "app/api/notifications/test/route.js"
      provides: "Test API with priority support"
      contains: "priority"
  key_links:
    - from: "app/debug/notifications/test/page.js"
      to: "/api/notifications/test"
      via: "fetch POST"
      pattern: "fetch.*notifications/test"
    - from: "app/api/notifications/test/route.js"
      to: "sendNotificationToUser"
      via: "import from firebaseAdmin"
      pattern: "sendNotificationToUser"
---

<objective>
Enhance admin testing panel with priority selector, bulk device testing, and ensure test notifications appear in notification history.

Purpose: Provide comprehensive notification testing capabilities for admins (Success Criteria #3: Admin panel shows predefined templates), with additional features for priority testing and DND verification as specified in CONTEXT.md.

Output: Enhanced test notification page with priority selection, bulk testing support, and improved delivery feedback.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-automation-and-testing/05-CONTEXT.md
@app/debug/notifications/test/page.js
@app/api/notifications/test/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Priority Selector to Test API</name>
  <files>
    - app/api/notifications/test/route.js
  </files>
  <action>
Enhance the test notification API to support priority level selection.

1. Update TEMPLATES object to include all priority levels:
   ```javascript
   const TEMPLATES = {
     error_alert: {
       title: '... Errore Stufa',
       body: '...',
       priority: 'high',
       type: 'ERROR'
     },
     scheduler_success: {
       title: '... Accensione Completata',
       body: '...',
       priority: 'normal',
       type: 'scheduler_success'
     },
     maintenance_reminder: {
       title: '... Promemoria Manutenzione',
       body: '...',
       priority: 'normal',
       type: 'maintenance'
     },
     critical_test: {
       title: '... Test CRITICAL',
       body: 'Notifica CRITICAL di test - bypassa DND e ha rate limit 5/min',
       priority: 'high',
       type: 'CRITICAL'
     },
     low_priority_test: {
       title: '... Test LOW Priority',
       body: 'Notifica LOW priority di test - subject to all rate limits',
       priority: 'low',
       type: 'status'
     }
   };
   ```

2. Accept `priority` in request body that overrides template priority:
   ```javascript
   const { deviceToken, template, customTitle, customBody, broadcast, priority } = body;

   // Build notification
   const notification = {
     title: customTitle || notificationConfig.title,
     body: customBody || notificationConfig.body,
     icon: '/icons/icon-192.png',
     // Priority from request overrides template
     priority: priority || notificationConfig.priority,
     data: {
       type: notificationConfig.type,
       priority: priority || notificationConfig.priority, // Include in data for filtering
       url: '/settings/notifications',
       timestamp: sentAt,
       isTest: true // Mark as test notification for history filtering
     },
   };
   ```

3. Add `isTest: true` to notification data so test notifications can be filtered in history UI if needed.
  </action>
  <verify>
    - API accepts priority parameter
    - isTest: true added to notification data
    - Templates include critical_test and low_priority_test
  </verify>
  <done>Test API supports priority selection and marks test notifications</done>
</task>

<task type="auto">
  <name>Task 2: Enhance Test Page UI with Priority Selector</name>
  <files>
    - app/debug/notifications/test/page.js
  </files>
  <action>
Add priority selector and improve the test page UI with data-testid attributes.

1. Add priority state and selector:
   ```javascript
   const [priority, setPriority] = useState('normal');

   const priorities = [
     { value: 'high', label: 'HIGH - Urgent alerts', description: 'Bypasses some rate limits' },
     { value: 'normal', label: 'NORMAL - Standard', description: 'Default priority' },
     { value: 'low', label: 'LOW - Informational', description: 'Can be delayed' }
   ];
   ```

2. Add critical_test and low_priority_test to templates object:
   ```javascript
   const templates = {
     custom: { ... },
     error_alert: { ... },
     scheduler_success: { ... },
     maintenance_reminder: { ... },
     critical_test: {
       title: 'Test CRITICAL',
       body: 'Notifica CRITICAL di test - bypassa DND',
       description: 'CRITICAL priority (bypasses DND hours)',
       defaultPriority: 'high'
     },
     low_priority_test: {
       title: 'Test LOW Priority',
       body: 'Notifica LOW priority di test',
       description: 'LOW priority notification',
       defaultPriority: 'low'
     }
   };
   ```

3. Add Priority Selector section after Message Content card:
   ```jsx
   <Card className="p-6">
     <Heading level={2} size="lg" className="mb-4">Priority Level</Heading>
     <div className="space-y-3">
       {priorities.map(p => (
         <label key={p.value} className="flex items-start gap-3 cursor-pointer">
           <input
             type="radio"
             name="priority"
             value={p.value}
             checked={priority === p.value}
             onChange={(e) => setPriority(e.target.value)}
             className="..."
             data-testid={`priority-${p.value}`}
           />
           <div>
             <Text weight="medium">{p.label}</Text>
             <Text variant="tertiary" size="xs">{p.description}</Text>
           </div>
         </label>
       ))}
     </div>
   </Card>
   ```

4. Add data-testid attributes to ALL interactive elements:
   - Template select: data-testid="test-template"
   - Device selector: data-testid="device-selector"
   - Target mode radios: data-testid="target-all", data-testid="target-specific"
   - Priority radios: data-testid="priority-high", data-testid="priority-normal", data-testid="priority-low"
   - Send button: data-testid="send-test-notification"
   - Result container: data-testid="delivery-status"
   - Custom title: data-testid="custom-title"
   - Custom body: data-testid="custom-body"

5. Update handleSend to include priority:
   ```javascript
   const handleSend = async () => {
     // ... existing code ...

     const bodyPayload = {
       // ... existing fields ...
       priority: priority // Add priority to request
     };

     // ... rest of function ...
   };
   ```

6. Auto-set priority when template changes:
   ```javascript
   const handleTemplateChange = (newTemplate) => {
     setTemplate(newTemplate);
     if (templates[newTemplate]?.defaultPriority) {
       setPriority(templates[newTemplate].defaultPriority);
     }
   };
   ```
  </action>
  <verify>
    - Priority selector UI with 3 options (high, normal, low)
    - data-testid attributes on all interactive elements
    - Template change auto-sets appropriate priority
    - handleSend includes priority in request body
  </verify>
  <done>Test page has priority selector and data-testid attributes for E2E tests</done>
</task>

<task type="auto">
  <name>Task 3: Add Bulk Testing Info and Test History Note</name>
  <files>
    - app/debug/notifications/test/page.js
  </files>
  <action>
Add informational section about test notifications appearing in history.

1. Add info card below the result section:
   ```jsx
   {/* Test History Info */}
   <Card className="p-6 bg-slate-800/30 border border-white/5">
     <div className="flex items-start gap-3">
       <span className="text-xl">...</span>
       <div>
         <Heading level={3} size="md" className="mb-2">
           About Test Notifications
         </Heading>
         <div className="space-y-2">
           <Text size="sm" variant="secondary">
             Test notifications are logged like production notifications and appear in
             <a href="/settings/notifications/history" className="text-ember-400 hover:underline ml-1">
               Notification History
             </a>.
           </Text>
           <Text size="sm" variant="secondary">
             Use CRITICAL priority to test DND bypass - CRITICAL notifications ignore quiet hours.
           </Text>
           <Text size="sm" variant="secondary">
             Bulk testing (All Devices) sends to every registered device for the current user.
           </Text>
         </div>
       </div>
     </div>
   </Card>
   ```

2. Add visual indicator in result trace when notification is logged to history:
   ```jsx
   {result.success && result.trace && (
     <div className="mt-3 pt-3 border-t border-white/10">
       <Text variant="tertiary" size="xs" className="flex items-center gap-2">
         <span>...</span>
         Logged to notification history
       </Text>
     </div>
   )}
   ```

3. Ensure result trace shows device count for bulk sends:
   - Already in code: targetDevices field
   - Add clarifying label: "{X} device(s) targeted"
  </action>
  <verify>
    - Info card explains test notifications appear in history
    - Info card mentions CRITICAL bypasses DND
    - Result shows "Logged to notification history" indicator
  </verify>
  <done>Test page documents history logging and CRITICAL behavior</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify API changes:
   ```bash
   grep "priority" app/api/notifications/test/route.js
   grep "isTest" app/api/notifications/test/route.js
   ```

2. Verify UI data-testid attributes:
   ```bash
   grep -c "data-testid" app/debug/notifications/test/page.js
   ```

3. Verify priority selector in UI:
   ```bash
   grep -E "priority-(high|normal|low)" app/debug/notifications/test/page.js
   ```

4. Manual verification:
   - Visit /debug/notifications/test
   - Verify template dropdown shows 5+ templates
   - Verify priority radio buttons appear
   - Select CRITICAL template, verify priority auto-sets to high
</verification>

<success_criteria>
- Priority selector with HIGH/NORMAL/LOW options
- Template dropdown includes critical_test and low_priority_test
- Template selection auto-sets appropriate priority
- All interactive elements have data-testid for E2E tests
- Test notifications marked with isTest: true in data
- Info section explains history logging and CRITICAL behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05-automation-and-testing/05-04-SUMMARY.md`
</output>
