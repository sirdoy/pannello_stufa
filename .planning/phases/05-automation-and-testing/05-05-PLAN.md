---
phase: 05-automation-and-testing
plan: 05
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - .github/workflows/e2e-tests.yml
autonomous: false

must_haves:
  truths:
    - "E2E tests run on every pull request"
    - "Tests run in parallel across 3 browsers"
    - "Failed tests block PR merge"
    - "Test results posted as PR comment"
  artifacts:
    - path: ".github/workflows/e2e-tests.yml"
      provides: "GitHub Actions workflow for E2E tests"
      contains: "playwright"
  key_links:
    - from: ".github/workflows/e2e-tests.yml"
      to: "playwright.config.ts"
      via: "npx playwright test command"
      pattern: "npx playwright test"
---

<objective>
Create GitHub Actions workflow for running E2E tests on every PR with merge blocking and PR comments.

Purpose: Ensure CI/CD pipeline runs E2E tests on every PR and blocks merge if service worker lifecycle tests fail (Success Criteria #4), providing automated quality gates for the notification system.

Output: GitHub Actions workflow that runs Playwright tests in parallel across browsers with PR comment reporting.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-automation-and-testing/05-RESEARCH.md
@.planning/phases/05-automation-and-testing/05-03-SUMMARY.md
@.github/workflows/sync-changelog.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions E2E Workflow</name>
  <files>
    - .github/workflows/e2e-tests.yml
  </files>
  <action>
Create GitHub Actions workflow for Playwright E2E tests with sharded parallel execution.

Per CONTEXT.md decisions:
- Test execution trigger: On every PR
- Failure behavior: Block merge (strict quality gate)
- Execution time budget: 5 minutes max (requires parallelization)
- Test result reporting: GitHub PR comment

1. Create .github/workflows/e2e-tests.yml:

```yaml
name: E2E Tests

on:
  pull_request:
    branches: [main]
  # Allow manual trigger for debugging
  workflow_dispatch:

# Cancel in-progress runs for same PR
concurrency:
  group: e2e-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    name: E2E / ${{ matrix.browser }} / shard ${{ matrix.shard }}
    timeout-minutes: 10
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1, 2]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browser
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run Playwright tests
        run: npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shard }}/2
        env:
          CI: true
          # Add any required env vars for tests
          # NEXT_PUBLIC_* vars can be added here

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.browser }}-${{ matrix.shard }}
          path: blob-report/
          retention-days: 1

  merge-reports:
    name: Merge Reports
    if: always()
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge reports
        run: npx playwright merge-reports --reporter html ./all-blob-reports

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Post results to PR
        if: github.event_name == 'pull_request'
        uses: daun/playwright-report-summary@v3
        with:
          report-file: playwright-report/index.html
          comment-title: 'E2E Test Results'
          job-summary: true

  # Status check job that can be required for merge
  e2e-status:
    name: E2E Status
    if: always()
    needs: [test, merge-reports]
    runs-on: ubuntu-latest
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "E2E tests failed or were cancelled"
            exit 1
          fi
          echo "All E2E tests passed!"
```

2. Key configuration notes:
   - 2 shards per browser = 6 parallel jobs (3 browsers x 2 shards)
   - 10 minute timeout provides buffer over 5 minute target
   - fail-fast: false ensures all browsers complete
   - e2e-status job provides single status check for branch protection
   - daun/playwright-report-summary posts results to PR

3. The workflow requires branch protection rules to enforce:
   - Go to Settings > Branches > Branch protection rules
   - Add rule for "main" branch
   - Enable "Require status checks to pass"
   - Add "E2E Status" as required check
  </action>
  <verify>
    - .github/workflows/e2e-tests.yml exists
    - Matrix includes 3 browsers and 2 shards
    - PR comment action configured (daun/playwright-report-summary)
    - e2e-status job aggregates results for branch protection
  </verify>
  <done>GitHub Actions workflow for parallel E2E tests with PR commenting</done>
</task>

<task type="auto">
  <name>Task 2: Update package.json CI Scripts</name>
  <files>
    - package.json
  </files>
  <action>
Add CI-specific npm scripts for the workflow.

1. Add to package.json scripts:
   ```json
   {
     "scripts": {
       "test:e2e": "playwright test",
       "test:e2e:ui": "playwright test --ui",
       "test:e2e:headed": "playwright test --headed",
       "test:e2e:ci": "playwright test --reporter=blob"
     }
   }
   ```

NOTE: If test:e2e scripts already exist from 05-01, just verify they're correct. Do not duplicate.

2. The CI script uses blob reporter which is required for:
   - Sharded execution across multiple jobs
   - Report merging in merge-reports job
   - HTML report generation from merged blobs
  </action>
  <verify>
    - package.json has test:e2e:ci script with blob reporter
    - Scripts don't duplicate existing entries
  </verify>
  <done>CI scripts configured for blob reporting</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 5: Automation & Testing

1. Playwright E2E infrastructure (05-01)
2. HMAC-secured cron webhook (05-02)
3. E2E tests for token persistence, SW lifecycle (05-03)
4. Admin testing enhancements with priority (05-04)
5. GitHub Actions CI/CD workflow (this plan)
  </what-built>
  <how-to-verify>
**Pre-requisites:**
1. Run `npm install` to install @playwright/test
2. Run `npx playwright install` to install browsers
3. Generate CRON_WEBHOOK_SECRET and add to .env

**Manual Verification:**

1. **Playwright Setup:**
   ```bash
   npx playwright test --project=chromium --headed --grep "token persistence"
   ```
   Expected: Browser opens, test runs (may fail if FCM not configured)

2. **Cron Webhook (local test):**
   ```bash
   # Generate test signature
   SECRET="your-test-secret"
   BODY='{}'
   SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$SECRET" | awk '{print $2}')

   # Test endpoint
   curl -X POST http://localhost:3000/api/cron/cleanup-tokens \
     -H "Content-Type: application/json" \
     -H "x-cron-signature: $SIG" \
     -d "$BODY"
   ```
   Expected: Returns { success: true, ... } or auth error if secret mismatch

3. **Admin Test Panel:**
   - Visit /debug/notifications/test
   - Verify 5+ templates in dropdown
   - Verify priority selector (HIGH/NORMAL/LOW)
   - Select "Test CRITICAL" template
   - Verify priority auto-sets to HIGH
   - Send test notification
   - Check notification appears in /settings/notifications/history

4. **GitHub Actions:**
   - Open a test PR to trigger workflow
   - Verify jobs run in parallel (6 jobs: 3 browsers x 2 shards)
   - Verify PR comment with test results appears

**Success Criteria from ROADMAP.md:**
1. [ ] Weekly cron job runs automatically (cron-job.org not yet configured - user setup)
2. [ ] Playwright E2E test simulates browser restart, verifies token persists
3. [ ] Admin panel "Quick Test" dropdown shows predefined templates
4. [ ] CI/CD pipeline runs E2E tests on every PR, blocks merge on failures
5. [ ] System requires zero manual token cleanup for 30+ days (validated after 30 days)
  </how-to-verify>
  <resume-signal>Type "verified" when all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify workflow file:
   ```bash
   cat .github/workflows/e2e-tests.yml | head -50
   ```

2. Verify matrix configuration:
   ```bash
   grep -A 5 "matrix:" .github/workflows/e2e-tests.yml
   ```

3. Verify PR comment action:
   ```bash
   grep "playwright-report-summary" .github/workflows/e2e-tests.yml
   ```

4. Verify package.json scripts:
   ```bash
   grep "test:e2e" package.json
   ```
</verification>

<success_criteria>
- GitHub Actions workflow runs on every PR
- Tests execute in parallel (3 browsers x 2 shards = 6 jobs)
- PR receives comment with test results summary
- e2e-status job provides single check for branch protection
- Workflow completes within 10 minute timeout
</success_criteria>

<output>
After completion, create `.planning/phases/05-automation-and-testing/05-05-SUMMARY.md`
</output>
