---
phase: 08-stove-thermostat-integration-correction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/coordinationState.js
  - lib/coordinationPreferences.js
  - lib/schemas/coordinationPreferences.js
  - __tests__/lib/coordinationState.test.js
  - __tests__/lib/coordinationPreferences.test.js
autonomous: true

must_haves:
  truths:
    - "System tracks coordination state (stoveOn, automationPaused, pendingDebounce)"
    - "User can configure coordination preferences (enabled, defaultBoost, zones)"
    - "State persists in Firebase RTDB and survives server restarts"
    - "Preferences validate against Zod schema with sensible defaults"
  artifacts:
    - path: "lib/coordinationState.js"
      provides: "Coordination state management (get, update, reset)"
      exports: ["getCoordinationState", "updateCoordinationState", "resetCoordinationState"]
    - path: "lib/coordinationPreferences.js"
      provides: "User preferences for coordination (get, update)"
      exports: ["getCoordinationPreferences", "updateCoordinationPreferences", "getDefaultCoordinationPreferences"]
    - path: "lib/schemas/coordinationPreferences.js"
      provides: "Zod schema for coordination preferences validation"
      exports: ["coordinationPreferencesSchema", "zoneConfigSchema"]
  key_links:
    - from: "lib/coordinationState.js"
      to: "lib/firebaseAdmin.js"
      via: "adminDbGet/adminDbSet for RTDB persistence"
      pattern: "adminDb(Get|Set)"
    - from: "lib/coordinationPreferences.js"
      to: "lib/schemas/coordinationPreferences.js"
      via: "Zod validation before storage"
      pattern: "coordinationPreferencesSchema\\.parse"
---

<objective>
Create the foundational state management and user preferences infrastructure for stove-thermostat coordination.

Purpose: Provide centralized, persistent storage for coordination state (tracking stove status, automation pauses, debounce timers) and user-configurable preferences (zones, boost amounts). This enables all other coordination features to share consistent state.

Output: Two service modules (coordinationState.js, coordinationPreferences.js) with Zod schema validation, Firebase RTDB persistence, and comprehensive tests.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stove-thermostat-integration-correction/08-CONTEXT.md
@.planning/phases/08-stove-thermostat-integration-correction/08-RESEARCH.md
@lib/firebaseAdmin.js
@lib/schemas/notificationPreferences.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Coordination State Service</name>
  <files>lib/coordinationState.js, __tests__/lib/coordinationState.test.js</files>
  <action>
Create `lib/coordinationState.js` following the existing Firebase RTDB pattern from `netatmoStoveSync.js`.

State schema stored at `coordination/state` in Firebase RTDB:
```javascript
{
  stoveOn: boolean,              // Current stove state (from last check)
  automationPaused: boolean,     // Whether automation is paused (user intent)
  pausedUntil: number|null,      // Timestamp when pause expires (next schedule slot)
  pauseReason: string|null,      // Why automation was paused ('manual_setpoint_change', 'manual_mode_change')
  lastStateChange: number,       // Timestamp of last state change
  pendingDebounce: boolean,      // Whether a debounce timer is active
  debounceStartedAt: number|null, // When debounce timer started (for resumability)
  previousSetpoints: object|null, // { roomId: setpoint } for restoration
}
```

Implement functions:
- `getCoordinationState()` - Returns current state from RTDB, or default state if not found
- `updateCoordinationState(updates)` - Merges updates into state, sets lastStateChange to Date.now()
- `resetCoordinationState()` - Resets to default state (useful for testing and manual reset)

Follow patterns from `netatmoStoveSync.js`:
- Use `adminDbGet`, `adminDbSet` from `firebaseAdmin.js`
- Use `getEnvironmentPath` from `environmentHelper.js` for environment-aware paths

Create comprehensive tests:
- getCoordinationState returns default state when nothing stored
- getCoordinationState returns stored state
- updateCoordinationState merges updates correctly
- updateCoordinationState sets lastStateChange automatically
- resetCoordinationState clears all state to defaults
- State shape matches schema
  </action>
  <verify>Run `npm test -- __tests__/lib/coordinationState.test.js` - all tests pass</verify>
  <done>Coordination state service reads/writes to Firebase RTDB with proper defaults and update logic</done>
</task>

<task type="auto">
  <name>Task 2: Create Coordination Preferences Schema</name>
  <files>lib/schemas/coordinationPreferences.js</files>
  <action>
Create Zod schema for coordination preferences following the pattern in `lib/schemas/notificationPreferences.js`.

Schema structure:
```javascript
{
  enabled: boolean,           // Whether coordination is enabled (default: true)
  defaultBoost: number,       // Default temperature boost in °C (default: 2, min: 0.5, max: 5)
  zones: [                    // Array of zone configurations
    {
      roomId: string,         // Netatmo room ID
      roomName: string,       // Display name
      enabled: boolean,       // Whether this zone participates (default: true)
      boost: number|null,     // Zone-specific boost override (null = use defaultBoost)
    }
  ],
  notificationPreferences: {
    coordinationApplied: boolean,  // Notify when setpoint override applied (default: true)
    coordinationRestored: boolean, // Notify when setpoints restored (default: false)
    automationPaused: boolean,     // Notify when automation paused (default: true)
    maxSetpointReached: boolean,   // Notify when 30°C cap applied (default: true)
  },
  version: number,            // For conflict detection
  updatedAt: string,          // ISO timestamp
}
```

Export:
- `coordinationPreferencesSchema` - Full schema
- `zoneConfigSchema` - Zone sub-schema for reuse
- `getDefaultCoordinationPreferences()` - Returns validated defaults
  </action>
  <verify>Schema can be imported and validates sample data correctly</verify>
  <done>Zod schema provides type-safe validation for coordination preferences with sensible defaults</done>
</task>

<task type="auto">
  <name>Task 3: Create Coordination Preferences Service</name>
  <files>lib/coordinationPreferences.js, __tests__/lib/coordinationPreferences.test.js</files>
  <action>
Create `lib/coordinationPreferences.js` for reading/writing user coordination preferences.

Store preferences at `coordination/preferences/{userId}` in Firebase RTDB (consistent with other user preferences patterns).

Implement functions:
- `getCoordinationPreferences(userId)` - Returns user preferences, or defaults if not found
- `updateCoordinationPreferences(userId, updates)` - Validates with Zod, merges, increments version, sets updatedAt
- `getDefaultCoordinationPreferences()` - Re-export from schema for convenience

Key behaviors:
- Always validate with Zod before writing
- Merge updates (partial update support)
- Increment version on every update
- Set updatedAt to current ISO timestamp
- Return sensible defaults for new users

Create comprehensive tests:
- getCoordinationPreferences returns defaults for new user
- getCoordinationPreferences returns stored preferences
- updateCoordinationPreferences validates input with Zod
- updateCoordinationPreferences rejects invalid data
- updateCoordinationPreferences increments version
- updateCoordinationPreferences sets updatedAt
- Zone configuration validates correctly
- Boost amount constraints enforced (0.5-5°C)
  </action>
  <verify>Run `npm test -- __tests__/lib/coordinationPreferences.test.js` - all tests pass</verify>
  <done>Coordination preferences service provides validated, versioned preference storage per user</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm test -- coordinationState coordinationPreferences` - All tests pass
2. State service uses correct RTDB paths with environment awareness
3. Preferences validate against Zod schema before storage
4. Default state and preferences match documented schema
</verification>

<success_criteria>
- Two new services created: coordinationState.js, coordinationPreferences.js
- One Zod schema: schemas/coordinationPreferences.js
- All tests pass (expect ~15-20 new tests)
- Services follow existing Firebase patterns (adminDbGet/Set, getEnvironmentPath)
- Preferences include zone configuration and notification toggles
</success_criteria>

<output>
After completion, create `.planning/phases/08-stove-thermostat-integration-correction/08-01-SUMMARY.md`
</output>
