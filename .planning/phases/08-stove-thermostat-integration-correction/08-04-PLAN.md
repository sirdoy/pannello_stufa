---
phase: 08-stove-thermostat-integration-correction
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - lib/netatmoStoveSync.js
  - __tests__/lib/netatmoStoveSync.test.js
autonomous: true

must_haves:
  truths:
    - "setRoomsToBoostMode applies configurable boost (+N°C) to rooms"
    - "Max setpoint capped at 30°C when boost would exceed"
    - "restoreRoomSetpoints restores previous setpoints (not schedule)"
    - "Multi-room zones apply individual boost amounts"
    - "Existing setRoomsToStoveMode remains for backward compatibility"
  artifacts:
    - path: "lib/netatmoStoveSync.js"
      provides: "Enhanced stove sync with boost mode and restoration"
      exports: ["(existing exports)", "setRoomsToBoostMode", "restoreRoomSetpoints"]
  key_links:
    - from: "lib/netatmoStoveSync.js"
      to: "lib/netatmoApi.js"
      via: "setRoomThermpoint for setpoint changes"
      pattern: "NETATMO_API\\.setRoomThermpoint"
    - from: "lib/netatmoStoveSync.js"
      to: "lib/coordinationPreferences.js"
      via: "Get zone-specific boost amounts"
      pattern: "getCoordinationPreferences"
---

<objective>
Enhance netatmoStoveSync.js with boost mode and setpoint restoration functionality.

Purpose: Add two new functions that support configurable temperature boost (instead of fixed low temperature) and proper setpoint restoration that preserves user's previous values. This prepares the sync module for orchestrator integration.

Output: Enhanced netatmoStoveSync.js with setRoomsToBoostMode and restoreRoomSetpoints functions, plus comprehensive tests for the new functionality.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-stove-thermostat-integration-correction/08-CONTEXT.md
@.planning/phases/08-stove-thermostat-integration-correction/08-RESEARCH.md
@.planning/phases/08-stove-thermostat-integration-correction/08-01-SUMMARY.md
@.planning/phases/08-stove-thermostat-integration-correction/08-02-SUMMARY.md
@.planning/phases/08-stove-thermostat-integration-correction/08-03-SUMMARY.md
@lib/netatmoStoveSync.js
@lib/netatmoApi.js
@lib/coordinationPreferences.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add setRoomsToBoostMode Function</name>
  <files>lib/netatmoStoveSync.js, __tests__/lib/netatmoStoveSync.test.js</files>
  <action>
Add new `setRoomsToBoostMode` function to `lib/netatmoStoveSync.js`.

Current behavior in setRoomsToStoveMode: Sets rooms to fixed low temperature (16°C) when stove is ON.
New behavior in setRoomsToBoostMode: Applies configurable boost (+N°C) when stove is ON.

**setRoomsToBoostMode(config, boostAmount, previousSetpoints = {})**

Parameters:
- config: { homeId, rooms: [{ id, name }], accessToken } - same structure as existing functions
- boostAmount: number - temperature increase in °C (default from preferences, typically +2°C)
- previousSetpoints: object - { roomId: setpoint } to track pre-override values for restoration

Implementation:
1. For each room in config.rooms:
   - Get current setpoint via getHomeStatus
   - Store current setpoint in previousSetpoints[roomId] if not already stored
   - Calculate new setpoint: currentSetpoint + boostAmount
   - Cap at 30°C maximum (per CONTEXT.md)
   - Apply via setRoomThermpoint with mode: 'manual', endtime: 8 hours
2. Return result object:
```javascript
{
  success: boolean,
  appliedSetpoints: {
    [roomId]: {
      roomName: string,
      previous: number,    // Setpoint before boost
      applied: number,     // Setpoint after boost
      capped: boolean,     // True if 30°C limit reached
    }
  },
  previousSetpoints: {...}, // Updated map for state storage
  cappedRooms: [...],       // Room names that hit 30°C cap
}
```

Add tests for setRoomsToBoostMode:
- Applies boost correctly (20°C + 2°C = 22°C)
- Caps at 30°C when boost would exceed (29°C + 2°C = 30°C not 31°C)
- Stores previous setpoints correctly
- Does not overwrite existing previousSetpoints entry
- Handles multiple rooms correctly
- Returns capped flag for rooms hitting limit
- Returns cappedRooms array with room names
- Handles API errors gracefully (per-room failure doesn't block others)
  </action>
  <verify>Run `npm test -- __tests__/lib/netatmoStoveSync.test.js` - all tests pass including new setRoomsToBoostMode tests</verify>
  <done>setRoomsToBoostMode applies configurable boost with 30°C cap and tracks previous setpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add restoreRoomSetpoints Function</name>
  <files>lib/netatmoStoveSync.js, __tests__/lib/netatmoStoveSync.test.js</files>
  <action>
Add new `restoreRoomSetpoints` function to `lib/netatmoStoveSync.js`.

**restoreRoomSetpoints(config, previousSetpoints)**

Parameters:
- config: { homeId, rooms: [{ id, name }], accessToken }
- previousSetpoints: object - { roomId: setpoint } from setRoomsToBoostMode

Implementation:
1. For each room in config.rooms:
   - If previousSetpoints[roomId] exists:
     - Restore to that value via setRoomThermpoint (mode: 'manual', temp: previousSetpoints[roomId], endtime: 8h)
   - If previousSetpoints[roomId] is undefined/null:
     - Return to schedule via setRoomThermpoint (mode: 'home')
2. Return result object:
```javascript
{
  success: boolean,
  restoredRooms: [
    {
      roomId: string,
      roomName: string,
      restoredTo: number | 'schedule', // Actual temp or 'schedule' if returned to home mode
      hadPrevious: boolean,            // True if had stored previous setpoint
    }
  ],
}
```

This preserves user's manual adjustments instead of always returning to schedule.

Add tests for restoreRoomSetpoints:
- Restores to previous setpoint when available
- Returns to schedule ('home' mode) when no previous setpoint
- Handles mixed scenarios (some rooms have previous, some don't)
- Handles multiple rooms correctly
- Handles API errors gracefully (per-room failure doesn't block others)
- Uses Promise.allSettled pattern for graceful degradation
  </action>
  <verify>Run `npm test -- __tests__/lib/netatmoStoveSync.test.js` - all tests pass including new restoreRoomSetpoints tests</verify>
  <done>restoreRoomSetpoints restores previous setpoints or returns to schedule, preserving user's manual adjustments</done>
</task>

<task type="auto">
  <name>Task 3: Add Multi-Zone Coordination Edge Case Tests (INTEG-03)</name>
  <files>__tests__/lib/netatmoStoveSync.test.js</files>
  <action>
Add explicit test coverage for multi-zone coordination edge cases to satisfy requirement INTEG-03.

INTEG-03: "System coordinates multi-room thermostat zones when stove is active"

Add test suite "Multi-Zone Coordination Edge Cases":
- "applies boost to multiple zones independently"
  - 3 rooms with different current setpoints (19°C, 20°C, 21°C)
  - Apply +2°C boost
  - Verify each gets individual boost (21°C, 22°C, 23°C)

- "handles partial zone failure gracefully"
  - 3 rooms, middle room API call fails
  - Verify first and third room still succeed
  - Verify failure is logged but doesn't block other rooms

- "respects per-zone boost configuration"
  - Room A: boost +2°C
  - Room B: boost +3°C
  - Room C: boost +1.5°C
  - Verify each applies correct zone-specific boost

- "restores multiple zones correctly"
  - 3 rooms with different previous setpoints
  - One room has no previous (returns to schedule)
  - Verify each restores to correct value

- "handles all zones at 30°C cap"
  - 3 rooms all at 29°C
  - Apply +2°C boost
  - Verify all cap at 30°C
  - Verify cappedRooms contains all 3 room names
  </action>
  <verify>Run `npm test -- __tests__/lib/netatmoStoveSync.test.js` - all tests pass including multi-zone edge cases</verify>
  <done>Multi-zone coordination explicitly verified with edge case tests for INTEG-03 requirement</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm test -- __tests__/lib/netatmoStoveSync.test.js` - All tests pass
2. setRoomsToBoostMode applies boost with 30°C cap
3. restoreRoomSetpoints preserves previous values
4. Multi-zone edge cases pass (partial failure, per-zone boost, all-capped scenario)
5. Existing setRoomsToStoveMode still works (backward compatibility)
</verification>

<success_criteria>
- Two new functions added to netatmoStoveSync.js
- Existing functionality preserved for backward compatibility
- Comprehensive tests for new functions (~10-12 new tests)
- Multi-zone coordination edge cases explicitly tested (INTEG-03)
- Ready for orchestrator integration in Plan 08-04b
</success_criteria>

<output>
After completion, create `.planning/phases/08-stove-thermostat-integration-correction/08-04-SUMMARY.md`
</output>
