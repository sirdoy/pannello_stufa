---
phase: 09-schedule-management-ui
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - app/schedule/components/ScheduleSelector.js
  - app/schedule/page.js
  - app/components/ui/Skeleton.js
autonomous: true

must_haves:
  truths:
    - "User can navigate to /schedule page from thermostat"
    - "User can see which schedule is currently active"
    - "User can switch between available schedules via dropdown"
  artifacts:
    - path: "app/schedule/page.js"
      provides: "Schedule management page"
      exports: ["default"]
    - path: "app/schedule/components/ScheduleSelector.js"
      provides: "Dropdown for switching schedules"
      exports: ["default"]
  key_links:
    - from: "app/schedule/components/ScheduleSelector.js"
      to: "/api/netatmo/schedules"
      via: "POST fetch for schedule switch"
      pattern: "fetch.*schedules.*POST"
---

<objective>
Create the schedule management page with schedule selector dropdown.

Purpose: Provide the main page for viewing and managing thermostat schedules. Users can select from pre-configured schedules to change their heating program.

Output: Schedule page at /schedule with ScheduleSelector component for switching between schedules.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-schedule-management-ui/09-CONTEXT.md
@.planning/phases/09-schedule-management-ui/09-RESEARCH.md

# Dependencies
@lib/hooks/useScheduleData.js
@lib/routes.js

# Dependency from Plan 02
@app/schedule/components/WeeklyTimeline.js

# UI patterns from existing pages
@app/thermostat/page.js
@app/components/ui/Select.js
@app/components/ui/Card.js
@app/components/ui/Skeleton.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScheduleSelector component</name>
  <files>app/schedule/components/ScheduleSelector.js</files>
  <action>
Create the schedule switching dropdown:

```javascript
'use client';
import { useState } from 'react';
import { Select, Button, Text } from '@/app/components/ui';
import { NETATMO_ROUTES } from '@/lib/routes';
import { Check, RefreshCw } from 'lucide-react';

/**
 * ScheduleSelector - Dropdown for switching between schedules
 *
 * @param {Array} schedules - List of available schedules
 * @param {Object} activeSchedule - Currently active schedule
 * @param {Function} onScheduleChanged - Callback after successful switch
 */
export default function ScheduleSelector({
  schedules = [],
  activeSchedule,
  onScheduleChanged,
}) {
  const [switching, setSwitching] = useState(false);
  const [error, setError] = useState(null);
  const [selectedId, setSelectedId] = useState(activeSchedule?.id || '');

  const handleSwitch = async () => {
    if (!selectedId || selectedId === activeSchedule?.id) return;

    try {
      setSwitching(true);
      setError(null);

      const res = await fetch(NETATMO_ROUTES.schedules, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scheduleId: selectedId }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.message || 'Impossibile cambiare programmazione');
      }

      // Success - notify parent to refetch
      onScheduleChanged?.();
    } catch (err) {
      setError(err.message);
    } finally {
      setSwitching(false);
    }
  };

  // Build options array
  const options = schedules.map(s => ({
    value: s.id,
    label: s.name,
  }));

  const hasChanged = selectedId && selectedId !== activeSchedule?.id;

  return (
    <div className="space-y-3">
      <div className="flex items-end gap-3">
        {/* Schedule dropdown */}
        <div className="flex-1">
          <label className="block mb-1.5">
            <Text variant="label" size="sm">Programmazione attiva</Text>
          </label>
          <Select
            value={selectedId}
            onChange={(e) => setSelectedId(e.target.value)}
            options={options}
            disabled={switching || schedules.length === 0}
            liquid
          />
        </div>

        {/* Apply button - only show when selection changed */}
        {hasChanged && (
          <Button
            variant="primary"
            onClick={handleSwitch}
            loading={switching}
            icon={switching ? <RefreshCw className="animate-spin" /> : <Check />}
          >
            Applica
          </Button>
        )}
      </div>

      {/* Active indicator */}
      {activeSchedule && !hasChanged && (
        <div className="flex items-center gap-2 text-sage-400">
          <Check size={16} />
          <Text variant="sage" size="sm">
            "{activeSchedule.name}" è la programmazione attiva
          </Text>
        </div>
      )}

      {/* Pending change indicator */}
      {hasChanged && !switching && (
        <Text variant="warning" size="sm">
          Premi "Applica" per cambiare programmazione
        </Text>
      )}

      {/* Error message */}
      {error && (
        <Text variant="error" size="sm">{error}</Text>
      )}
    </div>
  );
}
```

Key behaviors:
- Two-step change: select → apply (prevents accidental switches)
- Shows current active schedule clearly
- Loading state during switch
- Error handling with user-friendly message
  </action>
  <verify>
Unit test: Verify dropdown renders options, apply button appears on change.
Integration: Test with real API in dev (switch schedule, verify cache invalidation).
  </verify>
  <done>ScheduleSelector allows selecting and switching schedules with confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Create schedule page</name>
  <files>app/schedule/page.js</files>
  <action>
Create the main schedule management page:

```javascript
'use client';
import { Suspense } from 'react';
import { useRouter } from 'next/navigation';
import { Card, Heading, Text, Button, Skeleton, ErrorAlert } from '@/app/components/ui';
import { useScheduleData } from '@/lib/hooks/useScheduleData';
import ScheduleSelector from './components/ScheduleSelector';
import WeeklyTimeline from './components/WeeklyTimeline';
import { ArrowLeft, RefreshCw, Calendar, Flame } from 'lucide-react';

function ScheduleContent() {
  const router = useRouter();
  const { schedules, activeSchedule, loading, error, refetch } = useScheduleData();

  if (loading) {
    return <Skeleton.SchedulePage />;
  }

  if (error) {
    return (
      <div className="max-w-4xl mx-auto px-4 py-8">
        <ErrorAlert message={error} />
        <div className="mt-4">
          <Button variant="secondary" onClick={refetch}>
            <RefreshCw size={16} className="mr-2" />
            Riprova
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto px-4 sm:px-6 py-8">
      {/* Header with back button */}
      <div className="mb-6">
        <Button
          variant="ghost"
          size="sm"
          onClick={() => router.push('/thermostat')}
          className="mb-4"
        >
          <ArrowLeft size={16} className="mr-1" />
          Termostato
        </Button>

        <div className="flex items-start justify-between">
          <div>
            <Heading level={1} size="3xl" className="flex items-center gap-3">
              <Calendar className="text-ember-400" />
              Programmazione
            </Heading>
            <Text variant="secondary" className="mt-1">
              Visualizza e gestisci le programmazioni settimanali del termostato
            </Text>
          </div>

          <Button
            variant="secondary"
            size="sm"
            onClick={refetch}
            icon={<RefreshCw size={16} />}
          >
            Aggiorna
          </Button>
        </div>
      </div>

      {/* Schedule selector card */}
      <Card variant="glass" className="p-5 sm:p-6 mb-6">
        <ScheduleSelector
          schedules={schedules}
          activeSchedule={activeSchedule}
          onScheduleChanged={refetch}
        />
      </Card>

      {/* Timeline card */}
      <Card variant="glass" className="p-5 sm:p-6 mb-6">
        <div className="flex items-center justify-between mb-4">
          <Heading level={2} size="xl">
            Programmazione Settimanale
          </Heading>
          {activeSchedule && (
            <Text variant="tertiary" size="sm">
              {activeSchedule.name}
            </Text>
          )}
        </div>

        <WeeklyTimeline schedule={activeSchedule} />
      </Card>

      {/* Manual override link */}
      <Card variant="elevated" className="p-5 sm:p-6">
        <div className="flex items-center justify-between">
          <div>
            <Heading level={3} size="lg" className="flex items-center gap-2">
              <Flame className="text-ember-400" />
              Override Manuale
            </Heading>
            <Text variant="secondary" size="sm" className="mt-1">
              Imposta una temperatura temporanea senza modificare la programmazione
            </Text>
          </div>
          <Button
            variant="ember"
            onClick={() => {
              // Will be implemented in Plan 04
              // Opens ManualOverrideSheet
              console.log('TODO: Open override sheet');
            }}
          >
            Boost
          </Button>
        </div>
      </Card>
    </div>
  );
}

export default function SchedulePage() {
  return (
    <Suspense fallback={<Skeleton.SchedulePage />}>
      <ScheduleContent />
    </Suspense>
  );
}
```

Page structure:
- Back navigation to /thermostat
- Header with refresh button
- Schedule selector in glass card
- Weekly timeline visualization
- Manual override section (button wired in Plan 04)
  </action>
  <verify>
Navigate to http://localhost:3000/schedule
- Page loads without errors
- Back button returns to /thermostat
- Schedules load and display in dropdown
- Timeline shows active schedule data
  </verify>
  <done>Schedule page renders with selector and timeline, navigation works</done>
</task>

<task type="auto">
  <name>Task 3: Add Skeleton.SchedulePage</name>
  <files>app/components/ui/Skeleton.js</files>
  <action>
Add SchedulePage skeleton to existing Skeleton component:

In the Skeleton object, add:

```javascript
SchedulePage: () => (
  <div className="max-w-4xl mx-auto px-4 sm:px-6 py-8">
    {/* Header */}
    <div className="mb-6">
      <div className="h-6 w-24 bg-slate-700/50 rounded mb-4 animate-pulse" />
      <div className="h-10 w-64 bg-slate-700/50 rounded mb-2 animate-pulse" />
      <div className="h-5 w-96 bg-slate-700/50 rounded animate-pulse" />
    </div>

    {/* Selector card */}
    <div className="bg-slate-800/50 rounded-2xl p-6 mb-6">
      <div className="h-5 w-32 bg-slate-700/50 rounded mb-2 animate-pulse" />
      <div className="h-12 w-full bg-slate-700/50 rounded-xl animate-pulse" />
    </div>

    {/* Timeline card */}
    <div className="bg-slate-800/50 rounded-2xl p-6">
      <div className="h-6 w-48 bg-slate-700/50 rounded mb-4 animate-pulse" />
      <div className="space-y-2">
        {Array(7).fill(null).map((_, i) => (
          <div key={i} className="flex gap-2">
            <div className="w-12 h-12 bg-slate-700/50 rounded animate-pulse" />
            <div className="flex-1 h-12 bg-slate-700/50 rounded animate-pulse" />
          </div>
        ))}
      </div>
    </div>
  </div>
),
```

Follow existing skeleton patterns in the file for consistency.
  </action>
  <verify>
Visual test: Force loading state and verify skeleton displays correctly.
  </verify>
  <done>Skeleton.SchedulePage added with appropriate loading placeholders</done>
</task>

</tasks>

<verification>
1. Navigate to /schedule - page loads with data
2. Select different schedule - Apply button appears
3. Click Apply - schedule switches, timeline updates
4. Back button returns to /thermostat
5. Loading state shows skeleton
6. Error state shows ErrorAlert with retry
</verification>

<success_criteria>
- Schedule page accessible at /schedule route
- ScheduleSelector shows all available schedules
- Active schedule clearly indicated
- Schedule switch requires confirmation (select → apply)
- Page follows Ember Noir design patterns
- Skeleton provides proper loading experience
</success_criteria>

<output>
After completion, create `.planning/phases/09-schedule-management-ui/09-03-SUMMARY.md`
</output>
