---
phase: 09-schedule-management-ui
plan: 04
type: execute
wave: 3
depends_on: ["09-01", "09-03"]
files_modified:
  - app/schedule/components/ManualOverrideSheet.js
  - app/schedule/components/DurationPicker.js
  - app/schedule/components/TemperaturePicker.js
  - lib/hooks/useRoomStatus.js
autonomous: true

must_haves:
  truths:
    - "User can open manual override UI from schedule page"
    - "User can select target temperature (5-30Â°C range)"
    - "User can select duration (5 min to 12 hours)"
    - "Override is applied to selected room via setroomthermpoint API"
  artifacts:
    - path: "app/schedule/components/ManualOverrideSheet.js"
      provides: "Bottom sheet modal for creating temperature overrides"
      exports: ["default"]
    - path: "app/schedule/components/DurationPicker.js"
      provides: "Logarithmic slider for duration selection"
      exports: ["default"]
    - path: "app/schedule/components/TemperaturePicker.js"
      provides: "Temperature selector with +/- buttons"
      exports: ["default"]
    - path: "lib/hooks/useRoomStatus.js"
      provides: "Hook for fetching room list and current status"
      exports: ["useRoomStatus"]
  key_links:
    - from: "app/schedule/components/ManualOverrideSheet.js"
      to: "/api/netatmo/setroomthermpoint"
      via: "POST fetch"
      pattern: "fetch.*setroomthermpoint.*POST"
---

<objective>
Build the manual override bottom sheet for creating temporary temperature overrides.

Purpose: Enable users to set a specific temperature for a limited duration without modifying the underlying schedule. This provides quick control when the stove is lit or heating needs adjustment.

Output: ManualOverrideSheet component with duration picker, temperature picker, and room selector.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-schedule-management-ui/09-CONTEXT.md
@.planning/phases/09-schedule-management-ui/09-RESEARCH.md

# UI components
@app/components/ui/BottomSheet.js
@app/components/ui/Button.js
@app/components/ui/RoomSelector.js

# API reference
@app/api/netatmo/setroomthermpoint/route.js
@lib/routes.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useRoomStatus hook</name>
  <files>lib/hooks/useRoomStatus.js</files>
  <action>
Create hook for fetching rooms with current status:

```javascript
'use client';
import { useState, useEffect, useCallback } from 'react';
import { NETATMO_ROUTES } from '@/lib/routes';

/**
 * useRoomStatus - Fetch rooms with current temperature/setpoint
 *
 * Returns rooms from homestatus API enriched with status info.
 */
export function useRoomStatus() {
  const [rooms, setRooms] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchRooms = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const res = await fetch(NETATMO_ROUTES.homeStatus);
      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.message || data.error || 'Failed to fetch rooms');
      }

      // Transform to room selector format
      const roomList = (data.rooms || []).map(room => ({
        id: room.room_id,
        name: room.room_name,
        temperature: room.temperature,
        setpoint: room.setpoint,
        mode: room.mode,
        heating: room.heating,
      }));

      setRooms(roomList);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchRooms();
  }, [fetchRooms]);

  return {
    rooms,
    loading,
    error,
    refetch: fetchRooms,
  };
}
```
  </action>
  <verify>
Unit test: Verify hook fetches and transforms room data correctly.
  </verify>
  <done>useRoomStatus hook exports rooms, loading, error, refetch</done>
</task>

<task type="auto">
  <name>Task 2: Create DurationPicker component</name>
  <files>app/schedule/components/DurationPicker.js</files>
  <action>
Create logarithmic duration slider:

```javascript
'use client';
import { formatDuration } from '@/lib/utils/scheduleHelpers';
import { Text } from '@/app/components/ui';

/**
 * DurationPicker - Logarithmic slider for 5min to 12 hours
 *
 * Uses logarithmic scale for better UX (more granularity at short durations).
 *
 * @param {number} value - Duration in minutes (5-720)
 * @param {Function} onChange - Called with new duration in minutes
 */
export default function DurationPicker({ value, onChange }) {
  // Logarithmic scale: 5 min to 720 min (12 hours)
  const minLog = Math.log(5);
  const maxLog = Math.log(720);

  const toSlider = (minutes) => {
    return ((Math.log(minutes) - minLog) / (maxLog - minLog)) * 100;
  };

  const fromSlider = (percent) => {
    const raw = Math.exp(minLog + (percent / 100) * (maxLog - minLog));
    // Round to nice values
    if (raw < 15) return Math.round(raw / 5) * 5; // 5-min steps
    if (raw < 60) return Math.round(raw / 15) * 15; // 15-min steps
    return Math.round(raw / 30) * 30; // 30-min steps
  };

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <Text variant="label" size="sm">Durata</Text>
        <Text variant="body" weight="bold" className="text-ember-400">
          {formatDuration(value)}
        </Text>
      </div>

      <input
        type="range"
        min={0}
        max={100}
        step={1}
        value={toSlider(value)}
        onChange={(e) => onChange(fromSlider(Number(e.target.value)))}
        className="
          w-full h-2 rounded-lg appearance-none cursor-pointer
          bg-slate-700 [html:not(.dark)_&]:bg-slate-200

          [&::-webkit-slider-thumb]:appearance-none
          [&::-webkit-slider-thumb]:w-6
          [&::-webkit-slider-thumb]:h-6
          [&::-webkit-slider-thumb]:rounded-full
          [&::-webkit-slider-thumb]:bg-ember-500
          [&::-webkit-slider-thumb]:shadow-lg
          [&::-webkit-slider-thumb]:cursor-pointer
          [&::-webkit-slider-thumb]:hover:scale-110
          [&::-webkit-slider-thumb]:active:scale-95
          [&::-webkit-slider-thumb]:transition-transform

          [&::-moz-range-thumb]:w-6
          [&::-moz-range-thumb]:h-6
          [&::-moz-range-thumb]:rounded-full
          [&::-moz-range-thumb]:bg-ember-500
          [&::-moz-range-thumb]:border-0
          [&::-moz-range-thumb]:cursor-pointer
        "
        style={{ touchAction: 'none' }}
      />

      {/* Scale markers */}
      <div className="flex justify-between text-xs text-slate-500">
        <span>5 min</span>
        <span>30 min</span>
        <span>2h</span>
        <span>6h</span>
        <span>12h</span>
      </div>
    </div>
  );
}
```

Key features:
- Logarithmic scale (more precision at low end)
- Snaps to nice values (5/15/30 min increments)
- Touch-friendly (large thumb, no touch-action)
- Ember accent color
  </action>
  <verify>
Manual test: Drag slider, verify output snaps to sensible values (5, 10, 15, 30, 45, 60, 90, 120, etc).
  </verify>
  <done>DurationPicker renders slider with logarithmic scale and nice value snapping</done>
</task>

<task type="auto">
  <name>Task 3: Create TemperaturePicker component</name>
  <files>app/schedule/components/TemperaturePicker.js</files>
  <action>
Create temperature selector with +/- controls:

```javascript
'use client';
import { Button, Text } from '@/app/components/ui';
import { Minus, Plus } from 'lucide-react';
import { tempToColor } from '@/lib/utils/scheduleHelpers';

/**
 * TemperaturePicker - Temperature selector with +/- buttons
 *
 * @param {number} value - Temperature in Â°C
 * @param {Function} onChange - Called with new temperature
 * @param {number} min - Minimum temperature (default: 5)
 * @param {number} max - Maximum temperature (default: 30)
 * @param {number} step - Step size (default: 0.5)
 */
export default function TemperaturePicker({
  value,
  onChange,
  min = 5,
  max = 30,
  step = 0.5,
}) {
  const decrease = () => {
    const newValue = Math.max(min, value - step);
    onChange(newValue);
  };

  const increase = () => {
    const newValue = Math.min(max, value + step);
    onChange(newValue);
  };

  const bgColor = tempToColor(value);

  return (
    <div className="space-y-3">
      <Text variant="label" size="sm">Temperatura</Text>

      <div className="flex items-center justify-center gap-4">
        {/* Decrease button */}
        <Button
          variant="secondary"
          size="lg"
          onClick={decrease}
          disabled={value <= min}
          className="w-14 h-14 rounded-full p-0"
          aria-label="Diminuisci temperatura"
        >
          <Minus size={24} />
        </Button>

        {/* Temperature display */}
        <div
          className="
            w-28 h-28 rounded-full
            flex flex-col items-center justify-center
            shadow-lg transition-colors duration-300
          "
          style={{ backgroundColor: bgColor }}
        >
          <span className="text-3xl font-bold text-white drop-shadow">
            {value.toFixed(1)}
          </span>
          <span className="text-sm text-white/80">Â°C</span>
        </div>

        {/* Increase button */}
        <Button
          variant="secondary"
          size="lg"
          onClick={increase}
          disabled={value >= max}
          className="w-14 h-14 rounded-full p-0"
          aria-label="Aumenta temperatura"
        >
          <Plus size={24} />
        </Button>
      </div>

      {/* Min/max labels */}
      <div className="flex justify-between text-xs text-slate-500 px-4">
        <span>{min}Â°C</span>
        <span>{max}Â°C</span>
      </div>
    </div>
  );
}
```

Key features:
- Large touch targets (56px buttons)
- Visual feedback via color gradient
- 0.5Â°C step for precision
- Disabled states at min/max
  </action>
  <verify>
Manual test: Click +/-, verify temperature changes by 0.5Â°C, buttons disabled at limits.
  </verify>
  <done>TemperaturePicker allows selecting temperature with +/- buttons and color feedback</done>
</task>

<task type="auto">
  <name>Task 4: Create ManualOverrideSheet component</name>
  <files>app/schedule/components/ManualOverrideSheet.js</files>
  <action>
Create the main override bottom sheet:

```javascript
'use client';
import { useState, useEffect } from 'react';
import { BottomSheet, Button, Text, Select, ErrorAlert } from '@/app/components/ui';
import { NETATMO_ROUTES } from '@/lib/routes';
import { useRoomStatus } from '@/lib/hooks/useRoomStatus';
import DurationPicker from './DurationPicker';
import TemperaturePicker from './TemperaturePicker';
import { Flame, CheckCircle } from 'lucide-react';

/**
 * ManualOverrideSheet - Bottom sheet for creating temperature overrides
 *
 * @param {boolean} isOpen - Sheet visibility
 * @param {Function} onClose - Close handler
 * @param {Function} onOverrideCreated - Success callback
 */
export default function ManualOverrideSheet({
  isOpen,
  onClose,
  onOverrideCreated,
}) {
  const { rooms, loading: roomsLoading } = useRoomStatus();

  // Form state
  const [selectedRoomId, setSelectedRoomId] = useState('');
  const [temperature, setTemperature] = useState(20);
  const [duration, setDuration] = useState(60); // 1 hour default
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState(null);
  const [success, setSuccess] = useState(false);

  // Auto-select first room when loaded
  useEffect(() => {
    if (rooms.length > 0 && !selectedRoomId) {
      setSelectedRoomId(rooms[0].id);
      // Pre-fill temperature from current setpoint
      const room = rooms[0];
      if (room.setpoint) {
        setTemperature(room.setpoint);
      }
    }
  }, [rooms, selectedRoomId]);

  // Update temperature when room changes
  const handleRoomChange = (roomId) => {
    setSelectedRoomId(roomId);
    const room = rooms.find(r => r.id === roomId);
    if (room?.setpoint) {
      setTemperature(room.setpoint);
    }
  };

  const handleSubmit = async () => {
    if (!selectedRoomId) return;

    try {
      setSubmitting(true);
      setError(null);

      // Calculate endtime (UNIX timestamp in SECONDS)
      const endtime = Math.floor(Date.now() / 1000) + duration * 60;

      const res = await fetch(NETATMO_ROUTES.setRoomThermpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          room_id: selectedRoomId,
          mode: 'manual',
          temp: temperature,
          endtime,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.message || data.error || 'Impossibile impostare override');
      }

      // Show success briefly, then close
      setSuccess(true);
      setTimeout(() => {
        onOverrideCreated?.();
        onClose();
        // Reset state
        setSuccess(false);
        setError(null);
      }, 1500);
    } catch (err) {
      setError(err.message);
    } finally {
      setSubmitting(false);
    }
  };

  // Room options for select
  const roomOptions = rooms.map(r => ({
    value: r.id,
    label: `${r.name} (${r.temperature?.toFixed(1) || '--'}Â°C)`,
  }));

  const selectedRoom = rooms.find(r => r.id === selectedRoomId);

  return (
    <BottomSheet
      isOpen={isOpen}
      onClose={onClose}
      title="Manual Boost"
      icon="ðŸ”¥"
    >
      {/* Success state */}
      {success ? (
        <div className="text-center py-8">
          <CheckCircle className="w-16 h-16 text-sage-400 mx-auto mb-4" />
          <Text variant="sage" size="lg" weight="bold">Override applicato!</Text>
        </div>
      ) : (
        <div className="space-y-6">
          {/* Room selector */}
          <div>
            <Text variant="label" size="sm" className="mb-1.5">Stanza</Text>
            <Select
              value={selectedRoomId}
              onChange={(e) => handleRoomChange(e.target.value)}
              options={roomOptions}
              disabled={roomsLoading || submitting}
              liquid
            />
            {selectedRoom && (
              <Text variant="tertiary" size="xs" className="mt-1">
                Attuale: {selectedRoom.setpoint}Â°C â€¢ {selectedRoom.mode === 'manual' ? 'Override attivo' : 'Programmato'}
              </Text>
            )}
          </div>

          {/* Temperature picker */}
          <TemperaturePicker
            value={temperature}
            onChange={setTemperature}
          />

          {/* Duration picker */}
          <DurationPicker
            value={duration}
            onChange={setDuration}
          />

          {/* Error message */}
          {error && (
            <ErrorAlert message={error} />
          )}

          {/* Submit button */}
          <Button
            variant="ember"
            size="lg"
            onClick={handleSubmit}
            loading={submitting}
            disabled={!selectedRoomId || submitting}
            className="w-full"
            icon={<Flame />}
          >
            Applica Override
          </Button>

          {/* Help text */}
          <Text variant="tertiary" size="xs" className="text-center">
            L'override terminerÃ  automaticamente. La programmazione normale riprenderÃ  al termine.
          </Text>
        </div>
      )}
    </BottomSheet>
  );
}
```

Key behaviors:
- Auto-selects first room, pre-fills current setpoint
- Shows current room temperature in selector
- endtime calculated in SECONDS (not milliseconds!)
- Success feedback before closing
- Error handling with retry capability
  </action>
  <verify>
Integration test:
1. Open sheet, verify rooms load
2. Select room, verify temp pre-fills
3. Adjust temp and duration
4. Submit, verify API call succeeds
5. Verify success state shows before close
  </verify>
  <done>ManualOverrideSheet creates temperature overrides via setroomthermpoint API</done>
</task>

</tasks>

<verification>
1. Open override sheet from schedule page
2. Select room - temperature pre-fills from current setpoint
3. Adjust temperature with +/- buttons
4. Adjust duration with slider
5. Submit - verify success, sheet closes
6. Check Netatmo app - override active on selected room
</verification>

<success_criteria>
- ManualOverrideSheet opens as bottom sheet on mobile
- Room selector shows all rooms with current temperature
- Temperature picker allows 5-30Â°C range in 0.5Â°C steps
- Duration picker allows 5 min to 12 hours with logarithmic scale
- Override applied via setroomthermpoint API with correct endtime (seconds)
- Success feedback shown before sheet closes
- Error handling displays user-friendly messages
</success_criteria>

<output>
After completion, create `.planning/phases/09-schedule-management-ui/09-04-SUMMARY.md`
</output>
