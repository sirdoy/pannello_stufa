---
phase: 09-schedule-management-ui
plan: 05
type: execute
wave: 3
depends_on: ["09-02", "09-03", "09-04"]
files_modified:
  - app/schedule/components/ActiveOverrideBadge.js
  - app/schedule/page.js
  - app/thermostat/page.js
autonomous: true

must_haves:
  truths:
    - "User can see when a manual override is active on timeline"
    - "User can cancel an active override by tapping the badge"
    - "User can navigate to schedule page from thermostat"
  artifacts:
    - path: "app/schedule/components/ActiveOverrideBadge.js"
      provides: "Badge showing active override with cancel action"
      exports: ["default"]
  key_links:
    - from: "app/schedule/page.js"
      to: "app/schedule/components/ManualOverrideSheet.js"
      via: "state management"
      pattern: "useState.*showOverrideSheet"
    - from: "app/schedule/components/ActiveOverrideBadge.js"
      to: "/api/netatmo/setroomthermpoint"
      via: "cancel POST"
      pattern: "mode.*home"
---

<objective>
Complete the schedule UI with active override badge, cancellation flow, and navigation integration.

Purpose: Provide visual feedback when a manual override is active and allow users to cancel it easily. Connect the schedule page to the thermostat page for natural navigation.

Output: ActiveOverrideBadge component, integrated ManualOverrideSheet, and navigation link from thermostat.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-schedule-management-ui/09-CONTEXT.md
@.planning/phases/09-schedule-management-ui/09-RESEARCH.md

# Dependencies
@app/schedule/page.js
@app/schedule/components/ManualOverrideSheet.js
@app/thermostat/page.js
@lib/hooks/useRoomStatus.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActiveOverrideBadge component</name>
  <files>app/schedule/components/ActiveOverrideBadge.js</files>
  <action>
Create badge component showing active override with cancel action:

```javascript
'use client';
import { useState } from 'react';
import { Button, Text, ConfirmDialog } from '@/app/components/ui';
import { NETATMO_ROUTES } from '@/lib/routes';
import { X, Flame, Clock } from 'lucide-react';
import { format } from 'date-fns';
import { it } from 'date-fns/locale';

/**
 * ActiveOverrideBadge - Shows active override with cancel option
 *
 * @param {Object} room - Room object with override info
 * @param {number} room.id - Room ID
 * @param {string} room.name - Room name
 * @param {number} room.setpoint - Current override temperature
 * @param {number} room.endtime - UNIX timestamp (seconds) when override ends
 * @param {Function} onCancelled - Callback after cancellation
 */
export default function ActiveOverrideBadge({
  room,
  onCancelled,
}) {
  const [showConfirm, setShowConfirm] = useState(false);
  const [cancelling, setCancelling] = useState(false);

  if (!room || room.mode !== 'manual') {
    return null;
  }

  // Calculate remaining time
  const endDate = room.endtime ? new Date(room.endtime * 1000) : null;
  const now = new Date();
  const remainingMinutes = endDate ? Math.max(0, Math.round((endDate - now) / 60000)) : null;

  const formatRemaining = (minutes) => {
    if (!minutes) return '';
    if (minutes < 60) return `${minutes} min`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
  };

  const handleCancel = async () => {
    try {
      setCancelling(true);

      const res = await fetch(NETATMO_ROUTES.setRoomThermpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          room_id: room.id,
          mode: 'home', // Return to schedule
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || 'Impossibile annullare override');
      }

      setShowConfirm(false);
      onCancelled?.();
    } catch (err) {
      console.error('Cancel override failed:', err);
      // Keep dialog open on error
    } finally {
      setCancelling(false);
    }
  };

  return (
    <>
      {/* Badge */}
      <button
        onClick={() => setShowConfirm(true)}
        className="
          flex items-center gap-3
          bg-ember-500/20 hover:bg-ember-500/30
          border border-ember-500/40
          rounded-xl px-4 py-3
          transition-colors
          group
        "
      >
        <div className="flex items-center gap-2">
          <Flame className="text-ember-400" size={20} />
          <div className="text-left">
            <Text variant="body" weight="bold" className="text-ember-300">
              {room.setpoint}°C
            </Text>
            <Text variant="tertiary" size="xs">
              {room.name}
            </Text>
          </div>
        </div>

        <div className="flex items-center gap-2 text-ember-400/70">
          <Clock size={14} />
          <Text variant="tertiary" size="xs">
            {remainingMinutes !== null ? (
              <>fino alle {format(endDate, 'HH:mm', { locale: it })}</>
            ) : (
              'Override attivo'
            )}
          </Text>
        </div>

        <X
          size={16}
          className="text-slate-400 group-hover:text-ember-400 transition-colors"
        />
      </button>

      {/* Confirm dialog */}
      <ConfirmDialog
        isOpen={showConfirm}
        onClose={() => setShowConfirm(false)}
        onConfirm={handleCancel}
        title="Annulla Override"
        message={`Vuoi tornare alla programmazione normale per ${room.name}?`}
        confirmText="Annulla Override"
        cancelText="Mantieni"
        variant="warning"
        loading={cancelling}
      />
    </>
  );
}
```

Key features:
- Shows temperature, room name, and remaining time
- Tap opens confirmation dialog
- Cancellation sets mode to 'home' (return to schedule)
- Loading state during API call
  </action>
  <verify>
Integration test:
1. Create override via ManualOverrideSheet
2. Badge appears with correct info
3. Tap badge - confirm dialog opens
4. Cancel override - badge disappears
  </verify>
  <done>ActiveOverrideBadge shows override info and allows cancellation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ManualOverrideSheet and badge into schedule page</name>
  <files>app/schedule/page.js</files>
  <action>
Update schedule page to integrate the override sheet and active badge:

Add imports:
```javascript
import ManualOverrideSheet from './components/ManualOverrideSheet';
import ActiveOverrideBadge from './components/ActiveOverrideBadge';
import { useRoomStatus } from '@/lib/hooks/useRoomStatus';
```

Add state and hooks inside ScheduleContent:
```javascript
const [showOverrideSheet, setShowOverrideSheet] = useState(false);
const { rooms, refetch: refetchRooms } = useRoomStatus();

// Find rooms with active override
const roomsWithOverride = rooms.filter(r => r.mode === 'manual');
```

Update the "Manual Override" section (replace the existing card):
```javascript
{/* Active overrides section */}
{roomsWithOverride.length > 0 && (
  <Card variant="elevated" className="p-5 sm:p-6 mb-6">
    <Heading level={3} size="lg" className="flex items-center gap-2 mb-4">
      <Flame className="text-ember-400" />
      Override Attivi
    </Heading>
    <div className="space-y-2">
      {roomsWithOverride.map(room => (
        <ActiveOverrideBadge
          key={room.id}
          room={room}
          onCancelled={() => {
            refetchRooms();
            refetch(); // Also refresh schedules
          }}
        />
      ))}
    </div>
  </Card>
)}

{/* Manual override button */}
<Card variant="elevated" className="p-5 sm:p-6">
  <div className="flex items-center justify-between">
    <div>
      <Heading level={3} size="lg" className="flex items-center gap-2">
        <Flame className="text-ember-400" />
        Override Manuale
      </Heading>
      <Text variant="secondary" size="sm" className="mt-1">
        Imposta una temperatura temporanea senza modificare la programmazione
      </Text>
    </div>
    <Button
      variant="ember"
      onClick={() => setShowOverrideSheet(true)}
    >
      Boost
    </Button>
  </div>
</Card>

{/* Override sheet */}
<ManualOverrideSheet
  isOpen={showOverrideSheet}
  onClose={() => setShowOverrideSheet(false)}
  onOverrideCreated={() => {
    refetchRooms();
    refetch();
  }}
/>
```

Ensure the Boost button click opens the sheet:
- Replace `console.log('TODO: Open override sheet')` with `setShowOverrideSheet(true)`
  </action>
  <verify>
Integration test:
1. Load schedule page
2. Click Boost button - sheet opens
3. Create override - sheet closes, badge appears
4. Cancel override - badge disappears
5. Multiple overrides show as separate badges
  </verify>
  <done>Schedule page integrates ManualOverrideSheet and shows active overrides</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation link from thermostat page</name>
  <files>app/thermostat/page.js</files>
  <action>
Add a "Schedule" link in the thermostat page to navigate to /schedule:

Add import:
```javascript
import { Calendar } from 'lucide-react';
import Link from 'next/link';
```

Add a new card after the "Mode Control" card (after line ~405, before StoveSyncPanel):
```javascript
{/* Schedule Management Link */}
<Card variant="glass" className="p-5 sm:p-6 mb-6">
  <Link
    href="/schedule"
    className="flex items-center justify-between group"
  >
    <div className="flex items-center gap-3">
      <div className="
        w-10 h-10 rounded-xl
        bg-ember-500/20 flex items-center justify-center
        group-hover:bg-ember-500/30 transition-colors
      ">
        <Calendar className="text-ember-400" size={20} />
      </div>
      <div>
        <Heading level={3} size="lg">
          Programmazione
        </Heading>
        <Text variant="secondary" size="sm">
          Visualizza e gestisci le programmazioni settimanali
        </Text>
      </div>
    </div>
    <Button variant="ghost" size="sm" className="group-hover:text-ember-400">
      Apri →
    </Button>
  </Link>
</Card>
```

Position this BEFORE the StoveSyncPanel for logical grouping (schedule → sync → rooms).
  </action>
  <verify>
Navigate to /thermostat:
1. Schedule link card is visible
2. Click navigates to /schedule
3. Back button on /schedule returns to /thermostat
  </verify>
  <done>Thermostat page has navigation link to schedule management</done>
</task>

</tasks>

<verification>
Complete flow test:
1. `/thermostat` - click "Programmazione" card → navigates to `/schedule`
2. `/schedule` - view active schedule in timeline
3. Click "Boost" → override sheet opens
4. Create override → sheet closes, badge appears
5. Tap badge → confirm dialog
6. Cancel override → badge disappears
7. Click back → returns to `/thermostat`
</verification>

<success_criteria>
- ActiveOverrideBadge displays when room has mode='manual'
- Badge shows temperature, room name, and remaining time
- Tap badge → confirmation dialog for cancellation
- Cancel sends mode='home' to setroomthermpoint API
- ManualOverrideSheet integrated into schedule page
- Thermostat page has visible link to schedule page
- Full flow from thermostat → schedule → override → cancel works
</success_criteria>

<output>
After completion, create `.planning/phases/09-schedule-management-ui/09-05-SUMMARY.md`
</output>
