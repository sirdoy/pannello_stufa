---
phase: 10-monitoring-dashboard-&-alerts-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/health-monitoring/logs/route.js
  - app/api/health-monitoring/stats/route.js
  - app/api/health-monitoring/dead-man-switch/route.js
  - __tests__/api/health-monitoring.test.js
autonomous: true

must_haves:
  truths:
    - "API returns paginated health logs with cursor support"
    - "API returns aggregated statistics for dashboard cards"
    - "API returns dead man's switch status with stale detection"
  artifacts:
    - path: "app/api/health-monitoring/logs/route.js"
      provides: "Paginated health event logs"
      exports: ["GET"]
    - path: "app/api/health-monitoring/stats/route.js"
      provides: "Aggregated statistics"
      exports: ["GET"]
    - path: "app/api/health-monitoring/dead-man-switch/route.js"
      provides: "Dead man's switch status"
      exports: ["GET"]
  key_links:
    - from: "app/api/health-monitoring/logs/route.js"
      to: "lib/healthLogger.js"
      via: "getRecentHealthLogs import"
      pattern: "import.*getRecentHealthLogs.*from.*healthLogger"
    - from: "app/api/health-monitoring/stats/route.js"
      to: "lib/healthLogger.js"
      via: "getHealthStats import"
      pattern: "import.*getHealthStats.*from.*healthLogger"
    - from: "app/api/health-monitoring/dead-man-switch/route.js"
      to: "lib/healthDeadManSwitch.js"
      via: "checkDeadManSwitch import"
      pattern: "import.*checkDeadManSwitch.*from.*healthDeadManSwitch"
---

<objective>
Create API routes to expose Phase 7's health monitoring backend services to the frontend dashboard.

Purpose: Enable frontend components to fetch health logs, statistics, and dead man's switch status via authenticated API endpoints.

Output: Three API routes that wrap existing lib functions with proper auth and pagination support.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Existing services (from Phase 7):
- lib/healthLogger.js exports: getRecentHealthLogs(), getHealthStats(), getHealthCheckDetails()
- lib/healthDeadManSwitch.js exports: checkDeadManSwitch()

Reference patterns:
- app/api/notifications/history/route.js - cursor pagination pattern
- lib/core/middleware.js - withAuth pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Health Logs API Route with Cursor Pagination</name>
  <files>app/api/health-monitoring/logs/route.js</files>
  <action>
Create GET endpoint for paginated health monitoring logs.

Query parameters:
- `limit` (default: 50, max: 100)
- `cursor` (document ID for pagination)
- `type` (optional filter: 'mismatch' for hasStateMismatch=true)
- `severity` (optional filter: 'error' for failureCount>0, 'warning' for hasStateMismatch=true)

Implementation:
1. Use withAuth wrapper for authentication
2. Parse query params with sensible defaults
3. Use getAdminFirestore() directly for cursor-based pagination (getRecentHealthLogs doesn't support cursors)
4. Apply 7-day date filter using date-fns subDays
5. Apply type/severity filters by mapping to Firestore fields
6. Order by timestamp descending
7. Return: { events, cursor, hasMore }

Follow NotificationInbox pattern for cursor pagination:
- cursor is last document ID
- hasMore = events.length === limit
- Convert Firestore Timestamp to ISO string

Export: `export const dynamic = 'force-dynamic';`
  </action>
  <verify>Create test file and verify route exports GET, uses withAuth, returns proper JSON structure</verify>
  <done>GET /api/health-monitoring/logs returns paginated events with cursor support</done>
</task>

<task type="auto">
  <name>Task 2: Health Stats API Route</name>
  <files>app/api/health-monitoring/stats/route.js</files>
  <action>
Create GET endpoint for aggregated health statistics.

Query parameters:
- `days` (default: 7, max: 30)

Implementation:
1. Use withAuth wrapper
2. Parse days param with validation (1-30)
3. Call getHealthStats(days) from lib/healthLogger.js
4. Return stats object directly

Response structure (from getHealthStats):
{
  totalRuns: number,
  totalChecks: number,
  successfulChecks: number,
  failedChecks: number,
  mismatchCount: number,
  successRate: string (e.g., "99.5")
}

Keep simple - just wrap existing function with auth.
  </action>
  <verify>npm test -- --testPathPattern="health-monitoring" passes</verify>
  <done>GET /api/health-monitoring/stats returns aggregated statistics</done>
</task>

<task type="auto">
  <name>Task 3: Dead Man's Switch Status API Route</name>
  <files>app/api/health-monitoring/dead-man-switch/route.js</files>
  <action>
Create GET endpoint for dead man's switch status.

No query parameters needed.

Implementation:
1. Use withAuth wrapper
2. Call checkDeadManSwitch() from lib/healthDeadManSwitch.js
3. Return status object directly

Response structure (from checkDeadManSwitch):
- Healthy: { stale: false, elapsed: number, lastCheck: ISO string }
- Never run: { stale: true, reason: 'never_run' }
- Timeout: { stale: true, elapsed: number, reason: 'timeout', lastCheck: ISO string }
- Error: { stale: true, reason: 'error', error: string }

Frontend will poll this every 30 seconds for status updates.
  </action>
  <verify>Route returns proper status object, handles all stale cases</verify>
  <done>GET /api/health-monitoring/dead-man-switch returns DMS status</done>
</task>

</tasks>

<verification>
1. All three routes exist and export GET handler
2. Routes use withAuth middleware
3. Routes include `export const dynamic = 'force-dynamic'`
4. npm test passes (if tests written)
5. Manual test: curl endpoints return expected JSON structure
</verification>

<success_criteria>
- /api/health-monitoring/logs returns paginated events with cursor
- /api/health-monitoring/stats returns aggregated stats for N days
- /api/health-monitoring/dead-man-switch returns stale status
- All routes authenticated via withAuth
</success_criteria>

<output>
After completion, create `.planning/phases/10-monitoring-dashboard-&-alerts-ui/10-01-SUMMARY.md`
</output>
