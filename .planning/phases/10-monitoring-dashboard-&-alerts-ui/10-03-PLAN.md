---
phase: 10-monitoring-dashboard-&-alerts-ui
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - components/monitoring/MonitoringTimeline.js
  - components/monitoring/HealthEventItem.js
  - components/monitoring/EventFilters.js
  - __tests__/components/monitoring/Timeline.test.js
autonomous: true

must_haves:
  truths:
    - "User can see chronological event stream with newest first"
    - "User can tap event to expand inline (accordion style)"
    - "User can filter by event type and severity"
    - "Timeline implements memory safeguard (MAX_EVENTS limit)"
  artifacts:
    - path: "components/monitoring/MonitoringTimeline.js"
      provides: "Infinite scroll event feed"
      min_lines: 80
    - path: "components/monitoring/HealthEventItem.js"
      provides: "Expandable event item"
      min_lines: 50
    - path: "components/monitoring/EventFilters.js"
      provides: "Type and severity filters"
      min_lines: 30
  key_links:
    - from: "components/monitoring/MonitoringTimeline.js"
      to: "/api/health-monitoring/logs"
      via: "fetch call"
      pattern: "fetch.*api/health-monitoring/logs"
    - from: "components/monitoring/MonitoringTimeline.js"
      to: "react-infinite-scroll-component"
      via: "InfiniteScroll import"
      pattern: "import.*InfiniteScroll.*from.*react-infinite-scroll-component"
---

<objective>
Create timeline components for the monitoring dashboard event history section.

Purpose: Display 7-day monitoring event history with filtering and infinite scroll pagination.

Output: Timeline component with infinite scroll, expandable event items, and filter controls.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md

Design decisions (from 10-CONTEXT.md):
- Chronological event stream (newest first, simple list)
- Compact event display: Icon + timestamp + one-line summary
- Tap event to expand inline (accordion style)
- Filtering: event type (connection, state mismatch, cron execution, alerts)
- Filtering: severity (errors, warnings, normal, success)
- NO date range picker or search (keep it simple)

Reference patterns:
- components/notifications/NotificationInbox.js - infinite scroll pattern
- components/notifications/NotificationFilters.js - filter pattern
- MAX_NOTIFICATIONS = 200 memory safeguard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Event Filters Component</name>
  <files>components/monitoring/EventFilters.js</files>
  <action>
Create client component for timeline filtering.

Props:
- `type` - current type filter value
- `severity` - current severity filter value
- `onTypeChange` - callback for type change
- `onSeverityChange` - callback for severity change

Type options:
- '' (empty): "Tutti gli eventi"
- 'mismatch': "State Mismatch"
- 'error': "Errori"

Severity options:
- '' (empty): "Tutte le severita"
- 'error': "Solo errori"
- 'warning': "Solo warning"
- 'success': "Solo successi"

Display:
- Horizontal flex row with two Select components
- "Pulisci filtri" button when any filter active

Use design system: Select (liquid), Button (variant="ghost", size="sm")
Follow NotificationFilters.js pattern exactly.
  </action>
  <verify>Component renders select dropdowns and clear button</verify>
  <done>EventFilters displays type and severity filter dropdowns</done>
</task>

<task type="auto">
  <name>Task 2: Health Event Item Component</name>
  <files>components/monitoring/HealthEventItem.js</files>
  <action>
Create client component for individual timeline events with accordion expansion.

Props:
- `event` - health monitoring log object from API

Compact view (always visible):
1. Status indicator: Icon based on event status
   - hasStateMismatch: AlertTriangle (yellow)
   - failureCount > 0: XCircle (red)
   - else: CheckCircle (green)
2. One-line summary:
   - hasStateMismatch: "State mismatch rilevato"
   - failureCount > 0: "Controllo fallito"
   - else: "Controllo completato"
3. Relative timestamp: formatDistanceToNow(event.timestamp, { addSuffix: true })
4. Chevron indicator: ChevronDown/ChevronUp based on expanded state

Expanded view (shown when clicked):
- Border-left accent line for visual hierarchy
- Details: checkedCount, successCount, failureCount
- Duration: event.duration + "ms"
- If hasStateMismatch: show mismatch details

State management:
- useState for expanded boolean
- onClick toggles expanded

Use lucide-react: CheckCircle, AlertTriangle, XCircle, ChevronDown, ChevronUp
Use date-fns: formatDistanceToNow
  </action>
  <verify>Component expands on click, shows correct icons based on status</verify>
  <done>HealthEventItem displays compact view with expand-on-tap</done>
</task>

<task type="auto">
  <name>Task 3: Monitoring Timeline Component</name>
  <files>components/monitoring/MonitoringTimeline.js</files>
  <action>
Create client component with infinite scroll following NotificationInbox pattern.

State:
- events: array of event objects
- cursor: string (document ID for pagination)
- hasMore: boolean
- isLoading: boolean
- typeFilter: string
- severityFilter: string

Fetch logic (copy from NotificationInbox pattern):
1. Build URLSearchParams with limit=50, cursor, type, severity
2. Fetch from /api/health-monitoring/logs
3. On resetList=true: replace events
4. On resetList=false: append events
5. Update cursor, hasMore

Memory safeguard:
- MAX_EVENTS = 200
- setHasMore(data.hasMore && totalAfter < MAX_EVENTS)

Filter change handling:
- Reset cursor to null
- Clear events array
- Set hasMore to true
- Set isLoading to true

Loading state:
- Show Skeleton placeholders when isLoading && events.length === 0

Empty state:
- Show EmptyState component with "Nessun evento trovato" message

Main render:
1. EventFilters component
2. Card with InfiniteScroll wrapper
3. Map events to HealthEventItem components
4. Divider between items

Use react-infinite-scroll-component: InfiniteScroll
Follow NotificationInbox.js structure exactly for scroll behavior.
  </action>
  <verify>Component loads events, filters work, scroll loads more</verify>
  <done>MonitoringTimeline displays event feed with infinite scroll and filters</done>
</task>

</tasks>

<verification>
1. All three components exist in components/monitoring/
2. Components use 'use client' directive
3. MonitoringTimeline uses InfiniteScroll from react-infinite-scroll-component
4. HealthEventItem expands on click
5. EventFilters shows clear button when filtered
6. MAX_EVENTS = 200 constant exists
</verification>

<success_criteria>
- MonitoringTimeline fetches and displays paginated events
- Infinite scroll loads more events on scroll
- HealthEventItem shows compact view, expands on tap
- EventFilters allows type and severity filtering
- Filter changes reset list and refetch
- Memory safeguard prevents loading >200 events
</success_criteria>

<output>
After completion, create `.planning/phases/10-monitoring-dashboard-&-alerts-ui/10-03-SUMMARY.md`
</output>
