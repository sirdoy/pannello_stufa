---
phase: 14-feedback-layout-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/Modal.js
  - app/components/ui/__tests__/Modal.test.js
autonomous: true

must_haves:
  truths:
    - "User can open Modal in 5 different sizes (sm, md, lg, xl, full)"
    - "User can dismiss Modal via ESC key"
    - "User can dismiss Modal via backdrop click"
    - "Focus is trapped inside Modal when open"
    - "Modal appears as bottom sheet on mobile (max-sm breakpoint)"
  artifacts:
    - path: "app/components/ui/Modal.js"
      provides: "Modal with Radix Dialog + CVA sizes + mobile bottom sheet"
      exports: ["default", "Modal", "ModalHeader", "ModalTitle", "ModalDescription", "ModalFooter", "ModalClose"]
    - path: "app/components/ui/__tests__/Modal.test.js"
      provides: "Accessibility and interaction tests"
      min_lines: 100
  key_links:
    - from: "app/components/ui/Modal.js"
      to: "@radix-ui/react-dialog"
      via: "Radix Dialog primitive"
      pattern: "DialogPrimitive"
---

<objective>
Refactor Modal to use Radix Dialog primitive with CVA size variants and mobile bottom sheet behavior.

Purpose: Replace custom focus/escape handling with Radix's built-in accessible patterns, add size variants for different content needs, and provide native-feeling bottom sheet on mobile.
Output: Modal component with sm/md/lg/xl/full sizes, automatic focus trap, and responsive mobile behavior.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-feedback-layout-components/14-RESEARCH.md
@app/components/ui/Modal.js
@app/components/ui/Button.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Modal with Radix Dialog and CVA</name>
  <files>app/components/ui/Modal.js</files>
  <action>
Replace the existing Modal implementation with Radix Dialog primitive:

1. Import dependencies:
   - `import * as DialogPrimitive from '@radix-ui/react-dialog'`
   - `import { cva } from 'class-variance-authority'`
   - `import { cn } from '@/lib/utils/cn'`
   - `import { forwardRef } from 'react'`
   - `import { X } from 'lucide-react'`

2. Create CVA variants for overlay:
   ```javascript
   const overlayVariants = cva([
     'fixed inset-0 z-50',
     'bg-slate-950/70 [html:not(.dark)_&]:bg-slate-900/40',
     'backdrop-blur-md',
     'data-[state=open]:animate-fade-in',
     'data-[state=closed]:animate-fade-out',
   ]);
   ```

3. Create CVA variants for content with sizes:
   ```javascript
   const contentVariants = cva(
     [
       'fixed z-50 p-6',
       'bg-slate-900/95 [html:not(.dark)_&]:bg-white/95',
       'backdrop-blur-3xl',
       'border border-slate-700/50 [html:not(.dark)_&]:border-slate-200',
       'shadow-card-elevated',
       'focus:outline-none',
       'overflow-y-auto',
       // Desktop: centered
       'left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2',
       'rounded-3xl max-h-[85vh]',
       // Animation
       'data-[state=open]:animate-scale-in-center',
       'data-[state=closed]:animate-fade-out',
       // Mobile bottom sheet override (max-sm = < 640px)
       'max-sm:left-0 max-sm:right-0 max-sm:bottom-0 max-sm:top-auto',
       'max-sm:translate-x-0 max-sm:translate-y-0',
       'max-sm:rounded-t-3xl max-sm:rounded-b-none',
       'max-sm:max-h-[85vh] max-sm:w-full max-sm:max-w-none',
       'max-sm:data-[state=open]:animate-slide-in-from-bottom',
     ],
     {
       variants: {
         size: {
           sm: 'w-full max-w-sm',
           md: 'w-full max-w-md',
           lg: 'w-full max-w-lg',
           xl: 'w-full max-w-xl',
           full: 'w-[95vw] h-[85vh] max-w-none',
         },
       },
       defaultVariants: { size: 'md' },
     }
   );
   ```

4. Create namespace components:
   - `ModalOverlay` - Radix Overlay with overlayVariants
   - `ModalContent` - Radix Content with contentVariants + size prop
   - `ModalHeader` - flex container for title area
   - `ModalTitle` - Radix Title with typography
   - `ModalDescription` - Radix Description
   - `ModalFooter` - flex container for actions
   - `ModalClose` - Radix Close with X icon

5. Keep backwards-compatible default export:
   ```javascript
   function Modal({ isOpen, onClose, children, size = 'md', className, ...props }) {
     return (
       <DialogPrimitive.Root open={isOpen} onOpenChange={(open) => !open && onClose?.()}>
         <DialogPrimitive.Portal>
           <ModalOverlay />
           <ModalContent size={size} className={className} {...props}>
             {children}
           </ModalContent>
         </DialogPrimitive.Portal>
       </DialogPrimitive.Root>
     );
   }
   ```

6. Attach namespace components and export:
   ```javascript
   Modal.Header = ModalHeader;
   Modal.Title = ModalTitle;
   Modal.Description = ModalDescription;
   Modal.Footer = ModalFooter;
   Modal.Close = ModalClose;

   export default Modal;
   export { Modal, ModalHeader, ModalTitle, ModalDescription, ModalFooter, ModalClose };
   ```

IMPORTANT:
- Remove manual scroll lock logic (Radix handles via Dialog.Content)
- Remove manual ESC key handler (Radix handles via onEscapeKeyDown)
- Remove manual focus management (Radix has built-in focus trap)
- The `size` prop overrides max-width, but mobile always uses full width
- Use forwardRef on all components for composition
  </action>
  <verify>Existing Modal usages still work with new API; check app/components/ui/ConfirmDialog.js and other consumers</verify>
  <done>Modal renders with Radix Dialog, supports 5 sizes, shows bottom sheet on mobile (max-sm), focus trapped inside</done>
</task>

<task type="auto">
  <name>Task 2: Add Modal accessibility and interaction tests</name>
  <files>app/components/ui/__tests__/Modal.test.js</files>
  <action>
Create comprehensive tests for the refactored Modal:

1. Import dependencies:
   ```javascript
   import { render, screen, fireEvent, waitFor } from '@testing-library/react';
   import userEvent from '@testing-library/user-event';
   import { axe } from 'jest-axe';
   import Modal from '../Modal';
   ```

2. Test cases:

   **Rendering tests:**
   - "renders nothing when closed"
   - "renders content when open"
   - "renders with all size variants" (sm, md, lg, xl, full)
   - "renders Modal.Header, Modal.Title, Modal.Footer"

   **Accessibility tests:**
   - "has no accessibility violations when open"
   - "has correct role=dialog"
   - "has aria-modal=true"
   - "Modal.Title provides accessible name"

   **Interaction tests:**
   - "closes on ESC key press"
   - "closes on backdrop click"
   - "does not close on content click"
   - "focuses first focusable element on open" (use waitFor for Radix async focus)
   - "traps focus inside modal" (tab cycles within modal)

   **Mobile behavior tests (CSS class verification):**
   - "applies bottom sheet classes on mobile viewport" (check for max-sm: classes in className)

3. Use proper async patterns:
   - Use `userEvent.setup()` for user interactions
   - Use `waitFor` for focus assertions (Radix focuses asynchronously)
   - Use JSDOM Radix polyfills from jest.setup.js

4. Test helper:
   ```javascript
   const TestModal = ({ isOpen = true, onClose = jest.fn(), size = 'md', children }) => (
     <Modal isOpen={isOpen} onClose={onClose} size={size}>
       <Modal.Header>
         <Modal.Title>Test Modal</Modal.Title>
       </Modal.Header>
       {children || <button>Focus Me</button>}
       <Modal.Footer>
         <button onClick={onClose}>Close</button>
       </Modal.Footer>
     </Modal>
   );
   ```
  </action>
  <verify>npm test -- Modal.test.js --watchAll=false</verify>
  <done>All tests pass including accessibility, ESC close, backdrop click, focus trap</done>
</task>

</tasks>

<verification>
- [ ] `npm test -- Modal.test.js --watchAll=false` passes
- [ ] Modal renders in all 5 sizes (sm, md, lg, xl, full)
- [ ] ESC key closes modal
- [ ] Backdrop click closes modal
- [ ] Focus stays trapped inside modal
- [ ] Existing ConfirmDialog still works
</verification>

<success_criteria>
Modal component uses Radix Dialog primitive with CVA size variants. Focus is automatically trapped. ESC and backdrop click close modal. Mobile shows bottom sheet style. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/14-feedback-layout-components/14-01-SUMMARY.md`
</output>
