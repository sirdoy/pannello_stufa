---
phase: 14-feedback-layout-components
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/Toast.js
  - app/components/ui/ToastProvider.js
  - app/hooks/useToast.js
  - app/components/ui/__tests__/Toast.test.js
  - app/components/ui/index.js
autonomous: true

must_haves:
  truths:
    - "User sees toast notifications in bottom-right corner"
    - "User can dismiss toast manually"
    - "Toasts auto-dismiss after duration (5s default, 8s for errors)"
    - "Max 3 toasts visible at once, others queued"
    - "User can swipe toast to dismiss on touch devices"
  artifacts:
    - path: "app/components/ui/ToastProvider.js"
      provides: "Toast context provider with stacking logic"
      exports: ["ToastProvider"]
    - path: "app/hooks/useToast.js"
      provides: "Hook for imperative toast API"
      exports: ["useToast"]
    - path: "app/components/ui/Toast.js"
      provides: "Toast component with Radix + CVA variants"
      exports: ["default", "Toast", "ToastViewport"]
  key_links:
    - from: "app/hooks/useToast.js"
      to: "app/components/ui/ToastProvider.js"
      via: "React context"
      pattern: "useContext.*ToastContext"
    - from: "app/components/ui/Toast.js"
      to: "@radix-ui/react-toast"
      via: "Radix Toast primitive"
      pattern: "ToastPrimitive"
---

<objective>
Refactor Toast system with Radix Toast primitive, provider pattern, and stacking behavior.

Purpose: Enable proper toast stacking (max 3 visible), swipe dismiss, and imperative toast() API for easy use across the app.
Output: ToastProvider wrapping app, useToast hook for triggering, Toast component with variants.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-feedback-layout-components/14-RESEARCH.md
@app/components/ui/Toast.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToastProvider and useToast hook</name>
  <files>app/components/ui/ToastProvider.js, app/hooks/useToast.js</files>
  <action>
**ToastProvider.js:**

1. Import dependencies:
   ```javascript
   'use client';

   import { createContext, useCallback, useState, useRef } from 'react';
   import * as ToastPrimitive from '@radix-ui/react-toast';
   import Toast, { ToastViewport } from './Toast';
   ```

2. Create context:
   ```javascript
   export const ToastContext = createContext(null);
   ```

3. Create ToastProvider:
   ```javascript
   export function ToastProvider({ children }) {
     const [toasts, setToasts] = useState([]);
     const toastIdRef = useRef(0);

     const toast = useCallback(({ variant = 'info', message, title, duration, action }) => {
       const id = ++toastIdRef.current;

       // Default duration: 5000ms, 8000ms for errors
       const defaultDuration = variant === 'error' ? 8000 : 5000;

       setToasts(prev => [
         ...prev,
         {
           id,
           variant,
           message,
           title,
           duration: duration ?? defaultDuration,
           action,
         },
       ]);

       return id;
     }, []);

     const dismiss = useCallback((id) => {
       setToasts(prev => prev.filter(t => t.id !== id));
     }, []);

     const dismissAll = useCallback(() => {
       setToasts([]);
     }, []);

     // Convenience methods
     const success = useCallback((message, opts = {}) =>
       toast({ variant: 'success', message, ...opts }), [toast]);
     const error = useCallback((message, opts = {}) =>
       toast({ variant: 'error', message, ...opts }), [toast]);
     const warning = useCallback((message, opts = {}) =>
       toast({ variant: 'warning', message, ...opts }), [toast]);
     const info = useCallback((message, opts = {}) =>
       toast({ variant: 'info', message, ...opts }), [toast]);

     // Only show max 3 toasts, slice from end (newest on top)
     const visibleToasts = toasts.slice(-3);

     return (
       <ToastContext.Provider value={{ toast, dismiss, dismissAll, success, error, warning, info }}>
         {children}
         <ToastPrimitive.Provider swipeDirection="right">
           {visibleToasts.map((t) => (
             <Toast
               key={t.id}
               variant={t.variant}
               title={t.title}
               open={true}
               onOpenChange={(open) => !open && dismiss(t.id)}
               duration={t.duration}
               action={t.action}
             >
               {t.message}
             </Toast>
           ))}
           <ToastViewport />
         </ToastPrimitive.Provider>
       </ToastContext.Provider>
     );
   }
   ```

**useToast.js:**

```javascript
'use client';

import { useContext } from 'react';
import { ToastContext } from '@/app/components/ui/ToastProvider';

/**
 * Hook for triggering toast notifications
 *
 * @example
 * const { toast, success, error } = useToast();
 * success('Saved successfully!');
 * error('Something went wrong');
 * toast({ variant: 'info', message: 'Hello', title: 'Info' });
 */
export function useToast() {
  const context = useContext(ToastContext);
  if (!context) {
    throw new Error('useToast must be used within a ToastProvider');
  }
  return context;
}
```

IMPORTANT:
- toasts.slice(-3) shows newest 3, older ones are automatically removed when new arrive
- Radix handles swipe dismiss via swipeDirection="right"
- Each toast auto-dismisses via Radix duration prop
  </action>
  <verify>Files created without syntax errors</verify>
  <done>ToastProvider context with stacking logic, useToast hook with convenience methods</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Toast component with Radix primitive</name>
  <files>app/components/ui/Toast.js</files>
  <action>
Refactor Toast to use Radix Toast primitive:

1. Import dependencies:
   ```javascript
   'use client';

   import * as ToastPrimitive from '@radix-ui/react-toast';
   import { forwardRef } from 'react';
   import { cva } from 'class-variance-authority';
   import { cn } from '@/lib/utils/cn';
   import { X, CheckCircle, AlertCircle, AlertTriangle, Info } from 'lucide-react';
   ```

2. Create CVA variants:
   ```javascript
   const toastVariants = cva(
     [
       'group pointer-events-auto relative flex w-full items-center gap-3',
       'overflow-hidden rounded-2xl p-4 shadow-lg',
       'backdrop-blur-xl',
       'border',
       // Animations
       'data-[state=open]:animate-slide-in-from-right',
       'data-[state=closed]:animate-fade-out',
       'data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)]',
       'data-[swipe=cancel]:translate-x-0 data-[swipe=cancel]:transition-transform',
       'data-[swipe=end]:animate-slide-out-to-right',
     ],
     {
       variants: {
         variant: {
           success: [
             'bg-sage-900/90 [html:not(.dark)_&]:bg-sage-50/95',
             'border-sage-500/30',
             'text-sage-100 [html:not(.dark)_&]:text-sage-800',
           ],
           error: [
             'bg-danger-900/90 [html:not(.dark)_&]:bg-danger-50/95',
             'border-danger-500/30',
             'text-danger-100 [html:not(.dark)_&]:text-danger-800',
           ],
           warning: [
             'bg-warning-900/90 [html:not(.dark)_&]:bg-warning-50/95',
             'border-warning-500/30',
             'text-warning-100 [html:not(.dark)_&]:text-warning-800',
           ],
           info: [
             'bg-ocean-900/90 [html:not(.dark)_&]:bg-ocean-50/95',
             'border-ocean-500/30',
             'text-ocean-100 [html:not(.dark)_&]:text-ocean-800',
           ],
         },
       },
       defaultVariants: { variant: 'info' },
     }
   );
   ```

3. Create icon map:
   ```javascript
   const variantIcons = {
     success: CheckCircle,
     error: AlertCircle,
     warning: AlertTriangle,
     info: Info,
   };
   ```

4. Create Toast component:
   ```javascript
   const Toast = forwardRef(({ className, variant = 'info', title, children, action, ...props }, ref) => {
     const Icon = variantIcons[variant];

     return (
       <ToastPrimitive.Root
         ref={ref}
         className={cn(toastVariants({ variant }), className)}
         {...props}
       >
         {/* Icon */}
         <div className="flex-shrink-0">
           <Icon className="h-5 w-5" />
         </div>

         {/* Content */}
         <div className="flex-1 min-w-0">
           {title && (
             <ToastPrimitive.Title className="text-sm font-semibold">
               {title}
             </ToastPrimitive.Title>
           )}
           <ToastPrimitive.Description className="text-sm opacity-90">
             {children}
           </ToastPrimitive.Description>
         </div>

         {/* Action button */}
         {action && (
           <ToastPrimitive.Action asChild altText={action.label}>
             <button
               onClick={action.onClick}
               className="flex-shrink-0 px-3 py-1.5 rounded-lg text-sm font-medium
                 bg-white/10 hover:bg-white/20 transition-colors
                 [html:not(.dark)_&]:bg-black/5 [html:not(.dark)_&]:hover:bg-black/10"
             >
               {action.label}
             </button>
           </ToastPrimitive.Action>
         )}

         {/* Close button */}
         <ToastPrimitive.Close
           className="flex-shrink-0 p-1.5 rounded-lg
             hover:bg-white/10 transition-colors
             [html:not(.dark)_&]:hover:bg-black/5"
           aria-label="Close"
         >
           <X className="h-4 w-4" />
         </ToastPrimitive.Close>
       </ToastPrimitive.Root>
     );
   });
   Toast.displayName = 'Toast';
   ```

5. Create ToastViewport:
   ```javascript
   function ToastViewport({ className }) {
     return (
       <ToastPrimitive.Viewport
         className={cn(
           'fixed bottom-4 right-4 z-[9999]',
           'flex flex-col-reverse gap-2',
           'w-full max-w-sm',
           'outline-none',
           // Mobile: full width with padding
           'max-sm:bottom-0 max-sm:right-0 max-sm:left-0 max-sm:p-4',
           className
         )}
       />
     );
   }
   ```

6. Export:
   ```javascript
   export default Toast;
   export { Toast, ToastViewport, toastVariants };
   ```

IMPORTANT:
- Use lucide icons instead of emoji for consistency
- flex-col-reverse makes newest toast appear on top
- z-[9999] ensures toasts are above modals
- data-[swipe=*] states handle swipe animations
  </action>
  <verify>Toast renders with Radix structure</verify>
  <done>Toast component with Radix primitive, CVA variants, swipe support</done>
</task>

<task type="auto">
  <name>Task 3: Add Toast tests and update exports</name>
  <files>app/components/ui/__tests__/Toast.test.js, app/components/ui/index.js</files>
  <action>
**Toast.test.js:**

1. Import dependencies:
   ```javascript
   import { render, screen, act, waitFor } from '@testing-library/react';
   import userEvent from '@testing-library/user-event';
   import { axe } from 'jest-axe';
   import { ToastProvider } from '../ToastProvider';
   import { useToast } from '@/app/hooks/useToast';
   ```

2. Test wrapper with consumer component:
   ```javascript
   function TestConsumer({ onMount }) {
     const toast = useToast();
     React.useEffect(() => {
       onMount?.(toast);
     }, [toast, onMount]);
     return null;
   }

   const renderWithProvider = (onMount) =>
     render(
       <ToastProvider>
         <TestConsumer onMount={onMount} />
       </ToastProvider>
     );
   ```

3. Test cases:

   **Rendering tests:**
   - "renders no toasts initially"
   - "renders toast when triggered"
   - "renders with all variant icons"

   **Stacking tests:**
   - "shows max 3 toasts at once"
   - "newest toast appears on top"

   **Interaction tests:**
   - "closes on close button click"
   - "auto-dismisses after duration"

   **Convenience methods:**
   - "success() shows success toast"
   - "error() shows error toast"
   - "warning() shows warning toast"
   - "info() shows info toast"

   **Accessibility tests:**
   - "has no accessibility violations"
   - "toast has proper ARIA attributes"

4. Use act() and waitFor for async updates:
   ```javascript
   let toastApi;
   renderWithProvider((api) => { toastApi = api; });

   act(() => {
     toastApi.success('Test message');
   });

   expect(screen.getByText('Test message')).toBeInTheDocument();
   ```

**index.js update:**
```javascript
export { ToastProvider } from './ToastProvider';
export { default as Toast, ToastViewport } from './Toast';
```
  </action>
  <verify>npm test -- Toast.test.js --watchAll=false</verify>
  <done>Tests pass, ToastProvider and Toast exported</done>
</task>

</tasks>

<verification>
- [ ] `npm test -- Toast.test.js --watchAll=false` passes
- [ ] Toast appears in bottom-right corner
- [ ] Max 3 toasts visible at once
- [ ] Toast auto-dismisses after duration
- [ ] Toast can be manually dismissed
- [ ] Swipe right dismisses on touch
</verification>

<success_criteria>
Toast system uses Radix Toast primitive with provider pattern. Max 3 visible with stacking. useToast hook provides imperative API. Swipe dismiss works on touch devices.
</success_criteria>

<output>
After completion, create `.planning/phases/14-feedback-layout-components/14-03-SUMMARY.md`
</output>
