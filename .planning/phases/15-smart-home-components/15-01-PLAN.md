---
phase: 15-smart-home-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/hooks/useLongPress.js
  - app/hooks/__tests__/useLongPress.test.js
  - app/components/ui/ControlButton.js
  - app/components/ui/__tests__/ControlButton.test.js
autonomous: true

must_haves:
  truths:
    - "User can press and hold ControlButton to continuously increment/decrement"
    - "User feels haptic feedback on mobile devices when pressing controls"
    - "Long-press stops when user lifts finger or moves away"
  artifacts:
    - path: "app/hooks/useLongPress.js"
      provides: "Long-press hook with constant repeat rate"
      exports: ["useLongPress"]
    - path: "app/components/ui/ControlButton.js"
      provides: "CVA-based control button with long-press and haptic"
      exports: ["ControlButton", "controlButtonVariants"]
  key_links:
    - from: "app/components/ui/ControlButton.js"
      to: "app/hooks/useLongPress.js"
      via: "import useLongPress"
      pattern: "useLongPress\\("
    - from: "app/hooks/useLongPress.js"
      to: "lib/pwa/vibration.js"
      via: "vibrateShort for haptic"
      pattern: "vibrateShort"
---

<objective>
Create useLongPress hook and refactor ControlButton with CVA variants, long-press support, and haptic feedback.

Purpose: Enable continuous value adjustment (temperature, brightness) with a single press-and-hold gesture, providing tactile feedback on mobile devices.
Output: useLongPress hook and enhanced ControlButton component with CVA, long-press, and haptic integration.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-smart-home-components/15-CONTEXT.md
@.planning/phases/15-smart-home-components/15-RESEARCH.md
@app/components/ui/ControlButton.js
@lib/pwa/vibration.js
@lib/utils/cn.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLongPress hook with constant repeat rate</name>
  <files>
    app/hooks/useLongPress.js
    app/hooks/__tests__/useLongPress.test.js
  </files>
  <action>
Create `app/hooks/useLongPress.js` with the following behavior:

1. Hook signature: `useLongPress(callback, options)` where options includes:
   - `delay`: Initial delay before repeat starts (default: 400ms)
   - `interval`: Interval between repeats (default: 100ms) - CONSTANT rate, not accelerating
   - `haptic`: Enable haptic feedback (default: true)

2. Return object with event handlers:
   - `onMouseDown`, `onMouseUp`, `onMouseLeave`
   - `onTouchStart`, `onTouchEnd`, `onTouchCancel`

3. Implementation details:
   - Call callback immediately on press start
   - After `delay` ms, start repeating at `interval` ms
   - Call `vibrateShort()` from `@/lib/pwa/vibration` on each callback if haptic enabled
   - Use refs (not state) for timeout/interval IDs to avoid re-renders
   - Use `isActiveRef` to prevent double-start
   - Clear all timers on stop (mouseup, mouseleave, touchend, touchcancel)
   - Prevent default on touch events to avoid scrolling during press

Create `app/hooks/__tests__/useLongPress.test.js` with tests:
- Calls callback immediately on mousedown
- Starts repeating after delay
- Repeats at constant interval (not accelerating)
- Stops on mouseup
- Stops on mouseleave
- Stops on touchend
- Calls vibrate when haptic=true
- Does not call vibrate when haptic=false
- Uses jest.useFakeTimers() for timing tests
  </action>
  <verify>npm test -- --testPathPattern="useLongPress" --passWithNoTests</verify>
  <done>useLongPress hook created with tests passing, supports delay/interval/haptic options</done>
</task>

<task type="auto">
  <name>Task 2: Refactor ControlButton with CVA and long-press integration</name>
  <files>
    app/components/ui/ControlButton.js
    app/components/ui/__tests__/ControlButton.test.js
  </files>
  <action>
Refactor `app/components/ui/ControlButton.js` to use CVA and integrate useLongPress:

1. Add CVA configuration (`controlButtonVariants`):
   - Variants: `ember`, `ocean`, `sage`, `warning`, `danger`, `subtle`
   - Sizes: `sm` (44px min), `md` (48px min), `lg` (56px min) - touch targets
   - Base classes: rounded-xl, font-black, font-display, transition, border, focus-visible ring

2. New props:
   - `onChange(delta)`: Called with +step or -step value (replaces onClick)
   - `step`: Step size for increment/decrement (default: 1)
   - `longPressDelay`: Initial delay (default: 400ms)
   - `longPressInterval`: Repeat interval (default: 100ms)
   - `haptic`: Enable haptic feedback (default: true)

3. Integration:
   - Use `useLongPress` hook with handlePress callback
   - handlePress calls `onChange(type === 'increment' ? step : -step)`
   - Pass longPressDelay, longPressInterval, haptic to hook
   - Only attach handlers if not disabled
   - Add `aria-label` for accessibility: "Incrementa" / "Decrementa"
   - Add `touch-manipulation` and `select-none` classes for mobile

4. Export both `ControlButton` and `controlButtonVariants`

5. Backwards compatibility:
   - If `onClick` prop is provided (legacy), call it instead of onChange
   - Log deprecation warning in dev for onClick usage

Update/create `app/components/ui/__tests__/ControlButton.test.js`:
- Accessibility: no a11y violations (jest-axe)
- Has correct aria-label for increment/decrement
- Calls onChange with positive step for increment
- Calls onChange with negative step for decrement
- Long-press behavior with fake timers
- Disabled state prevents handlers
- Mock navigator.vibrate for haptic tests
  </action>
  <verify>npm test -- --testPathPattern="ControlButton" --passWithNoTests</verify>
  <done>ControlButton uses CVA, exports controlButtonVariants, integrates long-press with haptic feedback, tests pass</done>
</task>

</tasks>

<verification>
1. Run all tests: `npm test -- --testPathPattern="(useLongPress|ControlButton)"`
2. Verify CVA exports: Check that `controlButtonVariants` is exported from ControlButton.js
3. Verify hook exports: Check that `useLongPress` is exported from app/hooks/useLongPress.js
</verification>

<success_criteria>
- useLongPress hook exists with delay/interval/haptic options
- ControlButton uses CVA with controlButtonVariants export
- Long-press triggers continuous callbacks at constant rate
- Haptic feedback via vibrateShort on each callback
- All tests pass including accessibility
- Type "increment" calls onChange with +step, "decrement" with -step
</success_criteria>

<output>
After completion, create `.planning/phases/15-smart-home-components/15-01-SUMMARY.md`
</output>
