---
phase: 15-smart-home-components
plan: 06
type: execute
wave: 2
depends_on: ["15-01", "15-02", "15-03", "15-04"]
files_modified:
  - app/components/ui/DeviceCard.js
  - app/components/ui/__tests__/DeviceCard.test.js
autonomous: true

must_haves:
  truths:
    - "DeviceCard displays device controls with consistent structure"
    - "DeviceCard extends SmartHomeCard with controls area"
    - "DeviceCard maintains backwards compatibility with existing usages"
  artifacts:
    - path: "app/components/ui/DeviceCard.js"
      provides: "Device control card for interactive device management"
      exports: ["DeviceCard"]
  key_links:
    - from: "app/components/ui/DeviceCard.js"
      to: "app/components/ui/SmartHomeCard.js"
      via: "extends SmartHomeCard base"
      pattern: "SmartHomeCard"
    - from: "app/components/ui/DeviceCard.js"
      to: "app/components/ui/Badge.js"
      via: "status badge display"
      pattern: "import Badge"
    - from: "app/components/ui/DeviceCard.js"
      to: "app/components/ui/HealthIndicator.js"
      via: "health status display"
      pattern: "HealthIndicator"
---

<objective>
Refactor DeviceCard to extend SmartHomeCard while maintaining backwards compatibility.

Purpose: Standardize DeviceCard to use the new SmartHomeCard base, integrating Badge, HealthIndicator, and maintaining the existing API for seamless migration.
Output: Refactored DeviceCard.js that uses SmartHomeCard internally while preserving existing props API.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-smart-home-components/15-CONTEXT.md
@.planning/phases/15-smart-home-components/15-RESEARCH.md
@.planning/phases/15-smart-home-components/15-04-SUMMARY.md
@app/components/ui/DeviceCard.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor DeviceCard to use SmartHomeCard base</name>
  <files>
    app/components/ui/DeviceCard.js
  </files>
  <action>
Refactor `app/components/ui/DeviceCard.js` to use SmartHomeCard internally:

1. Keep ALL existing props for backwards compatibility:
   - icon, title, colorTheme, connected, connectionError, onConnect, connectButtonLabel, connectInfoRoute
   - loading, loadingMessage, skeletonComponent, statusBadge
   - banners, children, infoBoxes, infoBoxesTitle, footerActions
   - toast, onToastClose, className

2. Add new props (optional, for new API):
   - `size`: 'compact' | 'default' (default: 'default')
   - `healthStatus`: 'ok' | 'warning' | 'error' | 'critical' (optional)
   - `isLoading`: Alias for loading (new API consistency)
   - `error`: boolean (derived from banners with error variant)
   - `errorMessage`: string (first error banner description)

3. Component structure for connected state:
   ```jsx
   <SmartHomeCard
     icon={icon}
     title={title}
     size={size}
     colorTheme={colorTheme}
     isLoading={loading || isLoading}
     error={error || banners.some(b => b.variant === 'error')}
     errorMessage={errorMessage}
     disabled={!connected}
     className={className}
   >
     {/* Status area with Badge and HealthIndicator */}
     <SmartHomeCard.Status className="flex items-center justify-between mb-6">
       {/* Legacy statusBadge support - convert to new Badge */}
       {statusBadge && (
         <Badge
           variant={statusBadge.color || 'neutral'}
           pulse={statusBadge.color === 'ember' || statusBadge.color === 'sage'}
         >
           {statusBadge.icon && <span className="mr-1">{statusBadge.icon}</span>}
           {statusBadge.label}
         </Badge>
       )}

       {/* New HealthIndicator (if provided) */}
       {healthStatus && (
         <HealthIndicator status={healthStatus} />
       )}
     </SmartHomeCard.Status>

     {/* Banners (legacy support) */}
     {banners.map((banner, index) => (
       <div key={index} className="mb-4">
         <Banner {...banner} />
       </div>
     ))}

     {/* Main content */}
     {children}

     {/* Info boxes section (legacy support) */}
     {infoBoxes.length > 0 && (
       <>
         {infoBoxesTitle && <Divider label={infoBoxesTitle} variant="gradient" spacing="large" />}
         <div className="grid grid-cols-2 gap-2.5 mb-6">
           {infoBoxes.map((box, index) => (
             <InfoBox key={index} {...box} />
           ))}
         </div>
       </>
     )}

     {/* Footer actions (legacy support) */}
     <SmartHomeCard.Controls>
       {footerActions.map((action, index) => (
         <Button key={index} variant={action.variant || 'subtle'} className="w-full" {...action}>
           {action.label}
         </Button>
       ))}
     </SmartHomeCard.Controls>
   </SmartHomeCard>
   ```

4. Keep NOT connected state logic:
   - If !connected && onConnect, render EmptyState with connect button
   - Use SmartHomeCard wrapper for consistency

5. Keep LoadingOverlay and Toast support:
   - LoadingOverlay handled by SmartHomeCard isLoading
   - Toast rendered outside SmartHomeCard

6. Keep skeletonComponent logic:
   - If loading && skeletonComponent, return skeleton directly

Note: This is a REFACTOR, not a rewrite. The component should work exactly as before while using SmartHomeCard internally. All existing DeviceCard usages in the codebase should continue to work.
  </action>
  <verify>npm test -- --testPathPattern="DeviceCard" --passWithNoTests 2>/dev/null || echo "No existing tests or tests pass"</verify>
  <done>DeviceCard refactored to use SmartHomeCard while maintaining full backwards compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Create DeviceCard test suite</name>
  <files>
    app/components/ui/__tests__/DeviceCard.test.js
  </files>
  <action>
Create `app/components/ui/__tests__/DeviceCard.test.js`:

Test categories:

1. Accessibility:
   - No a11y violations (jest-axe)

2. Legacy API (backwards compatibility):
   - Renders icon and title
   - Renders statusBadge with label, color, icon
   - Renders banners array
   - Renders infoBoxes with title
   - Renders footerActions
   - Shows EmptyState when !connected && onConnect
   - Shows skeleton when loading && skeletonComponent
   - Shows LoadingOverlay when loading (no skeleton)

3. New API:
   - Supports size='compact' with smaller padding
   - Supports healthStatus with HealthIndicator
   - Supports isLoading as alias for loading

4. Integration:
   - Uses SmartHomeCard internally (check for CardAccentBar)
   - Uses Badge for statusBadge
   - Applies colorTheme to accent bar

5. State handling:
   - Disabled appearance when !connected
   - Error state from banners
  </action>
  <verify>npm test -- --testPathPattern="DeviceCard" --passWithNoTests</verify>
  <done>DeviceCard test suite created covering legacy and new APIs</done>
</task>

</tasks>

<verification>
1. Run tests: `npm test -- --testPathPattern="DeviceCard"`
2. Manual check: Verify DeviceCard still works in existing pages (stove, thermostat)
3. Verify SmartHomeCard usage: Check imports in DeviceCard.js
</verification>

<success_criteria>
- DeviceCard uses SmartHomeCard internally
- ALL existing props continue to work (backwards compatible)
- New props added: size, healthStatus, isLoading
- statusBadge prop converts to Badge component
- footerActions use SmartHomeCard.Controls
- Not connected state still shows EmptyState
- All tests pass including accessibility
</success_criteria>

<output>
After completion, create `.planning/phases/15-smart-home-components/15-06-SUMMARY.md`
</output>
