---
phase: 17-accessibility-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/hooks/useReducedMotion.js
  - app/hooks/__tests__/useReducedMotion.test.js
  - app/components/ui/Spinner.js
  - app/components/ui/__tests__/Spinner.test.js
  - app/components/ui/Progress.js
  - app/components/ui/__tests__/Progress.test.js
autonomous: true

must_haves:
  truths:
    - "useReducedMotion hook returns true when user prefers reduced motion"
    - "useReducedMotion hook returns false when user has no motion preference"
    - "Spinner respects reduced motion preference"
    - "Progress respects reduced motion preference"
  artifacts:
    - path: "app/hooks/useReducedMotion.js"
      provides: "React hook for motion preference detection"
      exports: ["useReducedMotion"]
    - path: "app/hooks/__tests__/useReducedMotion.test.js"
      provides: "Hook tests including matchMedia mocking"
    - path: "app/components/ui/__tests__/Spinner.test.js"
      provides: "Reduced motion tests for Spinner"
      contains: "Reduced Motion"
    - path: "app/components/ui/__tests__/Progress.test.js"
      provides: "Reduced motion tests for Progress"
      contains: "Reduced Motion"
  key_links:
    - from: "app/hooks/useReducedMotion.js"
      to: "window.matchMedia"
      via: "Media query listener"
      pattern: "matchMedia.*prefers-reduced-motion"
---

<objective>
Create useReducedMotion hook and verify reduced motion behavior in essential animated components (Spinner, Progress).

Purpose: Establish the foundation for respecting user motion preferences across the application. While CSS handles decorative animations via media query, JS-based logic changes require this hook.

Output: Working useReducedMotion hook with tests, plus reduced motion tests for Spinner and Progress components.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-accessibility-testing/17-RESEARCH.md

# Existing hook location pattern
@app/hooks/useToast.js

# Components to add reduced motion tests
@app/components/ui/Spinner.js
@app/components/ui/Progress.js
@app/components/ui/__tests__/Spinner.test.js
@app/components/ui/__tests__/Progress.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useReducedMotion hook</name>
  <files>
    app/hooks/useReducedMotion.js
    app/hooks/__tests__/useReducedMotion.test.js
  </files>
  <action>
Create useReducedMotion hook following the pattern from RESEARCH.md:

```javascript
// app/hooks/useReducedMotion.js
import { useState, useEffect } from 'react';

const QUERY = '(prefers-reduced-motion: no-preference)';

export function useReducedMotion() {
  const [prefersReducedMotion, setPrefersReducedMotion] = useState(() => {
    // SSR-safe: default to reduced motion on server
    if (typeof window === 'undefined') return true;
    return !window.matchMedia(QUERY).matches;
  });

  useEffect(() => {
    const mediaQueryList = window.matchMedia(QUERY);
    const listener = (event) => {
      setPrefersReducedMotion(!event.matches);
    };

    // Support both modern and legacy browsers
    if (mediaQueryList.addEventListener) {
      mediaQueryList.addEventListener('change', listener);
    } else {
      mediaQueryList.addListener(listener);
    }

    return () => {
      if (mediaQueryList.removeEventListener) {
        mediaQueryList.removeEventListener('change', listener);
      } else {
        mediaQueryList.removeListener(listener);
      }
    };
  }, []);

  return prefersReducedMotion;
}
```

Create test file with matchMedia mocking:

```javascript
// app/hooks/__tests__/useReducedMotion.test.js
import { renderHook, act } from '@testing-library/react';
import { useReducedMotion } from '../useReducedMotion';

const mockMatchMedia = (matches) => {
  const listeners = [];
  window.matchMedia = jest.fn().mockImplementation((query) => ({
    matches,
    media: query,
    addEventListener: jest.fn((event, listener) => {
      listeners.push(listener);
    }),
    removeEventListener: jest.fn(),
    addListener: jest.fn((listener) => listeners.push(listener)),
    removeListener: jest.fn(),
    dispatchChange: (newMatches) => {
      listeners.forEach(l => l({ matches: newMatches }));
    }
  }));
  return listeners;
};

describe('useReducedMotion', () => {
  afterEach(() => {
    jest.restoreAllMocks();
  });

  test('returns false when user has no motion preference', () => {
    mockMatchMedia(true); // no-preference matches = motion allowed
    const { result } = renderHook(() => useReducedMotion());
    expect(result.current).toBe(false);
  });

  test('returns true when user prefers reduced motion', () => {
    mockMatchMedia(false); // no-preference doesn't match = reduced motion
    const { result } = renderHook(() => useReducedMotion());
    expect(result.current).toBe(true);
  });

  test('updates when preference changes', () => {
    const listeners = mockMatchMedia(true);
    const { result } = renderHook(() => useReducedMotion());
    expect(result.current).toBe(false);

    act(() => {
      listeners[0]({ matches: false });
    });
    expect(result.current).toBe(true);
  });

  test('defaults to reduced motion on server (SSR)', () => {
    const originalWindow = global.window;
    delete global.window;

    // Note: renderHook requires window, so we test the initial value logic
    const QUERY = '(prefers-reduced-motion: no-preference)';
    const getInitialValue = () => {
      if (typeof window === 'undefined') return true;
      return !window.matchMedia(QUERY).matches;
    };
    expect(getInitialValue()).toBe(true);

    global.window = originalWindow;
  });
});
```

Export from hooks index if one exists, otherwise hook is imported directly.
  </action>
  <verify>
npm test -- app/hooks/__tests__/useReducedMotion.test.js --watchAll=false
  </verify>
  <done>Hook returns correct boolean based on user preference, updates on change, and SSR-safe defaults</done>
</task>

<task type="auto">
  <name>Task 2: Add reduced motion tests to Spinner and Progress</name>
  <files>
    app/components/ui/__tests__/Spinner.test.js
    app/components/ui/__tests__/Progress.test.js
  </files>
  <action>
Add reduced motion test section to Spinner.test.js:

```javascript
describe('Reduced Motion', () => {
  test('has animate-spin class for animation', () => {
    const { container } = render(<Spinner />);
    expect(container.querySelector('svg')).toHaveClass('animate-spin');
  });

  test('CSS media query handles reduced motion (documented behavior)', () => {
    // Animation behavior in reduced motion is handled by globals.css:
    // @media (prefers-reduced-motion: reduce) {
    //   animation-duration: 0.01ms !important;
    // }
    // JSDOM cannot test CSS media query effects, but we document expected behavior
    const { container } = render(<Spinner />);
    // Animation class is always present; CSS reduces duration when preference set
    expect(container.querySelector('svg')).toHaveClass('animate-spin');
  });

  test('Spinner remains visible in reduced motion (essential feedback)', () => {
    // Per CONTEXT.md: essential animations remain visible but non-animated
    // Spinner provides essential loading feedback - must remain visible
    const { container } = render(<Spinner />);
    expect(container.querySelector('svg')).toBeInTheDocument();
  });
});
```

Add reduced motion test section to Progress.test.js:

```javascript
describe('Reduced Motion', () => {
  test('indeterminate state has animation class', () => {
    const { container } = render(<Progress />);
    const indicator = container.querySelector('[class*="animate-progress-indeterminate"]');
    expect(indicator).toBeInTheDocument();
  });

  test('determinate state has no animation class', () => {
    const { container } = render(<Progress value={50} />);
    const indicator = container.querySelector('[data-value]');
    expect(indicator).not.toHaveClass('animate-progress-indeterminate');
  });

  test('CSS media query handles reduced motion (documented behavior)', () => {
    // Animation behavior in reduced motion handled by globals.css
    // Progress indeterminate animation reduced to 0.01ms duration
    const { container } = render(<Progress />);
    // Class present; CSS handles reduced motion
    expect(container.querySelector('[class*="animate-progress-indeterminate"]')).toBeInTheDocument();
  });

  test('Progress indicator remains visible in reduced motion', () => {
    // Progress provides essential feedback - must remain visible
    const { container } = render(<Progress value={75} />);
    expect(container.querySelector('[data-value]')).toBeInTheDocument();
  });
});
```

These tests document expected reduced motion behavior. Since CSS media queries handle the actual animation reduction and JSDOM cannot test computed styles, we verify:
1. Animation classes are present (CSS will reduce them)
2. Components remain visible (essential feedback preserved)
  </action>
  <verify>
npm test -- app/components/ui/__tests__/Spinner.test.js app/components/ui/__tests__/Progress.test.js --watchAll=false
  </verify>
  <done>Spinner and Progress have reduced motion test sections documenting CSS-based behavior</done>
</task>

</tasks>

<verification>
1. `npm test -- app/hooks/__tests__/useReducedMotion.test.js --watchAll=false` - All hook tests pass
2. `npm test -- app/components/ui/__tests__/Spinner.test.js --watchAll=false` - Spinner tests including reduced motion pass
3. `npm test -- app/components/ui/__tests__/Progress.test.js --watchAll=false` - Progress tests including reduced motion pass
</verification>

<success_criteria>
- useReducedMotion hook created with SSR-safe implementation
- Hook returns false when motion allowed, true when reduced motion preferred
- Hook updates when user preference changes
- Spinner and Progress have documented reduced motion test sections
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-testing/17-01-SUMMARY.md`
</output>
