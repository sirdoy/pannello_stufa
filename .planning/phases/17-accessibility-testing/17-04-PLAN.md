---
phase: 17-accessibility-testing
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/__tests__/Modal.test.js
  - app/components/ui/__tests__/Tooltip.test.js
  - app/components/ui/__tests__/Toast.test.js
  - app/components/ui/__tests__/Banner.test.js
  - app/components/ui/__tests__/EmptyState.test.js
autonomous: true

must_haves:
  truths:
    - "Modal closes via Escape key"
    - "Modal traps focus within dialog"
    - "Tooltip shows on focus and hides on blur"
    - "Toast has role=status for screen reader announcements"
    - "Banner has proper ARIA for dismissible feedback"
    - "EmptyState icon is marked aria-hidden"
  artifacts:
    - path: "app/components/ui/__tests__/Modal.test.js"
      provides: "Focus trap and Escape key tests"
      contains: "Focus Trap"
    - path: "app/components/ui/__tests__/Tooltip.test.js"
      provides: "Focus trigger tests"
      contains: "Keyboard Navigation"
    - path: "app/components/ui/__tests__/Toast.test.js"
      provides: "ARIA role tests"
      contains: "role.*status"
    - path: "app/components/ui/__tests__/Banner.test.js"
      provides: "ARIA and dismissible tests"
      contains: "Accessibility"
    - path: "app/components/ui/__tests__/EmptyState.test.js"
      provides: "Icon aria-hidden test"
      contains: "aria-hidden"
  key_links:
    - from: "Modal.test.js"
      to: "userEvent.keyboard"
      via: "Escape close"
      pattern: "Escape"
    - from: "Tooltip.test.js"
      to: "userEvent.tab"
      via: "Focus trigger"
      pattern: "userEvent\\.tab"
---

<objective>
Add comprehensive accessibility tests to feedback components: Modal, Tooltip, Toast, Banner, and EmptyState.

Purpose: Ensure feedback components meet accessibility requirements including keyboard dismissal (A11Y-01), proper ARIA roles (A11Y-03, A11Y-07), and screen reader support for dynamic content.

Output: Accessibility test suites added to existing test files for 5 feedback components.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-accessibility-testing/17-RESEARCH.md

# Existing test files to update
@app/components/ui/__tests__/Modal.test.js
@app/components/ui/__tests__/Tooltip.test.js
@app/components/ui/__tests__/Toast.test.js
@app/components/ui/__tests__/Banner.test.js
@app/components/ui/__tests__/EmptyState.test.js

# Components being tested
@app/components/ui/Modal.js
@app/components/ui/Tooltip.js
@app/components/ui/Toast.js
@app/components/ui/Banner.js
@app/components/ui/EmptyState.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accessibility tests to Modal and Tooltip</name>
  <files>
    app/components/ui/__tests__/Modal.test.js
    app/components/ui/__tests__/Tooltip.test.js
  </files>
  <action>
**Modal.test.js** - Add/enhance keyboard and focus trap tests:

```javascript
describe('Keyboard Navigation', () => {
  test('closes via Escape key', async () => {
    const handleClose = jest.fn();
    render(
      <Modal open onOpenChange={handleClose}>
        <Modal.Content>
          <Modal.Header>
            <Modal.Title>Test</Modal.Title>
          </Modal.Header>
          <Modal.Body>Content</Modal.Body>
        </Modal.Content>
      </Modal>
    );
    await userEvent.keyboard('{Escape}');
    expect(handleClose).toHaveBeenCalledWith(false);
  });

  test('close button can be activated via Enter', async () => {
    const handleClose = jest.fn();
    render(
      <Modal open onOpenChange={handleClose}>
        <Modal.Content>
          <Modal.Header>
            <Modal.Title>Test</Modal.Title>
            <Modal.Close />
          </Modal.Header>
          <Modal.Body>Content</Modal.Body>
        </Modal.Content>
      </Modal>
    );
    const closeButton = screen.getByRole('button', { name: /close/i });
    closeButton.focus();
    await userEvent.keyboard('{Enter}');
    expect(handleClose).toHaveBeenCalledWith(false);
  });
});

describe('Focus Trap', () => {
  test('traps focus within modal when open', async () => {
    render(
      <Modal open onOpenChange={() => {}}>
        <Modal.Content>
          <Modal.Header>
            <Modal.Title>Test</Modal.Title>
            <Modal.Close />
          </Modal.Header>
          <Modal.Body>
            <button data-testid="first">First</button>
            <button data-testid="second">Second</button>
          </Modal.Body>
        </Modal.Content>
      </Modal>
    );

    // Focus should start within modal
    await userEvent.tab();
    // Tab should cycle within modal, not escape
    const first = screen.getByTestId('first');
    const second = screen.getByTestId('second');
    const closeBtn = screen.getByRole('button', { name: /close/i });

    // Verify focus stays within modal (order may vary based on Radix implementation)
    const focusedElement = document.activeElement;
    const isInModal = first === focusedElement ||
                      second === focusedElement ||
                      closeBtn === focusedElement;
    expect(isInModal).toBe(true);
  });

  test('returns focus to trigger on close', async () => {
    const TestComponent = () => {
      const [open, setOpen] = React.useState(false);
      return (
        <>
          <button data-testid="trigger" onClick={() => setOpen(true)}>Open</button>
          <Modal open={open} onOpenChange={setOpen}>
            <Modal.Content>
              <Modal.Header>
                <Modal.Title>Test</Modal.Title>
                <Modal.Close />
              </Modal.Header>
              <Modal.Body>Content</Modal.Body>
            </Modal.Content>
          </Modal>
        </>
      );
    };
    render(<TestComponent />);

    const trigger = screen.getByTestId('trigger');
    trigger.focus();
    await userEvent.click(trigger);

    // Modal opens, close it
    await userEvent.keyboard('{Escape}');

    // Focus should return to trigger
    expect(trigger).toHaveFocus();
  });
});
```

Note: Add `import React from 'react'` if needed for the TestComponent.

**Tooltip.test.js** - Add keyboard trigger tests:

```javascript
describe('Keyboard Navigation', () => {
  test('shows on focus', async () => {
    render(
      <Tooltip.Provider>
        <Tooltip>
          <Tooltip.Trigger asChild>
            <button>Hover me</button>
          </Tooltip.Trigger>
          <Tooltip.Content>Tooltip content</Tooltip.Content>
        </Tooltip>
      </Tooltip.Provider>
    );

    await userEvent.tab();
    expect(screen.getByRole('button')).toHaveFocus();

    // Wait for tooltip delay
    await new Promise(resolve => setTimeout(resolve, 500));

    // Tooltip should be visible
    expect(screen.getByRole('tooltip')).toBeInTheDocument();
  });

  test('hides on blur', async () => {
    render(
      <Tooltip.Provider>
        <Tooltip>
          <Tooltip.Trigger asChild>
            <button>Hover me</button>
          </Tooltip.Trigger>
          <Tooltip.Content>Tooltip content</Tooltip.Content>
        </Tooltip>
        <button>Other button</button>
      </Tooltip.Provider>
    );

    await userEvent.tab();
    await new Promise(resolve => setTimeout(resolve, 500));
    expect(screen.getByRole('tooltip')).toBeInTheDocument();

    // Tab away
    await userEvent.tab();

    // Tooltip should hide (may need to wait for animation)
    await new Promise(resolve => setTimeout(resolve, 400));
    expect(screen.queryByRole('tooltip')).not.toBeInTheDocument();
  });

  test('trigger is focusable via keyboard', async () => {
    render(
      <Tooltip.Provider>
        <Tooltip>
          <Tooltip.Trigger asChild>
            <button data-testid="tooltip-trigger">Hover me</button>
          </Tooltip.Trigger>
          <Tooltip.Content>Tooltip content</Tooltip.Content>
        </Tooltip>
      </Tooltip.Provider>
    );

    await userEvent.tab();
    expect(screen.getByTestId('tooltip-trigger')).toHaveFocus();
  });
});
```

Note: Check existing Tooltip.test.js for the exact component API and wrapper requirements.
  </action>
  <verify>
npm test -- app/components/ui/__tests__/Modal.test.js app/components/ui/__tests__/Tooltip.test.js --watchAll=false
  </verify>
  <done>Modal has Escape close and focus trap tests, Tooltip has focus trigger tests</done>
</task>

<task type="auto">
  <name>Task 2: Add accessibility tests to Toast, Banner, and EmptyState</name>
  <files>
    app/components/ui/__tests__/Toast.test.js
    app/components/ui/__tests__/Banner.test.js
    app/components/ui/__tests__/EmptyState.test.js
  </files>
  <action>
**Toast.test.js** - Add ARIA and keyboard tests:

```javascript
describe('Accessibility', () => {
  test('toast has role="status" for screen reader announcements', () => {
    render(
      <ToastProvider>
        <Toast open>
          <Toast.Title>Success</Toast.Title>
          <Toast.Description>Action completed</Toast.Description>
        </Toast>
        <Toast.Viewport />
      </ToastProvider>
    );

    // Radix Toast uses role="status" by default
    const toast = screen.getByRole('status');
    expect(toast).toBeInTheDocument();
  });

  test('toast has aria-live="polite" for non-interrupting announcements', () => {
    render(
      <ToastProvider>
        <Toast open>
          <Toast.Title>Info</Toast.Title>
        </Toast>
        <Toast.Viewport />
      </ToastProvider>
    );

    const toast = screen.getByRole('status');
    expect(toast).toHaveAttribute('aria-live', 'polite');
  });

  test('close button is keyboard accessible', async () => {
    const handleClose = jest.fn();
    render(
      <ToastProvider>
        <Toast open onOpenChange={handleClose}>
          <Toast.Title>Test</Toast.Title>
          <Toast.Close />
        </Toast>
        <Toast.Viewport />
      </ToastProvider>
    );

    const closeButton = screen.getByRole('button');
    closeButton.focus();
    await userEvent.keyboard('{Enter}');
    // Close button should trigger close (check Radix behavior)
    expect(handleClose).toHaveBeenCalled();
  });
});
```

Note: Check existing Toast.test.js for ToastProvider/Toast API and adjust accordingly.

**Banner.test.js** - Add/enhance accessibility tests:

```javascript
describe('Accessibility', () => {
  test('has role="alert" for important messages', () => {
    render(<Banner variant="error">Error message</Banner>);
    // Banner should have alert role for errors
    const banner = screen.getByRole('alert');
    expect(banner).toBeInTheDocument();
  });

  test('has role="status" for info messages', () => {
    render(<Banner variant="info">Info message</Banner>);
    // Info banners use status role
    const banner = screen.getByRole('status');
    expect(banner).toBeInTheDocument();
  });

  test('dismissible banner close button has accessible label', () => {
    render(<Banner variant="info" dismissible>Dismissible</Banner>);
    const closeButton = screen.getByRole('button');
    expect(closeButton).toHaveAttribute('aria-label');
  });

  test('dismissible banner can be closed via Enter key', async () => {
    const handleDismiss = jest.fn();
    render(<Banner variant="info" dismissible onDismiss={handleDismiss}>Dismissible</Banner>);
    const closeButton = screen.getByRole('button');
    closeButton.focus();
    await userEvent.keyboard('{Enter}');
    expect(handleDismiss).toHaveBeenCalled();
  });

  test('icon has aria-hidden for decorative purposes', () => {
    render(<Banner variant="success">Success</Banner>);
    const icon = document.querySelector('svg');
    if (icon) {
      expect(icon).toHaveAttribute('aria-hidden', 'true');
    }
  });
});
```

Note: Check existing Banner.test.js for exact props (onDismiss vs onClose, etc.).

**EmptyState.test.js** - Add accessibility tests:

```javascript
describe('Accessibility', () => {
  test('icon is marked aria-hidden for decorative purposes', () => {
    const { container } = render(
      <EmptyState
        title="No items"
        description="Add your first item"
        icon={<svg data-testid="icon" />}
      />
    );

    const icon = screen.getByTestId('icon').closest('[aria-hidden="true"]') ||
                 screen.getByTestId('icon');
    // Icon wrapper or icon itself should have aria-hidden
    expect(container.querySelector('[aria-hidden="true"]')).toBeInTheDocument();
  });

  test('action button is keyboard accessible', async () => {
    const handleAction = jest.fn();
    render(
      <EmptyState
        title="No items"
        description="Add your first item"
        action={<button onClick={handleAction}>Add Item</button>}
      />
    );

    await userEvent.tab();
    expect(screen.getByRole('button')).toHaveFocus();
    await userEvent.keyboard('{Enter}');
    expect(handleAction).toHaveBeenCalled();
  });

  test('no accessibility violations in default state', async () => {
    const { container } = render(
      <EmptyState
        title="No items"
        description="Add your first item"
      />
    );
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  test('no accessibility violations with all props', async () => {
    const { container } = render(
      <EmptyState
        title="No items"
        description="Add your first item"
        icon={<svg aria-hidden="true" />}
        action={<button>Add Item</button>}
      />
    );
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});
```

Note: Check existing EmptyState.test.js for exact API (icon prop shape, action prop, etc.).
  </action>
  <verify>
npm test -- app/components/ui/__tests__/Toast.test.js app/components/ui/__tests__/Banner.test.js app/components/ui/__tests__/EmptyState.test.js --watchAll=false
  </verify>
  <done>Toast has ARIA role tests, Banner has alert/status role and dismiss tests, EmptyState has aria-hidden tests</done>
</task>

</tasks>

<verification>
1. `npm test -- app/components/ui/__tests__/Modal.test.js --watchAll=false` - All tests pass
2. `npm test -- app/components/ui/__tests__/Tooltip.test.js --watchAll=false` - All tests pass
3. `npm test -- app/components/ui/__tests__/Toast.test.js --watchAll=false` - All tests pass
4. `npm test -- app/components/ui/__tests__/Banner.test.js --watchAll=false` - All tests pass
5. `npm test -- app/components/ui/__tests__/EmptyState.test.js --watchAll=false` - All tests pass
</verification>

<success_criteria>
- Modal has Escape close and focus trap tests
- Tooltip shows on focus and hides on blur
- Toast has role="status" and aria-live tests
- Banner has alert/status role based on variant and dismissible keyboard tests
- EmptyState has aria-hidden icon tests
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-testing/17-04-SUMMARY.md`
</output>
