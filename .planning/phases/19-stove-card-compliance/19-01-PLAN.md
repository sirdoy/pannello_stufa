---
phase: 19-stove-card-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/stove/StoveCard.js
autonomous: true

must_haves:
  truths:
    - "User sees scheduler mode buttons (Manuale/Automatico/Semi) rendered using Button.Group with proper variants"
    - "User sees 'Torna in Automatico' rendered using Button component with ember variant"
    - "User sees 'Configura Pianificazione' rendered using Button component with consistent styling"
    - "Active mode button shows ember variant, inactive buttons show subtle variant"
    - "Mode action buttons have proper focus states and accessibility attributes"
  artifacts:
    - path: "app/components/devices/stove/StoveCard.js"
      provides: "Button.Group for mode selection, Button component for action buttons"
      contains: "<Button.Group"
  key_links:
    - from: "StoveCard.js"
      to: "Button component"
      via: "import Button from '../../ui/Button'"
      pattern: "import.*Button.*from.*ui/Button"
    - from: "StoveCard.js"
      to: "Button.Group component"
      via: "Button.Group usage"
      pattern: "<Button\\.Group"
    - from: "StoveCard.js mode handlers"
      to: "/api/scheduler/update"
      via: "fetch with operation: setSchedulerMode"
      pattern: "operation.*setSchedulerMode"
---

<objective>
Migrate raw HTML button elements and mode display in StoveCard to design system Button and Button.Group components.

Purpose: Replace raw `<button>` elements with Button component and add Button.Group for scheduler mode buttons (Manuale/Automatico/Semi) for consistent styling, accessibility (focus ring, disabled states), and design system compliance per STOVE-01 and STOVE-02 requirements.

Output: StoveCard with Button.Group for mode selection (with aria-pressed on active), Button component for "Torna in Automatico" (ember variant) and "Configura Pianificazione" (subtle variant) actions.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-stove-card-compliance/19-CONTEXT.md
@.planning/phases/19-stove-card-compliance/19-RESEARCH.md
@app/components/devices/stove/StoveCard.js
@app/components/ui/Button.js
@app/api/scheduler/update/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Button.Group for scheduler mode selection</name>
  <files>app/components/devices/stove/StoveCard.js</files>
  <action>
In StoveCard.js, locate the mode indicator section (around lines 1005-1020) that currently displays mode as text:

```jsx
<Text weight="bold" className={`...`}>
  {schedulerEnabled && semiManualMode ? 'Semi-manuale' : schedulerEnabled ? 'Automatica' : 'Manuale'}
</Text>
```

Replace this text display with an interactive Button.Group for mode selection:

1. **Add mode switching handlers** at line 558 (after handleClearSemiManual function ends):

   **IMPORTANT:** The `/api/scheduler/mode` endpoint does NOT exist. Mode changes go through the existing `/api/scheduler/update` endpoint with specific operations.

   ```jsx
   const handleSetManualMode = async () => {
     // Use existing API: operation setSchedulerMode with enabled: false
     await fetch('/api/scheduler/update', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         operation: 'setSchedulerMode',
         data: { enabled: false }
       })
     });
     setSchedulerEnabled(false);
     setSemiManualMode(false);
   };

   const handleSetAutomaticMode = async () => {
     // Use existing API: operation clearSemiManualMode then setSchedulerMode
     await fetch('/api/scheduler/update', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         operation: 'setSchedulerMode',
         data: { enabled: true }
       })
     });
     // Clear semi-manual if active
     if (semiManualMode) {
       await fetch('/api/scheduler/update', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({
           operation: 'clearSemiManualMode',
           data: {}
         })
       });
     }
     setSchedulerEnabled(true);
     setSemiManualMode(false);
     const nextAction = await getNextScheduledAction();
     setNextScheduledAction(nextAction);
   };
   ```

2. **Replace mode text with Button.Group** (around line 1014):
   ```jsx
   <Button.Group className="w-full sm:w-auto">
     <Button
       variant={!schedulerEnabled ? 'ember' : 'subtle'}
       size="sm"
       onClick={handleSetManualMode}
       aria-pressed={!schedulerEnabled}
       className="flex-1 sm:flex-none"
     >
       Manuale
     </Button>
     <Button
       variant={schedulerEnabled && !semiManualMode ? 'ember' : 'subtle'}
       size="sm"
       onClick={handleSetAutomaticMode}
       aria-pressed={schedulerEnabled && !semiManualMode}
       className="flex-1 sm:flex-none"
     >
       Automatica
     </Button>
     <Button
       variant={schedulerEnabled && semiManualMode ? 'ember' : 'subtle'}
       size="sm"
       disabled
       aria-pressed={schedulerEnabled && semiManualMode}
       className="flex-1 sm:flex-none cursor-not-allowed"
     >
       Semi-man.
     </Button>
   </Button.Group>
   ```

Per CONTEXT.md decisions:
- Active mode uses `ember` variant (visual highlight)
- Inactive modes use `subtle` variant
- `aria-pressed="true"` on active button for accessibility
- Semi-manuale is disabled (can't be selected directly - only triggered by manual overrides)
- Text only on buttons - no icons

**Existing API verification:** The `/api/scheduler/update` endpoint exists at `app/api/scheduler/update/route.js` and supports operations: `setSchedulerMode` (with `data: { enabled: boolean }`), `setSemiManualMode`, `clearSemiManualMode`.

**DO NOT modify:**
- Primary action buttons (ACCENDI/SPEGNI) - already use Button component
- ControlButton usage for fan/power controls
- Any other UI elements
  </action>
  <verify>
1. Run `npm test -- --testPathPattern=StoveCard --passWithNoTests` to verify no regressions
2. Grep to confirm Button.Group usage:
   `grep -n "Button.Group" app/components/devices/stove/StoveCard.js` should show Button.Group
3. Grep to confirm aria-pressed:
   `grep -n "aria-pressed" app/components/devices/stove/StoveCard.js` should show multiple results
4. Grep to confirm correct API usage:
   `grep -n "operation.*setSchedulerMode" app/components/devices/stove/StoveCard.js` should show the operation
  </verify>
  <done>
- Button.Group displays three mode buttons: Manuale, Automatica, Semi-man.
- Active mode shows ember variant, inactive show subtle
- aria-pressed attribute correctly set on active mode button
- Semi-manuale button is disabled (read-only indicator)
- Mode handlers use existing /api/scheduler/update endpoint with setSchedulerMode and clearSemiManualMode operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace raw action buttons with Button component</name>
  <files>app/components/devices/stove/StoveCard.js</files>
  <action>
In StoveCard.js, locate the action buttons section (around lines 1050-1066) containing two raw `<button>` elements:

1. **"Torna in Automatico" button** (lines 1052-1057):
   Current: raw `<button>` with inline Tailwind classes (warning color scheme)
   Replace with:
   ```jsx
   <Button
     variant="ember"
     size="sm"
     onClick={handleClearSemiManual}
     aria-label="Torna alla modalita automatica"
   >
     Torna in Automatico
   </Button>
   ```
   Per CONTEXT.md decision: uses `ember` variant (primary action)
   Remove the arrow emoji prefix - Button styling makes it clear it's an action

2. **"Configura Pianificazione" button** (lines 1059-1064):
   Current: raw `<button>` with inline Tailwind classes (ocean color scheme)
   Replace with:
   ```jsx
   <Button
     variant="subtle"
     size="sm"
     onClick={() => router.push('/stove/scheduler')}
     aria-label="Vai alle impostazioni di pianificazione"
   >
     Configura Pianificazione
   </Button>
   ```
   Use `subtle` variant (secondary action, less prominent than ember)

3. **Verify Button import exists** - Button is already imported at line 17:
   `import Button from '../../ui/Button';`

4. **Container styling** - Keep the existing flex container `<div className="flex flex-col sm:flex-row gap-2 sm:gap-3">` unchanged.
  </action>
  <verify>
1. Grep to confirm no raw button elements remain in action section:
   `grep -n "<button" app/components/devices/stove/StoveCard.js` should return 0 results
2. Grep to confirm Button usage with aria-label:
   `grep -n 'aria-label="Torna' app/components/devices/stove/StoveCard.js` should show the button
3. Dev server check: `npm run dev` should start without errors
  </verify>
  <done>
- "Torna in Automatico" uses Button with variant="ember" and aria-label
- "Configura Pianificazione" uses Button with variant="subtle" and aria-label
- No raw `<button>` elements remain in StoveCard.js
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `npm test` - All existing tests pass
2. Visual check in dev server:
   - Mode indicator shows Button.Group with 3 mode buttons
   - Active mode highlighted with ember variant
   - Action buttons below styled consistently
3. Keyboard navigation: Tab to buttons shows ember glow focus ring
4. No raw `<button>` elements in StoveCard.js (grep confirms)
5. aria-pressed on mode buttons, aria-label on action buttons
</verification>

<success_criteria>
- Button.Group displays Manuale/Automatica/Semi-man. mode buttons
- Active mode uses ember variant, inactive use subtle
- aria-pressed correctly indicates current mode
- Zero raw `<button>` elements in StoveCard.js
- "Torna in Automatico" uses Button variant="ember"
- "Configura Pianificazione" uses Button variant="subtle"
- All buttons have proper accessibility attributes
- All existing tests pass
- Visual styling matches design system (ember glow focus, proper hover states)
</success_criteria>

<output>
After completion, create `.planning/phases/19-stove-card-compliance/19-01-SUMMARY.md`
</output>
