---
phase: 19-stove-card-compliance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/stove/StoveCard.js
autonomous: true

must_haves:
  truths:
    - "Stove status display uses CVA variants from Badge component instead of inline Tailwind classes"
    - "User sees HealthIndicator showing ok/warning/error based on stove operational state"
    - "Status colors are consistent with design system (ember for WORK, ocean for START, warning for STANDBY, danger for ERROR)"
  artifacts:
    - path: "app/components/devices/stove/StoveCard.js"
      provides: "CVA-based status styling with Badge and HealthIndicator"
      contains: "getStatusDisplay"
  key_links:
    - from: "StoveCard.js"
      to: "Badge component"
      via: "import Badge"
      pattern: "import.*Badge.*from.*ui"
    - from: "StoveCard.js"
      to: "HealthIndicator component"
      via: "import HealthIndicator"
      pattern: "import.*HealthIndicator.*from.*ui"
---

<objective>
Refactor StoveCard status display to use CVA variants from design system components instead of inline Tailwind classes.

Purpose: Replace the 150+ line `getStatusInfo()` function with a CVA-based approach using Badge variants (ember, sage, ocean, warning, danger, neutral) and HealthIndicator. This achieves STOVE-03 and STOVE-04 requirements for consistent status styling.

Output: StoveCard with simplified status helper returning variant names, Badge for status display, and HealthIndicator for health visualization.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-stove-card-compliance/19-CONTEXT.md
@.planning/phases/19-stove-card-compliance/19-RESEARCH.md
@app/components/devices/stove/StoveCard.js
@app/components/ui/Badge.js
@app/components/ui/HealthIndicator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CVA-based status helper function</name>
  <files>app/components/devices/stove/StoveCard.js</files>
  <action>
Create a new `getStatusDisplay()` function that returns CVA variant names instead of inline Tailwind classes. This complements (does not replace) the existing `getStatusInfo()` function (lines 572-728).

1. **Add imports** at top of file (after existing imports around line 27):
   ```jsx
   import { Badge, HealthIndicator } from '../../ui';
   ```
   Note: These are already exported from the barrel file.

2. **Create simplified status helper at line 729** (immediately after getStatusInfo's closing brace `};` on line 728):
   ```jsx
   /**
    * Get status display properties using CVA variants
    * Returns variant names for Badge and health status for HealthIndicator
    */
   const getStatusDisplay = (status) => {
     if (!status) {
       return {
         label: 'CARICAMENTO...',
         icon: '',
         variant: 'neutral',
         pulse: true,
         health: 'ok',
         animated: true
       };
     }

     const s = status.toUpperCase();

     // WORK - In funzione (Ember)
     if (s.includes('WORK')) {
       return {
         label: 'IN FUNZIONE',
         icon: '',
         variant: 'ember',
         pulse: true,
         health: 'ok',
         animated: true
       };
     }

     // OFF - Spenta (Neutral)
     if (s.includes('OFF')) {
       return {
         label: 'SPENTA',
         icon: '',
         variant: 'neutral',
         pulse: false,
         health: 'ok',
         animated: false
       };
     }

     // START - Avvio in corso (Ocean)
     if (s.includes('START')) {
       return {
         label: 'AVVIO IN CORSO',
         icon: '',
         variant: 'ocean',
         pulse: true,
         health: 'ok',
         animated: true
       };
     }

     // STANDBY/WAIT - In attesa (Warning)
     if (s.includes('STANDBY') || s.includes('WAIT')) {
       return {
         label: 'IN ATTESA',
         icon: '',
         variant: 'warning',
         pulse: true,
         health: 'warning',
         animated: true
       };
     }

     // ERROR/ALARM - Errore (Danger)
     if (s.includes('ERROR') || s.includes('ALARM')) {
       return {
         label: 'ERRORE',
         icon: '',
         variant: 'danger',
         pulse: true,
         health: 'error',
         animated: true
       };
     }

     // CLEAN - Pulizia (Sage)
     if (s.includes('CLEAN')) {
       return {
         label: 'PULIZIA',
         icon: '',
         variant: 'sage',
         pulse: true,
         health: 'ok',
         animated: true
       };
     }

     // MODULATION - Modulazione (Ocean)
     if (s.includes('MODULATION')) {
       return {
         label: 'MODULAZIONE',
         icon: '',
         variant: 'ocean',
         pulse: true,
         health: 'ok',
         animated: true
       };
     }

     // Default - Stato sconosciuto
     return {
       label: status.toUpperCase(),
       icon: '',
       variant: 'neutral',
       pulse: false,
       health: 'ok',
       animated: false
     };
   };
   ```

3. **Keep `getStatusInfo()` unchanged** - The new `getStatusDisplay()` is used for Badge/HealthIndicator, while existing `getStatusInfo()` continues to provide elaborate styling for the main status box.
  </action>
  <verify>
1. `grep -n "getStatusDisplay" app/components/devices/stove/StoveCard.js` shows function definition
2. `grep -n "import.*Badge.*HealthIndicator" app/components/devices/stove/StoveCard.js` confirms import
3. `npm run dev` starts without errors
  </verify>
  <done>
- `getStatusDisplay()` function exists at line 729+ with CVA variant returns
- Badge and HealthIndicator imported from ui barrel
- Function covers all status states: WORK, OFF, START, STANDBY/WAIT, ERROR/ALARM, CLEAN, MODULATION
- Existing getStatusInfo() function unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Badge and HealthIndicator to status display header</name>
  <files>app/components/devices/stove/StoveCard.js</files>
  <action>
Enhance the status display area with Badge and HealthIndicator components. Per CONTEXT.md: use StatusCard approach with HealthIndicator showing ok/warning/error.

This is an ADDITIVE change - we wrap existing header elements in a flex container and add new elements to the right side.

1. **Cache status display result** at line 735 (after existing `const statusInfo = getStatusInfo(status);`):
   Add this line immediately after line 734:
   ```jsx
   const statusDisplay = getStatusDisplay(status);
   ```

2. **Modify the header section** at lines 831-835.

   **Current code (lines 831-835):**
   ```jsx
   {/* Header - Ember Noir style */}
   <div className="flex items-center gap-3 mb-6">
     <span className="text-2xl sm:text-3xl">ðŸ”¥</span>
     <Heading level={2} size="xl" className="font-display">Stufa</Heading>
   </div>
   ```

   **Replace with (ADDITIVE - wrapping existing elements and adding Badge + HealthIndicator on right):**
   ```jsx
   {/* Header - Ember Noir style */}
   <div className="flex items-center justify-between gap-3 mb-6">
     <div className="flex items-center gap-3">
       <span className="text-2xl sm:text-3xl">ðŸ”¥</span>
       <Heading level={2} size="xl" className="font-display">Stufa</Heading>
     </div>
     <div className="flex items-center gap-2">
       <Badge
         variant={statusDisplay.variant}
         pulse={statusDisplay.pulse}
         size="sm"
       >
         {statusDisplay.label}
       </Badge>
       <HealthIndicator
         status={statusDisplay.health}
         size="sm"
         showIcon={true}
         label=""
       />
     </div>
   </div>
   ```

**Summary of changes:**
- Line 832: Add `justify-between` to outer div className
- Lines 833-834: Wrap existing emoji + Heading in a new inner `<div className="flex items-center gap-3">`
- After the closing `</div>` of the inner wrapper: Add new `<div className="flex items-center gap-2">` containing Badge and HealthIndicator

**Note:** Keep the existing elaborate status display box (the large visual with icon and gradient background) unchanged. The Badge + HealthIndicator provide a compact status summary in the header, complementing the main visual display.
  </action>
  <verify>
1. `grep -n "<Badge" app/components/devices/stove/StoveCard.js` shows Badge usage
2. `grep -n "<HealthIndicator" app/components/devices/stove/StoveCard.js` shows HealthIndicator usage
3. `grep -n "statusDisplay.variant" app/components/devices/stove/StoveCard.js` confirms cached variable usage
4. `npm run dev` - Check visual: header should show compact Badge + HealthIndicator on right side, "Stufa" title with emoji on left
  </verify>
  <done>
- Badge with CVA variant displayed in header right side showing current status
- HealthIndicator with ok/warning/error based on stove state
- statusDisplay variable cached at line 735 to avoid repeated function calls
- Header uses justify-between with left group (emoji + title) and right group (Badge + HealthIndicator)
- Main elaborate status display box preserved below header (no visual regression)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CVA variant data attribute and glow helper to status display box</name>
  <files>app/components/devices/stove/StoveCard.js</files>
  <action>
Update the main status display box to use CVA-aligned data attributes for CSS hooks, while preserving the elaborate gradient design.

**Step 1: Create glow helper function at line 729** (immediately after getStatusInfo closes on line 728, BEFORE getStatusDisplay):

Insert at line 729:
```jsx
/**
 * Map CVA variants to glow/shadow effects for status box
 * Preserves elaborate visual design while using design system tokens
 */
const getStatusGlow = (variant) => {
  const glows = {
    ember: 'shadow-ember-glow',
    sage: 'shadow-[0_0_20px_rgba(96,115,96,0.3)]',
    ocean: 'shadow-[0_0_30px_rgba(67,125,174,0.3)]',
    warning: 'shadow-[0_0_20px_rgba(234,179,8,0.2)]',
    danger: 'shadow-[0_0_30px_rgba(239,68,68,0.3)]',
    neutral: ''
  };
  return glows[variant] || '';
};
```

**Step 2: Add data-status-variant attribute at line 864** (the Status Display Box div):

Current line 864:
```jsx
<div className={`relative ${statusInfo.bgColor} rounded-2xl p-6 sm:p-8 ${statusInfo.glowColor} border ${statusInfo.borderColor} overflow-visible transition-all duration-500`}>
```

Modify to add data attribute (add `data-status-variant={statusDisplay.variant}` before the closing `>`):
```jsx
<div className={`relative ${statusInfo.bgColor} rounded-2xl p-6 sm:p-8 ${statusInfo.glowColor} border ${statusInfo.borderColor} overflow-visible transition-all duration-500`} data-status-variant={statusDisplay.variant}>
```

**Summary of line-specific changes:**
- Line 729: Insert getStatusGlow() function (14 lines)
- Line ~878 (after function insertion shifts lines): Add `data-status-variant={statusDisplay.variant}` attribute to existing div

**DO NOT:**
- Remove or modify getStatusInfo() - it provides elaborate styling for main status box
- Replace the gradient backgrounds with simple solid colors
- Change the visual design of the main status display
- Modify the getStatusInfo() return values
  </action>
  <verify>
1. `grep -n 'data-status-variant' app/components/devices/stove/StoveCard.js` confirms data attribute added
2. `grep -n 'getStatusGlow' app/components/devices/stove/StoveCard.js` confirms helper function exists
3. `npm test -- --testPathPattern=StoveCard --passWithNoTests` passes
4. Visual check: Main status display box retains elaborate gradient design
  </verify>
  <done>
- data-status-variant attribute added to main status display box div
- getStatusGlow() helper function created at line 729 for future use
- Elaborate visual design of main status box preserved unchanged
- CVA variants used for Badge and HealthIndicator in header (from Task 2)
- getStatusInfo() function unchanged
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm test` - All existing tests pass
2. Visual check in dev server:
   - Header shows Badge with status label + HealthIndicator on right side
   - Main status display box retains elaborate gradient design
   - Badge color matches status (ember for WORK, danger for ERROR, etc.)
3. `grep -c "getStatusDisplay" app/components/devices/stove/StoveCard.js` shows function definition and usage
4. No console errors or warnings
</verification>

<success_criteria>
- getStatusDisplay() function returns CVA variant names
- Badge component displays status with correct variant
- HealthIndicator shows ok/warning/error based on stove state
- Main status display box visual design preserved
- All status states mapped: WORK, OFF, START, STANDBY, ERROR, CLEAN, MODULATION
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/19-stove-card-compliance/19-02-SUMMARY.md`
</output>
