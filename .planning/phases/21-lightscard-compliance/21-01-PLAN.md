---
phase: 21-lightscard-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/lights/LightsCard.js
autonomous: true

must_haves:
  truths:
    - "User can drag slider to adjust brightness with smooth visual feedback"
    - "API is called only when slider drag ends (not on every pixel movement)"
    - "Slider adapts styling based on light contrast mode (light/dark/default)"
    - "Slider is keyboard accessible (arrow keys, Page Up/Down, Home/End)"
  artifacts:
    - path: "app/components/devices/lights/LightsCard.js"
      provides: "Brightness slider using design system Slider component"
      contains: "import.*Slider.*from"
  key_links:
    - from: "LightsCard.js Slider"
      to: "handleBrightnessChange"
      via: "onPointerUp/onTouchEnd commit pattern"
      pattern: "onPointerUp.*handleBrightnessChange|onTouchEnd.*handleBrightnessChange"
---

<objective>
Replace the raw `<input type="range">` brightness slider in LightsCard with the design system Slider component.

Purpose: Achieve design system compliance for the brightness control while preserving the local-state-during-drag UX pattern that prevents API spam during slider movement.

Output: LightsCard uses Radix-based Slider component with proper accessibility, touch support, and adaptive styling.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-lightscard-compliance/21-CONTEXT.md
@.planning/phases/21-lightscard-compliance/21-RESEARCH.md
@app/components/devices/lights/LightsCard.js
@app/components/ui/Slider.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace raw input range with Slider component</name>
  <files>app/components/devices/lights/LightsCard.js</files>
  <action>
Replace the raw `<input type="range">` (lines 1059-1091) with the design system Slider component.

**Key preservation requirements:**
1. Keep `localBrightness` state pattern - this prevents API calls during drag
2. Keep `isDraggingSlider` ref - used for tracking drag state
3. Slider onChange should update localBrightness (local state during drag)
4. API call happens only on release (onPointerUp/onTouchEnd)

**Implementation:**

1. Add Slider to the import statement (it's already exported from `../../ui`):
   ```jsx
   import { Divider, Heading, Button, ControlButton, EmptyState, Text, Slider } from '../../ui';
   ```

2. Replace the raw input (lines 1059-1091) with:
   ```jsx
   <Slider
     value={localBrightness !== null ? localBrightness : avgBrightness}
     onChange={(value) => {
       // Update local state during drag for smooth UI
       setLocalBrightness(value);
     }}
     onPointerUp={() => {
       // Commit to API on release
       if (localBrightness !== null) {
         handleBrightnessChange(selectedRoomGroupedLightId, localBrightness.toString());
         setLocalBrightness(null);
       }
     }}
     onTouchEnd={() => {
       // Commit on touch release (mobile)
       if (localBrightness !== null) {
         handleBrightnessChange(selectedRoomGroupedLightId, localBrightness.toString());
         setLocalBrightness(null);
       }
     }}
     min={1}
     max={100}
     variant="ember"
     disabled={refreshing || !selectedRoomGroupedLightId}
     aria-label="LuminositÃ "
     className={cn(
       'w-full',
       adaptive.slider
     )}
   />
   ```

3. Add `cn` import if not already present:
   ```jsx
   import { cn } from '@/lib/utils/cn';
   ```

**Note:** The `isDraggingSlider` ref can be removed as Slider handles this internally, but leave it if other code references it. The Slider's onPointerUp/onTouchEnd events provide the commit point.

**Adaptive styling note:** The `adaptive.slider` class provides contrast-aware styling:
- light mode: 'bg-slate-300 accent-slate-800'
- dark mode: 'bg-slate-600 accent-white'
- default: '' (uses Slider's ember variant)
  </action>
  <verify>
- Slider component renders in brightness panel when room is on
- `npm run dev` - no console errors
- Drag slider - value updates smoothly without API calls (check Network tab)
- Release slider - single API call to brightness endpoint
- Touch drag works on mobile/touch devices
- Keyboard navigation works (Tab to focus, arrow keys to adjust)
  </verify>
  <done>
- Raw input replaced with Slider component
- Local state pattern preserved (localBrightness)
- API called only on drag release
- Adaptive styling applied via className
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up unused dragging ref if applicable</name>
  <files>app/components/devices/lights/LightsCard.js</files>
  <action>
Check if `isDraggingSlider` ref (line 33) is used elsewhere in the component.

**If NOT used elsewhere:** Remove the ref declaration:
```jsx
// Remove this line if no other code references it:
const isDraggingSlider = useRef(false);
```

**If used elsewhere:** Keep it, the Slider migration doesn't require its removal.

The Slider component handles drag state internally via onPointerDown/onPointerUp, so the ref is no longer needed for the brightness control.
  </action>
  <verify>
- Search file for `isDraggingSlider` - should find 0 usages after removal (or keep if other usages exist)
- `npm run dev` - component renders without errors
  </verify>
  <done>
- Unused ref removed (if applicable)
- No dead code remaining from raw input implementation
  </done>
</task>

</tasks>

<verification>
1. **Functional:** Slider adjusts brightness smoothly, API called only on release
2. **Accessibility:** Slider is keyboard navigable (Tab, Arrow keys, Page Up/Down)
3. **Adaptive:** Slider contrast changes with light color (bright lights = dark slider, dark lights = light slider)
4. **Touch:** Slider works on touch devices without multi-touch issues
5. **Design system:** Import from `../../ui`, not direct Radix import
</verification>

<success_criteria>
- [ ] No raw `<input type="range">` in LightsCard.js
- [ ] Slider imported from design system (../../ui)
- [ ] Local state pattern preserved (no API spam during drag)
- [ ] Adaptive styling applied (adaptive.slider class)
- [ ] Keyboard accessible (arrow keys work)
- [ ] Touch accessible (mobile drag works)
</success_criteria>

<output>
After completion, create `.planning/phases/21-lightscard-compliance/21-01-SUMMARY.md`
</output>
