---
phase: 25-weather-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/openMeteo.js
  - lib/weatherCache.js
  - app/api/weather/forecast/route.js
autonomous: true

must_haves:
  truths:
    - "API route /api/weather/forecast returns weather data for given coordinates"
    - "Weather responses are cached for 15 minutes"
    - "Repeated requests within cache window return cached data instantly"
    - "Response includes cachedAt timestamp for freshness indicator"
    - "Stale data returns immediately while background refresh triggers"
  artifacts:
    - path: "lib/openMeteo.js"
      provides: "Open-Meteo API wrapper with weather code interpretation"
      exports: ["fetchWeatherForecast", "interpretWeatherCode", "WMO_CODES"]
    - path: "lib/weatherCache.js"
      provides: "In-memory cache with TTL and stale-while-revalidate"
      exports: ["getCachedWeather", "clearWeatherCache"]
    - path: "app/api/weather/forecast/route.js"
      provides: "GET endpoint for weather forecast"
      exports: ["GET"]
  key_links:
    - from: "app/api/weather/forecast/route.js"
      to: "lib/weatherCache.js"
      via: "getCachedWeather call"
      pattern: "getCachedWeather\\("
    - from: "lib/weatherCache.js"
      to: "lib/openMeteo.js"
      via: "fetchWeatherForecast callback"
      pattern: "fetchWeatherForecast"
---

<objective>
Create the weather API infrastructure: Open-Meteo client, in-memory cache with 15-minute TTL, and forecast API route.

Purpose: Provide the backend foundation for weather display. Without this, Phase 26 (WeatherCard) has no data source.
Output: Working /api/weather/forecast endpoint that returns current conditions and 5-day forecast.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-weather-foundation/25-CONTEXT.md
@.planning/phases/25-weather-foundation/25-RESEARCH.md
@lib/core/index.js
@lib/core/apiResponse.js
@lib/environmentHelper.js
@app/api/netatmo/homestatus/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Open-Meteo API wrapper</name>
  <files>lib/openMeteo.js</files>
  <action>
Create `lib/openMeteo.js` with:

1. **WMO_CODES constant**: Complete weather code mapping (0-99) with description and icon code:
   ```javascript
   export const WMO_CODES = {
     0: { description: 'Sereno', icon: '01' },
     1: { description: 'Prevalentemente sereno', icon: '02' },
     2: { description: 'Parzialmente nuvoloso', icon: '03' },
     3: { description: 'Coperto', icon: '04' },
     45: { description: 'Nebbia', icon: '50' },
     48: { description: 'Nebbia con brina', icon: '50' },
     51: { description: 'Pioviggine leggera', icon: '09' },
     53: { description: 'Pioviggine moderata', icon: '09' },
     55: { description: 'Pioviggine intensa', icon: '09' },
     61: { description: 'Pioggia leggera', icon: '10' },
     63: { description: 'Pioggia moderata', icon: '10' },
     65: { description: 'Pioggia intensa', icon: '10' },
     71: { description: 'Neve leggera', icon: '13' },
     73: { description: 'Neve moderata', icon: '13' },
     75: { description: 'Neve intensa', icon: '13' },
     77: { description: 'Granuli di neve', icon: '13' },
     80: { description: 'Rovesci leggeri', icon: '09' },
     81: { description: 'Rovesci moderati', icon: '09' },
     82: { description: 'Rovesci violenti', icon: '09' },
     85: { description: 'Rovesci di neve leggeri', icon: '13' },
     86: { description: 'Rovesci di neve intensi', icon: '13' },
     95: { description: 'Temporale', icon: '11' },
     96: { description: 'Temporale con grandine leggera', icon: '11' },
     99: { description: 'Temporale con grandine intensa', icon: '11' },
   };
   ```

2. **interpretWeatherCode(code)**: Returns description and icon for weather code, defaults to 'Sconosciuto' for unknown codes.

3. **fetchWeatherForecast(latitude, longitude)**:
   - Build URL with URLSearchParams:
     - latitude/longitude rounded to 4 decimals
     - current: 'temperature_2m,apparent_temperature,relative_humidity_2m,wind_speed_10m,weather_code'
     - daily: 'weather_code,temperature_2m_max,temperature_2m_min'
     - forecast_days: '5'
     - timezone: 'auto' (CRITICAL: always include for correct local times)
   - Fetch from `https://api.open-meteo.com/v1/forecast`
   - On error: throw Error with status code
   - Return parsed JSON response

Use Italian descriptions for weather conditions (project language).
  </action>
  <verify>
```bash
# Test file exists and exports correctly
node -e "const m = require('./lib/openMeteo.js'); console.log(Object.keys(m))"
# Should show: fetchWeatherForecast, interpretWeatherCode, WMO_CODES
```
  </verify>
  <done>
- `fetchWeatherForecast` function exported and makes API call
- `interpretWeatherCode` maps codes to Italian descriptions
- `WMO_CODES` constant exported for direct access
  </done>
</task>

<task type="auto">
  <name>Task 2: Create weather cache utility</name>
  <files>lib/weatherCache.js</files>
  <action>
Create `lib/weatherCache.js` implementing stale-while-revalidate pattern:

1. **Constants**:
   ```javascript
   const cache = new Map();
   const CACHE_TTL = 15 * 60 * 1000; // 15 minutes in ms
   ```

2. **getCachedWeather(lat, lon, fetchFn)**:
   - Build cache key: `location:${lat.toFixed(4)},${lon.toFixed(4)}` (4 decimals = ~11m precision)
   - Check if entry exists in cache
   - If exists:
     - Calculate age: `Date.now() - cached.timestamp`
     - If stale (age > CACHE_TTL): trigger background refresh with `fetchFn(lat, lon).then(...).catch(...)` - do NOT await
     - Return immediately: `{ data: cached.data, cachedAt: cached.timestamp, stale: age > CACHE_TTL }`
   - If not exists:
     - Await `fetchFn(lat, lon)`
     - Store in cache: `{ data: fresh, timestamp: Date.now() }`
     - Return: `{ data: fresh, cachedAt: Date.now(), stale: false }`

3. **clearWeatherCache()**: Clears the Map for testing purposes

Export: `getCachedWeather`, `clearWeatherCache`

Note: Background refresh error logging uses `console.error` (fire-and-forget pattern from project conventions).
  </action>
  <verify>
```bash
# Test cache module loads
node -e "const c = require('./lib/weatherCache.js'); console.log(typeof c.getCachedWeather, typeof c.clearWeatherCache)"
# Should show: function function
```
  </verify>
  <done>
- `getCachedWeather` returns cached data with stale indicator
- Background refresh triggers for stale data without blocking
- Cache key uses 4-decimal coordinate precision
- `clearWeatherCache` available for testing
  </done>
</task>

<task type="auto">
  <name>Task 3: Create weather forecast API route</name>
  <files>app/api/weather/forecast/route.js</files>
  <action>
Create `app/api/weather/forecast/route.js`:

1. **Imports**:
   ```javascript
   import { withAuthAndErrorHandler, success, badRequest, error } from '@/lib/core';
   import { getCachedWeather } from '@/lib/weatherCache';
   import { fetchWeatherForecast, interpretWeatherCode } from '@/lib/openMeteo';
   ```

2. **Force dynamic**: `export const dynamic = 'force-dynamic';`

3. **GET handler** wrapped with `withAuthAndErrorHandler`:
   - Parse query params: `lat`, `lon` from URL searchParams
   - Validate: both required, must be valid numbers
   - Validate ranges: lat -90 to 90, lon -180 to 180
   - On validation failure: return `badRequest('Missing or invalid coordinates')`

   - Call `getCachedWeather(parseFloat(lat), parseFloat(lon), fetchWeatherForecast)`
   - Transform response for frontend:
     ```javascript
     const { data, cachedAt, stale } = await getCachedWeather(...);

     // Enrich current weather with interpreted code
     const currentCondition = interpretWeatherCode(data.current.weather_code);

     // Enrich daily forecast
     const dailyForecast = data.daily.time.map((date, i) => ({
       date,
       tempMax: data.daily.temperature_2m_max[i],
       tempMin: data.daily.temperature_2m_min[i],
       condition: interpretWeatherCode(data.daily.weather_code[i]),
     }));

     return success({
       current: {
         temperature: data.current.temperature_2m,
         feelsLike: data.current.apparent_temperature,
         humidity: data.current.relative_humidity_2m,
         windSpeed: data.current.wind_speed_10m,
         condition: currentCondition,
         units: data.current_units,
       },
       forecast: dailyForecast,
       cachedAt,
       stale,
     });
     ```

4. **Error handling**: Catch errors from Open-Meteo and return appropriate response:
   - Network errors: `error('Weather service unavailable', 'WEATHER_API_ERROR', 503)`
   - Log errors to console for monitoring

Context name for middleware: `'Weather/Forecast'`
  </action>
  <verify>
```bash
# Start dev server and test endpoint (requires server running)
# Manual verification: curl "http://localhost:3000/api/weather/forecast?lat=45.4642&lon=9.19"
# Should return JSON with current temperature, forecast array, cachedAt timestamp

# File structure check
ls -la app/api/weather/forecast/route.js
```
  </verify>
  <done>
- GET /api/weather/forecast?lat=X&lon=Y returns weather data
- Response includes current conditions with Italian descriptions
- Response includes 5-day forecast
- Response includes cachedAt timestamp and stale indicator
- Invalid coordinates return 400 Bad Request
- Auth required (withAuthAndErrorHandler middleware)
  </done>
</task>

</tasks>

<verification>
All tasks verified:
1. `lib/openMeteo.js` exports `fetchWeatherForecast`, `interpretWeatherCode`, `WMO_CODES`
2. `lib/weatherCache.js` exports `getCachedWeather`, `clearWeatherCache`
3. `app/api/weather/forecast/route.js` exports GET handler
4. Files follow project patterns (imports from @/lib/core, withAuthAndErrorHandler wrapper)
</verification>

<success_criteria>
- API route /api/weather/forecast returns weather data for valid coordinates
- Response includes current.temperature, current.feelsLike, current.condition
- Response includes forecast array with 5 days
- Response includes cachedAt timestamp
- Second request within 15 minutes returns cached data (verify by cachedAt not changing)
- Invalid coordinates (missing, out of range) return 400
</success_criteria>

<output>
After completion, create `.planning/phases/25-weather-foundation/25-01-SUMMARY.md`
</output>
