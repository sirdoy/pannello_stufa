---
phase: 25-weather-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/geolocation.js
  - lib/services/locationService.js
  - app/api/config/location/route.js
autonomous: true

must_haves:
  truths:
    - "Geolocation utility returns coordinates within 10 seconds or throws specific error"
    - "iOS PWA geolocation failures show appropriate error code (not generic)"
    - "Permission denied, timeout, and unavailable errors are distinguishable"
    - "Location can be saved to Firebase RTDB at /config/location"
    - "Location can be read from Firebase RTDB"
  artifacts:
    - path: "lib/geolocation.js"
      provides: "Browser geolocation utility with timeout and error handling"
      exports: ["getCurrentLocation", "GEOLOCATION_ERRORS"]
    - path: "lib/services/locationService.js"
      provides: "Firebase RTDB location read/write service"
      exports: ["getLocation", "setLocation", "subscribeToLocation"]
    - path: "app/api/config/location/route.js"
      provides: "API route for location CRUD"
      exports: ["GET", "POST"]
  key_links:
    - from: "app/api/config/location/route.js"
      to: "lib/firebaseAdmin.js"
      via: "adminDbGet/adminDbSet calls"
      pattern: "adminDb(Get|Set)\\("
    - from: "lib/services/locationService.js"
      to: "firebase/database"
      via: "ref, onValue, set"
      pattern: "(ref|onValue|set)\\("
---

<objective>
Create geolocation utility with iOS PWA fallback handling and location service for Firebase persistence.

Purpose: Enable weather to know where to fetch data from. Location is stored centrally in Firebase so all users see weather for the same configured location.
Output: Client-side geolocation utility, Firebase location service, and API route for location CRUD.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-weather-foundation/25-CONTEXT.md
@.planning/phases/25-weather-foundation/25-RESEARCH.md
@lib/firebase.js
@lib/firebaseAdmin.js
@lib/environmentHelper.js
@lib/core/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geolocation utility</name>
  <files>lib/geolocation.js</files>
  <action>
Create `lib/geolocation.js` for client-side browser geolocation:

1. **Error codes constant**:
   ```javascript
   export const GEOLOCATION_ERRORS = {
     NOT_SUPPORTED: 'GEOLOCATION_NOT_SUPPORTED',
     PERMISSION_DENIED: 'PERMISSION_DENIED',
     POSITION_UNAVAILABLE: 'POSITION_UNAVAILABLE',
     TIMEOUT: 'TIMEOUT',
     UNKNOWN: 'UNKNOWN_ERROR',
   };
   ```

2. **Error messages for UI** (Italian):
   ```javascript
   export const GEOLOCATION_ERROR_MESSAGES = {
     [GEOLOCATION_ERRORS.NOT_SUPPORTED]: 'Geolocalizzazione non supportata dal browser',
     [GEOLOCATION_ERRORS.PERMISSION_DENIED]: 'Permesso di geolocalizzazione negato',
     [GEOLOCATION_ERRORS.POSITION_UNAVAILABLE]: 'Posizione non disponibile',
     [GEOLOCATION_ERRORS.TIMEOUT]: 'Richiesta di posizione scaduta',
     [GEOLOCATION_ERRORS.UNKNOWN]: 'Errore sconosciuto nella geolocalizzazione',
   };
   ```

3. **getCurrentLocation()** function:
   - Check `navigator.geolocation` exists, throw `NOT_SUPPORTED` if not
   - Return Promise that wraps `getCurrentPosition`:
     ```javascript
     const options = {
       enableHighAccuracy: false, // Faster, less battery drain
       timeout: 10000,            // 10 seconds (from INFRA-04 requirement)
       maximumAge: 300000,        // 5 minutes cached position OK
     };
     ```
   - On success: resolve with `{ latitude, longitude, accuracy }`
   - On error: map error codes to our constants:
     - `error.code === 1` (PERMISSION_DENIED) -> `GEOLOCATION_ERRORS.PERMISSION_DENIED`
     - `error.code === 2` (POSITION_UNAVAILABLE) -> `GEOLOCATION_ERRORS.POSITION_UNAVAILABLE`
     - `error.code === 3` (TIMEOUT) -> `GEOLOCATION_ERRORS.TIMEOUT`
     - else -> `GEOLOCATION_ERRORS.UNKNOWN`
   - Reject with Error that has `code` property set to the error constant

4. **Export**: `getCurrentLocation`, `GEOLOCATION_ERRORS`, `GEOLOCATION_ERROR_MESSAGES`

Note: This is CLIENT-SIDE only - 'use client' directive NOT needed since it's a utility, but ensure no server-only imports.
  </action>
  <verify>
```bash
# Check file exists and has expected exports
head -50 lib/geolocation.js
# Should show GEOLOCATION_ERRORS, GEOLOCATION_ERROR_MESSAGES, getCurrentLocation
```
  </verify>
  <done>
- `getCurrentLocation()` returns Promise with { latitude, longitude, accuracy }
- Timeout is 10 seconds as per INFRA-04
- Error codes are specific and distinguishable
- Italian error messages available for UI
  </done>
</task>

<task type="auto">
  <name>Task 2: Create location service for Firebase</name>
  <files>lib/services/locationService.js</files>
  <action>
Create `lib/services/locationService.js` for client-side Firebase operations:

1. **Imports**:
   ```javascript
   import { ref, onValue, set } from 'firebase/database';
   import { db } from '@/lib/firebase';
   import { getEnvironmentPath } from '@/lib/environmentHelper';
   ```

2. **LOCATION_PATH constant**:
   ```javascript
   const getLocationPath = () => getEnvironmentPath('config/location');
   ```

3. **getLocation()** - Read location once:
   ```javascript
   export async function getLocation() {
     const locationRef = ref(db, getLocationPath());
     return new Promise((resolve) => {
       onValue(locationRef, (snapshot) => {
         resolve(snapshot.val());
       }, { onlyOnce: true });
     });
   }
   ```

4. **setLocation(locationData)** - Write location:
   ```javascript
   export async function setLocation({ latitude, longitude, name }) {
     const locationRef = ref(db, getLocationPath());
     await set(locationRef, {
       latitude,
       longitude,
       name: name || null,
       updatedAt: Date.now(),
     });
   }
   ```

5. **subscribeToLocation(callback)** - Real-time subscription:
   ```javascript
   export function subscribeToLocation(callback) {
     const locationRef = ref(db, getLocationPath());
     const unsubscribe = onValue(locationRef, (snapshot) => {
       callback(snapshot.val());
     });
     return unsubscribe;
   }
   ```

Export: `getLocation`, `setLocation`, `subscribeToLocation`

Directory note: Create `lib/services/` directory if it doesn't exist.
  </action>
  <verify>
```bash
# Check file and directory exist
ls -la lib/services/locationService.js
# Check exports
head -30 lib/services/locationService.js
```
  </verify>
  <done>
- `getLocation()` reads from Firebase RTDB
- `setLocation({ latitude, longitude, name })` writes to Firebase RTDB
- `subscribeToLocation(callback)` provides real-time updates
- Path uses `getEnvironmentPath` for dev/prod separation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create location API route</name>
  <files>app/api/config/location/route.js</files>
  <action>
Create `app/api/config/location/route.js` for server-side location operations:

1. **Imports**:
   ```javascript
   import { withAuthAndErrorHandler, success, badRequest, error } from '@/lib/core';
   import { adminDbGet, adminDbSet } from '@/lib/firebaseAdmin';
   import { getEnvironmentPath } from '@/lib/environmentHelper';
   ```

2. **Force dynamic**: `export const dynamic = 'force-dynamic';`

3. **GET handler** - Read current location:
   ```javascript
   export const GET = withAuthAndErrorHandler(async () => {
     const locationPath = getEnvironmentPath('config/location');
     const location = await adminDbGet(locationPath);

     if (!location) {
       return error('Location not configured', 'LOCATION_NOT_SET', 404);
     }

     return success({ location });
   }, 'Config/Location');
   ```

4. **POST handler** - Set location:
   ```javascript
   export const POST = withAuthAndErrorHandler(async (request) => {
     const body = await request.json();
     const { latitude, longitude, name } = body;

     // Validate coordinates
     if (latitude === undefined || longitude === undefined) {
       return badRequest('latitude and longitude are required');
     }

     const lat = parseFloat(latitude);
     const lon = parseFloat(longitude);

     if (isNaN(lat) || isNaN(lon)) {
       return badRequest('latitude and longitude must be valid numbers');
     }

     if (lat < -90 || lat > 90) {
       return badRequest('latitude must be between -90 and 90');
     }

     if (lon < -180 || lon > 180) {
       return badRequest('longitude must be between -180 and 180');
     }

     // Save to Firebase
     const locationPath = getEnvironmentPath('config/location');
     await adminDbSet(locationPath, {
       latitude: lat,
       longitude: lon,
       name: name || null,
       updatedAt: Date.now(),
     });

     return success({
       message: 'Location updated',
       location: { latitude: lat, longitude: lon, name: name || null },
     });
   }, 'Config/Location');
   ```

Directory note: Create `app/api/config/location/` directory structure.
  </action>
  <verify>
```bash
# Check file exists
ls -la app/api/config/location/route.js

# Verify structure
head -20 app/api/config/location/route.js
```
  </verify>
  <done>
- GET /api/config/location returns stored location or 404 LOCATION_NOT_SET
- POST /api/config/location saves { latitude, longitude, name }
- Coordinates validated for range
- Auth required via withAuthAndErrorHandler
  </done>
</task>

</tasks>

<verification>
All tasks verified:
1. `lib/geolocation.js` exports `getCurrentLocation`, `GEOLOCATION_ERRORS`, `GEOLOCATION_ERROR_MESSAGES`
2. `lib/services/locationService.js` exports `getLocation`, `setLocation`, `subscribeToLocation`
3. `app/api/config/location/route.js` exports `GET`, `POST`
4. Files follow project patterns
</verification>

<success_criteria>
- `getCurrentLocation()` resolves with coordinates or rejects with specific error code
- Geolocation timeout is 10 seconds (INFRA-04)
- Error codes distinguish permission denied vs timeout vs unavailable
- GET /api/config/location returns location or 404 with LOCATION_NOT_SET code
- POST /api/config/location saves and returns location
- Location path uses environment prefix (dev/config/location vs config/location)
</success_criteria>

<output>
After completion, create `.planning/phases/25-weather-foundation/25-02-SUMMARY.md`
</output>
