---
phase: 25-weather-foundation
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - lib/services/dashboardPreferencesService.js
  - app/api/config/dashboard/route.js
  - lib/__tests__/weatherCache.test.js
autonomous: true

must_haves:
  truths:
    - "Dashboard preferences can be saved to Firebase RTDB"
    - "Dashboard preferences can be read from Firebase RTDB"
    - "Default card order is sensible for new users"
    - "Weather cache correctly returns stale data and triggers background refresh"
  artifacts:
    - path: "lib/services/dashboardPreferencesService.js"
      provides: "Dashboard preferences read/write service"
      exports: ["getDashboardPreferences", "setDashboardPreferences", "subscribeToDashboardPreferences", "DEFAULT_CARD_ORDER"]
    - path: "app/api/config/dashboard/route.js"
      provides: "API route for dashboard preferences CRUD"
      exports: ["GET", "POST"]
    - path: "lib/__tests__/weatherCache.test.js"
      provides: "Unit tests for weather cache"
  key_links:
    - from: "app/api/config/dashboard/route.js"
      to: "lib/firebaseAdmin.js"
      via: "adminDbGet/adminDbSet calls"
      pattern: "adminDb(Get|Set)\\("
    - from: "lib/services/dashboardPreferencesService.js"
      to: "firebase/database"
      via: "ref, onValue, set"
      pattern: "(ref|onValue|set)\\("
---

<objective>
Create dashboard preferences service for Phase 28 and add weather cache tests to validate Phase 25 infrastructure.

Purpose: Foundation for dashboard customization (Phase 28) and verification that cache behavior is correct.
Output: Dashboard preferences API and service, plus comprehensive tests for weather cache.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-weather-foundation/25-CONTEXT.md
@.planning/phases/25-weather-foundation/25-RESEARCH.md
@lib/firebase.js
@lib/firebaseAdmin.js
@lib/environmentHelper.js
@lib/core/index.js
@lib/services/locationService.js
@lib/weatherCache.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard preferences service</name>
  <files>lib/services/dashboardPreferencesService.js</files>
  <action>
Create `lib/services/dashboardPreferencesService.js` for client-side Firebase operations:

1. **Imports**:
   ```javascript
   import { ref, onValue, set } from 'firebase/database';
   import { db } from '@/lib/firebase';
   import { getEnvironmentPath } from '@/lib/environmentHelper';
   ```

2. **Default card order constant** (matches existing home page cards):
   ```javascript
   export const DEFAULT_CARD_ORDER = [
     { id: 'stove', label: 'Stufa', visible: true },
     { id: 'thermostat', label: 'Termostato', visible: true },
     { id: 'weather', label: 'Meteo', visible: true },
     { id: 'lights', label: 'Luci', visible: true },
     { id: 'camera', label: 'Telecamera', visible: true },
   ];
   ```

3. **Path helper**:
   ```javascript
   const getDashboardPath = () => getEnvironmentPath('config/dashboard');
   ```

4. **getDashboardPreferences()** - Read preferences once:
   ```javascript
   export async function getDashboardPreferences() {
     const dashboardRef = ref(db, getDashboardPath());
     return new Promise((resolve) => {
       onValue(dashboardRef, (snapshot) => {
         const data = snapshot.val();
         // Return stored preferences or defaults
         resolve(data || { cardOrder: DEFAULT_CARD_ORDER });
       }, { onlyOnce: true });
     });
   }
   ```

5. **setDashboardPreferences(preferences)** - Write preferences:
   ```javascript
   export async function setDashboardPreferences({ cardOrder }) {
     const dashboardRef = ref(db, getDashboardPath());
     await set(dashboardRef, {
       cardOrder: cardOrder || DEFAULT_CARD_ORDER,
       updatedAt: Date.now(),
     });
   }
   ```

6. **subscribeToDashboardPreferences(callback)** - Real-time subscription:
   ```javascript
   export function subscribeToDashboardPreferences(callback) {
     const dashboardRef = ref(db, getDashboardPath());
     const unsubscribe = onValue(dashboardRef, (snapshot) => {
       const data = snapshot.val();
       callback(data || { cardOrder: DEFAULT_CARD_ORDER });
     });
     return unsubscribe;
   }
   ```

Export: `getDashboardPreferences`, `setDashboardPreferences`, `subscribeToDashboardPreferences`, `DEFAULT_CARD_ORDER`
  </action>
  <verify>
```bash
# Check file exists and exports
head -40 lib/services/dashboardPreferencesService.js
# Should show DEFAULT_CARD_ORDER and all three functions
```
  </verify>
  <done>
- `getDashboardPreferences()` returns stored or default preferences
- `setDashboardPreferences({ cardOrder })` writes to Firebase
- `subscribeToDashboardPreferences(callback)` provides real-time updates
- `DEFAULT_CARD_ORDER` includes all existing cards plus weather
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard preferences API route</name>
  <files>app/api/config/dashboard/route.js</files>
  <action>
Create `app/api/config/dashboard/route.js` for server-side dashboard operations:

1. **Imports**:
   ```javascript
   import { withAuthAndErrorHandler, success, badRequest } from '@/lib/core';
   import { adminDbGet, adminDbSet } from '@/lib/firebaseAdmin';
   import { getEnvironmentPath } from '@/lib/environmentHelper';
   ```

2. **Default card order** (duplicated for server-side):
   ```javascript
   const DEFAULT_CARD_ORDER = [
     { id: 'stove', label: 'Stufa', visible: true },
     { id: 'thermostat', label: 'Termostato', visible: true },
     { id: 'weather', label: 'Meteo', visible: true },
     { id: 'lights', label: 'Luci', visible: true },
     { id: 'camera', label: 'Telecamera', visible: true },
   ];
   ```

3. **Force dynamic**: `export const dynamic = 'force-dynamic';`

4. **GET handler** - Read dashboard preferences:
   ```javascript
   export const GET = withAuthAndErrorHandler(async () => {
     const dashboardPath = getEnvironmentPath('config/dashboard');
     const preferences = await adminDbGet(dashboardPath);

     // Return stored or defaults
     return success({
       preferences: preferences || { cardOrder: DEFAULT_CARD_ORDER },
     });
   }, 'Config/Dashboard');
   ```

5. **POST handler** - Set dashboard preferences:
   ```javascript
   export const POST = withAuthAndErrorHandler(async (request) => {
     const body = await request.json();
     const { cardOrder } = body;

     // Validate cardOrder structure
     if (!cardOrder || !Array.isArray(cardOrder)) {
       return badRequest('cardOrder must be an array');
     }

     // Validate each card has required fields
     for (const card of cardOrder) {
       if (!card.id || typeof card.id !== 'string') {
         return badRequest('Each card must have a string id');
       }
       if (typeof card.visible !== 'boolean') {
         return badRequest('Each card must have a boolean visible field');
       }
     }

     // Save to Firebase
     const dashboardPath = getEnvironmentPath('config/dashboard');
     await adminDbSet(dashboardPath, {
       cardOrder,
       updatedAt: Date.now(),
     });

     return success({
       message: 'Dashboard preferences updated',
       preferences: { cardOrder },
     });
   }, 'Config/Dashboard');
   ```

Directory note: Create `app/api/config/dashboard/` directory structure.
  </action>
  <verify>
```bash
# Check file exists
ls -la app/api/config/dashboard/route.js

# Verify handlers
grep -E "export const (GET|POST)" app/api/config/dashboard/route.js
```
  </verify>
  <done>
- GET /api/config/dashboard returns stored or default preferences
- POST /api/config/dashboard saves cardOrder array
- Validation ensures cardOrder is array with { id, visible } objects
- Auth required via withAuthAndErrorHandler
  </done>
</task>

<task type="auto">
  <name>Task 3: Add weather cache unit tests</name>
  <files>lib/__tests__/weatherCache.test.js</files>
  <action>
Create `lib/__tests__/weatherCache.test.js` to verify cache behavior:

1. **Imports and setup**:
   ```javascript
   import { getCachedWeather, clearWeatherCache } from '../weatherCache';

   describe('weatherCache', () => {
     beforeEach(() => {
       clearWeatherCache();
     });
   ```

2. **Test: First call fetches and caches**:
   ```javascript
   it('fetches data on first call', async () => {
     const mockFetch = jest.fn().mockResolvedValue({ temperature: 20 });

     const result = await getCachedWeather(45.4642, 9.19, mockFetch);

     expect(mockFetch).toHaveBeenCalledTimes(1);
     expect(mockFetch).toHaveBeenCalledWith(45.4642, 9.19);
     expect(result.data).toEqual({ temperature: 20 });
     expect(result.stale).toBe(false);
     expect(result.cachedAt).toBeDefined();
   });
   ```

3. **Test: Second call returns cached data**:
   ```javascript
   it('returns cached data on second call within TTL', async () => {
     const mockFetch = jest.fn().mockResolvedValue({ temperature: 20 });

     const result1 = await getCachedWeather(45.4642, 9.19, mockFetch);
     const result2 = await getCachedWeather(45.4642, 9.19, mockFetch);

     expect(mockFetch).toHaveBeenCalledTimes(1); // Only called once
     expect(result2.data).toEqual({ temperature: 20 });
     expect(result2.stale).toBe(false);
     expect(result2.cachedAt).toBe(result1.cachedAt);
   });
   ```

4. **Test: Cache key uses rounded coordinates**:
   ```javascript
   it('normalizes coordinates to 4 decimal places for cache key', async () => {
     const mockFetch = jest.fn().mockResolvedValue({ temperature: 20 });

     // These should hit the same cache entry
     await getCachedWeather(45.46423456, 9.19001234, mockFetch);
     await getCachedWeather(45.4642, 9.19, mockFetch);

     expect(mockFetch).toHaveBeenCalledTimes(1);
   });
   ```

5. **Test: Different locations are cached separately**:
   ```javascript
   it('caches different locations separately', async () => {
     const mockFetch = jest.fn()
       .mockResolvedValueOnce({ temperature: 20 })
       .mockResolvedValueOnce({ temperature: 25 });

     const result1 = await getCachedWeather(45.4642, 9.19, mockFetch);
     const result2 = await getCachedWeather(41.9028, 12.4964, mockFetch);

     expect(mockFetch).toHaveBeenCalledTimes(2);
     expect(result1.data.temperature).toBe(20);
     expect(result2.data.temperature).toBe(25);
   });
   ```

6. **Test: clearWeatherCache works**:
   ```javascript
   it('clearWeatherCache removes all cached data', async () => {
     const mockFetch = jest.fn().mockResolvedValue({ temperature: 20 });

     await getCachedWeather(45.4642, 9.19, mockFetch);
     clearWeatherCache();
     await getCachedWeather(45.4642, 9.19, mockFetch);

     expect(mockFetch).toHaveBeenCalledTimes(2);
   });
   ```

Close describe block properly.

Note: Directory `lib/__tests__/` already exists based on `ls` output earlier.
  </action>
  <verify>
```bash
# Run the specific test file
npm test -- lib/__tests__/weatherCache.test.js --passWithNoTests

# Or just verify file exists and is valid JS
node --check lib/__tests__/weatherCache.test.js 2>/dev/null || head -50 lib/__tests__/weatherCache.test.js
```
  </verify>
  <done>
- Tests cover: first fetch, cache hit, coordinate normalization, separate locations, cache clearing
- Tests use mock fetch function to avoid real API calls
- clearWeatherCache called in beforeEach for test isolation
  </done>
</task>

</tasks>

<verification>
All tasks verified:
1. `lib/services/dashboardPreferencesService.js` exports all functions and DEFAULT_CARD_ORDER
2. `app/api/config/dashboard/route.js` exports GET and POST
3. `lib/__tests__/weatherCache.test.js` exists with comprehensive tests
4. Tests pass: `npm test -- lib/__tests__/weatherCache.test.js`
</verification>

<success_criteria>
- Dashboard preferences service provides get/set/subscribe functions
- DEFAULT_CARD_ORDER includes stove, thermostat, weather, lights, camera
- GET /api/config/dashboard returns preferences or defaults
- POST /api/config/dashboard validates and saves cardOrder
- Weather cache tests pass and verify:
  - First call fetches data
  - Second call returns cached data without fetching
  - Coordinate precision normalized to 4 decimals
  - Different locations cached separately
</success_criteria>

<output>
After completion, create `.planning/phases/25-weather-foundation/25-03-SUMMARY.md`
</output>
