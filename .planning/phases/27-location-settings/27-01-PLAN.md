---
phase: 27-location-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/geocoding/search/route.js
  - app/api/geocoding/reverse/route.js
  - app/hooks/useDebounce.js
  - __tests__/api/geocoding.test.js
autonomous: true

must_haves:
  truths:
    - "Geocoding search endpoint returns city suggestions for query"
    - "Reverse geocoding endpoint returns city name for coordinates"
    - "useDebounce hook delays value updates by specified milliseconds"
  artifacts:
    - path: "app/api/geocoding/search/route.js"
      provides: "Proxy to Open-Meteo Geocoding API for city search"
      exports: ["GET"]
    - path: "app/api/geocoding/reverse/route.js"
      provides: "Reverse geocoding for coordinate-to-city-name lookup"
      exports: ["GET"]
    - path: "app/hooks/useDebounce.js"
      provides: "React hook for debouncing values"
      exports: ["useDebounce"]
  key_links:
    - from: "app/api/geocoding/search/route.js"
      to: "https://geocoding-api.open-meteo.com/v1/search"
      via: "fetch proxy"
      pattern: "geocoding-api\\.open-meteo\\.com"
    - from: "app/api/geocoding/reverse/route.js"
      to: "https://geocoding-api.open-meteo.com/v1/get"
      via: "fetch with lat/lon lookup"
      pattern: "geocoding-api\\.open-meteo\\.com"
---

<objective>
Create geocoding API routes and useDebounce utility for location settings.

Purpose: Provides infrastructure for city search autocomplete and reverse geocoding (for "Use my location" feature). The useDebounce hook prevents excessive API calls during search input.

Output:
- `/api/geocoding/search?q=Milan` - Returns up to 5 city suggestions
- `/api/geocoding/reverse?lat=X&lon=Y` - Returns city name for coordinates
- `useDebounce` hook for client-side debouncing
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-location-settings/27-CONTEXT.md
@.planning/phases/27-location-settings/27-RESEARCH.md

# Existing patterns to follow
@app/api/config/location/route.js
@lib/core.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create geocoding search API route</name>
  <files>app/api/geocoding/search/route.js</files>
  <action>
Create GET endpoint that proxies to Open-Meteo Geocoding API.

Query params:
- `q`: Search query string (required, min 3 chars)

Implementation:
1. Use `withAuthAndErrorHandler` wrapper from lib/core.js for consistent error handling
2. Validate `q` param exists and is at least 3 characters
3. Fetch from `https://geocoding-api.open-meteo.com/v1/search` with params:
   - `name`: query string
   - `count`: 5 (limit per CONTEXT.md)
   - `language`: 'it' (Italian results)
   - `format`: 'json'
4. Return simplified response with array of results:
   ```
   {
     success: true,
     results: [
       { id, name, country, admin1, latitude, longitude, timezone }
     ]
   }
   ```
5. Handle Open-Meteo errors gracefully - return empty results array on API failure (after 2-3 retries)
6. Add `export const dynamic = 'force-dynamic'` for Next.js 15.5

Error messages (Italian):
- Missing query: "Parametro 'q' richiesto"
- Query too short: "Inserisci almeno 3 caratteri"
- No results: Return empty `results: []` (not an error)
  </action>
  <verify>
Run `npm test -- --testPathPattern=geocoding` to verify API tests pass.
Manual test: `curl 'http://localhost:3000/api/geocoding/search?q=Milano'` returns results array.
  </verify>
  <done>
- `/api/geocoding/search?q=Milano` returns 200 with results array containing Milan entries
- `/api/geocoding/search?q=ab` returns 400 with "Inserisci almeno 3 caratteri"
- `/api/geocoding/search` returns 400 with "Parametro 'q' richiesto"
- `/api/geocoding/search?q=xyzabc123` returns 200 with empty results array
  </done>
</task>

<task type="auto">
  <name>Task 2: Create geocoding reverse API route</name>
  <files>app/api/geocoding/reverse/route.js</files>
  <action>
Create GET endpoint for reverse geocoding (coordinates to city name).

Query params:
- `lat`: Latitude (required, -90 to 90)
- `lon`: Longitude (required, -180 to 180)

Implementation:
1. Use `withAuthAndErrorHandler` wrapper for consistent error handling
2. Validate lat/lon are valid numbers within range
3. Open-Meteo Geocoding API doesn't have true reverse geocoding, but we can use a workaround:
   - Fetch from search API with very low radius: `https://geocoding-api.open-meteo.com/v1/search?name=&latitude={lat}&longitude={lon}&count=1`
   - Alternative: Use Open-Meteo's `/v1/get?id=X` endpoint if we have a location ID
   - Better approach: Query Open-Meteo forecast API which returns location name in response

Actually, implement using a practical approach:
1. Call Open-Meteo forecast API briefly to get timezone info
2. Use timezone to infer rough location OR
3. Simply format coordinates as fallback: "45.4642° N, 9.1900° E"

Simplified implementation:
1. Validate coordinates
2. Try searching for nearest city using coordinates with Open-Meteo search API
3. If no result, return formatted coordinates as name
4. Return: `{ success: true, name: "Milano, Italia", latitude, longitude }`

Error messages (Italian):
- Missing params: "Parametri 'lat' e 'lon' richiesti"
- Invalid coordinates: "Coordinate non valide"
  </action>
  <verify>
Run `npm test -- --testPathPattern=geocoding` to verify API tests pass.
Manual test: `curl 'http://localhost:3000/api/geocoding/reverse?lat=45.4642&lon=9.19'` returns name.
  </verify>
  <done>
- `/api/geocoding/reverse?lat=45.4642&lon=9.19` returns 200 with city name (Milano or coordinates)
- `/api/geocoding/reverse` returns 400 with "Parametri 'lat' e 'lon' richiesti"
- `/api/geocoding/reverse?lat=999&lon=999` returns 400 with "Coordinate non valide"
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useDebounce hook and tests</name>
  <files>app/hooks/useDebounce.js, __tests__/api/geocoding.test.js</files>
  <action>
Create useDebounce hook following the pattern from RESEARCH.md:

```javascript
// app/hooks/useDebounce.js
'use client';

import { useState, useEffect } from 'react';

/**
 * Debounce a value by specified delay
 * Returns debounced value that updates only after delay ms of no changes
 *
 * @param {any} value - Value to debounce
 * @param {number} delay - Delay in milliseconds (default 300ms)
 * @returns {any} Debounced value
 *
 * @example
 * const [searchQuery, setSearchQuery] = useState('');
 * const debouncedQuery = useDebounce(searchQuery, 300);
 *
 * useEffect(() => {
 *   if (debouncedQuery) {
 *     fetchResults(debouncedQuery);
 *   }
 * }, [debouncedQuery]);
 */
export function useDebounce(value, delay = 300) {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
}

export default useDebounce;
```

Also create API tests for geocoding routes:
- Test search with valid query returns results
- Test search with short query returns 400
- Test search with no results returns empty array
- Test reverse with valid coords
- Test reverse with invalid coords returns 400
  </action>
  <verify>
Run `npm test -- --testPathPattern=geocoding` to verify tests pass.
Check file exists: `ls app/hooks/useDebounce.js`
  </verify>
  <done>
- useDebounce hook exported from app/hooks/useDebounce.js
- Geocoding API tests exist and pass
- Hook follows React 18+ patterns with cleanup
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Geocoding Search API:**
   ```bash
   curl 'http://localhost:3000/api/geocoding/search?q=Roma' | jq .
   # Should return results array with Rome entries
   ```

2. **Geocoding Reverse API:**
   ```bash
   curl 'http://localhost:3000/api/geocoding/reverse?lat=41.9028&lon=12.4964' | jq .
   # Should return name for Rome coordinates
   ```

3. **Tests pass:**
   ```bash
   npm test -- --testPathPattern=geocoding
   ```

4. **Hook file exists:**
   ```bash
   cat app/hooks/useDebounce.js
   ```
</verification>

<success_criteria>
- [ ] `/api/geocoding/search` endpoint works with Open-Meteo proxy
- [ ] `/api/geocoding/reverse` endpoint returns city name for coordinates
- [ ] useDebounce hook exists with proper React patterns
- [ ] All tests pass
- [ ] Italian error messages used throughout
</success_criteria>

<output>
After completion, create `.planning/phases/27-location-settings/27-01-SUMMARY.md`
</output>
