---
phase: 27-location-settings
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - app/settings/location/page.js
  - app/components/LocationSearch.js
autonomous: false

must_haves:
  truths:
    - "User can navigate to location settings page"
    - "User can type city name and see autocomplete suggestions"
    - "User can click suggestion to select location"
    - "User can click 'Usa la mia posizione' to auto-detect"
    - "User sees error message when geolocation fails"
    - "Selected location is saved to Firebase"
  artifacts:
    - path: "app/settings/location/page.js"
      provides: "Location settings page with search and geolocation"
      min_lines: 80
    - path: "app/components/LocationSearch.js"
      provides: "Reusable location search component with autocomplete"
      min_lines: 100
  key_links:
    - from: "app/components/LocationSearch.js"
      to: "/api/geocoding/search"
      via: "fetch on debounced query"
      pattern: "fetch.*api/geocoding/search"
    - from: "app/components/LocationSearch.js"
      to: "/api/geocoding/reverse"
      via: "fetch after geolocation"
      pattern: "fetch.*api/geocoding/reverse"
    - from: "app/settings/location/page.js"
      to: "/api/config/location"
      via: "POST to save location"
      pattern: "fetch.*api/config/location"
---

<objective>
Create location settings page with city search autocomplete and geolocation.

Purpose: Users configure their home location for weather display. This is the primary user interface for Phase 27.

Output:
- `/settings/location` page with SettingsLayout
- City search with debounced autocomplete (5 suggestions max)
- "Usa la mia posizione" button with geolocation
- "Avanzate" section for manual coordinate entry
- Save to Firebase via existing API
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-location-settings/27-CONTEXT.md
@.planning/phases/27-location-settings/27-RESEARCH.md

# Patterns to follow
@app/settings/theme/page.js
@app/components/SettingsLayout.js
@lib/geolocation.js
@app/hooks/useDebounce.js

# Prior plan output
@.planning/phases/27-location-settings/27-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LocationSearch component</name>
  <files>app/components/LocationSearch.js</files>
  <action>
Create reusable LocationSearch component with autocomplete functionality.

Props:
- `onLocationSelected(location)`: Callback when location selected. location = { latitude, longitude, name }
- `currentLocation`: Optional current location to display
- `className`: Optional className for styling

Features:
1. **Search input** with debounced autocomplete (300ms delay using useDebounce)
2. **Suggestions dropdown** showing max 5 results from /api/geocoding/search
3. **"Usa la mia posizione" button** using lib/geolocation.js + reverse geocoding
4. **"Avanzate" collapsible section** for manual coordinate entry (hidden by default)
5. **Error display** using Banner component for geolocation/API errors
6. **Loading states** for search and geolocation operations

Implementation details:

```javascript
'use client';

import { useState, useEffect } from 'react';
import { useDebounce } from '@/app/hooks/useDebounce';
import { getCurrentLocation, GEOLOCATION_ERRORS } from '@/lib/geolocation';
import { Input, Button, Banner, Text } from '@/app/components/ui';
import { MapPin, Search, ChevronDown, ChevronUp } from 'lucide-react';

export default function LocationSearch({ onLocationSelected, currentLocation, className }) {
  // Search state
  const [searchQuery, setSearchQuery] = useState('');
  const [suggestions, setSuggestions] = useState([]);
  const [isSearching, setIsSearching] = useState(false);

  // Geolocation state
  const [isLocating, setIsLocating] = useState(false);

  // Manual coordinates state
  const [showAdvanced, setShowAdvanced] = useState(false);
  const [manualLat, setManualLat] = useState('');
  const [manualLon, setManualLon] = useState('');

  // Error state
  const [error, setError] = useState(null);

  // Debounce search query
  const debouncedQuery = useDebounce(searchQuery, 300);

  // Fetch suggestions when debounced query changes
  useEffect(() => {
    if (debouncedQuery.length < 3) {
      setSuggestions([]);
      return;
    }

    const controller = new AbortController();

    const fetchSuggestions = async () => {
      setIsSearching(true);
      setError(null);

      try {
        const response = await fetch(
          `/api/geocoding/search?q=${encodeURIComponent(debouncedQuery)}`,
          { signal: controller.signal }
        );
        const data = await response.json();

        if (data.success) {
          setSuggestions(data.results || []);
          if (data.results.length === 0) {
            setError('Nessun risultato. Prova con un nome pi√π completo o una citt√† vicina.');
          }
        }
      } catch (err) {
        if (err.name !== 'AbortError') {
          setError('Errore durante la ricerca. Riprova.');
        }
      } finally {
        setIsSearching(false);
      }
    };

    fetchSuggestions();
    return () => controller.abort();
  }, [debouncedQuery]);

  // Handle suggestion selection
  const handleSelectSuggestion = (suggestion) => {
    onLocationSelected({
      latitude: suggestion.latitude,
      longitude: suggestion.longitude,
      name: `${suggestion.name}, ${suggestion.country}`,
    });
    setSearchQuery('');
    setSuggestions([]);
    setError(null);
  };

  // Handle "Usa la mia posizione"
  const handleUseMyLocation = async () => {
    setIsLocating(true);
    setError(null);

    try {
      const { latitude, longitude } = await getCurrentLocation();

      // Reverse geocode to get city name
      const response = await fetch(
        `/api/geocoding/reverse?lat=${latitude}&lon=${longitude}`
      );
      const data = await response.json();

      onLocationSelected({
        latitude,
        longitude,
        name: data.name || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`,
      });
    } catch (err) {
      setError(err.message);
    } finally {
      setIsLocating(false);
    }
  };

  // Handle manual coordinate submission
  const handleManualSubmit = () => {
    const lat = parseFloat(manualLat);
    const lon = parseFloat(manualLon);

    if (isNaN(lat) || lat < -90 || lat > 90) {
      setError('Latitudine non valida (deve essere tra -90 e 90)');
      return;
    }
    if (isNaN(lon) || lon < -180 || lon > 180) {
      setError('Longitudine non valida (deve essere tra -180 e 180)');
      return;
    }

    onLocationSelected({
      latitude: lat,
      longitude: lon,
      name: `${lat.toFixed(4)}, ${lon.toFixed(4)}`,
    });
    setShowAdvanced(false);
    setManualLat('');
    setManualLon('');
  };

  return (
    <div className={className}>
      {/* Current location display */}
      {currentLocation && (
        <div className="mb-4 p-3 bg-sage-900/20 rounded-lg border border-sage-700/30">
          <Text variant="tertiary" size="xs" className="mb-1">Posizione attuale</Text>
          <Text weight="medium">{currentLocation.name}</Text>
        </div>
      )}

      {/* Search input */}
      <div className="relative">
        <Input
          label="Cerca citt√†"
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          placeholder="Es. Milano, Roma, Napoli..."
          icon={<Search className="w-4 h-4" />}
        />

        {/* Suggestions dropdown */}
        {suggestions.length > 0 && (
          <ul className="absolute z-10 w-full mt-1 bg-slate-800 rounded-lg border border-slate-700 shadow-lg overflow-hidden">
            {suggestions.map((s) => (
              <li key={s.id}>
                <button
                  type="button"
                  onClick={() => handleSelectSuggestion(s)}
                  className="w-full px-4 py-3 text-left hover:bg-slate-700 transition-colors flex items-center gap-2"
                >
                  <MapPin className="w-4 h-4 text-ocean-400 flex-shrink-0" />
                  <div>
                    <Text weight="medium">{s.name}</Text>
                    <Text variant="tertiary" size="sm">{s.country}{s.admin1 ? `, ${s.admin1}` : ''}</Text>
                  </div>
                </button>
              </li>
            ))}
          </ul>
        )}
      </div>

      {/* Search loading indicator */}
      {isSearching && (
        <Text variant="tertiary" size="sm" className="mt-2">Ricerca in corso...</Text>
      )}

      {/* Geolocation button */}
      <div className="mt-4">
        <Button
          variant="subtle"
          onClick={handleUseMyLocation}
          disabled={isLocating}
          loading={isLocating}
          icon={<MapPin className="w-4 h-4" />}
          className="w-full sm:w-auto"
        >
          Usa la mia posizione
        </Button>
      </div>

      {/* Advanced section toggle */}
      <button
        type="button"
        onClick={() => setShowAdvanced(!showAdvanced)}
        className="mt-4 text-sm text-slate-400 hover:text-slate-300 flex items-center gap-1"
      >
        {showAdvanced ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
        Avanzate
      </button>

      {/* Manual coordinates section */}
      {showAdvanced && (
        <div className="mt-3 p-4 bg-slate-800/40 rounded-lg space-y-3">
          <Text variant="secondary" size="sm">Inserisci coordinate manualmente</Text>
          <div className="grid grid-cols-2 gap-3">
            <Input
              label="Latitudine"
              value={manualLat}
              onChange={(e) => setManualLat(e.target.value)}
              placeholder="45.4642"
              type="number"
              step="0.0001"
            />
            <Input
              label="Longitudine"
              value={manualLon}
              onChange={(e) => setManualLon(e.target.value)}
              placeholder="9.1900"
              type="number"
              step="0.0001"
            />
          </div>
          <Button variant="subtle" size="sm" onClick={handleManualSubmit}>
            Usa coordinate
          </Button>
        </div>
      )}

      {/* Error display */}
      {error && (
        <Banner variant="danger" compact className="mt-4">
          {error}
        </Banner>
      )}
    </div>
  );
}
```

Note: Adjust styling to match design system. Use cn() for conditional classes.
  </action>
  <verify>
Check file exists and has correct structure:
`grep -n "onLocationSelected" app/components/LocationSearch.js`
`grep -n "useDebounce" app/components/LocationSearch.js`
  </verify>
  <done>
- LocationSearch component handles city search with debounced autocomplete
- "Usa la mia posizione" button triggers geolocation
- "Avanzate" section allows manual coordinate entry
- Error states displayed with Banner component
- Search query clears after selection
  </done>
</task>

<task type="auto">
  <name>Task 2: Create location settings page</name>
  <files>app/settings/location/page.js</files>
  <action>
Create location settings page using SettingsLayout pattern from theme page.

Implementation:
1. Use SettingsLayout with title "Posizione" and icon "üìç"
2. Show auth check (redirect to login if not authenticated)
3. Fetch current location from /api/config/location on mount
4. Display LocationSearch component
5. On location selection:
   - Save to Firebase via POST /api/config/location
   - Show success feedback (toast or inline message)
   - Update displayed current location
6. Handle loading states (initial fetch, saving)

Page structure:
```javascript
'use client';

import { useState, useEffect } from 'react';
import { useUser } from '@auth0/nextjs-auth0/client';
import SettingsLayout from '@/app/components/SettingsLayout';
import Card from '@/app/components/ui/Card';
import { Text, Heading, Banner } from '@/app/components/ui';
import Skeleton from '@/app/components/ui/Skeleton';
import LocationSearch from '@/app/components/LocationSearch';

export default function LocationSettingsPage() {
  const { user, isLoading: userLoading } = useUser();
  const [currentLocation, setCurrentLocation] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [saveMessage, setSaveMessage] = useState(null);

  // Fetch current location on mount
  useEffect(() => {
    const fetchLocation = async () => {
      try {
        const response = await fetch('/api/config/location');
        if (response.ok) {
          const data = await response.json();
          setCurrentLocation(data.location);
        }
        // 404 means not configured - that's OK
      } catch (err) {
        console.error('Error fetching location:', err);
      } finally {
        setIsLoading(false);
      }
    };

    if (user) {
      fetchLocation();
    } else if (!userLoading) {
      setIsLoading(false);
    }
  }, [user, userLoading]);

  // Handle location selection from LocationSearch
  const handleLocationSelected = async (location) => {
    setIsSaving(true);
    setSaveMessage(null);

    try {
      const response = await fetch('/api/config/location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(location),
      });

      if (response.ok) {
        setCurrentLocation(location);
        setSaveMessage({ type: 'success', text: 'Posizione salvata!' });
        setTimeout(() => setSaveMessage(null), 3000);
      } else {
        const data = await response.json();
        setSaveMessage({ type: 'error', text: data.error || 'Errore durante il salvataggio' });
      }
    } catch (err) {
      setSaveMessage({ type: 'error', text: 'Errore di connessione' });
    } finally {
      setIsSaving(false);
    }
  };

  // Loading state
  if (userLoading || isLoading) {
    return (
      <SettingsLayout title="Posizione" icon="üìç">
        <Skeleton className="h-64 w-full" />
      </SettingsLayout>
    );
  }

  // Not authenticated
  if (!user) {
    return (
      <SettingsLayout title="Posizione" icon="üìç">
        <Card variant="glass">
          <Text variant="secondary">
            Devi essere autenticato per configurare la posizione.
          </Text>
        </Card>
      </SettingsLayout>
    );
  }

  return (
    <SettingsLayout title="Posizione" icon="üìç">
      {/* Description */}
      <Text variant="secondary">
        Configura la posizione per le previsioni meteo
      </Text>

      {/* Main settings card */}
      <Card variant="glass" className="p-6 sm:p-8">
        <Heading level={2} size="lg" className="mb-4">
          Posizione Meteo
        </Heading>

        <LocationSearch
          onLocationSelected={handleLocationSelected}
          currentLocation={currentLocation}
        />

        {/* Save feedback */}
        {saveMessage && (
          <Banner
            variant={saveMessage.type === 'success' ? 'success' : 'danger'}
            compact
            className="mt-4"
          >
            {saveMessage.text}
          </Banner>
        )}

        {/* Saving indicator */}
        {isSaving && (
          <Banner variant="info" compact className="mt-4">
            Salvataggio in corso...
          </Banner>
        )}
      </Card>

      {/* Info card */}
      <Card variant="glass" className="p-6 sm:p-8 bg-ocean-50/50 [html:not(.dark)_&]:bg-ocean-50/50 bg-ocean-900/10 border border-ocean-200 [html:not(.dark)_&]:border-ocean-200 border-ocean-800">
        <div className="flex gap-3">
          <div className="text-2xl">‚ÑπÔ∏è</div>
          <div className="flex-1">
            <Heading level={3} size="md" variant="info" className="mb-1">
              Posizione Condivisa
            </Heading>
            <Text variant="info" size="sm">
              La posizione √® condivisa per l&apos;intera app. Tutti i dispositivi vedranno lo stesso meteo.
            </Text>
          </div>
        </div>
      </Card>
    </SettingsLayout>
  );
}
```
  </action>
  <verify>
Check page renders:
`npm run dev` then visit http://localhost:3000/settings/location
Verify SettingsLayout structure matches theme page.
  </verify>
  <done>
- `/settings/location` page exists with correct SettingsLayout
- Current location displayed if configured
- LocationSearch component integrated
- Save feedback shown on success/error
- Info card explains shared location
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Location settings page with city search autocomplete and geolocation</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/settings/location
3. Verify page loads with SettingsLayout (back button, title "Posizione")
4. Type "Milano" in search - should see autocomplete suggestions after 3 chars
5. Click a suggestion - should show success message and update current location
6. Click "Usa la mia posizione" - should request geolocation permission
7. If geolocation succeeds, should show saved location
8. If geolocation fails (denied/timeout), should show Italian error message
9. Click "Avanzate" - should show manual coordinate entry
10. Enter coordinates (45.4642, 9.1900) and submit - should save

Expected behaviors:
- Autocomplete shows max 5 results
- Error "Nessun risultato..." shown for no-match queries
- Success banner shown after save
- Current location displayed at top of search area
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Page accessible:**
   Navigate to `/settings/location` - should render without errors

2. **Search works:**
   Type "Roma" - should see autocomplete suggestions

3. **Selection saves:**
   Click suggestion - should save and show confirmation

4. **Geolocation works:**
   Click "Usa la mia posizione" - should request permission and save

5. **Errors handled:**
   Deny geolocation - should show Italian error message
</verification>

<success_criteria>
- [ ] LocationSearch component created with debounced autocomplete
- [ ] Location settings page accessible at /settings/location
- [ ] City search shows max 5 suggestions
- [ ] "Usa la mia posizione" triggers geolocation
- [ ] Selected location saved to Firebase
- [ ] Success/error feedback shown
- [ ] All error messages in Italian
- [ ] Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/27-location-settings/27-02-SUMMARY.md`
</output>
