---
phase: 27-location-settings
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - app/components/weather/WeatherCard.jsx
  - app/components/weather/CurrentConditions.jsx
  - app/components/weather/weatherHelpers.js
  - app/api/weather/forecast/route.js
  - lib/openMeteo.js
autonomous: true

must_haves:
  truths:
    - "WeatherCard displays configured location name"
    - "User sees temperature trend indicator when hourly data available"
    - "Weather API returns hourly data for trend calculation"
  artifacts:
    - path: "app/components/weather/WeatherCard.jsx"
      provides: "Location name display in header"
      contains: "locationName"
    - path: "app/components/weather/CurrentConditions.jsx"
      provides: "Temperature trend indicator with arrow"
      contains: "TrendingUp|TrendingDown"
    - path: "app/components/weather/weatherHelpers.js"
      provides: "Temperature trend calculation function"
      exports: ["getTemperatureTrend"]
  key_links:
    - from: "app/components/weather/WeatherCard.jsx"
      to: "locationName prop"
      via: "prop display in header"
      pattern: "locationName"
    - from: "app/components/weather/CurrentConditions.jsx"
      to: "weatherHelpers.js"
      via: "getTemperatureTrend import"
      pattern: "import.*getTemperatureTrend"
    - from: "app/api/weather/forecast/route.js"
      to: "lib/openMeteo.js"
      via: "hourly data fetch"
      pattern: "hourly"
---

<objective>
Add location display and temperature trend to WeatherCard.

Purpose: Completes the weather display by showing the configured location name and temperature trend indicator (WEATHER-09 requirement). Users can see at a glance where the weather is for and whether temperature is rising/falling.

Output:
- WeatherCard shows location name in header (e.g., "Meteo - Milano")
- CurrentConditions shows temperature trend arrow (TrendingUp/TrendingDown icons)
- Weather API returns hourly data for trend calculation
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-location-settings/27-CONTEXT.md
@.planning/phases/26-weather-component/26-04-SUMMARY.md

# Files to modify
@app/components/weather/WeatherCard.jsx
@app/components/weather/CurrentConditions.jsx
@app/components/weather/weatherHelpers.js
@app/api/weather/forecast/route.js
@lib/openMeteo.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hourly data to weather API</name>
  <files>lib/openMeteo.js, app/api/weather/forecast/route.js</files>
  <action>
Update Open-Meteo client and API route to include hourly temperature data for trend calculation.

**1. Update lib/openMeteo.js - fetchWeatherForecast function:**

Add hourly temperature data to the API request. Modify the `hourly` parameter to include:
- `temperature_2m` - hourly temperatures for past few hours

The Open-Meteo API supports `past_hours` parameter to get historical hourly data.
Add `past_hours=6` and `forecast_hours=1` to get last 6 hours + current hour.

Updated params should include:
```javascript
hourly: 'temperature_2m',
past_hours: 6,
forecast_hours: 1,
```

**2. Update app/api/weather/forecast/route.js:**

Process hourly data and return it in the response for trend calculation:

```javascript
// Extract hourly temperatures from response
const hourlyTemps = data.hourly?.temperature_2m || [];
const hourlyTimes = data.hourly?.time || [];

// Return hourly data for trend calculation
return success({
  current: { ... },
  forecast: dailyForecast,
  hourly: {
    times: hourlyTimes,
    temperatures: hourlyTemps,
  },
  cachedAt,
  stale,
});
```

This gives the frontend data to calculate whether temperature is trending up or down.
  </action>
  <verify>
Test API returns hourly data:
`curl 'http://localhost:3000/api/weather/forecast?lat=45.46&lon=9.19' | jq '.hourly'`
Should return times and temperatures arrays.
  </verify>
  <done>
- Weather API returns hourly.times and hourly.temperatures arrays
- Past 6 hours + current hour included for trend analysis
- Existing current/forecast data unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Add temperature trend helper</name>
  <files>app/components/weather/weatherHelpers.js, app/components/weather/index.js</files>
  <action>
Add getTemperatureTrend function to calculate temperature direction.

**Add to weatherHelpers.js:**

```javascript
/**
 * Calculate temperature trend from hourly data
 * Compares recent hours to determine if temp is rising, falling, or stable
 *
 * @param {number[]} temperatures - Array of hourly temperatures (oldest to newest)
 * @returns {'rising' | 'falling' | 'stable' | null} Trend direction or null if insufficient data
 *
 * @example
 * getTemperatureTrend([15, 16, 17, 18, 19, 20, 21]) // 'rising'
 * getTemperatureTrend([21, 20, 19, 18, 17, 16, 15]) // 'falling'
 * getTemperatureTrend([18, 18, 18, 18, 18, 18, 18]) // 'stable'
 */
export function getTemperatureTrend(temperatures) {
  // Need at least 3 data points for meaningful trend
  if (!temperatures || temperatures.length < 3) {
    return null;
  }

  // Compare average of last 3 hours to average of first 3 hours
  const recentHours = temperatures.slice(-3);
  const earlierHours = temperatures.slice(0, 3);

  const recentAvg = recentHours.reduce((a, b) => a + b, 0) / recentHours.length;
  const earlierAvg = earlierHours.reduce((a, b) => a + b, 0) / earlierHours.length;

  const diff = recentAvg - earlierAvg;

  // Threshold: 1째C change considered meaningful
  if (diff > 1) {
    return 'rising';
  } else if (diff < -1) {
    return 'falling';
  } else {
    return 'stable';
  }
}
```

**Update index.js barrel export:**

Add getTemperatureTrend to the exports.
  </action>
  <verify>
Check function is exported:
`grep "getTemperatureTrend" app/components/weather/index.js`
  </verify>
  <done>
- getTemperatureTrend function calculates trend from hourly temps
- Returns 'rising', 'falling', 'stable', or null
- 1째C threshold for meaningful change
- Exported from barrel file
  </done>
</task>

<task type="auto">
  <name>Task 3: Update WeatherCard and CurrentConditions</name>
  <files>app/components/weather/WeatherCard.jsx, app/components/weather/CurrentConditions.jsx</files>
  <action>
**1. Update WeatherCard.jsx:**

Add locationName prop and display in header:

```javascript
// Updated props
export function WeatherCard({
  weatherData = null,
  locationName = null, // NEW: Location name to display
  indoorTemp = null,
  isLoading = false,
  error = null,
  onRetry = () => {},
}) {
```

Update title display - if locationName provided, show "Meteo - {locationName}":

```javascript
<SmartHomeCard
  icon={<CloudSun className="w-6 h-6 sm:w-8 sm:h-8" />}
  title={locationName ? `Meteo - ${locationName}` : 'Meteo'}
  colorTheme="ocean"
>
```

Pass hourly data to CurrentConditions for trend:

```javascript
const { current, forecast, hourly, cachedAt, stale } = weatherData;

// ...

<CurrentConditions
  current={current}
  todayForecast={todayForecast}
  hourlyTemperatures={hourly?.temperatures} // NEW
  indoorTemp={indoorTemp}
/>
```

**2. Update CurrentConditions.jsx:**

Add hourlyTemperatures prop and trend display:

```javascript
import { TrendingUp, TrendingDown, Minus } from 'lucide-react';
import { getTemperatureTrend } from './weatherHelpers';

export function CurrentConditions({
  current,
  todayForecast = null,
  hourlyTemperatures = null, // NEW
  indoorTemp = null
}) {
```

Calculate and display trend near temperature:

```javascript
// Calculate trend
const trend = getTemperatureTrend(hourlyTemperatures);

// Trend icon component
const TrendIcon = trend === 'rising'
  ? <TrendingUp className="w-4 h-4 text-ember-400" />
  : trend === 'falling'
  ? <TrendingDown className="w-4 h-4 text-ocean-400" />
  : null; // Don't show icon for 'stable' or null
```

Display trend next to temperature:

```javascript
<div className="flex items-baseline gap-3 mb-1">
  <Text
    size="4xl"
    weight="bold"
    className="leading-none"
  >
    {formatTemperature(temperature)}째
  </Text>
  {/* Trend indicator */}
  {TrendIcon && (
    <span className="flex items-center" title={trend === 'rising' ? 'In aumento' : 'In diminuzione'}>
      {TrendIcon}
    </span>
  )}
  {/* Today's min/max */}
  {todayForecast && (
    // ... existing code
  )}
</div>
```

The trend icon appears between the current temperature and the min/max display.
  </action>
  <verify>
Check props added:
`grep -n "locationName" app/components/weather/WeatherCard.jsx`
`grep -n "hourlyTemperatures" app/components/weather/CurrentConditions.jsx`
`grep -n "TrendingUp" app/components/weather/CurrentConditions.jsx`
  </verify>
  <done>
- WeatherCard accepts locationName prop and displays in header
- CurrentConditions accepts hourlyTemperatures prop
- Temperature trend icon displayed (TrendingUp/TrendingDown)
- Trend only shown when meaningful (rising/falling, not stable)
- Italian tooltips on trend icons
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **API returns hourly data:**
   ```bash
   curl 'http://localhost:3000/api/weather/forecast?lat=45.46&lon=9.19' | jq '.hourly'
   ```

2. **Helper function works:**
   ```javascript
   // In browser console or test
   getTemperatureTrend([15, 16, 17, 18, 19, 20, 21]) === 'rising'
   getTemperatureTrend([21, 20, 19, 18, 17, 16, 15]) === 'falling'
   ```

3. **WeatherCard shows location:**
   Render WeatherCard with locationName prop - should show "Meteo - {name}"

4. **Trend icon displays:**
   Visit /debug/weather-test with real API data - should show trend arrow
</verification>

<success_criteria>
- [ ] Weather API returns hourly.times and hourly.temperatures
- [ ] getTemperatureTrend function exported from weatherHelpers
- [ ] WeatherCard accepts and displays locationName prop
- [ ] CurrentConditions shows trend icon when hourly data available
- [ ] Trend threshold is 1째C for meaningful change
- [ ] No trend icon shown for stable temperatures
</success_criteria>

<output>
After completion, create `.planning/phases/27-location-settings/27-03-SUMMARY.md`
</output>
