---
phase: 28-dashboard-customization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/config/dashboard/route.js
  - lib/services/dashboardPreferencesService.js
  - lib/devices/deviceTypes.js
autonomous: true

must_haves:
  truths:
    - "Dashboard API accepts userId parameter for per-user storage"
    - "Dashboard service reads/writes to user-specific Firebase paths"
    - "Menu shows 'Personalizza home' option in settings dropdown"
  artifacts:
    - path: "app/api/config/dashboard/route.js"
      provides: "Per-user dashboard preferences API"
      contains: "users/${userId}/dashboardPreferences"
    - path: "lib/services/dashboardPreferencesService.js"
      provides: "Per-user client service"
      exports: ["getDashboardPreferences", "setDashboardPreferences", "DEFAULT_CARD_ORDER"]
    - path: "lib/devices/deviceTypes.js"
      provides: "Dashboard menu item"
      contains: "DASHBOARD"
  key_links:
    - from: "app/api/config/dashboard/route.js"
      to: "Firebase RTDB"
      via: "adminDbGet/adminDbSet with user path"
      pattern: "users.*dashboardPreferences"
    - from: "lib/devices/deviceTypes.js"
      to: "/settings/dashboard"
      via: "SETTINGS_MENU.DASHBOARD"
      pattern: "/settings/dashboard"
---

<objective>
Refactor dashboard preferences infrastructure for per-user storage and add menu navigation.

Purpose: Enable each user to have their own dashboard card order (not shared app-wide). Prepare infrastructure for the settings page.
Output: API route and service using per-user Firebase paths, menu item added to navigation.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-dashboard-customization/28-CONTEXT.md
@.planning/phases/28-dashboard-customization/28-RESEARCH.md
@app/api/config/dashboard/route.js
@lib/services/dashboardPreferencesService.js
@lib/devices/deviceTypes.js
@app/api/config/location/route.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor API route for per-user storage</name>
  <files>app/api/config/dashboard/route.js</files>
  <action>
Refactor the existing API route to support per-user dashboard preferences:

1. GET endpoint:
   - Extract userId from Auth0 session (`session.user.sub`)
   - Use Firebase path `users/${userId}/dashboardPreferences` (NOT `config/dashboard`)
   - Return user's preferences or DEFAULT_CARD_ORDER if none exist
   - Do NOT use getEnvironmentPath for user paths (users/ is already namespaced)

2. POST endpoint:
   - Same userId extraction from session
   - Validate cardOrder array structure (existing validation is fine)
   - Save to `users/${userId}/dashboardPreferences` with updatedAt timestamp
   - Return success with saved preferences

Key changes:
- Replace `getEnvironmentPath('config/dashboard')` with direct `users/${userId}/dashboardPreferences`
- Add userId extraction from auth session (pattern from location/route.js: `const session = await auth0.getSession()`)
- Keep existing validation logic for cardOrder

Reference the location API route pattern but note: location uses shared config, dashboard uses per-user.

Do NOT use dev/ prefix for user paths - they are already isolated per user.
  </action>
  <verify>
Read the updated file and confirm:
- GET uses `users/${userId}/dashboardPreferences` path
- POST uses same per-user path
- userId comes from `session.user.sub`
- Validation unchanged
  </verify>
  <done>
API route reads/writes to user-specific Firebase path, authenticated via Auth0 session.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor client service for per-user storage</name>
  <files>lib/services/dashboardPreferencesService.js</files>
  <action>
Refactor the client service to accept userId parameter:

1. Update getDashboardPreferences(userId):
   - Add userId parameter (required)
   - Return early with defaults if no userId provided
   - Use path `users/${userId}/dashboardPreferences`
   - Keep existing return shape { cardOrder: [...] }

2. Update setDashboardPreferences(userId, { cardOrder }):
   - Add userId as first parameter
   - Throw error if userId not provided
   - Use path `users/${userId}/dashboardPreferences`
   - Keep updatedAt timestamp

3. Update subscribeToDashboardPreferences(userId, callback):
   - Add userId parameter
   - Subscribe to user-specific path

4. Keep DEFAULT_CARD_ORDER unchanged (add icon field for each card):
   - { id: 'stove', label: 'Stufa', icon: 'üî•', visible: true }
   - { id: 'thermostat', label: 'Termostato', icon: 'üå°Ô∏è', visible: true }
   - { id: 'weather', label: 'Meteo', icon: '‚òÄÔ∏è', visible: true }
   - { id: 'lights', label: 'Luci', icon: 'üí°', visible: true }
   - { id: 'camera', label: 'Telecamera', icon: 'üìπ', visible: true }

Remove getEnvironmentPath import - user paths don't need env prefixing.

JSDoc comments should document the userId parameter requirement.
  </action>
  <verify>
Read updated file and confirm:
- All three functions accept userId as first parameter
- Path pattern is `users/${userId}/dashboardPreferences`
- DEFAULT_CARD_ORDER includes icon field for each card
- No getEnvironmentPath usage
  </verify>
  <done>
Client service operates on per-user Firebase paths, icons added to default card order.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add dashboard settings to navigation menu</name>
  <files>lib/devices/deviceTypes.js</files>
  <action>
Add "Personalizza home" to SETTINGS_MENU:

1. Add new entry DASHBOARD in SETTINGS_MENU object:
   ```javascript
   DASHBOARD: {
     id: 'dashboard',
     name: 'Personalizza home',
     icon: 'üè†',
     route: '/settings/dashboard',
     description: 'Ordine e visibilit√† card',
   },
   ```

2. Position it AFTER LOCATION (since both are customization settings):
   - DEVICES
   - NOTIFICATIONS
   - THEME
   - LOCATION
   - DASHBOARD  <-- new
   - LOG
   - CHANGELOG
   - DEBUG

Keep all other entries unchanged.
  </action>
  <verify>
Read updated file and confirm:
- DASHBOARD entry exists in SETTINGS_MENU
- Route is '/settings/dashboard'
- Name is 'Personalizza home'
- Position is after LOCATION
  </verify>
  <done>
"Personalizza home" appears in settings dropdown menu, links to /settings/dashboard.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. API endpoints are per-user:
   - Check route.js uses `users/${userId}/dashboardPreferences`
   - userId from session.user.sub

2. Service is per-user:
   - Check all functions take userId parameter
   - DEFAULT_CARD_ORDER has icon field

3. Menu item exists:
   - Check SETTINGS_MENU.DASHBOARD in deviceTypes.js
   - Route is /settings/dashboard
</verification>

<success_criteria>
- Dashboard preferences API uses per-user Firebase paths
- Dashboard preferences service accepts userId parameter
- DEFAULT_CARD_ORDER includes icon field for each card
- "Personalizza home" appears in settings menu
- Route /settings/dashboard is registered in navigation
</success_criteria>

<output>
After completion, create `.planning/phases/28-dashboard-customization/28-01-SUMMARY.md`
</output>
