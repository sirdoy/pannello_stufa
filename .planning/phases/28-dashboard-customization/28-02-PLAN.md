---
phase: 28-dashboard-customization
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - app/settings/dashboard/page.js
autonomous: false

must_haves:
  truths:
    - "User can navigate to dashboard settings page from menu"
    - "User can see all cards with icon, name, and visibility state"
    - "User can reorder cards using up/down buttons"
    - "User can toggle card visibility with switches"
    - "User can save changes with Save button"
    - "Saved preferences persist across page refresh"
  artifacts:
    - path: "app/settings/dashboard/page.js"
      provides: "Dashboard customization settings page"
      min_lines: 150
  key_links:
    - from: "app/settings/dashboard/page.js"
      to: "/api/config/dashboard"
      via: "fetch in useEffect and handleSave"
      pattern: "fetch.*api/config/dashboard"
    - from: "app/settings/dashboard/page.js"
      to: "user.sub"
      via: "useUser hook"
      pattern: "useUser"
---

<objective>
Create the dashboard customization settings page with card reordering and visibility toggles.

Purpose: Allow users to personalize their home page by reordering cards and hiding ones they don't need.
Output: Fully functional settings page at /settings/dashboard with manual save.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-dashboard-customization/28-CONTEXT.md
@.planning/phases/28-dashboard-customization/28-RESEARCH.md
@.planning/phases/28-dashboard-customization/28-01-SUMMARY.md
@app/settings/location/page.js
@app/components/SettingsLayout.js
@app/components/ui/Switch.js
@app/components/ui/Button.js
@app/components/ui/Card.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard settings page with full functionality</name>
  <files>app/settings/dashboard/page.js</files>
  <action>
Create the dashboard settings page following location settings page pattern but with:

**Page Structure:**
```javascript
'use client';

import { useState, useEffect } from 'react';
import { useUser } from '@auth0/nextjs-auth0/client';
import SettingsLayout from '@/app/components/SettingsLayout';
import Card from '@/app/components/ui/Card';
import Button from '@/app/components/ui/Button';
import Switch from '@/app/components/ui/Switch';
import { Text, Badge, Banner } from '@/app/components/ui';
import Skeleton from '@/app/components/ui/Skeleton';
import { ChevronUp, ChevronDown } from 'lucide-react';
```

**Key Components:**

1. **Page wrapper**: SettingsLayout with title="Personalizza home" icon="ðŸ "

2. **Card list**: Map over cards array showing each with:
   - Icon (emoji) + Label
   - "Nascosto" Badge when !card.visible (variant="subtle")
   - Switch for visibility toggle (variant="ember", size="sm")
   - Up/Down buttons (variant="ghost", size="sm", iconOnly)
   - Visual muting for hidden cards: className with opacity-60 when !visible

3. **Card item layout** (flex row):
   ```
   [Icon] [Label + Badge] -------- [Switch] [Up] [Down]
   ```
   - Left side: flex items-center gap-3
   - Right side: flex items-center gap-4
   - Use Card component with variant="glass" for each item
   - Add className to mute hidden cards: `${card.visible ? '' : 'opacity-60'}`

4. **Button states**:
   - Up button: disabled={index === 0}
   - Down button: disabled={index === cards.length - 1}
   - Use disabled prop (NOT hidden) - consistent layout, shows why unavailable

5. **Save section**: Button at bottom-right, variant="ember", loading state

**State Management:**
```javascript
const [cards, setCards] = useState([]);
const [isLoading, setIsLoading] = useState(true);
const [isSaving, setIsSaving] = useState(false);
const [saveMessage, setSaveMessage] = useState(null);
```

**Data Flow:**

1. Load on mount:
   - Fetch from `/api/config/dashboard`
   - Set cards from response.preferences.cardOrder
   - Handle loading/error states

2. Reorder functions (immutable updates):
   ```javascript
   const moveUp = (index) => {
     if (index === 0) return;
     setCards(prev => {
       const newCards = [...prev];
       [newCards[index - 1], newCards[index]] = [newCards[index], newCards[index - 1]];
       return newCards;
     });
   };

   const moveDown = (index) => {
     if (index === cards.length - 1) return;
     setCards(prev => {
       const newCards = [...prev];
       [newCards[index], newCards[index + 1]] = [newCards[index + 1], newCards[index]];
       return newCards;
     });
   };
   ```

3. Toggle visibility:
   ```javascript
   const toggleVisibility = (index, newVisible) => {
     setCards(prev => prev.map((card, i) =>
       i === index ? { ...card, visible: newVisible } : card
     ));
   };
   ```

4. Save handler:
   - POST to `/api/config/dashboard` with { cardOrder: cards }
   - Show success/error Banner
   - Clear message after 3 seconds

**Loading state:** Show Skeleton in SettingsLayout
**Not authenticated:** Show message in Card

**Button placement (Claude's discretion):** Place buttons on RIGHT side of each card item

**No instruction text:** UI is self-explanatory (per CONTEXT.md)

**No animation on reorder:** Instant swap for fastest perceived response (per RESEARCH.md recommendation)
  </action>
  <verify>
1. Run dev server: page loads at /settings/dashboard
2. Read file and verify:
   - Uses SettingsLayout with "Personalizza home" title
   - Maps over cards with icon, label, switch, up/down buttons
   - moveUp/moveDown use immutable array updates
   - toggleVisibility uses immutable update
   - Save button POSTs to /api/config/dashboard
   - Hidden cards show Badge and have opacity-60
   - Button disabled states for first/last items
  </verify>
  <done>
Dashboard settings page renders all cards with reorder and visibility controls.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Dashboard customization settings page with:
- Card list showing icon + name for each card
- Up/down buttons for reordering
- Toggle switches for visibility
- Hidden cards appear muted with "Nascosto" badge
- Manual Save button
  </what-built>
  <how-to-verify>
1. Start dev server if not running: `npm run dev`
2. Navigate to http://localhost:3000
3. Open the menu and go to Impostazioni > Personalizza home
4. Verify page loads with all 5 cards (Stufa, Termostato, Meteo, Luci, Telecamera)
5. Test reorder:
   - Click down arrow on first card - it should move to position 2
   - Click up arrow - it should return to position 1
   - First card's up button should be disabled
   - Last card's down button should be disabled
6. Test visibility:
   - Toggle switch OFF on any card
   - Card should become muted (lower opacity) and show "Nascosto" badge
   - Toggle it back ON - should return to normal
7. Test save:
   - Make some changes (reorder, hide a card)
   - Click "Salva" button
   - Should see success message
8. Test persistence:
   - Refresh the page
   - Changes should persist (same order, same visibility)
9. Test per-user:
   - If you have another test account, log in with it
   - Should see DEFAULT order (not the changes from other user)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:

1. Page accessible from menu:
   - Navigate via Impostazioni > Personalizza home
   - URL is /settings/dashboard

2. All functionality works:
   - Cards display with icon and name
   - Reorder with up/down buttons
   - Visibility toggle with switches
   - Save persists changes
   - Hidden cards muted with badge

3. Per-user isolation:
   - Each user has their own preferences
   - Changes don't affect other users
</verification>

<success_criteria>
- User can navigate to dashboard layout settings page (DASH-01)
- User can reorder cards using up/down buttons (DASH-02)
- User can toggle card visibility (DASH-03)
- User's preferences persist across sessions (DASH-04)
- Dashboard preferences stored in Firebase RTDB per-user (INFRA-02)
</success_criteria>

<output>
After completion, create `.planning/phases/28-dashboard-customization/28-02-SUMMARY.md`
</output>
