---
phase: 29-home-page-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/weather/WeatherCardWrapper.js
  - app/page.js
autonomous: true

must_haves:
  truths:
    - "Home page renders cards in user's saved order from dashboard preferences"
    - "Home page hides cards user has disabled (visible: false)"
    - "WeatherCard appears in the card list alongside other device cards"
    - "New users see all 5 cards in default order (stove, thermostat, weather, lights, camera)"
  artifacts:
    - path: "app/components/devices/weather/WeatherCardWrapper.js"
      provides: "Client wrapper for WeatherCard with location subscription and weather fetch"
      min_lines: 40
    - path: "app/page.js"
      provides: "Home page rendering cards from dashboard preferences"
      contains: "CARD_COMPONENTS"
  key_links:
    - from: "app/page.js"
      to: "users/${userId}/dashboardPreferences"
      via: "adminDbGet server-side fetch"
      pattern: "adminDbGet.*dashboardPreferences"
    - from: "app/page.js"
      to: "app/components/devices/weather/WeatherCardWrapper.js"
      via: "CARD_COMPONENTS registry"
      pattern: "weather.*WeatherCardWrapper"
    - from: "app/components/devices/weather/WeatherCardWrapper.js"
      to: "/api/weather/forecast"
      via: "fetch in useEffect"
      pattern: "fetch.*api/weather/forecast"
---

<objective>
Render home page cards from user's dashboard preferences instead of legacy device preferences.

Purpose: Complete the v3.2 milestone by integrating WeatherCard into the home page and respecting user's card order/visibility preferences from Phase 28.
Output: Home page that renders 5 cards (stove, thermostat, weather, lights, camera) in user's saved order with visibility control.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-home-page-integration/29-RESEARCH.md

# Existing infrastructure
@lib/services/dashboardPreferencesService.js
@lib/services/locationService.js
@app/components/weather/WeatherCard.jsx
@app/page.js
@lib/firebaseAdmin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WeatherCardWrapper client component</name>
  <files>app/components/devices/weather/WeatherCardWrapper.js</files>
  <action>
Create a client component that wraps WeatherCard with data fetching logic:

1. Create directory `app/components/devices/weather/` if needed
2. Create `WeatherCardWrapper.js` with:
   - 'use client' directive
   - Import WeatherCard from `@/app/components/weather`
   - Import subscribeToLocation from `@/lib/services/locationService`
   - State: location, weatherData, isLoading, error
   - useEffect that subscribes to location changes
   - When location has coordinates, fetch from `/api/weather/forecast?lat={lat}&lon={lon}`
   - Pass weatherData, locationName, isLoading, error, onRetry to WeatherCard
   - Handle case where no location is configured (show WeatherCard with null data)

Pattern from research:
```javascript
'use client';
import { useState, useEffect, useCallback } from 'react';
import { WeatherCard } from '@/app/components/weather';
import { subscribeToLocation } from '@/lib/services/locationService';

export default function WeatherCardWrapper() {
  const [location, setLocation] = useState(null);
  const [weatherData, setWeatherData] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  const fetchWeather = useCallback(async (lat, lon) => {
    setIsLoading(true);
    setError(null);
    try {
      const res = await fetch(`/api/weather/forecast?lat=${lat}&lon=${lon}`);
      if (!res.ok) throw new Error('Impossibile caricare i dati meteo');
      const data = await res.json();
      setWeatherData(data);
    } catch (err) {
      setError(err);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    const unsubscribe = subscribeToLocation((loc) => {
      setLocation(loc);
      if (loc?.latitude && loc?.longitude) {
        fetchWeather(loc.latitude, loc.longitude);
      } else {
        setIsLoading(false);
        setWeatherData(null);
      }
    });
    return () => unsubscribe();
  }, [fetchWeather]);

  const handleRetry = () => {
    if (location?.latitude && location?.longitude) {
      fetchWeather(location.latitude, location.longitude);
    }
  };

  return (
    <WeatherCard
      weatherData={weatherData}
      locationName={location?.name || null}
      isLoading={isLoading}
      error={error}
      onRetry={handleRetry}
    />
  );
}
```
  </action>
  <verify>File exists at app/components/devices/weather/WeatherCardWrapper.js with 'use client' directive, subscribeToLocation import, and WeatherCard render</verify>
  <done>WeatherCardWrapper client component exists and handles location subscription + weather fetching</done>
</task>

<task type="auto">
  <name>Task 2: Update home page to render cards from dashboard preferences</name>
  <files>app/page.js</files>
  <action>
Replace legacy device preferences with dashboard preferences in home page:

1. **Remove old imports:**
   - Remove: `import { getEnabledDevicesForUser } from '@/lib/devicePreferencesService';`

2. **Add new imports:**
   - Add: `import { adminDbGet } from '@/lib/firebaseAdmin';`
   - Add: `import { DEFAULT_CARD_ORDER } from '@/lib/services/dashboardPreferencesService';`
   - Add: `import WeatherCardWrapper from './components/devices/weather/WeatherCardWrapper';`

3. **Create CARD_COMPONENTS registry** (before the Home function):
```javascript
// Card component registry - maps card IDs to React components
const CARD_COMPONENTS = {
  stove: StoveCard,
  thermostat: ThermostatCard,
  weather: WeatherCardWrapper,
  lights: LightsCard,
  camera: CameraCard,
};
```

4. **Replace getEnabledDevicesForUser call with dashboard preferences fetch:**
```javascript
// Fetch dashboard preferences server-side
const dashboardPath = `users/${userId}/dashboardPreferences`;
const preferences = await adminDbGet(dashboardPath);
const cardOrder = preferences?.cardOrder || DEFAULT_CARD_ORDER;

// Filter to only visible cards
const visibleCards = cardOrder.filter(card => card.visible !== false);
```

5. **Update the Grid render section:**
Replace the existing map with if/else chain with:
```javascript
<Grid cols={2} gap="lg">
  {visibleCards.map((card, index) => {
    const CardComponent = CARD_COMPONENTS[card.id];
    if (!CardComponent) return null;

    return (
      <div
        key={card.id}
        className="animate-spring-in"
        style={{ animationDelay: `${index * 100}ms` }}
      >
        <CardComponent />
      </div>
    );
  })}
</Grid>
```

6. **Update empty state check:**
Change `enabledDevices.length === 0` to `visibleCards.length === 0`

7. **Remove the sonos placeholder** (it's not in DEFAULT_CARD_ORDER)

The page should still be a Server Component (async function) that fetches preferences on the server.
  </action>
  <verify>
Verify the changes:
1. `grep -n "adminDbGet" app/page.js` shows import and usage
2. `grep -n "CARD_COMPONENTS" app/page.js` shows registry definition
3. `grep -n "WeatherCardWrapper" app/page.js` shows import and registry entry
4. `grep -n "getEnabledDevicesForUser" app/page.js` returns nothing (removed)
5. `grep -n "DEFAULT_CARD_ORDER" app/page.js` shows import and fallback usage
  </verify>
  <done>
Home page:
- Fetches dashboard preferences server-side using adminDbGet
- Falls back to DEFAULT_CARD_ORDER for new users
- Renders cards using CARD_COMPONENTS registry
- Filters by visibility (card.visible !== false)
- WeatherCard integrated via WeatherCardWrapper
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000 - should see home page with cards
3. Check browser console for errors
4. Cards should appear in order from dashboard preferences (or default order)
5. If location is configured, WeatherCard should show weather data
6. If location not configured, WeatherCard should show "Nessun dato meteo disponibile"
</verification>

<success_criteria>
- [ ] WeatherCardWrapper.js exists with client-side location subscription and weather fetch
- [ ] Home page imports adminDbGet and DEFAULT_CARD_ORDER
- [ ] CARD_COMPONENTS registry maps all 5 card IDs to components
- [ ] getEnabledDevicesForUser is no longer imported or used
- [ ] Cards render in order from dashboard preferences
- [ ] Hidden cards (visible: false) are filtered out
- [ ] New users see all 5 cards in default order
</success_criteria>

<output>
After completion, create `.planning/phases/29-home-page-integration/29-01-SUMMARY.md`
</output>
