---
phase: 30-foundation-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/Popover.js
  - app/components/ui/__tests__/Popover.test.js
  - app/components/ui/index.js
autonomous: true

must_haves:
  truths:
    - "User can click trigger to open/close Popover"
    - "Popover positions correctly within viewport (auto-flip when near edges)"
    - "Click outside closes Popover"
    - "Escape key closes Popover"
    - "Focus is trapped within Popover when open"
  artifacts:
    - path: "app/components/ui/Popover.js"
      provides: "Popover component with CVA variants and namespace pattern"
      exports: ["Popover", "PopoverTrigger", "PopoverContent", "PopoverClose", "PopoverArrow"]
    - path: "app/components/ui/__tests__/Popover.test.js"
      provides: "Unit tests for Popover component"
      min_lines: 80
  key_links:
    - from: "app/components/ui/Popover.js"
      to: "@radix-ui/react-popover"
      via: "Radix primitive wrapper"
      pattern: "PopoverPrimitive"
    - from: "app/components/ui/index.js"
      to: "app/components/ui/Popover.js"
      via: "barrel export"
      pattern: "export.*Popover"
---

<objective>
Create the Popover component using Radix UI primitive with Ember Noir styling and CVA variants.

Purpose: Establish the Popover pattern for tooltips, menus, and info panels across the application. This is a foundation component that will be used by other advanced components (Command Palette, Context Menu).

Output: Production-ready Popover component with click/hover trigger modes, size variants, arrow support, and full accessibility.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-foundation-components/30-CONTEXT.md
@.planning/phases/30-foundation-components/30-RESEARCH.md
@app/components/ui/Modal.js
@app/components/ui/Tooltip.js
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Popover component with CVA variants</name>
  <files>app/components/ui/Popover.js</files>
  <action>
Create Popover component following established patterns from Modal.js and Tooltip.js:

1. **Imports and setup:**
   - Import `@radix-ui/react-popover` as PopoverPrimitive
   - Import cva from class-variance-authority
   - Import cn from @/lib/utils/cn
   - Add 'use client' directive

2. **CVA variants for content:**
   ```javascript
   const contentVariants = cva(
     [
       'z-50 rounded-2xl p-4',
       'bg-slate-900/95 [html:not(.dark)_&]:bg-white/95',
       'backdrop-blur-xl',
       'border border-slate-700/50 [html:not(.dark)_&]:border-slate-200',
       'shadow-card-elevated',
       // Animation - scale from 95% + fade
       'data-[state=open]:animate-scale-in',
       'data-[state=closed]:animate-fade-out',
       // Reduced motion
       'motion-reduce:animate-none',
     ],
     {
       variants: {
         size: {
           sm: 'max-w-xs',    // 320px
           md: 'max-w-sm',    // 384px (default per research)
           lg: 'max-w-md',    // 448px
         },
       },
       defaultVariants: { size: 'md' },
     }
   );
   ```

3. **Hover trigger support:**
   - Support both click (default) and hover trigger modes via `triggerMode` prop
   - For hover: use `openDelay` (default 200ms) and `closeDelay` (default 100ms)
   - Wrap children in div with onMouseEnter/onMouseLeave handlers when hover mode

4. **Component structure (namespace pattern):**
   - `Popover` - Root wrapper with triggerMode support
   - `Popover.Trigger` - Alias to PopoverPrimitive.Trigger
   - `Popover.Content` - Styled content with Portal, size variants, sideOffset
   - `Popover.Close` - Close button primitive
   - `Popover.Arrow` - Optional arrow indicator (renders when `arrow` prop is true)

5. **PopoverContent implementation:**
   - Use Portal for z-index management
   - Default sideOffset={4}
   - Support `side` prop (top/right/bottom/left, default: bottom)
   - Support `align` prop (start/center/end, default: center)
   - Expose `arrow` boolean prop to render Arrow primitive

6. **Arrow styling:**
   ```javascript
   const arrowVariants = cva([
     'fill-slate-900/95 [html:not(.dark)_&]:fill-white/95',
   ]);
   ```

7. **Exports:**
   - Named exports: Popover, PopoverTrigger, PopoverContent, PopoverClose, PopoverArrow
   - Default export: Popover with namespace attached

Focus ring: Use existing pattern `focus-visible:ring-2 focus-visible:ring-ember-500/50`
  </action>
  <verify>File exists at app/components/ui/Popover.js with ~100-150 lines, exports Popover with namespace components</verify>
  <done>Popover component with click/hover trigger modes, size variants (sm/md/lg), optional arrow, Portal rendering, and Ember Noir styling</done>
</task>

<task type="auto">
  <name>Task 2: Add Popover tests and barrel export</name>
  <files>app/components/ui/__tests__/Popover.test.js, app/components/ui/index.js</files>
  <action>
1. **Create test file** at `app/components/ui/__tests__/Popover.test.js`:

Test cases to cover:
- Renders trigger without content when closed
- Opens on click and shows content
- Closes on Escape key
- Closes on click outside
- Positions content correctly (snapshot or visual regression)
- Arrow renders when arrow={true}
- Size variants apply correct max-width classes
- Hover mode: opens on mouseEnter, closes on mouseLeave
- Accessibility: has correct aria attributes (Radix handles, but verify)

Use existing test patterns from Modal.test.js:
- Import from @testing-library/react
- Use userEvent for interactions
- Mock Portal if needed (Radix portals to document.body)

Example test structure:
```javascript
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { Popover } from '../Popover';

describe('Popover', () => {
  it('opens on trigger click', async () => {
    const user = userEvent.setup();
    render(
      <Popover>
        <Popover.Trigger>Open</Popover.Trigger>
        <Popover.Content>Content</Popover.Content>
      </Popover>
    );

    expect(screen.queryByText('Content')).not.toBeInTheDocument();
    await user.click(screen.getByText('Open'));
    expect(screen.getByText('Content')).toBeInTheDocument();
  });

  it('closes on Escape', async () => {
    // ...
  });

  // ... more tests
});
```

2. **Update barrel export** in `app/components/ui/index.js`:

Add after Tooltip exports (line ~53):
```javascript
// Popover (v4.0+)
export { default as Popover, PopoverTrigger, PopoverContent, PopoverClose, PopoverArrow } from './Popover';
```
  </action>
  <verify>`npm test -- Popover` passes all tests; Popover is exported from index.js</verify>
  <done>Popover has 8+ unit tests covering open/close, keyboard, hover mode, and accessibility; component is exported from barrel</done>
</task>

</tasks>

<verification>
1. **Component renders:** Import Popover from `@/app/components/ui` and render basic example
2. **Click trigger:** Clicking trigger opens content, clicking again or outside closes
3. **Keyboard:** Escape closes popover, Tab cycles focus within content
4. **Positioning:** Content appears below trigger by default, flips when near viewport edge
5. **Arrow:** Setting `arrow` prop renders triangle pointing to trigger
6. **Hover mode:** With `triggerMode="hover"`, hovering opens after delay
7. **Tests pass:** `npm test -- Popover` shows all green
8. **Export works:** `import { Popover } from '@/app/components/ui'` resolves correctly
</verification>

<success_criteria>
- Popover component exists with CVA size variants (sm/md/lg)
- Supports both click and hover trigger modes
- Arrow indicator renders when enabled
- All 5 POPV requirements satisfied (click open, positioning, click outside, escape, focus trap)
- Unit tests pass
- Exported from barrel file
</success_criteria>

<output>
After completion, create `.planning/phases/30-foundation-components/30-01-SUMMARY.md`
</output>
