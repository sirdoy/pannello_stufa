---
phase: 32-action-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/RightClickMenu.js
  - app/components/ui/__tests__/RightClickMenu.test.js
  - app/hooks/useLongPress.js
  - app/components/ui/index.js
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "User can right-click on trigger to open Context Menu"
    - "User can navigate menu items with arrow keys"
    - "User can select item with Enter key"
    - "Escape closes menu and restores focus"
    - "Menu positions within viewport (collision detection)"
  artifacts:
    - path: "app/components/ui/RightClickMenu.js"
      provides: "Radix Context Menu with namespace pattern"
      exports: ["RightClickMenu", "RightClickMenuTrigger", "RightClickMenuContent", "RightClickMenuItem", "RightClickMenuCheckboxItem", "RightClickMenuSeparator", "RightClickMenuLabel", "RightClickMenuGroup"]
      min_lines: 150
    - path: "app/components/ui/__tests__/RightClickMenu.test.js"
      provides: "Test coverage for Context Menu"
      min_lines: 200
    - path: "app/hooks/useLongPress.js"
      provides: "Long-press hook wrapper with project defaults"
      exports: ["useLongPress"]
  key_links:
    - from: "app/components/ui/RightClickMenu.js"
      to: "@radix-ui/react-context-menu"
      via: "import"
      pattern: "import.*@radix-ui/react-context-menu"
    - from: "app/components/ui/index.js"
      to: "app/components/ui/RightClickMenu.js"
      via: "barrel export"
      pattern: "export.*RightClickMenu"
---

<objective>
Create RightClickMenu component for right-click context menus with Radix UI primitives.

Purpose: Enable context menus on device cards and other interactive elements. Right-click on desktop triggers menu with proper collision detection, keyboard navigation, and accessibility.
Output: RightClickMenu.js component with namespace pattern, useLongPress hook for mobile support, and comprehensive tests.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-action-components/32-CONTEXT.md
@.planning/phases/32-action-components/32-RESEARCH.md
@app/components/ui/Sheet.js
@app/components/ui/Accordion.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create RightClickMenu component</name>
  <files>
    - package.json
    - package-lock.json
    - app/components/ui/RightClickMenu.js
    - app/hooks/useLongPress.js
  </files>
  <action>
1. Install required packages:
   ```bash
   npm install @radix-ui/react-context-menu use-long-press
   ```

2. Create `app/hooks/useLongPress.js` - wrapper hook with project defaults:
   - Re-export use-long-press with 500ms threshold (platform convention)
   - Export helper for scale animation state (isPressed)
   - Include haptic feedback trigger (navigator.vibrate(10))
   - Add CSS for preventing text selection on iOS

3. Create `app/components/ui/RightClickMenu.js` following Sheet.js patterns:
   - 'use client' directive
   - Import Radix Context Menu primitives
   - Import CVA and cn() utility
   - Create namespace component pattern:
     - RightClickMenu (Root wrapper)
     - RightClickMenu.Trigger
     - RightClickMenu.Content (with CVA variants for styling)
     - RightClickMenu.Item (with icon support, all items have icons per CONTEXT.md)
     - RightClickMenu.CheckboxItem (for toggle states)
     - RightClickMenu.Separator
     - RightClickMenu.Label
     - RightClickMenu.Group

   CVA variants for Content:
   - Ember Noir styling: bg-slate-900/95, backdrop-blur-3xl, rounded-xl
   - Border: border-slate-700/50
   - Shadow: shadow-card-elevated
   - Animation: data-[state=open]:animate-scale-in

   CVA variants for Item:
   - Base: flex items-center gap-3 px-3 py-2 rounded-lg
   - Colors: text-slate-300 [html:not(.dark)_&]:text-slate-700
   - Hover: hover:bg-slate-700/50 [html:not(.dark)_&]:hover:bg-slate-100
   - Focus: focus-visible:ring-2 focus-visible:ring-ember-500/50
   - Disabled: data-[disabled]:opacity-50 data-[disabled]:pointer-events-none
   - NO destructive variant (user decision: rely on label clarity)

4. Add JSDoc documentation with usage examples
5. Export all components individually AND as namespace properties

Key implementation notes:
- Use Radix Portal for overlay (automatic viewport collision)
- forwardRef on all components for ref forwarding
- Apply CSS to prevent text selection during long-press: WebkitUserSelect: 'none', userSelect: 'none', WebkitTouchCallout: 'none'
- Icons are required on all items (user decision from CONTEXT.md)
  </action>
  <verify>
    - `npm test -- --testPathPattern="useLongPress" --passWithNoTests` passes (hook file exists)
    - File exists: `ls app/components/ui/RightClickMenu.js`
    - File exists: `ls app/hooks/useLongPress.js`
    - Package installed: `grep "react-context-menu" package.json`
  </verify>
  <done>
    - RightClickMenu.js created with namespace pattern matching Sheet.js
    - useLongPress hook wrapper created with 500ms threshold and haptic support
    - All Radix Context Menu primitives wrapped with CVA styling
    - No destructive variant (user decision honored)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests and barrel export</name>
  <files>
    - app/components/ui/__tests__/RightClickMenu.test.js
    - app/components/ui/index.js
  </files>
  <action>
1. Create `app/components/ui/__tests__/RightClickMenu.test.js` with comprehensive coverage:

   Test categories (aim for 40+ tests):

   **Rendering (5 tests):**
   - Renders trigger without crashing
   - Does not render content when closed
   - Renders content when opened via contextmenu event
   - Renders multiple items
   - Renders with custom className

   **Right-Click Trigger (5 tests):**
   - Opens on right-click (contextmenu event)
   - Positions content at click coordinates
   - Multiple right-clicks reposition menu
   - Right-click outside closes menu
   - Does not open on regular click

   **Keyboard Navigation (8 tests):**
   - Arrow Down moves to next item
   - Arrow Up moves to previous item
   - Home key moves to first item
   - End key moves to last item
   - Arrow keys wrap at boundaries
   - Enter selects focused item
   - Space selects focused item
   - Tab does not move focus out (focus trapped)

   **Item Selection (5 tests):**
   - Click on item calls onSelect callback
   - Closes menu after selection
   - Disabled items cannot be selected
   - Checkbox items toggle state on click
   - Checkbox items maintain state after close

   **Escape and Focus (4 tests):**
   - Escape key closes menu
   - Focus returns to trigger after Escape
   - Focus returns to trigger after item selection
   - Click outside closes menu

   **Accessibility (6 tests):**
   - Trigger has aria-haspopup="menu"
   - Content has role="menu"
   - Items have role="menuitem"
   - Checkbox items have role="menuitemcheckbox"
   - aria-checked reflects checkbox state
   - axe accessibility audit passes

   **Styling (4 tests):**
   - Content applies Ember Noir styling
   - Items show hover state
   - Disabled items have reduced opacity
   - Icons render on left of item text

   **Exports (4 tests):**
   - Exports RightClickMenu default
   - Exports named subcomponents
   - Namespace properties attached
   - Barrel export includes RightClickMenu

2. Update `app/components/ui/index.js` barrel export:
   ```javascript
   export { default as RightClickMenu, ... } from './RightClickMenu';
   ```
   Export all named exports from RightClickMenu.js

3. Run tests and ensure all pass
  </action>
  <verify>
    - `npm test -- --testPathPattern="RightClickMenu" --coverage` shows 40+ tests passing
    - `grep "RightClickMenu" app/components/ui/index.js` shows export exists
  </verify>
  <done>
    - 40+ tests covering rendering, keyboard navigation, selection, accessibility
    - All tests passing
    - Barrel export updated with RightClickMenu and all subcomponents
  </done>
</task>

</tasks>

<verification>
1. All tests pass: `npm test -- --testPathPattern="RightClickMenu"`
2. Package installed: `grep "react-context-menu" package.json`
3. Hook exists: `ls app/hooks/useLongPress.js`
4. Component renders: Import and render in a test page
5. Keyboard navigation works: Arrow keys, Enter, Escape
6. Accessibility: axe audit passes in tests
</verification>

<success_criteria>
- RightClickMenu component created with namespace pattern
- useLongPress hook created with 500ms threshold and haptic feedback
- Right-click opens menu with proper positioning
- Arrow key navigation works correctly
- Enter/Space selects items
- Escape closes and restores focus
- 40+ tests passing
- Barrel export includes all exports
</success_criteria>

<output>
After completion, create `.planning/phases/32-action-components/32-01-SUMMARY.md`
</output>
