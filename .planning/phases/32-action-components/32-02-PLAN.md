---
phase: 32-action-components
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/CommandPalette.js
  - app/components/ui/Kbd.js
  - app/components/layout/CommandPaletteProvider.js
  - app/components/ui/__tests__/CommandPalette.test.js
  - app/components/ui/__tests__/Kbd.test.js
  - app/components/ui/index.js
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "User can open Command Palette with Cmd+K (Mac) or Ctrl+K (Windows)"
    - "User can search commands with fuzzy matching"
    - "User can navigate results with arrow keys"
    - "User can execute command with Enter"
    - "Escape closes palette and returns focus"
  artifacts:
    - path: "app/components/ui/CommandPalette.js"
      provides: "Command Palette with cmdk integration"
      exports: ["CommandPalette"]
      min_lines: 200
    - path: "app/components/ui/Kbd.js"
      provides: "Keyboard shortcut display component"
      exports: ["Kbd"]
      min_lines: 30
    - path: "app/components/layout/CommandPaletteProvider.js"
      provides: "Global keyboard shortcut handler"
      exports: ["CommandPaletteProvider"]
      min_lines: 50
    - path: "app/components/ui/__tests__/CommandPalette.test.js"
      provides: "Test coverage for Command Palette"
      min_lines: 200
  key_links:
    - from: "app/components/layout/CommandPaletteProvider.js"
      to: "app/components/ui/CommandPalette.js"
      via: "renders CommandPalette"
      pattern: "CommandPalette.*open"
    - from: "app/components/ui/CommandPalette.js"
      to: "cmdk"
      via: "import"
      pattern: "import.*cmdk"
    - from: "app/components/ui/index.js"
      to: "app/components/ui/CommandPalette.js"
      via: "barrel export"
      pattern: "export.*CommandPalette"
---

<objective>
Create Command Palette component for power-user navigation and quick actions.

Purpose: Enable keyboard-first navigation with Cmd+K/Ctrl+K shortcut. Users can search and execute commands without using mouse. Full-screen on mobile with large touch targets.
Output: CommandPalette.js with cmdk integration, Kbd.js for shortcut display, CommandPaletteProvider for global shortcut handling, and comprehensive tests.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-action-components/32-CONTEXT.md
@.planning/phases/32-action-components/32-RESEARCH.md
@app/components/ui/Sheet.js
@app/components/ui/Modal.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cmdk and create Kbd component</name>
  <files>
    - package.json
    - package-lock.json
    - app/components/ui/Kbd.js
    - app/components/ui/__tests__/Kbd.test.js
  </files>
  <action>
1. Install cmdk package:
   ```bash
   npm install cmdk
   ```

2. Create `app/components/ui/Kbd.js` - keyboard shortcut display component:
   - 'use client' directive
   - Simple functional component with cn() for class merging
   - Styling following Ember Noir:
     - px-2 py-1 rounded-md
     - text-xs font-mono font-medium
     - bg-slate-700/50 [html:not(.dark)_&]:bg-slate-200
     - text-slate-300 [html:not(.dark)_&]:text-slate-700
     - border border-slate-600/50 [html:not(.dark)_&]:border-slate-300
     - shadow-sm
   - Accept children (the shortcut text like "Cmd+K" or "Enter")
   - Accept className prop for overrides
   - JSDoc with usage examples

3. Create `app/components/ui/__tests__/Kbd.test.js`:
   - Renders children text
   - Applies base styling
   - Merges custom className
   - Renders special characters (symbols)
   - Snapshot test for visual regression
  </action>
  <verify>
    - `npm test -- --testPathPattern="Kbd" --passWithNoTests` passes
    - `grep "cmdk" package.json` shows package installed
    - File exists: `ls app/components/ui/Kbd.js`
  </verify>
  <done>
    - cmdk installed
    - Kbd.js created with Ember Noir styling
    - 5+ Kbd tests passing
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CommandPalette component and Provider</name>
  <files>
    - app/components/ui/CommandPalette.js
    - app/components/layout/CommandPaletteProvider.js
    - app/components/ui/__tests__/CommandPalette.test.js
    - app/components/ui/index.js
  </files>
  <action>
1. Create `app/components/ui/CommandPalette.js`:
   - 'use client' directive
   - Import { Command } from 'cmdk'
   - Import Kbd component
   - Import lucide-react icons (Home, Settings, Power, Moon, etc.)

   Component structure:
   ```jsx
   function CommandPalette({ open, onOpenChange, commands }) {
     return (
       <Command.Dialog open={open} onOpenChange={onOpenChange} loop>
         {/* Overlay - blur+dim matching Sheet pattern */}
         <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-md z-50" />

         {/* Content - full screen on mobile (user decision) */}
         <div className="
           fixed z-50
           inset-4 md:inset-auto
           md:left-1/2 md:top-1/2 md:-translate-x-1/2 md:-translate-y-1/2
           md:w-full md:max-w-2xl
         ">
           <Command className="rounded-3xl border border-slate-700/50 bg-slate-900/95 shadow-card-elevated overflow-hidden">
             <Command.Input
               placeholder="Press Cmd+K to open"
               autoFocus
               className="..."
             />
             <Command.List className="max-h-[60vh] md:max-h-[400px] overflow-y-auto p-2">
               <Command.Empty>No results found.</Command.Empty>

               {/* Groups from commands prop */}
               {commands.map(group => (
                 <Command.Group key={group.heading} heading={group.heading}>
                   {group.items.map(item => (
                     <Command.Item
                       key={item.id}
                       onSelect={() => {
                         item.onSelect();
                         onOpenChange(false);
                         if (navigator.vibrate) navigator.vibrate([10, 20, 10]);
                       }}
                     >
                       <div className="flex items-center gap-3">
                         {item.icon}
                         <span>{item.label}</span>
                       </div>
                       {item.shortcut && <Kbd>{item.shortcut}</Kbd>}
                     </Command.Item>
                   ))}
                 </Command.Group>
               ))}
             </Command.List>
           </Command>
         </div>
       </Command.Dialog>
     );
   }
   ```

   Styling for Command.Input:
   - w-full px-4 py-4 text-lg
   - bg-transparent border-b border-slate-700/50
   - text-slate-100 placeholder:text-slate-500
   - focus:outline-none

   Styling for Command.Item:
   - flex items-center justify-between px-3 py-3 rounded-xl
   - text-sm font-medium cursor-pointer
   - text-slate-300 [html:not(.dark)_&]:text-slate-700
   - data-[selected=true]:bg-slate-700/50
   - Ember Noir colors, 48px touch targets on mobile

   Styling for Command.Group heading:
   - text-xs font-semibold uppercase tracking-wider
   - text-slate-500 px-3 py-2

2. Create `app/components/layout/CommandPaletteProvider.js`:
   - 'use client' directive
   - Manage open/close state
   - Global keydown listener for Cmd+K / Ctrl+K
   - CRITICAL: Call e.preventDefault() to prevent browser default
   - Default commands for Navigation, Device Actions, Settings (user decision)
   - Render children + CommandPalette

   Default command structure (centralized, not dynamic per user decision):
   ```javascript
   const defaultCommands = [
     {
       heading: 'Navigation',
       items: [
         { id: 'nav-home', label: 'Dashboard', icon: <Home />, shortcut: 'Cmd+D', onSelect: () => router.push('/') },
         { id: 'nav-settings', label: 'Settings', icon: <Settings />, shortcut: 'Cmd+,', onSelect: () => router.push('/settings') },
         { id: 'nav-thermostat', label: 'Thermostat', icon: <Thermometer />, onSelect: () => router.push('/thermostat') },
       ]
     },
     {
       heading: 'Device Actions',
       items: [
         { id: 'stove-ignite', label: 'Ignite Stove', icon: <Power />, onSelect: () => {} }, // Placeholder
         { id: 'stove-off', label: 'Turn Off Stove', icon: <PowerOff />, onSelect: () => {} },
       ]
     },
     {
       heading: 'Settings',
       items: [
         { id: 'toggle-theme', label: 'Toggle Dark Mode', icon: <Moon />, onSelect: () => {} },
       ]
     },
   ];
   ```

3. Create `app/components/ui/__tests__/CommandPalette.test.js` with 35+ tests:

   **Rendering (5 tests):**
   - Does not render when closed
   - Renders when open=true
   - Renders all command groups
   - Renders items within groups
   - Renders shortcuts with Kbd component

   **Search/Filter (6 tests):**
   - Input receives autofocus
   - Typing filters items
   - Fuzzy matching works (e.g., "dshb" matches "Dashboard")
   - Empty state shows when no matches
   - Clearing input shows all items
   - Search is case-insensitive

   **Keyboard Navigation (8 tests):**
   - Arrow Down moves to next item
   - Arrow Up moves to previous item
   - Navigation wraps (loop prop)
   - Enter executes selected command
   - Escape closes palette
   - Tab does not exit focus trap
   - First item is selected by default
   - Home/End navigation (if supported)

   **Command Execution (5 tests):**
   - Click on item calls onSelect
   - Closes palette after execution
   - Haptic feedback triggers on mobile
   - onOpenChange called with false
   - Router navigation commands work

   **Global Shortcut (5 tests):**
   - Cmd+K opens palette (Mac)
   - Ctrl+K opens palette (Windows)
   - Prevents default browser behavior
   - Toggle behavior (open/close)
   - Works when focus is elsewhere

   **Accessibility (4 tests):**
   - Command.Input has proper aria attributes
   - Items have role appropriate for combobox
   - Selected item has aria-selected
   - axe accessibility audit passes

   **Mobile Layout (3 tests):**
   - Full screen on mobile (inset-4)
   - Large touch targets (py-3)
   - Placeholder visible

4. Update `app/components/ui/index.js`:
   ```javascript
   export { default as CommandPalette } from './CommandPalette';
   export { default as Kbd } from './Kbd';
   ```

5. Note: CommandPaletteProvider should be added to layout in Phase 36 (Application Integration), not now. This phase only creates the components.
  </action>
  <verify>
    - `npm test -- --testPathPattern="CommandPalette" --coverage` shows 35+ tests passing
    - `npm test -- --testPathPattern="Kbd"` shows tests passing
    - `grep "CommandPalette" app/components/ui/index.js` shows export
    - File exists: `ls app/components/layout/CommandPaletteProvider.js`
  </verify>
  <done>
    - CommandPalette.js created with cmdk Dialog integration
    - CommandPaletteProvider.js created with global Cmd+K handler
    - Full-screen mobile layout (user decision honored)
    - Grouped commands with section headers (user decision honored)
    - No recent commands history (user decision honored)
    - Haptic feedback on selection
    - 35+ tests passing
    - Barrel exports updated
  </done>
</task>

</tasks>

<verification>
1. All tests pass: `npm test -- --testPathPattern="Command|Kbd"`
2. Package installed: `grep "cmdk" package.json`
3. Cmd+K handler prevents default: Check test for e.preventDefault()
4. Mobile layout is full-screen: Check className includes inset-4
5. Groups have headers: Check Command.Group heading prop
6. Shortcuts displayed with Kbd: Check items render Kbd component
</verification>

<success_criteria>
- CommandPalette component created with cmdk Dialog
- Kbd component created for shortcut display
- CommandPaletteProvider handles global Cmd+K/Ctrl+K
- Fuzzy search filters commands
- Arrow key navigation with wrapping (loop)
- Enter executes, Escape closes
- Full-screen on mobile (user decision)
- Grouped commands with headers (user decision)
- No recent commands (user decision)
- Haptic feedback on selection
- 40+ total tests passing
- Barrel exports include both components
</success_criteria>

<output>
After completion, create `.planning/phases/32-action-components/32-02-SUMMARY.md`
</output>
