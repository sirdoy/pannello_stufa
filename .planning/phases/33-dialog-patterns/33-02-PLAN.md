---
phase: 33-dialog-patterns
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/FormModal.js
  - app/components/ui/__tests__/FormModal.test.js
  - app/components/ui/index.js
  - app/styles/animations.css
autonomous: true

must_haves:
  truths:
    - "FormModal opens and first input receives focus"
    - "Validation errors appear inline below fields on blur"
    - "Validation errors appear in summary at top on submit"
    - "Invalid fields shake and get red border on submit"
    - "Submit button shows spinner and 'Saving...' during loading"
    - "All form fields disabled during submit"
    - "Modal cannot be closed while loading"
    - "Success checkmark shows briefly before auto-close"
  artifacts:
    - path: "app/components/ui/FormModal.js"
      provides: "FormModal component with React Hook Form integration"
      exports: ["FormModal"]
    - path: "app/components/ui/__tests__/FormModal.test.js"
      provides: "Unit tests for FormModal"
      contains: "describe('FormModal'"
    - path: "app/styles/animations.css"
      provides: "Shake animation for validation errors"
      contains: "animate-shake"
  key_links:
    - from: "app/components/ui/FormModal.js"
      to: "app/components/ui/Modal.js"
      via: "import Modal"
      pattern: "import.*Modal.*from"
    - from: "app/components/ui/FormModal.js"
      to: "react-hook-form"
      via: "useForm hook"
      pattern: "useForm|Controller"
---

<objective>
Create FormModal component integrating React Hook Form with Modal for validated form dialogs.

Purpose: Standardize form-in-modal pattern with hybrid validation, loading states, and success feedback per CONTEXT.md decisions.
Output: FormModal.js with validation integration, error display, shake animation, and success state.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-dialog-patterns/33-CONTEXT.md
@.planning/phases/33-dialog-patterns/33-RESEARCH.md
@app/components/ui/Modal.js
@app/components/ui/Input.js
@app/components/ui/Button.js
@app/settings/notifications/NotificationSettingsForm.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shake animation CSS</name>
  <files>app/styles/animations.css</files>
  <action>
Add shake animation to existing animations.css (or create if doesn't exist):

```css
/* Shake animation for form validation errors */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
  20%, 40%, 60%, 80% { transform: translateX(4px); }
}

.animate-shake {
  animation: shake 0.5s ease-in-out;
}
```

Also add to tailwind.config.js animation extend if needed:
```js
animation: {
  shake: 'shake 0.5s ease-in-out',
}
```

Verify the file is imported in the app (check globals.css or layout.js).
  </action>
  <verify>grep -r "animate-shake" app/styles/ shows animation defined</verify>
  <done>Shake animation CSS available for form validation error feedback</done>
</task>

<task type="auto">
  <name>Task 2: Create FormModal component</name>
  <files>app/components/ui/FormModal.js</files>
  <action>
Create FormModal component that wraps Modal with React Hook Form integration:

1. API props:
   - isOpen, onClose (standard Modal API)
   - onSubmit: async (data) => void - called with validated form data
   - title: string (required)
   - description: string (optional)
   - defaultValues: object (initial form values)
   - validationSchema: Zod schema (for zodResolver)
   - submitLabel: string (default: "Save")
   - cancelLabel: string (default: "Cancel")
   - successMessage: string (optional - shown on success before close)
   - size: Modal size variant (default: "md")
   - children: (form) => ReactNode - render prop for form fields

2. Internal state:
   - formState: 'idle' | 'submitting' | 'success' | 'error'
   - Use useForm from react-hook-form with zodResolver

3. Validation timing (CONTEXT.md locked decision):
   - mode: 'onBlur' - validate on blur for touched fields
   - reValidateMode: 'onChange' - after first error, validate immediately

4. Form structure:
   ```jsx
   <Modal isOpen={isOpen} onClose={handleClose} size={size}>
     <Modal.Header>
       <Modal.Title>{title}</Modal.Title>
       <Modal.Close disabled={formState === 'submitting'} />
     </Modal.Header>

     {description && <Modal.Description>{description}</Modal.Description>}

     {/* Error summary at top (CONTEXT.md decision) */}
     {Object.keys(errors).length > 0 && hasSubmitted && (
       <ErrorSummary errors={errors} />
     )}

     <form onSubmit={handleSubmit(onFormSubmit)}>
       {/* Render prop for form fields */}
       {children({ control, formState, register, setValue, watch })}

       <Modal.Footer>
         <Button variant="subtle" onClick={handleClose} disabled={isSubmitting}>
           {cancelLabel}
         </Button>
         <Button
           type="submit"
           variant="ember"
           loading={isSubmitting}
           disabled={isSubmitting}
         >
           {isSubmitting ? 'Saving...' : submitLabel}
         </Button>
       </Modal.Footer>
     </form>

     {/* Success overlay */}
     {formState === 'success' && <SuccessOverlay message={successMessage} />}
   </Modal>
   ```

5. Error handling (CONTEXT.md locked decisions):
   - ErrorSummary component: List all errors at top of form
   - Shake animation: Add animate-shake class to invalid fields on submit
   - Red border: Input already supports error variant
   - Auto-scroll to first error: Use setFocus from useForm

6. Loading state (CONTEXT.md locked decision):
   - Disable all form fields: Pass disabled to all inputs via context or cloneElement
   - Prevent close: Same pattern as ConfirmationDialog
   - Submit button shows spinner + "Saving..."

7. Success state (CONTEXT.md locked decision):
   - Show checkmark overlay for 800ms after successful submit
   - Then call onClose

8. Form reset on open:
   - Reset form values when isOpen changes to true
   - Clear any previous errors

9. Shake animation trigger:
   - On submit with errors, add animate-shake class to each invalid field
   - Remove class on animationend event (so it can retrigger)
   - Use refs or data attributes to target fields

Example usage:
```jsx
<FormModal
  isOpen={showEdit}
  onClose={() => setShowEdit(false)}
  onSubmit={handleSave}
  title="Edit Schedule"
  defaultValues={{ name: 'Morning', time: '07:00' }}
  validationSchema={scheduleSchema}
  successMessage="Schedule saved!"
>
  {({ control, formState }) => (
    <>
      <Controller
        name="name"
        control={control}
        render={({ field, fieldState }) => (
          <Input
            label="Name"
            {...field}
            error={fieldState.error?.message}
            data-field="name"
          />
        )}
      />
    </>
  )}
</FormModal>
```
  </action>
  <verify>File exists and exports FormModal with proper TypeScript-friendly JSDoc types</verify>
  <done>FormModal component created with React Hook Form integration, hybrid validation, error display patterns, and success state per CONTEXT.md decisions</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests and export</name>
  <files>
    app/components/ui/__tests__/FormModal.test.js
    app/components/ui/index.js
  </files>
  <action>
1. Create FormModal tests:

Test cases:
- Basic rendering: Opens with title, renders children
- Focus: First focusable element receives focus on open
- Validation on blur: Error appears after blur on invalid field
- Submit validation: All errors shown on submit attempt
- Error summary: Shows at top when hasSubmitted and has errors
- Shake animation: Invalid fields get animate-shake class on submit
- Auto-scroll: First error field receives focus on invalid submit
- Loading state: Fields disabled, close blocked, button shows spinner
- Success state: Checkmark overlay appears, then closes after delay
- Form reset: Form resets when reopened

Mock Zod schema for tests:
```js
const testSchema = z.object({
  name: z.string().min(1, 'Name required'),
  email: z.string().email('Invalid email'),
});
```

2. Export from barrel:
Add to app/components/ui/index.js:
```js
export { default as FormModal } from './FormModal';
```
  </action>
  <verify>npm test -- --testPathPattern=FormModal --watchAll=false && grep FormModal app/components/ui/index.js</verify>
  <done>FormModal tests pass and component exported from barrel</done>
</task>

</tasks>

<verification>
1. Animation CSS exists with shake keyframes
2. FormModal.js exports correctly
3. Tests pass: npm test -- --testPathPattern=FormModal
4. Export in barrel: grep FormModal app/components/ui/index.js
</verification>

<success_criteria>
- FormModal integrates with React Hook Form via render prop
- Hybrid validation timing (onBlur + onChange after error)
- Error summary appears at top on submit
- Invalid fields shake and have red border
- Loading state disables fields and prevents close
- Success checkmark shows briefly before auto-close
- All tests pass
- Exported from barrel
</success_criteria>

<output>
After completion, create `.planning/phases/33-dialog-patterns/33-02-SUMMARY.md`
</output>
