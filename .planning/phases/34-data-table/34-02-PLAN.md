---
phase: 34-data-table
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - app/components/ui/DataTable.js
  - app/components/ui/DataTableToolbar.js
  - app/components/ui/__tests__/DataTable.test.js
  - app/components/ui/index.js
autonomous: true

must_haves:
  truths:
    - "User can select rows via checkbox in first column"
    - "User can see selected count in floating bulk actions toolbar"
    - "User can search globally via search input"
    - "User can filter individual columns via header dropdown"
    - "User can see active filters as removable chips"
    - "User can paginate through data with page numbers"
  artifacts:
    - path: "app/components/ui/DataTable.js"
      provides: "DataTable with selection, filtering, pagination"
      exports: ["DataTable", "dataTableVariants"]
      contains: "getFilteredRowModel"
    - path: "app/components/ui/DataTableToolbar.js"
      provides: "Toolbar component with search, filter chips, bulk actions"
      exports: ["DataTableToolbar"]
      min_lines: 80
  key_links:
    - from: "app/components/ui/DataTable.js"
      to: "@tanstack/react-table"
      via: "getFilteredRowModel, getPaginationRowModel, selection state"
      pattern: "(getFilteredRowModel|getPaginationRowModel|rowSelection)"
    - from: "app/components/ui/DataTableToolbar.js"
      to: "app/components/ui/Badge.js"
      via: "Filter chips display"
      pattern: "Badge"
---

<objective>
Add row selection, filtering (global + per-column), and pagination to DataTable.

Purpose: Enable users to select multiple rows for bulk actions, search/filter data, and navigate through large datasets efficiently.

Output: Enhanced DataTable with selection checkboxes, floating bulk actions toolbar, filter chips, and traditional page number pagination.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-data-table/34-CONTEXT.md
@.planning/phases/34-data-table/34-RESEARCH.md
@.planning/phases/34-data-table/34-01-SUMMARY.md

# Components to use
@app/components/ui/Checkbox.js
@app/components/ui/Badge.js
@app/components/ui/Button.js
@app/components/ui/Input.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection support to DataTable</name>
  <files>
    app/components/ui/DataTable.js
  </files>
  <action>
Enhance DataTable.js with row selection:

**New props:**
- selectionMode: 'none' | 'single' | 'multi' (default: 'none')
- onSelectionChange: (selectedRowIds: Record<string, boolean>) => void
- selectedRows: Record<string, boolean> (controlled mode)

**Implementation:**

1. Add rowSelection state (useState) and onRowSelectionChange handler
2. Add enableRowSelection and enableMultiRowSelection to useReactTable config
3. Create checkbox column that is automatically prepended when selectionMode !== 'none':

```javascript
const selectionColumn = {
  id: 'select',
  header: ({ table }) => (
    selectionMode === 'multi' && (
      <Checkbox
        checked={table.getIsAllPageRowsSelected()}
        indeterminate={table.getIsSomePageRowsSelected()}
        onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
        aria-label="Select all rows"
      />
    )
  ),
  cell: ({ row }) => (
    <div onClick={(e) => e.stopPropagation()}>
      <Checkbox
        checked={row.getIsSelected()}
        disabled={!row.getCanSelect()}
        onCheckedChange={row.toggleSelected}
        aria-label={`Select row ${row.id}`}
      />
    </div>
  ),
  size: 40, // Fixed width for checkbox column
  enableSorting: false,
};
```

4. CRITICAL: stopPropagation on checkbox click to prevent row click (expansion) conflict per CONTEXT.md decision

**Styling:**
- Checkbox column: fixed width, centered
- Selected rows: bg-ember-500/10 highlight
  </action>
  <verify>
DataTable with selectionMode="multi" shows checkbox column, clicking checkbox selects row without triggering row click.
  </verify>
  <done>
DataTable supports single and multi-select modes with checkbox column, selection state is tracked.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DataTableToolbar with search and filter chips</name>
  <files>
    app/components/ui/DataTableToolbar.js
  </files>
  <action>
Create DataTableToolbar.js component:

**Structure (per CONTEXT.md decisions):**
```
+--------------------------------------------------+
| [Global Search Input]            [Bulk Actions]  |  <- Shows when rows selected
+--------------------------------------------------+
| [Filter: Status=Active] [Filter: Type=Error] [X Clear all] |  <- Filter chips
+--------------------------------------------------+
```

**Props:**
- table: TanStack table instance
- globalFilter: string
- onGlobalFilterChange: (value: string) => void
- showBulkActions: boolean
- onBulkAction: (action: string, selectedRows: Row[]) => void
- bulkActions: Array<{ id: string, label: string, variant?: string, icon?: ReactNode }>

**Components:**

1. **Global Search Input:**
   - Use existing Input component
   - Left icon: Search from lucide-react
   - Placeholder: "Search..."
   - Debounced onChange (300ms) using setTimeout

2. **Floating Bulk Actions Toolbar:**
   - Appears above table when selectedCount > 0
   - Shows: "{count} selected" text + action buttons
   - Styling: bg-ember-500/10 border border-ember-400/20 rounded-xl p-3
   - Position: relative (inside toolbar, not absolute)

3. **Filter Chips:**
   - Use Badge component with variant="ocean"
   - Display: columnId + ": " + filterValue
   - X icon on right to remove filter
   - "Clear all" button when >1 filter active
   - Maps over table.getState().columnFilters

**ARIA:**
- aria-live="polite" region announcing selected count changes
- aria-label on filter removal buttons
  </action>
  <verify>
DataTableToolbar.js exists and exports DataTableToolbar. Component renders search input and filter chips.
  </verify>
  <done>
DataTableToolbar provides global search, filter chips display, and floating bulk actions toolbar.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add filtering and pagination to DataTable</name>
  <files>
    app/components/ui/DataTable.js
    app/components/ui/__tests__/DataTable.test.js
    app/components/ui/index.js
  </files>
  <action>
**DataTable.js enhancements:**

1. **Add TanStack models:**
   - getFilteredRowModel() for filtering
   - getPaginationRowModel() for pagination

2. **New state:**
   - columnFilters (useState)
   - globalFilter (useState)
   - pagination (useState): { pageIndex: 0, pageSize: 10 }

3. **New props:**
   - enableFiltering: boolean (default: false)
   - enablePagination: boolean (default: false)
   - pageSize: number (default: 10)
   - pageSizeOptions: number[] (default: [10, 25, 50, 100])
   - showRowCount: boolean (default: true) - "Showing 1-10 of 243"
   - onPageChange: (pageIndex: number) => void

4. **Integrate DataTableToolbar:**
   - Render above table when enableFiltering is true
   - Pass table instance, globalFilter, onGlobalFilterChange

5. **Add Pagination UI (centered at bottom per CONTEXT.md):**
```jsx
<div className="flex items-center justify-center gap-4 py-4 border-t border-white/[0.06]">
  {/* ARIA live region */}
  <div role="status" aria-live="polite" className="sr-only">
    Page {pageIndex + 1} of {pageCount}. Showing rows {startRow} to {endRow} of {totalRows}.
  </div>

  {/* Visual count (optional) */}
  {showRowCount && (
    <Text variant="secondary" size="sm">
      Showing {startRow}-{endRow} of {totalRows}
    </Text>
  )}

  {/* Page buttons */}
  <div className="flex gap-1">
    <Button variant="ghost" size="sm" onClick={previousPage} disabled={!canPreviousPage}>
      <ChevronLeft className="w-4 h-4" />
    </Button>
    {/* Page numbers - show max 5 pages with ellipsis */}
    {pageNumbers.map(page => (
      <Button
        key={page}
        variant={page === pageIndex ? 'ember' : 'ghost'}
        size="sm"
        onClick={() => setPageIndex(page)}
        aria-current={page === pageIndex ? 'page' : undefined}
      >
        {page + 1}
      </Button>
    ))}
    <Button variant="ghost" size="sm" onClick={nextPage} disabled={!canNextPage}>
      <ChevronRight className="w-4 h-4" />
    </Button>
  </div>

  {/* Rows per page (optional per CONTEXT.md) */}
  {pageSizeOptions && (
    <Select
      value={pageSize}
      onChange={(e) => setPageSize(Number(e.target.value))}
      options={pageSizeOptions.map(size => ({ value: size, label: String(size) }))}
      className="w-20"
    />
  )}
</div>
```

6. **Page number calculation (max 5 visible):**
   - Always show first and last page
   - Show current page and 1 page on each side
   - Use ellipsis (...) for gaps

**Update tests:**
- Test selection mode enables checkbox column
- Test global filter filters visible rows
- Test column filter updates filter chips
- Test pagination controls navigate pages
- Test aria-live announcements update

**Update index.js:**
- Add DataTableToolbar export
  </action>
  <verify>
`npm test -- --testPathPattern="DataTable" --watchAll=false` passes. DataTable with enableFiltering and enablePagination shows toolbar and pagination controls.
  </verify>
  <done>
DataTable supports filtering (global + column), pagination with page numbers, and integrates with DataTableToolbar.
  </done>
</task>

</tasks>

<verification>
1. Selection mode adds checkbox column
2. Checkbox click selects row (stopPropagation prevents row click)
3. Bulk actions toolbar appears when rows selected
4. Global search filters visible rows
5. Column filters show as removable chips
6. "Clear all" removes all filters
7. Pagination controls show page numbers
8. Rows per page selector works
9. "Showing X-Y of Z" displays correctly
10. ARIA live region announces changes
11. All tests pass
</verification>

<success_criteria>
- selectionMode="multi" shows checkbox column with select-all header
- Individual row selection via checkbox works
- Floating toolbar shows "{N} selected" with bulk action buttons
- Global search input filters data in real-time (debounced 300ms)
- Per-column filters display as Badge chips
- Filter chips have X button to remove, "Clear all" button when >1 filter
- Pagination shows page numbers (1, 2, 3... with ellipsis for large counts)
- "Showing 1-10 of 243" format for row count
- Rows per page dropdown (10/25/50/100)
- Screen reader announces filter results and page changes
</success_criteria>

<output>
After completion, create `.planning/phases/34-data-table/34-02-SUMMARY.md`
</output>
