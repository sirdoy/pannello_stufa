---
phase: 34-data-table
plan: 03
type: execute
wave: 3
depends_on: ["34-02"]
files_modified:
  - app/components/ui/DataTable.js
  - app/components/ui/DataTableRow.js
  - app/components/ui/__tests__/DataTable.test.js
autonomous: true

must_haves:
  truths:
    - "User can click row to expand and see additional details"
    - "User can navigate rows with arrow keys"
    - "User can see expanded content below the row"
    - "Table scrolls horizontally on mobile with visual indicator"
    - "Screen reader announces expanded/collapsed state"
  artifacts:
    - path: "app/components/ui/DataTable.js"
      provides: "DataTable with row expansion and responsive behavior"
      contains: "getExpandedRowModel"
    - path: "app/components/ui/DataTableRow.js"
      provides: "Row component with expansion and keyboard navigation"
      exports: ["DataTableRow"]
      min_lines: 60
  key_links:
    - from: "app/components/ui/DataTable.js"
      to: "@tanstack/react-table"
      via: "getExpandedRowModel for row expansion"
      pattern: "getExpandedRowModel"
    - from: "app/components/ui/DataTableRow.js"
      to: "app/components/ui/DataTable.js"
      via: "Row component used by DataTable"
      pattern: "DataTableRow"
---

<objective>
Add row expansion and responsive behavior to DataTable.

Purpose: Enable users to expand rows to see additional details and ensure the table works well on mobile devices with horizontal scrolling.

Output: DataTable with expandable rows, keyboard navigation, and responsive horizontal scroll with visual indicators.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-data-table/34-CONTEXT.md
@.planning/phases/34-data-table/34-RESEARCH.md
@.planning/phases/34-data-table/34-01-SUMMARY.md
@.planning/phases/34-data-table/34-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DataTableRow component with expansion</name>
  <files>
    app/components/ui/DataTableRow.js
  </files>
  <action>
Create DataTableRow.js component to handle row rendering with expansion:

**Props:**
- row: TanStack Row instance
- columns: Column definitions
- index: Row index (for roving tabindex)
- renderExpandedContent: (row) => ReactNode (custom expansion content)
- isExpanded: boolean
- onToggleExpand: () => void

**Implementation:**

1. **Row click handler (per CONTEXT.md: row click expands):**
```jsx
<tr
  role="row"
  tabIndex={index === 0 ? 0 : -1}  // Roving tabindex
  onClick={() => row.getCanExpand() && row.toggleExpanded()}
  onKeyDown={handleKeyDown}
  aria-expanded={row.getIsExpanded()}
  aria-selected={row.getIsSelected()}
  className={cn(
    'cursor-pointer',
    'hover:bg-white/[0.02]',
    'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-ember-500/50',
    row.getIsSelected() && 'bg-ember-500/10',
    row.getIsExpanded() && 'border-b-0'
  )}
>
```

2. **Keyboard navigation (roving tabindex pattern per RESEARCH.md):**
```javascript
const handleKeyDown = (e) => {
  switch (e.key) {
    case 'ArrowDown':
      e.preventDefault();
      const nextRow = e.currentTarget.nextElementSibling;
      // Skip expanded content row
      if (nextRow?.getAttribute('data-expansion-row')) {
        nextRow.nextElementSibling?.focus();
      } else {
        nextRow?.focus();
      }
      break;
    case 'ArrowUp':
      e.preventDefault();
      const prevRow = e.currentTarget.previousElementSibling;
      // Skip expanded content row
      if (prevRow?.getAttribute('data-expansion-row')) {
        prevRow.previousElementSibling?.focus();
      } else {
        prevRow?.focus();
      }
      break;
    case 'Enter':
      e.preventDefault();
      row.toggleExpanded();
      break;
    case ' ':
      e.preventDefault();
      row.toggleSelected();
      break;
  }
};
```

3. **Expansion indicator column:**
   - ChevronRight icon that rotates 90deg when expanded
   - Add as first column (after checkbox if selection enabled)

4. **Expanded content row:**
```jsx
{row.getIsExpanded() && (
  <tr data-expansion-row className="bg-slate-800/30">
    <td colSpan={columns.length + extraColumns} className="p-4">
      {renderExpandedContent ? renderExpandedContent(row) : (
        <Text variant="secondary" size="sm">
          {JSON.stringify(row.original, null, 2)}
        </Text>
      )}
    </td>
  </tr>
)}
```

**ARIA:**
- aria-expanded on row
- aria-controls pointing to expansion row id
- Expansion row has role="row" with single cell spanning all columns
  </action>
  <verify>
DataTableRow.js exists and handles row click, keyboard navigation, and expansion content rendering.
  </verify>
  <done>
DataTableRow component handles expansion toggle, keyboard navigation, and renders expanded content.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate expansion into DataTable and add responsive behavior</name>
  <files>
    app/components/ui/DataTable.js
  </files>
  <action>
**Add expansion support:**

1. **New props:**
   - enableExpansion: boolean (default: false)
   - renderExpandedContent: (row) => ReactNode
   - getRowCanExpand: (row) => boolean (default: () => true)

2. **Add TanStack expansion:**
   - Add getExpandedRowModel() to useReactTable
   - Add expanded state (useState)
   - Add onExpandedChange handler

3. **Expansion column (when enableExpansion):**
```javascript
const expansionColumn = {
  id: 'expand',
  header: () => null,
  cell: ({ row }) => (
    row.getCanExpand() && (
      <button
        onClick={(e) => {
          e.stopPropagation();
          row.toggleExpanded();
        }}
        aria-label={row.getIsExpanded() ? 'Collapse row' : 'Expand row'}
        className="p-1 hover:bg-white/[0.05] rounded"
      >
        <ChevronRight
          className={cn(
            'w-4 h-4 transition-transform',
            row.getIsExpanded() && 'rotate-90'
          )}
        />
      </button>
    )
  ),
  size: 40,
  enableSorting: false,
};
```

4. **Use DataTableRow for rendering:**
   - Import and use DataTableRow component
   - Pass renderExpandedContent prop

**Add responsive horizontal scroll (per CONTEXT.md + RESEARCH.md):**

1. **Wrapper structure:**
```jsx
<div className="relative">
  {/* Scroll container */}
  <div
    ref={scrollContainerRef}
    className={cn(
      'overflow-x-auto',
      'rounded-2xl border border-white/[0.06]',
      'scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent'
    )}
    onScroll={handleScroll}
  >
    <table className={cn(dataTableVariants({ density, striped, stickyHeader }), 'min-w-full')}>
      {/* ... */}
    </table>
  </div>

  {/* Right fade gradient indicator (per RESEARCH.md) */}
  {showScrollIndicator && (
    <div
      className="absolute top-0 right-0 bottom-0 w-8 pointer-events-none"
      style={{
        background: 'linear-gradient(to left, rgb(15 23 42), transparent)',
      }}
      aria-hidden="true"
    />
  )}
</div>
```

2. **Scroll indicator logic:**
```javascript
const [showScrollIndicator, setShowScrollIndicator] = useState(false);
const scrollContainerRef = useRef(null);

useEffect(() => {
  const container = scrollContainerRef.current;
  if (!container) return;

  const checkScroll = () => {
    const canScrollRight = container.scrollWidth > container.clientWidth &&
      container.scrollLeft < container.scrollWidth - container.clientWidth - 5;
    setShowScrollIndicator(canScrollRight);
  };

  checkScroll();
  container.addEventListener('scroll', checkScroll);
  window.addEventListener('resize', checkScroll);

  return () => {
    container.removeEventListener('scroll', checkScroll);
    window.removeEventListener('resize', checkScroll);
  };
}, []);
```

3. **Mobile-friendly touch scrolling:**
   - Add `-webkit-overflow-scrolling: touch` via Tailwind
   - Ensure min-width on table so it doesn't squeeze columns
  </action>
  <verify>
DataTable with enableExpansion shows expand icons, row click expands, horizontal scroll works with fade indicator.
  </verify>
  <done>
DataTable supports row expansion with custom content and responsive horizontal scrolling with visual indicator.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tests for expansion and responsive behavior</name>
  <files>
    app/components/ui/__tests__/DataTable.test.js
  </files>
  <action>
Add comprehensive tests for expansion and keyboard navigation:

**Expansion tests:**
1. enableExpansion adds expand icon column
2. Clicking row toggles expansion
3. Expanded row shows renderExpandedContent output
4. aria-expanded attribute updates
5. Chevron rotates when expanded
6. getRowCanExpand controls which rows can expand

**Keyboard navigation tests:**
1. First row has tabIndex={0}, others have tabIndex={-1}
2. ArrowDown moves focus to next row
3. ArrowUp moves focus to previous row
4. Enter toggles expansion
5. Space toggles selection
6. Arrow keys skip expansion content rows

**Responsive tests:**
1. Scroll container has overflow-x-auto
2. Fade indicator appears when content overflows
3. Fade indicator hides when scrolled to end

**Test helpers:**
```javascript
// Simulate scrollable container
const setScrollWidth = (container, scrollWidth, clientWidth) => {
  Object.defineProperty(container, 'scrollWidth', { value: scrollWidth, configurable: true });
  Object.defineProperty(container, 'clientWidth', { value: clientWidth, configurable: true });
  Object.defineProperty(container, 'scrollLeft', { value: 0, configurable: true, writable: true });
};
```
  </action>
  <verify>
`npm test -- --testPathPattern="DataTable" --watchAll=false` passes all tests including expansion and keyboard navigation.
  </verify>
  <done>
DataTable tests cover expansion, keyboard navigation, and responsive scroll behavior.
  </done>
</task>

</tasks>

<verification>
1. enableExpansion adds expand chevron column
2. Clicking row expands to show additional content
3. renderExpandedContent prop customizes expansion content
4. Arrow keys navigate between rows
5. Enter expands/collapses, Space selects/deselects
6. Expanded rows skip during keyboard navigation
7. Horizontal scroll works on narrow screens
8. Fade gradient indicates more content to scroll
9. aria-expanded reflects expansion state
10. All tests pass
</verification>

<success_criteria>
- enableExpansion=true adds expand icon column
- Clicking row body expands row (checkbox click still selects)
- Expanded content renders below row spanning all columns
- renderExpandedContent prop controls expansion content
- Keyboard: ArrowUp/Down navigates, Enter expands, Space selects
- Roving tabindex: only one row focusable at a time
- Table horizontally scrolls on mobile
- Fade gradient on right edge indicates scrollable content
- Screen reader announces "expanded"/"collapsed" via aria-expanded
- getRowCanExpand controls which rows can expand
</success_criteria>

<output>
After completion, create `.planning/phases/34-data-table/34-03-SUMMARY.md`
</output>
