---
phase: 34-data-table
plan: 04
type: execute
wave: 4
depends_on: ["34-03"]
files_modified:
  - app/settings/notifications/history/page.js
  - app/debug/design-system/data/component-docs.js
  - app/debug/design-system/page.js
autonomous: false

must_haves:
  truths:
    - "User can see notification history in table format"
    - "User can sort notifications by date, type, status"
    - "User can filter notifications by type and status"
    - "User can paginate through notification history"
    - "User can expand notification to see full message"
    - "DataTable appears in design system documentation"
  artifacts:
    - path: "app/settings/notifications/history/page.js"
      provides: "Notification history using DataTable"
      contains: "DataTable"
    - path: "app/debug/design-system/data/component-docs.js"
      provides: "DataTable documentation for design system"
      contains: "DataTable"
  key_links:
    - from: "app/settings/notifications/history/page.js"
      to: "app/components/ui/DataTable.js"
      via: "import and usage"
      pattern: "DataTable"
    - from: "app/settings/notifications/history/page.js"
      to: "/api/notifications/history"
      via: "fetch for data"
      pattern: "api/notifications/history"
---

<objective>
Apply DataTable to the notification history page and add to design system documentation.

Purpose: Replace the existing NotificationInbox component with the new DataTable, demonstrating real-world usage. Add comprehensive documentation to the design system page.

Output: Notification history page using DataTable with all features (sorting, filtering, pagination, expansion), plus design system documentation.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-data-table/34-CONTEXT.md
@.planning/phases/34-data-table/34-01-SUMMARY.md
@.planning/phases/34-data-table/34-02-SUMMARY.md
@.planning/phases/34-data-table/34-03-SUMMARY.md

# Existing page to update
@app/settings/notifications/history/page.js

# API for data
@app/api/notifications/history/route.js

# Design system patterns
@app/debug/design-system/data/component-docs.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace NotificationInbox with DataTable</name>
  <files>
    app/settings/notifications/history/page.js
  </files>
  <action>
Update notification history page to use DataTable:

**Column definitions:**
```javascript
const columns = useMemo(() => [
  {
    accessorKey: 'timestamp',
    header: 'Data',
    cell: ({ getValue }) => {
      const date = new Date(getValue());
      return format(date, 'dd/MM/yyyy HH:mm', { locale: it });
    },
    sortingFn: 'datetime',
  },
  {
    accessorKey: 'type',
    header: 'Tipo',
    cell: ({ getValue }) => {
      const type = getValue();
      const variants = {
        scheduler: 'ocean',
        error: 'danger',
        maintenance: 'warning',
        test: 'neutral',
        generic: 'neutral',
      };
      return <Badge variant={variants[type] || 'neutral'}>{type}</Badge>;
    },
    filterFn: 'equals',
  },
  {
    accessorKey: 'status',
    header: 'Stato',
    cell: ({ getValue }) => {
      const status = getValue();
      const variants = {
        sent: 'ocean',
        delivered: 'sage',
        failed: 'danger',
      };
      return <Badge variant={variants[status] || 'neutral'}>{status}</Badge>;
    },
    filterFn: 'equals',
  },
  {
    accessorKey: 'title',
    header: 'Titolo',
    cell: ({ getValue }) => (
      <Text className="max-w-[200px] truncate">{getValue()}</Text>
    ),
  },
], []);
```

**Data fetching:**
- Use SWR or useState + useEffect for fetching from /api/notifications/history
- Transform API response to flat array for DataTable
- Handle pagination via API (server-side) or client-side (load all, paginate locally)

**DataTable usage:**
```jsx
<DataTable
  data={notifications}
  columns={columns}
  density="compact"
  enableFiltering
  enablePagination
  enableExpansion
  pageSize={25}
  pageSizeOptions={[25, 50, 100]}
  showRowCount
  getRowId={(row) => row.id}
  renderExpandedContent={(row) => (
    <div className="space-y-2">
      <Text variant="secondary" size="sm">
        <strong>Messaggio:</strong> {row.original.body}
      </Text>
      {row.original.deviceId && (
        <Text variant="secondary" size="sm">
          <strong>Dispositivo:</strong> {row.original.deviceId}
        </Text>
      )}
    </div>
  )}
/>
```

**Empty state:**
- Show EmptyState component when no notifications
- Message: "Nessuna notifica trovata"

**Loading state:**
- Show Skeleton while fetching
- Or use DataTable's loading state if implemented
  </action>
  <verify>
Navigate to /settings/notifications/history and verify table displays notification data with sorting, filtering, pagination.
  </verify>
  <done>
Notification history page uses DataTable with sorting by date/type/status, filtering, pagination, and expandable rows showing full message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add DataTable documentation to design system</name>
  <files>
    app/debug/design-system/data/component-docs.js
    app/debug/design-system/page.js
  </files>
  <action>
**Add to component-docs.js:**

```javascript
export const dataTableDocs = {
  name: 'DataTable',
  description: 'Full-featured data table with sorting, filtering, selection, pagination, and row expansion. Built on TanStack Table v8.',
  status: 'stable',
  version: '4.0',
  props: [
    { name: 'data', type: 'T[]', required: true, description: 'Array of data objects to display' },
    { name: 'columns', type: 'ColumnDef<T>[]', required: true, description: 'TanStack Table column definitions' },
    { name: 'density', type: "'compact' | 'default' | 'relaxed'", default: "'default'", description: 'Row height (32px/44px/52px)' },
    { name: 'striped', type: 'boolean', default: 'false', description: 'Alternating row backgrounds' },
    { name: 'stickyHeader', type: 'boolean', default: 'false', description: 'Sticky header on scroll' },
    { name: 'selectionMode', type: "'none' | 'single' | 'multi'", default: "'none'", description: 'Row selection mode' },
    { name: 'enableFiltering', type: 'boolean', default: 'false', description: 'Enable global search and column filters' },
    { name: 'enablePagination', type: 'boolean', default: 'false', description: 'Enable pagination controls' },
    { name: 'enableExpansion', type: 'boolean', default: 'false', description: 'Enable row expansion' },
    { name: 'pageSize', type: 'number', default: '10', description: 'Rows per page' },
    { name: 'pageSizeOptions', type: 'number[]', default: '[10, 25, 50, 100]', description: 'Rows per page options' },
    { name: 'showRowCount', type: 'boolean', default: 'true', description: 'Show "Showing X-Y of Z"' },
    { name: 'getRowId', type: '(row: T) => string', description: 'Custom row ID function (prevents selection bugs on sort)' },
    { name: 'renderExpandedContent', type: '(row: Row<T>) => ReactNode', description: 'Custom expansion content' },
    { name: 'onSelectionChange', type: '(selectedRowIds: Record<string, boolean>) => void', description: 'Selection change callback' },
  ],
  accessibility: [
    'aria-sort on sortable columns (ascending/descending/none)',
    'aria-expanded on expandable rows',
    'aria-selected on selectable rows',
    'aria-live region for filter/page/selection announcements',
    'Keyboard navigation: ArrowUp/Down to move, Enter to expand, Space to select',
    'Roving tabindex pattern for efficient keyboard navigation',
  ],
  examples: [
    {
      title: 'Basic Table',
      code: `<DataTable
  data={users}
  columns={[
    { accessorKey: 'name', header: 'Name' },
    { accessorKey: 'email', header: 'Email' },
  ]}
/>`,
    },
    {
      title: 'With All Features',
      code: `<DataTable
  data={notifications}
  columns={columns}
  density="compact"
  striped
  selectionMode="multi"
  enableFiltering
  enablePagination
  enableExpansion
  pageSize={25}
  getRowId={(row) => row.id}
  renderExpandedContent={(row) => (
    <div>{row.original.details}</div>
  )}
/>`,
    },
  ],
};
```

**Add to page.js:**

Add DataTable section after existing components (Dialog Patterns section).
Follow existing pattern:
1. Import dataTableDocs
2. Add DataTable demo with sample data
3. Show variants (density, striped, with selection, with pagination)
4. Include PropTable for props documentation
  </action>
  <verify>
Navigate to /debug/design-system and verify DataTable section appears with interactive demos and documentation.
  </verify>
  <done>
Design system page includes DataTable documentation with props table, accessibility info, and interactive examples.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete DataTable implementation with:
1. Sorting (click header, visual indicators, aria-sort)
2. Selection (checkbox column, bulk actions toolbar)
3. Filtering (global search, column filters, filter chips)
4. Pagination (page numbers, rows per page, row count)
5. Expansion (click row to expand, custom content)
6. Responsive (horizontal scroll with fade indicator)
7. Applied to notification history page
8. Documented in design system
  </what-built>
  <how-to-verify>
1. Go to /debug/design-system
   - Scroll to DataTable section
   - Verify demos show different configurations
   - Check PropTable lists all props

2. Go to /settings/notifications/history (must be logged in)
   - Verify notifications display in table format
   - Click column header to sort (check sort arrows)
   - Use search to filter notifications
   - Use pagination to navigate pages
   - Click row to expand and see full message
   - On mobile: verify horizontal scroll with fade indicator

3. Accessibility checks:
   - Tab to table, use arrows to navigate rows
   - Press Enter to expand, Space to select
   - Run screen reader: verify aria-sort and aria-expanded announcements
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Notification history page displays data in DataTable
2. Sorting works on all columns
3. Filtering by type/status with filter chips
4. Pagination controls navigate through history
5. Row expansion shows full notification message
6. Design system page documents DataTable
7. Interactive demos work in design system
8. Mobile horizontal scroll with indicator
9. Keyboard navigation works
10. Screen reader announces state changes
</verification>

<success_criteria>
- /settings/notifications/history uses DataTable instead of NotificationInbox
- Columns: Date, Type (badge), Status (badge), Title (truncated)
- Sorting: Click header sorts, visual arrows indicate direction
- Filtering: Search input + column filters + removable chips
- Pagination: Page numbers, "Showing 1-25 of 150" format
- Expansion: Click row shows full message body and device info
- Design system: DataTable section with props, examples, accessibility info
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-data-table/34-04-SUMMARY.md`
</output>
