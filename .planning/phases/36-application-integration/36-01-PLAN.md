---
phase: 36-application-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/stove/StoveCard.js
  - app/components/devices/thermostat/ThermostatCard.js
  - app/components/devices/lights/LightsCard.js
  - app/components/devices/camera/CameraCard.js
  - app/components/ui/DeviceCard.js
  - app/components/ui/__tests__/DeviceCard.test.js
autonomous: true

must_haves:
  truths:
    - "Device cards have visible quick action icon buttons in Controls area"
    - "Device cards support right-click context menu on desktop"
    - "Device cards support long-press context menu on mobile"
    - "Quick actions are consistent across device types (similar patterns)"
  artifacts:
    - path: "app/components/ui/DeviceCard.js"
      provides: "Quick actions slot and context menu wrapper"
      contains: "RightClickMenu"
    - path: "app/components/devices/stove/StoveCard.js"
      provides: "Stove quick actions (power toggle, power level, fan)"
      contains: "Button.Icon"
    - path: "app/components/devices/thermostat/ThermostatCard.js"
      provides: "Thermostat quick actions (temp adjust, mode)"
      contains: "Button.Icon"
    - path: "app/components/devices/lights/LightsCard.js"
      provides: "Lights quick actions (on/off, brightness via slider)"
      contains: "Button.Icon"
  key_links:
    - from: "DeviceCard.js"
      to: "RightClickMenu"
      via: "Context menu wrapper around card content"
      pattern: "RightClickMenu\\.Trigger"
    - from: "Device cards"
      to: "useContextMenuLongPress"
      via: "Long-press hook for mobile context menu"
      pattern: "useContextMenuLongPress"
---

<objective>
Add quick action icon buttons to device cards and wrap cards with context menu support.

Purpose: Enable immediate device control via visible buttons and extended actions via right-click/long-press context menu.

Output:
- Quick action buttons in each device card's primary control area
- Context menu on all device cards (desktop right-click, mobile long-press)
- Consistent patterns across all device types
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-application-integration/36-CONTEXT.md
@.planning/phases/36-application-integration/36-RESEARCH.md
@app/components/ui/DeviceCard.js
@app/components/ui/RightClickMenu.js
@app/components/ui/Button.js
@app/hooks/useContextMenuLongPress.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Context Menu Wrapper to DeviceCard</name>
  <files>
    app/components/ui/DeviceCard.js
    app/components/ui/__tests__/DeviceCard.test.js
  </files>
  <action>
Extend DeviceCard to wrap content with RightClickMenu for context menu support:

1. Add new props to DeviceCard:
   - `contextMenuItems: Array<{ icon, label, onSelect, disabled?, separator? }>` - Menu items
   - `onContextMenu: Function` - Optional callback when context menu opens (for state sync)

2. Import RightClickMenu and useContextMenuLongPress:
   ```javascript
   import RightClickMenu from './RightClickMenu';
   import { useContextMenuLongPress, longPressPreventSelection } from '@/app/hooks/useContextMenuLongPress';
   ```

3. Add state and hook for context menu:
   ```javascript
   const [contextMenuOpen, setContextMenuOpen] = useState(false);
   const { bind: longPressBind, isPressed } = useContextMenuLongPress(() => {
     setContextMenuOpen(true);
   });
   ```

4. Wrap the Card content with RightClickMenu.Trigger:
   ```jsx
   {contextMenuItems && contextMenuItems.length > 0 ? (
     <RightClickMenu open={contextMenuOpen} onOpenChange={setContextMenuOpen}>
       <RightClickMenu.Trigger asChild>
         <div
           {...longPressBind()}
           style={{
             ...longPressPreventSelection,
             transform: isPressed ? 'scale(0.98)' : 'scale(1)',
             transition: 'transform 150ms cubic-bezier(0.4, 0, 0.2, 1)',
           }}
         >
           {/* Existing card content */}
         </div>
       </RightClickMenu.Trigger>
       <RightClickMenu.Content>
         {contextMenuItems.map((item, index) => (
           item.separator ? (
             <RightClickMenu.Separator key={index} />
           ) : (
             <RightClickMenu.Item
               key={item.label}
               icon={item.icon}
               onSelect={item.onSelect}
               disabled={item.disabled}
             >
               {item.label}
             </RightClickMenu.Item>
           )
         ))}
       </RightClickMenu.Content>
     </RightClickMenu>
   ) : (
     // Original card without context menu
   )}
   ```

5. Update tests to verify context menu integration (add basic render test).

**Important:** Only add context menu wrapper if contextMenuItems prop is provided (backwards compatible).
  </action>
  <verify>
npm test -- --testPathPattern=DeviceCard --run
  </verify>
  <done>
DeviceCard supports optional context menu via contextMenuItems prop, maintains backwards compatibility when prop not provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Quick Actions and Context Menu to StoveCard</name>
  <files>
    app/components/devices/stove/StoveCard.js
  </files>
  <action>
Add quick action buttons and context menu to StoveCard per user decisions:

**Quick Actions (always visible in status display area):**
Per CONTEXT.md: "Stove card: On/Off toggle + Power level + Fan control visible"

1. Import Button component and icons:
   ```javascript
   import { Power, Plus, Minus, Fan, Settings, Info, Activity, RefreshCw } from 'lucide-react';
   ```

2. Add a compact quick actions bar below the status display box (inside the existing card structure):
   ```jsx
   {/* Quick Actions Bar - Always visible */}
   <div className="flex items-center justify-center gap-3 mt-4">
     {/* Power Toggle */}
     <Button.Icon
       icon={<Power className="w-5 h-5" />}
       aria-label={isAccesa ? "Spegni Stufa" : "Accendi Stufa"}
       variant={isAccesa ? 'ember' : 'subtle'}
       size="md"
       onClick={isAccesa ? handleShutdown : handleIgnite}
       disabled={loading || (!isAccesa && needsMaintenance)}
     />

     {/* Power Level Controls (only when stove is in WORK mode) */}
     {status?.toUpperCase().includes('WORK') && (
       <div className="flex items-center gap-1 px-2 py-1 rounded-xl bg-slate-800/50 border border-slate-700/50">
         <Button.Icon
           icon={<Minus className="w-4 h-4" />}
           aria-label="Diminuisci Potenza"
           variant="ghost"
           size="sm"
           onClick={() => handlePowerChange({ target: { value: (powerLevel - 1).toString() }})}
           disabled={loading || !powerLevel || powerLevel <= 1}
         />
         <span className="text-sm font-bold text-ember-400 w-6 text-center">{powerLevel}</span>
         <Button.Icon
           icon={<Plus className="w-4 h-4" />}
           aria-label="Aumenta Potenza"
           variant="ghost"
           size="sm"
           onClick={() => handlePowerChange({ target: { value: (powerLevel + 1).toString() }})}
           disabled={loading || !powerLevel || powerLevel >= 5}
         />
       </div>
     )}

     {/* Fan Control (only when stove is in WORK mode) */}
     {status?.toUpperCase().includes('WORK') && (
       <Button.Icon
         icon={<Fan className="w-5 h-5" />}
         aria-label="Regola Ventola"
         variant="subtle"
         size="md"
         onClick={() => {
           // Scroll to fan control section or open modal
           document.querySelector('[data-control="fan"]')?.scrollIntoView({ behavior: 'smooth' });
         }}
       />
     )}
   </div>
   ```

3. Add data attribute to fan control section for scroll targeting:
   - Find the "Ventilazione" control section and add `data-control="fan"`

**Context Menu (extended actions):**
Per CONTEXT.md: "Context menu includes more options than quick buttons (settings, details, advanced actions)"

4. Define context menu items array:
   ```javascript
   const stoveContextMenuItems = [
     {
       icon: <Settings className="w-4 h-4" />,
       label: 'Impostazioni Stufa',
       onSelect: () => router.push('/stove/settings'),
     },
     {
       icon: <Activity className="w-4 h-4" />,
       label: 'Log Attivita',
       onSelect: () => router.push('/stove/logs'),
     },
     { separator: true },
     {
       icon: <RefreshCw className="w-4 h-4" />,
       label: 'Aggiorna Stato',
       onSelect: handleManualRefresh,
     },
   ];
   ```

5. Pass contextMenuItems to DeviceCard (or wrap the main Card with RightClickMenu if not using DeviceCard wrapper).

Note: StoveCard builds its own Card structure, so we need to add the RightClickMenu wrapper directly in StoveCard rather than using DeviceCard's wrapper.

**Accessibility:**
- All Button.Icon components MUST have aria-label (already shown above)
- Disabled states must be properly managed
  </action>
  <verify>
Manual verification: Dev server running, navigate to homepage, verify:
1. Quick action buttons visible in Stove card status area
2. Power toggle works (accendi/spegni)
3. Power level +/- works when stove is in WORK mode
4. Right-click opens context menu
5. Long-press on mobile opens context menu
  </verify>
  <done>
StoveCard has quick action buttons (power toggle, power level +/-, fan) and context menu (settings, activity log, refresh).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Quick Actions and Context Menu to ThermostatCard, LightsCard, CameraCard</name>
  <files>
    app/components/devices/thermostat/ThermostatCard.js
    app/components/devices/lights/LightsCard.js
    app/components/devices/camera/CameraCard.js
  </files>
  <action>
Add quick actions and context menu to remaining device cards following the same pattern as StoveCard.

**ThermostatCard Quick Actions:**
Per CONTEXT.md: "Thermostat card: Temperature adjustment + Mode switcher (Schedule/Manual/Away)"

1. Add quick actions bar in the selected room temperature display area:
   ```jsx
   {/* Quick Actions - below temperature display */}
   <div className="flex items-center justify-center gap-3 mt-4">
     {/* Temperature Adjustment */}
     {selectedRoom?.setpoint && !selectedRoom?.isOffline && (
       <div className="flex items-center gap-1 px-2 py-1 rounded-xl bg-slate-800/50 border border-slate-700/50">
         <Button.Icon
           icon={<Minus className="w-4 h-4" />}
           aria-label="Diminuisci Temperatura"
           variant="ghost"
           size="sm"
           onClick={() => handleTemperatureChange(selectedRoom.id, selectedRoom.setpoint - 0.5)}
           disabled={refreshing || selectedRoom.setpoint <= 15}
         />
         <span className="text-sm font-bold text-ocean-400 w-10 text-center">{selectedRoom.setpoint}Â°</span>
         <Button.Icon
           icon={<Plus className="w-4 h-4" />}
           aria-label="Aumenta Temperatura"
           variant="ghost"
           size="sm"
           onClick={() => handleTemperatureChange(selectedRoom.id, selectedRoom.setpoint + 0.5)}
           disabled={refreshing || selectedRoom.setpoint >= 30}
         />
       </div>
     )}

     {/* Mode Quick Cycle (only show current mode icon, click to cycle) */}
     <Button.Icon
       icon={mode === 'schedule' ? <Calendar className="w-5 h-5" /> :
             mode === 'away' ? <Home className="w-5 h-5" /> :
             mode === 'hg' ? <Snowflake className="w-5 h-5" /> :
             <Power className="w-5 h-5" />}
       aria-label={`Modalita attuale: ${mode}. Clicca per cambiare`}
       variant="subtle"
       size="md"
       onClick={() => {
         // Cycle: schedule -> away -> hg -> off -> schedule
         const modes = ['schedule', 'away', 'hg', 'off'];
         const nextIndex = (modes.indexOf(mode) + 1) % modes.length;
         handleModeChange(modes[nextIndex]);
       }}
       disabled={refreshing}
     />
   </div>
   ```

2. Add context menu items for ThermostatCard (wrap with RightClickMenu):
   ```javascript
   const thermostatContextMenuItems = [
     { icon: <Settings />, label: 'Impostazioni Termostato', onSelect: () => router.push('/thermostat/settings') },
     { icon: <Calendar />, label: 'Programmazioni', onSelect: () => router.push('/thermostat/schedules') },
     { separator: true },
     { icon: <RefreshCw />, label: 'Aggiorna', onSelect: handleRefresh },
   ];
   ```

**LightsCard Quick Actions:**
Per CONTEXT.md: "Lights and Camera: Claude's discretion based on device capabilities - likely on/off + brightness"

1. LightsCard already has good controls. Add quick action bar below room selection:
   ```jsx
   {/* Quick Actions */}
   {selectedRoom && (
     <div className="flex items-center justify-center gap-3 mb-4">
       <Button.Icon
         icon={<Power className="w-5 h-5" />}
         aria-label={isRoomOn ? "Spegni Luci" : "Accendi Luci"}
         variant={isRoomOn ? 'ember' : 'subtle'}
         size="md"
         onClick={() => handleRoomToggle(selectedRoomGroupedLightId, !isRoomOn)}
         disabled={refreshing || !selectedRoomGroupedLightId}
       />
       {isRoomOn && (
         <div className="flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800/50 border border-slate-700/50">
           <Sun className="w-4 h-4 text-warning-400" />
           <Slider
             value={avgBrightness}
             onChange={(v) => handleBrightnessChange(selectedRoomGroupedLightId, v.toString())}
             min={1}
             max={100}
             variant="ember"
             className="w-24"
             aria-label="Luminosita"
           />
         </div>
       )}
     </div>
   )}
   ```

2. Add context menu for LightsCard:
   ```javascript
   const lightsContextMenuItems = [
     { icon: <Settings />, label: 'Impostazioni Luci', onSelect: () => router.push('/lights/settings') },
     { icon: <Palette />, label: 'Controllo Colore', onSelect: () => router.push('/lights') },
     { separator: true },
     { icon: <RefreshCw />, label: 'Aggiorna', onSelect: handleRefresh },
   ];
   ```

**CameraCard Quick Actions:**
Per CONTEXT.md: "Camera quick actions - likely snapshot if available"

1. Add quick action for snapshot refresh:
   ```jsx
   {/* Quick Actions */}
   <div className="flex items-center justify-center gap-3 mb-4">
     <Button.Icon
       icon={<Camera className="w-5 h-5" />}
       aria-label="Cattura Snapshot"
       variant="subtle"
       size="md"
       onClick={() => fetchSnapshot(selectedCameraId)}
       disabled={snapshotLoading || !selectedCameraId}
     />
     {selectedCamera?.status === 'on' && (
       <Button.Icon
         icon={isLiveMode ? <Image className="w-5 h-5" /> : <Video className="w-5 h-5" />}
         aria-label={isLiveMode ? "Mostra Snapshot" : "Mostra Live"}
         variant="subtle"
         size="md"
         onClick={() => setIsLiveMode(!isLiveMode)}
       />
     )}
   </div>
   ```

2. Context menu for CameraCard:
   ```javascript
   const cameraContextMenuItems = [
     { icon: <Activity />, label: 'Eventi Camera', onSelect: () => router.push('/camera/events') },
     { icon: <Settings />, label: 'Impostazioni', onSelect: () => router.push('/camera/settings') },
     { separator: true },
     { icon: <RefreshCw />, label: 'Aggiorna', onSelect: handleRefresh },
   ];
   ```

**For all cards:**
- Import required icons from lucide-react
- Import RightClickMenu and useContextMenuLongPress
- Wrap main card content with RightClickMenu
- All Button.Icon must have aria-label
  </action>
  <verify>
Manual verification: Navigate to homepage with dev server:
1. ThermostatCard: temp +/- buttons visible, mode toggle works, right-click/long-press opens menu
2. LightsCard: power button and brightness slider visible, context menu works
3. CameraCard: snapshot button visible, live/snapshot toggle, context menu works
  </verify>
  <done>
All device cards (Thermostat, Lights, Camera) have quick action buttons and context menus with consistent patterns.
  </done>
</task>

</tasks>

<verification>
1. All quick action buttons are visible in device cards
2. All Button.Icon components have aria-label
3. Context menus open on right-click (desktop)
4. Context menus open on long-press (mobile)
5. Disabled states properly managed at boundaries
6. npm test passes for DeviceCard
</verification>

<success_criteria>
- QACT-01: Device cards have visible quick action icon buttons - VERIFIED
- QACT-02: Device cards support context menu on right-click/long-press - VERIFIED
- QACT-03: Quick actions are consistent across all device types - VERIFIED
- APPL-05: Context Menu on all device cards - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/36-application-integration/36-01-SUMMARY.md`
</output>
