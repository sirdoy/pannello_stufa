---
phase: 36-application-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/layout/CommandPaletteProvider.js
  - lib/commands/deviceCommands.js
  - app/components/ui/__tests__/CommandPalette.test.js
autonomous: true

must_haves:
  truths:
    - "Command Palette accessible from any page with Cmd+K/Ctrl+K"
    - "Device commands available in Command Palette (stove, thermostat, lights)"
    - "Commands execute device actions via API calls"
    - "Navigation commands work to all main pages"
  artifacts:
    - path: "lib/commands/deviceCommands.js"
      provides: "Device-specific command definitions"
      exports: ["getDeviceCommands"]
    - path: "app/components/layout/CommandPaletteProvider.js"
      provides: "Global command palette with device commands"
      contains: "getDeviceCommands"
  key_links:
    - from: "CommandPaletteProvider.js"
      to: "lib/commands/deviceCommands.js"
      via: "Import and merge device commands"
      pattern: "getDeviceCommands"
    - from: "deviceCommands.js"
      to: "/api/stove/*"
      via: "fetch calls for device control"
      pattern: "fetch.*api/stove"
---

<objective>
Extend Command Palette with device-specific commands for power users.

Purpose: Enable keyboard-driven device control from any page via Cmd+K/Ctrl+K shortcut.

Output:
- Device commands module with stove, thermostat, lights actions
- Updated CommandPaletteProvider with real device command implementations
- Full navigation commands to all pages
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-application-integration/36-CONTEXT.md
@.planning/phases/36-application-integration/36-RESEARCH.md
@app/components/layout/CommandPaletteProvider.js
@app/components/ui/CommandPalette.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Device Commands Module</name>
  <files>
    lib/commands/deviceCommands.js
  </files>
  <action>
Create a new module that defines device-specific commands for the Command Palette.

1. Create the file at `lib/commands/deviceCommands.js`:

```javascript
'use client';

import {
  Power,
  PowerOff,
  Plus,
  Minus,
  Thermometer,
  Calendar,
  Home,
  Snowflake,
  Lightbulb,
  Sun,
  Moon,
  Fan,
  RefreshCw,
} from 'lucide-react';

/**
 * Device Commands for Command Palette
 *
 * Per CONTEXT.md:
 * - Full command set: Navigation + Global actions + Device commands
 * - Device command format: Claude's discretion on organization
 * - No recent commands section (per CMDK-05 deferral)
 */

/**
 * Execute stove action with error handling
 */
async function executeStoveAction(endpoint, body = {}) {
  try {
    const response = await fetch(`/api/stove/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...body, source: 'command_palette' }),
    });
    const data = await response.json();
    if (data.error) {
      console.error(`[CommandPalette] Stove ${endpoint} error:`, data.error);
    }
    return data;
  } catch (err) {
    console.error(`[CommandPalette] Stove ${endpoint} failed:`, err);
  }
}

/**
 * Execute thermostat action with error handling
 */
async function executeThermostatAction(endpoint, body = {}) {
  try {
    const response = await fetch(`/api/netatmo/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await response.json();
    if (data.error) {
      console.error(`[CommandPalette] Thermostat ${endpoint} error:`, data.error);
    }
    return data;
  } catch (err) {
    console.error(`[CommandPalette] Thermostat ${endpoint} failed:`, err);
  }
}

/**
 * Execute lights action with error handling
 */
async function executeLightsAction(endpoint, method = 'PUT', body = {}) {
  try {
    const response = await fetch(`/api/hue/${endpoint}`, {
      method,
      headers: { 'Content-Type': 'application/json' },
      ...(method !== 'GET' && { body: JSON.stringify(body) }),
    });
    const data = await response.json();
    if (data.error) {
      console.error(`[CommandPalette] Lights ${endpoint} error:`, data.error);
    }
    return data;
  } catch (err) {
    console.error(`[CommandPalette] Lights ${endpoint} failed:`, err);
  }
}

/**
 * Get stove commands
 */
export function getStoveCommands() {
  return {
    heading: 'Stufa',
    items: [
      {
        id: 'stove-ignite',
        label: 'Accendi Stufa',
        icon: <Power className="w-4 h-4" />,
        shortcut: '⌘⇧S',
        onSelect: () => executeStoveAction('ignite'),
      },
      {
        id: 'stove-shutdown',
        label: 'Spegni Stufa',
        icon: <PowerOff className="w-4 h-4" />,
        onSelect: () => executeStoveAction('shutdown'),
      },
      {
        id: 'stove-power-up',
        label: 'Aumenta Potenza Stufa',
        icon: <Plus className="w-4 h-4" />,
        onSelect: async () => {
          // Get current power level first
          const statusRes = await fetch('/api/stove/get-power');
          const statusData = await statusRes.json();
          const currentPower = statusData?.Result ?? 3;
          if (currentPower < 5) {
            await executeStoveAction('set-power', { level: currentPower + 1 });
          }
        },
      },
      {
        id: 'stove-power-down',
        label: 'Diminuisci Potenza Stufa',
        icon: <Minus className="w-4 h-4" />,
        onSelect: async () => {
          const statusRes = await fetch('/api/stove/get-power');
          const statusData = await statusRes.json();
          const currentPower = statusData?.Result ?? 3;
          if (currentPower > 1) {
            await executeStoveAction('set-power', { level: currentPower - 1 });
          }
        },
      },
      {
        id: 'stove-fan-up',
        label: 'Aumenta Ventola Stufa',
        icon: <Fan className="w-4 h-4" />,
        onSelect: async () => {
          const statusRes = await fetch('/api/stove/get-fan');
          const statusData = await statusRes.json();
          const currentFan = statusData?.Result ?? 3;
          if (currentFan < 6) {
            await executeStoveAction('set-fan', { level: currentFan + 1 });
          }
        },
      },
      {
        id: 'stove-fan-down',
        label: 'Diminuisci Ventola Stufa',
        icon: <Fan className="w-4 h-4" />,
        onSelect: async () => {
          const statusRes = await fetch('/api/stove/get-fan');
          const statusData = await statusRes.json();
          const currentFan = statusData?.Result ?? 3;
          if (currentFan > 1) {
            await executeStoveAction('set-fan', { level: currentFan - 1 });
          }
        },
      },
    ],
  };
}

/**
 * Get thermostat commands
 */
export function getThermostatCommands() {
  return {
    heading: 'Termostato',
    items: [
      {
        id: 'thermo-mode-schedule',
        label: 'Modalita Automatica',
        icon: <Calendar className="w-4 h-4" />,
        onSelect: () => executeThermostatAction('set-therm-mode', { mode: 'schedule' }),
      },
      {
        id: 'thermo-mode-away',
        label: 'Modalita Away',
        icon: <Home className="w-4 h-4" />,
        onSelect: () => executeThermostatAction('set-therm-mode', { mode: 'away' }),
      },
      {
        id: 'thermo-mode-hg',
        label: 'Modalita Antigelo',
        icon: <Snowflake className="w-4 h-4" />,
        onSelect: () => executeThermostatAction('set-therm-mode', { mode: 'hg' }),
      },
      {
        id: 'thermo-temp-up',
        label: 'Aumenta Temperatura (+0.5°C)',
        icon: <Plus className="w-4 h-4" />,
        shortcut: '⌘↑',
        // Note: This requires knowing which room is selected - show info toast
        onSelect: () => {
          console.log('[CommandPalette] Temperature adjustment requires room selection - navigate to thermostat page');
          window.location.href = '/thermostat';
        },
      },
      {
        id: 'thermo-temp-down',
        label: 'Diminuisci Temperatura (-0.5°C)',
        icon: <Minus className="w-4 h-4" />,
        shortcut: '⌘↓',
        onSelect: () => {
          console.log('[CommandPalette] Temperature adjustment requires room selection - navigate to thermostat page');
          window.location.href = '/thermostat';
        },
      },
    ],
  };
}

/**
 * Get lights commands
 */
export function getLightsCommands() {
  return {
    heading: 'Luci',
    items: [
      {
        id: 'lights-all-on',
        label: 'Accendi Tutte le Luci',
        icon: <Lightbulb className="w-4 h-4" />,
        shortcut: '⌘⇧L',
        onSelect: async () => {
          // Get all rooms and toggle each
          const roomsRes = await fetch('/api/hue/rooms');
          const roomsData = await roomsRes.json();
          const rooms = roomsData.rooms || [];

          for (const room of rooms) {
            const groupedLightId = room.services?.find(s => s.rtype === 'grouped_light')?.rid;
            if (groupedLightId) {
              await executeLightsAction(`rooms/${groupedLightId}`, 'PUT', { on: { on: true } });
            }
          }
        },
      },
      {
        id: 'lights-all-off',
        label: 'Spegni Tutte le Luci',
        icon: <Moon className="w-4 h-4" />,
        onSelect: async () => {
          const roomsRes = await fetch('/api/hue/rooms');
          const roomsData = await roomsRes.json();
          const rooms = roomsData.rooms || [];

          for (const room of rooms) {
            const groupedLightId = room.services?.find(s => s.rtype === 'grouped_light')?.rid;
            if (groupedLightId) {
              await executeLightsAction(`rooms/${groupedLightId}`, 'PUT', { on: { on: false } });
            }
          }
        },
      },
      {
        id: 'lights-brightness-up',
        label: 'Aumenta Luminosita',
        icon: <Sun className="w-4 h-4" />,
        onSelect: () => {
          // Room-specific - navigate
          window.location.href = '/lights';
        },
      },
    ],
  };
}

/**
 * Get all device commands combined
 */
export function getDeviceCommands() {
  return [
    getStoveCommands(),
    getThermostatCommands(),
    getLightsCommands(),
  ];
}

export default getDeviceCommands;
```

**Key decisions:**
- Commands that require room/device selection redirect to the relevant page
- All API calls include error handling
- Shortcuts follow macOS convention (Cmd+Shift+Letter for global actions)
- Source tracking via 'command_palette' for logging
  </action>
  <verify>
File created at lib/commands/deviceCommands.js with proper exports
  </verify>
  <done>
Device commands module created with stove, thermostat, and lights command groups.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CommandPaletteProvider with Device Commands</name>
  <files>
    app/components/layout/CommandPaletteProvider.js
  </files>
  <action>
Replace placeholder commands with real device command implementations:

1. Import the device commands module:
   ```javascript
   import { getDeviceCommands } from '@/lib/commands/deviceCommands';
   ```

2. Update the defaultCommands to include real device commands:
   ```javascript
   /**
    * Build complete command set
    * - Navigation commands
    * - Device commands (from deviceCommands.js)
    * - Global actions
    */
   const defaultCommands = useMemo(() => [
     // Navigation
     {
       heading: 'Navigazione',
       items: [
         {
           id: 'nav-home',
           label: 'Dashboard',
           icon: <Home className="w-4 h-4" />,
           shortcut: '⌘D',
           onSelect: () => router.push('/'),
         },
         {
           id: 'nav-stove',
           label: 'Stufa',
           icon: <Flame className="w-4 h-4" />,
           onSelect: () => router.push('/stove'),
         },
         {
           id: 'nav-thermostat',
           label: 'Termostato',
           icon: <Thermometer className="w-4 h-4" />,
           onSelect: () => router.push('/thermostat'),
         },
         {
           id: 'nav-lights',
           label: 'Luci',
           icon: <Lightbulb className="w-4 h-4" />,
           onSelect: () => router.push('/lights'),
         },
         {
           id: 'nav-camera',
           label: 'Videocamera',
           icon: <Camera className="w-4 h-4" />,
           onSelect: () => router.push('/camera'),
         },
         {
           id: 'nav-settings',
           label: 'Impostazioni',
           icon: <Settings className="w-4 h-4" />,
           shortcut: '⌘,',
           onSelect: () => router.push('/settings'),
         },
         {
           id: 'nav-debug',
           label: 'Debug',
           icon: <Bug className="w-4 h-4" />,
           onSelect: () => router.push('/debug'),
         },
       ],
     },
     // Device commands from module
     ...getDeviceCommands(),
     // Global actions
     {
       heading: 'Azioni',
       items: [
         {
           id: 'action-refresh',
           label: 'Aggiorna Pagina',
           icon: <RefreshCw className="w-4 h-4" />,
           shortcut: '⌘R',
           onSelect: () => window.location.reload(),
         },
       ],
     },
   ], [router]);
   ```

3. Add missing icon imports:
   ```javascript
   import {
     Home,
     Settings,
     Thermometer,
     Flame,
     Lightbulb,
     Camera,
     Bug,
     RefreshCw,
   } from 'lucide-react';
   ```

4. Remove the old placeholder device actions (stove-ignite, stove-off with console.log).

5. Remove toggle-theme placeholder (out of scope for this phase).

6. Wrap defaultCommands in useMemo to prevent recreation on every render.
  </action>
  <verify>
npm test -- --testPathPattern=CommandPalette --run

Manual verification:
1. Open app, press Cmd+K
2. Search "stufa" - see stove commands
3. Search "luci" - see lights commands
4. Search "termostato" - see thermostat commands
5. Execute a command (e.g., "Accendi Stufa") - verify API call in network tab
  </verify>
  <done>
CommandPaletteProvider updated with real device commands, navigation to all pages, and proper command organization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Command Palette Tests</name>
  <files>
    app/components/ui/__tests__/CommandPalette.test.js
  </files>
  <action>
Update CommandPalette tests to verify device commands integration:

1. Add test for device commands rendering:
   ```javascript
   describe('Device Commands', () => {
     it('renders stove commands when searching', async () => {
       const commands = [
         {
           heading: 'Stufa',
           items: [
             { id: 'stove-ignite', label: 'Accendi Stufa', icon: <Power />, onSelect: jest.fn() },
           ],
         },
       ];

       render(<CommandPalette open={true} onOpenChange={() => {}} commands={commands} />);

       // Type in search
       const input = screen.getByPlaceholderText(/type a command/i);
       await userEvent.type(input, 'accendi');

       expect(screen.getByText('Accendi Stufa')).toBeInTheDocument();
     });

     it('calls onSelect when command is executed', async () => {
       const mockOnSelect = jest.fn();
       const commands = [
         {
           heading: 'Test',
           items: [
             { id: 'test-cmd', label: 'Test Command', onSelect: mockOnSelect },
           ],
         },
       ];

       render(<CommandPalette open={true} onOpenChange={() => {}} commands={commands} />);

       const item = screen.getByText('Test Command');
       await userEvent.click(item);

       expect(mockOnSelect).toHaveBeenCalled();
     });

     it('displays keyboard shortcuts when provided', () => {
       const commands = [
         {
           heading: 'Test',
           items: [
             { id: 'test', label: 'Test', shortcut: '⌘K', onSelect: () => {} },
           ],
         },
       ];

       render(<CommandPalette open={true} onOpenChange={() => {}} commands={commands} />);

       expect(screen.getByText('⌘K')).toBeInTheDocument();
     });
   });
   ```

2. Ensure existing tests still pass.
  </action>
  <verify>
npm test -- --testPathPattern=CommandPalette --run
  </verify>
  <done>
CommandPalette tests updated to verify device commands rendering and execution.
  </done>
</task>

</tasks>

<verification>
1. Cmd+K/Ctrl+K opens Command Palette from any page
2. Device commands visible in palette (Stufa, Termostato, Luci groups)
3. Navigation commands work (Dashboard, Stufa, Termostato, Luci, Camera, Settings, Debug)
4. Device actions execute API calls (verify in Network tab)
5. Keyboard shortcuts displayed for commands that have them
6. npm test passes for CommandPalette
</verification>

<success_criteria>
- APPL-04: Command Palette accessible from any page - VERIFIED
- CMDK-01: Cmd+K/Ctrl+K shortcut works - VERIFIED
- CMDK-02: Fuzzy search filters commands - VERIFIED
- CMDK-04: Enter executes selected command - VERIFIED
- Device commands integrated and functional - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/36-application-integration/36-02-SUMMARY.md`
</output>
