---
phase: 36-application-integration
plan: 03
type: execute
wave: 2
depends_on: ["36-01", "36-02"]
files_modified:
  - app/layout.js
  - app/(pages)/*/page.js
  - app/debug/*/page.js
  - app/components/ui/*.js
autonomous: true

must_haves:
  truths:
    - "All pages use v4.0 design system components consistently"
    - "No accessibility violations detected by axe-core-react"
    - "Pattern consistency across all pages (ARIA, keyboard, focus)"
    - "Debug pages included in audit scope"
  artifacts:
    - path: "app/layout.js"
      provides: "axe-core-react integration for dev mode"
      contains: "axe-core"
    - path: "All page files"
      provides: "Consistent component usage"
      contains: "import from ui"
  key_links:
    - from: "app/layout.js"
      to: "@axe-core/react"
      via: "Dynamic import in useEffect (dev only)"
      pattern: "import.*axe-core"
---

<objective>
Audit all pages for consistent component usage and accessibility, fixing issues immediately.

Purpose: Ensure v4.0 Advanced UI Components are properly applied throughout the application with consistent patterns and accessibility compliance.

Output:
- axe-core-react integration for runtime accessibility checking (dev mode)
- Fixed accessibility issues found during audit
- Consistent component patterns across all pages
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-application-integration/36-CONTEXT.md
@.planning/phases/36-application-integration/36-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add axe-core-react Integration</name>
  <files>
    app/layout.js
  </files>
  <action>
Add runtime accessibility auditing via axe-core-react (development mode only).

Per CONTEXT.md: "Checks: Component consistency + Pattern consistency + Accessibility (ARIA/keyboard)"

1. Install axe-core-react as dev dependency (if not already installed):
   ```bash
   npm install --save-dev @axe-core/react
   ```

2. Update app/layout.js to include axe-core-react in development:

   Find the RootLayout component and add the useEffect for axe-core:

   ```javascript
   'use client';

   import { useEffect } from 'react';
   // ... other imports

   export default function RootLayout({ children }) {
     // Runtime accessibility auditing (development only)
     useEffect(() => {
       if (process.env.NODE_ENV !== 'development') return;

       // Dynamic import to avoid bundling in production
       import('@axe-core/react').then((axe) => {
         const React = require('react');
         const ReactDOM = require('react-dom');
         axe.default(React, ReactDOM, 1000); // 1 second debounce
       }).catch((err) => {
         console.log('[Accessibility] axe-core-react not installed:', err.message);
       });
     }, []);

     return (
       // ... existing layout JSX
     );
   }
   ```

Note: The layout.js may already be a server component. If so, create a client wrapper:

   ```javascript
   // app/components/AxeDevtools.js
   'use client';

   import { useEffect } from 'react';

   export default function AxeDevtools() {
     useEffect(() => {
       if (process.env.NODE_ENV !== 'development') return;

       import('@axe-core/react').then((axe) => {
         const React = require('react');
         const ReactDOM = require('react-dom');
         axe.default(React, ReactDOM, 1000);
       }).catch(() => {
         // Silently fail if not installed
       });
     }, []);

     return null;
   }
   ```

   Then include it in layout.js:
   ```jsx
   import AxeDevtools from './components/AxeDevtools';

   export default function RootLayout({ children }) {
     return (
       <html lang="it">
         <body>
           <AxeDevtools />
           {/* ... rest of layout */}
         </body>
       </html>
     );
   }
   ```

3. Verify axe-core-react logs violations to console when running dev server.
  </action>
  <verify>
npm run dev
# Open browser console
# Navigate to any page
# Check for axe accessibility violations in console (if any exist)
  </verify>
  <done>
axe-core-react integrated for development mode accessibility auditing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit and Fix Main Pages</name>
  <files>
    app/(pages)/*/page.js
    app/page.js
  </files>
  <action>
Perform manual audit of main pages, checking for v4.0 component usage and accessibility.

Per CONTEXT.md: "Migration: Fix all issues found in this phase (no documentation-only approach)"

**Audit checklist for each page:**

1. **Component Consistency:**
   - [ ] Uses Button component from ui (not raw button)
   - [ ] Uses Card/SmartHomeCard for card layouts
   - [ ] Uses Heading for headings (not raw h1/h2)
   - [ ] Uses Text for body text
   - [ ] Uses Badge for status indicators
   - [ ] Uses Banner for alerts/warnings
   - [ ] Uses Tabs (if tabbed interface)
   - [ ] Uses Accordion (if expandable sections)

2. **Accessibility:**
   - [ ] All images have alt text
   - [ ] All interactive elements keyboard accessible
   - [ ] All Button.Icon have aria-label
   - [ ] Form inputs have associated labels
   - [ ] Color contrast meets WCAG AA
   - [ ] Focus visible on all interactive elements

3. **Pattern Consistency:**
   - [ ] cn() for class merging (not raw template literals)
   - [ ] Consistent spacing using design system classes
   - [ ] Loading states use LoadingOverlay or Spinner
   - [ ] Error states use Banner or ErrorAlert

**Pages to audit:**
- / (Homepage with device cards)
- /stove/* (Stove pages)
- /thermostat/* (Thermostat pages)
- /lights/* (Lights pages)
- /camera/* (Camera pages)
- /settings/* (Settings pages)
- /netatmo (Connection page)

**Fixing approach:**
For each issue found, fix it immediately in the file. Common fixes:

```javascript
// BEFORE: Raw button
<button onClick={...}>Click</button>

// AFTER: Design system Button
<Button variant="subtle" onClick={...}>Click</Button>
```

```javascript
// BEFORE: Icon button without aria-label
<Button.Icon icon={<Power />} onClick={...} />

// AFTER: With aria-label
<Button.Icon icon={<Power />} aria-label="Accendi" onClick={...} />
```

```javascript
// BEFORE: Raw heading
<h2 className="text-lg font-bold">Title</h2>

// AFTER: Design system Heading
<Heading level={2} size="lg">Title</Heading>
```

Since the codebase is already well-structured with design system components (based on earlier phases), focus on:
1. Any remaining raw HTML elements that should use components
2. Missing aria-labels on icon-only buttons
3. axe-core-react reported violations
  </action>
  <verify>
# Run dev server and check each page
npm run dev

# For each page:
# 1. Open in browser
# 2. Check console for axe violations
# 3. Tab through page to verify keyboard navigation
# 4. Check Button.Icon components have aria-label in React DevTools
  </verify>
  <done>
Main pages audited and any accessibility/consistency issues fixed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Audit and Fix Debug Pages</name>
  <files>
    app/debug/*/page.js
    app/debug/*.js
  </files>
  <action>
Audit debug pages for component consistency and accessibility.

Per CONTEXT.md: "Scope: All pages including Debug pages"

**Debug pages to audit:**
- /debug (Debug index)
- /debug/design-system (Design system showcase)
- /debug/api (API testing)
- /debug/firebase (Firebase testing)
- /debug/stove (Stove debugging)
- /debug/thermostat (Thermostat debugging)
- /debug/logs (Log viewer)
- /debug/cron (Cron monitoring)
- /debug/notifications (Notification testing)

**Special considerations for debug pages:**
1. Debug pages may use raw HTML for technical displays (acceptable)
2. Data tables should use DataTable component
3. Status indicators should use Badge/HealthIndicator
4. Interactive elements still need accessibility

**Audit and fix:**

1. Check /debug/design-system - this is the reference, should already be correct

2. For other debug pages, ensure:
   - Uses Card component for sections
   - Uses Tabs component if tabbed (Phase 30)
   - Uses DataTable for data grids (Phase 34)
   - Uses Button component for actions
   - Has proper headings structure

Common patterns in debug pages that may need fixing:

```javascript
// BEFORE: Raw table
<table>...</table>

// AFTER: If data needs sorting/filtering, use DataTable
// If simple display table, keep raw but add proper accessibility
<table role="table">
  <thead><tr><th scope="col">Header</th></tr></thead>
  <tbody>...</tbody>
</table>
```

```javascript
// BEFORE: Raw pre/code block
<pre>{JSON.stringify(data)}</pre>

// AFTER: With proper styling
<pre className="bg-slate-800/50 rounded-xl p-4 overflow-x-auto text-sm font-mono">
  {JSON.stringify(data, null, 2)}
</pre>
```

Note: Debug pages are developer tools, so some raw HTML is acceptable for technical output.
Focus on:
1. Navigation and buttons using design system
2. Accessibility of interactive elements
3. Consistent Card/Tabs usage for structure
  </action>
  <verify>
# Check each debug page
npm run dev

# Navigate to /debug and each sub-page
# Check console for axe violations
# Verify keyboard navigation works
  </verify>
  <done>
Debug pages audited and consistency issues fixed. Interactive elements are accessible.
  </done>
</task>

</tasks>

<verification>
1. axe-core-react integrated and reporting in dev mode
2. No critical accessibility violations on any page
3. Button.Icon components have aria-label throughout
4. Design system components used consistently
5. Debug pages accessible and using appropriate components
6. Keyboard navigation works on all interactive elements
</verification>

<success_criteria>
- APPL-01: Tabs used on thermostat page - VERIFIED (from Phase 30)
- APPL-02: Accordion used for expandable device details - VERIFIED (from Phase 31)
- APPL-03: DataTable used for notification history - VERIFIED (from Phase 34)
- APPL-06: Sheet used for mobile-friendly forms - VERIFIED (from Phase 31)
- APPL-07: Confirmation Dialog for destructive actions - VERIFIED (from Phase 33)
- APPL-08: All pages use new components consistently - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/36-application-integration/36-03-SUMMARY.md`
</output>
