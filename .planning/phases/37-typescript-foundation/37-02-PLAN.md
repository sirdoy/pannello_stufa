---
phase: 37-typescript-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - types/index.ts
  - types/firebase/index.ts
  - types/firebase/stove.ts
  - types/firebase/maintenance.ts
  - types/firebase/notifications.ts
  - types/firebase/devices.ts
  - types/api/index.ts
  - types/api/responses.ts
  - types/api/errors.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Developer can import Firebase types from @/types/firebase"
    - "Developer can import API types from @/types/api"
    - "Types match existing Firebase data structures"
  artifacts:
    - path: "types/index.ts"
      provides: "Barrel export for all types"
      min_lines: 5
    - path: "types/firebase/stove.ts"
      provides: "Stove state types"
      contains: "StoveStatus"
    - path: "types/api/responses.ts"
      provides: "API response types"
      contains: "ApiResponse"
  key_links:
    - from: "types/api/errors.ts"
      to: "lib/core/apiErrors.js"
      via: "Type derivation from ERROR_CODES"
      pattern: "ERROR_CODES"
---

<objective>
Create core type definitions for Firebase data structures and API patterns.

Purpose: Establish shared types that can be imported during incremental migration.
Output: types/ directory with Firebase and API type definitions (TYPE-01, TYPE-02).
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-typescript-foundation/37-RESEARCH.md
@lib/core/apiErrors.js
@lib/core/apiResponse.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Firebase data structure types (TYPE-01)</name>
  <files>
types/firebase/index.ts
types/firebase/stove.ts
types/firebase/maintenance.ts
types/firebase/notifications.ts
types/firebase/devices.ts
  </files>
  <action>
Create types/firebase/ directory with type definitions based on existing Firebase data structures.

**types/firebase/stove.ts:**
```typescript
/**
 * Stove data types - matches Firebase /stove/* structure
 */

/** Stove operational status */
export type StoveStatus =
  | 'off'
  | 'igniting'
  | 'running'
  | 'modulating'
  | 'shutdown'
  | 'error'
  | 'standby';

/** Stove power level (1-5) */
export type StovePowerLevel = 1 | 2 | 3 | 4 | 5;

/** Stove state as stored in Firebase /stove/state */
export interface StoveState {
  status: StoveStatus;
  power: StovePowerLevel;
  targetTemperature: number;
  currentTemperature?: number;
  exhaustTemperature?: number;
  lastUpdatedAt: string; // ISO 8601
  errorCode?: string;
  errorMessage?: string;
}

/** Stove command for API requests */
export interface StoveCommand {
  action: 'power_on' | 'power_off' | 'set_power' | 'set_temperature';
  value?: number;
}
```

**types/firebase/maintenance.ts:**
```typescript
/**
 * Maintenance data types - matches Firebase /maintenance/* structure
 */

/** Maintenance history entry type */
export type MaintenanceType = 'cleaning' | 'inspection' | 'repair';

/** Single maintenance history entry */
export interface MaintenanceHistoryEntry {
  timestamp: string; // ISO 8601
  type: MaintenanceType;
  notes?: string;
}

/** Maintenance record as stored in Firebase /maintenance */
export interface MaintenanceRecord {
  lastCleaning: string; // ISO 8601
  totalHours: number;
  hoursSinceLastCleaning: number;
  needsCleaning: boolean;
  cleaningThresholdHours: number;
  history?: MaintenanceHistoryEntry[];
}
```

**types/firebase/notifications.ts:**
```typescript
/**
 * Notification data types - matches Firebase /notifications/* structure
 */

/** Notification types available in the system */
export type NotificationType =
  | 'alert'
  | 'system'
  | 'maintenance'
  | 'scheduler'
  | 'coordination';

/** Notification delivery status */
export type NotificationStatus =
  | 'pending'
  | 'sent'
  | 'delivered'
  | 'displayed'
  | 'failed';

/** FCM token record in Firebase */
export interface FCMToken {
  token: string;
  deviceId: string;
  deviceName?: string;
  platform: 'web' | 'android' | 'ios';
  createdAt: string;
  lastUsedAt: string;
  status: 'active' | 'inactive' | 'invalid';
}

/** Notification preferences */
export interface NotificationPreferences {
  enabled: boolean;
  types: {
    alert: boolean;
    system: boolean;
    maintenance: boolean;
    scheduler: boolean;
    coordination: boolean;
  };
  dndEnabled: boolean;
  dndStart?: string; // HH:MM format
  dndEnd?: string;   // HH:MM format
  timezone?: string;
}

/** Notification history entry (Firestore) */
export interface NotificationHistoryEntry {
  id: string;
  type: NotificationType;
  title: string;
  body: string;
  status: NotificationStatus;
  sentAt: string;
  deliveredAt?: string;
  displayedAt?: string;
  deviceId?: string;
}
```

**types/firebase/devices.ts:**
```typescript
/**
 * Device registry types - matches Firebase /devices/* structure
 */

/** Supported device types */
export type DeviceType = 'stove' | 'thermostat' | 'hue' | 'camera';

/** Device connection status */
export type ConnectionStatus = 'connected' | 'disconnected' | 'unknown';

/** Base device interface */
export interface DeviceBase {
  id: string;
  type: DeviceType;
  name: string;
  enabled: boolean;
  lastSeen?: string; // ISO 8601
  connectionStatus: ConnectionStatus;
}

/** Thermostat device */
export interface ThermostatDevice extends DeviceBase {
  type: 'thermostat';
  homeId?: string;
  roomId?: string;
  currentTemperature?: number;
  setpointTemperature?: number;
}

/** Hue device (bridge) */
export interface HueDevice extends DeviceBase {
  type: 'hue';
  bridgeId?: string;
  lightCount?: number;
}

/** Union of all device types */
export type Device = DeviceBase | ThermostatDevice | HueDevice;
```

**types/firebase/index.ts:**
```typescript
/**
 * Firebase type definitions barrel export
 */

// Stove types
export type {
  StoveStatus,
  StovePowerLevel,
  StoveState,
  StoveCommand,
} from './stove';

// Maintenance types
export type {
  MaintenanceType,
  MaintenanceHistoryEntry,
  MaintenanceRecord,
} from './maintenance';

// Notification types
export type {
  NotificationType,
  NotificationStatus,
  FCMToken,
  NotificationPreferences,
  NotificationHistoryEntry,
} from './notifications';

// Device types
export type {
  DeviceType,
  ConnectionStatus,
  DeviceBase,
  ThermostatDevice,
  HueDevice,
  Device,
} from './devices';
```
  </action>
  <verify>
Create test file `temp-firebase-types.ts`:
```typescript
import type { StoveState, NotificationPreferences, Device } from '@/types/firebase';

const stove: StoveState = {
  status: 'running',
  power: 3,
  targetTemperature: 21,
  lastUpdatedAt: new Date().toISOString(),
};

export { stove };
```
Run `npx tsc --noEmit temp-firebase-types.ts` - should pass.
Delete temp file after verification.
  </verify>
  <done>Firebase types created covering stove, maintenance, notifications, devices (TYPE-01)</done>
</task>

<task type="auto">
  <name>Task 2: Create API response/error types (TYPE-02)</name>
  <files>
types/api/index.ts
types/api/responses.ts
types/api/errors.ts
  </files>
  <action>
Create types/api/ directory with API type definitions derived from lib/core/apiErrors.js patterns.

**types/api/errors.ts:**
```typescript
/**
 * API error types - derived from lib/core/apiErrors.js
 */

/** HTTP status codes (matching lib/core/apiErrors.js HTTP_STATUS) */
export type HttpStatus =
  | 200  // OK
  | 201  // CREATED
  | 204  // NO_CONTENT
  | 400  // BAD_REQUEST
  | 401  // UNAUTHORIZED
  | 403  // FORBIDDEN
  | 404  // NOT_FOUND
  | 409  // CONFLICT
  | 422  // UNPROCESSABLE_ENTITY
  | 429  // TOO_MANY_REQUESTS
  | 500  // INTERNAL_SERVER_ERROR
  | 502  // BAD_GATEWAY
  | 503  // SERVICE_UNAVAILABLE
  | 504; // GATEWAY_TIMEOUT

/** Error codes (matching lib/core/apiErrors.js ERROR_CODES) */
export type ErrorCode =
  // Authentication & Authorization
  | 'UNAUTHORIZED'
  | 'FORBIDDEN'
  | 'SESSION_EXPIRED'
  // Validation
  | 'VALIDATION_ERROR'
  | 'INVALID_INPUT'
  | 'MISSING_REQUIRED_FIELD'
  // Resources
  | 'NOT_FOUND'
  | 'ALREADY_EXISTS'
  | 'CONFLICT'
  // Network & External Services
  | 'NETWORK_ERROR'
  | 'TIMEOUT'
  | 'SERVICE_UNAVAILABLE'
  | 'EXTERNAL_API_ERROR'
  // Stove-specific
  | 'STOVE_OFFLINE'
  | 'STOVE_TIMEOUT'
  | 'STOVE_ERROR'
  | 'MAINTENANCE_REQUIRED'
  // Netatmo-specific
  | 'NETATMO_NOT_CONNECTED'
  | 'NETATMO_TOKEN_EXPIRED'
  | 'NETATMO_TOKEN_INVALID'
  | 'NETATMO_RECONNECT_REQUIRED'
  // Hue-specific
  | 'HUE_NOT_CONNECTED'
  | 'HUE_BRIDGE_NOT_FOUND'
  | 'HUE_LINK_BUTTON_NOT_PRESSED'
  | 'HUE_NOT_ON_LOCAL_NETWORK'
  // Firebase
  | 'FIREBASE_ERROR'
  // Rate limiting
  | 'RATE_LIMITED'
  // Server
  | 'INTERNAL_ERROR'
  | 'NOT_IMPLEMENTED';
```

**types/api/responses.ts:**
```typescript
/**
 * API response types - matches lib/core/apiResponse.js patterns
 */

import type { ErrorCode } from './errors';

/** Successful API response */
export interface ApiSuccessResponse<T = Record<string, unknown>> {
  success: true;
  message?: string;
  /** Data is spread at top level for backward compatibility */
  [key: string]: unknown;
}

/** Error API response */
export interface ApiErrorResponse {
  success: false;
  error: string;
  code: ErrorCode;
  /** Additional error details spread at top level */
  details?: string;
  /** Device-specific: indicates reconnection needed */
  reconnect?: boolean;
}

/** Generic API response union */
export type ApiResponse<T = Record<string, unknown>> =
  | ApiSuccessResponse<T>
  | ApiErrorResponse;

/** Type guard to check if response is successful */
export function isApiSuccess<T>(
  response: ApiResponse<T>
): response is ApiSuccessResponse<T> {
  return response.success === true;
}

/** Type guard to check if response is an error */
export function isApiError(
  response: ApiResponse
): response is ApiErrorResponse {
  return response.success === false;
}

/**
 * Stove status response
 * Example: GET /api/stove/status
 */
export interface StoveStatusResponse extends ApiSuccessResponse {
  status: import('../firebase').StoveStatus;
  power: import('../firebase').StovePowerLevel;
  temperature: number;
  maintenance?: {
    needsCleaning: boolean;
    hoursSinceLastCleaning: number;
  };
}

/**
 * Generic paginated response
 */
export interface PaginatedResponse<T> extends ApiSuccessResponse {
  items: T[];
  total: number;
  page: number;
  pageSize: number;
  hasMore: boolean;
}
```

**types/api/index.ts:**
```typescript
/**
 * API type definitions barrel export
 */

// Error types
export type { HttpStatus, ErrorCode } from './errors';

// Response types
export type {
  ApiSuccessResponse,
  ApiErrorResponse,
  ApiResponse,
  StoveStatusResponse,
  PaginatedResponse,
} from './responses';

// Type guards
export { isApiSuccess, isApiError } from './responses';
```
  </action>
  <verify>
Create test file `temp-api-types.ts`:
```typescript
import type { ApiResponse, ErrorCode } from '@/types/api';
import { isApiSuccess } from '@/types/api';

const response: ApiResponse = { success: true, data: 'test' };

if (isApiSuccess(response)) {
  console.log('Success!');
}

const code: ErrorCode = 'STOVE_OFFLINE';
export { response, code };
```
Run `npx tsc --noEmit temp-api-types.ts` - should pass.
Delete temp file after verification.
  </verify>
  <done>API types created covering responses, errors, and type guards (TYPE-02)</done>
</task>

<task type="auto">
  <name>Task 3: Create root barrel export</name>
  <files>types/index.ts</files>
  <action>
Create types/index.ts as the main barrel export that re-exports from subdirectories.

**types/index.ts:**
```typescript
/**
 * Pannello Stufa - Shared Type Definitions
 *
 * Usage:
 *   import type { StoveState, ApiResponse } from '@/types';
 *   import { isApiSuccess } from '@/types';
 *
 * Or import from specific subdirectories:
 *   import type { StoveState } from '@/types/firebase';
 *   import type { ApiResponse } from '@/types/api';
 */

// Firebase data structure types
export * from './firebase';

// API response/error types
export * from './api';
```

This allows developers to either:
1. Import everything from `@/types` for convenience
2. Import from specific subdirectories for clarity
  </action>
  <verify>
Create test file `temp-barrel-types.ts`:
```typescript
// Test importing from root barrel
import type { StoveState, ApiResponse, ErrorCode } from '@/types';
import { isApiSuccess, isApiError } from '@/types';

const stove: StoveState = {
  status: 'off',
  power: 1,
  targetTemperature: 20,
  lastUpdatedAt: '',
};

export { stove, isApiSuccess, isApiError };
```
Run `npx tsc --noEmit temp-barrel-types.ts` - should pass.
Delete temp file after verification.
  </verify>
  <done>Root types/index.ts barrel export created, all types accessible from @/types</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Directory structure:
   ```bash
   ls -la types/
   ls -la types/firebase/
   ls -la types/api/
   ```
   Should show all expected files.

2. TypeScript compilation:
   ```bash
   npx tsc --noEmit
   ```
   Should pass on all new type files.

3. Import test from project root:
   ```bash
   echo "import type { StoveState, ApiResponse } from '@/types';" > temp-test.ts
   echo "export {};" >> temp-test.ts
   npx tsc --noEmit temp-test.ts
   rm temp-test.ts
   ```
   Should pass.
</verification>

<success_criteria>
1. types/firebase/ directory contains stove.ts, maintenance.ts, notifications.ts, devices.ts, index.ts
2. types/api/ directory contains responses.ts, errors.ts, index.ts
3. types/index.ts barrel exports all types
4. All type files compile without errors
5. Types can be imported from @/types or @/types/firebase, @/types/api
6. TYPE-01 and TYPE-02 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/37-typescript-foundation/37-02-SUMMARY.md`
</output>
