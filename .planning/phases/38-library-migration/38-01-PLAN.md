---
phase: 38-library-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/utils/cn.ts
  - lib/utils/pidController.ts
  - lib/utils/scheduleHelpers.ts
  - lib/formatUtils.ts
  - lib/version.ts
  - lib/routes.ts
  - lib/deviceFingerprint.ts
  - lib/environmentHelper.ts
  - lib/envValidator.ts
  - lib/geolocation.ts
  - lib/themeService.ts
  - lib/maintenance/helpers.ts
  - lib/migrateSchedules.ts
autonomous: true

must_haves:
  truths:
    - "All 13 leaf utility files have .ts extension with no .js remaining"
    - "Type annotations on all exported functions (parameters + return types)"
    - "Existing imports from other files still resolve (allowJs handles cross-file)"
  artifacts:
    - path: "lib/utils/cn.ts"
      provides: "Tailwind className merge utility"
      contains: "ClassValue"
    - path: "lib/utils/pidController.ts"
      provides: "PID controller algorithm"
      contains: "interface PIDConfig"
    - path: "lib/formatUtils.ts"
      provides: "Format helper functions"
    - path: "lib/version.ts"
      provides: "App version constants"
    - path: "lib/routes.ts"
      provides: "Route definitions"
    - path: "lib/envValidator.ts"
      provides: "Environment variable validation"
  key_links:
    - from: "lib/utils/cn.ts"
      to: "clsx"
      via: "import ClassValue from clsx"
      pattern: "ClassValue"
    - from: "lib/envValidator.ts"
      to: "process.env"
      via: "environment variable access"
      pattern: "process\\.env"
---

<objective>
Migrate all leaf utility files (no lib/ internal dependencies) from JavaScript to TypeScript.

Purpose: These 13 files are the foundation layer — they have zero dependencies on other lib/ files, so they can be migrated first without breaking anything. This establishes migration patterns for the rest of the phase.
Output: 13 .ts files replacing .js originals, with typed exports.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/37-typescript-foundation/37-03-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate pure utility files (utils/, formatUtils, version, routes)</name>
  <files>
    lib/utils/cn.js -> lib/utils/cn.ts
    lib/utils/pidController.js -> lib/utils/pidController.ts
    lib/utils/scheduleHelpers.js -> lib/utils/scheduleHelpers.ts
    lib/formatUtils.js -> lib/formatUtils.ts
    lib/version.js -> lib/version.ts
    lib/routes.js -> lib/routes.ts
  </files>
  <action>
    For each file: rename .js to .ts using `git mv`, then add TypeScript annotations.

    **Pattern to follow (from research):**
    - cn.ts: Import `ClassValue` from clsx, type params as `(...inputs: ClassValue[]): string`
    - pidController.ts: Create `interface PIDConfig { kp: number; ki: number; kd: number; ... }` and `interface PIDState`. Type all methods.
    - scheduleHelpers.ts: Type schedule data structures based on Netatmo schedule format. Use `Record<string, unknown>` for complex nested structures, specific types where clear.
    - formatUtils.ts: Simple parameter + return type annotations (string/number formatting)
    - version.ts: Already uses `export const` — just add `: string` type annotations where not inferred
    - routes.ts: Type route definitions as `Record<string, string>` or create a `Route` interface if structure is more complex

    **Rules:**
    - Use `git mv old.js new.ts` (not copy+delete) to preserve git history
    - Add explicit return types on all exported functions
    - Use `unknown` over `any` where feasible, `any` with `// TODO: type properly` for complex cases
    - Import from `@/types` where Phase 37 types fit (StoveStatus, etc.)
    - Do NOT change behavior — only add types
    - Keep `strict: false` compatibility (no need for definite assignment assertions)
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no new errors from these 6 files.
    Verify files exist: `ls lib/utils/cn.ts lib/utils/pidController.ts lib/utils/scheduleHelpers.ts lib/formatUtils.ts lib/version.ts lib/routes.ts`
    Verify old files removed: `ls lib/utils/cn.js 2>/dev/null` should fail.
  </verify>
  <done>6 utility files converted to TypeScript with typed exports, git history preserved, no compilation errors.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate standalone service utilities (fingerprint, env, geo, theme, maintenance helpers)</name>
  <files>
    lib/deviceFingerprint.js -> lib/deviceFingerprint.ts
    lib/environmentHelper.js -> lib/environmentHelper.ts
    lib/envValidator.js -> lib/envValidator.ts
    lib/geolocation.js -> lib/geolocation.ts
    lib/themeService.js -> lib/themeService.ts
    lib/maintenance/helpers.js -> lib/maintenance/helpers.ts
    lib/migrateSchedules.js -> lib/migrateSchedules.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - deviceFingerprint.ts: Type fingerprint components as interfaces. Return type is `string` (hash). Browser APIs (navigator, screen) are already typed via DOM lib.
    - environmentHelper.ts: Type helper functions that determine runtime environment. Return boolean or string types.
    - envValidator.ts: Type validation result interface. Environment variable names as string literal union if practical, otherwise `string`.
    - geolocation.ts: Use built-in `GeolocationPosition` and `GeolocationPositionError` from DOM types. Create interface for custom position result if needed.
    - themeService.ts: Type theme values using `ColorScheme` from `@/types/components` if applicable. Type localStorage interactions.
    - maintenance/helpers.ts: Import `MaintenanceRecord` or `MaintenanceHistoryEntry` from `@/types/firebase` where applicable.
    - migrateSchedules.ts: Type migration functions. Use `Record<string, unknown>` for legacy data shapes.

    **Same rules as Task 1** — git mv, explicit return types, unknown over any, no behavior changes.
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no new errors.
    Verify: `ls lib/deviceFingerprint.ts lib/environmentHelper.ts lib/envValidator.ts lib/geolocation.ts lib/themeService.ts lib/maintenance/helpers.ts lib/migrateSchedules.ts`
    Verify no .js remains: `find lib/utils lib/maintenance -name "*.js" -not -path "*__tests__*"` should return empty (except if maintenance has other files).
  </verify>
  <done>7 standalone utility files converted to TypeScript with typed exports. Total: 13/116 lib files migrated.</done>
</task>

</tasks>

<verification>
- `find lib/utils -name "*.js" -not -path "*__tests__*"` returns empty
- All 13 files exist as .ts
- `npx tsc --noEmit` passes with no new errors
- `npm run dev` starts without errors (quick smoke test)
</verification>

<success_criteria>
13 leaf utility files converted from .js to .ts with proper type annotations. No JavaScript source files remain in lib/utils/. All existing imports from other (still-JS) files continue to work via allowJs.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-01-SUMMARY.md`
</output>
