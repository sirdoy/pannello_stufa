---
phase: 38-library-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/pwa/backgroundSync.ts
  - lib/pwa/badgeService.ts
  - lib/pwa/geofencing.ts
  - lib/pwa/indexedDB.ts
  - lib/pwa/offlineStateCache.ts
  - lib/pwa/periodicSync.ts
  - lib/pwa/persistentStorage.ts
  - lib/pwa/vibration.ts
  - lib/pwa/wakeLock.ts
  - lib/pwa/webShare.ts
autonomous: true

must_haves:
  truths:
    - "All 10 PWA utility files have .ts extension with no .js remaining"
    - "Browser APIs typed via DOM/WebWorker lib types (no manual declarations needed)"
    - "Feature detection patterns typed with proper narrowing"
  artifacts:
    - path: "lib/pwa/indexedDB.ts"
      provides: "IndexedDB wrapper"
      contains: "IDBDatabase"
    - path: "lib/pwa/backgroundSync.ts"
      provides: "Background sync registration"
    - path: "lib/pwa/geofencing.ts"
      provides: "Geofencing utilities"
    - path: "lib/pwa/offlineStateCache.ts"
      provides: "Offline state caching"
    - path: "lib/pwa/vibration.ts"
      provides: "Haptic feedback wrapper"
  key_links:
    - from: "lib/pwa/indexedDB.ts"
      to: "IndexedDB API"
      via: "window.indexedDB"
      pattern: "IDBDatabase|indexedDB"
    - from: "lib/pwa/backgroundSync.ts"
      to: "Service Worker API"
      via: "navigator.serviceWorker"
      pattern: "serviceWorker"
---

<objective>
Migrate all PWA utility files from JavaScript to TypeScript.

Purpose: The 10 files in lib/pwa/ are self-contained browser API wrappers with no dependencies on other lib/ files. They interact with Web APIs (IndexedDB, Service Worker, Vibration, Wake Lock, Web Share) which are already typed via the DOM and WebWorker lib targets in tsconfig.
Output: 10 .ts files with properly typed browser API interactions.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate PWA storage and sync utilities</name>
  <files>
    lib/pwa/indexedDB.js -> lib/pwa/indexedDB.ts
    lib/pwa/offlineStateCache.js -> lib/pwa/offlineStateCache.ts
    lib/pwa/persistentStorage.js -> lib/pwa/persistentStorage.ts
    lib/pwa/backgroundSync.js -> lib/pwa/backgroundSync.ts
    lib/pwa/periodicSync.js -> lib/pwa/periodicSync.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - indexedDB.ts: Use built-in `IDBDatabase`, `IDBTransaction`, `IDBObjectStore` types. Create interfaces for stored data shapes (e.g., `interface StoredToken { token: string; timestamp: number; }`). Generic wrapper functions: `async function getFromDB<T>(store: string, key: string): Promise<T | null>`.
    - offlineStateCache.ts: Type cached state entries with interface. Use `Record<string, unknown>` for generic cached data.
    - persistentStorage.ts: Type the navigator.storage API. Use `StorageManager` type (built-in). Return `Promise<boolean>` for persist().
    - backgroundSync.ts: Type SyncManager and SyncEvent. Note: BackgroundSync API types may need declaration extension — if `SyncManager` is not in lib types, declare minimal interface: `interface SyncManager { register(tag: string): Promise<void>; }` in the file.
    - periodicSync.ts: Similar to backgroundSync — PeriodicSyncManager may need local declaration if not in lib types.

    **Rules:**
    - `git mv` for history preservation
    - Feature detection patterns: `if ('serviceWorker' in navigator)` — TypeScript handles this via type narrowing
    - For experimental APIs not in lib types, declare minimal interfaces locally (not in @/types — these are PWA-specific)
    - Explicit return types on all exported functions
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from these 5 files.
    Verify: `ls lib/pwa/indexedDB.ts lib/pwa/offlineStateCache.ts lib/pwa/persistentStorage.ts lib/pwa/backgroundSync.ts lib/pwa/periodicSync.ts`
  </verify>
  <done>5 PWA storage/sync files converted to TypeScript with typed browser API interactions.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate PWA interaction and sharing utilities</name>
  <files>
    lib/pwa/vibration.js -> lib/pwa/vibration.ts
    lib/pwa/wakeLock.js -> lib/pwa/wakeLock.ts
    lib/pwa/webShare.js -> lib/pwa/webShare.ts
    lib/pwa/badgeService.js -> lib/pwa/badgeService.ts
    lib/pwa/geofencing.js -> lib/pwa/geofencing.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - vibration.ts: Use built-in `Navigator` type with `vibrate()`. Type vibration patterns as `number | number[]`. Feature detection: `'vibrate' in navigator`.
    - wakeLock.ts: Use `WakeLock` and `WakeLockSentinel` types (built-in in modern TS DOM lib). If missing, declare locally. Return `Promise<WakeLockSentinel | null>`.
    - webShare.ts: Use `ShareData` type (built-in). Feature detection for `navigator.share`. Type return as `Promise<void>`.
    - badgeService.ts: Badge API (`navigator.setAppBadge`, `navigator.clearAppBadge`) may need local declarations. Type badge count as `number`.
    - geofencing.ts: Type geofence regions with interface `interface GeofenceRegion { id: string; latitude: number; longitude: number; radius: number; }`. Use `GeolocationPosition` from DOM lib.

    **Same rules as Task 1.**
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from these 5 files.
    Verify: `ls lib/pwa/vibration.ts lib/pwa/wakeLock.ts lib/pwa/webShare.ts lib/pwa/badgeService.ts lib/pwa/geofencing.ts`
    Full check: `find lib/pwa -name "*.js" -not -path "*__tests__*"` returns empty.
  </verify>
  <done>5 PWA interaction files converted. All 10 lib/pwa/ source files now TypeScript. Total: 23/116 lib files migrated (with Plan 01).</done>
</task>

</tasks>

<verification>
- `find lib/pwa -name "*.js" -not -path "*__tests__*"` returns empty
- All 10 files exist as .ts
- `npx tsc --noEmit` passes with no new errors
</verification>

<success_criteria>
All 10 PWA utility files converted from .js to .ts with proper type annotations. Browser API interactions typed using DOM/WebWorker lib types or minimal local declarations for experimental APIs.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-02-SUMMARY.md`
</output>
