---
phase: 38-library-migration
plan: 03
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - lib/core/apiErrors.ts
  - lib/core/apiResponse.ts
  - lib/core/index.ts
  - lib/core/middleware.ts
  - lib/core/netatmoHelpers.ts
  - lib/core/requestParser.ts
  - lib/firebase.ts
  - lib/firebaseAdmin.ts
  - lib/logger.ts
  - lib/auth0.ts
  - lib/rateLimiter.ts
  - lib/errorMonitor.ts
  - lib/logService.ts
autonomous: true

must_haves:
  truths:
    - "All core infrastructure files have .ts extension"
    - "API error/response functions use types from @/types/api"
    - "Firebase client and admin modules are typed"
    - "Logger, auth, and rate limiter have typed interfaces"
  artifacts:
    - path: "lib/core/apiErrors.ts"
      provides: "Error factory functions"
      contains: "ErrorCode"
    - path: "lib/core/apiResponse.ts"
      provides: "API response builders"
      contains: "ApiResponse"
    - path: "lib/firebase.ts"
      provides: "Client-side Firebase instance"
    - path: "lib/firebaseAdmin.ts"
      provides: "Server-side Firebase Admin"
      contains: "adminDbGet|adminDbSet"
    - path: "lib/logger.ts"
      provides: "Logging utility"
    - path: "lib/rateLimiter.ts"
      provides: "Rate limiting"
  key_links:
    - from: "lib/core/apiErrors.ts"
      to: "@/types/api"
      via: "import ErrorCode, HttpStatus"
      pattern: "import.*ErrorCode.*from.*@/types"
    - from: "lib/core/apiResponse.ts"
      to: "@/types/api"
      via: "import ApiResponse types"
      pattern: "import.*ApiResponse|ApiSuccessResponse.*from.*@/types"
    - from: "lib/firebaseAdmin.ts"
      to: "firebase-admin"
      via: "admin SDK import"
      pattern: "firebase-admin"
---

<objective>
Migrate core infrastructure files (API layer, Firebase, logging, auth) from JavaScript to TypeScript.

Purpose: These 13 files form the infrastructure layer that most services depend on. They must be migrated before services/repositories can be converted. The core/ API utilities directly map to Phase 37's @/types/api types.
Output: 13 .ts files with types imported from @/types where applicable.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/api/errors.ts
@types/api/responses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core/ API layer (errors, responses, middleware, request parsing)</name>
  <files>
    lib/core/apiErrors.js -> lib/core/apiErrors.ts
    lib/core/apiResponse.js -> lib/core/apiResponse.ts
    lib/core/index.js -> lib/core/index.ts
    lib/core/middleware.js -> lib/core/middleware.ts
    lib/core/netatmoHelpers.js -> lib/core/netatmoHelpers.ts
    lib/core/requestParser.js -> lib/core/requestParser.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Critical: Leverage @/types/api types from Phase 37.**

    - apiErrors.ts: Import `ErrorCode`, `HttpStatus` from `@/types/api`. The ERROR_CODES object should be typed as `Record<string, { code: ErrorCode; status: HttpStatus; message: string }>`. Error factory functions return typed error objects. The `createApiError` function should return `ApiErrorResponse` type.
    - apiResponse.ts: Import `ApiSuccessResponse`, `ApiErrorResponse`, `ApiResponse` from `@/types/api`. Type `successResponse<T>(data: T): NextResponse` and `errorResponse(error: ApiErrorResponse): NextResponse`. Use `NextResponse` from `next/server`.
    - index.ts: Barrel export file — just re-export with type-only exports where needed.
    - middleware.ts: Type middleware functions as `(req: NextRequest) => Promise<NextResponse>` or similar. Import `NextRequest`, `NextResponse` from `next/server`. Type HMAC verification params.
    - netatmoHelpers.ts: Type Netatmo-specific helper functions. Use `Record<string, unknown>` for Netatmo API data shapes that aren't in @/types yet.
    - requestParser.ts: Type request parsing/validation functions. Parameters: `NextRequest`, return parsed body types. Use generics where practical: `parseBody<T>(req: NextRequest): Promise<T>`.

    **Rules:**
    - `git mv` for git history preservation
    - Import from `@/types` first, create local types only for things not in Phase 37 types
    - `NextRequest`/`NextResponse` from `next/server` for API types
    - Explicit return types on all exports
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from core/ files.
    Verify: `find lib/core -name "*.js" -not -path "*__tests__*"` returns empty.
  </verify>
  <done>All 6 core/ files converted to TypeScript, using @/types/api for error/response typing.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Firebase, auth, logging, and rate limiting infrastructure</name>
  <files>
    lib/firebase.js -> lib/firebase.ts
    lib/firebaseAdmin.js -> lib/firebaseAdmin.ts
    lib/logger.js -> lib/logger.ts
    lib/auth0.js -> lib/auth0.ts
    lib/rateLimiter.js -> lib/rateLimiter.ts
    lib/errorMonitor.js -> lib/errorMonitor.ts
    lib/logService.js -> lib/logService.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - firebase.ts: Type the Firebase app initialization. Use `FirebaseApp` from `firebase/app`, `Database` from `firebase/database`. Likely a small file (~21 lines) — just add import types.
    - firebaseAdmin.ts: This is 630 lines — significant file. Use `import admin from 'firebase-admin'` types. Type `adminDbGet<T>(path: string): Promise<T | null>`, `adminDbSet(path: string, data: unknown): Promise<void>`, `adminDbUpdate(path: string, data: Record<string, unknown>): Promise<void>`. Type the initialization check. Use `admin.database.Reference` etc.
    - logger.ts: Create `type LogLevel = 'debug' | 'info' | 'warn' | 'error'`. Type log function signatures. Return types `void`.
    - auth0.ts: Type Auth0 configuration and client initialization. Use `@auth0/nextjs-auth0` types if available, otherwise `any` with TODO comment.
    - rateLimiter.ts: Create `interface RateLimitConfig { windowMs: number; maxRequests: number; }` and `interface RateLimitResult { allowed: boolean; remaining: number; resetAt: number; }`. Type the in-memory store as `Map<string, { count: number; resetAt: number }>`.
    - errorMonitor.ts: Type error monitoring functions. Use `Error` type for error parameters. Type the error reporting interface.
    - logService.ts: Type log storage and retrieval functions. Use `@/types/firebase` types if log entries match Firebase structures.

    **Rules:**
    - `git mv` for history
    - Firebase types come from `firebase/app`, `firebase/database`, `firebase-admin`
    - Auth0 types from `@auth0/nextjs-auth0` (check if @types package exists)
    - Use `unknown` for generic data parameters in Firebase operations
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from these 7 files.
    Verify: `ls lib/firebase.ts lib/firebaseAdmin.ts lib/logger.ts lib/auth0.ts lib/rateLimiter.ts lib/errorMonitor.ts lib/logService.ts`
  </verify>
  <done>7 infrastructure files converted. All 13 core infrastructure files now TypeScript. Total: 36/116 lib files migrated.</done>
</task>

</tasks>

<verification>
- `find lib/core -name "*.js" -not -path "*__tests__*"` returns empty
- `ls lib/firebase.ts lib/firebaseAdmin.ts lib/logger.ts lib/auth0.ts lib/rateLimiter.ts lib/errorMonitor.ts lib/logService.ts` all exist
- `npx tsc --noEmit` passes with no new errors
- Core API utilities import types from `@/types/api`
</verification>

<success_criteria>
All 13 core infrastructure files converted to TypeScript. API error/response layer uses Phase 37 types from @/types/api. Firebase modules typed with official Firebase SDK types.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-03-SUMMARY.md`
</output>
