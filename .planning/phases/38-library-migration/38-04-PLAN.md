---
phase: 38-library-migration
plan: 04
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - lib/repositories/base/BaseRepository.ts
  - lib/repositories/MaintenanceRepository.ts
  - lib/repositories/ScheduleRepository.ts
  - lib/repositories/SchedulerModeRepository.ts
  - lib/repositories/StoveStateRepository.ts
  - lib/repositories/index.ts
  - lib/schemas/coordinationPreferences.ts
  - lib/schemas/notificationPreferences.ts
  - lib/validators/index.ts
  - lib/validators/stove.validators.ts
  - lib/devices/deviceRegistry.ts
  - lib/devices/deviceTypes.ts
  - lib/devices/index.ts
autonomous: true

must_haves:
  truths:
    - "All repository, schema, validator, and device files have .ts extension"
    - "BaseRepository is generic: BaseRepository<T> with typed CRUD operations"
    - "Concrete repositories specify their data type (e.g., MaintenanceRepository extends BaseRepository<MaintenanceData>)"
    - "Zod schemas infer their TypeScript types"
    - "Device registry types match @/types/firebase device types"
  artifacts:
    - path: "lib/repositories/base/BaseRepository.ts"
      provides: "Generic base repository class"
      contains: "BaseRepository<T"
    - path: "lib/repositories/MaintenanceRepository.ts"
      provides: "Maintenance data access"
      contains: "MaintenanceRepository"
    - path: "lib/schemas/notificationPreferences.ts"
      provides: "Notification preference Zod schema"
      contains: "z.object"
    - path: "lib/devices/deviceRegistry.ts"
      provides: "Device registry"
    - path: "lib/validators/stove.validators.ts"
      provides: "Stove validation functions"
  key_links:
    - from: "lib/repositories/base/BaseRepository.ts"
      to: "lib/firebaseAdmin"
      via: "Firebase admin database operations"
      pattern: "adminDb|firebaseAdmin"
    - from: "lib/repositories/MaintenanceRepository.ts"
      to: "@/types/firebase"
      via: "import MaintenanceRecord or similar"
      pattern: "import.*from.*@/types"
    - from: "lib/devices/deviceTypes.ts"
      to: "@/types/firebase"
      via: "import Device types"
      pattern: "DeviceType|Device"
---

<objective>
Migrate repositories, schemas, validators, and device registry from JavaScript to TypeScript.

Purpose: These 13 files provide the data access layer (repositories with generic base), validation (Zod schemas, validators), and device management. They depend on leaf utilities and will be consumed by services. The repository pattern benefits greatly from TypeScript generics.
Output: 13 .ts files with generic repository base, typed Zod schemas, and typed device registry.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/firebase/stove.ts
@types/firebase/maintenance.ts
@types/firebase/notifications.ts
@types/firebase/devices.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate repositories with generic base class</name>
  <files>
    lib/repositories/base/BaseRepository.js -> lib/repositories/base/BaseRepository.ts
    lib/repositories/MaintenanceRepository.js -> lib/repositories/MaintenanceRepository.ts
    lib/repositories/ScheduleRepository.js -> lib/repositories/ScheduleRepository.ts
    lib/repositories/SchedulerModeRepository.js -> lib/repositories/SchedulerModeRepository.ts
    lib/repositories/StoveStateRepository.js -> lib/repositories/StoveStateRepository.ts
    lib/repositories/index.js -> lib/repositories/index.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Critical pattern — Generic BaseRepository (from research):**
    ```typescript
    export abstract class BaseRepository<T = unknown> {
      protected basePath: string;
      constructor(basePath: string) { this.basePath = basePath; }
      async get(subPath?: string): Promise<T | null> { ... }
      async set(subPath: string, data: Partial<T>): Promise<void> { ... }
      async update(subPath: string, data: Partial<T>): Promise<void> { ... }
      async remove(subPath: string): Promise<void> { ... }
      protected resolvePath(subPath?: string): string { ... }
    }
    ```

    **Concrete repositories:**
    - MaintenanceRepository: `extends BaseRepository<MaintenanceData>` — import `MaintenanceRecord` or equivalent from `@/types/firebase`. If the exact shape differs from Phase 37 types, create a local type that extends the Phase 37 type.
    - ScheduleRepository: Type with schedule data shape. May need local interface for schedule-specific fields.
    - SchedulerModeRepository: Type with scheduler mode enum/union.
    - StoveStateRepository: `extends BaseRepository<StoveState>` — import from `@/types/firebase`.
    - index.ts: Barrel export — re-export all repositories.

    **Rules:**
    - `git mv` for history
    - Import from `@/types/firebase` for data types that match
    - Create local types only for shapes not covered by Phase 37
    - Type method parameters and return types explicitly
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from repository files.
    Verify: `find lib/repositories -name "*.js" -not -path "*__tests__*"` returns empty.
  </verify>
  <done>6 repository files converted with generic BaseRepository<T> pattern. Concrete repos use @/types/firebase data types.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate schemas, validators, and device modules</name>
  <files>
    lib/schemas/coordinationPreferences.js -> lib/schemas/coordinationPreferences.ts
    lib/schemas/notificationPreferences.js -> lib/schemas/notificationPreferences.ts
    lib/validators/index.js -> lib/validators/index.ts
    lib/validators/stove.validators.js -> lib/validators/stove.validators.ts
    lib/devices/deviceRegistry.js -> lib/devices/deviceRegistry.ts
    lib/devices/deviceTypes.js -> lib/devices/deviceTypes.ts
    lib/devices/index.js -> lib/devices/index.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - Zod schemas (schemas/*.ts): Already use `z.object(...)`. TypeScript will infer types from Zod schemas. Add `export type CoordinationPreferencesSchema = z.infer<typeof coordinationPreferencesSchema>` to export inferred types. This is a major win for TypeScript — Zod schemas become the single source of truth.
    - validators/stove.validators.ts: Type validation functions with explicit parameter types. Use `StoveState`, `StovePowerLevel` from `@/types/firebase` where applicable. Return `{ valid: boolean; errors?: string[] }` or similar.
    - validators/index.ts: Barrel export.
    - devices/deviceTypes.ts: Import `DeviceType`, `Device` from `@/types/firebase`. This file likely defines device type constants — type them using the Phase 37 union types.
    - devices/deviceRegistry.ts: Type the registry map. Use `Map<string, DeviceConfig>` or `Record<string, DeviceConfig>`. Import device types from `@/types/firebase`.
    - devices/index.ts: Barrel export.

    **Rules:**
    - `git mv` for history
    - Zod schemas: add `z.infer<typeof ...>` type exports
    - Import from `@/types/firebase` for device types
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    Verify: `find lib/schemas lib/validators lib/devices -name "*.js" -not -path "*__tests__*"` returns empty.
  </verify>
  <done>7 schema/validator/device files converted. Total: 49/116 lib files migrated. Zod schemas export inferred types.</done>
</task>

</tasks>

<verification>
- `find lib/repositories lib/schemas lib/validators lib/devices -name "*.js" -not -path "*__tests__*"` returns empty
- All 13 files exist as .ts
- `npx tsc --noEmit` passes with no new errors
- BaseRepository has generic type parameter `<T>`
</verification>

<success_criteria>
All 13 data layer files converted to TypeScript. BaseRepository uses generics. Zod schemas export inferred types. Device registry uses @/types/firebase types.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-04-SUMMARY.md`
</output>
