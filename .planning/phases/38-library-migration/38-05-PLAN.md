---
phase: 38-library-migration
plan: 05
type: execute
wave: 3
depends_on: ["38-03"]
files_modified:
  - lib/stoveApi.ts
  - lib/netatmoApi.ts
  - lib/netatmoCacheService.ts
  - lib/netatmoCalibrationService.ts
  - lib/netatmoCameraApi.ts
  - lib/netatmoCredentials.ts
  - lib/netatmoRateLimiter.ts
  - lib/netatmoTokenHelper.ts
  - lib/openMeteo.ts
autonomous: true

must_haves:
  truths:
    - "All 9 external API client files have .ts extension"
    - "Stove API uses StoveState, StoveCommand types from @/types/firebase"
    - "Netatmo API functions have typed request/response shapes"
    - "External API responses typed pragmatically (type what's consumed, not full API)"
  artifacts:
    - path: "lib/stoveApi.ts"
      provides: "Thermorossi stove HTTP client"
      contains: "StoveStatus|StoveState"
    - path: "lib/netatmoApi.ts"
      provides: "Netatmo REST API client"
    - path: "lib/netatmoTokenHelper.ts"
      provides: "OAuth token refresh"
    - path: "lib/openMeteo.ts"
      provides: "Weather data client"
  key_links:
    - from: "lib/stoveApi.ts"
      to: "@/types/firebase"
      via: "import StoveState, StoveCommand"
      pattern: "import.*Stove.*from.*@/types"
    - from: "lib/netatmoApi.ts"
      to: "lib/netatmoTokenHelper"
      via: "token refresh for API calls"
      pattern: "netatmoTokenHelper|getAccessToken"
    - from: "lib/netatmoApi.ts"
      to: "lib/netatmoRateLimiter"
      via: "rate limit check before API call"
      pattern: "rateLimiter|checkLimit"
---

<objective>
Migrate external API client files (Thermorossi stove, Netatmo, OpenMeteo) from JavaScript to TypeScript.

Purpose: These 9 files handle HTTP communication with external devices and services. They depend on core infrastructure (firebase, logger, rate limiter) and are consumed by business logic services. Type the API response shapes pragmatically — only type what the app actually consumes.
Output: 9 .ts files with typed API requests and responses.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/firebase/stove.ts
@types/api/responses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Thermorossi stove API and OpenMeteo weather API</name>
  <files>
    lib/stoveApi.js -> lib/stoveApi.ts
    lib/openMeteo.js -> lib/openMeteo.ts
    lib/netatmoCredentials.js -> lib/netatmoCredentials.ts
    lib/netatmoRateLimiter.js -> lib/netatmoRateLimiter.ts
    lib/netatmoTokenHelper.js -> lib/netatmoTokenHelper.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - stoveApi.ts: Import `StoveState`, `StoveStatus`, `StoveCommand`, `StovePowerLevel` from `@/types/firebase`. Create interface for raw API response if it differs from typed state: `interface StoveRawResponse { ... }` and map to `StoveState`. Type all exported functions: `getStoveStatus(): Promise<StoveState>`, `sendCommand(cmd: StoveCommand): Promise<void>`, etc.
    - openMeteo.ts: Create local interfaces for OpenMeteo API response shape:
      ```typescript
      interface OpenMeteoResponse {
        current_weather: { temperature: number; weathercode: number; windspeed: number; ... };
        daily: { temperature_2m_max: number[]; temperature_2m_min: number[]; ... };
      }
      ```
      Type only the fields actually consumed. Return typed weather data.
    - netatmoCredentials.ts: Type credential storage/retrieval. Return `{ clientId: string; clientSecret: string; refreshToken: string }` or similar.
    - netatmoRateLimiter.ts: Type rate limit tracking. Create `interface RateLimitState { calls: number; windowStart: number; limit: number }`. Methods: `checkLimit(): boolean`, `recordCall(): void`.
    - netatmoTokenHelper.ts: Type OAuth token operations. Create `interface TokenData { accessToken: string; refreshToken: string; expiresAt: number }`. Methods: `getAccessToken(): Promise<string>`, `refreshAccessToken(): Promise<TokenData>`.

    **Rules:**
    - `git mv` for history
    - Import from `@/types` where Phase 37 types fit
    - Create local interfaces for external API responses (not in @/types — these are service-specific)
    - Use `unknown` for raw fetch responses, then narrow with type assertions or guards
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    Verify: `ls lib/stoveApi.ts lib/openMeteo.ts lib/netatmoCredentials.ts lib/netatmoRateLimiter.ts lib/netatmoTokenHelper.ts`
  </verify>
  <done>5 external API client files converted with typed request/response shapes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Netatmo API, cache, calibration, and camera modules</name>
  <files>
    lib/netatmoApi.js -> lib/netatmoApi.ts
    lib/netatmoCacheService.js -> lib/netatmoCacheService.ts
    lib/netatmoCalibrationService.js -> lib/netatmoCalibrationService.ts
    lib/netatmoCameraApi.js -> lib/netatmoCameraApi.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - netatmoApi.ts (564 lines — largest Netatmo file): Create interfaces for Netatmo API responses:
      ```typescript
      interface NetatmoHomesData { homes: NetatmoHome[]; }
      interface NetatmoHome { id: string; name: string; rooms: NetatmoRoom[]; modules: NetatmoModule[]; }
      interface NetatmoRoom { id: string; name: string; type: string; }
      interface NetatmoModule { id: string; type: string; firmware: number; }
      ```
      Type only consumed fields. Methods: `getHomesData(): Promise<NetatmoHomesData>`, `setThermpoint(...)`, `switchSchedule(...)`, etc. Import token helper types.
    - netatmoCacheService.ts: Type cache entries with TTL: `interface CacheEntry<T> { data: T; expiry: number; }`. Use generics: `get<T>(key: string): T | null`, `set<T>(key: string, data: T, ttl: number): void`.
    - netatmoCalibrationService.ts: Type calibration parameters and results. Use `number` for temperature values.
    - netatmoCameraApi.ts (515 lines): Type camera-specific API. Create `interface CameraStatus { ... }`, `interface CameraEvent { ... }`. Type snapshot URL generation. Import from `lib/netatmoTokenHelper` for auth.

    **Rules:**
    - `git mv` for history
    - Netatmo response interfaces are local to these files (too API-specific for @/types)
    - Type only consumed fields, not full Netatmo API surface
    - Use `as unknown as T` pattern for fetch response parsing
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    Verify: `ls lib/netatmoApi.ts lib/netatmoCacheService.ts lib/netatmoCalibrationService.ts lib/netatmoCameraApi.ts`
  </verify>
  <done>4 Netatmo files converted. All 9 external API client files now TypeScript. Total: 58/116 lib files migrated.</done>
</task>

</tasks>

<verification>
- All 9 API client files exist as .ts (no .js remaining for these files)
- `npx tsc --noEmit` passes with no new errors
- Stove API imports types from `@/types/firebase`
- Netatmo API files have local interfaces for API response shapes
</verification>

<success_criteria>
All 9 external API client files converted to TypeScript. Stove API uses Phase 37 types. Netatmo and OpenMeteo have pragmatic local interfaces for consumed response fields.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-05-SUMMARY.md`
</output>
