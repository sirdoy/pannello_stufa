---
phase: 38-library-migration
plan: 06
type: execute
wave: 3
depends_on: ["38-03"]
files_modified:
  - lib/hue/colorUtils.ts
  - lib/hue/hueApi.ts
  - lib/hue/hueConnectionStrategy.ts
  - lib/hue/hueLocalHelper.ts
  - lib/hue/hueRemoteApi.ts
  - lib/hue/hueRemoteTokenHelper.ts
  - lib/hue/hueTokenHelper.ts
  - lib/notificationFilter.ts
  - lib/notificationHistoryService.ts
  - lib/notificationLogger.ts
  - lib/notificationPreferencesService.ts
  - lib/notificationService.ts
  - lib/notificationTriggers.ts
  - lib/notificationTriggersServer.ts
  - lib/notificationValidation.ts
  - lib/tokenRefresh.ts
  - lib/tokenStorage.ts
autonomous: true

must_haves:
  truths:
    - "All 17 Hue and notification files have .ts extension"
    - "Hue API typed with light/scene/group interfaces"
    - "Notification service uses NotificationPreferences, FCMToken from @/types/firebase"
    - "Token storage typed for IndexedDB + localStorage dual persistence"
  artifacts:
    - path: "lib/hue/hueApi.ts"
      provides: "Philips Hue API client"
    - path: "lib/notificationService.ts"
      provides: "Push notification sending"
      contains: "NotificationType|FCMToken"
    - path: "lib/tokenStorage.ts"
      provides: "FCM token persistence"
    - path: "lib/notificationPreferencesService.ts"
      provides: "User notification preferences"
  key_links:
    - from: "lib/notificationService.ts"
      to: "@/types/firebase"
      via: "import notification types"
      pattern: "import.*Notification.*from.*@/types"
    - from: "lib/tokenStorage.ts"
      to: "lib/pwa/indexedDB"
      via: "IndexedDB storage"
      pattern: "indexedDB|getFromDB"
    - from: "lib/hue/hueApi.ts"
      to: "lib/hue/hueConnectionStrategy"
      via: "connection strategy selection"
      pattern: "hueConnectionStrategy|ConnectionStrategy"
---

<objective>
Migrate Philips Hue API client files and notification system files from JavaScript to TypeScript.

Purpose: The 7 Hue files form a complete API client with connection strategy pattern. The 10 notification files handle the push notification pipeline (filtering, logging, preferences, sending, triggers, token management). Both subsystems depend on core infrastructure and are consumed by API routes.
Output: 17 .ts files with typed Hue and notification interfaces.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/firebase/notifications.ts
@types/firebase/devices.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Philips Hue API client (7 files)</name>
  <files>
    lib/hue/colorUtils.js -> lib/hue/colorUtils.ts
    lib/hue/hueApi.js -> lib/hue/hueApi.ts
    lib/hue/hueConnectionStrategy.js -> lib/hue/hueConnectionStrategy.ts
    lib/hue/hueLocalHelper.js -> lib/hue/hueLocalHelper.ts
    lib/hue/hueRemoteApi.js -> lib/hue/hueRemoteApi.ts
    lib/hue/hueRemoteTokenHelper.js -> lib/hue/hueRemoteTokenHelper.ts
    lib/hue/hueTokenHelper.js -> lib/hue/hueTokenHelper.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - colorUtils.ts: Type color conversion functions. Parameters/returns are `number` (RGB, XY coordinates, kelvin). Create `interface XYColor { x: number; y: number; }` and `interface RGBColor { r: number; g: number; b: number; }`.
    - hueApi.ts: Main facade — type public methods: `getLights(): Promise<HueLight[]>`, `setLightState(id: string, state: Partial<HueLightState>): Promise<void>`, `getScenes(): Promise<HueScene[]>`, etc. Create local interfaces:
      ```typescript
      interface HueLight { id: string; name: string; state: HueLightState; }
      interface HueLightState { on: boolean; bri: number; ct?: number; xy?: [number, number]; }
      interface HueScene { id: string; name: string; lights: string[]; }
      ```
    - hueConnectionStrategy.ts: Type the strategy pattern. Create `interface ConnectionStrategy { isAvailable(): Promise<boolean>; request<T>(path: string, method?: string, body?: unknown): Promise<T>; }`. Type the factory function.
    - hueLocalHelper.ts: Type local bridge discovery and communication. Use `fetch` return types.
    - hueRemoteApi.ts: Type remote API calls through Hue cloud. Same response types as local.
    - hueRemoteTokenHelper.ts (497 lines): Type OAuth flow for Hue remote API. Create `interface HueTokens { accessToken: string; refreshToken: string; expiresAt: number; }`. Type token storage in Firebase.
    - hueTokenHelper.ts: Type token helper utilities.

    **Rules:**
    - `git mv` for history
    - Hue-specific types stay local (too API-specific for @/types)
    - Type Hue API responses pragmatically (consumed fields only)
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from hue/ files.
    Verify: `find lib/hue -name "*.js" -not -path "*__tests__*"` returns empty.
  </verify>
  <done>7 Hue API files converted with typed light/scene/connection interfaces.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate notification system files (10 files)</name>
  <files>
    lib/notificationFilter.js -> lib/notificationFilter.ts
    lib/notificationHistoryService.js -> lib/notificationHistoryService.ts
    lib/notificationLogger.js -> lib/notificationLogger.ts
    lib/notificationPreferencesService.js -> lib/notificationPreferencesService.ts
    lib/notificationService.js -> lib/notificationService.ts
    lib/notificationTriggers.js -> lib/notificationTriggers.ts
    lib/notificationTriggersServer.js -> lib/notificationTriggersServer.ts
    lib/notificationValidation.js -> lib/notificationValidation.ts
    lib/tokenRefresh.js -> lib/tokenRefresh.ts
    lib/tokenStorage.js -> lib/tokenStorage.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Critical: Leverage @/types/firebase notification types from Phase 37.**

    - notificationFilter.ts: Import `NotificationType`, `NotificationPreferences` from `@/types/firebase`. Type filter function: `shouldSendNotification(type: NotificationType, prefs: NotificationPreferences): boolean`. Type DND check functions.
    - notificationHistoryService.ts: Import `NotificationHistoryEntry` from `@/types/firebase`. Type Firestore query parameters and pagination.
    - notificationLogger.ts: Type log entry creation. Import `NotificationStatus` from `@/types/firebase`.
    - notificationPreferencesService.ts: Import `NotificationPreferences` from `@/types/firebase`. Type CRUD operations: `getPreferences(userId: string): Promise<NotificationPreferences>`, `updatePreferences(userId: string, prefs: Partial<NotificationPreferences>): Promise<void>`.
    - notificationService.ts (619 lines): Import `FCMToken`, `NotificationType` from `@/types/firebase`. Type send function: `sendNotification(token: string, payload: NotificationPayload): Promise<SendResult>`. Create local `interface NotificationPayload { title: string; body: string; data?: Record<string, string>; }` and `interface SendResult { success: boolean; messageId?: string; error?: string; }`.
    - notificationTriggers.ts: Type trigger functions with event-specific parameters.
    - notificationTriggersServer.ts: Type server-side trigger functions.
    - notificationValidation.ts: Type validation functions (small file, ~30 lines).
    - tokenRefresh.ts: Type token refresh logic. Use `FCMToken` from `@/types/firebase`.
    - tokenStorage.ts: Type dual persistence (IndexedDB + localStorage). Use `FCMToken` from `@/types/firebase`. Type storage key constants.

    **Rules:**
    - `git mv` for history
    - Import from `@/types/firebase` for NotificationType, NotificationPreferences, FCMToken, etc.
    - Create local types for implementation-specific shapes (SendResult, NotificationPayload)
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    Verify all 10 notification files exist as .ts.
  </verify>
  <done>10 notification files converted. Total: 75/116 lib files migrated. Notification types integrated with @/types/firebase.</done>
</task>

</tasks>

<verification>
- `find lib/hue -name "*.js" -not -path "*__tests__*"` returns empty
- All 10 notification files exist as .ts
- `npx tsc --noEmit` passes with no new errors
- Notification service imports types from `@/types/firebase`
</verification>

<success_criteria>
All 17 Hue and notification files converted to TypeScript. Hue API has typed light/scene interfaces. Notification system uses Phase 37 Firebase types for NotificationType, NotificationPreferences, FCMToken.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-06-SUMMARY.md`
</output>
