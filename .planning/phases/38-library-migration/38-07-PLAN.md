---
phase: 38-library-migration
plan: 07
type: execute
wave: 4
depends_on: ["38-04", "38-05", "38-06"]
files_modified:
  - lib/coordinationDebounce.ts
  - lib/coordinationEventLogger.ts
  - lib/coordinationNotificationThrottle.ts
  - lib/coordinationOrchestrator.ts
  - lib/coordinationPauseCalculator.ts
  - lib/coordinationPreferences.ts
  - lib/coordinationState.ts
  - lib/coordinationUserIntent.ts
  - lib/netatmoService.ts
  - lib/netatmoStoveSync.ts
  - lib/services/StoveService.ts
  - lib/services/pidAutomationService.ts
  - lib/services/unifiedDeviceConfigService.ts
  - lib/healthDeadManSwitch.ts
  - lib/healthLogger.ts
  - lib/healthMonitoring.ts
  - lib/hlsDownloader.ts
autonomous: true

must_haves:
  truths:
    - "All 17 coordination, health, and high-level service files have .ts extension"
    - "Coordination orchestrator typed with state machine pattern"
    - "StoveService uses types from @/types/firebase"
    - "Health monitoring typed with alert and check result interfaces"
  artifacts:
    - path: "lib/coordinationOrchestrator.ts"
      provides: "Stove-thermostat coordination logic"
    - path: "lib/services/StoveService.ts"
      provides: "High-level stove operations"
      contains: "StoveState|StoveCommand"
    - path: "lib/healthMonitoring.ts"
      provides: "Stove health check runner"
    - path: "lib/netatmoStoveSync.ts"
      provides: "Netatmo-stove synchronization"
  key_links:
    - from: "lib/coordinationOrchestrator.ts"
      to: "lib/coordinationState"
      via: "state management"
      pattern: "coordinationState|CoordinationState"
    - from: "lib/services/StoveService.ts"
      to: "lib/stoveApi"
      via: "stove API calls"
      pattern: "stoveApi|getStoveStatus"
    - from: "lib/healthMonitoring.ts"
      to: "lib/healthLogger"
      via: "logging health check results"
      pattern: "healthLogger|logCheck"
---

<objective>
Migrate coordination system, health monitoring, and high-level service files from JavaScript to TypeScript.

Purpose: These 17 files contain the business logic layer — coordination orchestrator (stove-thermostat sync), health monitoring (dead man's switch, logging), and service facades (StoveService, PID automation). They depend on repositories, API clients, and core infrastructure from earlier waves.
Output: 17 .ts files with typed coordination state machine, health check interfaces, and service types.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/firebase/stove.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate coordination system (8 files)</name>
  <files>
    lib/coordinationDebounce.js -> lib/coordinationDebounce.ts
    lib/coordinationEventLogger.js -> lib/coordinationEventLogger.ts
    lib/coordinationNotificationThrottle.js -> lib/coordinationNotificationThrottle.ts
    lib/coordinationOrchestrator.js -> lib/coordinationOrchestrator.ts
    lib/coordinationPauseCalculator.js -> lib/coordinationPauseCalculator.ts
    lib/coordinationPreferences.js -> lib/coordinationPreferences.ts
    lib/coordinationState.js -> lib/coordinationState.ts
    lib/coordinationUserIntent.js -> lib/coordinationUserIntent.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - coordinationState.ts: Create `interface CoordinationState { isPaused: boolean; pauseReason?: string; pauseUntil?: number; lastCheck?: number; }` or match existing shape. Type state read/write operations.
    - coordinationOrchestrator.ts (532 lines — largest): Type the main orchestration function. Create `interface CoordinationContext { stoveState: StoveState; thermostatData: unknown; preferences: unknown; }` and `interface CoordinationResult { action: string; reason: string; }`. Import `StoveState` from `@/types/firebase`. Use `unknown` for complex nested Netatmo data shapes.
    - coordinationDebounce.ts: Type debounce parameters and timer state. Create `interface DebounceConfig { delayMs: number; key: string; }`.
    - coordinationEventLogger.ts: Type event logging. Create `interface CoordinationEvent { type: string; timestamp: number; details: Record<string, unknown>; }`.
    - coordinationNotificationThrottle.ts: Type throttle state. Similar to rateLimiter pattern.
    - coordinationPauseCalculator.ts: Type pause duration calculation. Parameters and return are `number` (milliseconds).
    - coordinationPreferences.ts: Import coordination preference types (Zod inferred from Plan 04 if available, otherwise type locally).
    - coordinationUserIntent.ts: Type user intent detection. Create `type UserIntent = 'manual_override' | 'schedule_change' | 'temperature_adjust' | 'none'` or similar.

    **Rules:**
    - `git mv` for history
    - Import `StoveState` from `@/types/firebase` where used
    - Use `unknown` + type guards for complex nested data
    - Coordination-specific types stay local (not reused outside coordination)
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors from coordination files.
    Verify: `ls lib/coordination*.ts | wc -l` returns 8.
  </verify>
  <done>8 coordination files converted with typed state machine and event interfaces.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate health monitoring, Netatmo services, StoveService, and remaining services</name>
  <files>
    lib/healthDeadManSwitch.js -> lib/healthDeadManSwitch.ts
    lib/healthLogger.js -> lib/healthLogger.ts
    lib/healthMonitoring.js -> lib/healthMonitoring.ts
    lib/netatmoService.js -> lib/netatmoService.ts
    lib/netatmoStoveSync.js -> lib/netatmoStoveSync.ts
    lib/services/StoveService.js -> lib/services/StoveService.ts
    lib/services/pidAutomationService.js -> lib/services/pidAutomationService.ts
    lib/services/unifiedDeviceConfigService.js -> lib/services/unifiedDeviceConfigService.ts
    lib/hlsDownloader.js -> lib/hlsDownloader.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - healthDeadManSwitch.ts: Type the dead man's switch. Create `interface DeadManSwitchState { lastPing: number; threshold: number; isTriggered: boolean; }`. Methods: `ping(): void`, `check(): boolean`.
    - healthLogger.ts: Type health log entries. Create `interface HealthLogEntry { timestamp: number; check: string; result: 'pass' | 'fail' | 'warning'; details?: string; }`.
    - healthMonitoring.ts: Type health check runner. Create `interface HealthCheck { name: string; run(): Promise<HealthCheckResult>; }` and `interface HealthCheckResult { status: 'healthy' | 'unhealthy' | 'degraded'; message: string; }`.
    - netatmoService.ts: Higher-level Netatmo operations. Type with Netatmo data shapes. Import from netatmoApi types.
    - netatmoStoveSync.ts (697 lines): Type sync logic. Import `StoveState` from `@/types/firebase`. Use coordination types from coordinationState.
    - services/StoveService.ts: Import `StoveState`, `StoveCommand` from `@/types/firebase`. Type all public methods with proper return types.
    - services/pidAutomationService.ts: Type PID parameters. Use PIDConfig from pidController (already migrated in Plan 01).
    - services/unifiedDeviceConfigService.ts (316 lines): Type device configuration. Import `DeviceType`, `Device` from `@/types/firebase`.
    - hlsDownloader.ts: Type HLS stream download. Create `interface HLSSegment { url: string; duration: number; }`. Return `Promise<Buffer>` or `Promise<Blob>`.

    **Rules:**
    - `git mv` for history
    - Import from `@/types/firebase` for StoveState, DeviceType, etc.
    - Health monitoring types stay local
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    Verify: `ls lib/healthDeadManSwitch.ts lib/healthLogger.ts lib/healthMonitoring.ts lib/netatmoService.ts lib/netatmoStoveSync.ts lib/services/StoveService.ts lib/services/pidAutomationService.ts lib/services/unifiedDeviceConfigService.ts lib/hlsDownloader.ts`
  </verify>
  <done>9 service files converted. Total: 92/116 lib files migrated.</done>
</task>

</tasks>

<verification>
- All 17 files exist as .ts
- `npx tsc --noEmit` passes with no new errors
- Coordination orchestrator imports StoveState from @/types/firebase
- StoveService imports StoveState, StoveCommand from @/types/firebase
</verification>

<success_criteria>
All 17 coordination, health, and high-level service files converted to TypeScript. Coordination system has typed state machine. Health monitoring has typed check results. StoveService uses Phase 37 types.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-07-SUMMARY.md`
</output>
