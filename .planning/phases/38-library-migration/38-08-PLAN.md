---
phase: 38-library-migration
plan: 08
type: execute
wave: 4
depends_on: ["38-04", "38-05"]
files_modified:
  - lib/maintenanceService.ts
  - lib/maintenanceServiceAdmin.ts
  - lib/schedulerService.ts
  - lib/schedulerStats.ts
  - lib/schedulerApiClient.ts
  - lib/schedulesApiClient.ts
  - lib/schedulesService.ts
  - lib/stoveStateService.ts
  - lib/sandboxService.ts
  - lib/changelogService.ts
  - lib/weatherCache.ts
  - lib/weatherCacheService.ts
  - lib/devicePreferencesService.ts
  - lib/services/dashboardPreferencesService.ts
  - lib/services/locationService.ts
  - lib/commands/deviceCommands.ts
autonomous: true

must_haves:
  truths:
    - "All 16 remaining service files have .ts extension"
    - "Maintenance service uses MaintenanceRecord from @/types/firebase"
    - "Scheduler service typed with schedule mode and timing interfaces"
    - "Weather cache typed with TTL and data shape"
    - "All lib/ source files (excluding tests) now have .ts extension"
  artifacts:
    - path: "lib/maintenanceService.ts"
      provides: "Maintenance tracking operations"
      contains: "MaintenanceRecord|MaintenanceType"
    - path: "lib/schedulerService.ts"
      provides: "Stove scheduler logic"
    - path: "lib/weatherCacheService.ts"
      provides: "Weather data caching"
    - path: "lib/commands/deviceCommands.ts"
      provides: "Command palette device commands"
  key_links:
    - from: "lib/maintenanceService.ts"
      to: "@/types/firebase"
      via: "import MaintenanceRecord"
      pattern: "import.*Maintenance.*from.*@/types"
    - from: "lib/schedulerService.ts"
      to: "lib/repositories"
      via: "SchedulerModeRepository usage"
      pattern: "SchedulerModeRepository|ScheduleRepository"
    - from: "lib/weatherCacheService.ts"
      to: "lib/weatherCache"
      via: "cache data access"
      pattern: "weatherCache|getWeather"
---

<objective>
Migrate all remaining lib/ service files from JavaScript to TypeScript — completing the lib/ source migration.

Purpose: These 16 files are the final batch of lib/ source files. They include maintenance, scheduler, weather, dashboard preferences, and device commands. After this plan, all 116 lib/ source files will have .ts extension.
Output: 16 .ts files completing the lib/ migration. Zero .js source files remaining in lib/ (only test files in __tests__/).
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/37-typescript-foundation/37-02-SUMMARY.md
@.planning/phases/38-library-migration/38-RESEARCH.md
@types/firebase/maintenance.ts
@types/firebase/stove.ts
@types/config/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate maintenance, scheduler, and stove state services</name>
  <files>
    lib/maintenanceService.js -> lib/maintenanceService.ts
    lib/maintenanceServiceAdmin.js -> lib/maintenanceServiceAdmin.ts
    lib/schedulerService.js -> lib/schedulerService.ts
    lib/schedulerStats.js -> lib/schedulerStats.ts
    lib/schedulerApiClient.js -> lib/schedulerApiClient.ts
    lib/schedulesApiClient.js -> lib/schedulesApiClient.ts
    lib/schedulesService.js -> lib/schedulesService.ts
    lib/stoveStateService.js -> lib/stoveStateService.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - maintenanceService.ts: Import `MaintenanceRecord`, `MaintenanceType`, `MaintenanceHistoryEntry` from `@/types/firebase`. Type CRUD operations: `getMaintenance(): Promise<MaintenanceRecord>`, `updateMaintenance(data: Partial<MaintenanceRecord>): Promise<void>`, `addHistoryEntry(entry: MaintenanceHistoryEntry): Promise<void>`.
    - maintenanceServiceAdmin.ts: Admin-level maintenance operations. Same type imports as above.
    - schedulerService.ts (377 lines): Create `type SchedulerMode = 'manual' | 'automatic' | 'semi-manual'`. Type schedule execution: `executeSchedule(): Promise<void>`, `getSchedulerStatus(): Promise<SchedulerStatus>`. Create `interface SchedulerStatus { mode: SchedulerMode; nextRun?: number; lastRun?: number; isActive: boolean; }`.
    - schedulerStats.ts: Type statistics tracking. Create `interface SchedulerStats { totalRuns: number; successRate: number; averageDuration: number; }`.
    - schedulerApiClient.ts: Type client-side API calls to scheduler endpoints. Return typed responses.
    - schedulesApiClient.ts: Type client-side API calls to schedule endpoints (Netatmo schedules).
    - schedulesService.ts: Type schedule management operations.
    - stoveStateService.ts: Import `StoveState` from `@/types/firebase`. Type: `getStoveState(): Promise<StoveState>`, `updateStoveState(state: Partial<StoveState>): Promise<void>`.

    **Rules:**
    - `git mv` for history
    - Import from `@/types/firebase` for MaintenanceRecord, StoveState, etc.
    - Scheduler mode types stay local unless broadly reused
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    Verify: `ls lib/maintenanceService.ts lib/maintenanceServiceAdmin.ts lib/schedulerService.ts lib/schedulerStats.ts lib/schedulerApiClient.ts lib/schedulesApiClient.ts lib/schedulesService.ts lib/stoveStateService.ts`
  </verify>
  <done>8 maintenance/scheduler/stove files converted to TypeScript.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate weather, dashboard, device commands, and remaining services</name>
  <files>
    lib/weatherCache.js -> lib/weatherCache.ts
    lib/weatherCacheService.js -> lib/weatherCacheService.ts
    lib/sandboxService.js -> lib/sandboxService.ts
    lib/changelogService.js -> lib/changelogService.ts
    lib/devicePreferencesService.js -> lib/devicePreferencesService.ts
    lib/services/dashboardPreferencesService.js -> lib/services/dashboardPreferencesService.ts
    lib/services/locationService.js -> lib/services/locationService.ts
    lib/commands/deviceCommands.js -> lib/commands/deviceCommands.ts
  </files>
  <action>
    For each file: `git mv old.js new.ts`, then add TypeScript annotations.

    **Specific guidance:**
    - weatherCache.ts: Type in-memory cache. Create `interface WeatherCacheEntry { data: WeatherData; timestamp: number; ttl: number; }` and `interface WeatherData { current: CurrentWeather; daily: DailyForecast[]; }` (or match existing shape from openMeteo).
    - weatherCacheService.ts: Higher-level cache operations. Use types from weatherCache.
    - sandboxService.ts (477 lines): Type sandbox execution. Create `interface SandboxConfig { timeout: number; ... }` and `interface SandboxResult { success: boolean; output?: unknown; error?: string; }`.
    - changelogService.ts: Type changelog entry operations. Create `interface ChangelogEntry { version: string; date: string; changes: string[]; }`.
    - devicePreferencesService.ts: Type device preference CRUD. Import `DeviceType` from `@/types/firebase` if applicable. Import `DashboardCardId` from `@/types/config` if applicable.
    - services/dashboardPreferencesService.ts: Import `DashboardPreferences`, `DashboardCardId` from `@/types/config`. Type: `getPreferences(userId: string): Promise<DashboardPreferences>`, `updatePreferences(userId: string, prefs: Partial<DashboardPreferences>): Promise<void>`.
    - services/locationService.ts: Type location operations. Create `interface Location { city: string; latitude: number; longitude: number; country?: string; }`.
    - commands/deviceCommands.ts: Type command definitions for Command Palette. Create `interface DeviceCommand { id: string; label: string; icon?: string; action: () => void | Promise<void>; category: string; }`.

    **Final verification — this task completes lib/ source migration:**
    After this task, run: `find lib -name "*.js" -not -path "*__tests__*"` — should return ZERO results.

    **Rules:**
    - `git mv` for history
    - Import from `@/types/config` for DashboardPreferences, DashboardCardId
    - No behavior changes
  </action>
  <verify>
    Run `npx tsc --noEmit` — no new errors.
    **CRITICAL CHECK:** `find lib -name "*.js" -not -path "*__tests__*" | wc -l` must return 0.
    This confirms LIB-01 (all lib/ files converted to .ts) and LIB-03 (utilities typed) and LIB-04 (services typed).
  </verify>
  <done>8 remaining files converted. ALL 116 lib/ source files now TypeScript. LIB-01, LIB-03, LIB-04 satisfied.</done>
</task>

</tasks>

<verification>
- **LIB-01 check:** `find lib -name "*.js" -not -path "*__tests__*" | wc -l` returns 0
- **LIB-03 check:** All utility functions have typed parameters and return types
- **LIB-04 check:** All services have typed parameters and return types
- `npx tsc --noEmit` passes with no new errors
- `npm run dev` starts without errors
</verification>

<success_criteria>
All 116 lib/ source files converted from .js to .ts. Zero JavaScript source files remain in lib/ (only test files in __tests__/ directories, deferred to Phase 42). Requirements LIB-01, LIB-03, LIB-04 satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-08-SUMMARY.md`
</output>
