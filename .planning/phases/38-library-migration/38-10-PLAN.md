---
phase: 38-library-migration
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - types/firebase/stove.ts
  - lib/version.ts
  - lib/coordinationOrchestrator.ts
  - lib/coordinationEventLogger.ts
  - lib/stoveApi.ts
  - lib/services/StoveService.ts
  - lib/sandboxService.ts
  - lib/schedulerService.ts
  - lib/devices/deviceTypes.ts
  - lib/devicePreferencesService.ts
  - lib/core/netatmoHelpers.ts
  - lib/coordinationUserIntent.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "tsc --noEmit reports 0 errors for files in this plan"
    - "All union types include every runtime value used in the codebase"
    - "All interfaces include every property accessed in the codebase"
  artifacts:
    - path: "types/firebase/stove.ts"
      provides: "StoveStatus with START/STANDBY, StoveState with fanLevel/powerLevel, StovePowerLevel accepts number cast"
    - path: "lib/coordinationOrchestrator.ts"
      provides: "CoordinationAction includes capped/retry_timer/throttled"
    - path: "lib/version.ts"
      provides: "VersionEntry includes breaking/tags properties"
  key_links:
    - from: "lib/services/StoveService.ts"
      to: "types/firebase/stove.ts"
      via: "import StoveStatus, StoveState, StovePowerLevel"
      pattern: "import.*StoveStatus.*from.*@/types"
---

<objective>
Fix ~45 TypeScript errors caused by incomplete union types, missing interface properties, and incorrect type assertions across shared type definitions and service files.

Purpose: Shared type definitions must accurately reflect all runtime values to enable type-safe code across the codebase. These are the most impactful fixes because they correct the source-of-truth types.

Output: 12 files updated with complete type definitions, 0 tsc errors for these files.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-library-migration/38-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix shared type definitions (types/firebase/stove.ts) and dependent services</name>
  <files>types/firebase/stove.ts, lib/services/StoveService.ts, lib/stoveApi.ts, lib/devices/deviceTypes.ts, lib/devicePreferencesService.ts</files>
  <action>
**types/firebase/stove.ts** -- Fix 3 type issues:
1. Add `'START'` and `'STANDBY'` to `StoveStatus` union (StoveService.ts uses uppercase values from Thermorossi API)
2. Add `fanLevel?: number` and `powerLevel?: number` to `StoveState` interface (StoveService.ts sets these at lines 112, 138)
3. StovePowerLevel is `1|2|3|4|5` but StoveService.ts passes a `number` at line 49. Add a utility type or change the assignment to cast: `power as StovePowerLevel`. The type definition is correct (power IS 1-5), so the fix is in StoveService.ts, not the type.

**lib/services/StoveService.ts** -- Fix 8 errors:
- Line 49: Cast `number` to `StovePowerLevel`: `stoveData.power as StovePowerLevel`
- Line 53: `'START'` is now valid after StoveStatus fix above
- Line 82: `'STANDBY'` is now valid after StoveStatus fix above (error suggests `'standby'` -- add BOTH cases to StoveStatus)
- Line 112: `fanLevel` now valid after StoveState fix above
- Line 138: `powerLevel` now valid after StoveState fix above
- Lines 67, 95: `roomNames` and `temperature` not on sync result union type. The `syncResult` from `setRoomsToBoostMode`/`restoreRoomSetpoints` returns a union. Fix by adding type guard: check `if ('roomNames' in syncResult)` before accessing, OR narrow via `if (syncResult.action)` which identifies the success branch.

**lib/stoveApi.ts** -- Fix 4 errors:
- Lines 205, 225, 249, 273: `StoveApiResponse` requires `isSandbox: boolean` but error paths return `{ success: boolean }`. Fix by making `isSandbox` optional in the `StoveApiResponse` interface: `isSandbox?: boolean`. OR add `isSandbox: false` to each error return. Prefer making it optional since error paths legitimately don't have sandbox info.

**lib/devices/deviceTypes.ts** -- Fix 1 error (enables devicePreferencesService.ts fix):
- `DeviceTypeId` is `'stove' | 'thermostat' | 'camera' | 'lights' | 'sonos'`. At lib/devicePreferencesService.ts:132, `DeviceTypeId` is not assignable to `'stove' | 'thermostat'`. The function at that line likely filters devices. Fix in devicePreferencesService.ts by widening the parameter type to accept `DeviceTypeId` instead of the narrow literal, OR cast at call site.

**lib/devicePreferencesService.ts** -- Fix 1 error:
- Line 132: Change the parameter type from `'stove' | 'thermostat'` to `DeviceTypeId`, or use a type assertion at the call site. Read the function being called to determine the right fix.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/services/StoveService|^lib/stoveApi|^lib/devicePreferences|^types/firebase/stove" | wc -l`
Expected: 0
  </verify>
  <done>StoveStatus includes START/STANDBY, StoveState includes fanLevel/powerLevel, all StoveService/stoveApi/devicePreferences errors resolved</done>
</task>

<task type="auto">
  <name>Task 2: Fix coordination, version, sandbox, scheduler, and netatmo helper types</name>
  <files>lib/coordinationOrchestrator.ts, lib/coordinationEventLogger.ts, lib/coordinationUserIntent.ts, lib/version.ts, lib/sandboxService.ts, lib/schedulerService.ts, lib/core/netatmoHelpers.ts</files>
  <action>
**lib/coordinationOrchestrator.ts** -- Fix 6 errors:
- The local `CoordinationResult.action` type at line 29 is `'skipped' | 'paused' | 'debouncing' | 'applied' | 'restored' | 'no_change'`. Add `'capped'` | `'retry_timer'` | `'throttled'` to this union. These are used at lines 205, 256, 452.
- Line 110: `NETATMO_API.getThermSchedules` does not exist. Check lib/netatmoApi.ts for the actual method name (likely `getSchedules` or similar). Fix the method call to use the correct name.
- Line 124: String not assignable to `'manual_setpoint_change' | 'manual_mode_change'`. The `detectUserIntent` function returns a `string`. Cast the result: `as 'manual_setpoint_change' | 'manual_mode_change'` or widen the type in the interface.
- Line 269: `CoordinationResult` requires `reason` but `{ action: 'no_change', stoveOn: boolean }` is missing it. Add `reason: 'no change needed'` (or similar) to the object literal.

**lib/coordinationEventLogger.ts** -- Fix 6 errors (lines 139, 144, 151, 152, 155, 159):
- The local `CoordinationAction` type at line 48 needs `'no_change'` | `'capped'` | `'retry_timer'` | `'throttled'` added.
- All 6 errors are Query<DocumentData> being assigned to CollectionReference. The `getCoordinationEvents` function uses Firestore `where()` which returns `Query`, not `CollectionReference`. Fix: Change the variable type from `CollectionReference<DocumentData>` to `Query<DocumentData, DocumentData>` using `import { Query } from 'firebase-admin/firestore'`. The initial `collection()` call returns CollectionReference which is a subtype of Query, so using Query as the variable type works for both the initial assignment and after `where()` calls.

**lib/coordinationUserIntent.ts** -- Fix 1 error:
- Line 107: `string` not assignable to `'off' | 'away' | 'hg'`. Cast the argument: `as 'off' | 'away' | 'hg'` or widen the parameter type.

**lib/version.ts** -- Fix 8 errors:
- The `VersionEntry` interface (line 17-24) is missing `breaking?: boolean` and `tags?: string[]`. Add both as optional properties. Lines 212, 223 use `tags`, lines 562, 577, 590, 607, 684, 701 use `breaking`.

**lib/sandboxService.ts** -- Fix 3 errors:
- Lines 240: `getSandboxMaintenance()` at line 353-367 returns `SandboxConfig` but should return `SandboxMaintenance`. Fix line 366: change `as SandboxConfig` to `as SandboxMaintenance`.
- Lines 253, 292: `getSandboxSettings()` at line 434-448 returns `SandboxConfig` but should return `SandboxConfig['settings']`. Fix line 447: change `as SandboxConfig` to `as SandboxConfig['settings']`. Or create a `SandboxSettings` type alias and use that.

**lib/schedulerService.ts** -- Fix 1 error:
- Line 371: Object literal `{ enabled: false, semiManual: false }` is missing `lastUpdated` required by `SchedulerMode`. Add `lastUpdated: new Date().toISOString()` to the object literal. OR make `lastUpdated` optional in the `SchedulerMode` interface if it's not always present.

**lib/core/netatmoHelpers.ts** -- Fix 2 errors:
- Line 55: `Property 'message' does not exist on type 'TokenResult'`. `TokenResult` is `TokenSuccess | TokenError`. `message` exists only on `TokenError`. The code already checks `if (error)` above, but TypeScript needs narrowing. Fix by narrowing: access `message` only after checking the discriminant, e.g., `const { accessToken, error } = await getValidAccessToken(); if (error) { ... (result as TokenError).message ... }` OR destructure differently. Read the actual code at line 55 to determine the best narrowing approach.
- Line 70: `number` not assignable to `HttpStatus`. The `status` variable comes from `handleTokenError` which returns a generic `number`. Cast it: `status as HttpStatus` OR change `handleTokenError` return type.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/coordination|^lib/version|^lib/sandbox|^lib/scheduler|^lib/core/netatmo" | wc -l`
Expected: 0
  </verify>
  <done>All coordination, version, sandbox, scheduler, and netatmo helper type errors resolved. Union types include all runtime values. Interfaces include all accessed properties.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit 2>&1 | grep -E "^(types/|lib/version|lib/coordination|lib/stoveApi|lib/services/Stove|lib/sandbox|lib/scheduler|lib/devices/|lib/devicePreferences|lib/core/netatmo)" | wc -l` -- should be 0.
</verification>

<success_criteria>
- 0 tsc errors for all 12 files modified by this plan
- Union types (StoveStatus, CoordinationAction, CoordinationResult.action) include all runtime values
- Interfaces (VersionEntry, StoveState, StoveApiResponse, SchedulerMode) include all accessed properties
- SandboxService functions return correct types (SandboxMaintenance, SandboxConfig['settings'])
- No behavior changes -- only type definitions updated
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-10-SUMMARY.md`
</output>
