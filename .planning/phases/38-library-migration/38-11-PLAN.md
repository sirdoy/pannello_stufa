---
phase: 38-library-migration
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/healthLogger.ts
  - lib/notificationLogger.ts
  - lib/notificationHistoryService.ts
  - lib/coordinationPauseCalculator.ts
  - lib/notificationTriggers.ts
  - lib/notificationTriggersServer.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "tsc --noEmit reports 0 errors for files in this plan"
    - "Firestore query variables use Query type, not CollectionReference"
    - "All function parameters have proper interfaces instead of {}"
  artifacts:
    - path: "lib/healthLogger.ts"
      provides: "HealthLogFilter interface, Query<DocumentData> variable type"
    - path: "lib/notificationLogger.ts"
      provides: "NotificationLogFilter interface, Query<DocumentData> variable type"
    - path: "lib/notificationHistoryService.ts"
      provides: "NotificationHistoryFilter interface"
  key_links:
    - from: "lib/healthLogger.ts"
      to: "firebase-admin/firestore"
      via: "import Query"
      pattern: "import.*Query.*from.*firebase-admin"
---

<objective>
Fix ~38 TypeScript errors caused by Firestore Query vs CollectionReference type mismatches and untyped function parameters (typed as `{}`) across logger and notification files.

Purpose: These files all share the same two error patterns: (1) `where()` returns `Query` not `CollectionReference`, and (2) filter/options parameters are typed as `{}` instead of proper interfaces. Fixing these patterns consistently across all logger files ensures type safety for Firestore operations.

Output: 6 files updated with proper Firestore types and parameter interfaces, 0 tsc errors for these files.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-library-migration/38-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Firestore query types and parameter interfaces in logger files</name>
  <files>lib/healthLogger.ts, lib/notificationLogger.ts, lib/notificationHistoryService.ts</files>
  <action>
**lib/healthLogger.ts** -- Fix 12 errors:

Pattern A: Query vs CollectionReference (lines 160, 161, 165, 169, 173 -- 5 errors):
- The `getHealthLogs` function builds a Firestore query by chaining `where()` and `orderBy()` on a CollectionReference. After the first `where()`, the result is `Query<DocumentData>`, not `CollectionReference`.
- Fix: Import `Query` from `firebase-admin/firestore`. Change the variable that holds the query chain from `CollectionReference<DocumentData>` to `Query<DocumentData, DocumentData>`. Example:
  ```typescript
  let query: Query<DocumentData, DocumentData> = collectionRef;
  // Now where() assignments work:
  query = query.where('timestamp', '>=', startDate);
  ```

Pattern B: Parameter typed as `{}` (lines 157, 158, 164, 165, 172 -- 5 errors):
- The function has a `filters` parameter typed as `{}`. Properties `startDate`, `endDate`, `hasStateMismatch`, `limit` are accessed but don't exist on `{}`.
- Fix: Define a `HealthLogFilter` interface:
  ```typescript
  interface HealthLogFilter {
    startDate?: Date;
    endDate?: Date;
    hasStateMismatch?: boolean;
    limit?: number;
  }
  ```
  Change the parameter type from `{}` to `HealthLogFilter`.

Pattern C: Other errors:
- Line 106: `Property 'StatusDescription' does not exist on type 'string'`. Read the code context -- likely accessing a property on a raw API response that should be typed. If the value comes from the stove API, cast it to the appropriate type or access it correctly.
- Line 269: `Type 'string' is not assignable to type 'number'`. Read the code context -- likely a `duration` or timestamp field that needs `Number()` conversion or is being assigned to a wrong-typed variable.

**lib/notificationLogger.ts** -- Fix 15 errors:

Pattern A: Query vs CollectionReference (lines 130, 134, 138, 142, 146, 150 -- 6 errors):
- Same fix as healthLogger.ts. Import `Query` from `firebase-admin/firestore`. Use `Query<DocumentData, DocumentData>` as the variable type for the query chain.

Pattern B: Parameter typed as `{}` (lines 129, 130, 133, 134, 137, 138, 141, 142, 149 -- 9 errors):
- Define a `NotificationLogFilter` interface:
  ```typescript
  interface NotificationLogFilter {
    startDate?: Date;
    endDate?: Date;
    status?: string;
    type?: string;
    limit?: number;
  }
  ```
  Change the parameter type from `{}` to `NotificationLogFilter`.

**lib/notificationHistoryService.ts** -- Fix 5 errors:

Pattern B: Parameter typed as `{}` (lines 36, 37, 38, 39 -- 4 errors):
- Define a `NotificationHistoryFilter` interface:
  ```typescript
  interface NotificationHistoryFilter {
    limit?: number;
    cursor?: string;
    type?: string;
    status?: string;
  }
  ```
  Change the parameter type from `{}` to `NotificationHistoryFilter`.

Pattern C: forEach callback (line 102):
- `(doc: any, index: any) => void` not assignable to Firestore forEach callback type. Remove the `index` parameter (Firestore `forEach` only passes `doc`) and type `doc` properly: `(doc: QueryDocumentSnapshot<DocumentData>) => void`.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/(healthLogger|notificationLogger|notificationHistoryService)" | wc -l`
Expected: 0
  </verify>
  <done>All healthLogger, notificationLogger, and notificationHistoryService tsc errors resolved. Query types properly used for Firestore chains. Filter parameters have proper interfaces.</done>
</task>

<task type="auto">
  <name>Task 2: Fix notification trigger and coordination pause calculator types</name>
  <files>lib/notificationTriggersServer.ts, lib/notificationTriggers.ts, lib/coordinationPauseCalculator.ts</files>
  <action>
**lib/notificationTriggersServer.ts** -- Fix 9 errors:

1. Lines 99-102: `unknown` type access. The code spreads an unknown value and accesses `.enabledTypes`, `.dndWindows`, `.rateLimits` on it. This data comes from `adminDbGet()` which returns `unknown`. Fix: Define a `NotificationPreferencesData` interface (or reuse existing one from types/firebase/notifications.ts if it matches) and cast the result: `const prefs = await adminDbGet(path) as NotificationPreferencesData | null`.

2. Line 99: `Spread types may only be created from object types` -- the spread of `unknown`. Fix by casting first (see above), then spreading.

3. Line 159: `Property 'skipPreferenceCheck' does not exist on type '{}'`. The `options` parameter is typed as `{}`. Define an interface:
   ```typescript
   interface TriggerNotificationOptions {
     skipPreferenceCheck?: boolean;
   }
   ```
   Change the parameter type from `{}` to `TriggerNotificationOptions`.

4. Lines 207, 211, 212 (4 errors): `successCount` and `failureCount` don't exist on a union type. The `sendNotificationToUser` or `sendNotificationToAll` return is a union where not all branches have these properties. Fix by narrowing: check `if ('successCount' in result)` before accessing, OR add a type guard for the multi-device result branch.

**lib/notificationTriggers.ts** -- Fix 1 error:
- Line 418: `Property 'url' does not exist on type '{}'`. An `options` or `data` parameter is typed as `{}`. Read the function signature, define a proper interface with `url?: string`, and use it.

**lib/coordinationPauseCalculator.ts** -- Fix 2 errors:
- Lines 131, 132: `Property 'name'/'temp' does not exist on type '{}'`. A parameter (likely a room or data object) is typed as `{}`. Read the function context and define a proper interface:
  ```typescript
  interface RoomData {
    name: string;
    temp: number;
  }
  ```
  Or use the appropriate existing type (e.g., from netatmoApi.ts types).
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/(notificationTriggers|coordinationPause)" | wc -l`
Expected: 0
  </verify>
  <done>All notificationTriggersServer, notificationTriggers, and coordinationPauseCalculator tsc errors resolved. Unknown data properly typed with interfaces. Filter/options parameters have proper types.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit 2>&1 | grep -E "^lib/(healthLogger|notificationLogger|notificationHistoryService|notificationTriggers|coordinationPause)" | wc -l` -- should be 0.
</verification>

<success_criteria>
- 0 tsc errors for all 6 files modified by this plan
- All Firestore query chain variables use `Query<DocumentData, DocumentData>` type
- All function filter/options parameters have named interfaces instead of `{}`
- Unknown data from Firebase properly narrowed with type assertions
- No behavior changes -- only type annotations updated
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-11-SUMMARY.md`
</output>
