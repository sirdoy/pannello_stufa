---
phase: 38-library-migration
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/netatmoStoveSync.ts
  - lib/schedulesService.ts
  - lib/migrateSchedules.ts
  - lib/netatmoService.ts
  - lib/firebaseAdmin.ts
  - lib/healthDeadManSwitch.ts
  - lib/healthMonitoring.ts
  - lib/notificationService.ts
  - lib/tokenRefresh.ts
  - lib/tokenStorage.ts
  - lib/services/unifiedDeviceConfigService.ts
  - lib/schedulerStats.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "tsc --noEmit reports 0 errors for files in this plan"
    - "All Firebase data access uses type assertions or type guards, never raw unknown"
    - "Firebase messaging priority uses literal type 'high' not string"
  artifacts:
    - path: "lib/netatmoStoveSync.ts"
      provides: "Typed Firebase data access for sync config"
    - path: "lib/schedulesService.ts"
      provides: "Typed schedule data from Firebase snapshots"
    - path: "lib/firebaseAdmin.ts"
      provides: "Typed token records, literal priority types"
  key_links:
    - from: "lib/netatmoStoveSync.ts"
      to: "firebase/database"
      via: "get().val() with type assertion"
      pattern: "as.*Config|as.*Data"
---

<objective>
Fix ~62 TypeScript errors caused by property access on `unknown` type (data from Firebase `get().val()` and `adminDbGet()`), plus Firebase messaging priority string literal issues.

Purpose: Firebase database reads return `unknown` by default. Every access point needs a type assertion to the expected data shape. This is the largest category of errors and follows a consistent pattern: define or reuse an interface, cast the Firebase result.

Output: 12 files updated with proper type assertions for Firebase data, 0 tsc errors for these files.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-library-migration/38-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix unknown type access in Netatmo, schedules, and migration files</name>
  <files>lib/netatmoStoveSync.ts, lib/schedulesService.ts, lib/migrateSchedules.ts, lib/netatmoService.ts, lib/services/unifiedDeviceConfigService.ts</files>
  <action>
**GENERAL PATTERN:** For every `adminDbGet()` or `snapshot.val()` that returns `unknown`, add a type assertion to the expected interface. Read the properties being accessed to determine the correct type shape.

**lib/netatmoStoveSync.ts** -- Fix 14 errors:

1. Lines 62-69: Data from Firebase accessed as unknown. Properties: `livingRoomId`, `rooms`, `livingRoomName`, `originalSetpoint`. This is sync configuration data. Define a local interface:
   ```typescript
   interface SyncConfigData {
     livingRoomId?: string;
     livingRoomName?: string;
     rooms?: Array<Record<string, unknown>>;
     originalSetpoint?: number;
     [key: string]: unknown;
   }
   ```
   Cast the Firebase result: `const configData = snapshot.val() as SyncConfigData | null`.

2. Line 65: `Spread types may only be created from object types` -- spreading an `unknown`. Once the data is typed (step 1), the spread will work.

3. Line 74: `Type '{}' is missing properties from StoveSyncConfig`. Read the `StoveSyncConfig` interface definition in this file. The fallback empty object needs all required properties. Use `Partial<StoveSyncConfig>` or provide defaults for all required fields.

4. Lines 218, 242, 321, 398, 437: `unknown` not assignable to `string`. These are string values read from Firebase. Cast each: `as string`. Or cast the parent data object to a typed interface.

5. Lines 685, 690: `Property 'rooms' does not exist on type 'unknown'`. Another Firebase read. Cast the home status data: `const homeStatus = await adminDbGet(path) as { rooms?: Array<Record<string, unknown>> } | null`.

**lib/schedulesService.ts** -- Fix 14 errors:

Lines 56-64 and 157-165 (two nearly identical blocks):
- Data from `snapshot.val()` is `unknown`. Properties accessed: `name`, `enabled`, `createdAt`, `updatedAt`, `slots`.
- The file already defines `ScheduleMetadata` interface. Use the raw Firebase shape:
  ```typescript
  interface ScheduleRawData {
    name: string;
    enabled: boolean;
    createdAt: string;
    updatedAt: string;
    slots: Record<string, unknown[]>;
  }
  ```
  Cast: `const data = snapshot.val() as ScheduleRawData`.
- Lines 64, 165: Arithmetic on `createdAt`/`updatedAt` (which are strings used in `new Date()` constructor then `.getTime()`). Read the actual code -- if it's `new Date(data.createdAt).getTime()` that's fine once typed. If it's direct arithmetic on the string, wrap in `new Date()`.

**lib/migrateSchedules.ts** -- Fix 6 errors:
- Lines 119, 121, 124, 143, 174: `Property 'mode' does not exist on type 'unknown'`. Firebase data needs casting. Define:
  ```typescript
  interface SchedulerModeData {
    mode?: string;
    enabled?: boolean;
    [key: string]: unknown;
  }
  ```
  Cast at the read point.
- Line 259: `Property 'slots' does not exist on type 'unknown'`. Same pattern -- cast the schedule data.

**lib/netatmoService.ts** -- Fix 6 errors:
- Lines 159, 160, 168, 169, 179, 181: `Property 'rooms'/'modules' does not exist on type 'unknown'`. Data from Firebase (home status). Cast to:
  ```typescript
  interface NetatmoHomeData {
    rooms?: Array<Record<string, unknown>>;
    modules?: Array<Record<string, unknown>>;
  }
  ```
  Apply at the read point.

**lib/services/unifiedDeviceConfigService.ts** -- Fix 2 errors:
- Line 122: `Property 'version' does not exist on type 'unknown'`. Cast Firebase data: `as { version?: number } | null`.
- Line 191: `Property 'cardOrder' does not exist on type 'unknown'`. Cast Firebase data: `as { cardOrder?: string[] } | null`.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/(netatmoStoveSync|schedulesService|migrateSchedules|netatmoService|services/unified)" | wc -l`
Expected: 0
  </verify>
  <done>All unknown type access errors in Netatmo, schedules, and migration files resolved with proper type assertions</done>
</task>

<task type="auto">
  <name>Task 2: Fix unknown type access in Firebase admin, health, notification, and token files</name>
  <files>lib/firebaseAdmin.ts, lib/healthDeadManSwitch.ts, lib/healthMonitoring.ts, lib/notificationService.ts, lib/tokenRefresh.ts, lib/tokenStorage.ts, lib/schedulerStats.ts</files>
  <action>
**lib/firebaseAdmin.ts** -- Fix 6 errors:

1. Lines 162-163: `Property 'token'/'deviceId' does not exist on type 'unknown'`. Firebase token record data. Cast:
   ```typescript
   interface TokenRecord {
     token: string;
     deviceId: string;
     [key: string]: unknown;
   }
   ```
   Apply at read point: `const tokenData = snapshot.val() as TokenRecord | null`.

2. Line 238: Same `token` on `unknown` pattern. Apply same `TokenRecord` cast at this read point.

3. Lines 354, 434: Firebase messaging `priority: string` not assignable to `Message`/`MulticastMessage`. The `android.priority` must be `'high' | 'normal'`, not `string`. Fix by using literal: `priority: 'high' as const` (or just `priority: 'high'`). Same for `android.notification.priority` if present. Check both the `android` and `apns` config objects in the message construction.

**lib/healthDeadManSwitch.ts** -- Fix 3 errors:
- Line 65: `No overload matches this call` -- likely a Firestore query or date comparison issue. Read the code context to determine the exact fix (probably needs a Timestamp conversion or type assertion).
- Lines 74, 82: `unknown` not assignable to `string`. Firebase data needs casting. Cast to string: `as string`.

**lib/healthMonitoring.ts** -- Fix 3 errors:
- Line 78: `StoveStatusResponse` not assignable to `string`. The variable expects a string but receives a full response object. Access `.status` or the appropriate string property from the response. Or change the variable type.
- Lines 297, 303: `Property 'token' does not exist on type 'unknown'`. Firebase token data. Cast: `as { token: string } | null`.

**lib/notificationService.ts** -- Fix 7 errors:
- Line 89: `Property 'standalone' does not exist on type 'Navigator'`. This is the iOS PWA detection. Fix with: `(navigator as unknown as { standalone?: boolean }).standalone` or use the standard check: `window.matchMedia('(display-mode: standalone)').matches`.
- Line 245: `Expected 1 arguments, but got 0`. A `Promise` resolve is called without an argument but the Promise type expects one. Fix: Use `Promise<void>` and call `resolve()`, or `resolve(undefined)`.
- Lines 270, 271: `Property 'scope'/'active' does not exist on type 'unknown'`. Service worker registration from Firebase result. Cast: `as ServiceWorkerRegistration`.
- Line 283: `Property 'serviceWorkerRegistration' does not exist on type '{ vapidKey: string }'`. The FCM `getToken()` config needs `serviceWorkerRegistration`. Widen the config type by constructing the object with proper typing, or use `as any` for the config parameter (FCM accepts it).
- Line 324: `DeviceInfo` not assignable to `Record<string, unknown>`. Add index signature to `DeviceInfo` interface: `[key: string]: unknown;`. Or use intermediate cast: `deviceInfo as unknown as Record<string, unknown>`.
- Line 495: `Property 'token' does not exist on type 'unknown'`. Firebase data. Cast: `as { token: string } | null`.

**lib/tokenStorage.ts** -- Fix interface (enables tokenRefresh.ts fixes):
- Add `platform?: string` and `isPWA?: boolean` to the `TokenStorageRecord` interface (currently at top of file, has: id, token, createdAt, lastUsed, deviceId, deviceInfo).

**lib/tokenRefresh.ts** -- Fix 4 errors:
- Line 114: `Property 'serviceWorkerRegistration' does not exist on type '{ vapidKey: string }'`. Same issue as notificationService.ts line 283. Fix by widening the config object type or using `as any` on the config.
- Lines 139, 140: `Property 'platform'/'isPWA' does not exist on type 'TokenStorageRecord'`. Fixed by updating TokenStorageRecord in tokenStorage.ts (above).
- Line 153: `Record<string, unknown> | DeviceInfo` not assignable to `Record<string, unknown>`. Fix by adding index signature to DeviceInfo or using cast.

**lib/schedulerStats.ts** -- Fix 1 error:
- Line 136: `Operator '>' cannot be applied to types 'unknown' and 'number'`. Firebase data is `unknown`. Cast to `number`: `(value as number) > threshold`.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/(firebaseAdmin|healthDead|healthMonitoring|notificationService|tokenRefresh|tokenStorage|schedulerStats)" | wc -l`
Expected: 0
  </verify>
  <done>All unknown type access errors in Firebase admin, health monitoring, notification service, and token files resolved. Firebase messaging uses literal priority types. TokenStorageRecord includes platform and isPWA properties.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit 2>&1 | grep -E "^lib/(netatmoStove|schedules|migrate|netatmoService|firebaseAdmin|health|notification[^L]|tokenRefresh|tokenStorage|services/unified|schedulerStat)" | wc -l` -- should be 0.
</verification>

<success_criteria>
- 0 tsc errors for all 12 files modified by this plan
- Every Firebase `get().val()` and `adminDbGet()` result has a type assertion
- Firebase messaging priority uses `'high' as const` literal, not bare `string`
- Navigator standalone check uses proper type assertion for iOS PWA detection
- TokenStorageRecord includes platform and isPWA properties
- No behavior changes -- only type annotations and assertions added
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-12-SUMMARY.md`
</output>
