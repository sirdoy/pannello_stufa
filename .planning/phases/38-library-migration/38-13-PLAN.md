---
phase: 38-library-migration
plan: 13
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/maintenanceService.ts
  - lib/maintenanceServiceAdmin.ts
  - lib/netatmoApi.ts
  - lib/commands/deviceCommands.tsx
  - lib/hooks/useBackgroundSync.ts
  - lib/hooks/useOnlineStatus.ts
  - lib/hooks/usePWAInstall.ts
  - lib/hooks/useWakeLock.ts
  - lib/hooks/useGeofencing.ts
  - lib/hooks/useRoomStatus.ts
  - lib/hlsDownloader.ts
  - lib/pwa/periodicSync.ts
  - lib/repositories/base/BaseRepository.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "tsc --noEmit reports 0 errors for files in this plan"
    - "MaintenanceData can be cast to Record<string, unknown> without error"
    - "All hook return type interfaces match actual return values"
    - "HLS downloader function signatures match call sites"
  artifacts:
    - path: "lib/maintenanceService.ts"
      provides: "MaintenanceData with index signature for Firebase writes"
    - path: "lib/hooks/useBackgroundSync.ts"
      provides: "Correct return type for queueStoveCommand"
    - path: "lib/hlsDownloader.ts"
      provides: "Correct function signatures matching call sites"
  key_links:
    - from: "lib/maintenanceService.ts"
      to: "firebase/database"
      via: "update() with Record<string, unknown>"
      pattern: "as unknown as Record"
---

<objective>
Fix ~43 TypeScript errors across three categories: (1) Record<string, unknown> conversion errors for MaintenanceData/Netatmo params, (2) Promise return type mismatches in hooks and commands, (3) miscellaneous function signature and type issues.

Purpose: These are the remaining errors after type definitions (Plan 10), Firestore query types (Plan 11), and Firebase unknown access (Plan 12) are fixed. This plan handles the "last mile" of conversion issues.

Output: 13 files updated, 0 tsc errors for these files.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-library-migration/38-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Record conversion errors in maintenance and Netatmo API files</name>
  <files>lib/maintenanceService.ts, lib/maintenanceServiceAdmin.ts, lib/netatmoApi.ts</files>
  <action>
**lib/maintenanceService.ts** -- Fix 9 errors:

1. Lines 49-53 (4 errors): `Property 'hoursWorked'/'maxHours'/'needsCleaning'/'lastUpdatedAt' does not exist on type 'SandboxConfig'`. The function `getSandboxMaintenance()` in sandboxService.ts currently returns `SandboxConfig` but should return `SandboxMaintenance`. Plan 38-10 fixes sandboxService.ts. However, if Plan 10 hasn't run yet, this plan should handle it defensively. Cast at the call site: `const sandboxData = await getSandboxMaintenance() as unknown as SandboxMaintenance`. Import `SandboxMaintenance` from sandboxService. OR if the function already returns the correct type after Plan 10, no cast needed. Since plans run in parallel, add the defensive cast.

2. Line 94: `Argument of type 'string | number' is not assignable to parameter of type 'string'`. A value that could be string or number is passed where only string is expected. Cast: `String(value)` or `value as string`. Read the context to determine if `String()` conversion is more appropriate.

3. Lines 214, 218 (2 errors): `Conversion of type 'MaintenanceData' to type 'Record<string, unknown>' may be a mistake`. Fix by using double assertion: `data as unknown as Record<string, unknown>`. This is the recommended pattern from Phase 38-08 for typed objects passed to Firebase `update()`.

4. Lines 243, 244 (2 errors): Same pattern but for `MaintenanceData & { _notificationData?: unknown; _elapsedMinutes?: number }`. Same fix: `data as unknown as Record<string, unknown>`.

**lib/maintenanceServiceAdmin.ts** -- Fix 4 errors:

1. Line 64 (2 errors): `Left/right-hand side of arithmetic operation must be type number`. Values from MaintenanceData (likely `currentHours` and `targetHours`) are being used in arithmetic but TypeScript sees them as potentially non-numeric. Read the context: if the values come from a Firebase read typed as `unknown`, cast them: `(data.currentHours as number)`. Or ensure the parent object is properly typed.

2. Lines 103, 104 (2 errors): Same `MaintenanceData & { ... }` to `Record<string, unknown>` conversion. Fix: `data as unknown as Record<string, unknown>`.

**lib/netatmoApi.ts** -- Fix 4 errors:

1. Lines 337, 379, 401 (3 errors): `Conversion of type 'GetRoomMeasureParams'/'SetThermModeParams'/'CreateScheduleParams' to type 'Record<string, unknown>' may be a mistake`. These are typed parameter objects being cast to `Record<string, unknown>` for the API call helper. Fix with double assertion: `params as unknown as Record<string, unknown>`. OR add `[key: string]: unknown` index signature to each params interface. The index signature approach is cleaner if these interfaces are only used internally.

2. Line 339: `Conversion of { [key: string]: unknown; homes?: ... } to type 'unknown[]'`. This is likely a response parsing issue where an object is being cast to an array. Read the code context -- the API response might be `{ homes: [...] }` and the code is trying to cast the whole object to `unknown[]`. Fix: Access the array property first: `response.homes as unknown[]` instead of casting the entire response.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/(maintenance|netatmoApi)" | wc -l`
Expected: 0
  </verify>
  <done>MaintenanceData and Netatmo API param objects can be properly passed to Firebase and API helpers without Record conversion errors</done>
</task>

<task type="auto">
  <name>Task 2: Fix Promise return types in hooks, command types, and misc issues</name>
  <files>lib/commands/deviceCommands.tsx, lib/hooks/useBackgroundSync.ts, lib/hooks/useOnlineStatus.ts, lib/hooks/usePWAInstall.ts, lib/hooks/useWakeLock.ts, lib/hooks/useGeofencing.ts, lib/hooks/useRoomStatus.ts, lib/hlsDownloader.ts, lib/pwa/periodicSync.ts, lib/repositories/base/BaseRepository.ts</files>
  <action>
**lib/commands/deviceCommands.tsx** -- Fix 5 errors (lines 113, 119, 189, 195, 201):
- `Promise<unknown>` not assignable to `void | Promise<void>`. These are `onSelect` callbacks in command items that call async functions returning `Promise<unknown>`. Fix: Wrap each callback to discard the return value:
  ```typescript
  onSelect: async () => { await someAsyncFunction(); }
  ```
  OR cast the function: `onSelect: someAsyncFunction as () => Promise<void>`
  OR add `void` operator: `onSelect: () => void someAsyncFunction()`
  The wrapper approach is cleanest.

**lib/hooks/useBackgroundSync.ts** -- Fix 1 error:
- Line 219: Return type `(action: any, data?: {}) => Promise<number>` not assignable to `(action: string, body?: Record<string, unknown>) => Promise<void>`. The hook's return type interface declares the function returns `Promise<void>` but the implementation returns `Promise<number>`. Fix: Either update the return type interface to `Promise<number>`, or change the implementation to not return the number (just await and discard), or use `Promise<number | void>`. Read the interface definition to determine which is correct.

**lib/hooks/useOnlineStatus.ts** -- Fix 1 error:
- Line 143: `() => Promise<boolean>` not assignable to `() => Promise<void>`. Same pattern as useBackgroundSync. The hook return type interface says `Promise<void>` but implementation returns `Promise<boolean>`. Fix: Update the return type interface to match: `() => Promise<boolean>`.

**lib/hooks/usePWAInstall.ts** -- Fix 2 errors:
- Line 46: `Property 'standalone' does not exist on type 'Navigator'`. Fix: `(navigator as any).standalone` or define a type augmentation for iOS Navigator.
- Line 191: Return type mismatch. The `promptInstall` function returns `Promise<{ outcome: any; error?: undefined } | ...>` but interface says `Promise<void>`. Update the interface return type to match the actual return.

**lib/hooks/useWakeLock.ts** -- Fix 2 errors:
- Lines 75, 76: `() => Promise<boolean>` not assignable to `() => Promise<void>`. The `requestWakeLock` and `releaseWakeLock` functions return boolean but interface says void. Update the return type interface to `Promise<boolean>`.

**lib/hooks/useGeofencing.ts** -- Fix 3 errors:
- Lines 111, 114: `This expression is not callable`. The `onLeaveHome`/`onArriveHome` callbacks are not properly typed. Read the hook options interface -- likely the callbacks are typed as `never` or undefined instead of `() => void`. Fix the options interface to type callbacks as `(() => void) | undefined` or similar.
- Line 128: `No overload matches this call`. Likely a `setInterval` or `setTimeout` with wrong argument types. Read the code context -- may need to fix the callback signature or argument types.

**lib/hooks/useRoomStatus.ts** -- Fix 1 error:
- Line 54: `'refetch' does not exist in type`. The return type interface doesn't include `refetch`. Add `refetch: () => Promise<void>` to the return type interface. Or if the interface uses `fetchRooms`, rename the returned property to match.

**lib/hlsDownloader.ts** -- Fix 4 errors (lines 84, 128, 148, 158):
- `Expected 0 arguments, but got 2`. A function is being called with 2 arguments but its signature accepts 0. Read the function definition -- it's likely a callback or event handler that needs parameters added to its signature. The function being called is probably `muxer.push()` or similar from the mux.js library. Check the actual function being called and fix its type declaration or the call site. If it's a third-party library type issue, use `(fn as any)(arg1, arg2)` or declare the correct overload.

**lib/pwa/periodicSync.ts** -- Fix 1 error:
- Line 68: `Conversion of '{ name: "periodic-background-sync" }' to 'PermissionDescriptor' may be a mistake`. The `periodic-background-sync` permission is experimental and not in standard PermissionDescriptor. Fix: `{ name: 'periodic-background-sync' } as unknown as PermissionDescriptor`.

**lib/repositories/base/BaseRepository.ts** -- Fix 1 error:
- Line 32: `Type 'unknown' is not assignable to type 'T'`. The generic repository returns `unknown` from Firebase but needs to return `T`. Fix: `return data as T`. This is expected -- the repository trusts the data shape from Firebase matches the generic type.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/(commands/|hooks/|hlsDownloader|pwa/periodicSync|repositories/)" | wc -l`
Expected: 0
  </verify>
  <done>All Promise return type mismatches in hooks resolved. Device commands use proper void callbacks. HLS downloader function signatures match call sites. BaseRepository properly casts to generic type T.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit 2>&1 | grep -E "^lib/(maintenance|netatmoApi|commands/|hooks/|hlsDownloader|pwa/periodicSync|repositories/)" | wc -l` -- should be 0.
</verification>

<success_criteria>
- 0 tsc errors for all 13 files modified by this plan
- MaintenanceData objects use `as unknown as Record<string, unknown>` for Firebase writes
- Netatmo API params use index signatures or double assertion
- All hook return type interfaces match actual implementation return types
- Device command callbacks properly handle Promise<unknown> vs Promise<void>
- HLS downloader calls match function signatures
- No behavior changes -- only type annotations and return types updated
</success_criteria>

<output>
After completion, create `.planning/phases/38-library-migration/38-13-SUMMARY.md`
</output>
