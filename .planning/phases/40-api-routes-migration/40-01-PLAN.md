---
phase: 40-api-routes-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/stove/status/route.ts
  - app/api/stove/ignite/route.ts
  - app/api/stove/shutdown/route.ts
  - app/api/stove/getFan/route.ts
  - app/api/stove/getPower/route.ts
  - app/api/stove/getRoomTemperature/route.ts
  - app/api/stove/getActualWaterTemperature/route.ts
  - app/api/stove/getWaterSetTemperature/route.ts
  - app/api/stove/setFan/route.ts
  - app/api/stove/setPower/route.ts
  - app/api/stove/setWaterTemperature/route.ts
  - app/api/stove/setSettings/route.ts
  - app/api/stove/settings/route.ts
  - app/api/stove/sync-external-state/route.ts
autonomous: true

must_haves:
  truths:
    - "All 14 stove API route files have .ts extension with no .js remaining"
    - "Each route preserves exact existing behavior (no logic changes)"
    - "tsc --noEmit reports no new errors from stove routes"
  artifacts:
    - path: "app/api/stove/status/route.ts"
      provides: "Stove status GET endpoint"
      contains: "withAuthAndErrorHandler"
    - path: "app/api/stove/ignite/route.ts"
      provides: "Stove ignite POST endpoint"
      contains: "withAuthAndErrorHandler"
    - path: "app/api/stove/setSettings/route.ts"
      provides: "Stove settings POST endpoint"
      contains: "parseJson"
    - path: "app/api/stove/sync-external-state/route.ts"
      provides: "Stove external state sync endpoint"
      contains: "withAuthAndErrorHandler"
  key_links:
    - from: "app/api/stove/*/route.ts"
      to: "@/lib/core"
      via: "middleware wrappers"
      pattern: "import.*from.*@/lib/core"
    - from: "app/api/stove/*/route.ts"
      to: "@/lib/stoveApi"
      via: "service calls"
      pattern: "import.*from.*@/lib/stoveApi"
---

<objective>
Migrate all 14 Thermorossi stove API route files from JavaScript to TypeScript.

Purpose: Stove routes are the simplest domain (most are 13-32 lines, simple GET/POST wrappers around stoveApi service calls). Perfect first-batch validation of the migration pattern.
Output: 14 TypeScript route files with typed middleware usage, preserving exact behavior.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate simple stove GET routes (8 files)</name>
  <files>
    app/api/stove/status/route.ts
    app/api/stove/getFan/route.ts
    app/api/stove/getPower/route.ts
    app/api/stove/getRoomTemperature/route.ts
    app/api/stove/getActualWaterTemperature/route.ts
    app/api/stove/getWaterSetTemperature/route.ts
    app/api/stove/settings/route.ts
    app/api/stove/ignite/route.ts
  </files>
  <action>
For each file, use `git mv app/api/stove/X/route.js app/api/stove/X/route.ts` to preserve git history, then add TypeScript typing.

These are all simple routes (13-22 lines) that follow the pattern:
- Import from `@/lib/core` and `@/lib/stoveApi`
- Single GET or POST handler wrapped in `withAuthAndErrorHandler`
- Call service function, return `success(data)`

Migration steps per file:
1. `git mv route.js route.ts`
2. Read the JS content and confirm middleware wrapper pattern
3. Add types: middleware already provides type inference, so mostly just renaming
4. For routes that parse request body (ignite may have body), add typed body interface
5. For routes that access Firebase data via service, type-assert the response pragmatically
6. Do NOT change any logic, response shapes, or error handling
7. Use `.ts` extension (NOT `.tsx`)

Specific files:
- `status/route.ts`: Simple GET, ~13 lines, calls getStoveStatus()
- `getFan/route.ts`: Simple GET, ~13 lines
- `getPower/route.ts`: Simple GET, ~13 lines
- `getRoomTemperature/route.ts`: Simple GET, ~22 lines (may have temperature parsing)
- `getActualWaterTemperature/route.ts`: Simple GET, ~16 lines
- `getWaterSetTemperature/route.ts`: Simple GET, ~16 lines
- `settings/route.ts`: Simple GET, ~14 lines
- `ignite/route.ts`: POST, ~19 lines, may accept body params

Keep types inline. No shared type file needed for stove domain (routes are thin wrappers).
  </action>
  <verify>
Run: `find app/api/stove -name "route.js" | head -20` — should show only 6 remaining (task 2 files)
Run: `npx tsc --noEmit 2>&1 | grep "app/api/stove" | head -20` — check for stove-specific errors
  </verify>
  <done>8 stove route files renamed to .ts with proper TypeScript typing, git history preserved via git mv, no logic changes</done>
</task>

<task type="auto">
  <name>Task 2: Migrate stove SET and complex routes (6 files)</name>
  <files>
    app/api/stove/shutdown/route.ts
    app/api/stove/setFan/route.ts
    app/api/stove/setPower/route.ts
    app/api/stove/setWaterTemperature/route.ts
    app/api/stove/setSettings/route.ts
    app/api/stove/sync-external-state/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` then add TypeScript typing.

These routes are slightly more complex (19-32 lines) and involve POST with body parsing or multi-step operations:

- `shutdown/route.ts`: POST, ~19 lines, calls shutdownStove()
- `setFan/route.ts`: POST, ~27 lines, parses body for fan level, calls setFan()
- `setPower/route.ts`: POST, ~27 lines, parses body for power level
- `setWaterTemperature/route.ts`: POST, ~28 lines, parses body for temperature
- `setSettings/route.ts`: POST, ~21 lines, parses body for settings object
- `sync-external-state/route.ts`: POST, ~32 lines, syncs external state

Migration pattern for POST routes with body:
1. `git mv route.js route.ts`
2. Add typed body interface inline (e.g., `interface SetFanBody { level: number }`)
3. Use `parseJsonOrThrow<SetFanBody>(request)` or `parseJson<SetFanBody>(request)` matching existing pattern
4. If route uses `validateRequired`, `validateRange`, etc. — keep as-is (already typed in lib/core)
5. Do NOT change validation logic or response shapes

For `sync-external-state`: may have more complex body — type pragmatically with `Record<string, unknown>` if structure is loose.
  </action>
  <verify>
Run: `find app/api/stove -name "route.js"` — should return empty (all 14 migrated)
Run: `npx tsc --noEmit 2>&1 | grep "app/api/stove" | head -20` — check for errors
Run: `git status app/api/stove/` — should show 14 renamed files
  </verify>
  <done>All 14 stove API route files migrated to TypeScript. Zero .js route files remaining in app/api/stove/. Git history preserved.</done>
</task>

</tasks>

<verification>
1. `find app/api/stove -name "route.js" -type f` returns empty
2. `find app/api/stove -name "route.ts" -type f | wc -l` returns 14
3. `npx tsc --noEmit 2>&1 | grep "app/api/stove"` shows no errors (or only pre-existing ones)
4. `git log --oneline --diff-filter=R -- app/api/stove/` shows renames
</verification>

<success_criteria>
- All 14 stove route files have .ts extension
- Each route uses lib/core middleware with proper TypeScript inference
- POST routes have typed body interfaces
- No logic changes from JS originals
- Git history preserved via git mv
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-01-SUMMARY.md`
</output>
