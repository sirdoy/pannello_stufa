---
phase: 40-api-routes-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/netatmo/callback/route.ts
  - app/api/netatmo/calibrate/route.ts
  - app/api/netatmo/camera/route.ts
  - app/api/netatmo/camera/events/route.ts
  - app/api/netatmo/camera/[cameraId]/events/route.ts
  - app/api/netatmo/camera/[cameraId]/snapshot/route.ts
  - app/api/netatmo/debug/route.ts
  - app/api/netatmo/devices/route.ts
  - app/api/netatmo/devices-temperatures/route.ts
  - app/api/netatmo/disconnect/route.ts
  - app/api/netatmo/homesdata/route.ts
  - app/api/netatmo/homestatus/route.ts
  - app/api/netatmo/schedules/route.ts
  - app/api/netatmo/setroomthermpoint/route.ts
  - app/api/netatmo/setthermmode/route.ts
  - app/api/netatmo/stove-sync/route.ts
  - app/api/netatmo/temperature/route.ts
autonomous: true

must_haves:
  truths:
    - "All 16 netatmo API route files have .ts extension with no .js remaining (excluding test files)"
    - "OAuth callback route preserves exact redirect behavior"
    - "Dynamic camera routes have typed params with Promise<{ cameraId: string }>"
    - "tsc --noEmit reports no new errors from netatmo routes"
  artifacts:
    - path: "app/api/netatmo/callback/route.ts"
      provides: "Netatmo OAuth callback endpoint"
      contains: "withErrorHandler"
    - path: "app/api/netatmo/camera/[cameraId]/events/route.ts"
      provides: "Camera events with dynamic param"
      contains: "getPathParam"
    - path: "app/api/netatmo/homestatus/route.ts"
      provides: "Netatmo home status endpoint"
      contains: "withAuthAndErrorHandler"
    - path: "app/api/netatmo/setroomthermpoint/route.ts"
      provides: "Thermostat set point endpoint"
      contains: "parseJson"
  key_links:
    - from: "app/api/netatmo/*/route.ts"
      to: "@/lib/core"
      via: "middleware wrappers"
      pattern: "import.*from.*@/lib/core"
    - from: "app/api/netatmo/*/route.ts"
      to: "@/lib/netatmoApi"
      via: "Netatmo API calls"
      pattern: "import.*from.*@/lib/netatmo"
---

<objective>
Migrate all 16 Netatmo API route files from JavaScript to TypeScript.

Purpose: Netatmo domain includes OAuth callbacks (no auth middleware), dynamic camera routes (typed params), thermostat controls (POST with body), and data endpoints. Covers all 5 migration patterns identified in research.
Output: 16 TypeScript route files preserving exact behavior, with typed params, bodies, and pragmatic external API response typing.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate simple Netatmo GET routes and OAuth callback (9 files)</name>
  <files>
    app/api/netatmo/callback/route.ts
    app/api/netatmo/debug/route.ts
    app/api/netatmo/devices/route.ts
    app/api/netatmo/devices-temperatures/route.ts
    app/api/netatmo/disconnect/route.ts
    app/api/netatmo/homesdata/route.ts
    app/api/netatmo/homestatus/route.ts
    app/api/netatmo/temperature/route.ts
    app/api/netatmo/schedules/route.ts
  </files>
  <action>
For each file, use `git mv app/api/netatmo/X/route.js app/api/netatmo/X/route.ts` to preserve git history, then add TypeScript typing.

Key patterns by file:

**OAuth callback (special — uses withErrorHandler, NOT withAuthAndErrorHandler):**
- `callback/route.ts` (~58 lines): OAuth flow with external API call. Uses `withErrorHandler` (no auth). Type the Netatmo token response inline: `interface NetatmoTokenResponse { error?: string; error_description?: string; refresh_token?: string; }`. Use `as NetatmoTokenResponse` on json parse.

**Simple GET routes (withAuthAndErrorHandler):**
- `debug/route.ts` (~71 lines): Debug info, may have multiple data fetches. Type Firebase returns pragmatically.
- `devices/route.ts` (~15 lines): Simple GET, thin wrapper
- `devices-temperatures/route.ts` (~40 lines): Returns temperature data
- `disconnect/route.ts` (~22 lines): Clears Netatmo tokens
- `homesdata/route.ts` (~52 lines): Returns home data structure
- `homestatus/route.ts` (~117 lines): Complex — fetches home status, transforms data. Type pragmatically.
- `temperature/route.ts` (~60 lines): Returns temperature readings
- `schedules/route.ts` (~159 lines): Complex — GET schedules list + POST create/update. NOTE: this file may already have some TS-like patterns (check git status — it shows as modified). Migrate fully to .ts.

IMPORTANT for `schedules/route.ts`: Git status shows this file is modified. Read it first to check current state before migration. If it already has TypeScript-like content, just do `git mv` and adjust as needed.

For external API responses (Netatmo data), use pragmatic typing:
- Type only fields actively used in the route
- Use `as { fieldName: type } | null` for Firebase returns
- Use optional chaining for nested access
  </action>
  <verify>
Run: `find app/api/netatmo -name "route.js" | head -20` — should show only 7 remaining (task 2 files + test files don't count)
Run: `npx tsc --noEmit 2>&1 | grep "app/api/netatmo" | head -20` — check for netatmo-specific errors
  </verify>
  <done>9 netatmo route files migrated to TypeScript with proper typing. OAuth callback uses withErrorHandler pattern. Schedules route handles both GET and POST.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Netatmo camera, thermostat control, and complex routes (7 files)</name>
  <files>
    app/api/netatmo/camera/route.ts
    app/api/netatmo/camera/events/route.ts
    app/api/netatmo/camera/[cameraId]/events/route.ts
    app/api/netatmo/camera/[cameraId]/snapshot/route.ts
    app/api/netatmo/calibrate/route.ts
    app/api/netatmo/setroomthermpoint/route.ts
    app/api/netatmo/setthermmode/route.ts
    app/api/netatmo/stove-sync/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` then add TypeScript typing.

**Dynamic camera routes (CRITICAL — params is Promise in Next.js 15+):**
- `camera/[cameraId]/events/route.ts` (~49 lines): Dynamic param route. Add `interface RouteContext { params: Promise<{ cameraId: string }> }`. Use `await getPathParam(context, 'cameraId')` or `const { cameraId } = await context.params`.
- `camera/[cameraId]/snapshot/route.ts` (~53 lines): Same dynamic param pattern.

**Static camera routes:**
- `camera/route.ts` (~58 lines): Lists cameras
- `camera/events/route.ts` (~70 lines): All camera events

**Thermostat control POST routes:**
- `setroomthermpoint/route.ts` (~94 lines): POST with body for room temperature set point. Add body interface: `interface SetRoomThermPointBody { room_id: string; mode: string; temp?: number; endtime?: number; }` (check actual fields used). NOTE: has test file in __tests__/ that stays as .js — test import should auto-resolve.
- `setthermmode/route.ts` (~82 lines): POST with body for thermostat mode. Add body interface similarly. NOTE: also has test file that stays as .js.

**Complex routes:**
- `calibrate/route.ts` (~147 lines): Calibration logic, may have helper functions. Type pragmatically, use inline interfaces for any complex bodies.
- `stove-sync/route.ts` (~159 lines): Stove-Netatmo sync logic. Type Firebase data pragmatically with `as { field: type } | null`.

For all dynamic param routes, follow this exact pattern:
```typescript
interface RouteContext {
  params: Promise<{ cameraId: string }>;
}

export const GET = withAuthAndErrorHandler(async (request, context: RouteContext) => {
  const cameraId = await getPathParam(context, 'cameraId');
  // ...
}, 'Netatmo/Camera/Events');
```
  </action>
  <verify>
Run: `find app/api/netatmo -name "route.js" -not -path "*__tests__*"` — should return empty
Run: `find app/api/netatmo -name "route.ts" -type f | wc -l` — should be 16 (all migrated, excluding test files)
Run: `npx tsc --noEmit 2>&1 | grep "app/api/netatmo" | head -20` — check for errors
  </verify>
  <done>All 16 netatmo route files migrated to TypeScript. Dynamic camera routes have typed Promise params. Thermostat control routes have typed request bodies. Test files remain as .js (deferred to Phase 42). No logic changes.</done>
</task>

</tasks>

<verification>
1. `find app/api/netatmo -name "route.js" -not -path "*__tests__*" -type f` returns empty
2. `find app/api/netatmo -name "route.ts" -type f | wc -l` returns 16
3. `find app/api/netatmo -name "route.test.js" -type f | wc -l` returns 2 (deferred test files untouched)
4. `npx tsc --noEmit 2>&1 | grep "app/api/netatmo"` shows no errors
5. `git log --oneline --diff-filter=R -- app/api/netatmo/` shows renames
</verification>

<success_criteria>
- All 16 netatmo route files have .ts extension
- OAuth callback uses withErrorHandler (not withAuthAndErrorHandler)
- Dynamic camera routes type params as Promise<{ cameraId: string }>
- POST routes have typed body interfaces
- Test files in __tests__/ remain as .js (deferred)
- No logic changes from JS originals
- Git history preserved via git mv
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-02-SUMMARY.md`
</output>
