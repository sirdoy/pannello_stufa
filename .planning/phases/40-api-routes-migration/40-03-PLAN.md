---
phase: 40-api-routes-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/hue/callback/route.ts
  - app/api/hue/disconnect/route.ts
  - app/api/hue/discover/route.ts
  - app/api/hue/lights/route.ts
  - app/api/hue/lights/[id]/route.ts
  - app/api/hue/pair/route.ts
  - app/api/hue/rooms/route.ts
  - app/api/hue/rooms/[id]/route.ts
  - app/api/hue/scenes/route.ts
  - app/api/hue/scenes/create/route.ts
  - app/api/hue/scenes/[id]/route.ts
  - app/api/hue/scenes/[id]/activate/route.ts
  - app/api/hue/status/route.ts
  - app/api/hue/test/route.ts
  - app/api/hue/remote/authorize/route.ts
  - app/api/hue/remote/callback/route.ts
  - app/api/hue/remote/disconnect/route.ts
  - app/api/hue/remote/pair/route.ts
autonomous: true

must_haves:
  truths:
    - "All 18 Hue API route files have .ts extension with no .js remaining (excluding test files)"
    - "Dynamic routes ([id]) have typed params with Promise pattern"
    - "OAuth callback routes preserve exact redirect behavior"
    - "tsc --noEmit reports no new errors from hue routes"
  artifacts:
    - path: "app/api/hue/lights/[id]/route.ts"
      provides: "Individual light control with dynamic param"
      contains: "getPathParam"
    - path: "app/api/hue/remote/callback/route.ts"
      provides: "Hue remote OAuth callback"
      contains: "withErrorHandler"
    - path: "app/api/hue/scenes/[id]/route.ts"
      provides: "Scene CRUD with dynamic param"
      contains: "RouteContext"
    - path: "app/api/hue/remote/pair/route.ts"
      provides: "Hue remote pairing endpoint"
      contains: "withAuthAndErrorHandler"
  key_links:
    - from: "app/api/hue/*/route.ts"
      to: "@/lib/core"
      via: "middleware wrappers"
      pattern: "import.*from.*@/lib/core"
    - from: "app/api/hue/*/route.ts"
      to: "@/lib/hueApi"
      via: "Hue API calls"
      pattern: "import.*from.*@/lib/hue"
---

<objective>
Migrate all 18 Philips Hue API route files from JavaScript to TypeScript.

Purpose: Hue domain is the largest (18 files) with multiple dynamic routes ([id] params), OAuth flows (local + remote), and CRUD operations on lights/rooms/scenes. Covers Pattern 3 (dynamic params) and Pattern 4 (OAuth callback) extensively.
Output: 18 TypeScript route files with typed dynamic params, OAuth flows, and light/scene control bodies.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Hue simple routes, OAuth, and local endpoints (10 files)</name>
  <files>
    app/api/hue/callback/route.ts
    app/api/hue/disconnect/route.ts
    app/api/hue/discover/route.ts
    app/api/hue/lights/route.ts
    app/api/hue/pair/route.ts
    app/api/hue/rooms/route.ts
    app/api/hue/scenes/route.ts
    app/api/hue/scenes/create/route.ts
    app/api/hue/status/route.ts
    app/api/hue/test/route.ts
  </files>
  <action>
For each file, use `git mv app/api/hue/X/route.js app/api/hue/X/route.ts` to preserve git history, then add TypeScript typing.

**OAuth callback (uses withErrorHandler or redirect — no auth):**
- `callback/route.ts` (~7 lines): Very short, likely just a redirect. Preserve exactly.

**Simple GET routes:**
- `disconnect/route.ts` (~14 lines): Clears Hue connection
- `discover/route.ts` (~17 lines): Discovers Hue bridges. NOTE: has test file in __tests__/ that stays as .js.
- `lights/route.ts` (~26 lines): Lists all lights
- `rooms/route.ts` (~30 lines): Lists all rooms
- `scenes/route.ts` (~20 lines): Lists all scenes
- `status/route.ts` (~32 lines): Returns Hue connection status
- `test/route.ts` (~52 lines): Test endpoint for Hue API

**POST routes:**
- `pair/route.ts` (~59 lines): Hue bridge pairing flow. May have body parsing for bridge IP/username.
- `scenes/create/route.ts` (~77 lines): Creates new scene. Add body interface for scene creation params.

For all routes:
- Preserve exact middleware wrapper (withAuthAndErrorHandler or withErrorHandler)
- Type body interfaces inline
- For Hue API responses, type only fields used in the route (pragmatic)
- Use `as { field: type }` for service function returns if needed
  </action>
  <verify>
Run: `find app/api/hue -name "route.js" -not -path "*__tests__*" -not -path "*remote*" -not -path "*\[id\]*" | wc -l` — should be 0 for these paths
Run: `npx tsc --noEmit 2>&1 | grep "app/api/hue" | head -20`
  </verify>
  <done>10 Hue route files migrated to TypeScript. OAuth callback and simple GET routes typed. Scene creation has typed body interface.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate Hue dynamic param routes and remote OAuth (8 files)</name>
  <files>
    app/api/hue/lights/[id]/route.ts
    app/api/hue/rooms/[id]/route.ts
    app/api/hue/scenes/[id]/route.ts
    app/api/hue/scenes/[id]/activate/route.ts
    app/api/hue/remote/authorize/route.ts
    app/api/hue/remote/callback/route.ts
    app/api/hue/remote/disconnect/route.ts
    app/api/hue/remote/pair/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` then add TypeScript typing.

**Dynamic param routes (CRITICAL — params is Promise in Next.js 15+):**

For ALL [id] routes, add this context type:
```typescript
interface RouteContext {
  params: Promise<{ id: string }>;
}
```

- `lights/[id]/route.ts` (~71 lines): GET + PUT for individual light. Multiple HTTP methods share RouteContext. PUT has body for light state (brightness, color, on/off).
- `rooms/[id]/route.ts` (~71 lines): GET + PUT for individual room. PUT has body for room state.
- `scenes/[id]/route.ts` (~148 lines): GET + PUT + DELETE for scene CRUD. Most complex — has body for scene updates.
- `scenes/[id]/activate/route.ts` (~44 lines): POST to activate scene. Simple dynamic param route.

**Remote OAuth routes (Hue cloud API):**
- `remote/authorize/route.ts` (~75 lines): Initiates OAuth flow for Hue cloud
- `remote/callback/route.ts` (~119 lines): OAuth callback — uses withErrorHandler (no auth). Type external token response pragmatically.
- `remote/disconnect/route.ts` (~24 lines): Disconnects remote Hue
- `remote/pair/route.ts` (~177 lines): Complex pairing flow. Largest Hue route. Type pragmatically, use inline interfaces for bodies and responses.

For dynamic param access, use `getPathParam(context, 'id')` if available, or `const { id } = await context.params`.

For PUT/POST body types, create inline interfaces:
```typescript
interface UpdateLightBody {
  on?: boolean;
  brightness?: number;
  color?: { x: number; y: number } | null;
}
```

For remote OAuth, type external responses pragmatically:
```typescript
const json = await res.json() as { access_token?: string; error?: string };
```
  </action>
  <verify>
Run: `find app/api/hue -name "route.js" -not -path "*__tests__*" -type f` — should return empty
Run: `find app/api/hue -name "route.ts" -type f | wc -l` — should be 18
Run: `npx tsc --noEmit 2>&1 | grep "app/api/hue" | head -20`
  </verify>
  <done>All 18 Hue route files migrated to TypeScript. Dynamic routes have typed Promise params. OAuth callbacks use withErrorHandler. Test file in __tests__/ untouched. No logic changes.</done>
</task>

</tasks>

<verification>
1. `find app/api/hue -name "route.js" -not -path "*__tests__*" -type f` returns empty
2. `find app/api/hue -name "route.ts" -type f | wc -l` returns 18
3. `find app/api/hue -name "route.test.js" -type f | wc -l` returns 1 (deferred test file untouched)
4. `npx tsc --noEmit 2>&1 | grep "app/api/hue"` shows no errors
5. Dynamic routes contain `Promise<{ id: string }>` pattern
</verification>

<success_criteria>
- All 18 Hue route files have .ts extension
- Dynamic routes ([id]) type params as Promise<{ id: string }>
- OAuth callbacks use withErrorHandler (not withAuthAndErrorHandler)
- PUT/POST routes have typed body interfaces
- Remote OAuth flows type external responses pragmatically
- Test file in __tests__/ remains as .js
- No logic changes, git history preserved
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-03-SUMMARY.md`
</output>
