---
phase: 40-api-routes-migration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/notifications/check-rate/route.ts
  - app/api/notifications/cleanup/route.ts
  - app/api/notifications/devices/route.ts
  - app/api/notifications/devices/[tokenKey]/route.ts
  - app/api/notifications/errors/route.ts
  - app/api/notifications/history/route.ts
  - app/api/notifications/preferences/route.ts
  - app/api/notifications/preferences-v2/route.ts
  - app/api/notifications/register/route.ts
  - app/api/notifications/send/route.ts
  - app/api/notifications/stats/route.ts
  - app/api/notifications/test/route.ts
  - app/api/notifications/trends/route.ts
  - app/api/notifications/trigger/route.ts
  - app/api/notifications/unregister/route.ts
autonomous: true

must_haves:
  truths:
    - "All 15 notification API route files have .ts extension with no .js remaining"
    - "Dynamic [tokenKey] route has typed params with Promise pattern"
    - "POST routes for register/send/trigger have typed body interfaces"
    - "tsc --noEmit reports no new errors from notification routes"
  artifacts:
    - path: "app/api/notifications/register/route.ts"
      provides: "Push notification registration endpoint"
      contains: "parseJson"
    - path: "app/api/notifications/send/route.ts"
      provides: "Notification send endpoint"
      contains: "parseJsonOrThrow"
    - path: "app/api/notifications/devices/[tokenKey]/route.ts"
      provides: "Device management with dynamic param"
      contains: "getPathParam"
    - path: "app/api/notifications/cleanup/route.ts"
      provides: "Notification cleanup cron endpoint"
      contains: "withCronSecret"
  key_links:
    - from: "app/api/notifications/*/route.ts"
      to: "@/lib/core"
      via: "middleware wrappers"
      pattern: "import.*from.*@/lib/core"
    - from: "app/api/notifications/*/route.ts"
      to: "@/lib/firebaseAdmin"
      via: "Firebase messaging and database"
      pattern: "import.*from.*@/lib/firebaseAdmin"
---

<objective>
Migrate all 15 notification API route files from JavaScript to TypeScript.

Purpose: Notifications domain covers push registration, sending, device management, preferences, history, stats, and cleanup cron jobs. Includes the dynamic [tokenKey] route and both auth-protected and cron-secret-protected endpoints.
Output: 15 TypeScript route files with typed bodies for registration/send/trigger, typed dynamic params, and proper middleware signatures.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate notification data and management routes (8 files)</name>
  <files>
    app/api/notifications/devices/route.ts
    app/api/notifications/devices/[tokenKey]/route.ts
    app/api/notifications/errors/route.ts
    app/api/notifications/history/route.ts
    app/api/notifications/preferences/route.ts
    app/api/notifications/preferences-v2/route.ts
    app/api/notifications/stats/route.ts
    app/api/notifications/trends/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` to preserve git history, then add TypeScript typing.

**Dynamic param route:**
- `devices/[tokenKey]/route.ts` (~103 lines): GET + PUT + DELETE for individual device. Add:
```typescript
interface RouteContext {
  params: Promise<{ tokenKey: string }>;
}
```
Multiple HTTP methods share RouteContext. PUT likely has body for device metadata updates.

**Data listing routes (GET, possibly with query params):**
- `devices/route.ts` (~77 lines): Lists registered devices. May use searchParams for filtering.
- `errors/route.ts` (~156 lines): Lists notification errors. Complex — likely has pagination, filtering.
- `history/route.ts` (~117 lines): Notification history with pagination.
- `stats/route.ts` (~156 lines): Notification statistics aggregation.
- `trends/route.ts` (~142 lines): Notification trends data.

**Preferences routes (GET + PUT/POST):**
- `preferences/route.ts` (~112 lines): GET/POST notification preferences. Type body for preference updates.
- `preferences-v2/route.ts` (~67 lines): Updated preferences API.

For complex data routes (errors, history, stats, trends):
- Type Firebase data returns pragmatically: `as Record<string, unknown> | null`
- Type query params only if explicitly used: `request.nextUrl.searchParams.get('page')`
- These routes may have helper functions — type their params and returns inline
- Do NOT refactor pagination or filtering logic
  </action>
  <verify>
Run: `find app/api/notifications -name "route.js" | wc -l` — should show 7 remaining (task 2 files)
Run: `npx tsc --noEmit 2>&1 | grep "app/api/notifications" | head -20`
  </verify>
  <done>8 notification route files migrated. Dynamic [tokenKey] route has typed Promise params. Data routes use pragmatic typing for Firebase returns.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate notification action and cron routes (7 files)</name>
  <files>
    app/api/notifications/check-rate/route.ts
    app/api/notifications/cleanup/route.ts
    app/api/notifications/register/route.ts
    app/api/notifications/send/route.ts
    app/api/notifications/test/route.ts
    app/api/notifications/trigger/route.ts
    app/api/notifications/unregister/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` then add TypeScript typing.

**Cron-protected routes (use withCronSecret):**
- `check-rate/route.ts` (~169 lines): Rate checking cron. Complex — may have helper functions. Uses `withCronSecret` middleware.
- `cleanup/route.ts` (~167 lines): Cleanup cron. Complex — batch operations. Uses `withCronSecret`.

**POST routes with body parsing:**
- `register/route.ts` (~123 lines): Register push subscription. Add body interface:
```typescript
interface RegisterBody {
  subscription: {
    endpoint: string;
    keys: { p256dh: string; auth: string };
  };
  deviceName?: string;
  // ... check actual fields used
}
```
- `send/route.ts` (~75 lines): Send notification. Add body interface for notification payload (see research Pattern 2 example).
- `trigger/route.ts` (~78 lines): Trigger notification. Similar body parsing.
- `unregister/route.ts` (~33 lines): Unregister device. Simple body with token/subscription.

**Test route:**
- `test/route.ts` (~159 lines): Test notification sending. May have complex body or query params.

For cron routes (check-rate, cleanup):
- These use `withCronSecret` which provides `(request, context)` — no session param
- May have long helper functions — type params and returns inline
- Firebase batch operations: type pragmatically

For POST body interfaces:
- Read the actual JS file to determine exact body fields used
- Type only fields that are actually accessed (not the full possible shape)
- Use optional (?) for fields that may not always be present
  </action>
  <verify>
Run: `find app/api/notifications -name "route.js" -type f` — should return empty
Run: `find app/api/notifications -name "route.ts" -type f | wc -l` — should be 15
Run: `npx tsc --noEmit 2>&1 | grep "app/api/notifications" | head -20`
  </verify>
  <done>All 15 notification route files migrated to TypeScript. Cron routes use withCronSecret. POST routes have typed body interfaces. No logic changes.</done>
</task>

</tasks>

<verification>
1. `find app/api/notifications -name "route.js" -type f` returns empty
2. `find app/api/notifications -name "route.ts" -type f | wc -l` returns 15
3. `npx tsc --noEmit 2>&1 | grep "app/api/notifications"` shows no errors
4. Dynamic [tokenKey] route contains `Promise<{ tokenKey: string }>` pattern
</verification>

<success_criteria>
- All 15 notification route files have .ts extension
- Dynamic [tokenKey] route types params as Promise
- Cron routes use withCronSecret (not withAuthAndErrorHandler)
- POST routes have typed body interfaces
- No logic changes, git history preserved
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-04-SUMMARY.md`
</output>
