---
phase: 40-api-routes-migration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/health/route.ts
  - app/api/health-monitoring/check/route.ts
  - app/api/health-monitoring/dead-man-switch/route.ts
  - app/api/health-monitoring/logs/route.ts
  - app/api/health-monitoring/stats/route.ts
  - app/api/scheduler/check/route.ts
  - app/api/scheduler/update/route.ts
  - app/api/schedules/route.ts
  - app/api/schedules/active/route.ts
  - app/api/schedules/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "All 10 health/monitoring, scheduler, and schedules route files have .ts extension"
    - "scheduler/check (994 lines) is migrated with pragmatic typing — no logic changes"
    - "Dynamic schedules/[id] route has typed params with Promise pattern"
    - "Cron routes use withCronSecret middleware"
    - "tsc --noEmit reports no new errors from these routes"
  artifacts:
    - path: "app/api/scheduler/check/route.ts"
      provides: "Main scheduler cron handler (largest route)"
      contains: "withCronSecret"
    - path: "app/api/schedules/[id]/route.ts"
      provides: "Schedule CRUD with dynamic param"
      contains: "getPathParam"
    - path: "app/api/health-monitoring/check/route.ts"
      provides: "Health monitoring cron"
      contains: "withCronSecret"
    - path: "app/api/health/route.ts"
      provides: "Basic health check endpoint"
      contains: "success"
  key_links:
    - from: "app/api/scheduler/check/route.ts"
      to: "@/lib/core"
      via: "withCronSecret middleware"
      pattern: "withCronSecret"
    - from: "app/api/schedules/*/route.ts"
      to: "@/lib/firebaseAdmin"
      via: "Firebase schedule data"
      pattern: "adminDbGet|adminDbSet"
---

<objective>
Migrate all 10 health/monitoring, scheduler, and schedules API route files from JavaScript to TypeScript.

Purpose: This domain includes the largest route file (scheduler/check at 994 lines), cron-protected endpoints, and schedule CRUD operations with dynamic params. The scheduler/check route needs careful pragmatic typing given its size.
Output: 10 TypeScript route files with typed cron middleware, dynamic params, and pragmatic typing for the large scheduler route.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate health, monitoring, and schedule CRUD routes (7 files)</name>
  <files>
    app/api/health/route.ts
    app/api/health-monitoring/check/route.ts
    app/api/health-monitoring/dead-man-switch/route.ts
    app/api/health-monitoring/logs/route.ts
    app/api/health-monitoring/stats/route.ts
    app/api/schedules/route.ts
    app/api/schedules/active/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` to preserve git history, then add TypeScript typing.

**Simple health check:**
- `health/route.ts` (~29 lines): Basic health endpoint. Likely returns status + version info.

**Health monitoring routes (cron-protected):**
- `health-monitoring/check/route.ts` (~158 lines): Health check cron. Uses `withCronSecret`. May check multiple system components. Type Firebase data pragmatically.
- `health-monitoring/dead-man-switch/route.ts` (~65 lines): Dead man switch cron. Uses `withCronSecret`.
- `health-monitoring/logs/route.ts` (~149 lines): Health logs listing. May have pagination and query params.
- `health-monitoring/stats/route.ts` (~64 lines): Health statistics aggregation.

**Schedule CRUD routes:**
- `schedules/route.ts` (~139 lines): GET list + POST create. Add body interface for schedule creation:
```typescript
interface CreateScheduleBody {
  name: string;
  slots: Record<string, unknown>;
  enabled?: boolean;
}
```
- `schedules/active/route.ts` (~64 lines): GET/PUT active schedule. PUT body: `{ scheduleId: string }`.

For cron routes, use `withCronSecret` handler signature: `(request, context) => Promise<NextResponse>` — no session.

For health monitoring, type Firebase data returns as `as { field: type } | null`.
  </action>
  <verify>
Run: `find app/api/health app/api/health-monitoring app/api/schedules -name "route.js" -not -path "*\[id\]*" | wc -l` — should be 0
Run: `npx tsc --noEmit 2>&1 | grep -E "app/api/(health|schedules)" | head -20`
  </verify>
  <done>7 route files migrated. Health monitoring uses withCronSecret. Schedule CRUD has typed bodies. No logic changes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate scheduler cron routes and schedules/[id] (3 files)</name>
  <files>
    app/api/scheduler/check/route.ts
    app/api/scheduler/update/route.ts
    app/api/schedules/[id]/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` then add TypeScript typing.

**CRITICAL: scheduler/check/route.ts (~994 lines) — Largest route in the project**

This is the main scheduler cron handler. Migration strategy for large files:
1. `git mv route.js route.ts`
2. Type the "edges" (exports, middleware wrapper, helper function signatures) not every internal variable
3. Add inline interfaces for Firebase data used:
```typescript
interface SchedulerMode {
  enabled: boolean;
  semiManual?: boolean;
  returnToAutoAt?: string;
}

interface ScheduleSlot {
  startTime: string;
  endTime: string;
  // ... only fields actually accessed
}
```
4. Type helper function parameters and return types explicitly
5. Use pragmatic `as { field: type } | null` for all `adminDbGet()` calls
6. Use pragmatic `any` for deeply nested scheduler logic where full typing would be excessive
7. Do NOT refactor any logic — pure type annotation migration
8. The file may have 10+ helper functions — type each one's params and return

**scheduler/update/route.ts (~85 lines):** POST for scheduler mode updates. Simpler. Add body interface.

**schedules/[id]/route.ts (~120 lines):** GET + PUT + DELETE for individual schedule. Dynamic param route:
```typescript
interface RouteContext {
  params: Promise<{ id: string }>;
}
```
This is a well-documented pattern — see research Example 3 for exact code.
  </action>
  <verify>
Run: `find app/api/scheduler app/api/schedules -name "route.js" -type f` — should return empty
Run: `find app/api/scheduler app/api/schedules -name "route.ts" -type f | wc -l` — should be 5 (2 scheduler + 3 schedules)
Run: `npx tsc --noEmit 2>&1 | grep -E "app/api/(scheduler|schedules)" | head -30` — check for errors (may have some in the 994-line file)
  </verify>
  <done>All 10 health/monitoring, scheduler, and schedules route files migrated. scheduler/check (994 lines) typed pragmatically. schedules/[id] has typed Promise params with GET/PUT/DELETE. No logic changes.</done>
</task>

</tasks>

<verification>
1. `find app/api/health app/api/health-monitoring app/api/scheduler app/api/schedules -name "route.js" -type f` returns empty
2. `find app/api/health app/api/health-monitoring app/api/scheduler app/api/schedules -name "route.ts" -type f | wc -l` returns 10
3. `wc -l app/api/scheduler/check/route.ts` shows ~994 lines (size preserved)
4. `npx tsc --noEmit 2>&1 | grep -E "app/api/(health|scheduler|schedules)"` shows minimal errors
</verification>

<success_criteria>
- All 10 route files have .ts extension
- scheduler/check (994 lines) migrated with pragmatic typing
- Cron routes use withCronSecret
- schedules/[id] has typed Promise params for GET/PUT/DELETE
- No logic changes, git history preserved
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-05-SUMMARY.md`
</output>
