---
phase: 40-api-routes-migration
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/admin/sync-changelog/route.ts
  - app/api/config/dashboard/route.ts
  - app/api/config/location/route.ts
  - app/api/coordination/enforce/route.ts
  - app/api/devices/config/route.ts
  - app/api/devices/preferences/route.ts
  - app/api/errors/log/route.ts
  - app/api/errors/resolve/route.ts
  - app/api/geocoding/reverse/route.ts
  - app/api/geocoding/search/route.ts
  - app/api/log/add/route.ts
  - app/api/maintenance/confirm-cleaning/route.ts
  - app/api/maintenance/update-target/route.ts
  - app/api/user/route.ts
  - app/api/user/theme/route.ts
  - app/api/weather/forecast/route.ts
autonomous: true

must_haves:
  truths:
    - "All 16 miscellaneous API route files have .ts extension with no .js remaining"
    - "coordination/enforce (235 lines) and geocoding/reverse (240 lines) are migrated with pragmatic typing"
    - "POST routes have typed body interfaces"
    - "tsc --noEmit reports no new errors from these routes"
  artifacts:
    - path: "app/api/coordination/enforce/route.ts"
      provides: "Device coordination enforcement endpoint"
      contains: "withCronSecret"
    - path: "app/api/config/dashboard/route.ts"
      provides: "Dashboard config GET/PUT endpoint"
      contains: "withAuthAndErrorHandler"
    - path: "app/api/geocoding/reverse/route.ts"
      provides: "Reverse geocoding endpoint"
      contains: "withAuthAndErrorHandler"
    - path: "app/api/weather/forecast/route.ts"
      provides: "Weather forecast endpoint"
      contains: "withAuthAndErrorHandler"
  key_links:
    - from: "app/api/*/route.ts"
      to: "@/lib/core"
      via: "middleware wrappers"
      pattern: "import.*from.*@/lib/core"
    - from: "app/api/config/*/route.ts"
      to: "@/lib/firebaseAdmin"
      via: "Firebase config data"
      pattern: "adminDbGet|adminDbSet"
---

<objective>
Migrate all 16 remaining miscellaneous API route files from JavaScript to TypeScript.

Purpose: Covers admin, config, coordination, devices, errors, geocoding, log, maintenance, user, and weather domains. These are independent routes with no cross-domain dependencies. Includes two larger files (coordination/enforce at 235 lines, geocoding/reverse at 240 lines).
Output: 16 TypeScript route files completing the full API routes migration, with typed bodies and pragmatic Firebase typing.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate admin, config, devices, errors, and log routes (9 files)</name>
  <files>
    app/api/admin/sync-changelog/route.ts
    app/api/config/dashboard/route.ts
    app/api/config/location/route.ts
    app/api/devices/config/route.ts
    app/api/devices/preferences/route.ts
    app/api/errors/log/route.ts
    app/api/errors/resolve/route.ts
    app/api/log/add/route.ts
    app/api/user/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` to preserve git history, then add TypeScript typing.

**Admin routes:**
- `admin/sync-changelog/route.ts` (~113 lines): Syncs changelog data. May use withAuthAndErrorHandler or withCronSecret. Type pragmatically.

**Config routes (GET + PUT):**
- `config/dashboard/route.ts` (~109 lines): Dashboard config CRUD. Add body interface for PUT:
```typescript
interface DashboardConfig {
  layout?: Record<string, unknown>;
  widgets?: Record<string, unknown>;
  // ... check actual fields
}
```
- `config/location/route.ts` (~94 lines): Location config. GET + PUT with location data body.

**Devices routes:**
- `devices/config/route.ts` (~115 lines): Device configuration CRUD. Add body interface for updates.
- `devices/preferences/route.ts` (~102 lines): Device preferences CRUD.

**Error tracking routes:**
- `errors/log/route.ts` (~67 lines): Log error. POST with error body.
- `errors/resolve/route.ts` (~69 lines): Resolve error. POST/PUT with resolution data.

**Logging route:**
- `log/add/route.ts` (~39 lines): Add log entry. POST with log body.

**User route:**
- `user/route.ts` (~10 lines): Very short — likely returns user info from session.

For all POST/PUT routes, read the JS file to determine actual body fields, then create inline interfaces. Type only fields actively destructured or accessed.
  </action>
  <verify>
Run: `find app/api/admin app/api/config app/api/devices app/api/errors app/api/log app/api/user -name "route.js" -not -path "*theme*" | wc -l` — should be 0
Run: `npx tsc --noEmit 2>&1 | grep -E "app/api/(admin|config|devices|errors|log|user)" | head -20`
  </verify>
  <done>9 miscellaneous route files migrated. Config routes have typed body interfaces. Error tracking and logging routes typed. User route migrated.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate coordination, geocoding, maintenance, user/theme, and weather routes (7 files)</name>
  <files>
    app/api/coordination/enforce/route.ts
    app/api/geocoding/reverse/route.ts
    app/api/geocoding/search/route.ts
    app/api/maintenance/confirm-cleaning/route.ts
    app/api/maintenance/update-target/route.ts
    app/api/user/theme/route.ts
    app/api/weather/forecast/route.ts
  </files>
  <action>
For each file, use `git mv route.js route.ts` then add TypeScript typing.

**Complex routes (200+ lines):**
- `coordination/enforce/route.ts` (~235 lines): Coordination enforcement cron. Uses `withCronSecret`. Has multiple helper functions and Firebase operations. Strategy:
  1. Type helper function signatures (params + return types)
  2. Use `as { field: type } | null` for all adminDbGet calls
  3. Use pragmatic any for deeply nested coordination logic
  4. Do NOT refactor — pure type annotation

- `geocoding/reverse/route.ts` (~240 lines): Reverse geocoding. May call external geocoding API. Type external responses pragmatically:
```typescript
const data = await res.json() as {
  results?: Array<{ formatted_address?: string; geometry?: { lat: number; lng: number } }>;
  error_message?: string;
};
```

**Medium routes:**
- `geocoding/search/route.ts` (~115 lines): Forward geocoding search. Similar external API pattern.

**Maintenance routes (POST):**
- `maintenance/confirm-cleaning/route.ts` (~81 lines): Confirm stove cleaning. POST with body.
- `maintenance/update-target/route.ts` (~70 lines): Update maintenance target. POST with body.

**User theme route (GET + PUT):**
- `user/theme/route.ts` (~74 lines): Theme preference. GET returns theme, PUT updates theme. Simple body: `{ theme: string }`.

**Weather route:**
- `weather/forecast/route.ts` (~154 lines): Weather forecast data. Calls OpenMeteo or similar. Type external weather API response pragmatically — only fields used.

For external API responses (geocoding, weather), use pragmatic typing:
- `as { results?: Array<...> }` for geocoding
- `as { hourly?: Record<string, number[]>; daily?: Record<string, unknown> }` for weather
- Do NOT fully type external APIs
  </action>
  <verify>
Run: `find app/api -name "route.js" -not -path "*__tests__*" -type f` — should return EMPTY (all 90 files migrated!)
Run: `find app/api -name "route.ts" -type f | wc -l` — should be 90
Run: `npx tsc --noEmit 2>&1 | grep "app/api" | wc -l` — count remaining errors
  </verify>
  <done>All 16 miscellaneous route files migrated. All 90 API route files now have .ts extension. Zero .js route files remaining (excluding test files). Phase migration complete pending gap closure.</done>
</task>

</tasks>

<verification>
1. `find app/api -name "route.js" -not -path "*__tests__*" -type f` returns EMPTY
2. `find app/api -name "route.ts" -type f | wc -l` returns 90
3. `find app/api -name "route.test.js" -type f | wc -l` returns 3 (deferred test files untouched)
4. `npx tsc --noEmit 2>&1 | grep "app/api"` — count errors for gap closure plan
</verification>

<success_criteria>
- All 16 remaining route files have .ts extension
- coordination/enforce and geocoding/reverse typed pragmatically despite size
- External API responses (geocoding, weather) typed pragmatically
- No logic changes, git history preserved
- Combined with plans 01-05: all 90 API route files migrated
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-06-SUMMARY.md`
</output>
