---
phase: 40-api-routes-migration
plan: 07
type: execute
wave: 2
depends_on: ["40-01", "40-02", "40-03", "40-04", "40-05", "40-06"]
files_modified: []
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "tsc --noEmit reports zero errors in app/api/ directory"
    - "All 90 route files have .ts extension, no .js route files remain (excluding test files)"
    - "npm test passes (no regressions from migration)"
  artifacts:
    - path: "app/api/**/*.ts"
      provides: "All 90 migrated route files"
      contains: "import.*from.*@/lib/core"
  key_links:
    - from: "app/api/**/*.ts"
      to: "@/lib/core"
      via: "middleware wrappers compile without errors"
      pattern: "withAuthAndErrorHandler|withErrorHandler|withCronSecret"
---

<objective>
Fix any TypeScript errors remaining after the Wave 1 migration of all 90 API route files.

Purpose: Based on Phase 38/39 experience, bulk migration produces cross-file type errors (typically 30-80 errors). This gap closure plan diagnoses and fixes all remaining tsc errors in app/api/ to reach zero errors. Per user decision, at least one gap closure wave is expected.
Output: Zero tsc errors in app/api/ directory. All route files compile cleanly.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/40-api-routes-migration/40-RESEARCH.md
@.planning/phases/40-api-routes-migration/40-01-SUMMARY.md
@.planning/phases/40-api-routes-migration/40-02-SUMMARY.md
@.planning/phases/40-api-routes-migration/40-03-SUMMARY.md
@.planning/phases/40-api-routes-migration/40-04-SUMMARY.md
@.planning/phases/40-api-routes-migration/40-05-SUMMARY.md
@.planning/phases/40-api-routes-migration/40-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose and categorize all tsc errors in app/api/</name>
  <files>
    (determined by error analysis)
  </files>
  <action>
Run `npx tsc --noEmit 2>&1 | grep "app/api"` to get the full error list.

Categorize errors into groups (based on Phase 38/39 experience):
1. **Missing type assertions** — adminDbGet() returns unknown, needs `as Type | null`
2. **Middleware signature mismatches** — handler params don't match middleware expectations
3. **Import resolution** — imports that need path or type adjustments
4. **Body parsing types** — parseJson/parseJsonOrThrow generic type issues
5. **Promise params** — context.params not awaited
6. **Implicit any** — variables that need explicit type annotations

For each error:
1. Read the error message and file location
2. Open the file and understand the issue
3. Apply the minimal fix (type assertion, param type, import fix)
4. Do NOT change logic — only fix type errors

Common fixes from Phase 38/39 experience:
- `adminDbGet('path')` needs `as { field: type } | null` or `as unknown`
- Handler `(request, context, session)` — session type comes from middleware
- `parseJsonOrThrow<T>()` — T must match actual body structure
- `context.params` — must await if accessing directly (use getPathParam helper instead)
- Callback types — `async () => { await fn(); }` wrapper for void returns

Fix all errors found. If error count is large (50+), prioritize by domain and fix in batches.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep "app/api" | wc -l` — should be 0
Run: `npx tsc --noEmit 2>&1 | grep "error TS" | wc -l` — check total project errors haven't increased
  </verify>
  <done>All tsc errors in app/api/ directory resolved. Zero type errors remaining for API routes.</done>
</task>

<task type="auto">
  <name>Task 2: Verify migration completeness and run tests</name>
  <files>
    (verification only — no file modifications expected)
  </files>
  <action>
Final verification of the complete Phase 40 migration:

1. **File count verification:**
   - `find app/api -name "route.js" -not -path "*__tests__*" -type f | wc -l` must be 0
   - `find app/api -name "route.ts" -type f | wc -l` must be 90
   - `find app/api -name "route.test.js" -type f | wc -l` must be 3 (deferred)

2. **Type check:**
   - `npx tsc --noEmit 2>&1 | grep "app/api"` must be empty
   - Count total project tsc errors — should not have increased from pre-migration baseline

3. **Test run:**
   - `npm test` — all existing tests must pass
   - If any test fails due to import path changes from .js to .ts, fix the import path

4. **Git history verification:**
   - `git log --oneline --diff-filter=R -- app/api/ | wc -l` — should show 90 renames

If any test files fail to resolve imports after .js -> .ts rename:
- Check if test uses explicit `.js` extension in import (unlikely with Next.js resolution)
- If so, the test file stays as .js per Phase 42 deferral — the import should auto-resolve to .ts
- If auto-resolution fails, add a note for Phase 42 but do NOT modify the .js test file

If errors remain that cannot be fixed without logic changes, document them as known issues in the summary.
  </action>
  <verify>
Run: `find app/api -name "route.js" -not -path "*__tests__*" -type f | wc -l` — must be 0
Run: `npx tsc --noEmit 2>&1 | grep "app/api" | wc -l` — must be 0
Run: `npm test 2>&1 | tail -5` — must show all tests passing
  </verify>
  <done>Phase 40 migration verified complete: 90/90 route files migrated, 0 tsc errors in app/api/, all tests passing, git history preserved for all renames.</done>
</task>

</tasks>

<verification>
1. `find app/api -name "route.js" -not -path "*__tests__*" -type f` returns empty — all 90 routes migrated
2. `find app/api -name "route.ts" -type f | wc -l` returns 90
3. `npx tsc --noEmit 2>&1 | grep "app/api" | wc -l` returns 0 — zero type errors
4. `npm test` passes — no regressions
5. `find app/api -name "route.test.js" -type f | wc -l` returns 3 — deferred test files untouched
</verification>

<success_criteria>
- Zero .js route files remaining in app/api/ (excluding __tests__/)
- Zero tsc errors in app/api/ directory
- All tests passing
- All 90 renames preserved in git history
- Phase 40 requirements met: API-01, API-02, API-03
</success_criteria>

<output>
After completion, create `.planning/phases/40-api-routes-migration/40-07-SUMMARY.md`
</output>
