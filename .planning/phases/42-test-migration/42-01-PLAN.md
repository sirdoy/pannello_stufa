---
phase: 42-test-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jest.config.ts
  - jest.setup.ts
  - __mocks__/next-server.ts
  - __mocks__/react-dom.ts
  - app/components/ui/__mocks__/Text.tsx
autonomous: true

must_haves:
  truths:
    - "Jest config loads as TypeScript and test discovery still works"
    - "jest.setup.ts runs before all tests with typed mocks"
    - "__mocks__ files work with TypeScript extensions"
    - "npm test can still find and execute existing .js tests"
  artifacts:
    - path: "jest.config.ts"
      provides: "TypeScript Jest configuration"
      contains: "import type"
    - path: "jest.setup.ts"
      provides: "Typed test setup with mock declarations"
      contains: "declare global"
    - path: "__mocks__/next-server.ts"
      provides: "Typed Next.js server mock"
    - path: "__mocks__/react-dom.ts"
      provides: "Typed react-dom portal mock"
    - path: "app/components/ui/__mocks__/Text.tsx"
      provides: "Typed Text component mock"
  key_links:
    - from: "jest.config.ts"
      to: "jest.setup.ts"
      via: "setupFilesAfterSetup reference"
      pattern: "setupFilesAfterEnv.*jest\\.setup\\.ts"
    - from: "jest.config.ts"
      to: "__mocks__/next-server.ts"
      via: "moduleNameMapper"
      pattern: "next-server\\.ts"
---

<objective>
Migrate Jest configuration, setup file, and mock files from JavaScript to TypeScript.

Purpose: Establishes TypeScript test infrastructure that all subsequent test file migrations depend on. The jest.config.ts and jest.setup.ts must work before any test files are renamed.
Output: 5 TypeScript config/mock files replacing their .js counterparts.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-test-migration/42-CONTEXT.md
@.planning/phases/42-test-migration/42-RESEARCH.md
@jest.config.js
@jest.setup.js
@__mocks__/next-server.js
@__mocks__/react-dom.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate jest.config.js and jest.setup.js to TypeScript</name>
  <files>jest.config.ts, jest.setup.ts, jest.config.js, jest.setup.js</files>
  <action>
1. **jest.config.js -> jest.config.ts:**
   - `git mv jest.config.js jest.config.ts`
   - Convert `const nextJest = require('next/jest')` to `import nextJest from 'next/jest'`
   - Add `import type { Config } from 'jest'` for type safety
   - Type `customJestConfig` as `Config` (or inline object — Claude's discretion)
   - Update `setupFilesAfterEnv` path from `jest.setup.js` to `jest.setup.ts`
   - Update `moduleNameMapper` next-server mock path from `.js` to `.ts`
   - Keep `module.exports = createJestConfig(customJestConfig)` since next/jest returns a function that must be default-exported. If ESM export causes issues, keep CommonJS export.
   - Coverage threshold stays at 70% (locked decision)
   - `collectCoverageFrom` already uses `{js,jsx,ts,tsx}` pattern — no change needed

2. **jest.setup.js -> jest.setup.ts:**
   - `git mv jest.setup.js jest.setup.ts`
   - Add `declare global` block for custom globals: `__TEST_ENVIRONMENT__`, `__CLIENT_SIDE_MOUNTED__`, `axe`, `runAxeWithRealTimers`
   - Convert `require('@testing-library/jest-dom')` to `import '@testing-library/jest-dom'`
   - Convert `const { configure, waitFor } = require('@testing-library/react')` to ES import
   - Convert `const React = require('react')` to ES import
   - Convert `const { toHaveNoViolations, configureAxe } = require('jest-axe')` to ES import
   - Keep `jest.requireActual('react-dom')` as-is (it's a Jest runtime function, not a static import)
   - Keep `require('@testing-library/jest-dom')` inside `jest.mock()` callbacks as-is (dynamic, not static)
   - Type mock implementations pragmatically:
     - `createPortal: (node: React.ReactNode) => node`
     - `matchMedia` mock: type the query parameter as `string`
     - `IntersectionObserver` class: add proper constructor signature
     - `ResizeObserver` class: type callback parameter
     - `DOMRect` class: type constructor parameters as `number`
     - `Request` polyfill: type url as `string`, init as `RequestInit | undefined`
     - `localStorageMock`: type as `Record<string, jest.Mock>`
     - `nextResponseJsonImpl`: type body as `unknown`, init as `{ status?: number; headers?: HeadersInit }`
   - For `NextResponseMock` function and its `.json` static method, use pragmatic typing with `as any` where needed (complex mock shape)
   - Type the `afterEach` callback properly
   - Keep `global.IS_REACT_ACT_ENVIRONMENT = true` — add to declare global block as `var IS_REACT_ACT_ENVIRONMENT: boolean`

Note: The jest.setup.ts file is large (~310 lines) and uses many Jest-specific patterns (jest.mock with require, jest.requireActual). Convert `require()` to ES `import` ONLY for top-level static imports. Keep `require()` inside jest.mock() factory functions and jest.requireActual() calls — these are dynamic and must remain as require(). Use `as any` freely for complex mock objects per the pragmatic typing strategy (locked decision).
  </action>
  <verify>
Run `npx jest --listTests 2>&1 | head -5` to verify Jest can still discover tests with the new config.
Run `npx jest --showConfig 2>&1 | grep setupFilesAfterEnv` to verify it points to jest.setup.ts.
  </verify>
  <done>jest.config.ts and jest.setup.ts exist, old .js files removed, Jest discovers tests and references jest.setup.ts in config.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate __mocks__/ files to TypeScript</name>
  <files>__mocks__/next-server.ts, __mocks__/react-dom.ts, app/components/ui/__mocks__/Text.tsx, __mocks__/next-server.js, __mocks__/react-dom.js, app/components/ui/__mocks__/Text.js</files>
  <action>
1. **__mocks__/next-server.js -> __mocks__/next-server.ts:**
   - `git mv __mocks__/next-server.js __mocks__/next-server.ts`
   - Convert `module.exports = require('next/server')` to: `export { NextResponse } from 'next/server'` or keep as `module.exports` if Jest mock resolution requires CommonJS
   - If using ESM export, add re-export of all needed symbols from next/server
   - Simple file, minimal typing needed

2. **__mocks__/react-dom.js -> __mocks__/react-dom.ts:**
   - `git mv __mocks__/react-dom.js __mocks__/react-dom.ts`
   - Keep `jest.requireActual('react-dom')` as-is (Jest runtime function)
   - Type the createPortal override: `createPortal: (node: React.ReactNode) => node`
   - Use `as any` for the spread of requireActual result if needed (pragmatic typing)
   - Keep `module.exports` pattern — Jest __mocks__ with automatic mocking expect CommonJS exports

3. **app/components/ui/__mocks__/Text.js -> app/components/ui/__mocks__/Text.tsx:**
   - `git mv app/components/ui/__mocks__/Text.js app/components/ui/__mocks__/Text.tsx`
   - Add TypeScript typing: `children: React.ReactNode`, `as?: React.ElementType`, `[key: string]: any` for rest props
   - Simple mock component — minimal typing needed

4. Run a quick sanity test to verify mocks still work:
   - `npx jest --testPathPattern="Button.test" --no-coverage 2>&1 | tail -5` (pick any simple UI test that uses react-dom portal mock)
  </action>
  <verify>
Run `npx jest --testPathPattern="Button.test" --no-coverage` — test should pass (proves react-dom mock + jest.setup.ts work together).
  </verify>
  <done>All 3 __mocks__ files (.ts/.tsx) exist, old .js files removed, at least one existing test passes confirming mock infrastructure works.</done>
</task>

</tasks>

<verification>
1. `ls jest.config.ts jest.setup.ts __mocks__/next-server.ts __mocks__/react-dom.ts app/components/ui/__mocks__/Text.tsx` — all 5 files exist
2. `ls jest.config.js jest.setup.js __mocks__/next-server.js __mocks__/react-dom.js app/components/ui/__mocks__/Text.js 2>&1` — none of the old .js files exist
3. `npx jest --listTests 2>&1 | wc -l` — Jest discovers the same number of tests as before
4. `npx jest --testPathPattern="Button.test" --no-coverage` — at least one test passes
</verification>

<success_criteria>
- jest.config.ts, jest.setup.ts, __mocks__/next-server.ts, __mocks__/react-dom.ts, app/components/ui/__mocks__/Text.tsx exist
- No .js counterparts remain (including app/components/ui/__mocks__/Text.js)
- Jest discovers all 131 test files
- At least one existing test passes (proves infrastructure works)
</success_criteria>

<output>
After completion, create `.planning/phases/42-test-migration/42-01-SUMMARY.md`
</output>
