---
phase: 42-test-migration
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - lib/__tests__/changelogService.test.ts
  - lib/__tests__/errorMonitor.test.ts
  - lib/__tests__/formatUtils.test.ts
  - lib/__tests__/logService.test.ts
  - lib/__tests__/maintenanceService.test.ts
  - lib/__tests__/netatmoApi.test.ts
  - lib/__tests__/openMeteo.test.ts
  - lib/__tests__/schedulerService.test.ts
  - lib/__tests__/stoveApi.test.ts
  - lib/__tests__/tokenRefresh.test.ts
  - lib/__tests__/version.test.ts
  - lib/__tests__/weatherCache.test.ts
  - lib/__tests__/weatherCacheService.test.ts
  - lib/core/__tests__/apiErrors.test.ts
  - lib/core/__tests__/apiResponse.test.ts
  - lib/core/__tests__/requestParser.test.ts
  - lib/hooks/__tests__/useOnlineStatus.test.ts
  - lib/hue/__tests__/colorUtils.test.ts
  - lib/hue/__tests__/hueApiScenes.test.ts
  - lib/hue/__tests__/hueLocalHelper.test.ts
  - lib/hue/__tests__/hueRemoteTokenHelper.test.ts
  - lib/pwa/__tests__/backgroundSync.test.ts
  - lib/pwa/__tests__/geofencing.test.ts
  - lib/pwa/__tests__/offlineStateCache.test.ts
  - lib/pwa/__tests__/persistentStorage.test.ts
  - lib/pwa/__tests__/vibration.test.ts
  - lib/pwa/__tests__/wakeLock.test.ts
  - lib/pwa/__tests__/webShare.test.ts
  - lib/services/__tests__/StoveService.test.ts
  - lib/utils/__tests__/cn.test.ts
  - lib/utils/__tests__/pidController.test.ts
autonomous: true

must_haves:
  truths:
    - "All 31 lib/ test files have .ts extension"
    - "No .test.js files remain in lib/ subdirectories"
    - "Tests still pass after migration"
  artifacts:
    - path: "lib/__tests__/*.test.ts"
      provides: "Migrated lib service tests"
    - path: "lib/core/__tests__/*.test.ts"
      provides: "Migrated core API tests"
    - path: "lib/pwa/__tests__/*.test.ts"
      provides: "Migrated PWA utility tests"
    - path: "lib/hue/__tests__/*.test.ts"
      provides: "Migrated Hue API tests"
  key_links:
    - from: "lib/__tests__/*.test.ts"
      to: "lib/*.ts"
      via: "import"
      pattern: "import.*from.*@/lib/"
---

<objective>
Migrate all 31 test files under lib/ subdirectories from .test.js to .test.ts.

Purpose: Converts TEST-01 requirement — all lib/ test files to TypeScript. These are service/utility tests that primarily test pure functions and API clients with mock-heavy patterns.
Output: 31 .test.ts files replacing .test.js counterparts across lib/__tests__/, lib/core/__tests__/, lib/hooks/__tests__/, lib/hue/__tests__/, lib/pwa/__tests__/, lib/services/__tests__/, lib/utils/__tests__/.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-test-migration/42-CONTEXT.md
@.planning/phases/42-test-migration/42-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate lib/__tests__/ and lib/core/__tests__/ test files (16 files)</name>
  <files>
    lib/__tests__/changelogService.test.ts
    lib/__tests__/errorMonitor.test.ts
    lib/__tests__/formatUtils.test.ts
    lib/__tests__/logService.test.ts
    lib/__tests__/maintenanceService.test.ts
    lib/__tests__/netatmoApi.test.ts
    lib/__tests__/openMeteo.test.ts
    lib/__tests__/schedulerService.test.ts
    lib/__tests__/stoveApi.test.ts
    lib/__tests__/tokenRefresh.test.ts
    lib/__tests__/version.test.ts
    lib/__tests__/weatherCache.test.ts
    lib/__tests__/weatherCacheService.test.ts
    lib/core/__tests__/apiErrors.test.ts
    lib/core/__tests__/apiResponse.test.ts
    lib/core/__tests__/requestParser.test.ts
  </files>
  <action>
For each of the 16 files:

1. `git mv {file}.test.js {file}.test.ts`
2. Add minimal type annotations following pragmatic typing strategy (locked decision):
   - Type mock return values and parameters WHERE IT CATCHES BUGS
   - Use `jest.Mock` and `as any` for complex mocks (Firebase, fetch, external APIs)
   - Do NOT add strict `jest.Mock<ReturnType, Parameters>` everywhere
3. Convert top-level `require()` to ES `import` where straightforward
4. Keep `require()` for dynamic imports inside `jest.mock()` factories and `jest.requireActual()` calls
5. Fix any import paths that reference `.js` extensions (use extensionless imports per Claude's discretion)
6. If a test has pre-existing failures, fix if simple (<2 min), otherwise `test.skip()` + TODO comment (locked decision)

Specific typing patterns for service tests:
- Mock fetch: `global.fetch = jest.fn() as jest.Mock`
- Mock Firebase: `(get as jest.Mock).mockResolvedValue(...)` — keep as-is, minimal typing
- Mock API responses: Type the mock return objects only if the type is already defined in the source
- `jest.spyOn()` calls: No additional typing needed (TypeScript infers from the spied object)

Process all 16 files in a batch. Run tests after completing the batch:
`npx jest --testPathPattern="lib/__tests__|lib/core/__tests__" --no-coverage 2>&1 | tail -20`
  </action>
  <verify>
`find lib/__tests__ lib/core/__tests__ -name "*.test.js" | wc -l` returns 0
`find lib/__tests__ lib/core/__tests__ -name "*.test.ts" | wc -l` returns 16
`npx jest --testPathPattern="lib/__tests__|lib/core/__tests__" --no-coverage 2>&1 | tail -5` — tests pass (or skipped with TODO if pre-existing failures)
  </verify>
  <done>All 16 lib/__tests__/ and lib/core/__tests__/ files are .test.ts with no .test.js remaining. Tests pass or are documented as skipped.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate lib/hooks, lib/hue, lib/pwa, lib/services, lib/utils test files (15 files)</name>
  <files>
    lib/hooks/__tests__/useOnlineStatus.test.ts
    lib/hue/__tests__/colorUtils.test.ts
    lib/hue/__tests__/hueApiScenes.test.ts
    lib/hue/__tests__/hueLocalHelper.test.ts
    lib/hue/__tests__/hueRemoteTokenHelper.test.ts
    lib/pwa/__tests__/backgroundSync.test.ts
    lib/pwa/__tests__/geofencing.test.ts
    lib/pwa/__tests__/offlineStateCache.test.ts
    lib/pwa/__tests__/persistentStorage.test.ts
    lib/pwa/__tests__/vibration.test.ts
    lib/pwa/__tests__/wakeLock.test.ts
    lib/pwa/__tests__/webShare.test.ts
    lib/services/__tests__/StoveService.test.ts
    lib/utils/__tests__/cn.test.ts
    lib/utils/__tests__/pidController.test.ts
  </files>
  <action>
For each of the 15 files:

1. `git mv {file}.test.js {file}.test.ts`
2. Apply same pragmatic typing strategy as Task 1:
   - Type mock return values where it catches bugs
   - `jest.Mock` and `as any` for complex mocks
   - Convert top-level `require()` to `import` where straightforward
   - Keep `require()` inside jest.mock() factories

Specific patterns per subdirectory:
- **lib/hooks/**: Hook tests use renderHook — type the result as needed, keep generic
- **lib/hue/**: Hue API tests have complex mock objects — use `as any` freely (pragmatic typing for external APIs)
- **lib/pwa/**: Browser API mocks (navigator, ServiceWorker) — type with `as any` or minimal interfaces
- **lib/services/**: StoveService test has Firebase mocks — `as any` for Firebase responses
- **lib/utils/**: cn.test and pidController.test are pure function tests — minimal typing, mostly automatic

Process all 15 files in batch. Run tests:
`npx jest --testPathPattern="lib/(hooks|hue|pwa|services|utils)/__tests__" --no-coverage 2>&1 | tail -20`
  </action>
  <verify>
`find lib/hooks/__tests__ lib/hue/__tests__ lib/pwa/__tests__ lib/services/__tests__ lib/utils/__tests__ -name "*.test.js" | wc -l` returns 0
`find lib/hooks/__tests__ lib/hue/__tests__ lib/pwa/__tests__ lib/services/__tests__ lib/utils/__tests__ -name "*.test.ts" | wc -l` returns 15
`npx jest --testPathPattern="lib/(hooks|hue|pwa|services|utils)/__tests__" --no-coverage 2>&1 | tail -5` — tests pass
  </verify>
  <done>All 15 files under lib/{hooks,hue,pwa,services,utils}/__tests__/ are .test.ts. No .test.js remaining. Tests pass.</done>
</task>

</tasks>

<verification>
1. `find lib -name "*.test.js" | wc -l` returns 0
2. `find lib -name "*.test.ts" | wc -l` returns 31
3. `npx jest --testPathPattern="^lib/" --no-coverage` — all lib tests pass
4. `git log --oneline -1` shows commit for this plan
</verification>

<success_criteria>
- All 31 test files under lib/ have .test.ts extension
- Zero .test.js files remain anywhere in lib/
- All tests pass (or documented pre-existing failures skipped with TODO)
- TEST-01 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/42-test-migration/42-02-SUMMARY.md`
</output>
