---
phase: 42-test-migration
plan: 03
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - __tests__/lib/coordinationDebounce.test.ts
  - __tests__/lib/coordinationEventLogger.test.ts
  - __tests__/lib/coordinationNotificationThrottle.test.ts
  - __tests__/lib/coordinationOrchestrator.test.ts
  - __tests__/lib/coordinationPauseCalculator.test.ts
  - __tests__/lib/coordinationPreferences.test.ts
  - __tests__/lib/coordinationState.test.ts
  - __tests__/lib/coordinationUserIntent.test.ts
  - __tests__/lib/environmentHelper.test.ts
  - __tests__/lib/envValidator.test.ts
  - __tests__/lib/healthDeadManSwitch.test.ts
  - __tests__/lib/healthLogger.test.ts
  - __tests__/lib/healthMonitoring.test.ts
  - __tests__/lib/healthNotifications.test.ts
  - __tests__/lib/netatmoApi.test.ts
  - __tests__/lib/netatmoCacheService.test.ts
  - __tests__/lib/netatmoCameraApi.test.ts
  - __tests__/lib/netatmoCredentials.test.ts
  - __tests__/lib/netatmoRateLimiter.test.ts
  - __tests__/lib/netatmoStoveSync.test.ts
  - __tests__/lib/netatmoTokenHelper.test.ts
  - __tests__/lib/notificationHistoryService.test.ts
  - __tests__/lib/themeService.test.ts
  - __tests__/maintenanceService.concurrency.test.ts
  - __tests__/sandboxService.test.ts
  - __tests__/semiAutoMode.test.ts
  - __tests__/stoveApi.sandbox.test.ts
  - __tests__/utils/scheduleHelpers.test.ts
  - __tests__/hooks/useScheduleData.test.ts
  - __tests__/api/geocoding/geocoding.test.ts
  - __tests__/api/netatmo/schedules.test.ts
autonomous: true

must_haves:
  truths:
    - "All 31 __tests__/ root-level test files have .ts extension"
    - "No .test.js files remain in __tests__/ directory tree"
    - "Coordination, health, netatmo test suites pass"
  artifacts:
    - path: "__tests__/lib/*.test.ts"
      provides: "Migrated coordination, health, netatmo, and service tests"
    - path: "__tests__/api/*.test.ts"
      provides: "Migrated API integration tests"
    - path: "__tests__/*.test.ts"
      provides: "Migrated root-level service tests"
  key_links:
    - from: "__tests__/lib/*.test.ts"
      to: "lib/*.ts"
      via: "import"
      pattern: "import.*from.*@/lib/"
---

<objective>
Migrate all 31 test files under the root __tests__/ directory (excluding __tests__/components/ and __tests__/app/ which are handled in Plan 06) from .test.js to .test.ts.

Purpose: Converts the largest batch of service/lib tests in the root __tests__/ directory — coordination system (8 files), health monitoring (4 files), netatmo services (7 files), and misc services/utilities.
Output: 31 .test.ts files replacing .test.js counterparts.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-test-migration/42-CONTEXT.md
@.planning/phases/42-test-migration/42-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate __tests__/lib/ coordination and health test files (12 files)</name>
  <files>
    __tests__/lib/coordinationDebounce.test.ts
    __tests__/lib/coordinationEventLogger.test.ts
    __tests__/lib/coordinationNotificationThrottle.test.ts
    __tests__/lib/coordinationOrchestrator.test.ts
    __tests__/lib/coordinationPauseCalculator.test.ts
    __tests__/lib/coordinationPreferences.test.ts
    __tests__/lib/coordinationState.test.ts
    __tests__/lib/coordinationUserIntent.test.ts
    __tests__/lib/healthDeadManSwitch.test.ts
    __tests__/lib/healthLogger.test.ts
    __tests__/lib/healthMonitoring.test.ts
    __tests__/lib/healthNotifications.test.ts
  </files>
  <action>
For each of the 12 files:

1. `git mv __tests__/lib/{name}.test.js __tests__/lib/{name}.test.ts`
2. Apply pragmatic typing strategy (locked decision):
   - Type mock return values and parameters where it catches bugs
   - Use `jest.Mock` and `as any` for complex mocks (Firebase, fetch)
   - Convert top-level `require()` to ES `import` where straightforward
   - Keep `require()` inside jest.mock() factories
3. These are coordination/health service tests — typical patterns:
   - Firebase adminDbGet/adminDbSet mocks: `as any` for return values
   - Date/time mocking: `jest.spyOn(Date, 'now')` — no typing changes needed
   - Process.env mocking: Already string-typed, minimal changes
   - Fetch mocks: `global.fetch = jest.fn() as jest.Mock`

Process all 12 in batch, then run:
`npx jest --testPathPattern="__tests__/lib/(coordination|health)" --no-coverage 2>&1 | tail -20`
  </action>
  <verify>
`find __tests__/lib -name "coordination*.test.js" -o -name "health*.test.js" | wc -l` returns 0
`find __tests__/lib -name "coordination*.test.ts" -o -name "health*.test.ts" | wc -l` returns 12
Tests pass or are documented as skipped.
  </verify>
  <done>All 12 coordination + health test files migrated to .test.ts. Tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate __tests__/lib/ netatmo, remaining lib, root-level, api, utils, hooks test files (19 files)</name>
  <files>
    __tests__/lib/netatmoApi.test.ts
    __tests__/lib/netatmoCacheService.test.ts
    __tests__/lib/netatmoCameraApi.test.ts
    __tests__/lib/netatmoCredentials.test.ts
    __tests__/lib/netatmoRateLimiter.test.ts
    __tests__/lib/netatmoStoveSync.test.ts
    __tests__/lib/netatmoTokenHelper.test.ts
    __tests__/lib/notificationHistoryService.test.ts
    __tests__/lib/themeService.test.ts
    __tests__/lib/environmentHelper.test.ts
    __tests__/lib/envValidator.test.ts
    __tests__/maintenanceService.concurrency.test.ts
    __tests__/sandboxService.test.ts
    __tests__/semiAutoMode.test.ts
    __tests__/stoveApi.sandbox.test.ts
    __tests__/utils/scheduleHelpers.test.ts
    __tests__/hooks/useScheduleData.test.ts
    __tests__/api/geocoding/geocoding.test.ts
    __tests__/api/netatmo/schedules.test.ts
  </files>
  <action>
For each of the 19 files:

1. `git mv {path}.test.js {path}.test.ts`
2. Apply same pragmatic typing strategy:
   - Netatmo tests: Heavy external API mocking — use `as any` for mock responses
   - Root-level tests (maintenanceService.concurrency, sandboxService, semiAutoMode, stoveApi.sandbox): Service integration tests with Firebase mocks — `as any` for Firebase data
   - __tests__/utils/scheduleHelpers.test: Pure function test — minimal typing
   - __tests__/hooks/useScheduleData.test: Hook test with renderHook — type result generically
   - __tests__/api/ tests: API route integration tests — type Request/Response mocks pragmatically

Process all 19 in batch, then run:
`npx jest --testPathPattern="__tests__/(lib|api|utils|hooks|maintenance|sandbox|semiAuto|stoveApi)" --no-coverage 2>&1 | tail -20`
  </action>
  <verify>
`find __tests__ -name "*.test.js" -not -path "*/__tests__/components/*" -not -path "*/__tests__/app/*" | wc -l` returns 0
`find __tests__ -name "*.test.ts" -not -path "*/__tests__/components/*" -not -path "*/__tests__/app/*" | wc -l` returns 31
Tests pass.
  </verify>
  <done>All 19 remaining __tests__/ files (netatmo, services, api, utils, hooks) migrated to .test.ts. Tests pass.</done>
</task>

</tasks>

<verification>
1. `find __tests__/lib __tests__/api __tests__/utils __tests__/hooks -name "*.test.js" | wc -l` returns 0
2. `find __tests__ -maxdepth 1 -name "*.test.js" | wc -l` returns 0
3. `find __tests__/lib __tests__/api __tests__/utils __tests__/hooks -name "*.test.ts" | wc -l` returns 25
4. `find __tests__ -maxdepth 1 -name "*.test.ts" | wc -l` returns 4
5. `npx jest --testPathPattern="__tests__/(lib|api|utils|hooks|maintenance|sandbox|semiAuto|stoveApi)" --no-coverage` — all pass
</verification>

<success_criteria>
- All 31 test files in __tests__/ (lib, api, utils, hooks, root) have .test.ts extension
- Zero .test.js in these directories
- All tests pass (or documented pre-existing failures skipped with TODO)
</success_criteria>

<output>
After completion, create `.planning/phases/42-test-migration/42-03-SUMMARY.md`
</output>
