---
phase: 42-test-migration
plan: 07
type: execute
wave: 3
depends_on: ["42-02", "42-03", "42-04", "42-05", "42-06"]
files_modified: []
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "npm test passes with all tests green"
    - "Zero .test.js files remain in project"
    - "Zero tsc errors on test files"
    - "Coverage thresholds met (70% branches/functions/lines/statements)"
  artifacts:
    - path: "jest.config.ts"
      provides: "TypeScript Jest configuration"
    - path: "jest.setup.ts"
      provides: "Typed test setup"
  key_links:
    - from: "jest.config.ts"
      to: "jest.setup.ts"
      via: "setupFilesAfterEnv"
      pattern: "jest\\.setup\\.ts"
---

<objective>
Run the full test suite and fix any remaining issues from the migration. Verify zero .test.js files remain and all tests pass.

Purpose: Final verification and gap closure for Phase 42. Ensures TEST-03 (Jest configured for TypeScript) and TEST-04 (all tests pass) requirements are met. Fixes any breakages introduced during batch migrations in Plans 02-06.
Output: Clean test run, verified migration, SUMMARY documenting final state.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-test-migration/42-CONTEXT.md
@.planning/phases/42-test-migration/42-RESEARCH.md
@.planning/phases/42-test-migration/42-01-SUMMARY.md
@.planning/phases/42-test-migration/42-02-SUMMARY.md
@.planning/phases/42-test-migration/42-03-SUMMARY.md
@.planning/phases/42-test-migration/42-04-SUMMARY.md
@.planning/phases/42-test-migration/42-05-SUMMARY.md
@.planning/phases/42-test-migration/42-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Full test suite run and failure diagnosis</name>
  <files>(varies based on failures found)</files>
  <action>
1. **Verify zero .test.js files remain:**
   `find . -not -path "*/node_modules/*" -name "*.test.js" -o -name "*.test.jsx" | head -20`
   Expected: empty output
   If any remain: `git mv` them to .ts/.tsx

2. **Run full test suite:**
   `npx jest --no-coverage 2>&1 | tail -40`
   Capture: total tests, passed, failed, skipped

3. **If failures exist, categorize them:**
   - **Import errors** (module not found): Fix import paths (route.js -> route.ts pattern)
   - **Type errors** (TS compilation): Add missing types, use `as any` for complex cases
   - **Runtime errors** (test logic): Fix if quick (<2 min), else `test.skip()` + TODO comment (locked decision)
   - **Pre-existing failures**: Document in SUMMARY, fix if simple

4. **Fix each failure systematically:**
   - Read the failing test file
   - Diagnose the error type
   - Apply minimal fix
   - Re-run just that test to confirm fix
   - Move to next failure

5. **After all fixes, run full suite again:**
   `npx jest --no-coverage 2>&1 | tail -40`
   Target: all tests pass (or documented skips with TODO)

6. **Run with coverage to verify thresholds:**
   `npx jest --coverage 2>&1 | tail -20`
   Coverage thresholds: 70% branches/functions/lines/statements (locked decision)
  </action>
  <verify>
`npx jest --no-coverage` — all tests pass (0 failures, skipped tests have TODO comments)
`find . -not -path "*/node_modules/*" -name "*.test.js" | wc -l` returns 0
  </verify>
  <done>Full test suite passes. Zero .test.js files remain. All failures either fixed or documented with test.skip() + TODO.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript verification on test files</name>
  <files>(varies based on tsc errors found)</files>
  <action>
1. **Run tsc on test files to check for type errors:**
   `npx tsc --noEmit 2>&1 | grep -E "test\.(ts|tsx)" | head -40`
   This checks that test files compile without type errors.

2. **If tsc errors exist on test files, categorize and fix:**
   - **Missing type imports**: Add imports from @/types or component files
   - **Implicit any**: Add explicit types where tsc complains
   - **Mock type mismatches**: Use `as any` or `jest.Mock` (pragmatic typing)
   - **Property access on unknown**: Type assert with `as any` or narrow with type guard

3. **Target: zero tsc errors on test files** (locked decision — same standard as Phases 38-41)
   Note: There may be pre-existing tsc errors on non-test files (e.g., 198 external API type errors from Phase 41). Only fix NEW errors on test files.

4. **Final count:**
   `npx tsc --noEmit 2>&1 | grep -c "test\.(ts|tsx)"` — should return 0
   `find . -not -path "*/node_modules/*" \( -name "*.test.ts" -o -name "*.test.tsx" \) | wc -l` — should return 131
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep "test\.(ts|tsx)" | wc -l` returns 0
`find . -not -path "*/node_modules/*" \( -name "*.test.ts" -o -name "*.test.tsx" \) | wc -l` returns 131
  </verify>
  <done>Zero tsc errors on test files. 131 test files all in TypeScript. Phase 42 requirements fully satisfied.</done>
</task>

</tasks>

<verification>
1. `find . -not -path "*/node_modules/*" -name "*.test.js" | wc -l` returns 0 (no JS test files)
2. `find . -not -path "*/node_modules/*" \( -name "*.test.ts" -o -name "*.test.tsx" \) | wc -l` returns 131 (all TS)
3. `npx jest --no-coverage` — all tests pass
4. `npx tsc --noEmit 2>&1 | grep "test\.(ts|tsx)" | wc -l` returns 0 (no type errors on tests)
5. `ls jest.config.ts jest.setup.ts __mocks__/next-server.ts __mocks__/react-dom.ts` — all config files are TS
6. Coverage thresholds met (70%)
</verification>

<success_criteria>
- TEST-01: All lib/ test files are .ts (verified by find)
- TEST-02: All component test files are .tsx (verified by find)
- TEST-03: Jest configured for TypeScript (jest.config.ts, jest.setup.ts exist)
- TEST-04: All tests pass after migration (npm test green)
- Zero tsc errors on test files
- 131 test files migrated + 4 config/mock files = 135 total files
</success_criteria>

<output>
After completion, create `.planning/phases/42-test-migration/42-07-SUMMARY.md`
</output>
