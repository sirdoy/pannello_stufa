---
phase: 43-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/__utils__/mockHelpers.ts
  - __tests__/__utils__/mockFactories.ts
  - types/external-apis/hue.d.ts
  - types/external-apis/netatmo.d.ts
  - types/external-apis/camera.d.ts
  - types/external-apis.d.ts
autonomous: true

must_haves:
  truths:
    - "Shared mock utilities exist and compile without errors"
    - "External API types cover all 198 documented property access errors"
    - "jest.mocked() pattern works with project's Jest 30.2.0 setup"
  artifacts:
    - path: "__tests__/__utils__/mockHelpers.ts"
      provides: "Reusable mock type helpers for jest.mocked, jest.MockedFunction, typed jest.fn()"
      exports: ["mockFunction", "createMockResponse", "createMockNextRequest"]
    - path: "__tests__/__utils__/mockFactories.ts"
      provides: "Typed mock factories for Firebase refs, Firestore timestamps, fetch responses"
      exports: ["createMockDbRef", "createMockTimestamp", "createMockFetchResponse"]
    - path: "types/external-apis/hue.d.ts"
      provides: "Full Hue v2 API type definitions for lights, rooms, scenes, bridge"
      contains: "interface HueLight"
    - path: "types/external-apis/netatmo.d.ts"
      provides: "Full Netatmo API type definitions for thermostat, camera, modules"
      contains: "interface NetatmoDevice"
    - path: "types/external-apis/camera.d.ts"
      provides: "Camera API type definitions for events, snapshots, streams"
      contains: "interface CameraEvent"
  key_links:
    - from: "__tests__/__utils__/mockHelpers.ts"
      to: "@jest/globals"
      via: "import jest types"
      pattern: "import.*jest"
    - from: "types/external-apis/hue.d.ts"
      to: "app/lights/page.tsx"
      via: "type augmentation resolves property access errors"
      pattern: "interface Hue"
---

<objective>
Create shared mock type utilities and full external API type definitions that serve as foundation for all subsequent error-fixing plans.

Purpose: The 1492 mock type errors across 92 test files share common patterns (Firebase mocks, fetch mocks, service mocks). Shared utilities reduce boilerplate and ensure consistency. The 198 external API type errors require proper interface definitions for Hue v2, Netatmo, and Camera APIs — not stubs, per user decision.

Output: `__tests__/__utils__/mockHelpers.ts`, `__tests__/__utils__/mockFactories.ts`, and `types/external-apis/` directory with full type definitions.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-verification/43-RESEARCH.md
@tsconfig.json
@types/external-apis.d.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared mock type utilities</name>
  <files>
    __tests__/__utils__/mockHelpers.ts
    __tests__/__utils__/mockFactories.ts
  </files>
  <action>
Create `__tests__/__utils__/` directory and two utility files.

**mockHelpers.ts** — Generic mock typing helpers:
- `mockFunction<T extends (...args: any[]) => any>(fn: T): jest.MockedFunction<T>` — wraps cast for manual mocks
- `createMockResponse(overrides?: Partial<Response>): Response` — creates typed mock Response for fetch tests
- `createMockNextRequest(url: string, options?: RequestInit): Request` — creates typed mock Request for API route tests
- `typedMockResolvedValue<T>(mock: jest.MockedFunction<any>, value: T): void` — type-safe mockResolvedValue wrapper

**mockFactories.ts** — Domain-specific mock factories:
- `createMockDbRef()` — returns typed Firebase database ref mock with set/get/update/push/remove methods, all returning jest.fn() with proper types
- `createMockTimestamp(seconds?: number)` — returns typed Firestore Timestamp mock with toDate(), toMillis(), seconds, nanoseconds
- `createMockFetchResponse(body: unknown, options?: { ok?: boolean; status?: number; headers?: Record<string, string> })` — returns typed fetch Response mock
- `createMockDataSnapshot(val: unknown)` — returns typed Firebase DataSnapshot mock with val(), exists(), key, ref
- `createMockQuerySnapshot(docs: Array<{ id: string; data: () => unknown }>)` — returns typed Firestore QuerySnapshot mock

All functions must compile cleanly with `tsc --noEmit`. Use `jest.fn()` from `@jest/globals` if that's the project pattern, otherwise use global jest.

Check existing test files to understand the current mock patterns being used (look at 2-3 representative files like `lib/__tests__/maintenanceService.test.ts` and `__tests__/lib/netatmoStoveSync.test.ts`) to ensure utilities match actual usage patterns.
  </action>
  <verify>
Run `npx tsc --noEmit __tests__/__utils__/mockHelpers.ts __tests__/__utils__/mockFactories.ts` — no errors. If tsc doesn't accept individual files, verify by running full `npx tsc --noEmit 2>&1 | grep "__utils__"` returns no errors for these files.
  </verify>
  <done>
Mock helper utilities exist at `__tests__/__utils__/mockHelpers.ts` and `__tests__/__utils__/mockFactories.ts`, export typed helper functions, and compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create full external API type definitions</name>
  <files>
    types/external-apis/hue.d.ts
    types/external-apis/netatmo.d.ts
    types/external-apis/camera.d.ts
    types/external-apis.d.ts
  </files>
  <action>
Replace the current stub `types/external-apis.d.ts` with a proper directory structure under `types/external-apis/`.

**Step 1:** Analyze the 198 documented external API type errors. Run `npx tsc --noEmit 2>&1` and grep for errors in files that reference Hue, Netatmo, or Camera APIs. Also scan source files (`app/lights/page.tsx`, `app/thermostat/`, `app/camera/`, `lib/hue/`, `lib/netatmoApi.ts`, `lib/netatmoCameraApi.ts`) to understand ALL property accesses on external API data.

**Step 2: hue.d.ts** — Full Hue v2 API types:
- `HueLight` interface with ALL properties accessed in codebase (id, on, dimming, color, color_temperature, metadata, owner, type, dynamics, gradient, effects, powerup, etc.)
- `HueRoom` with services, metadata, children, grouped_services
- `HueScene` with group, actions, metadata, speed, auto_dynamic, palette
- `HueGroup` / `HueZone` / `HueBridge` / `HueBridgeConfig`
- `HueSceneAction` with target, action (on, dimming, color, color_temperature)
- `HueEntertainment`, `HueButton`, `HueMotion` if referenced in codebase
- ALL property types must match what the codebase actually accesses (check with grep)

**Step 3: netatmo.d.ts** — Full Netatmo API types:
- `NetatmoDevice` (thermostat) with all properties (id, type, module_name, dashboard_data, battery_percent, firmware, rf_status, etc.)
- `NetatmoModule` (valve/relay) with module_name, type, dashboard_data, setpoint_temp, etc.
- `NetatmoSchedule` with id, name, timetable, zones, type, selected, default
- `NetatmoTimetableEntry` with m_offset, zone_id
- `NetatmoZone` with id, name, type, rooms_temp, rooms
- `NetatmoRoom` with id, name, module_ids, therm_measured_temperature, therm_setpoint_temperature
- `NetatmoHome`, `NetatmoHomeData`, `NetatmoHomesData`
- Check `lib/netatmoApi.ts` and `lib/netatmoService.ts` for all property accesses

**Step 4: camera.d.ts** — Camera API types:
- `Camera` with id, name, type, status, vpn_url, is_local, sd_status, alim_status
- `CameraEvent` with id, type, time, camera_id, video_id, video_status, event_list, snapshot
- `CameraSnapshot` with url, filename, key
- `CameraPerson` with id, face, last_seen, out_of_sight
- Check `lib/netatmoCameraApi.ts` and `app/(pages)/camera/` for all property accesses

**Step 5:** Update or replace `types/external-apis.d.ts` to re-export from the new directory structure. Ensure the types are either global declarations or properly exported/importable.

IMPORTANT: Do NOT use stubs or `any` types. Every property that the codebase accesses must be properly typed. If a property's type is unclear, check the source file that accesses it to infer the correct type.
  </action>
  <verify>
Run `npx tsc --noEmit 2>&1 | grep -c "error TS"` and compare against baseline of 1654 errors. The external API type definitions should reduce non-test file errors significantly (target: reduce 170 non-test errors related to external APIs).
  </verify>
  <done>
Full external API type definitions exist for Hue v2, Netatmo, and Camera APIs with all properties properly typed. The `types/external-apis.d.ts` stub is replaced with complete interface definitions. Non-test tsc errors related to external API property access are resolved.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit 2>&1 | grep "__utils__"` shows 0 errors for utility files
- `ls types/external-apis/` shows hue.d.ts, netatmo.d.ts, camera.d.ts
- Mock helpers compile and export expected functions
- External API types cover all properties accessed in source code
</verification>

<success_criteria>
- Shared mock utilities exist and are importable from `__tests__/__utils__/mockHelpers` and `__tests__/__utils__/mockFactories`
- External API types resolve the majority of 170 non-test source file tsc errors
- Foundation is ready for subsequent mock type error fixing plans
</success_criteria>

<output>
After completion, create `.planning/phases/43-verification/43-01-SUMMARY.md`
</output>
