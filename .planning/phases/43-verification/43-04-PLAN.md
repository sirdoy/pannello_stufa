---
phase: 43-verification
plan: 04
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - lib/__tests__/maintenanceService.test.ts
  - lib/__tests__/schedulerService.test.ts
  - lib/__tests__/errorMonitor.test.ts
  - lib/__tests__/logService.test.ts
  - lib/__tests__/changelogService.test.ts
  - lib/__tests__/tokenRefresh.test.ts
  - lib/__tests__/weatherCacheService.test.ts
  - lib/__tests__/netatmoApi.test.ts
  - lib/__tests__/openMeteo.test.ts
  - lib/pwa/__tests__/offlineStateCache.test.ts
  - lib/pwa/__tests__/notificationService.test.ts
  - lib/pwa/__tests__/pushSubscription.test.ts
  - lib/pwa/__tests__/appBadge.test.ts
  - lib/hue/__tests__/hueLocalHelper.test.ts
  - lib/hue/__tests__/hueRemoteHelper.test.ts
  - lib/hue/__tests__/hueScenes.test.ts
  - lib/core/__tests__/requestParser.test.ts
  - lib/utils/__tests__/pidController.test.ts
  - lib/services/__tests__/deviceCache.test.ts
autonomous: true

must_haves:
  truths:
    - "All lib/ test files compile without tsc errors"
    - "Mock typing uses jest.mocked() for auto-mocked modules"
    - "Firebase Timestamp mocks are properly typed"
    - "All existing tests still pass after type fixes"
  artifacts:
    - path: "lib/__tests__/maintenanceService.test.ts"
      provides: "Maintenance service tests with proper Firebase mock typing"
      min_lines: 50
    - path: "lib/__tests__/schedulerService.test.ts"
      provides: "Scheduler service tests with proper mock typing"
      min_lines: 50
  key_links:
    - from: "lib/__tests__/maintenanceService.test.ts"
      to: "@/lib/maintenanceService"
      via: "jest.mock + jest.mocked"
      pattern: "jest\\.mocked"
---

<objective>
Fix mock type errors in all 19 lib/ test files (~350 errors total). These are service, utility, PWA, and Hue library tests.

Purpose: The lib/ tests have mock type errors primarily from Firebase database mocks, Firestore Timestamp mocks, and service function mocks. These follow consistent patterns that can be batch-processed.

Output: All 19 lib/ test files compile with zero tsc errors while tests continue to pass.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-verification/43-RESEARCH.md
@.planning/phases/43-verification/43-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix mock types in high-error lib/ test files</name>
  <files>
    lib/__tests__/maintenanceService.test.ts
    lib/__tests__/schedulerService.test.ts
    lib/__tests__/errorMonitor.test.ts
    lib/__tests__/logService.test.ts
    lib/__tests__/changelogService.test.ts
    lib/__tests__/tokenRefresh.test.ts
    lib/__tests__/weatherCacheService.test.ts
    lib/__tests__/netatmoApi.test.ts
    lib/__tests__/openMeteo.test.ts
  </files>
  <action>
Fix all tsc errors in these 9 lib/__tests__/ files (~280 errors total). Run `npx tsc --noEmit 2>&1 | grep "error TS" | grep "lib/__tests__"` to see exact errors.

**Common patterns across these files:**

1. **Firebase/Admin SDK mocks:** These files mock `@/lib/core/firebase-admin` or `firebase/database`. Apply `jest.mocked()` to all Firebase imports:
   ```typescript
   import { adminDbGet, adminDbSet } from '@/lib/core/firebase-admin';
   jest.mock('@/lib/core/firebase-admin');
   const mockAdminDbGet = jest.mocked(adminDbGet);
   const mockAdminDbSet = jest.mocked(adminDbSet);
   ```

2. **Firestore Timestamp mocks:** Many tests create fake Timestamp objects. Use proper typing:
   ```typescript
   const mockTimestamp = { seconds: 1234567890, nanoseconds: 0, toDate: () => new Date(), toMillis: () => 1234567890000 } as unknown as import('firebase-admin/firestore').Timestamp;
   ```
   Or better: use `createMockTimestamp()` from `__tests__/__utils__/mockFactories.ts` if available from Plan 43-01.

3. **Service function mocks:** For each `jest.mock('@/lib/someService')`, wrap imported functions with `jest.mocked()`.

4. **Cache service mocks:** `cacheGet`, `invalidateCache` from `@/lib/cacheService` — use `jest.mocked()`.

5. **pidController.test.ts (16 errors):** Has `TS2341: Property is private` errors — tests access private class members. Fix by:
   - Using `(controller as any).kp` pattern for test-only private access, OR
   - Better: access through public methods/getters if they exist, OR
   - Create a test subclass that exposes private members, OR
   - Use bracket notation: `controller['kp']` which bypasses private checks

After fixing, run tests for these files.
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep "error TS" | grep "lib/__tests__" | wc -l` returns 0.
`npm test -- --testPathPattern="lib/__tests__" --silent` shows all tests passing.
  </verify>
  <done>All 9 lib/__tests__/ files compile with zero tsc errors and all tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix mock types in lib/pwa, lib/hue, lib/core, lib/utils, lib/services tests</name>
  <files>
    lib/pwa/__tests__/offlineStateCache.test.ts
    lib/pwa/__tests__/notificationService.test.ts
    lib/pwa/__tests__/pushSubscription.test.ts
    lib/pwa/__tests__/appBadge.test.ts
    lib/hue/__tests__/hueLocalHelper.test.ts
    lib/hue/__tests__/hueRemoteHelper.test.ts
    lib/hue/__tests__/hueScenes.test.ts
    lib/core/__tests__/requestParser.test.ts
    lib/utils/__tests__/pidController.test.ts
    lib/services/__tests__/deviceCache.test.ts
  </files>
  <action>
Fix all tsc errors in these 10 lib subdirectory test files (~70 errors total). Run `npx tsc --noEmit 2>&1 | grep "error TS" | grep -E "lib/pwa/__tests__|lib/hue/__tests__|lib/core/__tests__|lib/utils/__tests__|lib/services/__tests__"` to see exact errors.

**Per-directory patterns:**

**lib/pwa/__tests__/ (4 files, ~30 errors):**
- PWA tests mock browser APIs (navigator, Notification, ServiceWorker). These need proper typing:
  ```typescript
  const mockRegistration = { pushManager: { subscribe: jest.fn(), getSubscription: jest.fn() } } as unknown as ServiceWorkerRegistration;
  ```
- Mock `fetch` as `jest.MockedFunction<typeof fetch>` or use `jest.mocked(global.fetch)` if global.fetch is mocked.
- IndexedDB mocks need proper IDBDatabase/IDBObjectStore types.

**lib/hue/__tests__/ (3 files, ~20 errors):**
- Hue helper tests mock HTTP requests and Hue API responses. Type the mock responses using Hue types from `types/external-apis/hue.d.ts` if available, otherwise create inline interfaces.
- Apply `jest.mocked()` to all imported Hue utility functions.

**lib/core/__tests__/requestParser.test.ts (11 errors):**
- Request parser tests likely mock Next.js Request objects. Use proper Request constructor or `createMockNextRequest()` from mock utilities.

**lib/utils/__tests__/pidController.test.ts (16 errors):**
- Private member access errors (TS2341). Use bracket notation `controller['kp']` to bypass TypeScript private access checks in tests. This is a standard test pattern.
- String-to-number argument errors (TS2345). Fix by passing numbers instead of strings, or add `parseInt()` / `Number()` conversion.

**lib/services/__tests__/deviceCache.test.ts:**
- Apply jest.mocked() to cache service imports.

After fixing, run tests for all lib/ test files to verify no regressions.
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep "error TS" | grep -E "lib/(pwa|hue|core|utils|services)/__tests__" | wc -l` returns 0.
`npm test -- --testPathPattern="lib/(pwa|hue|core|utils|services)/__tests__" --silent` shows all tests passing.
  </verify>
  <done>All 10 lib subdirectory test files compile with zero tsc errors and all tests pass.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit 2>&1 | grep "error TS" | grep -E "^lib/" | wc -l` returns 0
- All lib/ test files' tests still pass
- Mock typing uses jest.mocked() pattern, NOT `as any`
- Firebase Timestamp mocks are properly typed
</verification>

<success_criteria>
- ~350 mock type errors eliminated across 19 lib/ test files
- All existing tests in these files continue to pass
- Firebase and service mock patterns established for consistency
</success_criteria>

<output>
After completion, create `.planning/phases/43-verification/43-04-SUMMARY.md`
</output>
