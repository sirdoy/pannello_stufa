---
phase: 43-verification
plan: 05
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - __tests__/lib/netatmoStoveSync.test.ts
  - __tests__/lib/coordinationOrchestrator.test.ts
  - __tests__/lib/netatmoApi.test.ts
  - __tests__/lib/healthMonitoring.test.ts
  - __tests__/lib/healthDeadManSwitch.test.ts
  - __tests__/lib/coordinationPreferences.test.ts
  - __tests__/lib/coordinationUserIntent.test.ts
  - __tests__/lib/coordinationState.test.ts
  - __tests__/lib/coordinationPauseCalculator.test.ts
  - __tests__/lib/netatmoCacheService.test.ts
  - __tests__/lib/netatmoCameraApi.test.ts
  - __tests__/stoveApi.sandbox.test.ts
  - __tests__/semiAutoMode.test.ts
  - __tests__/utils/scheduleHelpers.test.ts
  - __tests__/api/netatmo/schedules.test.ts
  - __tests__/api/geocoding/geocoding.test.ts
  - app/api/netatmo/setthermmode/__tests__/route.test.ts
  - app/api/netatmo/setroomthermpoint/__tests__/route.test.ts
  - app/api/hue/discover/__tests__/route.test.ts
  - __tests__/components/StoveCard.externalSync.test.tsx
  - __tests__/components/StoveSyncPanel.test.tsx
autonomous: true

must_haves:
  truths:
    - "All __tests__/ directory test files compile without tsc errors"
    - "Discriminated union property access uses proper type guards"
    - "Netatmo/coordination mocks properly typed with jest.mocked()"
    - "All existing tests still pass after type fixes"
  artifacts:
    - path: "__tests__/lib/netatmoStoveSync.test.ts"
      provides: "Netatmo stove sync tests with proper discriminated union typing"
      min_lines: 50
    - path: "__tests__/lib/coordinationOrchestrator.test.ts"
      provides: "Coordination tests with proper mock typing"
      min_lines: 50
  key_links:
    - from: "__tests__/lib/netatmoStoveSync.test.ts"
      to: "@/lib/netatmoStoveSync"
      via: "jest.mock + jest.mocked"
      pattern: "jest\\.mocked"
    - from: "__tests__/lib/healthDeadManSwitch.test.ts"
      to: "@/lib/healthDeadManSwitch"
      via: "discriminated union type guards"
      pattern: "'stale' in|'remaining' in"
---

<objective>
Fix mock type errors in 21 __tests__/ directory files and API route test files (~520 errors total). This includes the Netatmo/coordination cluster (high error count), health monitoring, API route tests, and component tests.

Purpose: The __tests__/ directory contains the second-largest cluster of mock type errors. The netatmoStoveSync.test.ts alone has 108 errors. Many files also have discriminated union type narrowing issues that need proper type guards.

Output: All 21 files compile with zero tsc errors while tests continue to pass.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-verification/43-RESEARCH.md
@.planning/phases/43-verification/43-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Netatmo, coordination, and health test mock types</name>
  <files>
    __tests__/lib/netatmoStoveSync.test.ts
    __tests__/lib/coordinationOrchestrator.test.ts
    __tests__/lib/netatmoApi.test.ts
    __tests__/lib/healthMonitoring.test.ts
    __tests__/lib/healthDeadManSwitch.test.ts
    __tests__/lib/coordinationPreferences.test.ts
    __tests__/lib/coordinationUserIntent.test.ts
    __tests__/lib/coordinationState.test.ts
    __tests__/lib/coordinationPauseCalculator.test.ts
    __tests__/lib/netatmoCacheService.test.ts
    __tests__/lib/netatmoCameraApi.test.ts
  </files>
  <action>
Fix all tsc errors in these 11 __tests__/lib/ files (~370 errors total). Run `npx tsc --noEmit 2>&1 | grep "error TS" | grep "__tests__/lib/"` to see exact errors.

**netatmoStoveSync.test.ts (108 errors):**
This is the highest-error test file in __tests__/. Errors likely include:
- Mock function typing: Apply `jest.mocked()` to all imports from `@/lib/netatmoStoveSync`, `@/lib/netatmoApi`, `@/lib/core/firebase-admin`
- Discriminated union errors: Properties like `remaining`, `resetInSeconds` accessed without type narrowing on RateLimitCheckResult. Use `'remaining' in result` guards or assert the specific union type in tests where the mock return value is known.
- Missing required properties in test fixtures: Add all required fields to mock data objects.

**coordinationOrchestrator.test.ts (45 errors):**
- Apply `jest.mocked()` to all coordination service imports
- Fix discriminated union property access with type guards
- Type coordination event objects properly

**healthDeadManSwitch.test.ts (18 errors) and healthMonitoring.test.ts (20 errors):**
- DeadManSwitchStatus is a discriminated union (stale: true | false). Test fixtures must include ALL required properties for the specific discriminant.
- For `stale: true`: must include `reason`, `elapsed`, `lastCheck`
- For `stale: false`: must include `elapsed`, `lastCheck`
- Apply `jest.mocked()` to health service imports

**coordination*.test.ts files (4 files, ~55 errors total):**
- Apply `jest.mocked()` pattern to all coordination imports
- Fix CacheResult discriminated union narrowing
- Type preference objects properly

**netatmoCacheService.test.ts (14 errors) and netatmoCameraApi.test.ts (11 errors):**
- Apply `jest.mocked()` to cache and camera API imports
- Type Netatmo data using types from `types/external-apis/netatmo.d.ts` if available

For discriminated unions, prefer using the `'in'` operator for type narrowing in test assertions:
```typescript
// Instead of: expect(result.remaining).toBe(5)
// Use:
if ('remaining' in result) {
  expect(result.remaining).toBe(5);
}
// Or if mock is known: const result = fn() as RateLimitAllowed;
```

In tests where the mock return value is KNOWN (you set it up in beforeEach), casting to the specific union member is acceptable since you control the data.
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep "error TS" | grep "__tests__/lib/" | wc -l` returns 0.
`npm test -- --testPathPattern="__tests__/lib/" --silent` shows all tests passing.
  </verify>
  <done>All 11 __tests__/lib/ files compile with zero tsc errors and all tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining __tests__/ and API route test mock types</name>
  <files>
    __tests__/stoveApi.sandbox.test.ts
    __tests__/semiAutoMode.test.ts
    __tests__/utils/scheduleHelpers.test.ts
    __tests__/api/netatmo/schedules.test.ts
    __tests__/api/geocoding/geocoding.test.ts
    app/api/netatmo/setthermmode/__tests__/route.test.ts
    app/api/netatmo/setroomthermpoint/__tests__/route.test.ts
    app/api/hue/discover/__tests__/route.test.ts
    __tests__/components/StoveCard.externalSync.test.tsx
    __tests__/components/StoveSyncPanel.test.tsx
  </files>
  <action>
Fix all tsc errors in these 10 remaining files (~150 errors total). Run `npx tsc --noEmit 2>&1 | grep "error TS" | grep -E "__tests__/(stoveApi|semiAutoMode|utils|api|components)|app/api/.*/route\.test"` to see exact errors.

**stoveApi.sandbox.test.ts (22 errors) and semiAutoMode.test.ts (18 errors):**
- Apply `jest.mocked()` to stove API and mode service imports
- Type stove API response objects properly

**scheduleHelpers.test.ts:**
- Fix type errors in schedule helper function test cases
- Ensure function parameter types match

**API route tests (schedules 15, geocoding 12, setthermmode 25, setroomthermpoint 18, hue/discover 11):**
- Apply `jest.mocked()` to all mocked service/handler imports
- For Next.js route tests: use `createMockNextRequest()` from mock utilities or type Request/Response properly
- For global.fetch mocks: `const mockFetch = global.fetch as jest.MockedFunction<typeof fetch>`
- Fix API response type mismatches in mock data

**Component tests (StoveCard.externalSync 16, StoveSyncPanel 11):**
- Apply `jest.mocked()` to component and service mocks
- Fix discriminant literal type mismatches in StoveCard test fixtures â€” ensure status/state properties use exact literal types matching the discriminated union
- Fix missing required props

After fixing, run all affected tests to verify no regressions.
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep "error TS" | grep -E "__tests__/(stoveApi|semiAutoMode|utils|api|components)|app/api/.*/route\.test" | wc -l` returns 0.
`npm test -- --testPathPattern="stoveApi|semiAutoMode|scheduleHelpers|schedules|geocoding|setthermmode|setroomthermpoint|discover|StoveCard|StoveSyncPanel" --silent` shows all tests passing.
  </verify>
  <done>All 10 remaining __tests__/ and API route test files compile with zero tsc errors and all tests pass.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit 2>&1 | grep "error TS" | grep -E "^__tests__/|app/api/.*/route\.test" | wc -l` returns 0
- All tests in these files still pass
- Discriminated union access uses proper type guards or known-type assertions
- Mock typing uses jest.mocked() pattern, NOT `as any`
</verification>

<success_criteria>
- ~520 mock and discriminated union type errors eliminated across 21 files
- All existing tests in these files continue to pass
- Netatmo/coordination/health test patterns established
</success_criteria>

<output>
After completion, create `.planning/phases/43-verification/43-05-SUMMARY.md`
</output>
