---
phase: 43-verification
plan: 07
type: execute
wave: 3
depends_on: ["43-02", "43-03", "43-04", "43-05", "43-06"]
files_modified:
  - __tests__/lib/healthDeadManSwitch.test.ts
  - __tests__/lib/healthLogger.test.ts
  - __tests__/lib/healthMonitoring.test.ts
  - __tests__/lib/netatmoApi.test.ts
  - __tests__/utils/scheduleHelpers.test.ts
  - app/components/navigation/__tests__/DropdownComponents.test.tsx
  - app/components/ui/__tests__/DashboardLayout.test.tsx
  - app/components/ui/__tests__/EmptyState.test.tsx
  - app/components/ui/__tests__/PageLayout.test.tsx
  - app/thermostat/page.test.tsx
  - __tests__/components/devices/thermostat/ThermostatCard.schedule.test.tsx
autonomous: true

must_haves:
  truths:
    - "npm test passes with zero failures (25 currently failing tests all fixed)"
    - "No test regressions from type error fixes in earlier plans"
    - "All 3037 tests pass (3012 currently passing + 25 currently failing)"
  artifacts:
    - path: "__tests__/lib/healthDeadManSwitch.test.ts"
      provides: "Fixed health dead man switch test"
      min_lines: 30
    - path: "app/components/ui/__tests__/PageLayout.test.tsx"
      provides: "Fixed PageLayout test with proper context providers"
      min_lines: 20
  key_links:
    - from: "test files"
      to: "source files"
      via: "import and test"
      pattern: "import.*from"
---

<objective>
Fix all 25 failing tests across 11 test suites. These are runtime test failures (not compile-time tsc errors).

Purpose: The user decision requires zero test failures. These 25 failures are a mix of pre-existing issues and migration-related problems. Each failing test needs diagnosis and a targeted fix.

Output: `npm test` passes with zero failures. All 3037 tests pass.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-verification/43-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix health, netatmo, and schedule test failures</name>
  <files>
    __tests__/lib/healthDeadManSwitch.test.ts
    __tests__/lib/healthLogger.test.ts
    __tests__/lib/healthMonitoring.test.ts
    __tests__/lib/netatmoApi.test.ts
    __tests__/utils/scheduleHelpers.test.ts
  </files>
  <action>
Fix the 6 failing tests in these 5 test suites. Run each test individually to see exact failure output.

**healthDeadManSwitch.test.ts (1 failure):**
"should return stale: true with reason: error on RTDB error"
- Run: `npm test -- --testPathPattern="healthDeadManSwitch" --verbose`
- Diagnose: Likely mock setup issue — the mock for RTDB error case is not returning expected format
- Fix based on actual error output. Check if the mock return value matches what the function expects.

**healthLogger.test.ts (1 failure):**
"getHealthStats calculates stats correctly"
- Run: `npm test -- --testPathPattern="healthLogger" --verbose`
- Diagnose: Likely stats calculation mismatch — mock data may be incomplete or wrong format
- Fix the test fixture data to match expected calculation output.

**healthMonitoring.test.ts (2 failures):**
"handles stove timeout gracefully" and "handles all API failures gracefully"
- Run: `npm test -- --testPathPattern="healthMonitoring" --verbose`
- Diagnose: Timeout handling and error case mocking. Check if mock rejections are properly set up.
- Fix mock setup to properly simulate timeout and API failure scenarios.

**netatmoApi.test.ts (1 failure):**
"parseModules should parse modules correctly"
- Run: `npm test -- --testPathPattern="netatmoApi" --verbose`
- Diagnose: Module parsing function likely returns different structure than test expects
- Fix by updating expected output or fixing mock input data to match actual parser behavior.

**scheduleHelpers.test.ts (1 failure):**
"getZoneColor should return default color for unknown zone types"
- Run: `npm test -- --testPathPattern="scheduleHelpers" --verbose`
- Diagnose: Likely color mapping function returns different default than test expects
- Fix by updating expected value to match actual function behavior, or fix the function if it's a real bug.

For each failure:
1. Run the specific test with --verbose
2. Read the error output carefully
3. Check the source function implementation to understand expected behavior
4. Fix the test OR the source code (if source has a bug)
5. Verify the fix by re-running the test
  </action>
  <verify>
`npm test -- --testPathPattern="healthDeadManSwitch|healthLogger|healthMonitoring|netatmoApi|scheduleHelpers" --verbose` shows all tests passing (0 failures).
  </verify>
  <done>All 6 failing tests in health, netatmo, and schedule test suites are fixed and passing.</done>
</task>

<task type="auto">
  <name>Task 2: Fix UI component and page test failures</name>
  <files>
    app/components/navigation/__tests__/DropdownComponents.test.tsx
    app/components/ui/__tests__/DashboardLayout.test.tsx
    app/components/ui/__tests__/EmptyState.test.tsx
    app/components/ui/__tests__/PageLayout.test.tsx
    app/thermostat/page.test.tsx
    __tests__/components/devices/thermostat/ThermostatCard.schedule.test.tsx
  </files>
  <action>
Fix the 19 remaining failing tests across these 6 test suites.

**DropdownComponents.test.tsx (5 failures):**
"renders with label and icon", "renders with description", "applies active state correctly", "renders standard menu item", "applies prominent variant correctly"
- Run: `npm test -- --testPathPattern="DropdownComponents" --verbose`
- Diagnose: Likely component props or rendering mismatch. The DropdownItem and MenuItem components may have changed their API during migration.
- Check the actual component source and update tests to match current API.

**DashboardLayout.test.tsx (3 failures):**
"returns default context values when used outside provider", "renders main content", "accepts custom className"
- Run: `npm test -- --testPathPattern="DashboardLayout" --verbose`
- Diagnose: Sidebar context and MainContent component testing issues. May need proper provider wrapping.
- Fix context provider setup or test expectations.

**EmptyState.test.tsx (1 failure):**
"uses semantic heading for title"
- Run: `npm test -- --testPathPattern="EmptyState" --verbose`
- Diagnose: Heading element not found or wrong semantic level. Check component source for heading tag.
- Fix test expectation to match actual heading element.

**PageLayout.test.tsx (6 failures):**
"renders with default props", "renders all slots together", "renders children", "has flex-1 for growth", "accepts custom className", "has proper landmark structure"
- Run: `npm test -- --testPathPattern="PageLayout" --verbose`
- Diagnose: PageLayout is a layout component. Tests may be checking internal implementation details that changed.
- Check PageLayout.tsx source for current structure and update tests accordingly. May need to update CSS class expectations, slot rendering, or landmark structure.

**thermostat/page.test.tsx (1 failure):**
"should not redirect when connected"
- Run: `npm test -- --testPathPattern="thermostat/page.test" --verbose`
- Diagnose: Redirect logic test. Mock for Netatmo connection status may be wrong.
- Fix mock setup for connected state.

**ThermostatCard.schedule.test.tsx (3 failures):**
"shows schedule selector when connected", "shows loading spinner while schedule data loads", "shows empty state when no schedules"
- Run: `npm test -- --testPathPattern="ThermostatCard.schedule" --verbose`
- Diagnose: Schedule display tests. Mock data for schedules may be missing or wrong format. waitFor timeout suggests async rendering issues.
- Fix by updating mock data and potentially adjusting async waitFor patterns.

For each suite:
1. Run with --verbose to see exact error
2. Read source component to understand current behavior
3. Fix test to match current component API/behavior
4. Re-run to verify fix
5. Run full test suite at the end to catch any regressions
  </action>
  <verify>
`npm test -- --testPathPattern="DropdownComponents|DashboardLayout|EmptyState|PageLayout|thermostat/page\.test|ThermostatCard\.schedule" --verbose` shows all tests passing (0 failures).
Then run full suite: `npm test --silent` — expect 0 failures, 3037 passed.
  </verify>
  <done>All 19 remaining failing tests are fixed. Full test suite passes with zero failures (3037/3037 or more tests passing).</done>
</task>

</tasks>

<verification>
- `npm test --silent` shows "Test Suites: X passed, X total" with 0 failed
- `npm test --silent` shows "Tests: Y passed, Y total" with 0 failed
- No test regressions introduced by earlier plans' type fixes
</verification>

<success_criteria>
- All 25 currently failing tests are fixed and passing
- Total test suite: zero failures
- No new test failures introduced
</success_criteria>

<output>
After completion, create `.planning/phases/43-verification/43-07-SUMMARY.md`
</output>
