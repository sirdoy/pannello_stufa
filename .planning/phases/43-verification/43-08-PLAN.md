---
phase: 43-verification
plan: 08
type: execute
wave: 4
depends_on: ["43-07"]
files_modified:
  - postcss.config.js
  - postcss.config.mjs
  - next.config.mjs
  - eslint.config.mjs
  - tsconfig.json
autonomous: false

must_haves:
  truths:
    - "tsc --noEmit passes with exit code 0 (zero errors)"
    - "npm test passes with zero failures"
    - "npm run build completes successfully"
    - "allowJs is disabled in tsconfig.json"
    - "No .js/.jsx source files remain (only generated/vendor in public/)"
    - "Dev server starts and serves pages"
  artifacts:
    - path: "postcss.config.ts"
      provides: "PostCSS config in TypeScript"
      min_lines: 3
    - path: "next.config.ts"
      provides: "Next.js config in TypeScript with NextConfig type"
      min_lines: 20
    - path: "tsconfig.json"
      provides: "tsconfig with allowJs: false"
      contains: "\"allowJs\": false"
  key_links:
    - from: "tsconfig.json"
      to: "all .ts/.tsx files"
      via: "TypeScript compilation"
      pattern: "\"allowJs\": false"
    - from: "next.config.ts"
      to: "Next.js build system"
      via: "build configuration"
      pattern: "NextConfig"
---

<objective>
Convert remaining config files to TypeScript, run final validation (tsc, tests, build), disable allowJs, and verify the complete TypeScript migration.

Purpose: This is the final lockdown plan. Config file conversion completes VERIFY-03 (zero JS files). Build validation completes VERIFY-01. tsc validation completes VERIFY-02. Dev server test completes VERIFY-04. Disabling allowJs prevents future regression.

Output: All verification requirements met. TypeScript migration is complete.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-verification/43-RESEARCH.md
@tsconfig.json
@next.config.mjs
@postcss.config.js
@eslint.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert config files to TypeScript and run full validation</name>
  <files>
    postcss.config.js
    postcss.config.mjs
    next.config.mjs
    eslint.config.mjs
    tsconfig.json
  </files>
  <action>
**Step 1: Pre-validation (verify previous plans succeeded):**
Run `npx tsc --noEmit 2>&1 | tail -5` to confirm 0 errors.
Run `npm test --silent 2>&1 | tail -5` to confirm 0 failures.
If either has remaining errors, document them and fix before proceeding.

**Step 2: Convert postcss.config.js to postcss.config.ts:**
- There are two PostCSS config files: `postcss.config.js` (CommonJS) and `postcss.config.mjs` (ESM).
- Create `postcss.config.ts`:
  ```typescript
  const config = {
    plugins: {
      '@tailwindcss/postcss': {},
      autoprefixer: {},
    },
  };
  export default config;
  ```
- Delete both `postcss.config.js` and `postcss.config.mjs` (use `git rm`).
- Note: PostCSS v8+ supports TypeScript config files natively.

**Step 3: Convert next.config.mjs to next.config.ts:**
- Read current `next.config.mjs` fully.
- Create `next.config.ts` with `import type { NextConfig } from 'next'`:
  ```typescript
  import type { NextConfig } from 'next';
  import withSerwistInit from '@serwist/next';
  // ... rest of config with proper typing
  const nextConfig: NextConfig = { ... };
  export default withSerwist(nextConfig);
  ```
- Remove `/** @type {import('next').NextConfig} */` JSDoc comment (replaced by type annotation).
- Remove `import { fileURLToPath } from 'url'` and `import { dirname, resolve } from 'path'` if they can be replaced with TypeScript equivalents, or keep them with proper types.
- Delete `next.config.mjs` (use `git rm`).

**Step 4: Convert eslint.config.mjs to eslint.config.ts:**
- Read current `eslint.config.mjs` fully.
- Rename to `eslint.config.ts` (use `git mv`).
- Add proper TypeScript types for the ESLint flat config if available, or keep as-is since the content is already valid TypeScript.
- ESLint 9+ flat config supports .ts extension natively.

**Step 5: Update tsconfig.json:**
- First verify `tsc --noEmit` still passes with 0 errors after config changes.
- Set `"allowJs": false` (was `true`).
- Remove `"**/*.js"` and `"**/*.jsx"` from `include` array (no longer needed).
- Keep `"exclude": ["node_modules", "public/sw.js"]`.
- Run `npx tsc --noEmit` again to verify enforcement works.

**Step 6: Verify no JS source files remain:**
- Run `find app lib components __tests__ -name "*.js" -o -name "*.jsx" | grep -v node_modules`
- Should return empty (0 files).
- Run `ls *.config.js *.config.mjs 2>/dev/null` — should return nothing.

**Step 7: Full validation suite:**
- `npx tsc --noEmit` — must exit 0
- `npm test --silent` — must show 0 failures
- `npm run build` — must complete successfully (CAUTION: project rule says NEVER run npm run build, but user decision explicitly requires this as final verification. Run ONCE.)

**Step 8: Dev server smoke test:**
- Start `npm run dev` in background
- Wait for server to be ready
- Curl or fetch the following pages and verify 200 status:
  - `http://localhost:3000/` (home)
  - `http://localhost:3000/stove` (stove page)
  - `http://localhost:3000/lights` (lights page)
  - `http://localhost:3000/thermostat` (thermostat page)
- Stop the dev server

If any validation step fails, diagnose and fix before proceeding. Document any issues encountered.
  </action>
  <verify>
All 7 verification checks pass:
1. `npx tsc --noEmit` exits with code 0
2. `npm test --silent` shows 0 failures
3. `npm run build` completes successfully
4. `find app lib components __tests__ -name "*.js" -o -name "*.jsx"` returns empty
5. `ls *.config.js *.config.mjs 2>/dev/null` returns nothing
6. `grep "allowJs" tsconfig.json` shows `"allowJs": false`
7. Dev server starts and serves pages with 200 status
  </verify>
  <done>
All verification requirements met:
- VERIFY-01: `npm run build` completes without errors
- VERIFY-02: `tsc --noEmit` passes with exit code 0
- VERIFY-03: Zero .js/.jsx source files remaining
- VERIFY-04: Dev server works correctly
- allowJs disabled: Future JS files cause compile errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete TypeScript migration verification:
- All config files converted to TypeScript (postcss, next.config, eslint)
- tsc --noEmit passes with 0 errors
- npm test passes with 0 failures
- npm run build completes successfully
- allowJs disabled in tsconfig.json
- Zero JS source files remaining
  </what-built>
  <how-to-verify>
1. Run `npx tsc --noEmit` — verify exit code 0
2. Run `npm test` — verify all tests pass
3. Run `npm run dev` — verify app loads at localhost:3000
4. Navigate to key pages: /, /stove, /lights, /thermostat, /camera
5. Verify all pages render correctly without console errors
6. Check `tsconfig.json` — confirm `allowJs: false`
7. Try creating a .js file in app/ — verify tsc reports an error (optional)
  </how-to-verify>
  <resume-signal>Type "approved" to confirm migration is complete, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Complete v5.0 TypeScript migration verification checklist:
- [ ] `npx tsc --noEmit` — exit code 0, zero errors
- [ ] `npm test` — all tests pass, zero failures
- [ ] `npm run build` — successful completion
- [ ] `find app lib components __tests__ -name "*.js" -o -name "*.jsx"` — empty
- [ ] `tsconfig.json` has `allowJs: false`
- [ ] Dev server starts and pages load correctly
- [ ] No .config.js or .config.mjs files remain at project root
</verification>

<success_criteria>
- All 4 verification requirements (VERIFY-01 through VERIFY-04) are met
- TypeScript migration is 100% complete
- allowJs is disabled, preventing future JS file introduction
- User confirms the application works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/43-verification/43-08-SUMMARY.md`
</output>
