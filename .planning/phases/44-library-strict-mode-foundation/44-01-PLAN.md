---
phase: 44-library-strict-mode-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tsconfig.json
  - lib/sandboxService.ts
  - lib/healthMonitoring.ts
  - lib/healthLogger.ts
  - lib/hlsDownloader.ts
  - lib/migrateSchedules.ts
  - lib/commands/deviceCommands.tsx
  - lib/repositories/base/BaseRepository.ts
  - lib/maintenanceServiceAdmin.ts
  - lib/devicePreferencesService.ts
autonomous: true

must_haves:
  truths:
    - "strict: true is enabled in tsconfig.json"
    - "All miscellaneous lib/ files (health, sandbox, repositories, commands, utils) have zero tsc errors"
    - "Existing tests still pass after strict mode is enabled"
  artifacts:
    - path: "tsconfig.json"
      provides: "strict: true compiler option"
      contains: '"strict": true'
    - path: "lib/sandboxService.ts"
      provides: "Typed sandbox service"
    - path: "lib/healthMonitoring.ts"
      provides: "Typed health monitoring"
    - path: "lib/healthLogger.ts"
      provides: "Typed health logger"
  key_links:
    - from: "tsconfig.json"
      to: "all .ts/.tsx files"
      via: "TypeScript compiler"
      pattern: '"strict": true'
---

<objective>
Enable `strict: true` in tsconfig.json and fix all strict-mode errors in miscellaneous lib/ files (health, sandbox, repositories, commands, migration utilities).

Purpose: This is the foundation step — enabling strict mode affects the entire codebase, but this plan only fixes the small/miscellaneous lib/ files (27 errors across 9 files). Subsequent plans fix the larger subsystems in parallel.

Output: tsconfig.json with strict mode enabled, 9 miscellaneous lib/ files with zero strict-mode errors.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable strict mode in tsconfig.json</name>
  <files>tsconfig.json</files>
  <action>
Change `"strict": false` to `"strict": true` in tsconfig.json compilerOptions.

This single change enables all strict sub-flags:
- noImplicitAny
- strictNullChecks
- strictFunctionTypes
- strictBindCallApply
- strictPropertyInitialization
- noImplicitThis
- useUnknownInCatchVariables
- alwaysStrict

Do NOT add any other compiler options (noUncheckedIndexedAccess comes in phase 47).
Do NOT add any path exclusions or overrides — errors in non-lib files will be fixed in phases 45-47.

After enabling, run `npx tsc --noEmit 2>&1 | wc -l` to record the total error count baseline for tracking purposes.
  </action>
  <verify>
Run: `grep '"strict": true' tsconfig.json` — must match.
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/" | wc -l` — record baseline (expected ~377 lib/ errors).
  </verify>
  <done>"strict": true is set in tsconfig.json and baseline error count is recorded.</done>
</task>

<task type="auto">
  <name>Task 2: Fix strict-mode errors in miscellaneous lib/ files</name>
  <files>
    lib/sandboxService.ts
    lib/healthMonitoring.ts
    lib/healthLogger.ts
    lib/hlsDownloader.ts
    lib/migrateSchedules.ts
    lib/commands/deviceCommands.tsx
    lib/repositories/base/BaseRepository.ts
    lib/maintenanceServiceAdmin.ts
    lib/devicePreferencesService.ts
  </files>
  <action>
Fix all strict-mode tsc errors in these 9 files (27 errors total). Error patterns to fix:

**TS7006 (noImplicitAny):** Add explicit parameter types. Look at how the parameter is used in the function body to determine the correct type. Use existing types from `types/` directory when available. For callback parameters in `.forEach()`, `.map()`, `.filter()`, type the array variable and let inference handle it, OR type the callback parameter directly.

**TS18046 (unknown type in catch):** Replace bare `error` access with type guards:
```typescript
catch (error: unknown) {
  const message = error instanceof Error ? error.message : String(error);
}
```

**TS18048/TS2532 (possibly undefined):** Add null checks or optional chaining (`?.`). Use non-null assertion (`!`) only when logically guaranteed.

**TS7053 (implicit any from index expression):** Add proper index signatures or use type assertions with Record<string, T>.

**TS2345 (argument type mismatch):** Fix type narrowing or add proper type assertions.

**TS7034/TS7005 (implicit any[] variable):** Add explicit type annotations to variable declarations:
```typescript
const items: string[] = [];  // instead of: const items = [];
```

**TS2339 (property does not exist):** Add proper interface definitions or type guards.

For each file:
1. Run `npx tsc --noEmit 2>&1 | grep "^{filename}"` to see exact errors
2. Read the file to understand context
3. Apply the minimal fix for each error
4. Verify the file has zero errors after fixes

Do NOT refactor or restructure code. Only add/change types to satisfy strict mode.
Use pragmatic `as any` ONLY for truly untyped external API responses (Hue/Netatmo/OpenMeteo) — per project convention.
  </action>
  <verify>
Run for each file: `npx tsc --noEmit 2>&1 | grep "^lib/sandboxService.ts"` (repeat for each file) — must show zero errors.
Combined check: `npx tsc --noEmit 2>&1 | grep -E "^lib/(sandboxService|healthMonitoring|healthLogger|hlsDownloader|migrateSchedules|commands/deviceCommands|repositories/base/BaseRepository|maintenanceServiceAdmin|devicePreferencesService)" | wc -l` — must be 0.
  </verify>
  <done>All 9 miscellaneous lib/ files produce zero tsc errors under strict mode.</done>
</task>

</tasks>

<verification>
1. `grep '"strict": true' tsconfig.json` — confirms strict mode enabled
2. `npx tsc --noEmit 2>&1 | grep -E "^lib/(sandboxService|healthMonitoring|healthLogger|hlsDownloader|migrateSchedules|commands/|repositories/|maintenanceServiceAdmin|devicePreferencesService)" | wc -l` — must be 0
3. `npm test -- --testPathPattern="lib/__tests__/(sandbox|health|maintenance)" --passWithNoTests 2>&1 | tail -5` — tests still pass
</verification>

<success_criteria>
- strict: true enabled in tsconfig.json
- All 9 miscellaneous lib/ files have zero tsc strict-mode errors
- No behavioral changes to any function
</success_criteria>

<output>
After completion, create `.planning/phases/44-library-strict-mode-foundation/44-01-SUMMARY.md`
</output>
