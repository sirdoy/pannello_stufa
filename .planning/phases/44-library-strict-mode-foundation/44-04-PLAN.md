---
phase: 44-library-strict-mode-foundation
plan: 04
type: execute
wave: 2
depends_on: ["44-01"]
files_modified:
  - lib/firebaseAdmin.ts
  - lib/tokenRefresh.ts
  - lib/services/unifiedDeviceConfigService.ts
  - lib/services/StoveService.ts
  - lib/services/pidAutomationService.ts
autonomous: true

must_haves:
  truths:
    - "firebaseAdmin.ts has zero tsc errors under strict mode"
    - "tokenRefresh.ts has zero tsc errors under strict mode"
    - "All lib/services/ files have zero tsc errors under strict mode"
  artifacts:
    - path: "lib/firebaseAdmin.ts"
      provides: "Strictly typed Firebase Admin SDK wrapper"
    - path: "lib/services/unifiedDeviceConfigService.ts"
      provides: "Strictly typed device config service"
    - path: "lib/tokenRefresh.ts"
      provides: "Strictly typed token refresh logic"
  key_links:
    - from: "lib/firebaseAdmin.ts"
      to: "firebase-admin SDK"
      via: "Firebase Admin imports"
      pattern: "import.*firebase-admin"
    - from: "lib/services/unifiedDeviceConfigService.ts"
      to: "lib/firebaseAdmin.ts"
      via: "Firebase database operations"
      pattern: "import.*firebaseAdmin"
---

<objective>
Fix all strict-mode tsc errors in Firebase Admin, token refresh, and service layer files (79 errors across 5 files).

Purpose: These files form the core infrastructure layer — Firebase Admin wraps all database/messaging operations, token refresh handles auth, and the service files manage device configuration, stove control, and PID automation. Type safety here prevents runtime errors in critical paths.

Output: 5 infrastructure/service files with zero tsc strict-mode errors.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/firebaseAdmin.ts
@lib/tokenRefresh.ts
@lib/services/unifiedDeviceConfigService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix strict-mode errors in firebaseAdmin.ts and tokenRefresh.ts</name>
  <files>
    lib/firebaseAdmin.ts
    lib/tokenRefresh.ts
  </files>
  <action>
Fix all strict-mode errors in these 2 files (42 errors total: 30 + 12).

**firebaseAdmin.ts (30 errors, 639 lines):**
This is the Firebase Admin SDK wrapper. Error patterns:
- TS7006: Parameters like `token`, `errorData`, `invalidToken`, `path`, `updateFunction`, `tokens`, `notification` need explicit types
- TS7053: Index expression `users/${string}/fcmTokens/${string}` can't index type `{}` — use `Record<string, unknown>` or proper Firebase path typing
- TS7034/TS7005: `invalidTokens` implicitly has `any[]` — add explicit `string[]` type
- TS2339: `userId`/`deviceId` don't exist on type `never` — fix type narrowing (likely a union type issue or empty array type)
- TS18046: `error` is of type `unknown` — use `error instanceof Error` guard

For Firebase-specific types:
```typescript
import { Database } from 'firebase-admin/database';
import { Messaging, Message, MulticastMessage } from 'firebase-admin/messaging';
```

For the `runTransaction` wrapper: type `path` as `string` and `updateFunction` as `(currentData: unknown) => unknown`.
For `sendToDevices`: type `tokens` as `string[]` and `notification` using the Firebase `Notification` type or a custom interface.

**tokenRefresh.ts (12 errors, 239 lines):**
Token refresh/rotation logic. Fix TS7006 on token parameters and any TS18046 catch blocks. Token values are typically `string` type.

Do NOT change function behavior — only add types.
Use `as any` for Firebase Admin SDK calls where the SDK's own types are inadequate (per project convention for external APIs).
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep "^lib/firebaseAdmin.ts" | wc -l` — must be 0.
Run: `npx tsc --noEmit 2>&1 | grep "^lib/tokenRefresh.ts" | wc -l` — must be 0.
  </verify>
  <done>firebaseAdmin.ts (0 errors) and tokenRefresh.ts (0 errors) under strict mode.</done>
</task>

<task type="auto">
  <name>Task 2: Fix strict-mode errors in unifiedDeviceConfigService.ts, StoveService.ts, pidAutomationService.ts</name>
  <files>
    lib/services/unifiedDeviceConfigService.ts
    lib/services/StoveService.ts
    lib/services/pidAutomationService.ts
  </files>
  <action>
Fix all strict-mode errors in these 3 files (37 errors total: 28 + 5 + 4).

**unifiedDeviceConfigService.ts (28 errors, 322 lines):**
Device configuration CRUD. Likely patterns:
- TS7006: Config object parameters, callback parameters
- TS18048/TS2532: Possibly undefined config reads from Firebase
- TS7053: Dynamic property access on config objects

For device config, check `types/config/` for existing interfaces. If none exist, define based on the actual data shape used in the file. Use `Record<string, DeviceConfig>` for collections.

**StoveService.ts (5 errors, 181 lines):**
Thermorossi stove control service. Fix parameter types — stove commands and status objects should have clear types.

**pidAutomationService.ts (4 errors, 139 lines):**
PID automation controller. Fix parameter types for PID parameters (setpoint, kp, ki, kd are typically `number`).

For all files:
1. Run `npx tsc --noEmit 2>&1 | grep "^{filename}"` to see exact errors
2. Add explicit types using existing `types/` definitions where available
3. Add null guards for strictNullChecks
4. Handle unknown catch blocks

Do NOT change function behavior — only add types.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/services/(unifiedDeviceConfigService|StoveService|pidAutomationService)" | wc -l` — must be 0.
  </verify>
  <done>All 3 service files have zero tsc errors under strict mode.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -E "^lib/(firebaseAdmin|tokenRefresh|services/)" | wc -l` — must be 0
2. `npm test -- --testPathPattern="(firebase|token|stove|pid|device)" --passWithNoTests 2>&1 | tail -5` — related tests still pass
</verification>

<success_criteria>
- firebaseAdmin.ts: 0 tsc errors (was 30)
- tokenRefresh.ts: 0 tsc errors (was 12)
- unifiedDeviceConfigService.ts: 0 tsc errors (was 28)
- StoveService.ts: 0 tsc errors (was 5)
- pidAutomationService.ts: 0 tsc errors (was 4)
- No behavioral changes to any function
</success_criteria>

<output>
After completion, create `.planning/phases/44-library-strict-mode-foundation/44-04-SUMMARY.md`
</output>
