---
phase: 44-library-strict-mode-foundation
plan: 07
type: execute
wave: 3
depends_on: ["44-02", "44-03", "44-04", "44-05", "44-06"]
files_modified:
  - lib/__tests__/errorMonitor.test.ts
  - lib/__tests__/netatmoApi.test.ts
  - lib/__tests__/schedulerService.test.ts
  - lib/__tests__/maintenanceService.test.ts
  - lib/__tests__/logService.test.ts
autonomous: true

must_haves:
  truths:
    - "All lib/__tests__/ files have zero tsc errors under strict mode"
    - "All lib/ files (source + tests) produce zero tsc errors combined"
    - "All lib/ tests pass green (npm test)"
  artifacts:
    - path: "lib/__tests__/errorMonitor.test.ts"
      provides: "Strictly typed error monitor tests"
    - path: "lib/__tests__/netatmoApi.test.ts"
      provides: "Strictly typed netatmo API tests"
    - path: "lib/__tests__/schedulerService.test.ts"
      provides: "Strictly typed scheduler tests"
  key_links:
    - from: "lib/__tests__/*.test.ts"
      to: "lib/*.ts"
      via: "import and test"
      pattern: "import.*from.*@/lib/"
---

<objective>
Fix all strict-mode tsc errors in lib/ test files and verify the entire lib/ directory is error-free (16 test errors across 5 files + final verification).

Purpose: This is the final plan for phase 44 — fix the remaining test file errors and run comprehensive verification to confirm all lib/ files (source + tests) produce zero tsc errors under strict mode.

Output: 5 test files with zero errors, final verification that `npx tsc --noEmit 2>&1 | grep -E "^lib/" | wc -l` returns 0.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix strict-mode errors in all lib/ test files</name>
  <files>
    lib/__tests__/errorMonitor.test.ts
    lib/__tests__/netatmoApi.test.ts
    lib/__tests__/schedulerService.test.ts
    lib/__tests__/maintenanceService.test.ts
    lib/__tests__/logService.test.ts
  </files>
  <action>
Fix all 16 strict-mode errors across 5 test files.

**Error breakdown:**
- errorMonitor.test.ts: 8 errors (578 lines)
- netatmoApi.test.ts: 3 errors (356 lines)
- schedulerService.test.ts: 2 errors (680 lines)
- maintenanceService.test.ts: 2 errors (711 lines)
- logService.test.ts: 1 error (336 lines)

**Common test error patterns:**

**TS2790 (operand of delete must be optional):**
5 errors of this type. In test setup/teardown, `delete` is used on required properties. Fix by making the property optional in the test context:
```typescript
// Instead of: delete process.env.SOME_VAR
// Use: delete (process.env as Record<string, string | undefined>).SOME_VAR
```

**TS2345 (argument type mismatch):**
4 errors. Mock data doesn't match expected types. Fix by:
- Using `as` assertions on mock data: `mockData as SomeType`
- Or completing the mock data to satisfy the interface
- Use `jest.mocked()` for proper mock typing (per project convention)

**TS7006 (noImplicitAny):**
3 errors. Add explicit types to test parameters, typically in `.forEach()` callbacks or mock function parameters.

**TS18048 (possibly undefined):**
2 errors. Add null checks or assertions on test data.

**TS7034/TS7005 (implicit any[]):**
2 errors. Add explicit type annotations to test arrays.

For each file:
1. Run `npx tsc --noEmit 2>&1 | grep "^{filename}"` to see exact errors
2. Apply the minimal type fix
3. Verify the test still runs: `npm test -- --testPathPattern="{testname}" 2>&1 | tail -3`

Do NOT change test assertions or test logic — only add types.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/__tests__/" | wc -l` — must be 0.
Run: `npm test -- --testPathPattern="lib/__tests__/(errorMonitor|netatmoApi|schedulerService|maintenanceService|logService)" 2>&1 | tail -5` — all tests pass.
  </verify>
  <done>All 5 lib/ test files have zero tsc errors and all tests pass green.</done>
</task>

<task type="auto">
  <name>Task 2: Final lib/ verification and gap sweep</name>
  <files></files>
  <action>
Run comprehensive verification to confirm the entire lib/ directory is error-free.

**Step 1: Check all lib/ errors:**
```bash
npx tsc --noEmit 2>&1 | grep -E "^lib/" | wc -l
```
Must return 0.

**Step 2: If any errors remain, fix them.**
Some errors may have been introduced by fixes in Wave 2 plans (e.g., type changes in source files causing new mismatches in other lib/ files that import them). If this happens:
- Identify the affected files
- Apply minimal type fixes
- Re-run verification

**Step 3: Run all lib/ tests:**
```bash
npm test -- --testPathPattern="lib/__tests__/" 2>&1 | tail -10
```
All tests must pass.

**Step 4: Record final metrics:**
- Total lib/ source files: count
- Total lib/ test files: count
- Total tsc errors in lib/: 0
- Tests passing: all

This is a sweep task — it may have no files to modify if Wave 2 plans were clean, or it may need to fix cascade issues.
  </action>
  <verify>
Run: `npx tsc --noEmit 2>&1 | grep -E "^lib/" | wc -l` — MUST be 0.
Run: `npm test -- --testPathPattern="lib/__tests__/" 2>&1 | tail -5` — all pass.
  </verify>
  <done>Zero tsc errors in all lib/ files (source + tests). All lib/ tests pass green. Phase 44 success criteria met.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit 2>&1 | grep -E "^lib/" | wc -l` — MUST return 0 (the definitive phase 44 success metric)
2. `npm test -- --testPathPattern="lib/__tests__/" 2>&1 | tail -10` — all lib/ tests pass
3. `grep '"strict": true' tsconfig.json` — confirms strict mode still enabled
4. `npx tsc --noEmit 2>&1 | wc -l` — record total remaining errors (non-lib, for phases 45-47)
</verification>

<success_criteria>
- `npx tsc --noEmit 2>&1 | grep -E "^lib/" | wc -l` returns exactly 0
- All lib/ tests pass with `npm test -- --testPathPattern="lib/__tests__/"`
- strict: true remains enabled in tsconfig.json
- Total remaining non-lib errors recorded for subsequent phases
</success_criteria>

<output>
After completion, create `.planning/phases/44-library-strict-mode-foundation/44-07-SUMMARY.md`
</output>
