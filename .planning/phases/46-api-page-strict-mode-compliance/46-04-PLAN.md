---
phase: 46-api-page-strict-mode-compliance
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/hue/remote/pair/route.ts
  - app/api/hue/lights/[id]/route.ts
  - app/api/hue/rooms/[id]/route.ts
  - app/api/hue/scenes/[id]/route.ts
  - app/api/hue/scenes/[id]/activate/route.ts
  - app/api/netatmo/camera/[cameraId]/snapshot/route.ts
  - app/api/netatmo/camera/[cameraId]/events/route.ts
  - app/api/netatmo/setroomthermpoint/route.ts
  - app/api/netatmo/setthermmode/route.ts
  - app/api/netatmo/stove-sync/route.ts
  - app/api/stove/ignite/route.ts
  - app/api/stove/shutdown/route.ts
autonomous: true

must_haves:
  truths:
    - "All Hue API routes compile with zero tsc strict-mode errors"
    - "All Netatmo API routes compile with zero tsc strict-mode errors"
    - "Stove ignite and shutdown routes compile with zero tsc strict-mode errors"
    - "AuthedHandler signature mismatch fixed in all affected routes"
  artifacts:
    - path: "app/api/hue/lights/[id]/route.ts"
      provides: "Strict-mode compliant Hue light route"
    - path: "app/api/hue/remote/pair/route.ts"
      provides: "Strict-mode compliant Hue pair route"
  key_links:
    - from: "app/api/hue/lights/[id]/route.ts"
      to: "lib/core/middleware.ts"
      via: "withAuth/withHueHandler wrapping"
      pattern: "withAuth|withHueHandler"
---

<objective>
Fix 22 strict-mode TypeScript errors across 12 API route files for Hue, Netatmo, and Stove endpoints.

Purpose: These routes share a common pattern — AuthedHandler signature mismatch (TS2345) and possibly-undefined property access (TS18048). One consistent fix approach covers all routes.
Output: All 12 API route files with zero tsc strict-mode errors.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/core/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AuthedHandler signature mismatch in Hue/Netatmo/Notification routes</name>
  <files>
    app/api/hue/lights/[id]/route.ts
    app/api/hue/rooms/[id]/route.ts
    app/api/hue/scenes/[id]/route.ts
    app/api/hue/scenes/[id]/activate/route.ts
    app/api/netatmo/camera/[cameraId]/events/route.ts
    app/api/netatmo/camera/[cameraId]/snapshot/route.ts
  </files>
  <action>
**TS2345 AuthedHandler mismatch — 9 errors across 6 files:**

The `AuthedHandler` type in `lib/core/middleware.ts` expects:
```typescript
type AuthedHandler = (
  request: NextRequest,
  context: RouteContext,
  session: Session
) => Promise<NextResponse>;
```

But the route handlers are typed as returning `Promise<NextResponse<unknown>>`. The fix is to ensure the handler functions match the AuthedHandler signature exactly. Options:

1. **Preferred: Remove explicit return type from handler functions** — let TypeScript infer `Promise<NextResponse>` instead of `Promise<NextResponse<unknown>>`
2. Alternative: Cast the handler `as AuthedHandler` when passing to withAuth/withHueHandler

For each affected route, check the handler function signature and remove the explicit `NextResponse<unknown>` return type annotation, or change it to `NextResponse`.

**Affected files (all same pattern):**
- `app/api/hue/lights/[id]/route.ts` lines 31, 42 — 2 handlers
- `app/api/hue/rooms/[id]/route.ts` lines 31, 42 — 2 handlers
- `app/api/hue/scenes/[id]/route.ts` lines 43, 124 — 2 handlers
- `app/api/hue/scenes/[id]/activate/route.ts` line 23 — 1 handler
- `app/api/netatmo/camera/[cameraId]/events/route.ts` line 25 — 1 handler
- `app/api/netatmo/camera/[cameraId]/snapshot/route.ts` line 33 — 1 handler

Also fix the additional error in snapshot route:
- Line 49: `cameraData.cameras` possibly undefined (TS18048) — add `if (!cameraData.cameras)` guard
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "app/api/(hue|netatmo/camera)" | wc -l should return 0</verify>
  <done>Zero tsc errors in all Hue and Netatmo camera API routes. AuthedHandler mismatch and null checks fixed.</done>
</task>

<task type="auto">
  <name>Task 2: Fix Hue pair, Netatmo thermostat, and Stove route errors</name>
  <files>
    app/api/hue/remote/pair/route.ts
    app/api/netatmo/setroomthermpoint/route.ts
    app/api/netatmo/setthermmode/route.ts
    app/api/netatmo/stove-sync/route.ts
    app/api/stove/ignite/route.ts
    app/api/stove/shutdown/route.ts
  </files>
  <action>
**app/api/hue/remote/pair/route.ts — 7 errors (all TS18048 possibly undefined):**
- Line 73: `hasError.error` possibly undefined — add `if (hasError.error)` guard
- Line 81: same pattern
- Line 134: `errorItem.error` possibly undefined — add guard
- Line 143: same
- Lines 149-151: `successItem.success` possibly undefined — add `if (successItem.success)` guard before the block

These are Hue bridge pairing response items with optional error/success properties. Add null guards before accessing.

**app/api/netatmo/setroomthermpoint/route.ts — 2 errors (TS2322):**
- Lines 70-71: `string | undefined` not assignable to `string` — use `value ?? ''` or add `!` non-null assertion if the value is validated earlier

**app/api/netatmo/setthermmode/route.ts — 1 error (TS2322):**
- Line 60: `string | undefined` not assignable to `string` — same pattern as above

**app/api/netatmo/stove-sync/route.ts — 1 error (TS2783):**
- Line 161: `synced` property specified more than once — remove the duplicate property in the object literal

**app/api/stove/ignite/route.ts — 1 error (TS2345):**
- Line 18: `unknown` not assignable to `Record<string, unknown>` — cast the request body: `const body = await request.json() as Record<string, unknown>` or type the parsed body

**app/api/stove/shutdown/route.ts — 1 error (TS2345):**
- Line 18: Same pattern as ignite — `const body = await request.json() as Record<string, unknown>`
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "app/api/(hue/remote|netatmo/(set|stove)|stove/(ignite|shutdown))" | wc -l should return 0</verify>
  <done>Zero tsc errors in Hue pair, Netatmo thermostat, and Stove routes. All 13 errors fixed.</done>
</task>

</tasks>

<verification>
```bash
# Zero errors in all 12 API route files
npx tsc --noEmit 2>&1 | grep -E "app/api/(hue|netatmo|stove/(ignite|shutdown))" | wc -l
# Expected: 0
```
</verification>

<success_criteria>
- All 12 API route files compile with zero tsc strict-mode errors
- 22 total errors fixed
- AuthedHandler pattern consistently resolved across all routes
- No behavioral changes to any endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/46-api-page-strict-mode-compliance/46-04-SUMMARY.md`
</output>
