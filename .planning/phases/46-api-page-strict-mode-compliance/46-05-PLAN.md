---
phase: 46-api-page-strict-mode-compliance
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/scheduler/check/route.ts
  - app/api/notifications/test/route.ts
  - app/api/notifications/devices/[tokenKey]/route.ts
  - app/api/notifications/send/route.ts
  - app/api/notifications/check-rate/route.ts
  - app/api/geocoding/reverse/route.ts
  - app/api/geocoding/search/route.ts
  - app/api/health-monitoring/check/route.ts
autonomous: true

must_haves:
  truths:
    - "Scheduler check route compiles with zero tsc strict-mode errors"
    - "All notification API routes compile with zero tsc strict-mode errors"
    - "Geocoding and health-monitoring routes compile with zero tsc strict-mode errors"
    - "NotificationPayload type matches between callers and lib/firebaseAdmin"
  artifacts:
    - path: "app/api/scheduler/check/route.ts"
      provides: "Strict-mode compliant scheduler cron route"
    - path: "app/api/notifications/test/route.ts"
      provides: "Strict-mode compliant notification test route"
  key_links:
    - from: "app/api/notifications/test/route.ts"
      to: "lib/firebaseAdmin.ts"
      via: "NotificationPayload interface"
      pattern: "NotificationPayload|sendPushNotification"
---

<objective>
Fix 23 strict-mode TypeScript errors across 8 API route files for scheduler, notifications, geocoding, and health monitoring.

Purpose: The scheduler check route has the most complex errors (12 errors including dynamic Firebase paths and multiple catch blocks). Notification routes share a common NotificationPayload type mismatch pattern.
Output: All 8 API route files with zero tsc strict-mode errors.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/firebaseAdmin.ts
@app/api/scheduler/check/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix 12 errors in scheduler check route</name>
  <files>app/api/scheduler/check/route.ts</files>
  <action>
Fix 12 tsc errors in app/api/scheduler/check/route.ts:

**TS7053 (implicit any index - Firebase paths) — 3 errors:**
- Lines 251, 261: Template literal `\`users/${string}/fcmTokens/${string}\`` used to index `{}` — the Firebase multi-path update object needs to be typed as `Record<string, unknown>` instead of `{}`
- Line 287: Same pattern with `\`notificationErrors/${string}\`` — same fix

Find where the update object is initialized (likely `const updates = {}` or similar) and change to `const updates: Record<string, unknown> = {}`.

**TS18046 (unknown catch errors) — 8 errors:**
- Lines 512, 580, 581, 594, 604, 750, 751, 899: various `error`/`syncError` are unknown
- Fix each with `error instanceof Error ? error.message : String(error)` pattern
- Line 581: if `error.message` is accessed, wrap in instanceof check
- Line 751: if `error.message` AND `error.stack` are accessed, wrap in instanceof check

**TS18048 (possibly undefined) — 1 error:**
- Line 877: `maintenanceTrack.newCurrentHours` possibly undefined — add `?? 0` or check `if (maintenanceTrack.newCurrentHours !== undefined)`
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep "app/api/scheduler/check/route.ts" | wc -l should return 0</verify>
  <done>Zero tsc errors in scheduler check route. All 12 errors fixed.</done>
</task>

<task type="auto">
  <name>Task 2: Fix notification, geocoding, and health-monitoring route errors</name>
  <files>
    app/api/notifications/test/route.ts
    app/api/notifications/devices/[tokenKey]/route.ts
    app/api/notifications/send/route.ts
    app/api/notifications/check-rate/route.ts
    app/api/geocoding/reverse/route.ts
    app/api/geocoding/search/route.ts
    app/api/health-monitoring/check/route.ts
  </files>
  <action>
**app/api/notifications/test/route.ts — 4 errors:**

TS2345 (NotificationPayload mismatch) — 2 errors:
- Lines 133, 138: The inline notification object has `data` with non-string values (boolean, etc.) but `NotificationPayload` in `lib/firebaseAdmin.ts` requires `data?: Record<string, string>`. Fix: ensure all data values are strings: `isTest: 'true'` instead of `isTest: true`, and match the `priority` field type.

TS7006 (implicit any) — 2 errors:
- Lines 156, 157: `r` parameter implicit any — type based on the array context (likely notification result objects)

**app/api/notifications/devices/[tokenKey]/route.ts — 2 errors:**
- Lines 44, 93: AuthedHandler mismatch (TS2345) — same pattern as plan 04: remove explicit `NextResponse<unknown>` return type or change to `NextResponse`

**app/api/notifications/send/route.ts — 1 error:**
- Line 78: `SendNotificationPayload` not assignable to `NotificationPayload` (TS2345) — the `SendNotificationPayload` likely has a `data` property with broader types. Either:
  1. Convert data values to strings before passing: `Object.fromEntries(Object.entries(data).map(([k, v]) => [k, String(v)]))`
  2. Or use type assertion `as NotificationPayload`

**app/api/notifications/check-rate/route.ts — 1 error:**
- Line 111: Same NotificationPayload mismatch — ensure data values are all strings

**app/api/geocoding/reverse/route.ts — 1 error:**
- Line 27: Missing return statement (TS2366) — function declares return type but not all code paths return. Add explicit `return` at the end or adjust the return type to include `undefined`.

**app/api/geocoding/search/route.ts — 1 error:**
- Line 28: Same pattern as reverse route — add explicit return

**app/api/health-monitoring/check/route.ts — 1 error:**
- Line 150: `boolean | undefined` not assignable to `boolean` (TS2322) — use `?? false`
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "app/api/(notifications|geocoding|health-monitoring)" | wc -l should return 0</verify>
  <done>Zero tsc errors in all 7 API route files. All 11 errors fixed.</done>
</task>

</tasks>

<verification>
```bash
# Zero errors in all 8 API route files
npx tsc --noEmit 2>&1 | grep -E "app/api/(scheduler/check|notifications|geocoding|health-monitoring)" | wc -l
# Expected: 0
```
</verification>

<success_criteria>
- All 8 API route files compile with zero tsc strict-mode errors
- 23 total errors fixed
- NotificationPayload type mismatches resolved consistently
- No behavioral changes to any endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/46-api-page-strict-mode-compliance/46-05-SUMMARY.md`
</output>
