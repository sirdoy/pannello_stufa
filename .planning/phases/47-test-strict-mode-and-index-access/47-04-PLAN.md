---
phase: 47-test-strict-mode-and-index-access
plan: 04
type: execute
wave: 2
depends_on: [47-01, 47-02, 47-03]
files_modified:
  - tsconfig.json
  - lib/schedulerService.ts
  - lib/firebaseAdmin.ts
  - lib/rateLimiter.ts
  - lib/errorMonitor.ts
  - lib/schedulerStats.ts
  - lib/changelogService.ts
  - lib/netatmoApi.ts
  - lib/utils/scheduleHelpers.ts
  - lib/notificationFilter.ts
  - lib/netatmoCalibrationService.ts
  - lib/hlsDownloader.ts
  - lib/pwa/vibration.ts
  - lib/migrateSchedules.ts
  - lib/hue/hueRemoteApi.ts
  - lib/hue/hueApi.ts
  - lib/firebase.ts
  - lib/devices/deviceRegistry.ts
autonomous: true

must_haves:
  truths:
    - "noUncheckedIndexedAccess: true is enabled in tsconfig.json"
    - "All lib/ files have zero tsc errors with noUncheckedIndexedAccess enabled"
  artifacts:
    - path: "tsconfig.json"
      provides: "noUncheckedIndexedAccess enabled"
      contains: "noUncheckedIndexedAccess"
    - path: "lib/schedulerService.ts"
      provides: "Index-access-safe scheduler service"
    - path: "lib/firebaseAdmin.ts"
      provides: "Index-access-safe Firebase admin"
  key_links:
    - from: "tsconfig.json"
      to: "all .ts/.tsx files"
      via: "compiler option"
      pattern: "noUncheckedIndexedAccess.*true"
---

<objective>
Enable `noUncheckedIndexedAccess: true` in tsconfig.json and fix all 82 resulting errors in lib/ files (17 files).

Purpose: noUncheckedIndexedAccess adds `| undefined` to all index signatures and array access, catching real bugs where code assumes array elements or object properties always exist. This is the most impactful strict option remaining.
Output: tsconfig.json with noUncheckedIndexedAccess enabled, all lib/ files clean.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tsconfig.json
@lib/schedulerService.ts
@lib/firebaseAdmin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable noUncheckedIndexedAccess + fix high-error lib/ files (schedulerService 24, firebaseAdmin 11, rateLimiter 8, errorMonitor 8)</name>
  <files>tsconfig.json, lib/schedulerService.ts, lib/firebaseAdmin.ts, lib/rateLimiter.ts, lib/errorMonitor.ts</files>
  <action>
Step 1: Add `"noUncheckedIndexedAccess": true` to compilerOptions in tsconfig.json.

Step 2: Fix 51 errors in 4 lib/ files. The new errors are primarily:
- TS18048: 'x' is possibly 'undefined' — when accessing array elements like `arr[0]` or object properties like `obj[key]`
- TS2322: Type 'T | undefined' not assignable to 'T' — same root cause
- TS2532: Object is possibly 'undefined' — chaining after index access

Fix patterns (prefer in this order):
1. **Nullish coalescing:** `arr[0] ?? defaultValue` — when a default makes sense
2. **Optional chaining:** `arr[0]?.property` — when skipping is safe
3. **Non-null assertion:** `arr[0]!` — when context guarantees existence (e.g., after length check, inside `.forEach`/`.map`, after `if (arr.length > 0)`)
4. **Explicit undefined check:** `if (item !== undefined) { ... }` — for branching logic
5. **Type narrowing:** `const item = arr[0]; if (!item) return;` — early return pattern

For schedulerService.ts (24 errors): Likely schedule interval arrays and day-of-week object access. Use non-null assertions after validation and nullish coalescing for defaults.

For firebaseAdmin.ts (11 errors): Firebase data access patterns. Use optional chaining for nested data access.

For rateLimiter.ts (8 errors): Rate limit map access. Use `map.get(key)` with undefined check or `Map.has()` guard before access.

For errorMonitor.ts (8 errors): Error tracking object access. Use nullish coalescing for counters.

Run `npx tsc --noEmit 2>&1 | grep "error TS" | grep "^lib/scheduler\|^lib/firebase\|^lib/rate\|^lib/error" | wc -l` to verify.
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -c "lib/schedulerService\|lib/firebaseAdmin\|lib/rateLimiter\|lib/errorMonitor" outputs 0</verify>
  <done>tsconfig.json has noUncheckedIndexedAccess: true. Four highest-error lib/ files compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining 13 lib/ files (31 errors total: schedulerStats 7, changelogService 7, netatmoApi 3, and 10 files with 1-2 errors)</name>
  <files>
    lib/schedulerStats.ts, lib/changelogService.ts, lib/netatmoApi.ts,
    lib/utils/scheduleHelpers.ts, lib/notificationFilter.ts, lib/netatmoCalibrationService.ts,
    lib/hlsDownloader.ts, lib/pwa/vibration.ts, lib/migrateSchedules.ts,
    lib/hue/hueRemoteApi.ts, lib/hue/hueApi.ts, lib/firebase.ts, lib/devices/deviceRegistry.ts
  </files>
  <action>
Fix 31 errors across 13 lib/ files. Apply same patterns as Task 1:

- schedulerStats.ts (7): Schedule stats array access — nullish coalescing for defaults
- changelogService.ts (7): Changelog entry access — optional chaining and undefined checks
- netatmoApi.ts (3): API response data access — non-null assertion after validation
- Others (1-2 each): Quick fixes — non-null assertions or nullish coalescing

Verify all lib/ files are clean:
```bash
npx tsc --noEmit 2>&1 | grep "error TS" | grep "^lib/" | wc -l
```

Then run lib/ tests to ensure no regressions:
```bash
npx jest __tests__/lib/
```
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -c "^lib/.*error TS" outputs 0 AND npx jest __tests__/lib/ passes</verify>
  <done>All 17 lib/ files compile cleanly with noUncheckedIndexedAccess: true. All lib tests pass.</done>
</task>

</tasks>

<verification>
```bash
# Verify noUncheckedIndexedAccess is enabled
grep "noUncheckedIndexedAccess" tsconfig.json
# Expected: "noUncheckedIndexedAccess": true

# Verify zero lib/ errors
npx tsc --noEmit 2>&1 | grep "error TS" | grep "^lib/" | wc -l
# Expected: 0

# Verify lib tests pass
npx jest __tests__/lib/ 2>&1 | tail -5
```
</verification>

<success_criteria>
- noUncheckedIndexedAccess: true in tsconfig.json
- 0 tsc errors in all lib/ files
- All lib/ tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/47-test-strict-mode-and-index-access/47-04-SUMMARY.md`
</output>
