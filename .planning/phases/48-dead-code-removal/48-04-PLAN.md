---
phase: 48-dead-code-removal
plan: 04
type: execute
wave: 2
depends_on: ["48-01"]
files_modified:
  - lib/netatmoApi.ts
  - lib/netatmoCalibrationService.ts
  - lib/netatmoCameraApi.ts
  - lib/netatmoCredentials.ts
  - lib/netatmoStoveSync.ts
  - lib/netatmoTokenHelper.ts
  - lib/notificationFilter.ts
  - lib/notificationLogger.ts
  - lib/notificationPreferencesService.ts
  - lib/notificationService.ts
  - lib/notificationTriggers.ts
  - lib/notificationTriggersServer.ts
  - lib/rateLimiter.ts
  - lib/schedulesApiClient.ts
  - lib/schemas/coordinationPreferences.ts
  - lib/schemas/notificationPreferences.ts
  - lib/services/locationService.ts
  - lib/services/pidAutomationService.ts
  - lib/services/unifiedDeviceConfigService.ts
  - lib/tokenRefresh.ts
  - lib/tokenStorage.ts
autonomous: true

must_haves:
  truths:
    - "All unused exports identified by knip in these lib/ files are removed"
    - "Functions still used internally within their files remain functional"
    - "TypeScript compilation passes after export removals"
    - "All tests still pass after export removals"
  artifacts:
    - path: "lib/notificationTriggers.ts"
      provides: "Only actively used notification trigger exports remain"
    - path: "lib/netatmoApi.ts"
      provides: "Only actively used Netatmo API exports remain"
  key_links:
    - from: "modified lib/ files"
      to: "importing files"
      via: "remaining exports still resolve"
      pattern: "npx tsc --noEmit"
---

<objective>
Remove unused exports from lib/ service files (Group B: netatmo, notifications, tokens, schemas, services).

Purpose: Clean up unused public API surface from service modules. Addresses DEAD-01.
Output: ~21 files with leaner export surfaces.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-dead-code-removal/48-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove unused exports from lib/ netatmo and notification files</name>
  <files>
    lib/netatmoApi.ts
    lib/netatmoCalibrationService.ts
    lib/netatmoCameraApi.ts
    lib/netatmoCredentials.ts
    lib/netatmoStoveSync.ts
    lib/netatmoTokenHelper.ts
    lib/notificationFilter.ts
    lib/notificationLogger.ts
    lib/notificationPreferencesService.ts
    lib/notificationService.ts
    lib/notificationTriggers.ts
    lib/notificationTriggersServer.ts
  </files>
  <action>
    For each file, remove the unused exports identified by knip. Strategy:
    1. If function/variable has NO importers in source code AND no internal usage: **delete entirely**
    2. If function/variable IS used internally but not exported: **remove `export` keyword**
    3. For `default` exports: check if they are actually imported elsewhere via `import X from` pattern. If so, this is a false positive — **skip**

    **IMPORTANT verification before removing:** For each export, check usage:
    ```bash
    grep -rn "exportName" --include="*.ts" --include="*.tsx" lib/ app/ | grep -v "__tests__" | grep -v ".test." | grep -v "node_modules"
    ```

    **Specific removals per file:**

    **lib/netatmoApi.ts:** `getDeviceList`, `getThermState`, `getRoomMeasure`, `syncHomeSchedule`, `createSchedule`, `renameHome`, `isHeatingActive`
    **lib/netatmoCalibrationService.ts:** `default` export
    **lib/netatmoCameraApi.ts:** `getCamerasData`, `getCameraEvents`, `getEventsUntil`, `getLiveStreamUrl`, `getEventVideoUrl`, `getEventVideoThumbnail`, `getEventVideoDownloadUrl`, `getSubTypeName`, `getSubTypeIcon`
    **lib/netatmoCredentials.ts:** `NETATMO_OAUTH_SCOPES`
    **lib/netatmoStoveSync.ts:** `getSyncedRoomIds`, `default`
    **lib/netatmoTokenHelper.ts:** `clearNetatmoData`, `default`
    **lib/notificationFilter.ts:** `_internals` (test helper export — if used in tests, leave it)
    **lib/notificationLogger.ts:** `logNotificationError`, `getNotificationLogs`
    **lib/notificationPreferencesService.ts:** `getUserPreferences`, `updateUserPreferences`, `shouldSendSchedulerNotification`, `shouldSendMaintenanceNotification`, `resetPreferences`, `getPreferenceStats`
    **lib/notificationService.ts:** `createErrorNotification`, `createSchedulerNotification`, `createMaintenanceNotification`, `createGenericNotification`, `getUserFCMTokens`
    **lib/notificationTriggers.ts:** `getNotificationType`, `getNotificationTypesByCategory`, `triggerNotification`, `triggerStoveStatusWork`, `triggerStoveUnexpectedOff`, `triggerStoveError`, `triggerSchedulerAction`, `triggerMaintenanceAlert`, `triggerNetatmoAlert`, `triggerGenericNotification`
    **lib/notificationTriggersServer.ts:** `triggerNotificationToAdmin`, `triggerStoveErrorServer`, `triggerHueAlertServer`, `triggerSystemNotificationServer`, `triggerGenericNotificationServer`

    **Special case: `_internals` exports** in notificationFilter.ts and rateLimiter.ts — these are intentional test-only exports. Check if they are used in test files:
    ```bash
    grep -rn "_internals" --include="*.test.ts" --include="*.test.tsx"
    ```
    If used in tests, **keep them** — they are a valid testing pattern.

    After removals:
    ```bash
    npx tsc --noEmit 2>&1 | head -30
    ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit 2>&1 | tail -5
    npm test -- --bail --testPathPattern="(netatmo|notification)" 2>&1 | tail -10
    ```
  </verify>
  <done>Unused exports removed from 12 netatmo/notification files, tsc passes, related tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Remove unused exports from lib/ remaining service files</name>
  <files>
    lib/rateLimiter.ts
    lib/schedulesApiClient.ts
    lib/schemas/coordinationPreferences.ts
    lib/schemas/notificationPreferences.ts
    lib/services/locationService.ts
    lib/services/pidAutomationService.ts
    lib/services/unifiedDeviceConfigService.ts
    lib/tokenRefresh.ts
    lib/tokenStorage.ts
  </files>
  <action>
    Continue removing unused exports from remaining lib/ service files:

    **lib/rateLimiter.ts:** `clearRateLimitForUser`, `getRateLimitStatus`, `_internals` (check if _internals used in tests — if yes, keep)
    **lib/schedulesApiClient.ts:** `getScheduleById`, `getActiveScheduleId`
    **lib/schemas/coordinationPreferences.ts:** `zoneConfigSchema`
    **lib/schemas/notificationPreferences.ts:** `dndWindowSchema`, `rateLimitSchema`
    **lib/services/locationService.ts:** `getLocation`, `setLocation`
    **lib/services/pidAutomationService.ts:** `DEFAULT_PID_CONFIG`
    **lib/services/unifiedDeviceConfigService.ts:** `isDisplayOnly`, `hasHomepageCard`, `getDefaultDeviceConfig`, `getUnifiedDeviceConfig`
    **lib/tokenRefresh.ts:** `forceTokenRefresh`
    **lib/tokenStorage.ts:** `requestPersistentStorage`, `checkPersistence`, `clearToken`, `getStorageStatus`

    Same strategy: verify usage before removal, remove `export` if used internally, delete if completely unused.

    After all removals, full verification:
    ```bash
    npx tsc --noEmit 2>&1 | tail -5
    npm test -- --bail 2>&1 | tail -20
    ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit 2>&1 | tail -5
    npm test -- --bail 2>&1 | tail -10
    ```
  </verify>
  <done>Unused exports removed from 9 more lib/ files, tsc passes, all tests pass</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `npm test -- --bail` passes
3. Removed exports no longer appear in knip output for these files
</verification>

<success_criteria>
- ~82 unused exports removed from 21 lib/ service files
- Zero tsc errors
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/48-dead-code-removal/48-04-SUMMARY.md`
</output>
