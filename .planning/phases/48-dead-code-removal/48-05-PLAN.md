---
phase: 48-dead-code-removal
plan: 05
type: execute
wave: 2
depends_on: ["48-01"]
files_modified:
  - lib/core/apiResponse.ts
  - lib/core/middleware.ts
  - lib/core/requestParser.ts
  - lib/hooks/useBackgroundSync.ts
  - lib/hue/hueApi.ts
  - lib/hue/hueConnectionStrategy.ts
  - lib/hue/hueLocalHelper.ts
  - lib/hue/hueRemoteTokenHelper.ts
  - lib/hue/hueTokenHelper.ts
  - lib/pwa/backgroundSync.ts
  - lib/pwa/badgeService.ts
  - lib/pwa/geofencing.ts
  - lib/pwa/indexedDB.ts
  - lib/pwa/offlineStateCache.ts
  - lib/pwa/persistentStorage.ts
  - lib/pwa/vibration.ts
  - lib/pwa/wakeLock.ts
  - lib/pwa/webShare.ts
  - app/components/weather/weatherHelpers.ts
  - app/components/weather/index.ts
  - app/debug/api/components/ApiTab.tsx
  - app/debug/components/ApiTab.tsx
  - app/thermostat/components/ThermostatTabs.tsx
  - types/api/responses.ts
  - types/api/index.ts
  - app/components/ui/index.ts
autonomous: true

must_haves:
  truths:
    - "All unused exports from lib/core/, lib/hue/, lib/pwa/, app/ files are removed"
    - "UI barrel (app/components/ui/index.ts) cleaned of exports for components never consumed outside barrel"
    - "TypeScript compilation passes after all export removals"
    - "All tests still pass after all export removals"
  artifacts:
    - path: "app/components/ui/index.ts"
      provides: "Lean barrel with only consumed exports"
    - path: "lib/pwa/geofencing.ts"
      provides: "Only actively used geofencing exports"
  key_links:
    - from: "modified files"
      to: "importing files"
      via: "remaining exports still resolve"
      pattern: "npx tsc --noEmit"
---

<objective>
Remove unused exports from lib/core/, lib/hue/, lib/pwa/, app/ files, and clean up barrel exports in UI index and type barrels.

Purpose: Complete the unused export cleanup across all remaining source files. Addresses DEAD-01.
Output: ~26 files with leaner export surfaces, clean barrel re-exports.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/48-dead-code-removal/48-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove unused exports from lib/core/, lib/hue/, lib/pwa/ files</name>
  <files>
    lib/core/apiResponse.ts
    lib/core/middleware.ts
    lib/core/requestParser.ts
    lib/hooks/useBackgroundSync.ts
    lib/hue/hueApi.ts
    lib/hue/hueConnectionStrategy.ts
    lib/hue/hueLocalHelper.ts
    lib/hue/hueRemoteTokenHelper.ts
    lib/hue/hueTokenHelper.ts
    lib/pwa/backgroundSync.ts
    lib/pwa/badgeService.ts
    lib/pwa/geofencing.ts
    lib/pwa/indexedDB.ts
    lib/pwa/offlineStateCache.ts
    lib/pwa/persistentStorage.ts
    lib/pwa/vibration.ts
    lib/pwa/wakeLock.ts
    lib/pwa/webShare.ts
  </files>
  <action>
    For each file, remove unused exports. Same strategy as plans 03/04:
    1. Verify usage before removing (grep for importers in source and test files)
    2. Remove `export` keyword if used internally, delete function if completely unused
    3. Skip false-positive `default` exports that are actually imported elsewhere

    **Specific removals per file:**

    **lib/core/apiResponse.ts:** `fromApiError`, `validationError`, `serviceUnavailable`, `default`
    **lib/core/middleware.ts:** `withAuth`, `withOptionalAuth`, `protect`, `withAdmin`, `compose`, `default`
    **lib/core/requestParser.ts:** `default`
    **lib/hooks/useBackgroundSync.ts:** `default`
    **lib/hue/hueApi.ts:** `exchangeCodeForTokens`, `refreshAccessToken`
    **lib/hue/hueConnectionStrategy.ts:** `default`
    **lib/hue/hueLocalHelper.ts:** `getConnectionMode`, `setConnectionMode`
    **lib/hue/hueRemoteTokenHelper.ts:** `getRemoteStatus`, `default`
    **lib/hue/hueTokenHelper.ts:** `saveRefreshToken`, `saveInitialTokens`, `isHueConnected`, `clearHueData`, `getHueStatus`
    **lib/pwa/backgroundSync.ts:** `isBackgroundSyncSupported`, `registerSync`, `default`
    **lib/pwa/badgeService.ts:** `isBadgeSupported`, `getBadgeCount`, `setBadgeCount`, `incrementBadge`, `decrementBadge`, `updateBadgeFromAlerts`, `initializeBadge`, `default`
    **lib/pwa/geofencing.ts:** `getCurrentPosition`, `getGeofenceConfig`, `saveGeofenceConfig`, `setCurrentLocationAsHome`, `checkGeofenceStatus`, `enableGeofencing`, `disableGeofencing`, `updateGeofenceActions`, `clearGeofenceConfig`, `default`
    **lib/pwa/indexedDB.ts:** `openDB`, `add`, `clear`, `count`, `isSupported`, `default`
    **lib/pwa/offlineStateCache.ts:** `getAllCachedStates`, `cacheState`, `getCachedStateFromSW`, `default`
    **lib/pwa/persistentStorage.ts:** `getStorageDetails`, `default`
    **lib/pwa/vibration.ts:** `vibrateNotification`, `vibrateHeartbeat`, `default`
    **lib/pwa/wakeLock.ts:** `reacquireWakeLock`, `default`
    **lib/pwa/webShare.ts:** `isFileShareSupported`, `shareDeviceSummary`, `shareErrorLog`, `default`

    **NOTE on `default` exports:** Many lib/pwa/ files export both named exports and a `default` export that bundles everything. If the `default` is unused but named exports are used, just remove the `default` export object at the bottom of the file. If both are unused, the file may be a candidate for complete removal — but only if it was already flagged as an unused file in plan 01.

    After removals:
    ```bash
    npx tsc --noEmit 2>&1 | head -30
    ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit 2>&1 | tail -5
    npm test -- --bail --testPathPattern="(core|hue|pwa)" 2>&1 | tail -10
    ```
  </verify>
  <done>All unused exports removed from 18 lib/core+hue+pwa files, tsc passes, related tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Remove unused exports from app/ files and clean UI/type barrels</name>
  <files>
    app/components/weather/weatherHelpers.ts
    app/components/weather/index.ts
    app/debug/api/components/ApiTab.tsx
    app/debug/components/ApiTab.tsx
    app/thermostat/components/ThermostatTabs.tsx
    types/api/responses.ts
    types/api/index.ts
    app/components/ui/index.ts
  </files>
  <action>
    **Part A: app/ file exports**

    **app/components/weather/weatherHelpers.ts:** Remove exports: `isSnowCode`, `getPrecipitationLabel`
    **app/components/weather/index.ts:** Remove unused re-exports from barrel. The barrel re-exports many weather sub-components and helpers. Remove re-exports that no file outside the weather/ directory imports: `WeatherCardDefault`, `CurrentConditions`, `ForecastRow`, `ForecastDayCard`, `ForecastDaySheet`, `HourlyForecast`, `WeatherIcon`, `getWeatherLabel`, `formatTemperature`, `getTemperatureComparison`, `formatWindSpeed`, `getUVIndexLabel`, `getPrecipitationLabel`, `getAirQualityLabel`, `getTemperatureTrend`, `isSnowCode`, `getPressureLabel`.
    Before removing, verify what IS actually imported from this barrel:
    ```bash
    grep -rn "from.*components/weather" --include="*.ts" --include="*.tsx" app/ | grep -v "weather/" | grep -v "__tests__"
    ```
    Keep only the exports that are actually imported by files outside weather/.

    **app/debug/api/components/ApiTab.tsx:** Remove export: `JsonDisplay` (make it a local/private function)
    **app/debug/components/ApiTab.tsx:** Remove export: `JsonDisplay` (make it a local/private function)
    **app/thermostat/components/ThermostatTabs.tsx:** Remove export: `ThermostatTabs` — BUT VERIFY FIRST: this component is likely imported by the thermostat page. If it IS imported, this is a false positive. Check:
    ```bash
    grep -rn "ThermostatTabs" --include="*.ts" --include="*.tsx" app/ | grep -v ThermostatTabs.tsx
    ```

    **Part B: Type barrel cleanup**

    **types/api/responses.ts:** Remove exports: `isApiSuccess`, `isApiError` (type guard functions that appear unused)
    **types/api/index.ts:** Remove re-exports: `isApiSuccess`, `isApiError` (if removed from responses.ts)

    **Part C: UI barrel cleanup (app/components/ui/index.ts)**

    The UI barrel exports ~130+ items. Knip flags ~100 as unused because they are consumed only through the barrel, not directly. This is by design — the barrel IS the public API.

    However, some re-exports from the barrel may genuinely have no consumers (not even via the barrel). Run:
    ```bash
    npx knip --no-progress --include exports 2>/dev/null | grep "app/components/ui/index.ts" | head -60
    ```

    For each flagged barrel export, check if ANY file imports it:
    ```bash
    grep -rn "CardFooter\|CardDivider\|CardAccentBar\|CardAccentCorner\|ActionButton\|RadioGroupItem\|ErrorBadge\|Toggle\|ToastViewport" --include="*.ts" --include="*.tsx" app/ lib/ | grep -v "ui/index.ts" | grep -v "ui/Card" | grep -v "ui/Button" | grep -v "__tests__"
    ```

    Remove from the barrel only exports that are TRULY never imported anywhere (not even from the barrel). This is a conservative approach — when in doubt, keep the export.

    After all changes:
    ```bash
    npx tsc --noEmit 2>&1 | tail -5
    npm test -- --bail 2>&1 | tail -20
    ```
  </action>
  <verify>
    ```bash
    npx tsc --noEmit 2>&1 | tail -5
    npm test -- --bail 2>&1 | tail -10
    ```
  </verify>
  <done>All unused exports removed from app/ files and barrels, tsc passes, all tests pass</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `npm test -- --bail` passes
3. `npx knip --include exports` shows significantly fewer unused exports (mostly UI barrel design-system exports which are intentional)
</verification>

<success_criteria>
- ~66 unused exports removed from lib/core+hue+pwa files
- ~31 unused exports removed/cleaned from app/ and barrel files
- Zero tsc errors
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/48-dead-code-removal/48-05-SUMMARY.md`
</output>
