---
phase: 50-cron-automation-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/cron-scheduler.yml
autonomous: true
user_setup:
  - service: github-actions
    why: "GitHub Actions secrets needed for cron workflow to call Vercel endpoints"
    env_vars:
      - name: VERCEL_APP_URL
        source: "GitHub repo Settings -> Secrets and variables -> Actions -> New repository secret. Value: your Vercel production URL (e.g., https://pannello-stufa.vercel.app)"
      - name: CRON_SECRET
        source: "GitHub repo Settings -> Secrets and variables -> Actions -> New repository secret. Value: must match the CRON_SECRET environment variable configured in Vercel"

must_haves:
  truths:
    - "GitHub Actions workflow triggers every 5 minutes on schedule"
    - "Workflow calls both /api/health-monitoring/check and /api/scheduler/check with CRON_SECRET authentication"
    - "Workflow supports manual trigger via workflow_dispatch for testing"
    - "Workflow fails with non-zero exit code if either endpoint returns non-200"
  artifacts:
    - path: ".github/workflows/cron-scheduler.yml"
      provides: "GitHub Actions cron workflow with 5-minute schedule"
      contains: "cron: '*/5 * * * *'"
  key_links:
    - from: ".github/workflows/cron-scheduler.yml"
      to: "/api/health-monitoring/check"
      via: "curl with CRON_SECRET query param"
      pattern: "health-monitoring/check.*secret"
    - from: ".github/workflows/cron-scheduler.yml"
      to: "/api/scheduler/check"
      via: "curl with CRON_SECRET query param"
      pattern: "scheduler/check.*secret"
---

<objective>
Create the GitHub Actions cron workflow that triggers both health monitoring and scheduler check endpoints every 5 minutes.

Purpose: This is the core automation configuration that makes the stove control system fully automated. Without this workflow, the health monitoring and scheduler check must be triggered manually.

Output: `.github/workflows/cron-scheduler.yml` with `on.schedule` cron trigger, `workflow_dispatch` for manual testing, and separate steps for health monitoring and scheduler check endpoints.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing workflow pattern to follow:
@.github/workflows/sync-changelog.yml

# Endpoints to call:
@app/api/health-monitoring/check/route.ts
@app/api/scheduler/check/route.ts

# Authentication pattern:
@lib/core/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions cron-scheduler workflow</name>
  <files>.github/workflows/cron-scheduler.yml</files>
  <action>
Create `.github/workflows/cron-scheduler.yml` following the proven pattern from `sync-changelog.yml`.

The workflow must:
1. **Trigger:** `on.schedule` with `cron: '*/5 * * * *'` (every 5 minutes) AND `on.workflow_dispatch` (manual trigger for testing)
2. **Runner:** `ubuntu-latest` with `timeout-minutes: 2` (allows 60s endpoint + buffer)
3. **Step 1 - Health Monitoring Check:**
   - Call `${{ secrets.VERCEL_APP_URL }}/api/health-monitoring/check?secret=${{ secrets.CRON_SECRET }}` using GET
   - Capture HTTP status code and response body
   - Print response for GitHub Actions log visibility
   - Exit 1 on non-200 response
4. **Step 2 - Scheduler Check:**
   - Call `${{ secrets.VERCEL_APP_URL }}/api/scheduler/check?secret=${{ secrets.CRON_SECRET }}` using GET
   - Same response handling pattern as Step 1
   - Exit 1 on non-200 response
5. **Step 3 - Summary:**
   - Print completion timestamp (UTC) for audit trail
   - Print both response statuses

Use separate steps (not a single script) so individual endpoint failures are visible in GitHub Actions UI. Use `continue-on-error: false` (default) so any failure marks the workflow as failed.

Authentication: Use query param `?secret=` pattern (matching `withCronSecret` middleware which supports both query param and Bearer header).

IMPORTANT: Do NOT hardcode the app URL. Use `${{ secrets.VERCEL_APP_URL }}` secret. Do NOT use `on.push` trigger (would run on every commit, creating noise).
  </action>
  <verify>
Validate YAML syntax:
```bash
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/cron-scheduler.yml'))" && echo "YAML valid"
```
Verify the file contains: `*/5 * * * *`, `workflow_dispatch`, `health-monitoring/check`, `scheduler/check`, `CRON_SECRET`, `VERCEL_APP_URL`.
  </verify>
  <done>
`.github/workflows/cron-scheduler.yml` exists with valid YAML, 5-minute cron schedule, workflow_dispatch trigger, two separate endpoint calls with CRON_SECRET authentication, and proper error handling that exits 1 on non-200 responses.
  </done>
</task>

</tasks>

<verification>
1. `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/cron-scheduler.yml'))"` succeeds
2. File contains `schedule` and `workflow_dispatch` triggers
3. File contains both `/api/health-monitoring/check` and `/api/scheduler/check` endpoint calls
4. File uses `secrets.VERCEL_APP_URL` and `secrets.CRON_SECRET` (no hardcoded URLs)
5. File has `timeout-minutes` to prevent infinite hangs
</verification>

<success_criteria>
GitHub Actions cron workflow file created and validates as correct YAML. Contains all required triggers, endpoint calls, authentication, and error handling. Ready to execute once GitHub secrets are configured.
</success_criteria>

<output>
After completion, create `.planning/phases/50-cron-automation-configuration/50-01-SUMMARY.md`
</output>
