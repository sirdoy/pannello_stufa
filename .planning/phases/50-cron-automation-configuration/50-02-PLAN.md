---
phase: 50-cron-automation-configuration
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/cronExecutionLogger.ts
  - __tests__/lib/cronExecutionLogger.test.ts
autonomous: true

must_haves:
  truths:
    - "Cron execution logger writes timestamp, duration, status, and mode to Firebase RTDB"
    - "Execution log entries include enough detail for monitoring dashboard display"
    - "Logger uses fire-and-forget pattern (errors logged but never thrown)"
    - "Expired execution logs older than 24 hours are cleaned up automatically"
  artifacts:
    - path: "lib/cronExecutionLogger.ts"
      provides: "Cron execution logging service for scheduler check endpoint"
      exports: ["logCronExecution", "getRecentCronExecutions"]
      min_lines: 40
    - path: "__tests__/lib/cronExecutionLogger.test.ts"
      provides: "Unit tests for cron execution logger"
      min_lines: 60
  key_links:
    - from: "lib/cronExecutionLogger.ts"
      to: "Firebase RTDB cronExecutions/"
      via: "adminDbSet/adminDbGet"
      pattern: "cronExecutions/"
---

<objective>
Create a TDD-driven cron execution logger service that writes scheduler check execution details to Firebase RTDB, enabling the monitoring dashboard to display cron execution history with timestamp and duration (CRON-05).

Purpose: The existing `/api/scheduler/check` endpoint only writes `cronHealth/lastCall` (a single timestamp). The health monitoring check logs to Firestore via `healthLogger.ts`, but scheduler executions have no visibility in the dashboard. This service bridges that gap by logging scheduler execution details to RTDB.

Output: `lib/cronExecutionLogger.ts` with `logCronExecution()` and `getRecentCronExecutions()`, plus comprehensive tests.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Pattern reference for Firebase RTDB logging:
@lib/healthDeadManSwitch.ts
@lib/firebaseAdmin.ts

# Existing health logger pattern (Firestore-based, for reference):
@lib/healthLogger.ts

# Scheduler check route that will consume this logger:
@app/api/scheduler/check/route.ts
</context>

<feature>
  <name>Cron Execution Logger</name>
  <files>lib/cronExecutionLogger.ts, __tests__/lib/cronExecutionLogger.test.ts</files>
  <behavior>
    logCronExecution(result) writes execution log to Firebase RTDB:
    - Input: { status: string, mode: string, duration: number, details?: Record }
    - Writes to `cronExecutions/{timestamp-based-key}` with: timestamp, status, mode, duration, details
    - Cleans up entries older than 24 hours (fire-and-forget)
    - Returns void (never throws)

    Cases:
    - logCronExecution({ status: 'ACCESA', mode: 'auto', duration: 1234 }) -> writes to cronExecutions/{key}
    - logCronExecution({ status: 'SPENTA', mode: 'manual', duration: 500, details: { giorno: 'LunedÃ¬', ora: '08:00' } }) -> writes with details
    - Firebase error during write -> logs error to console, does NOT throw

    getRecentCronExecutions(limit) reads recent execution logs:
    - Input: limit (default 20)
    - Reads `cronExecutions/` from RTDB, returns array sorted by timestamp desc, limited
    - Returns empty array on error (never throws)

    Cases:
    - getRecentCronExecutions() -> returns up to 20 most recent entries
    - getRecentCronExecutions(5) -> returns up to 5 entries
    - No entries exist -> returns []
    - Firebase error -> returns []
  </behavior>
  <implementation>
    Use Firebase RTDB (not Firestore) for consistency with existing cron patterns (cronHealth/lastCall, healthMonitoring/lastCheck).

    Key format: `cronExecutions/{ISO-timestamp-sanitized}` (replace colons/dots for RTDB key compatibility).

    Cleanup: After each write, query entries older than 24h and remove them. Use `adminDbGet('cronExecutions')` to get all, filter old ones, delete with `adminDbSet` to null. Fire-and-forget cleanup (don't block on it).

    Follow the same pattern as `healthDeadManSwitch.ts`: import from `./firebaseAdmin`, fire-and-forget error handling, console.log for success/error.
  </implementation>
</feature>

<verification>
1. `npm test -- --testPathPattern="cronExecutionLogger" --no-coverage` passes all tests
2. Tests cover: successful write, Firebase error handling, cleanup of old entries, getRecentCronExecutions with limit, empty state
3. `logCronExecution` never throws (wrapped in try/catch)
4. `getRecentCronExecutions` never throws (wrapped in try/catch)
</verification>

<success_criteria>
All tests pass. `lib/cronExecutionLogger.ts` exports `logCronExecution` and `getRecentCronExecutions`. Both functions handle Firebase errors gracefully. Execution logs include timestamp, status, mode, and duration fields.
</success_criteria>

<output>
After completion, create `.planning/phases/50-cron-automation-configuration/50-02-SUMMARY.md`
</output>
