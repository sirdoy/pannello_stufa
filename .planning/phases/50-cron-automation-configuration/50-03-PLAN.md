---
phase: 50-cron-automation-configuration
plan: 03
type: execute
wave: 2
depends_on: ["50-02"]
files_modified:
  - app/api/scheduler/check/route.ts
  - app/api/health-monitoring/cron-executions/route.ts
  - __tests__/api/health-monitoring/cron-executions.test.ts
autonomous: true

must_haves:
  truths:
    - "Scheduler check endpoint logs execution details (status, mode, duration) to Firebase RTDB after each run"
    - "Cron execution logs API returns recent executions for dashboard display"
    - "Execution logging is fire-and-forget (does not increase endpoint response time)"
  artifacts:
    - path: "app/api/scheduler/check/route.ts"
      provides: "Scheduler check with cron execution logging integrated"
      contains: "logCronExecution"
    - path: "app/api/health-monitoring/cron-executions/route.ts"
      provides: "API route to fetch recent cron execution logs"
      exports: ["GET"]
    - path: "__tests__/api/health-monitoring/cron-executions.test.ts"
      provides: "Tests for cron executions API route"
      min_lines: 30
  key_links:
    - from: "app/api/scheduler/check/route.ts"
      to: "lib/cronExecutionLogger.ts"
      via: "import logCronExecution"
      pattern: "logCronExecution"
    - from: "app/api/health-monitoring/cron-executions/route.ts"
      to: "lib/cronExecutionLogger.ts"
      via: "import getRecentCronExecutions"
      pattern: "getRecentCronExecutions"
---

<objective>
Wire the cron execution logger into the scheduler check endpoint and create an API route for the monitoring dashboard to fetch execution logs.

Purpose: Completes CRON-05 by making scheduler execution data available to the monitoring dashboard. The logger (from plan 50-02) writes data; this plan integrates it into the scheduler endpoint and exposes it via API.

Output: Modified scheduler check route with logging, new cron-executions API route, and tests.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Logger created in plan 50-02:
@lib/cronExecutionLogger.ts

# Endpoint to modify:
@app/api/scheduler/check/route.ts

# Pattern for authenticated API routes:
@app/api/health-monitoring/logs/route.ts
@app/api/health-monitoring/dead-man-switch/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate cron execution logging into scheduler check endpoint</name>
  <files>app/api/scheduler/check/route.ts</files>
  <action>
Modify the `GET` handler in `app/api/scheduler/check/route.ts` to log each execution using `logCronExecution` from `lib/cronExecutionLogger.ts`.

Changes needed:
1. Add import at the top: `import { logCronExecution } from '@/lib/cronExecutionLogger';`
2. Record `startTime` at the very beginning of the handler (after `cronHealthTimestamp` save): `const startTime = Date.now();`
3. Before each `return success(...)` statement in the handler, add a fire-and-forget logging call:
   ```typescript
   const duration = Date.now() - startTime;
   logCronExecution({
     status: '<the status being returned>',
     mode: schedulerEnabled ? 'auto' : 'manual',
     duration,
     details: { giorno, ora, ... }  // relevant context from the response
   }).catch(err => console.error('‚ùå Cron execution log error:', err));
   ```
4. There are multiple early returns in the handler (MODALITA_MANUALE, MODALITA_SEMI_MANUALE, STATUS_UNAVAILABLE, MANUTENZIONE_RICHIESTA, etc.). Add logging before EACH return. For early returns before `giorno`/`ora` are defined, omit those from details.

IMPORTANT: Use fire-and-forget pattern (`.catch()`) - do NOT await the logging call. The scheduler endpoint must not be slowed down by logging.

IMPORTANT: Do NOT change any existing functionality. Only ADD the logging calls before returns. The existing `cronHealth/lastCall` write on line 771 must remain unchanged.
  </action>
  <verify>
TypeScript compilation check: `npx tsc --noEmit app/api/scheduler/check/route.ts 2>&1 | head -20` (may need broader check).
Grep for all `logCronExecution` calls to verify integration: `grep -n "logCronExecution" app/api/scheduler/check/route.ts`
  </verify>
  <done>
Every `return success(...)` in the scheduler check handler is preceded by a fire-and-forget `logCronExecution()` call. The import is present. No existing functionality changed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cron-executions API route and tests</name>
  <files>app/api/health-monitoring/cron-executions/route.ts, __tests__/api/health-monitoring/cron-executions.test.ts</files>
  <action>
Create `app/api/health-monitoring/cron-executions/route.ts`:

1. Follow the pattern from `app/api/health-monitoring/dead-man-switch/route.ts`
2. Import `withAuthAndErrorHandler` and `success` from `@/lib/core`
3. Import `getRecentCronExecutions` from `@/lib/cronExecutionLogger`
4. Export `dynamic = 'force-dynamic'`
5. Create `GET` handler:
   ```typescript
   export const GET = withAuthAndErrorHandler(async (request, context, session) => {
     const { searchParams } = new URL(request.url);
     const limitParam = searchParams.get('limit');
     const limit = limitParam ? Math.min(Math.max(parseInt(limitParam, 10) || 20, 1), 50) : 20;

     const executions = await getRecentCronExecutions(limit);

     return success({ executions, count: executions.length });
   }, 'HealthMonitoring/CronExecutions');
   ```

Create `__tests__/api/health-monitoring/cron-executions.test.ts`:

1. Mock `@/lib/cronExecutionLogger` to provide controlled `getRecentCronExecutions` responses
2. Mock `@/lib/core` to provide working `withAuthAndErrorHandler` and `success` helpers
3. Test cases:
   - Returns recent executions with default limit (20)
   - Respects custom limit query parameter
   - Clamps limit to max 50
   - Returns empty array when no executions exist
   - Uses Auth0 authentication (withAuthAndErrorHandler)
  </action>
  <verify>
```bash
npm test -- --testPathPattern="cron-executions" --no-coverage
```
All tests pass. Route file exists and exports GET handler.
  </verify>
  <done>
`app/api/health-monitoring/cron-executions/route.ts` exists, exports GET handler with auth protection, accepts limit param, returns recent cron executions. Tests pass.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "logCronExecution" app/api/scheduler/check/route.ts` returns 5+ (one import + one per return path)
2. `npm test -- --testPathPattern="cron-executions" --no-coverage` passes
3. `app/api/health-monitoring/cron-executions/route.ts` exists and exports GET
4. No existing scheduler check tests broken: `npm test -- --testPathPattern="scheduler" --no-coverage`
</verification>

<success_criteria>
Scheduler check endpoint logs every execution to Firebase RTDB. New API route serves execution logs for the monitoring dashboard. All tests pass including existing scheduler tests.
</success_criteria>

<output>
After completion, create `.planning/phases/50-cron-automation-configuration/50-03-SUMMARY.md`
</output>
