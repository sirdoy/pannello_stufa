---
phase: 51-e2e-test-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - playwright.config.ts
  - tests/auth.setup.ts
  - tests/helpers/auth.helpers.ts
  - tests/helpers/test-context.ts
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Playwright config defines setup project that runs auth.setup.ts before all feature tests"
    - "Auth setup authenticates via real Auth0 OAuth flow (not TEST_MODE) and saves session to tests/.auth/user.json"
    - "Feature test projects depend on setup project and reuse cached storageState"
    - "tests/.auth/ directory is gitignored to prevent credential leakage"
    - "Auth helpers (signIn, signOut) are reusable and centralized"
  artifacts:
    - path: "playwright.config.ts"
      provides: "Playwright configuration with setup project, chromium project, storageState, retries, trace"
      contains: "storageState"
    - path: "tests/auth.setup.ts"
      provides: "Session caching via real Auth0 login"
      contains: "storageState"
    - path: "tests/helpers/auth.helpers.ts"
      provides: "Reusable signIn and signOut functions"
      exports: ["signIn", "signOut"]
    - path: "tests/helpers/test-context.ts"
      provides: "Test user credentials from environment variables"
      exports: ["TEST_USER"]
  key_links:
    - from: "playwright.config.ts"
      to: "tests/auth.setup.ts"
      via: "setup project testMatch pattern"
      pattern: "testMatch.*setup"
    - from: "playwright.config.ts"
      to: "tests/.auth/user.json"
      via: "storageState path in chromium project"
      pattern: "storageState.*tests/.auth/user.json"
    - from: "tests/auth.setup.ts"
      to: "tests/helpers/auth.helpers.ts"
      via: "import signIn"
      pattern: "import.*signIn.*auth.helpers"
---

<objective>
Create Playwright E2E test infrastructure with real Auth0 authentication and session state caching.

Purpose: Replace the existing TEST_MODE bypass with production-realistic Auth0 OAuth flows. Session caching via Playwright's storageState pattern ensures a single Auth0 login per test run (preventing rate limiting) while validating the actual security foundation.

Output: playwright.config.ts, auth.setup.ts, auth helpers, test-context, updated .gitignore
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files for understanding auth patterns
@lib/auth0.ts
@proxy.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Playwright config and auth setup with session caching</name>
  <files>
    playwright.config.ts
    tests/auth.setup.ts
    tests/helpers/auth.helpers.ts
    tests/helpers/test-context.ts
  </files>
  <action>
Create the complete Playwright E2E test infrastructure:

**1. `playwright.config.ts`** (project root):
- Import `defineConfig, devices` from `@playwright/test`
- Import `dotenv/config` for loading `.env.test` in local dev (process.env already set in CI)
- Set `testDir: './tests'`
- Set `fullyParallel: true`
- Set `forbidOnly: !!process.env.CI` (prevent `.only` in CI)
- Set `retries: process.env.CI ? 2 : 0` (auto-retry in CI for transient Auth0 failures)
- Set `workers: process.env.CI ? 1 : undefined` (single worker in CI to avoid Auth0 rate limiting)
- Set `reporter: process.env.CI ? 'blob' : 'html'` (blob for CI merge, html for local)
- Set `timeout: 30000` (30s per test)
- Set `use.baseURL: 'http://localhost:3000'`
- Set `use.trace: 'on-first-retry'` (capture traces for debugging failures)
- Define projects array:
  1. `{ name: 'setup', testMatch: /.*\.setup\.ts/ }` - runs auth.setup.ts first
  2. `{ name: 'chromium', use: { ...devices['Desktop Chrome'], storageState: 'tests/.auth/user.json' }, dependencies: ['setup'] }` - feature tests reuse cached session
- Define `webServer` for local dev:
  ```
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120_000,
  }
  ```

**2. `tests/helpers/test-context.ts`**:
- Export `TEST_USER` object with:
  - `email: process.env.E2E_TEST_USER_EMAIL!` (non-null assertion - required env var)
  - `password: process.env.E2E_TEST_USER_PASSWORD!`
- Export `AUTH_FILE = 'tests/.auth/user.json'` constant
- Export `BASE_URL = process.env.BASE_URL || 'http://localhost:3000'` constant

**3. `tests/helpers/auth.helpers.ts`**:
- Import `Page` from `@playwright/test`
- Export `signIn(page: Page, email: string, password: string): Promise<void>`:
  - `await page.goto('/auth/login')` (uses baseURL from config)
  - Wait for Auth0 Universal Login page to load: `await page.waitForURL(/.*auth0.*/)` (Auth0 redirects from /auth/login)
  - Fill email: `await page.getByLabel('Email address').fill(email)` (Auth0 Universal Login uses "Email address" label)
  - Click Continue: `await page.getByRole('button', { name: 'Continue' }).click()`
  - Fill password: `await page.getByLabel('Password').fill(password)`
  - Click Continue again: `await page.getByRole('button', { name: 'Continue' }).click()`
  - Wait for redirect back to app: `await page.waitForURL('http://localhost:3000/**')` (any app page = success)
  - NOTE: Auth0 Universal Login has a 2-step flow (email -> password). If Auth0 UI changes, only this helper needs updating.
- Export `signOut(page: Page): Promise<void>`:
  - Navigate: `await page.goto('/auth/logout')`
  - Wait for redirect to login: `await page.waitForURL(/.*auth\/login.*/)` (Auth0 redirects to postLogoutRedirect)

**4. `tests/auth.setup.ts`**:
- Import `test as setup` from `@playwright/test`
- Import `signIn` from `./helpers/auth.helpers`
- Import `TEST_USER, AUTH_FILE` from `./helpers/test-context`
- Create setup test:
  ```typescript
  setup('authenticate', async ({ page }) => {
    await signIn(page, TEST_USER.email, TEST_USER.password);
    await page.context().storageState({ path: AUTH_FILE });
  });
  ```
- This runs ONCE before all other tests, saves cookies/localStorage/sessionStorage to user.json

**IMPORTANT NOTES:**
- Do NOT use `dotenv` package directly - use `import 'dotenv/config'` in playwright.config.ts which loads from `.env.test` automatically
- The `webServer` config starts the dev server automatically when running `npx playwright test` locally
- Auth0 label selectors (like 'Email address') may vary by Auth0 Universal Login version. Centralizing in auth.helpers.ts means single-point updates if Auth0 changes their UI.
- The `storageState` approach handles httpOnly cookies, localStorage, and sessionStorage automatically - no manual cookie management needed.
  </action>
  <verify>
  - `cat playwright.config.ts` shows setup project + chromium project with storageState
  - `cat tests/auth.setup.ts` shows signIn + storageState save
  - `cat tests/helpers/auth.helpers.ts` exports signIn and signOut functions
  - `cat tests/helpers/test-context.ts` exports TEST_USER, AUTH_FILE, BASE_URL
  - `npx tsc --noEmit tests/auth.setup.ts tests/helpers/auth.helpers.ts tests/helpers/test-context.ts` has no type errors (or verify manually that types are correct)
  </verify>
  <done>
  - playwright.config.ts defines setup+chromium projects with storageState caching
  - auth.setup.ts authenticates via real Auth0 and saves session to tests/.auth/user.json
  - Auth helpers are reusable and centralized for single-point maintenance
  - Test context provides environment-sourced credentials
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .gitignore and create tests/.auth directory</name>
  <files>
    .gitignore
  </files>
  <action>
**1. Update `.gitignore`**:
- Find the existing "# Playwright E2E" section (already has `/playwright-report/`, `/test-results/`, `/playwright/.cache/`)
- Add `tests/.auth/` to this section to prevent committing cached Auth0 session tokens
- Also add `.env.test` entry if not already covered by the `.env*` pattern (it IS covered by `.env*` glob, but add a comment for clarity)

The section should look like:
```
# Playwright E2E
/playwright-report/
/test-results/
/playwright/.cache/
tests/.auth/
```

**2. Create `tests/.auth/` directory**:
- Create `tests/.auth/.gitkeep` to ensure the directory exists in git (the actual `user.json` will be gitignored)
- Actually, since `tests/.auth/` is gitignored, the directory will be created at runtime by Playwright's `storageState({ path })` call. No need for .gitkeep since the whole dir is ignored.
- Instead, just ensure the `.gitignore` entry is correct. The directory will be auto-created when auth.setup.ts runs.
  </action>
  <verify>
  - `grep -A5 'Playwright E2E' .gitignore` shows `tests/.auth/` entry
  - `git check-ignore tests/.auth/user.json` returns the path (confirming it would be ignored)
  </verify>
  <done>
  - .gitignore prevents committing Auth0 session tokens from tests/.auth/
  - No session credential leakage risk
  </done>
</task>

</tasks>

<verification>
1. `playwright.config.ts` exists at project root with setup + chromium projects
2. `tests/auth.setup.ts` exists and uses real Auth0 flow (no TEST_MODE references)
3. `tests/helpers/auth.helpers.ts` exports signIn and signOut
4. `tests/helpers/test-context.ts` exports TEST_USER, AUTH_FILE
5. `.gitignore` includes `tests/.auth/`
6. No hardcoded credentials in any file (all from process.env)
</verification>

<success_criteria>
- Playwright config correctly defines setup project pattern with session caching
- Auth setup uses real Auth0 OAuth flow (NOT TEST_MODE bypass)
- Session state saved to tests/.auth/user.json for reuse by feature tests
- All credentials sourced from environment variables
- .gitignore prevents credential leakage
</success_criteria>

<output>
After completion, create `.planning/phases/51-e2e-test-improvements/51-01-SUMMARY.md`
</output>
