---
phase: 51-e2e-test-improvements
plan: 03
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - tests/features/notification-delivery.spec.ts
  - .github/workflows/playwright.yml
autonomous: true
user_setup:
  - service: auth0
    why: "E2E tests need a dedicated Auth0 test user account"
    env_vars:
      - name: E2E_TEST_USER_EMAIL
        source: "Auth0 Dashboard -> User Management -> Users -> test account email"
      - name: E2E_TEST_USER_PASSWORD
        source: "Auth0 Dashboard -> User Management -> Users -> test account password"
    dashboard_config:
      - task: "Create a test user account in Auth0 (if not already existing)"
        location: "Auth0 Dashboard -> User Management -> Users -> Create User"
  - service: github
    why: "CI needs encrypted secrets for Auth0 credentials"
    env_vars:
      - name: E2E_TEST_USER_EMAIL
        source: "Same email as Auth0 test user"
      - name: E2E_TEST_USER_PASSWORD
        source: "Same password as Auth0 test user"
      - name: AUTH0_ISSUER_BASE_URL
        source: "Auth0 Dashboard -> Applications -> Settings -> Domain (with https://)"
      - name: AUTH0_CLIENT_ID
        source: "Auth0 Dashboard -> Applications -> Settings -> Client ID"
      - name: AUTH0_CLIENT_SECRET
        source: "Auth0 Dashboard -> Applications -> Settings -> Client Secret"
      - name: AUTH0_SECRET
        source: "Generate with: openssl rand -hex 32"
    dashboard_config:
      - task: "Add secrets to GitHub repository"
        location: "GitHub -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "Notification delivery test verifies notification system is initialized and test send works"
    - "GitHub Actions workflow runs Playwright tests on every PR to main"
    - "CI workflow installs Chromium, starts dev server, runs tests, and uploads report artifact"
    - "All Auth0 credentials are stored as GitHub encrypted secrets (not in workflow file)"
    - "Playwright report artifact is uploaded on every run for debugging"
  artifacts:
    - path: "tests/features/notification-delivery.spec.ts"
      provides: "Notification delivery critical flow test"
      contains: "notification"
    - path: ".github/workflows/playwright.yml"
      provides: "CI workflow for Playwright E2E tests"
      contains: "playwright test"
  key_links:
    - from: ".github/workflows/playwright.yml"
      to: "playwright.config.ts"
      via: "npx playwright test reads config"
      pattern: "npx playwright test"
    - from: ".github/workflows/playwright.yml"
      to: "GitHub Secrets"
      via: "secrets.E2E_TEST_USER_EMAIL, secrets.AUTH0_*"
      pattern: "secrets\\."
    - from: "tests/features/notification-delivery.spec.ts"
      to: "app/settings/notifications"
      via: "navigates to notification settings page"
      pattern: "page.goto.*notifications"
---

<objective>
Create notification delivery E2E test and GitHub Actions CI workflow for automated Playwright testing.

Purpose: The notification test validates client-side FCM initialization and test-send flow (real FCM delivery is verified manually). The CI workflow ensures E2E tests run automatically on every PR, catching regressions early with secure credential management.

Output: notification-delivery.spec.ts, .github/workflows/playwright.yml
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-e2e-test-improvements/51-01-SUMMARY.md

# Source files for understanding notification UI
@app/settings/notifications/page.tsx
@.github/workflows/cron-scheduler.yml
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification delivery E2E test</name>
  <files>
    tests/features/notification-delivery.spec.ts
  </files>
  <action>
Create `tests/features/notification-delivery.spec.ts` for testing the notification system.

**IMPORTANT**: Before writing selectors, READ `app/settings/notifications/page.tsx` to understand the actual page structure, button labels, and test IDs. The notification delivery test validates the client-side notification setup flow, not actual FCM delivery (which requires a real device/service worker).

```typescript
import { test, expect } from '@playwright/test';

test.describe('Notification Delivery Flow', () => {
  test.beforeEach(async ({ page }) => {
    // Navigate to notification settings page
    await page.goto('/settings/notifications');
    await page.waitForLoadState('networkidle');
  });

  test('should display notification settings page', async ({ page }) => {
    // Verify the page loads with notification settings content
    // NOTE: Read app/settings/notifications/page.tsx for actual heading/content
    const heading = page.getByRole('heading', { name: /notifiche|notification/i });
    await expect(heading.first()).toBeVisible({ timeout: 15000 });
  });

  test('should show notification preference toggles', async ({ page }) => {
    // Verify notification type toggles are present (Alerts, System, etc.)
    // NOTE: Read the actual page component for toggle labels
    const toggles = page.getByRole('switch');

    // Should have at least one notification type toggle
    const toggleCount = await toggles.count();
    expect(toggleCount).toBeGreaterThan(0);
  });

  test('should have test notification capability', async ({ page }) => {
    // Look for test notification button
    // NOTE: Read app/settings/notifications/page.tsx for actual button text
    const testButton = page.getByRole('button', { name: /test|prova|invia/i });

    // Test send button should be visible
    await expect(testButton.first()).toBeVisible({ timeout: 10000 });
  });

  // NOTE: We do NOT click the test notification button because:
  // 1. FCM requires service worker registration (not available in Playwright by default)
  // 2. Push notifications require real device permissions
  // 3. The client-side flow is better verified by unit tests
  // This E2E test validates the UI is accessible and functional
  test('should display device registration info', async ({ page }) => {
    // The notification page should show device registration status
    // NOTE: Read the actual component to determine what device info is displayed
    const deviceInfo = page.getByText(/dispositiv|device|registrat/i);

    // Some device-related text should be present
    await expect(deviceInfo.first()).toBeVisible({ timeout: 15000 });
  });
});
```

**IMPLEMENTATION NOTES:**
1. **READ THE ACTUAL PAGE**: The executor MUST read `app/settings/notifications/page.tsx` and `app/components/NotificationPreferencesPanel.tsx` to use real element names.
2. **No FCM interaction**: Playwright cannot interact with Push API / Service Workers in a meaningful way. The test validates UI rendering and accessibility of notification controls.
3. **FCM mocking recommendation**: For future iterations, a test helper API endpoint (like `/api/test-helpers/verify-notification-system`) could validate server-side FCM setup without requiring browser push permissions.
4. **Generous timeouts**: The notification settings page may load user preferences from Firebase, requiring wait time.
  </action>
  <verify>
  - `cat tests/features/notification-delivery.spec.ts` shows 4 tests for notification UI
  - Tests use cached storageState (no per-test auth)
  - No actual FCM interaction (read-only UI verification)
  - Selectors use role-based approach
  </verify>
  <done>
  - Notification delivery test verifies settings page renders with toggles and test button
  - Tests validate UI accessibility without requiring FCM service worker
  - All assertions use Playwright auto-waiting with generous timeouts
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow for Playwright</name>
  <files>
    .github/workflows/playwright.yml
  </files>
  <action>
Create `.github/workflows/playwright.yml` for automated E2E testing on PRs.

```yaml
name: Playwright E2E Tests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  e2e-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build
        env:
          # Auth0 config needed for build (middleware references env vars)
          AUTH0_BASE_URL: "http://localhost:3000"
          AUTH0_ISSUER_BASE_URL: ${{ secrets.AUTH0_ISSUER_BASE_URL }}
          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
          AUTH0_SECRET: ${{ secrets.AUTH0_SECRET }}
          # Firebase config (needed for build)
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY || 'dummy-for-build' }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN || 'dummy-for-build' }}
          NEXT_PUBLIC_FIREBASE_DATABASE_URL: ${{ secrets.NEXT_PUBLIC_FIREBASE_DATABASE_URL || 'dummy-for-build' }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID || 'dummy-for-build' }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET || 'dummy-for-build' }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID || 'dummy-for-build' }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID || 'dummy-for-build' }}

      - name: Run Playwright tests
        run: npx playwright test
        env:
          # Auth0 runtime config
          AUTH0_BASE_URL: "http://localhost:3000"
          AUTH0_ISSUER_BASE_URL: ${{ secrets.AUTH0_ISSUER_BASE_URL }}
          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
          AUTH0_SECRET: ${{ secrets.AUTH0_SECRET }}
          # E2E test user credentials
          E2E_TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          E2E_TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}
          # Firebase config (runtime)
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_DATABASE_URL: ${{ secrets.NEXT_PUBLIC_FIREBASE_DATABASE_URL }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          # CI flag (used by playwright.config.ts for retries, workers)
          CI: true

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7
```

**IMPLEMENTATION NOTES:**
1. **Build before test**: CI needs `npm run build` to create the production build, then `npx playwright test` uses the `webServer` config from `playwright.config.ts` to start `npm run start` (or the config uses `npm run dev`). UPDATE: The playwright.config.ts from plan 01 uses `npm run dev` which is fine - it auto-starts the dev server. However, in CI it is better to build first and serve the built app. The executor should check if the webServer in playwright.config.ts should be `npm run start` for CI and `npm run dev` for local. A simple approach: keep `npm run dev` in playwright.config.ts but override in CI with `npx playwright test` + manual server start. Actually, the simplest approach: keep `npm run dev` in config, and since the webServer config has `reuseExistingServer: !process.env.CI`, in CI it will NOT reuse and will start fresh. This means the build step is for faster startup in CI. BUT `npm run dev` does not require a build. So REMOVE the build step, or change webServer to use `npm run start` (which requires build). The BETTER approach for CI: change playwright.config.ts webServer to `command: process.env.CI ? 'npm run start' : 'npm run dev'` and keep the build step. The executor should update playwright.config.ts accordingly.
2. **Secrets management**: All Auth0 and Firebase credentials come from GitHub encrypted secrets. The user must configure these in the repository settings.
3. **Report artifacts**: `playwright-report/` uploaded on every run (for PR checks), `test-results/` (with traces) uploaded only on failure.
4. **Timeout**: 15 minutes should be plenty for auth setup + 10-15 tests.
5. **Single worker in CI**: `workers: 1` in playwright.config.ts when `CI=true` prevents Auth0 rate limiting from parallel test processes.
6. **Retries**: `retries: 2` in CI catches transient Auth0 failures.
7. **Firebase env vars**: Some may not be available as GitHub secrets yet. Use fallback values for build step to prevent build failures. At runtime, the tests will need real Firebase config to interact with the app.
  </action>
  <verify>
  - `cat .github/workflows/playwright.yml` shows workflow with PR and push triggers
  - Workflow installs chromium, runs playwright test, uploads artifacts
  - All credentials use `${{ secrets.* }}` (no hardcoded values)
  - Upload artifacts step has `if: always()` for report and `if: failure()` for traces
  - Timeout is set to 15 minutes
  </verify>
  <done>
  - GitHub Actions workflow runs Playwright E2E tests on every PR to main
  - CI installs Chromium browser, runs tests with encrypted secrets
  - Playwright report uploaded as artifact on every run for debugging
  - Test traces uploaded on failure for detailed debugging
  - All credentials stored as GitHub encrypted secrets
  </done>
</task>

</tasks>

<verification>
1. `tests/features/notification-delivery.spec.ts` exists with notification UI tests
2. `.github/workflows/playwright.yml` exists with PR-triggered E2E test job
3. CI workflow references only GitHub secrets (no hardcoded credentials)
4. Playwright report artifact uploaded on every run
5. Test traces uploaded on failure only
6. CI uses single worker to prevent Auth0 rate limiting
</verification>

<success_criteria>
- Notification delivery test verifies notification settings UI renders correctly
- GitHub Actions CI runs Playwright tests automatically on every PR
- All credentials managed via GitHub encrypted secrets
- Playwright report and traces available as artifacts for debugging
- CI uses 2x retries and single worker for stability
</success_criteria>

<output>
After completion, create `.planning/phases/51-e2e-test-improvements/51-03-SUMMARY.md`
</output>
