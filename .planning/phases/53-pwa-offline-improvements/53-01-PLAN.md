---
phase: 53-pwa-offline-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/ui/OfflineBanner.tsx
  - app/components/ui/__tests__/OfflineBanner.test.tsx
autonomous: true

must_haves:
  truths:
    - "Offline banner appears as sticky top element pushing content down when connection is lost"
    - "Banner shows 'Offline' status with timestamp of last successful data update"
    - "Banner uses dark/muted Ember Noir styling (informational, not alarming)"
    - "Pending offline commands are listed inside the banner with device name, action, timestamp, and cancel button"
    - "User can cancel individual queued commands from the banner"
  artifacts:
    - path: "app/components/ui/OfflineBanner.tsx"
      provides: "Enhanced offline banner with command queue UI"
      min_lines: 100
    - path: "app/components/ui/__tests__/OfflineBanner.test.tsx"
      provides: "Tests for offline banner rendering and command queue"
      min_lines: 50
  key_links:
    - from: "app/components/ui/OfflineBanner.tsx"
      to: "lib/hooks/useOnlineStatus"
      via: "hook import"
      pattern: "useOnlineStatus"
    - from: "app/components/ui/OfflineBanner.tsx"
      to: "lib/hooks/useBackgroundSync"
      via: "hook import for pending commands"
      pattern: "useBackgroundSync"
---

<objective>
Enhance the existing OfflineBanner component to match user decisions: sticky top banner with dark/muted Ember Noir styling, timestamp of last update, and expandable command queue with per-command cancel capability.

Purpose: Users need clear, informational offline awareness and visibility of pending commands to feel in control during connectivity loss.
Output: Fully redesigned OfflineBanner.tsx with command queue UI + tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/components/ui/OfflineBanner.tsx
@app/components/ui/Banner.tsx
@lib/hooks/useOnlineStatus.ts
@lib/hooks/useBackgroundSync.ts
@lib/pwa/backgroundSync.ts
@app/components/ClientProviders.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign OfflineBanner with Ember Noir styling and command queue</name>
  <files>app/components/ui/OfflineBanner.tsx</files>
  <action>
Rewrite OfflineBanner.tsx to implement all user-locked decisions:

**Layout & Positioning:**
- Fixed at the very top of the viewport (`fixed top-0 left-0 right-0 z-[60]`)
- Pushes content down (add padding-top to body/main when banner visible via CSS or state)
- Use `rounded-none` for sticky top (no rounded corners)

**Styling (Ember Noir, NOT alarming):**
- Dark/muted background: `bg-slate-800/95 backdrop-blur-lg border-b border-slate-700/50` (dark mode)
- Light mode: `bg-slate-100/95 border-b border-slate-200`
- Use subtle informational icon (WifiOff from lucide-react), NOT warning colors
- Text colors: `text-slate-200` (dark) / `text-slate-700` (light) — muted, informational

**Content:**
- Title: "Sei offline" (Italian per spec)
- Subtitle: "Ultimo aggiornamento: X fa" using `formatDistanceToNow` from date-fns with Italian locale
- Use `lastOnlineAt` from `useOnlineStatus` hook for the timestamp

**Command Queue Section (expandable within banner):**
- When `pendingCommands.length > 0`, show a section below the title
- Header: "Comandi in coda ({count})"
- Each command shows: device name/action label, timestamp, and cancel button
- Use `formatCommandForDisplay` data (already returns `label`, `formattedTime`)
- Cancel button: small, outline/subtle variant, calls `cancelCommand(id)` from `useBackgroundSync`
- Commands displayed in a compact list with `bg-white/5` (dark) / `bg-slate-200/50` (light) rounded items

**Reconnect state:**
- When `wasOffline` is true (transition from offline->online), show brief "Connessione ripristinata" with success styling
- Keep existing 3-second auto-dismiss behavior

**Synced command notification:**
- Keep existing behavior for `lastSyncedCommand` display

**Animation:**
- Use `animate-fade-in-up` or similar CSS transition for banner appearance
- Smooth height transition when command queue expands/collapses

**Props interface:**
- Keep existing props: `showPendingCount`, `fixed`, `className`
- All remain backward-compatible with `ClientProviders.tsx` usage: `<OfflineBanner fixed showPendingCount />`

**IMPORTANT:** This component is already imported and used in `ClientProviders.tsx`. Do NOT change the import path or export name. The `OfflineBanner` is exported from `app/components/ui/index.ts` — keep this.
  </action>
  <verify>Component renders correctly in isolation. TypeScript compiles without errors: `npx tsc --noEmit --pretty 2>&1 | grep -i OfflineBanner` shows no errors.</verify>
  <done>OfflineBanner displays sticky top banner with Ember Noir styling, timestamp, command queue with cancel buttons, and reconnect notification.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for enhanced OfflineBanner</name>
  <files>app/components/ui/__tests__/OfflineBanner.test.tsx</files>
  <action>
Create or update test file for OfflineBanner. Mock `useOnlineStatus` and `useBackgroundSync` hooks.

**Test cases:**
1. Does not render when online with no special messages
2. Renders offline banner with "Sei offline" title when `isOnline=false`
3. Shows last online timestamp using `lastOnlineAt` value
4. Shows command queue section when pendingCommands has items
5. Each command shows label, time, and cancel button
6. Cancel button calls `cancelCommand` with correct id
7. Reconnect banner shows "Connessione ripristinata" when `wasOffline=true`
8. Synced command notification shows correct action label
9. Fixed positioning applied when `fixed={true}` prop

**Mock patterns:**
```typescript
jest.mock('@/lib/hooks/useOnlineStatus', () => ({
  useOnlineStatus: jest.fn(),
}));
jest.mock('@/lib/hooks/useBackgroundSync', () => ({
  useBackgroundSync: jest.fn(),
}));
```

Use `@testing-library/react` for rendering and assertions. Follow existing test patterns in codebase.
  </action>
  <verify>Run `npm test -- --testPathPattern="OfflineBanner" --no-coverage` — all tests pass.</verify>
  <done>All OfflineBanner test cases pass covering offline state, command queue, cancel interaction, reconnect message.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. `npm test -- --testPathPattern="OfflineBanner" --no-coverage` all tests pass
3. OfflineBanner is still properly exported from `app/components/ui/index.ts`
4. `ClientProviders.tsx` still imports and renders OfflineBanner without changes
</verification>

<success_criteria>
- OfflineBanner shows sticky top banner with Ember Noir styling when offline
- Last successful update timestamp displayed
- Pending commands listed with cancel capability
- Reconnect notification works
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/53-pwa-offline-improvements/53-01-SUMMARY.md`
</output>
