---
phase: 53-pwa-offline-improvements
plan: 03
type: execute
wave: 2
depends_on: [01, 02]
files_modified:
  - app/components/devices/stove/StoveCard.tsx
  - app/components/devices/thermostat/ThermostatCard.tsx
  - lib/pwa/backgroundSync.ts
autonomous: true

must_haves:
  truths:
    - "StoveCard hides all write controls (ACCENDI, SPEGNI, fan/power adjustment, mode buttons) when offline"
    - "StoveCard shows 'Controlli non disponibili offline' message in place of hidden controls"
    - "StoveCard shows staleness indicator with 'Ultimo aggiornamento: X fa' when cached data > 30 seconds old"
    - "StoveCard dims (opacity) when data is stale"
    - "ThermostatCard hides temperature adjustment controls and mode buttons when offline"
    - "ThermostatCard shows staleness indicator when cached data > 30 seconds old"
    - "Mid-action going offline cancels action immediately with notification"
    - "Expired safety-critical commands are rejected during queue processing"
  artifacts:
    - path: "app/components/devices/stove/StoveCard.tsx"
      provides: "Offline-aware stove controls with staleness UI"
      contains: "useDeviceStaleness"
    - path: "app/components/devices/thermostat/ThermostatCard.tsx"
      provides: "Offline-aware thermostat controls with staleness UI"
      contains: "useOnlineStatus"
    - path: "lib/pwa/backgroundSync.ts"
      provides: "Command expiration in queue processing"
      contains: "isCommandExpired"
  key_links:
    - from: "app/components/devices/stove/StoveCard.tsx"
      to: "lib/hooks/useDeviceStaleness"
      via: "import for staleness UI"
      pattern: "useDeviceStaleness"
    - from: "app/components/devices/stove/StoveCard.tsx"
      to: "lib/hooks/useOnlineStatus"
      via: "import for control hiding"
      pattern: "isOnline"
    - from: "lib/pwa/backgroundSync.ts"
      to: "lib/pwa/stalenessDetector.ts"
      via: "import isCommandExpired"
      pattern: "isCommandExpired"
---

<objective>
Integrate offline safety behavior into device cards: hide controls when offline, show staleness indicators, handle mid-action cancellation, and enforce command expiration in the queue processor.

Purpose: Users must not be able to execute device commands on stale state. Controls hidden entirely when offline (per user decision) prevents dangerous actions. Command expiration adds safety for extended offline periods.
Output: Modified StoveCard, ThermostatCard, and backgroundSync with offline safety
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/components/devices/stove/StoveCard.tsx
@app/components/devices/thermostat/ThermostatCard.tsx
@lib/pwa/backgroundSync.ts
@lib/pwa/stalenessDetector.ts
@lib/hooks/useDeviceStaleness.ts
@lib/hooks/useOnlineStatus.ts
@.planning/phases/53-pwa-offline-improvements/53-01-SUMMARY.md
@.planning/phases/53-pwa-offline-improvements/53-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add offline safety and staleness UI to StoveCard</name>
  <files>app/components/devices/stove/StoveCard.tsx</files>
  <action>
Modify StoveCard to implement all user-locked decisions:

**1. Import useDeviceStaleness:**
```typescript
import { useDeviceStaleness } from '@/lib/hooks/useDeviceStaleness';
```

**2. Add staleness tracking:**
```typescript
const staleness = useDeviceStaleness('stove');
```

**3. Staleness indicator on the status display:**
- When `staleness?.isStale` is true, add `opacity-60` class to the main status display box
- Show "Ultimo aggiornamento: X fa" text below the status badge area
- Use `getCacheAge(staleness.cachedAt.toISOString())` from `offlineStateCache.ts` or format with date-fns `formatDistanceToNow`
- Only show when staleness data is available (`staleness?.cachedAt !== null`)

**4. Hide controls when offline (user decision: "Controls hidden entirely"):**
- Wrap the PRIMARY ACTIONS section (ACCENDI/SPEGNI buttons) with `{isOnline && (...)}`
- Wrap the "Regolazioni" section (fan + power controls) with `{isOnline && (...)}`
- Wrap the "Modalità Controllo" section (mode buttons) with `{isOnline && (...)}`
- When offline (`!isOnline`), show a single informational message in place of controls:
  ```tsx
  {!isOnline && (
    <div className="p-6 text-center">
      <Text variant="secondary" size="sm">
        Controlli non disponibili offline
      </Text>
    </div>
  )}
  ```

**5. Mid-action cancellation (user decision: "action cancelled immediately"):**
- Modify `handleIgnite` and `handleShutdown`: Remove the existing offline queueing behavior. Per user decision, controls are now HIDDEN when offline, so users can't initiate actions. But add AbortController protection for mid-flight requests:
  ```typescript
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000);

  try {
    await fetch(STOVE_ROUTES.ignite, {
      method: 'POST',
      body: JSON.stringify({ source: 'manual' }),
      signal: controller.signal,
    });
  } catch (error) {
    if ((error as Error).name === 'AbortError') {
      setToast({
        message: 'Connessione persa — azione annullata',
        variant: 'error',
      });
      setLoading(false);
      return;
    }
    throw error;
  } finally {
    clearTimeout(timeoutId);
  }
  ```
- Apply same pattern to `handleShutdown`, `handleFanChange`, `handlePowerChange`

**6. Keep status info visible offline:**
- The status display (status badge, fan/power info boxes) should remain visible even offline (read-only)
- Only hide interactive controls (buttons, sliders, mode toggles)
- Maintenance status, CronHealthBanner remain visible offline too

**IMPORTANT:** Do NOT remove the `useOnlineStatus` and `useBackgroundSync` imports — they're still used for other features. Remove only the offline queueing branches in handleIgnite/handleShutdown since controls are now hidden when offline per user decision.
  </action>
  <verify>`npx tsc --noEmit 2>&1 | grep StoveCard` shows no errors. Component logic is correct (controls hidden when offline, staleness shown when stale).</verify>
  <done>StoveCard hides all write controls when offline, shows staleness indicator when data is stale, and cancels mid-flight requests on connection loss.</done>
</task>

<task type="auto">
  <name>Task 2: Add offline safety and staleness UI to ThermostatCard</name>
  <files>app/components/devices/thermostat/ThermostatCard.tsx</files>
  <action>
Modify ThermostatCard to match StoveCard offline behavior:

**1. Add imports:**
```typescript
import { useOnlineStatus } from '@/lib/hooks/useOnlineStatus';
import { useDeviceStaleness } from '@/lib/hooks/useDeviceStaleness';
```

**2. Add hooks:**
```typescript
const { isOnline } = useOnlineStatus();
const staleness = useDeviceStaleness('thermostat');
```

**3. Staleness indicator:**
- When `staleness?.isStale`, add `opacity-60` class to the temperature display section
- Show "Ultimo aggiornamento: X fa" below the temperature grid
- Use date-fns `formatDistanceToNow` with Italian locale

**4. Hide controls when offline:**
- Wrap quick temperature controls (+ 0.5° / − 0.5° buttons) with `{isOnline && (...)}`
- Wrap mode control grid (Auto, Away, Gelo, Off buttons) with `{isOnline && (...)}`
- Wrap schedule change select with `{isOnline && (...)}`
- Wrap calibrate button with `{isOnline && (...)}`
- Keep temperature display, room selector, device info VISIBLE (read-only)
- When offline, show `"Controlli non disponibili offline"` message where controls were

**5. Mid-action cancellation:**
- Add AbortController to `handleModeChange`, `handleTemperatureChange`, `handleCalibrateValves`, `handleScheduleChange`
- On abort: show toast "Connessione persa — azione annullata"
- 10-second timeout for all fetch operations

**6. Keep existing error handling and retry logic** — just wrap with AbortController.
  </action>
  <verify>`npx tsc --noEmit 2>&1 | grep ThermostatCard` shows no errors.</verify>
  <done>ThermostatCard hides write controls when offline, shows staleness indicator, and cancels mid-flight requests on connection loss.</done>
</task>

<task type="auto">
  <name>Task 3: Add command expiration to backgroundSync queue processor</name>
  <files>lib/pwa/backgroundSync.ts</files>
  <action>
Integrate command expiration into the queue processing logic:

**1. Import isCommandExpired:**
```typescript
import { isCommandExpired } from './stalenessDetector';
```

**2. Modify processQueue function:**
In the `for (const command of pendingCommands)` loop, before executing, check expiration:

```typescript
// Check command expiration (safety: stale-intent protection)
if (isCommandExpired({ endpoint: command.endpoint, timestamp: command.timestamp })) {
  // Remove expired command from queue
  await remove(STORES.COMMAND_QUEUE, command.id!);
  console.warn(`[BackgroundSync] Command expired (${command.endpoint}, queued at ${command.timestamp})`);
  failed++; // Count as failed for reporting
  continue;
}
```

Add this check right after `// Mark as processing` and before `// Execute the command`.

**3. Keep all existing behavior** — retry logic, status tracking, etc. remain unchanged.
  </action>
  <verify>`npx tsc --noEmit 2>&1 | grep backgroundSync` shows no errors. `npm test -- --testPathPattern="backgroundSync" --no-coverage` passes.</verify>
  <done>Queue processor rejects expired safety-critical commands before execution.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes without errors
2. StoveCard hides controls when offline, shows staleness when stale
3. ThermostatCard hides controls when offline, shows staleness when stale
4. backgroundSync rejects expired commands during queue processing
5. Existing tests still pass: `npm test -- --testPathPattern="backgroundSync" --no-coverage`
</verification>

<success_criteria>
- Device cards show staleness indicator when cached data > 30 seconds old
- Device cards hide all write controls when offline
- Mid-action connection loss cancels with user notification
- Expired commands rejected in queue processor
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/53-pwa-offline-improvements/53-03-SUMMARY.md`
</output>
