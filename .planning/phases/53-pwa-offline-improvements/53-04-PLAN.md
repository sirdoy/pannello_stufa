---
phase: 53-pwa-offline-improvements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/hooks/useInstallPrompt.ts
  - lib/pwa/installPromptService.ts
  - app/components/pwa/InstallPrompt.tsx
  - lib/hooks/__tests__/useInstallPrompt.test.ts
  - app/components/pwa/__tests__/InstallPrompt.test.tsx
autonomous: true

must_haves:
  truths:
    - "PWA install prompt appears as bottom sheet after 2+ visits"
    - "Install prompt has guided UI with benefits (offline, notifications, home screen)"
    - "Install prompt can be dismissed and does not reappear for 30 days"
    - "iOS users see Add to Home Screen instructions instead of native prompt"
    - "Install prompt uses beforeinstallprompt API on supported browsers"
  artifacts:
    - path: "lib/hooks/useInstallPrompt.ts"
      provides: "Hook managing beforeinstallprompt event, visit counting, dismissal tracking"
      exports: ["useInstallPrompt"]
      min_lines: 40
    - path: "lib/pwa/installPromptService.ts"
      provides: "localStorage-based visit tracking and dismissal persistence"
      exports: ["getVisitCount", "incrementVisitCount", "isDismissed", "dismissPrompt", "isIOSDevice", "isStandalone"]
      min_lines: 30
    - path: "app/components/pwa/InstallPrompt.tsx"
      provides: "Bottom sheet install prompt component"
      min_lines: 50
    - path: "lib/hooks/__tests__/useInstallPrompt.test.ts"
      provides: "Tests for install prompt hook"
      min_lines: 40
  key_links:
    - from: "lib/hooks/useInstallPrompt.ts"
      to: "lib/pwa/installPromptService.ts"
      via: "import for visit/dismissal tracking"
      pattern: "installPromptService"
    - from: "app/components/pwa/InstallPrompt.tsx"
      to: "lib/hooks/useInstallPrompt.ts"
      via: "hook import"
      pattern: "useInstallPrompt"
---

<objective>
Create PWA install prompt with bottom sheet UI, beforeinstallprompt event handling, 2+ visit requirement, 30-day dismissal tracking, and iOS fallback instructions.

Purpose: Guide users toward installing the PWA for better mobile experience (offline, notifications, home screen) with a non-intrusive bottom sheet that respects dismissal.
Output: useInstallPrompt hook + installPromptService + InstallPrompt component + tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/components/ui/Banner.tsx
@app/layout.tsx
@app/components/ClientProviders.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create installPromptService and useInstallPrompt hook</name>
  <files>lib/pwa/installPromptService.ts, lib/hooks/useInstallPrompt.ts, lib/hooks/__tests__/useInstallPrompt.test.ts</files>
  <action>
**installPromptService.ts** — Pure utility functions (no React):

```typescript
const VISIT_COUNT_KEY = 'pwa-visit-count';
const DISMISS_KEY = 'pwa-prompt-dismissed';
const DISMISS_DAYS = 30;

export function getVisitCount(): number
export function incrementVisitCount(): number
export function isDismissed(): boolean  // checks 30-day window
export function dismissPrompt(): void  // stores current timestamp
export function isIOSDevice(): boolean  // checks navigator.userAgent for iPhone/iPad/iPod
export function isStandalone(): boolean  // checks window.matchMedia('(display-mode: standalone)') or navigator.standalone
export function canUseLocalStorage(): boolean  // try/catch test
```

**Key logic:**
- `isDismissed()`: Get timestamp from localStorage, return true if less than 30 days ago
- `isIOSDevice()`: Check for iPhone/iPad/iPod in userAgent (handle iPadOS which reports as Macintosh)
- `isStandalone()`: Check if already installed (don't show prompt if already PWA)
- All functions handle `typeof window === 'undefined'` for SSR safety
- Use try/catch for localStorage access (private browsing fallback)

**useInstallPrompt.ts** — React hook:

```typescript
interface UseInstallPromptReturn {
  canInstall: boolean;      // Should show the prompt
  isIOS: boolean;           // Show iOS instructions instead
  install: () => Promise<boolean>;  // Trigger native prompt
  dismiss: () => void;      // Dismiss with 30-day cooldown
}

export function useInstallPrompt(): UseInstallPromptReturn
```

**Hook logic:**
1. On mount: increment visit count
2. Listen for `beforeinstallprompt` event → capture deferredPrompt, prevent default
3. Determine `canInstall`:
   - NOT standalone (not already installed)
   - Visits >= 2
   - NOT dismissed (within 30 days)
   - Either has deferredPrompt (Chrome/Edge) OR is iOS (show instructions)
4. `install()`: Call `deferredPrompt.prompt()`, await `userChoice`, return whether accepted
5. `dismiss()`: Call `dismissPrompt()`, set canInstall to false
6. Detect iOS: `isIOSDevice()` from service

**Tests (useInstallPrompt.test.ts):**
- Mock localStorage, navigator.userAgent, window.matchMedia
- Test visit count increment on mount
- Test canInstall=false when < 2 visits
- Test canInstall=true when >= 2 visits and not dismissed
- Test canInstall=false when dismissed within 30 days
- Test canInstall=true when dismissed > 30 days ago
- Test iOS detection returns isIOS=true
- Test standalone detection suppresses prompt
- Test dismiss() stores timestamp and sets canInstall=false
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep -E "installPrompt|useInstallPrompt"` shows no errors.
`npm test -- --testPathPattern="useInstallPrompt" --no-coverage` passes.
  </verify>
  <done>Install prompt service and hook work correctly with visit counting, dismissal tracking, iOS detection, and beforeinstallprompt handling.</done>
</task>

<task type="auto">
  <name>Task 2: Create InstallPrompt bottom sheet component with tests</name>
  <files>app/components/pwa/InstallPrompt.tsx, app/components/pwa/__tests__/InstallPrompt.test.tsx</files>
  <action>
**InstallPrompt.tsx** — Bottom sheet component:

Create `app/components/pwa/` directory if it doesn't exist.

**Do NOT use react-modal-sheet** (per CLAUDE.md rule: NEVER execute `npm install`). Instead, build a custom bottom sheet using existing design system primitives and CSS transforms. The app already has a Sheet component (from v4.0 Radix Dialog-based). Use it or build a simple slide-up panel.

**Implementation approach — Custom animated bottom sheet:**
```tsx
'use client';

import { useInstallPrompt } from '@/lib/hooks/useInstallPrompt';
import { Download, Wifi, Bell, Smartphone, Share, X } from 'lucide-react';
import Button from '../ui/Button';
import { Heading, Text } from '../ui';
import { cn } from '@/lib/utils/cn';
```

**Layout (bottom sheet style — slides up from bottom):**
- Fixed position: `fixed bottom-0 left-0 right-0 z-[55]`
- Backdrop: semi-transparent overlay
- Sheet: rounded top corners, slides up with CSS transition
- Drag handle: small bar at top (visual indicator, decorative)

**Content for Chrome/Android (native install):**
- Icon: Download from lucide-react with ember color
- Title: "Installa Pannello Stufa" (Heading level 2)
- Benefits list with icons (Ember Noir tone, Italian):
  - Wifi icon: "Funziona anche offline"
  - Bell icon: "Notifiche push in tempo reale"
  - Smartphone icon: "Accesso rapido dalla home screen"
- Install button: `variant="ember"`, full width, calls `install()`
- Dismiss button: `variant="subtle"`, full width, "Non ora", calls `dismiss()`

**Content for iOS (instructions):**
- Same benefits section
- Instead of install button, show step-by-step instructions:
  - "1. Tocca" + Share icon + "nella barra del browser"
  - "2. Seleziona 'Aggiungi alla schermata Home'"
- Dismiss button still available

**Animation:**
- Entry: translate-y from 100% to 0 with `transition-transform duration-300 ease-out`
- Exit: translate-y back to 100%
- Backdrop: opacity fade in/out

**Styling (Ember Noir):**
- Sheet background: `bg-slate-900 border-t border-slate-700/50` (dark) / `bg-white border-t border-slate-200` (light)
- Benefits list items: subtle icon color matching Ember Noir palette
- Install button: ember variant (already exists in Button component)

**Tests (InstallPrompt.test.tsx):**
- Mock useInstallPrompt hook
- When canInstall=false: renders nothing
- When canInstall=true and isIOS=false: renders install button and benefits
- When canInstall=true and isIOS=true: renders iOS instructions instead of install button
- Clicking install button calls install()
- Clicking dismiss button calls dismiss()
- Benefits text is present (offline, notifications, home screen)
  </action>
  <verify>
`npx tsc --noEmit 2>&1 | grep InstallPrompt` shows no errors.
`npm test -- --testPathPattern="InstallPrompt" --no-coverage` passes.
  </verify>
  <done>InstallPrompt bottom sheet renders with benefits, handles native install and iOS instructions, and can be dismissed with 30-day cooldown.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. All install prompt tests pass
3. Component renders nothing when canInstall=false
4. Component shows bottom sheet with benefits when canInstall=true
5. iOS fallback shows manual instructions
6. Dismiss hides and records 30-day cooldown
</verification>

<success_criteria>
- PWA install prompt appears after 2+ visits with guided UI
- Bottom sheet slides up from bottom with Ember Noir styling
- Benefits clearly listed: offline, notifications, home screen
- 30-day dismissal tracking via localStorage
- iOS users see manual Add to Home Screen instructions
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/53-pwa-offline-improvements/53-04-SUMMARY.md`
</output>
