---
phase: 53-pwa-offline-improvements
plan: 05
type: execute
wave: 3
depends_on: [01, 02, 03, 04]
files_modified:
  - app/components/ClientProviders.tsx
  - app/components/ui/OfflineBanner.tsx
autonomous: true

must_haves:
  truths:
    - "InstallPrompt component rendered in root layout via ClientProviders"
    - "Reconnect toast shows 'Comandi sincronizzati' when offline commands sync on reconnect"
    - "OfflineBanner and InstallPrompt coexist without z-index conflicts"
    - "All phase 53 features work together end-to-end"
  artifacts:
    - path: "app/components/ClientProviders.tsx"
      provides: "Root provider with InstallPrompt integration"
      contains: "InstallPrompt"
    - path: "app/components/ui/OfflineBanner.tsx"
      provides: "Reconnect sync toast integrated into banner"
      contains: "Comandi sincronizzati"
  key_links:
    - from: "app/components/ClientProviders.tsx"
      to: "app/components/pwa/InstallPrompt"
      via: "component import and render"
      pattern: "InstallPrompt"
    - from: "app/components/ui/OfflineBanner.tsx"
      to: "lib/hooks/useBackgroundSync"
      via: "lastSyncedCommand for reconnect toast"
      pattern: "lastSyncedCommand"
---

<objective>
Wire InstallPrompt into the app root, finalize reconnect sync toast, and verify all phase 53 features integrate correctly.

Purpose: All offline improvements must be wired into the app and work together â€” banner at top, install prompt at bottom, sync toast on reconnect, controls hidden when offline.
Output: Fully integrated PWA offline experience
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/components/ClientProviders.tsx
@app/components/ui/OfflineBanner.tsx
@.planning/phases/53-pwa-offline-improvements/53-01-SUMMARY.md
@.planning/phases/53-pwa-offline-improvements/53-02-SUMMARY.md
@.planning/phases/53-pwa-offline-improvements/53-03-SUMMARY.md
@.planning/phases/53-pwa-offline-improvements/53-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire InstallPrompt into ClientProviders and finalize reconnect sync toast</name>
  <files>app/components/ClientProviders.tsx, app/components/ui/OfflineBanner.tsx</files>
  <action>
**1. Add InstallPrompt to ClientProviders.tsx:**

Add import and render InstallPrompt after children (bottom of the page):
```typescript
import InstallPrompt from '@/app/components/pwa/InstallPrompt';
```

In the JSX, add `<InstallPrompt />` AFTER `{children}` but still inside the provider tree:
```tsx
<CommandPaletteProvider>
  <AxeDevtools />
  <PWAInitializer />
  <OfflineBanner fixed showPendingCount />
  {children}
  <InstallPrompt />
</CommandPaletteProvider>
```

This places the banner at top and install prompt at bottom, matching the layout intent.

**2. Finalize reconnect sync toast in OfflineBanner:**

Ensure that when `lastSyncedCommand` is detected (user comes back online and commands sync), the OfflineBanner shows a brief success notification:
- Message: "Comandi sincronizzati" with success styling
- Show for 3 seconds, auto-dismiss
- Use green/success styling (existing pattern in OfflineBanner)
- If `lastSyncedCommand` has endpoint info, show specific label (e.g., "Stufa accesa (sincronizzato)")

The existing OfflineBanner already has this behavior from the original implementation. Verify it's preserved in the Plan 01 rewrite. If not, add it back:
```typescript
// In OfflineBanner, the synced command section
if (lastSyncedCommand) {
  const endpoint = (lastSyncedCommand as any).endpoint;
  const actionLabels = {
    'stove/ignite': 'Stufa accesa',
    'stove/shutdown': 'Stufa spenta',
    'stove/set-power': 'Potenza impostata',
  };
  // Show toast-style notification
}
```

**3. Verify z-index layering:**
- OfflineBanner: `z-[60]` (top of screen)
- InstallPrompt: `z-[55]` (bottom sheet)
- Navbar: check existing z-index (likely z-40 or z-50)
- No conflicts between banner and install prompt

**4. Verify no duplicate hook usage issues:**
- OfflineBanner uses `useOnlineStatus` and `useBackgroundSync`
- StoveCard uses `useOnlineStatus` and `useBackgroundSync`
- ThermostatCard uses `useOnlineStatus`
- Each hook instance is independent (no shared state issues)

**5. Run full type check and existing test suite:**
- `npx tsc --noEmit` must pass
- `npm test -- --no-coverage` must pass (or at least no NEW failures)
  </action>
  <verify>
`npx tsc --noEmit` passes.
`npm test -- --testPathPattern="(OfflineBanner|InstallPrompt|stalenessDetector|useDeviceStaleness|useInstallPrompt)" --no-coverage` all pass.
  </verify>
  <done>InstallPrompt wired into app root, reconnect sync toast works, all phase 53 features integrated without conflicts.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (zero errors)
2. All phase 53 tests pass
3. ClientProviders renders both OfflineBanner and InstallPrompt
4. No z-index conflicts between banner (top) and install prompt (bottom)
5. Reconnect toast shows when commands sync after coming online
</verification>

<success_criteria>
- InstallPrompt renders in root layout
- Reconnect sync toast functional
- OfflineBanner and InstallPrompt coexist properly
- All TypeScript and tests pass
- Phase 53 success criteria met:
  1. Offline banner visible when connection lost with timestamp
  2. Device cards show staleness indicator when cached > 30s
  3. Device controls hidden when offline
  4. Pending commands visible with sync toast on reconnect
  5. PWA install prompt after 2+ visits with 30-day dismissal
</success_criteria>

<output>
After completion, create `.planning/phases/53-pwa-offline-improvements/53-05-SUMMARY.md`
</output>
