---
phase: 54-analytics-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - types/analytics.ts
  - lib/analyticsConsentService.ts
  - lib/analyticsEventLogger.ts
  - lib/__tests__/analyticsConsentService.test.ts
  - lib/__tests__/analyticsEventLogger.test.ts
autonomous: true

must_haves:
  truths:
    - "Analytics types define event, daily stats, and consent state shapes"
    - "Consent service reads/writes consent state to localStorage"
    - "canTrackAnalytics returns false when consent not granted"
    - "Event logger silently skips logging when no consent"
    - "Event logger writes events to Firebase RTDB with timestamp key"
  artifacts:
    - path: "types/analytics.ts"
      provides: "Analytics event, daily stats, calibration, and consent types"
      min_lines: 40
    - path: "lib/analyticsConsentService.ts"
      provides: "Consent state management (get/set/canTrack)"
      exports: ["getConsentState", "setConsentState", "canTrackAnalytics"]
    - path: "lib/analyticsEventLogger.ts"
      provides: "Fire-and-forget event logging to Firebase RTDB"
      exports: ["logAnalyticsEvent", "getAnalyticsEventsForDate"]
  key_links:
    - from: "lib/analyticsEventLogger.ts"
      to: "lib/analyticsConsentService.ts"
      via: "canTrackAnalytics check before logging"
      pattern: "canTrackAnalytics"
    - from: "lib/analyticsEventLogger.ts"
      to: "lib/firebaseAdmin.ts"
      via: "adminDbSet for event persistence"
      pattern: "adminDbSet"
---

<objective>
Create the analytics foundation: TypeScript types for all analytics data structures, a GDPR-compliant consent service using localStorage, and a fire-and-forget event logger for stove state changes.

Purpose: Establishes the data layer that all subsequent analytics plans depend on. Types ensure consistency, consent service enforces GDPR compliance (ANLY-01, ANLY-02), event logger captures stove state changes (ANLY-03).
Output: types/analytics.ts, lib/analyticsConsentService.ts, lib/analyticsEventLogger.ts with unit tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-RESEARCH.md

@types/firebase/stove.ts
@lib/cronExecutionLogger.ts
@lib/environmentHelper.ts
@lib/firebaseAdmin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics types and consent service</name>
  <files>
    types/analytics.ts
    lib/analyticsConsentService.ts
    lib/__tests__/analyticsConsentService.test.ts
  </files>
  <action>
Create `types/analytics.ts` with these interfaces:
- `ConsentState`: union type `'unknown' | 'granted' | 'denied'`
- `AnalyticsEventType`: union type `'stove_ignite' | 'stove_shutdown' | 'power_change'`
- `AnalyticsEventSource`: union type `'manual' | 'scheduler' | 'automation'`
- `AnalyticsEvent`: `{ timestamp: string; eventType: AnalyticsEventType; powerLevel?: number; source: AnalyticsEventSource; userId?: string }`
- `DailyStats`: `{ date: string; totalHours: number; byPowerLevel: Record<number, number>; pelletEstimate: { totalKg: number; costEstimate: number }; ignitionCount: number; shutdownCount: number; automationHours: number; manualHours: number; avgTemperature?: number }`
- `CalibrationSettings`: `{ pelletCalibrationFactor: number; lastCalibrationDate: string; lastCalibrationActual: number; lastCalibrationEstimated: number; pelletCostPerKg: number }`
- `AnalyticsPeriod`: union type `7 | 30 | 90`

Create `lib/analyticsConsentService.ts`:
- `getConsentState(): ConsentState` - reads from `localStorage.getItem('analytics_consent')`, returns `'unknown'` if not set or if `typeof window === 'undefined'` (SSR safety). Returns `'granted'` if stored value is `'true'`, `'denied'` otherwise.
- `setConsentState(granted: boolean): void` - writes `granted ? 'true' : 'false'` to `localStorage.setItem('analytics_consent')` and writes ISO timestamp to `localStorage.setItem('analytics_consent_timestamp')`.
- `canTrackAnalytics(): boolean` - returns `getConsentState() === 'granted'`
- `getConsentTimestamp(): string | null` - returns `localStorage.getItem('analytics_consent_timestamp')`
- `resetConsent(): void` - removes both localStorage keys (for settings page)

Create test file `lib/__tests__/analyticsConsentService.test.ts`:
- Mock localStorage with get/set/remove
- Test SSR safety (window undefined returns 'unknown')
- Test initial state is 'unknown'
- Test granting consent sets 'true' and timestamp
- Test denying consent sets 'false' and timestamp
- Test canTrackAnalytics returns true only when granted
- Test resetConsent removes both keys
  </action>
  <verify>Run `npx jest lib/__tests__/analyticsConsentService.test.ts --no-coverage` and confirm all tests pass.</verify>
  <done>types/analytics.ts has all interfaces, consent service manages localStorage state, canTrackAnalytics blocks tracking without consent, all tests green.</done>
</task>

<task type="auto">
  <name>Task 2: Create analytics event logger</name>
  <files>
    lib/analyticsEventLogger.ts
    lib/__tests__/analyticsEventLogger.test.ts
  </files>
  <action>
Create `lib/analyticsEventLogger.ts` following the `lib/cronExecutionLogger.ts` pattern:
- Import `adminDbSet`, `adminDbGet` from `./firebaseAdmin`
- Import `getEnvironmentPath` from `./environmentHelper`
- Import `AnalyticsEvent`, `AnalyticsEventType`, `AnalyticsEventSource` from `@/types/analytics`

Functions:
- `logAnalyticsEvent(event: Omit<AnalyticsEvent, 'timestamp'>): Promise<void>` - Fire-and-forget pattern:
  - Create ISO timestamp, generate key with `timestamp.replace(/[:.]/g, '-')`
  - Write to `getEnvironmentPath('analyticsEvents/${key}')` using `adminDbSet`
  - Wrap in try/catch, log error but never throw
  - NOTE: This is a server-side function. Consent check happens at the caller level (API route or scheduler). Do NOT import client-side consent service here.

- `getAnalyticsEventsForDate(dateKey: string): Promise<AnalyticsEvent[]>` - Read events filtered by date:
  - Read all events from `getEnvironmentPath('analyticsEvents')`
  - Filter where `event.timestamp.startsWith(dateKey)` (YYYY-MM-DD prefix)
  - Return filtered array, empty array on error

- `cleanupOldAnalyticsEvents(retentionDays: number = 7): Promise<void>` - Remove events older than retention:
  - Read all events, check timestamp age
  - Delete entries older than `retentionDays * 24 * 60 * 60 * 1000` ms
  - Fire-and-forget, log errors but never throw

Create test file `lib/__tests__/analyticsEventLogger.test.ts`:
- Mock `lib/firebaseAdmin` (adminDbSet, adminDbGet)
- Mock `lib/environmentHelper` (getEnvironmentPath returns identity)
- Test logAnalyticsEvent writes correct structure with timestamp key
- Test logAnalyticsEvent catches and logs errors (does not throw)
- Test getAnalyticsEventsForDate filters by date prefix
- Test getAnalyticsEventsForDate returns empty array when no data
- Test cleanupOldAnalyticsEvents removes old entries
  </action>
  <verify>Run `npx jest lib/__tests__/analyticsEventLogger.test.ts --no-coverage` and confirm all tests pass.</verify>
  <done>Event logger writes to Firebase RTDB, reads events by date, cleans up old events, all fire-and-forget, tests green.</done>
</task>

</tasks>

<verification>
1. `npx jest lib/__tests__/analyticsConsentService.test.ts lib/__tests__/analyticsEventLogger.test.ts --no-coverage` - all tests pass
2. `npx tsc --noEmit types/analytics.ts lib/analyticsConsentService.ts lib/analyticsEventLogger.ts` - no type errors
3. types/analytics.ts exports all required interfaces
4. Consent service never imports Firebase (client-safe)
5. Event logger never imports consent service (server-side only)
</verification>

<success_criteria>
- All analytics types defined in types/analytics.ts
- Consent service reads/writes localStorage correctly
- Event logger follows fire-and-forget pattern (errors caught, never thrown)
- All unit tests pass
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-01-SUMMARY.md`
</output>
