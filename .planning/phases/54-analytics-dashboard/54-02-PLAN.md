---
phase: 54-analytics-dashboard
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/pelletEstimationService.ts
  - lib/__tests__/pelletEstimationService.test.ts
autonomous: true

must_haves:
  truths:
    - "Pellet consumption estimated from power level and runtime hours"
    - "Calibration factor adjusts all estimates proportionally"
    - "Cost estimate calculated from total kg and price per kg"
    - "Daily average correctly computed"
    - "Unknown power levels fall back to medium rate (1.2 kg/h)"
  artifacts:
    - path: "lib/pelletEstimationService.ts"
      provides: "Pellet consumption estimation with calibration"
      exports: ["estimatePelletConsumption", "BASE_CONSUMPTION_RATES", "DEFAULT_PELLET_COST_PER_KG"]
    - path: "lib/__tests__/pelletEstimationService.test.ts"
      provides: "TDD tests for pellet estimation"
      min_lines: 60
  key_links:
    - from: "lib/pelletEstimationService.ts"
      to: "types/analytics.ts"
      via: "ConsumptionEstimate interface will be used later"
      pattern: "estimatePelletConsumption"
---

<objective>
Implement pellet consumption estimation service using TDD. The service calculates estimated pellet usage (kg) based on stove power level and runtime hours, with a user calibration factor to adjust for real-world variance.

Purpose: Core business logic for ANLY-04 (pellet consumption estimation) and ANLY-06 (consumption charts). Pure function with well-defined I/O - ideal TDD candidate.
Output: lib/pelletEstimationService.ts with comprehensive tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-RESEARCH.md
</context>

<feature>
  <name>Pellet Consumption Estimation</name>
  <files>lib/pelletEstimationService.ts, lib/__tests__/pelletEstimationService.test.ts</files>
  <behavior>
    Base consumption rates (kg/hour) per power level:
    - Level 1: 0.6 kg/h (low)
    - Level 2: 0.9 kg/h
    - Level 3: 1.2 kg/h (medium)
    - Level 4: 1.6 kg/h
    - Level 5: 2.0 kg/h (max)

    Function: estimatePelletConsumption(usageData, calibrationFactor?, pelletCostPerKg?)

    Input: Array of { powerLevel: number; hours: number }
    - calibrationFactor defaults to 1.0
    - pelletCostPerKg defaults to 0.50 (EUR)

    Output: { totalKg: number; costEstimate: number; dailyAverage: number; byPowerLevel: Record<number, { hours: number; kg: number }> }

    Test cases:
    - Single power level: [{powerLevel: 3, hours: 2}] -> totalKg: 2.4, costEstimate: 1.20
    - Multiple power levels: [{powerLevel: 1, hours: 3}, {powerLevel: 5, hours: 1}] -> totalKg: 3.8, cost: 1.90
    - With calibration factor 0.8: [{powerLevel: 3, hours: 2}] -> totalKg: 1.92
    - Unknown power level (e.g., 6): falls back to 1.2 kg/h
    - Empty array: totalKg: 0, costEstimate: 0, dailyAverage: 0
    - Custom cost: [{powerLevel: 3, hours: 1}] with cost 0.70 -> costEstimate: 0.84
    - dailyAverage: totalKg / usageData.length (NaN guard for empty)
    - byPowerLevel breakdown matches individual calculations
  </behavior>
  <implementation>
    Export const BASE_CONSUMPTION_RATES: Record<number, number> mapping power levels 1-5 to kg/h.
    Export const DEFAULT_PELLET_COST_PER_KG = 0.50.

    Function iterates usageData, looks up rate (fallback to level 3 rate for unknown levels),
    multiplies rate * hours * calibrationFactor, accumulates totals and per-level breakdown.
    All numbers rounded to 2 decimal places with parseFloat(n.toFixed(2)).
    dailyAverage guards against division by zero (returns 0 for empty input).
  </implementation>
</feature>

<verification>
1. `npx jest lib/__tests__/pelletEstimationService.test.ts --no-coverage` - all tests pass
2. `npx tsc --noEmit lib/pelletEstimationService.ts` - no type errors
3. All test cases from behavior section covered
4. Edge cases: empty array, unknown power level, calibration factor, custom cost
</verification>

<success_criteria>
- RED: Tests written first, all fail initially
- GREEN: Implementation passes all tests
- Pure function with no side effects (no Firebase, no localStorage)
- All numbers rounded to 2 decimals
- Exported constants for use by aggregation service
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-02-SUMMARY.md`
</output>
