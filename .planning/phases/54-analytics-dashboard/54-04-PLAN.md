---
phase: 54-analytics-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["54-01"]
files_modified:
  - app/components/analytics/ConsentBanner.tsx
  - app/components/analytics/ConsentBanner.test.tsx
  - app/components/ClientProviders.tsx
autonomous: true

must_haves:
  truths:
    - "Consent banner shows when consent state is 'unknown'"
    - "Accept and Reject buttons are visually identical (same variant, same size)"
    - "Clicking Accept sets consent to granted and hides banner"
    - "Clicking Reject sets consent to denied and hides banner"
    - "Banner does not show when consent already decided"
    - "Essential stove controls work regardless of consent state"
    - "ConsentBanner is wired into ClientProviders so it appears on ALL pages on first visit"
  artifacts:
    - path: "app/components/analytics/ConsentBanner.tsx"
      provides: "GDPR-compliant consent banner with visual parity"
      min_lines: 40
  key_links:
    - from: "app/components/analytics/ConsentBanner.tsx"
      to: "lib/analyticsConsentService.ts"
      via: "getConsentState and setConsentState for state management"
      pattern: "getConsentState|setConsentState"
    - from: "app/components/ClientProviders.tsx"
      to: "app/components/analytics/ConsentBanner.tsx"
      via: "ConsentBanner rendered in root client wrapper for all pages"
      pattern: "ConsentBanner"
---

<objective>
Create a GDPR-compliant consent banner component that blocks analytics tracking until the user explicitly grants or denies permission. The banner enforces visual parity between Accept and Reject options per EU 2026 requirements.

Purpose: ANLY-01 (GDPR consent banner) and ANLY-02 (essential mode without consent). This is the gateway that enables or blocks all analytics features.
Output: app/components/analytics/ConsentBanner.tsx with tests
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-RESEARCH.md
@.planning/phases/54-analytics-dashboard/54-01-SUMMARY.md

@app/components/ui/Banner.tsx
@app/components/ui/Button.tsx
@app/components/ui/Card.tsx
@app/components/ui/Text.tsx
@lib/analyticsConsentService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GDPR consent banner component</name>
  <files>
    app/components/analytics/ConsentBanner.tsx
  </files>
  <action>
Create `app/components/analytics/ConsentBanner.tsx` as a client component:

```
'use client';
```

Import:
- `useState`, `useEffect` from 'react'
- `Card` from `@/app/components/ui/Card`
- `Button` from `@/app/components/ui/Button`
- `Text` from `@/app/components/ui/Text`
- `Heading` from `@/app/components/ui/Heading`
- `getConsentState`, `setConsentState` from `@/lib/analyticsConsentService`

Component structure:
1. `const [show, setShow] = useState(false)` - start hidden to prevent SSR flash
2. `useEffect(() => { if (getConsentState() === 'unknown') setShow(true); }, [])` - check consent on mount
3. If `!show`, return `null`
4. `handleConsent(granted: boolean)` handler:
   - Call `setConsentState(granted)`
   - Call `setShow(false)`
   - If granted, do a soft reload: `window.location.reload()` to activate analytics features

Banner UI (fixed at bottom of viewport):
```jsx
<div className="fixed bottom-4 left-4 right-4 z-50 md:max-w-lg md:mx-auto">
  <Card variant="glass" padding="lg">
    <Heading level={4} variant="default" className="mb-2">
      Analytics & Usage Statistics
    </Heading>
    <Text variant="secondary" size="sm" className="mb-4">
      We track stove usage to show you consumption statistics, pellet estimates, and weather correlations. Essential stove controls work without consent.
    </Text>
    <div className="flex gap-3">
      {/* GDPR Visual Parity: identical variant, identical size */}
      <Button
        variant="subtle"
        size="sm"
        onClick={() => handleConsent(false)}
        className="flex-1"
        aria-label="Reject analytics tracking"
      >
        Only Essential
      </Button>
      <Button
        variant="subtle"
        size="sm"
        onClick={() => handleConsent(true)}
        className="flex-1"
        aria-label="Accept analytics tracking"
      >
        Accept Analytics
      </Button>
    </div>
  </Card>
</div>
```

GDPR compliance checklist (implement all):
- Both buttons use SAME variant (`subtle`) - no color bias
- Both buttons use SAME size (`sm`)
- Both buttons use `flex-1` for equal width
- No green/red color distinction
- Non-blocking: banner overlays but doesn't prevent page use
- Explicit mention that essential controls work without consent
- No pre-ticked options, no implied consent
  </action>
  <verify>Visually inspect: both buttons should be identical in appearance (same variant, same size, same styling). Verify no dark patterns (accept not more prominent than reject).</verify>
  <done>Consent banner shows on first visit, hides after decision, buttons are visually identical, consent state persisted to localStorage.</done>
</task>

<task type="auto">
  <name>Task 2: Create consent banner tests</name>
  <files>
    app/components/analytics/ConsentBanner.test.tsx
  </files>
  <action>
Create `app/components/analytics/ConsentBanner.test.tsx`:

Mock setup:
- Mock `@/lib/analyticsConsentService` with jest.fn() for getConsentState, setConsentState
- Mock `window.location.reload` with jest.fn()

Tests:
1. "does not render when consent already granted" - getConsentState returns 'granted', expect nothing rendered
2. "does not render when consent already denied" - getConsentState returns 'denied', expect nothing rendered
3. "renders when consent is unknown" - getConsentState returns 'unknown', expect banner visible
4. "shows both buttons with identical styling" - Render, find both buttons, verify they exist
5. "calls setConsentState(true) when Accept clicked" - Click accept button, verify setConsentState called with true
6. "calls setConsentState(false) when Reject clicked" - Click reject button, verify setConsentState called with false
7. "hides banner after Accept clicked" - Click, verify banner no longer in DOM
8. "hides banner after Reject clicked" - Click, verify banner no longer in DOM
9. "mentions essential controls work without consent" - Check text content includes "essential" or similar
10. "has accessible labels on buttons" - Check aria-label attributes exist

Use `@testing-library/react` with `render`, `screen`, `fireEvent`, `act`, `waitFor`.
  </action>
  <verify>Run `npx jest app/components/analytics/ConsentBanner.test.tsx --no-coverage` and confirm all tests pass.</verify>
  <done>All consent banner tests pass: renders conditionally, buttons visually identical, consent state managed correctly, accessible.</done>
</task>

<task type="auto">
  <name>Task 3: Wire ConsentBanner into ClientProviders for all pages</name>
  <files>
    app/components/ClientProviders.tsx
  </files>
  <action>
Add ConsentBanner to `app/components/ClientProviders.tsx` so it renders on ALL pages, not just /analytics.

1. Add import at the top of the file:
```typescript
import ConsentBanner from '@/app/components/analytics/ConsentBanner';
```

2. Add `<ConsentBanner />` inside the ClientProviders component, right after `<OfflineBanner fixed showPendingCount />` and before `{children}`:
```tsx
<OfflineBanner fixed showPendingCount />
<ConsentBanner />
{children}
```

The ConsentBanner self-manages visibility (renders null when consent already decided), so it is safe to include globally. This ensures users see the consent banner on their FIRST visit to ANY page, not just when they navigate to /analytics.

Do NOT remove ConsentBanner from the /analytics page (54-07) â€” the /analytics page uses it for in-page consent state display. The global instance handles first-visit consent, the /analytics instance handles the consent-denied/unknown informational states.
  </action>
  <verify>Read `app/components/ClientProviders.tsx` and confirm ConsentBanner is imported and rendered. Run `npx tsc --noEmit app/components/ClientProviders.tsx` to confirm no type errors.</verify>
  <done>ConsentBanner renders globally via ClientProviders. Users see consent prompt on first visit to any page, not just /analytics.</done>
</task>

</tasks>

<verification>
1. `npx jest app/components/analytics/ConsentBanner.test.tsx --no-coverage` - all tests pass
2. `npx tsc --noEmit app/components/analytics/ConsentBanner.tsx app/components/ClientProviders.tsx` - no type errors
3. Both buttons use identical variant and size (visual parity)
4. Banner only shows when consent is 'unknown'
5. Essential controls mentioned in banner text
6. ConsentBanner imported and rendered in ClientProviders.tsx (appears on all pages)
</verification>

<success_criteria>
- Consent banner renders only when consent undecided
- Accept/Reject buttons visually identical (GDPR visual parity)
- Consent state persisted via analyticsConsentService
- Banner disappears after user decision
- ConsentBanner wired into ClientProviders (visible on all pages)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-04-SUMMARY.md`
</output>
