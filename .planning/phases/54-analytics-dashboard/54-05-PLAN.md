---
phase: 54-analytics-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["54-03"]
files_modified:
  - app/api/analytics/stats/route.ts
  - app/api/analytics/calibrate/route.ts
  - app/components/analytics/StatsCards.tsx
autonomous: true

must_haves:
  truths:
    - "Stats API returns aggregated daily stats for requested period (7/30/90 days)"
    - "Stats API calculates period totals (hours, pellet kg, cost, automation %)"
    - "Calibrate API saves user calibration factor to Firebase"
    - "StatsCards displays 4 summary metrics in a grid"
  artifacts:
    - path: "app/api/analytics/stats/route.ts"
      provides: "GET endpoint for aggregated analytics stats"
      exports: ["GET"]
    - path: "app/api/analytics/calibrate/route.ts"
      provides: "POST endpoint for user pellet calibration"
      exports: ["POST"]
    - path: "app/components/analytics/StatsCards.tsx"
      provides: "Summary statistics card grid component"
      min_lines: 30
  key_links:
    - from: "app/api/analytics/stats/route.ts"
      to: "lib/firebaseAdmin.ts"
      via: "adminDbGet to read pre-aggregated daily stats"
      pattern: "adminDbGet"
    - from: "app/api/analytics/calibrate/route.ts"
      to: "lib/firebaseAdmin.ts"
      via: "adminDbUpdate for user calibration settings"
      pattern: "adminDbUpdate"
---

<objective>
Create the analytics API endpoints (stats retrieval and calibration) and the StatsCards summary component. The stats endpoint reads pre-aggregated daily data and computes period totals. The calibrate endpoint saves the user's pellet calibration factor.

Purpose: ANLY-08 (stats cards with totals), ANLY-11 (calibration API), ANLY-03 (usage hours API). These endpoints feed the dashboard components.
Output: 2 API routes + StatsCards component
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-RESEARCH.md
@.planning/phases/54-analytics-dashboard/54-03-SUMMARY.md

@lib/core/index.ts
@lib/core/middleware.ts
@lib/firebaseAdmin.ts
@lib/environmentHelper.ts
@app/components/ui/Card.tsx
@app/components/ui/Heading.tsx
@app/components/ui/Text.tsx
@types/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics stats and calibrate API routes</name>
  <files>
    app/api/analytics/stats/route.ts
    app/api/analytics/calibrate/route.ts
  </files>
  <action>
Create `app/api/analytics/stats/route.ts`:

```typescript
import { withAuthAndErrorHandler, success, badRequest } from '@/lib/core';
import { adminDbGet } from '@/lib/firebaseAdmin';
import { getEnvironmentPath } from '@/lib/environmentHelper';
import type { DailyStats, AnalyticsPeriod, CalibrationSettings } from '@/types/analytics';
import { estimatePelletConsumption } from '@/lib/pelletEstimationService';

export const dynamic = 'force-dynamic';

export const GET = withAuthAndErrorHandler(async (request, context, session) => {
  // Parse period from query params (default 30)
  const periodParam = request.nextUrl.searchParams.get('period');
  const period: AnalyticsPeriod = periodParam === '7' ? 7 : periodParam === '90' ? 90 : 30;

  // Calculate date range
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - period);

  // Read all daily stats from Firebase
  const statsPath = getEnvironmentPath('analyticsStats/daily');
  const allStats = await adminDbGet(statsPath) as Record<string, DailyStats> | null;

  if (!allStats) {
    return success({
      period,
      days: [],
      totals: { totalHours: 0, totalKg: 0, totalCost: 0, automationPercentage: 0 },
    });
  }

  // Filter stats within date range
  const startKey = startDate.toISOString().split('T')[0];
  const endKey = endDate.toISOString().split('T')[0];

  const filteredDays = Object.values(allStats)
    .filter(stat => stat.date >= startKey && stat.date <= endKey)
    .sort((a, b) => a.date.localeCompare(b.date));

  // Read user calibration settings
  const userId = session.user.sub;
  const calibrationPath = getEnvironmentPath(`users/${userId}/analyticsSettings`);
  const calibration = await adminDbGet(calibrationPath) as CalibrationSettings | null;
  const calibrationFactor = calibration?.pelletCalibrationFactor ?? 1.0;
  const pelletCostPerKg = calibration?.pelletCostPerKg ?? 0.50;

  // Calculate period totals
  let totalHours = 0;
  let totalAutomationHours = 0;
  let totalManualHours = 0;

  for (const day of filteredDays) {
    totalHours += day.totalHours;
    totalAutomationHours += day.automationHours;
    totalManualHours += day.manualHours;
  }

  // Recalculate pellet with user calibration
  const allUsage = filteredDays.flatMap(day =>
    Object.entries(day.byPowerLevel).map(([level, hours]) => ({
      powerLevel: parseInt(level),
      hours,
    }))
  );
  const pelletEstimate = estimatePelletConsumption(allUsage, calibrationFactor, pelletCostPerKg);

  const automationPercentage = totalHours > 0
    ? parseFloat(((totalAutomationHours / totalHours) * 100).toFixed(1))
    : 0;

  return success({
    period,
    days: filteredDays,
    totals: {
      totalHours: parseFloat(totalHours.toFixed(1)),
      totalKg: pelletEstimate.totalKg,
      totalCost: pelletEstimate.costEstimate,
      automationPercentage,
    },
    calibration: calibration ? {
      factor: calibrationFactor,
      lastDate: calibration.lastCalibrationDate,
      costPerKg: pelletCostPerKg,
    } : null,
  });
});
```

Create `app/api/analytics/calibrate/route.ts`:

```typescript
import { withAuthAndErrorHandler, success, badRequest } from '@/lib/core';
import { adminDbUpdate } from '@/lib/firebaseAdmin';
import { getEnvironmentPath } from '@/lib/environmentHelper';
import type { CalibrationSettings } from '@/types/analytics';

export const dynamic = 'force-dynamic';

export const POST = withAuthAndErrorHandler(async (request, context, session) => {
  const body = await request.json() as { actualKg?: number; estimatedKg?: number; pelletCostPerKg?: number };

  // Validate input
  if (body.actualKg !== undefined && body.estimatedKg !== undefined) {
    if (typeof body.actualKg !== 'number' || body.actualKg <= 0) {
      return badRequest('actualKg must be a positive number');
    }
    if (typeof body.estimatedKg !== 'number' || body.estimatedKg <= 0) {
      return badRequest('estimatedKg must be a positive number');
    }
  }

  const userId = session.user.sub;
  const settingsPath = getEnvironmentPath(`users/${userId}/analyticsSettings`);

  const updates: Partial<CalibrationSettings> = {};

  if (body.actualKg !== undefined && body.estimatedKg !== undefined) {
    updates.pelletCalibrationFactor = parseFloat((body.actualKg / body.estimatedKg).toFixed(4));
    updates.lastCalibrationDate = new Date().toISOString();
    updates.lastCalibrationActual = body.actualKg;
    updates.lastCalibrationEstimated = body.estimatedKg;
  }

  if (body.pelletCostPerKg !== undefined) {
    if (typeof body.pelletCostPerKg !== 'number' || body.pelletCostPerKg <= 0) {
      return badRequest('pelletCostPerKg must be a positive number');
    }
    updates.pelletCostPerKg = body.pelletCostPerKg;
  }

  if (Object.keys(updates).length === 0) {
    return badRequest('No valid calibration data provided');
  }

  await adminDbUpdate(settingsPath, updates as Record<string, unknown>);

  return success({ calibrated: true, ...updates });
});
```

Key points for both routes:
- `export const dynamic = 'force-dynamic'` (required for API routes)
- Use `withAuthAndErrorHandler` (requires Auth0 session)
- Use typed imports from `@/types/analytics`
- Use `getEnvironmentPath` for Firebase paths
  </action>
  <verify>Run `npx tsc --noEmit app/api/analytics/stats/route.ts app/api/analytics/calibrate/route.ts` and confirm no type errors.</verify>
  <done>Stats GET returns period data with totals, calibrate POST saves factor. Both protected by auth, use environment paths.</done>
</task>

<task type="auto">
  <name>Task 2: Create StatsCards summary component</name>
  <files>
    app/components/analytics/StatsCards.tsx
  </files>
  <action>
Create `app/components/analytics/StatsCards.tsx` as a client component:

```
'use client';
```

Import design system components: `Card`, `Text`, `Heading` from `@/app/components/ui/`.
Import icons from `lucide-react`: `Clock`, `Flame`, `Euro`, `Zap` (or closest matches).

Interface `StatsCardsProps`:
```typescript
interface StatsCardsProps {
  totalHours: number;
  totalKg: number;
  totalCost: number;
  automationPercentage: number;
  loading?: boolean;
}
```

Component renders a 2x2 grid (2 cols mobile, 4 cols desktop):

```jsx
<div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
```

Four cards using existing `Card` component:
1. **Total Hours** - Clock icon, value `{totalHours.toFixed(1)}`, unit "h"
2. **Pellet Used** - Flame icon, value `{totalKg.toFixed(1)}`, unit "kg"
3. **Estimated Cost** - Euro icon, value `{totalCost.toFixed(2)}`, prefix "EUR"
4. **Automation** - Zap icon, value `{automationPercentage.toFixed(0)}`, unit "%"

Each card:
```jsx
<Card variant="glass" padding="md">
  <div className="flex items-center gap-2 mb-2">
    <IconComponent className="w-4 h-4 text-ember-400" />
    <Text variant="secondary" size="xs">{label}</Text>
  </div>
  <div className="flex items-baseline gap-1">
    <Heading level={3} variant="ember">{value}</Heading>
    {unit && <Text variant="tertiary" size="sm">{unit}</Text>}
  </div>
</Card>
```

Use the Ember Noir design system: ember accents for icons and values, glass card variant for dark theme.

Loading state: render 4 skeleton cards with `animate-pulse` placeholder divs.

Do NOT use emoji icons. Use lucide-react icons only (the research used emojis as placeholders, but the project uses lucide-react).
  </action>
  <verify>Run `npx tsc --noEmit app/components/analytics/StatsCards.tsx` and confirm no type errors. Verify lucide-react icons used (not emoji).</verify>
  <done>StatsCards renders 4 metric cards in responsive grid with loading state. Uses design system components and lucide-react icons.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit app/api/analytics/stats/route.ts app/api/analytics/calibrate/route.ts app/components/analytics/StatsCards.tsx` - no errors
2. Stats API filters by period and applies user calibration
3. Calibrate API validates input and persists to Firebase
4. StatsCards uses design system components (Card, Heading, Text)
5. No emoji in StatsCards (lucide-react only)
</verification>

<success_criteria>
- Stats API returns period-filtered data with totals
- Calibrate API saves calibration factor with validation
- StatsCards displays 4 metrics in responsive grid
- Loading state implemented
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-05-SUMMARY.md`
</output>
