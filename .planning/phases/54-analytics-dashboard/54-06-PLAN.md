---
phase: 54-analytics-dashboard
plan: 06
type: execute
wave: 3
depends_on: ["54-03"]
files_modified:
  - app/components/analytics/UsageChart.tsx
  - app/components/analytics/ConsumptionChart.tsx
  - app/components/analytics/WeatherCorrelation.tsx
autonomous: true

must_haves:
  truths:
    - "Usage chart shows daily stove hours with stacked bars per power level"
    - "Consumption chart shows estimated pellet kg per day with period total and daily average"
    - "Weather correlation overlays temperature line on consumption bars"
    - "All charts handle empty data gracefully with empty state message"
    - "All charts use 'use client' directive (Recharts requires browser APIs)"
  artifacts:
    - path: "app/components/analytics/UsageChart.tsx"
      provides: "Stacked bar chart of daily usage hours by power level"
      min_lines: 50
    - path: "app/components/analytics/ConsumptionChart.tsx"
      provides: "Bar chart of daily pellet consumption"
      min_lines: 40
    - path: "app/components/analytics/WeatherCorrelation.tsx"
      provides: "Composed chart with pellet bars and temperature line"
      min_lines: 60
  key_links:
    - from: "app/components/analytics/UsageChart.tsx"
      to: "recharts"
      via: "BarChart, Bar, XAxis, YAxis, ResponsiveContainer"
      pattern: "from 'recharts'"
    - from: "app/components/analytics/WeatherCorrelation.tsx"
      to: "recharts"
      via: "ComposedChart, Bar, Line, dual YAxis"
      pattern: "ComposedChart"
---

<objective>
Create three Recharts visualization components for the analytics dashboard: stove usage hours chart, pellet consumption chart, and weather correlation chart. All follow the existing DeliveryChart.tsx pattern with dark-first Ember Noir styling.

Purpose: ANLY-05 (usage timeline), ANLY-06 (pellet consumption chart), ANLY-07 (weather-consumption correlation). These are the core data visualizations of the analytics dashboard.
Output: 3 chart components ready for dashboard assembly
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-RESEARCH.md

@app/debug/notifications/components/DeliveryChart.tsx
@types/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UsageChart and ConsumptionChart components</name>
  <files>
    app/components/analytics/UsageChart.tsx
    app/components/analytics/ConsumptionChart.tsx
  </files>
  <action>
**UsageChart.tsx** - Stacked bar chart showing daily stove usage hours broken down by power level.

Follow the exact pattern from `app/debug/notifications/components/DeliveryChart.tsx`:

```
'use client';
```

Import from recharts: `BarChart`, `Bar`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `Legend`, `ResponsiveContainer`
Import from date-fns: `format`, `parseISO`
Import `Text` from `@/app/components/ui/Text`
Import `DailyStats` from `@/types/analytics`

Interface:
```typescript
interface UsageChartProps {
  data: DailyStats[];
  loading?: boolean;
}
```

Transform data: map each DailyStats to chart format:
```typescript
{
  displayDate: format(parseISO(stat.date), 'MMM dd'),
  date: stat.date,
  level1: stat.byPowerLevel[1] || 0,
  level2: stat.byPowerLevel[2] || 0,
  level3: stat.byPowerLevel[3] || 0,
  level4: stat.byPowerLevel[4] || 0,
  level5: stat.byPowerLevel[5] || 0,
  total: stat.totalHours,
}
```

Chart structure:
- `ResponsiveContainer` width 100%, height 300
- `BarChart` with margin matching DeliveryChart
- `CartesianGrid` with `strokeDasharray="3 3"`, stroke `currentColor`, opacity 10%
- `XAxis` dataKey `displayDate`, styled like DeliveryChart
- `YAxis` with label "Hours", styled like DeliveryChart
- `Tooltip` with custom tooltip (dark theme, show breakdown)
- `Legend` with power level names
- 5 stacked `Bar` components (stackId="power"), one per power level:
  - Level 1: fill `#94a3b8` (slate, lowest heat)
  - Level 2: fill `#f59e0b` (amber)
  - Level 3: fill `#ed6f10` (ember-500, medium heat)
  - Level 4: fill `#ea580c` (orange-600)
  - Level 5: fill `#dc2626` (red-600, max heat)
  - Top bar gets `radius={[4, 4, 0, 0]}`

Loading and empty states: match DeliveryChart pattern exactly (h-[300px] flex center with Text).

Custom tooltip: dark bg, show each power level's hours and total.

---

**ConsumptionChart.tsx** - Bar chart showing estimated pellet consumption per day.

```
'use client';
```

Import: `BarChart`, `Bar`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `Legend`, `ResponsiveContainer`, `ReferenceLine` from recharts.
Import `Text`, `Heading` from UI.
Import `DailyStats` from `@/types/analytics`.

Interface:
```typescript
interface ConsumptionChartProps {
  data: DailyStats[];
  loading?: boolean;
}
```

Transform data:
```typescript
{
  displayDate: format(parseISO(stat.date), 'MMM dd'),
  date: stat.date,
  pelletKg: stat.pelletEstimate.totalKg,
  costEur: stat.pelletEstimate.costEstimate,
}
```

Chart: Single bar chart (no stacking):
- `ResponsiveContainer` 100% x 300
- `BarChart`
- `Bar` dataKey `pelletKg`, fill `#ed6f10` (ember), radius `[4, 4, 0, 0]`
- `ReferenceLine` y={dailyAverage} stroke `#f59e0b` strokeDasharray `5 5` label "Avg"
- YAxis label "Pellet (kg)"
- Custom tooltip showing kg and EUR cost

Calculate daily average from data array for reference line.

Show period summary below chart:
```jsx
<div className="flex gap-6 mt-3">
  <Text variant="secondary" size="xs">Total: {totalKg.toFixed(1)} kg</Text>
  <Text variant="secondary" size="xs">Daily avg: {avgKg.toFixed(1)} kg</Text>
  <Text variant="secondary" size="xs">Est. cost: EUR {totalCost.toFixed(2)}</Text>
</div>
```
  </action>
  <verify>Run `npx tsc --noEmit app/components/analytics/UsageChart.tsx app/components/analytics/ConsumptionChart.tsx` - no type errors.</verify>
  <done>UsageChart shows stacked hours by power level. ConsumptionChart shows pellet kg with daily average line and period summary. Both handle loading/empty states.</done>
</task>

<task type="auto">
  <name>Task 2: Create WeatherCorrelation chart component</name>
  <files>
    app/components/analytics/WeatherCorrelation.tsx
  </files>
  <action>
Create `app/components/analytics/WeatherCorrelation.tsx` following the ComposedChart dual-axis pattern from research:

```
'use client';
```

Import: `ComposedChart`, `Bar`, `Line`, `XAxis`, `YAxis`, `CartesianGrid`, `Tooltip`, `Legend`, `ResponsiveContainer` from recharts.
Import `Text` from UI.
Import `DailyStats` from `@/types/analytics`.

Interface:
```typescript
interface WeatherCorrelationProps {
  data: DailyStats[];
  loading?: boolean;
}
```

Filter data to only days with `avgTemperature !== undefined` (weather data available).

Transform data:
```typescript
{
  displayDate: format(parseISO(stat.date), 'MMM dd'),
  date: stat.date,
  consumptionKg: stat.pelletEstimate.totalKg,
  usageHours: stat.totalHours,
  avgTemperature: stat.avgTemperature, // may be undefined for some days
}
```

Chart structure using `ComposedChart` (EXACTLY like DeliveryChart pattern):
- `ResponsiveContainer` 100% x 350
- `ComposedChart` with standard margin
- `CartesianGrid` matching DeliveryChart
- `XAxis` displayDate
- Left `YAxis` (yAxisId="left"): label "Pellet (kg)", for consumption bars
- Right `YAxis` (yAxisId="right", orientation="right"): label "Temp (C)", for temperature line
- `Bar` yAxisId="left", dataKey "consumptionKg", fill `#ed6f10` (ember), name "Pellet (kg)", radius [4,4,0,0]
- `Line` yAxisId="right", type "monotone", dataKey "avgTemperature", stroke `#437dae` (ocean-ish blue), strokeWidth 2, dot fill matching, name "Temperature (C)"
- `Tooltip` with custom dark tooltip showing consumption, temperature, and usage hours
- `Legend`

Empty state: If no data with weather, show "Weather data unavailable - correlations require weather data from cron". Use same empty state pattern as DeliveryChart (h-[350px] flex center).

Handle missing `avgTemperature` on individual days: filter those points from the Line data or let Recharts handle undefined (it skips gaps naturally).
  </action>
  <verify>Run `npx tsc --noEmit app/components/analytics/WeatherCorrelation.tsx` - no type errors. Verify dual Y-axis setup matches DeliveryChart pattern.</verify>
  <done>WeatherCorrelation shows pellet consumption bars with temperature line overlay using dual Y-axes. Handles missing weather data gracefully.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit app/components/analytics/UsageChart.tsx app/components/analytics/ConsumptionChart.tsx app/components/analytics/WeatherCorrelation.tsx` - no errors
2. All three charts use `'use client'` directive
3. All charts handle loading and empty states
4. Styling follows DeliveryChart pattern (currentColor, opacity, dark theme)
5. WeatherCorrelation uses ComposedChart with dual YAxis
</verification>

<success_criteria>
- UsageChart shows stacked bars by power level (5 levels)
- ConsumptionChart shows daily pellet kg with average reference line
- WeatherCorrelation overlays temperature on consumption
- All follow existing DeliveryChart Recharts patterns
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-06-SUMMARY.md`
</output>
