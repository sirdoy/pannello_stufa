---
phase: 54-analytics-dashboard
plan: 07
type: execute
wave: 4
depends_on: ["54-04", "54-05", "54-06"]
files_modified:
  - app/analytics/page.tsx
  - app/components/analytics/CalibrationModal.tsx
  - app/components/analytics/PeriodSelector.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page at /analytics shows stats, charts, and calibration"
    - "Period selector switches between 7/30/90 day views"
    - "Dashboard fetches stats from /api/analytics/stats with selected period"
    - "Calibration modal allows user to input actual pellet kg"
    - "Dashboard checks consent and shows message if analytics denied"
    - "Charts render with fetched data, handle loading/empty states"
  artifacts:
    - path: "app/analytics/page.tsx"
      provides: "Analytics dashboard page assembling all components"
      min_lines: 80
    - path: "app/components/analytics/CalibrationModal.tsx"
      provides: "Modal for user pellet calibration input"
      min_lines: 40
    - path: "app/components/analytics/PeriodSelector.tsx"
      provides: "7/30/90 day period toggle component"
      min_lines: 20
  key_links:
    - from: "app/analytics/page.tsx"
      to: "/api/analytics/stats"
      via: "fetch in useEffect on mount and period change"
      pattern: "fetch.*api/analytics/stats"
    - from: "app/analytics/page.tsx"
      to: "lib/analyticsConsentService.ts"
      via: "canTrackAnalytics check before rendering dashboard"
      pattern: "canTrackAnalytics"
    - from: "app/components/analytics/CalibrationModal.tsx"
      to: "/api/analytics/calibrate"
      via: "POST request on form submit"
      pattern: "fetch.*api/analytics/calibrate"
---

<objective>
Assemble the complete analytics dashboard page at /analytics. Integrates all previously built components: ConsentBanner, StatsCards, UsageChart, ConsumptionChart, WeatherCorrelation. Adds period selection (7/30/90 days), calibration modal, and consent-aware rendering.

Purpose: ANLY-10 (dashboard page), ANLY-11 (calibration UI), ANLY-05 (period selection). This is the final user-facing deliverable bringing together all analytics features.
Output: /analytics page with period selector, stats cards, 3 charts, and calibration modal
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-RESEARCH.md
@.planning/phases/54-analytics-dashboard/54-04-SUMMARY.md
@.planning/phases/54-analytics-dashboard/54-05-SUMMARY.md
@.planning/phases/54-analytics-dashboard/54-06-SUMMARY.md

@app/debug/notifications/page.tsx
@lib/analyticsConsentService.ts
@app/components/ui/Card.tsx
@app/components/ui/Button.tsx
@app/components/ui/Heading.tsx
@app/components/ui/Text.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PeriodSelector and CalibrationModal components</name>
  <files>
    app/components/analytics/PeriodSelector.tsx
    app/components/analytics/CalibrationModal.tsx
  </files>
  <action>
**PeriodSelector.tsx** - Simple toggle for 7/30/90 day periods:

```
'use client';
```

Import `Button` from UI, `AnalyticsPeriod` from types.

Interface:
```typescript
interface PeriodSelectorProps {
  selected: AnalyticsPeriod;
  onChange: (period: AnalyticsPeriod) => void;
}
```

Render 3 buttons in a flex row:
```jsx
<div className="flex gap-2">
  {([7, 30, 90] as const).map((period) => (
    <Button
      key={period}
      variant={selected === period ? 'ember' : 'subtle'}
      size="sm"
      onClick={() => onChange(period)}
      aria-pressed={selected === period}
    >
      {period}d
    </Button>
  ))}
</div>
```

---

**CalibrationModal.tsx** - Modal for user to input actual pellet refill amount:

```
'use client';
```

Import `useState` from react.
Import `Card`, `Button`, `Text`, `Heading`, `Input` from UI.
Import `CalibrationSettings` from types.

Interface:
```typescript
interface CalibrationModalProps {
  isOpen: boolean;
  onClose: () => void;
  currentEstimate: number; // Current period's estimated kg
  currentCalibration?: {
    factor: number;
    lastDate: string;
    costPerKg: number;
  } | null;
  onCalibrate: (actualKg: number, costPerKg?: number) => Promise<void>;
}
```

When open, render a dark overlay with centered card:
```jsx
{isOpen && (
  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
    <Card variant="glass" padding="lg" className="w-full max-w-md mx-4">
      <Heading level={3} variant="default" className="mb-4">Calibrate Pellet Estimate</Heading>

      <Text variant="secondary" size="sm" className="mb-4">
        Enter the actual amount of pellets you refilled today. This helps improve the accuracy of consumption estimates.
      </Text>

      {/* Current estimate display */}
      <div className="mb-4 p-3 rounded-lg bg-white/5">
        <Text variant="tertiary" size="xs">Current estimate for period</Text>
        <Text variant="ember" size="lg">{currentEstimate.toFixed(1)} kg</Text>
      </div>

      {/* Actual kg input */}
      <label>
        <Text variant="secondary" size="sm" className="mb-1 block">Actual pellet refill (kg)</Text>
        <input
          type="number"
          step="0.5"
          min="0.5"
          max="100"
          value={actualKg}
          onChange={(e) => setActualKg(parseFloat(e.target.value))}
          className="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white placeholder-white/30 focus:border-ember-500 focus:ring-1 focus:ring-ember-500 outline-none"
          placeholder="e.g., 15"
          aria-label="Actual pellet amount in kilograms"
        />
      </label>

      {/* Optional: cost per kg */}
      <label className="mt-3 block">
        <Text variant="secondary" size="sm" className="mb-1 block">Pellet cost (EUR/kg)</Text>
        <input
          type="number"
          step="0.05"
          min="0.10"
          max="5.00"
          value={costPerKg}
          onChange={(e) => setCostPerKg(parseFloat(e.target.value))}
          className="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white placeholder-white/30 focus:border-ember-500 focus:ring-1 focus:ring-ember-500 outline-none"
          placeholder="0.50"
          aria-label="Pellet cost per kilogram in euros"
        />
      </label>

      {/* Last calibration info */}
      {currentCalibration?.lastDate && (
        <Text variant="tertiary" size="xs" className="mt-3">
          Last calibrated: {new Date(currentCalibration.lastDate).toLocaleDateString()}
          (factor: {currentCalibration.factor.toFixed(2)}x)
        </Text>
      )}

      {/* Actions */}
      <div className="flex gap-3 mt-6">
        <Button variant="subtle" size="sm" onClick={onClose} className="flex-1">
          Cancel
        </Button>
        <Button
          variant="ember"
          size="sm"
          onClick={handleSubmit}
          className="flex-1"
          disabled={!actualKg || actualKg <= 0 || submitting}
        >
          {submitting ? 'Saving...' : 'Calibrate'}
        </Button>
      </div>
    </Card>
  </div>
)}
```

State: `actualKg`, `costPerKg` (default 0.50), `submitting`.
`handleSubmit`: set submitting, call `onCalibrate(actualKg, costPerKg)`, then `onClose()`.
  </action>
  <verify>Run `npx tsc --noEmit app/components/analytics/PeriodSelector.tsx app/components/analytics/CalibrationModal.tsx` - no type errors.</verify>
  <done>PeriodSelector toggles 7/30/90 days. CalibrationModal accepts actual kg and optional cost input.</done>
</task>

<task type="auto">
  <name>Task 2: Assemble analytics dashboard page</name>
  <files>
    app/analytics/page.tsx
  </files>
  <action>
Create `app/analytics/page.tsx` as a client component following the notification dashboard pattern:

```
'use client';
```

Import:
- `useState`, `useEffect`, `useCallback` from react
- All analytics components: `StatsCards`, `UsageChart`, `ConsumptionChart`, `WeatherCorrelation`, `PeriodSelector`, `CalibrationModal`, `ConsentBanner`
- UI components: `Card`, `Button`, `Heading`, `Text`
- `canTrackAnalytics`, `getConsentState` from `@/lib/analyticsConsentService`
- `Settings` icon from lucide-react (for calibration button)
- `DailyStats`, `AnalyticsPeriod` from `@/types/analytics`

State:
```typescript
const [period, setPeriod] = useState<AnalyticsPeriod>(30);
const [days, setDays] = useState<DailyStats[]>([]);
const [totals, setTotals] = useState({ totalHours: 0, totalKg: 0, totalCost: 0, automationPercentage: 0 });
const [calibration, setCalibration] = useState<{ factor: number; lastDate: string; costPerKg: number } | null>(null);
const [loading, setLoading] = useState(true);
const [error, setError] = useState<string | null>(null);
const [showCalibration, setShowCalibration] = useState(false);
const [hasConsent, setHasConsent] = useState(false);
```

useEffect on mount:
```typescript
useEffect(() => {
  setHasConsent(canTrackAnalytics());
}, []);
```

Fetch function:
```typescript
const fetchStats = useCallback(async () => {
  if (!hasConsent) return;
  setLoading(true);
  setError(null);
  try {
    const res = await fetch(`/api/analytics/stats?period=${period}`);
    if (!res.ok) throw new Error('Failed to fetch analytics');
    const data = await res.json();
    setDays(data.days);
    setTotals(data.totals);
    setCalibration(data.calibration);
  } catch (err) {
    setError(err instanceof Error ? err.message : 'Unknown error');
  } finally {
    setLoading(false);
  }
}, [period, hasConsent]);
```

useEffect to fetch on period change:
```typescript
useEffect(() => { fetchStats(); }, [fetchStats]);
```

Calibrate handler:
```typescript
const handleCalibrate = async (actualKg: number, costPerKg?: number) => {
  await fetch('/api/analytics/calibrate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ actualKg, estimatedKg: totals.totalKg, pelletCostPerKg: costPerKg }),
  });
  await fetchStats(); // Refresh with new calibration
};
```

Page layout:
```jsx
<div className="min-h-screen p-4 md:p-6 max-w-6xl mx-auto">
  {/* Always show consent banner */}
  <ConsentBanner />

  {/* Header */}
  <div className="flex items-center justify-between mb-6">
    <Heading level={1} variant="ember">Analytics</Heading>
    {hasConsent && (
      <div className="flex items-center gap-3">
        <PeriodSelector selected={period} onChange={setPeriod} />
        <Button
          variant="subtle"
          size="sm"
          onClick={() => setShowCalibration(true)}
          aria-label="Calibrate pellet estimates"
        >
          <Settings className="w-4 h-4" />
        </Button>
      </div>
    )}
  </div>

  {/* Consent denied state */}
  {!hasConsent && getConsentState() === 'denied' && (
    <Card variant="glass" padding="lg" className="text-center">
      <Heading level={3} variant="default" className="mb-2">Analytics Disabled</Heading>
      <Text variant="secondary">
        You have declined analytics tracking. Stove controls continue to work normally.
        To enable analytics, update your consent in settings.
      </Text>
    </Card>
  )}

  {/* Consent unknown state */}
  {!hasConsent && getConsentState() === 'unknown' && (
    <Card variant="glass" padding="lg" className="text-center">
      <Heading level={3} variant="default" className="mb-2">Enable Analytics</Heading>
      <Text variant="secondary">
        Accept analytics tracking to see stove usage statistics, pellet consumption estimates, and weather correlations.
      </Text>
    </Card>
  )}

  {/* Dashboard content (only when consent granted) */}
  {hasConsent && (
    <div className="space-y-6">
      {/* Error state */}
      {error && (
        <Card variant="glass" padding="md">
          <Text variant="danger">{error}</Text>
          <Button variant="subtle" size="sm" onClick={fetchStats} className="mt-2">Retry</Button>
        </Card>
      )}

      {/* Stats cards */}
      <StatsCards
        totalHours={totals.totalHours}
        totalKg={totals.totalKg}
        totalCost={totals.totalCost}
        automationPercentage={totals.automationPercentage}
        loading={loading}
      />

      {/* Usage hours chart */}
      <Card variant="glass" padding="lg">
        <Heading level={3} variant="default" className="mb-4">Stove Usage</Heading>
        <UsageChart data={days} loading={loading} />
      </Card>

      {/* Pellet consumption chart */}
      <Card variant="glass" padding="lg">
        <Heading level={3} variant="default" className="mb-4">Pellet Consumption</Heading>
        <ConsumptionChart data={days} loading={loading} />
      </Card>

      {/* Weather correlation chart */}
      <Card variant="glass" padding="lg">
        <Heading level={3} variant="default" className="mb-4">Weather Correlation</Heading>
        <WeatherCorrelation data={days} loading={loading} />
      </Card>
    </div>
  )}

  {/* Calibration modal */}
  <CalibrationModal
    isOpen={showCalibration}
    onClose={() => setShowCalibration(false)}
    currentEstimate={totals.totalKg}
    currentCalibration={calibration}
    onCalibrate={handleCalibrate}
  />
</div>
```

Key behaviors:
- ConsentBanner always renders (it self-manages visibility)
- Dashboard content only renders when `hasConsent` is true
- Period changes trigger refetch
- Calibration modal POST then refetches stats
- Error state with retry button
- Consent denied and unknown show informative messages
  </action>
  <verify>Run `npx tsc --noEmit app/analytics/page.tsx` - no type errors. Verify the page imports all analytics components correctly.</verify>
  <done>Analytics dashboard at /analytics assembles all components. Consent-aware, period-selectable, with calibration modal. Fetches from /api/analytics/stats.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit app/analytics/page.tsx app/components/analytics/PeriodSelector.tsx app/components/analytics/CalibrationModal.tsx` - no errors
2. Page shows consent banner when undecided
3. Page shows informative message when consent denied
4. Page shows full dashboard when consent granted
5. Period selector changes trigger refetch
6. Calibration modal posts to API and refreshes
7. All charts receive correct data props
</verification>

<success_criteria>
- /analytics page renders with all 4 sections (stats, usage, consumption, weather)
- Consent state gates analytics features (GDPR compliance)
- Period selector switches 7/30/90 days
- Calibration modal saves and refreshes data
- Loading and error states handled throughout
- Follows notification dashboard page pattern
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-07-SUMMARY.md`
</output>
