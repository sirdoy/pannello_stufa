---
phase: 54-analytics-dashboard
plan: 08
type: execute
wave: 2
depends_on: ["54-01"]
files_modified:
  - app/api/stove/ignite/route.ts
  - app/api/stove/shutdown/route.ts
  - app/api/stove/setPower/route.ts
  - app/api/scheduler/check/route.ts
autonomous: true

must_haves:
  truths:
    - "Stove ignite API logs a stove_ignite analytics event after successful ignition"
    - "Stove shutdown API logs a stove_shutdown analytics event after successful shutdown"
    - "Stove setPower API logs a power_change analytics event after successful power change"
    - "API routes only log analytics events when X-Analytics-Consent header is 'granted'"
    - "Scheduler logs analytics events unconditionally (server-initiated, no user consent needed)"
    - "Analytics logging is fire-and-forget (never blocks or fails the stove operation)"
  artifacts:
    - path: "app/api/stove/ignite/route.ts"
      provides: "Stove ignition with analytics event logging"
      contains: "logAnalyticsEvent"
    - path: "app/api/stove/shutdown/route.ts"
      provides: "Stove shutdown with analytics event logging"
      contains: "logAnalyticsEvent"
    - path: "app/api/stove/setPower/route.ts"
      provides: "Power change with analytics event logging"
      contains: "logAnalyticsEvent"
    - path: "app/api/scheduler/check/route.ts"
      provides: "Scheduler stove operations with analytics event logging"
      contains: "logAnalyticsEvent"
  key_links:
    - from: "app/api/stove/ignite/route.ts"
      to: "lib/analyticsEventLogger.ts"
      via: "logAnalyticsEvent call after successful ignition"
      pattern: "logAnalyticsEvent"
    - from: "app/api/stove/shutdown/route.ts"
      to: "lib/analyticsEventLogger.ts"
      via: "logAnalyticsEvent call after successful shutdown"
      pattern: "logAnalyticsEvent"
    - from: "app/api/stove/setPower/route.ts"
      to: "lib/analyticsEventLogger.ts"
      via: "logAnalyticsEvent call after successful power change"
      pattern: "logAnalyticsEvent"
    - from: "app/api/scheduler/check/route.ts"
      to: "lib/analyticsEventLogger.ts"
      via: "logAnalyticsEvent call when scheduler performs stove actions"
      pattern: "logAnalyticsEvent"
---

<objective>
Instrument stove control API routes and the scheduler to log analytics events when stove state changes occur. This connects the event logger (54-01) to actual stove operations so the aggregation service (54-03) has real data to process.

Purpose: Without this instrumentation, the analytics pipeline has no data flowing into it. ANLY-03 requires "tracking stove ignition hours per day" which depends on actual events being logged when stove operations happen. This plan adds logAnalyticsEvent calls to the 3 stove API routes (ignite, shutdown, setPower) and the scheduler cron.
Output: 4 modified files with analytics event logging integrated into existing stove operations
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-analytics-dashboard/54-01-SUMMARY.md

@app/api/stove/ignite/route.ts
@app/api/stove/shutdown/route.ts
@app/api/stove/setPower/route.ts
@app/api/scheduler/check/route.ts
@lib/analyticsEventLogger.ts
@types/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instrument stove API routes with analytics event logging</name>
  <files>
    app/api/stove/ignite/route.ts
    app/api/stove/shutdown/route.ts
    app/api/stove/setPower/route.ts
  </files>
  <action>
Add analytics event logging to the three stove API routes. Each route already uses `withAuthAndErrorHandler` and has a `source` field from the validated input. The pattern is identical for all three:

1. Add import at top of each file:
```typescript
import { logAnalyticsEvent } from '@/lib/analyticsEventLogger';
```

2. After the successful stove operation (after `stoveService.ignite/shutdown/setPower` call) and BEFORE the `return success(...)`, add a consent-gated analytics log:

**For `app/api/stove/ignite/route.ts`:**
```typescript
// Analytics: log stove ignite event (fire-and-forget, consent-gated)
const consent = request.headers.get('x-analytics-consent');
if (consent === 'granted') {
  logAnalyticsEvent({
    eventType: 'stove_ignite',
    powerLevel: power,
    source: source ?? 'manual',
  }).catch(() => {}); // Fire-and-forget
}
```

**For `app/api/stove/shutdown/route.ts`:**
```typescript
// Analytics: log stove shutdown event (fire-and-forget, consent-gated)
const consent = request.headers.get('x-analytics-consent');
if (consent === 'granted') {
  logAnalyticsEvent({
    eventType: 'stove_shutdown',
    source: source ?? 'manual',
  }).catch(() => {}); // Fire-and-forget
}
```

**For `app/api/stove/setPower/route.ts`:**
```typescript
// Analytics: log power change event (fire-and-forget, consent-gated)
const consent = request.headers.get('x-analytics-consent');
if (consent === 'granted') {
  logAnalyticsEvent({
    eventType: 'power_change',
    powerLevel: level,
    source: source ?? 'manual',
  }).catch(() => {}); // Fire-and-forget
}
```

Key points:
- The `X-Analytics-Consent` header is sent by the client-side fetch calls (the client checks `canTrackAnalytics()` and sets this header). This is the standard pattern: client holds consent state in localStorage, passes it to server via header.
- `logAnalyticsEvent` is already fire-and-forget (catches errors internally), but adding `.catch(() => {})` makes it explicit that we don't await or handle errors.
- The `source` field maps directly to `AnalyticsEventSource` type ('manual' | 'scheduler' | 'automation').
- Do NOT move or restructure any existing code. Only ADD the import and the analytics block after the stove operation succeeds.
- If `source` is undefined in any route, default to `'manual'` using `??` operator.
  </action>
  <verify>Run `npx tsc --noEmit app/api/stove/ignite/route.ts app/api/stove/shutdown/route.ts app/api/stove/setPower/route.ts` and confirm no type errors. Grep for `logAnalyticsEvent` in all three files to confirm instrumentation.</verify>
  <done>All three stove API routes log analytics events after successful operations. Events are consent-gated via X-Analytics-Consent header and fire-and-forget.</done>
</task>

<task type="auto">
  <name>Task 2: Instrument scheduler cron with analytics event logging</name>
  <files>
    app/api/scheduler/check/route.ts
  </files>
  <action>
Add analytics event logging to the scheduler cron route at `app/api/scheduler/check/route.ts`. The scheduler performs stove ignite/shutdown/setPower operations as part of automated scheduling. These are server-initiated actions and do NOT require user consent (the scheduler is a system process, not a user interaction).

1. Add import at the top of the file (alongside existing imports):
```typescript
import { logAnalyticsEvent } from '@/lib/analyticsEventLogger';
```

2. Find the places where the scheduler calls `igniteStove`, `shutdownStove`, and `setPowerLevel`. After each SUCCESSFUL call, add analytics logging. The scheduler uses these from `@/lib/stoveApi`.

Search for patterns like:
- `await igniteStove(...)` - add after: `logAnalyticsEvent({ eventType: 'stove_ignite', powerLevel: ..., source: 'scheduler' }).catch(() => {});`
- `await shutdownStove(...)` - add after: `logAnalyticsEvent({ eventType: 'stove_shutdown', source: 'scheduler' }).catch(() => {});`
- `await setPowerLevel(...)` - add after: `logAnalyticsEvent({ eventType: 'power_change', powerLevel: ..., source: 'scheduler' }).catch(() => {});`

Key points:
- The scheduler is a cron job protected by CRON_SECRET. It runs server-side and has no user session. Therefore, NO consent check is needed - scheduler events are always logged.
- Use `source: 'scheduler'` for all scheduler-initiated events.
- The scheduler file is large. Only add the import and the analytics calls. Do NOT restructure any existing code.
- If there are multiple ignite/shutdown call sites, instrument ALL of them.
- Fire-and-forget with `.catch(() => {})` to ensure analytics never blocks cron execution.
- Extract the power level from the context available at each call site (the scheduler tracks current power level).
  </action>
  <verify>Run `npx tsc --noEmit app/api/scheduler/check/route.ts` and confirm no type errors. Grep for `logAnalyticsEvent` to confirm instrumentation points exist in the scheduler.</verify>
  <done>Scheduler logs stove_ignite, stove_shutdown, and power_change analytics events for all automated stove operations. No consent gate (server-initiated). Fire-and-forget.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit app/api/stove/ignite/route.ts app/api/stove/shutdown/route.ts app/api/stove/setPower/route.ts app/api/scheduler/check/route.ts` - no errors
2. All 4 files import `logAnalyticsEvent` from `@/lib/analyticsEventLogger`
3. API routes check `x-analytics-consent` header before logging
4. Scheduler logs unconditionally (server-initiated)
5. All analytics calls are fire-and-forget (never block stove operations)
6. Existing stove operations unchanged (analytics is additive only)
</verification>

<success_criteria>
- Stove ignite/shutdown/setPower API routes log analytics events after successful operations
- Consent is enforced via X-Analytics-Consent header on API routes
- Scheduler logs analytics events unconditionally for automated operations
- Analytics logging never blocks or fails stove operations
- No existing functionality broken
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-08-SUMMARY.md`
</output>
