---
phase: 54-analytics-dashboard
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - app/stove/page.tsx
  - app/debug/stove/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Manual stove ignition from app/stove/page.tsx sends X-Analytics-Consent header to API route"
    - "Manual stove shutdown from app/stove/page.tsx sends X-Analytics-Consent header to API route"
    - "Manual power change from app/stove/page.tsx sends X-Analytics-Consent header to API route"
    - "Debug page stove operations send X-Analytics-Consent header to API routes"
    - "When user denied consent, header value is 'denied' (or omitted) and API does NOT log analytics"
    - "When user granted consent, header value is 'granted' and API logs the analytics event"
  artifacts:
    - path: "app/stove/page.tsx"
      provides: "Consent header on all stove operation fetch calls"
      contains: "x-analytics-consent"
    - path: "app/debug/stove/page.tsx"
      provides: "Consent header on debug POST fetch calls"
      contains: "x-analytics-consent"
  key_links:
    - from: "app/stove/page.tsx"
      to: "lib/analyticsConsentService.ts"
      via: "import canTrackAnalytics"
      pattern: "canTrackAnalytics"
    - from: "app/stove/page.tsx"
      to: "app/api/stove/ignite/route.ts"
      via: "fetch with x-analytics-consent header"
      pattern: "x-analytics-consent.*granted"
    - from: "app/debug/stove/page.tsx"
      to: "lib/analyticsConsentService.ts"
      via: "import canTrackAnalytics"
      pattern: "canTrackAnalytics"
---

<objective>
Close the critical gap found during Phase 54 verification: client-side fetch calls to stove API routes (ignite, shutdown, setPower) do not send the X-Analytics-Consent header. API routes check this header to decide whether to log analytics events, but without the client sending it, manual user actions are NEVER logged.

Purpose: Complete the GDPR consent enforcement loop. Consent is collected (ConsentBanner), checked server-side (API routes), but never transmitted from client to server. This gap means analytics data only comes from scheduler-initiated events, not user actions.

Output: Modified app/stove/page.tsx and app/debug/stove/page.tsx with consent header on all stove operation fetch calls.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files for this gap closure
@lib/analyticsConsentService.ts
@app/stove/page.tsx
@app/debug/stove/page.tsx
@app/api/stove/ignite/route.ts

# Prior plan that created the server-side check
@.planning/phases/54-analytics-dashboard/54-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics consent header to stove page fetch calls</name>
  <files>app/stove/page.tsx</files>
  <action>
    Import `canTrackAnalytics` from `@/lib/analyticsConsentService` at the top of the file alongside other imports.

    Create a small helper function inside the component (or at module level) to build consent headers:

    ```typescript
    const getAnalyticsHeaders = (): HeadersInit => {
      const consent = canTrackAnalytics() ? 'granted' : 'denied';
      return { 'x-analytics-consent': consent };
    };
    ```

    Modify the following 3 fetch calls to include the consent header:

    1. **handleIgnite** (~line 414): Change the fetch to include headers:
       ```typescript
       await fetch(STOVE_ROUTES.ignite, {
         method: 'POST',
         headers: getAnalyticsHeaders(),
         body: JSON.stringify({ source: 'manual' }),
       });
       ```

    2. **handleShutdown** (~line 432): Change the fetch to include headers:
       ```typescript
       await fetch(STOVE_ROUTES.shutdown, {
         method: 'POST',
         headers: getAnalyticsHeaders(),
         body: JSON.stringify({ source: 'manual' }),
       });
       ```

    3. **handlePowerChange** (~line 387): Change the fetch to include headers:
       ```typescript
       const response = await fetch(STOVE_ROUTES.setPower, {
         method: 'POST',
         headers: getAnalyticsHeaders(),
         body: JSON.stringify({ level: newLevel, source: 'manual' }),
       });
       ```

    NOTE: Do NOT add the header to handleFanChange — the setFan API route does NOT have analytics instrumentation (verified: no logAnalyticsEvent in app/api/stove/setFan/route.ts). Adding headers to calls that don't use them is unnecessary but harmless. Skip it for minimal changes.

    NOTE: Do NOT add Content-Type header — the existing fetch calls work without it because Next.js API routes parse JSON body regardless. Adding it would change existing behavior pattern.
  </action>
  <verify>
    1. Run `grep -n 'x-analytics-consent' app/stove/page.tsx` — must show 3+ matches (in headers for ignite, shutdown, setPower)
    2. Run `grep -n 'canTrackAnalytics' app/stove/page.tsx` — must show import line and usage in helper
    3. Run `npx tsc --noEmit app/stove/page.tsx` or full `npx tsc --noEmit` — no new type errors
  </verify>
  <done>
    handleIgnite, handleShutdown, and handlePowerChange in app/stove/page.tsx all send X-Analytics-Consent header with value based on canTrackAnalytics() result. Manual user stove operations will now trigger analytics event logging on the server when consent is granted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add analytics consent header to debug stove page fetch calls</name>
  <files>app/debug/stove/page.tsx</files>
  <action>
    Import `canTrackAnalytics` from `@/lib/analyticsConsentService` at the top of the file alongside other imports.

    Modify the `callPostEndpoint` function to include the consent header. This function is the centralized POST handler used by ALL debug page operations (ignite, shutdown, setPower, setFan, setWaterTemperature).

    In `callPostEndpoint` (~line 133), the `options` object is built with `headers: { 'Content-Type': 'application/json' }`. Merge the consent header into this:

    ```typescript
    const callPostEndpoint = async (name: string, url: string, body: any = null): Promise<void> => {
      setLoadingPost((prev) => ({ ...prev, [name]: true }));
      try {
        const consent = canTrackAnalytics() ? 'granted' : 'denied';
        const options: RequestInit = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-analytics-consent': consent,
          },
        };
        if (body) {
          options.body = JSON.stringify(body);
        }
        // ... rest unchanged
    ```

    This is clean because the debug page already has a centralized POST function. One change covers all POST endpoints (ignite, shutdown, setPower, setFan, setWaterTemperature).

    NOTE: GET endpoints (fetchGetEndpoint) do NOT need the header — analytics is only logged on state-changing operations (POST).
  </action>
  <verify>
    1. Run `grep -n 'x-analytics-consent' app/debug/stove/page.tsx` — must show match in callPostEndpoint
    2. Run `grep -n 'canTrackAnalytics' app/debug/stove/page.tsx` — must show import and usage
    3. Run `npx tsc --noEmit app/debug/stove/page.tsx` or full `npx tsc --noEmit` — no new type errors
  </verify>
  <done>
    Debug stove page callPostEndpoint function sends X-Analytics-Consent header on all POST operations. Debug page stove operations will now trigger analytics event logging when consent is granted.
  </done>
</task>

</tasks>

<verification>
1. **Consent header present in stove page:** `grep -c 'x-analytics-consent' app/stove/page.tsx` returns 3+
2. **Consent header present in debug page:** `grep -c 'x-analytics-consent' app/debug/stove/page.tsx` returns 1+
3. **canTrackAnalytics imported in both files:**
   - `grep 'canTrackAnalytics' app/stove/page.tsx` shows import
   - `grep 'canTrackAnalytics' app/debug/stove/page.tsx` shows import
4. **TypeScript compiles:** `npx tsc --noEmit` exits 0 (no new errors)
5. **Existing tests pass:** `npm test` passes (no regressions)
6. **End-to-end flow:** When user grants consent via ConsentBanner, subsequent manual ignite/shutdown/power change sends `x-analytics-consent: granted` header, and API route logs the analytics event to Firebase RTDB.
</verification>

<success_criteria>
- X-Analytics-Consent header sent on all 3 stove operation fetch calls in app/stove/page.tsx
- X-Analytics-Consent header sent on all POST calls in app/debug/stove/page.tsx
- Header value reflects current canTrackAnalytics() state ('granted' or 'denied')
- No TypeScript compilation errors introduced
- No existing test regressions
- GDPR consent enforcement loop is now complete: ConsentBanner -> localStorage -> canTrackAnalytics() -> X-Analytics-Consent header -> API route check -> logAnalyticsEvent (or skip)
</success_criteria>

<output>
After completion, create `.planning/phases/54-analytics-dashboard/54-09-SUMMARY.md`
</output>
