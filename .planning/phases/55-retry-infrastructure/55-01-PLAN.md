---
phase: 55-retry-infrastructure
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/retry/retryClient.ts
  - lib/retry/deduplicationManager.ts
  - lib/retry/__tests__/retryClient.test.ts
  - lib/retry/__tests__/deduplicationManager.test.ts
autonomous: true

must_haves:
  truths:
    - "Transient network errors auto-retry up to 3 times with exponential backoff"
    - "Non-retryable errors (validation, auth, device offline) throw immediately without retry"
    - "Duplicate requests within 2-second window are silently blocked"
    - "Deduplication state auto-cleans when references are garbage collected"
  artifacts:
    - path: "lib/retry/retryClient.ts"
      provides: "Retry wrapper with exponential backoff, jitter, error classification"
      exports: ["retryFetch", "isTransientError", "RetryOptions", "RetryError"]
    - path: "lib/retry/deduplicationManager.ts"
      provides: "Request deduplication with 2-second window"
      exports: ["deduplicationManager", "DeduplicationManager"]
    - path: "lib/retry/__tests__/retryClient.test.ts"
      provides: "Unit tests for retry logic"
      contains: "retryFetch"
    - path: "lib/retry/__tests__/deduplicationManager.test.ts"
      provides: "Unit tests for deduplication"
      contains: "isDuplicate"
  key_links:
    - from: "lib/retry/retryClient.ts"
      to: "lib/core/apiErrors.ts"
      via: "ERROR_CODES import for classifying transient vs persistent errors"
      pattern: "import.*ERROR_CODES.*from.*apiErrors"
---

<objective>
Create the core retry client with exponential backoff and the request deduplication manager.

Purpose: These are the foundational building blocks for RETRY-02 (auto-retry transient errors), RETRY-05 (request deduplication), and RETRY-06 (single retry layer at API boundary). The retry client wraps fetch calls with automatic retry on transient errors using exponential backoff with 30% jitter. The deduplication manager prevents double-tap from sending duplicate commands within a 2-second window.

Output: Two tested modules — `retryClient.ts` and `deduplicationManager.ts` — ready for integration.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-retry-infrastructure/55-RESEARCH.md

@lib/core/apiErrors.ts — ERROR_CODES constants for classifying transient vs persistent errors
@types/api/errors.ts — ErrorCode type union
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement retryClient with TDD</name>
  <files>lib/retry/retryClient.ts, lib/retry/__tests__/retryClient.test.ts</files>
  <action>
RED phase — Create `lib/retry/__tests__/retryClient.test.ts` with these test cases:
- `retryFetch` returns response on first success (no retry)
- `retryFetch` retries up to 3 times on transient errors (NETWORK_ERROR, TIMEOUT, SERVICE_UNAVAILABLE, STOVE_TIMEOUT)
- `retryFetch` throws immediately on non-retryable errors (VALIDATION_ERROR, UNAUTHORIZED, STOVE_OFFLINE, MAINTENANCE_REQUIRED, HUE_NOT_CONNECTED, NETATMO_NOT_CONNECTED)
- `retryFetch` applies exponential backoff: delays are ~1s, ~2s, ~4s (with 30% jitter tolerance in assertion)
- `retryFetch` caps delay at maxDelay (10s default)
- `retryFetch` calls onRetry callback with attempt number and error
- `retryFetch` respects custom maxAttempts, initialDelay, maxDelay options
- `isTransientError` correctly classifies error codes as transient or persistent
- `RetryError` wraps the last error with attempt count metadata

Mock `fetch` globally. Use `jest.useFakeTimers()` for backoff timing tests — advance timers between retries. Run tests: they MUST fail (RED).

GREEN phase — Create `lib/retry/retryClient.ts`:

```typescript
import { ERROR_CODES } from '@/lib/core/apiErrors';

// Transient error codes that should be auto-retried
const TRANSIENT_ERROR_CODES: ReadonlySet<string> = new Set([
  ERROR_CODES.NETWORK_ERROR,
  ERROR_CODES.TIMEOUT,
  ERROR_CODES.SERVICE_UNAVAILABLE,
  ERROR_CODES.STOVE_TIMEOUT,
  ERROR_CODES.EXTERNAL_API_ERROR,
]);

export interface RetryOptions {
  maxAttempts?: number;       // Default: 3
  initialDelay?: number;      // Default: 1000ms
  maxDelay?: number;          // Default: 10000ms
  backoffMultiplier?: number; // Default: 2
  onRetry?: (attempt: number, error: Error) => void;
}

export class RetryError extends Error { ... }
export function isTransientError(code: string): boolean { ... }
export async function retryFetch(url: string, options: RequestInit, retryOptions?: RetryOptions): Promise<Response> { ... }
```

Key implementation details:
- Parse response JSON to extract `code` field, check against TRANSIENT_ERROR_CODES
- Network TypeError (fetch fails entirely) is always retryable
- Exponential delay: `min(initialDelay * 2^attempt, maxDelay)` + random jitter (0 to 30% of delay)
- After maxAttempts exhausted, throw RetryError wrapping the last error
- Do NOT delay after the last failed attempt
- Clone response before reading JSON (so caller can still read the body)

Run tests: they MUST pass (GREEN).

REFACTOR — Clean up, ensure exports are clean, add JSDoc to all exports.
  </action>
  <verify>Run `npx jest lib/retry/__tests__/retryClient.test.ts --no-coverage` — all tests pass</verify>
  <done>retryFetch correctly retries transient errors with exponential backoff and throws immediately for non-retryable errors. RetryError includes attempt metadata. isTransientError classifies all ERROR_CODES correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Implement deduplicationManager with TDD</name>
  <files>lib/retry/deduplicationManager.ts, lib/retry/__tests__/deduplicationManager.test.ts</files>
  <action>
RED phase — Create `lib/retry/__tests__/deduplicationManager.test.ts` with these test cases:
- `isDuplicate` returns false for first call with a given key
- `isDuplicate` returns true for second call within 2-second window
- `isDuplicate` returns false after 2-second window expires (use jest.advanceTimersByTime)
- `clear` removes dedup state, allowing immediate re-request
- Different keys (different action/device combos) do not interfere with each other
- `createRequestKey` generates stable key objects for same action+device combination
- `isInFlight` returns true during active request, false after clear
- Singleton `deduplicationManager` export works

Use `jest.useFakeTimers()` for timing. Run tests: they MUST fail (RED).

GREEN phase — Create `lib/retry/deduplicationManager.ts`:

```typescript
export class DeduplicationManager {
  private inFlightRequests = new Map<string, number>();
  private readonly DEDUP_WINDOW_MS = 2000; // 2 seconds (locked decision)

  isDuplicate(key: string): boolean { ... }
  isInFlight(key: string): boolean { ... }
  clear(key: string): void { ... }
}
```

Implementation notes:
- Use Map<string, number> with string keys (not WeakMap — WeakMap requires object references that components would need to maintain; string keys like `"stove:ignite"` are more practical and predictable)
- `isDuplicate(key)`: checks if key exists in map AND timestamp is within DEDUP_WINDOW_MS. If not duplicate, stores current timestamp and returns false.
- `clear(key)`: removes key from map
- `isInFlight(key)`: returns true if key is in map and within window
- Export `createRequestKey(device: string, action: string): string` helper that creates consistent `"device:action"` keys
- Export singleton: `export const deduplicationManager = new DeduplicationManager()`

Run tests: they MUST pass (GREEN).

REFACTOR — Add JSDoc, ensure clean exports.
  </action>
  <verify>Run `npx jest lib/retry/__tests__/deduplicationManager.test.ts --no-coverage` — all tests pass</verify>
  <done>DeduplicationManager blocks duplicate requests within 2-second window, allows requests after window expires, and provides createRequestKey helper for consistent key generation.</done>
</task>

</tasks>

<verification>
```bash
npx jest lib/retry/__tests__/ --no-coverage --verbose
```
All retry and deduplication tests pass. Both modules export clean TypeScript interfaces.
</verification>

<success_criteria>
- retryClient.ts exports retryFetch, isTransientError, RetryOptions, RetryError
- deduplicationManager.ts exports deduplicationManager, createRequestKey, DeduplicationManager
- Transient errors (NETWORK_ERROR, TIMEOUT, SERVICE_UNAVAILABLE, STOVE_TIMEOUT) trigger auto-retry
- Non-retryable errors throw immediately
- Exponential backoff with 30% jitter and 10s max delay
- 2-second deduplication window blocks duplicate requests
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/55-retry-infrastructure/55-01-SUMMARY.md`
</output>
