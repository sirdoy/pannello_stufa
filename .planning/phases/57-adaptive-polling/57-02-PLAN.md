---
phase: 57-adaptive-polling
plan: 02
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - app/components/devices/thermostat/ThermostatCard.tsx
  - app/components/devices/lights/LightsCard.tsx
  - app/components/CronHealthBanner.tsx
  - lib/hooks/__tests__/useAdaptivePolling.integration.test.ts
autonomous: true

must_haves:
  truths:
    - "ThermostatCard pauses its 30s polling when tab is hidden"
    - "ThermostatCard resumes polling immediately when tab becomes visible"
    - "LightsCard pauses its 30s polling when tab is hidden"
    - "LightsCard resumes polling immediately when tab becomes visible"
    - "CronHealthBanner pauses its 30s polling when tab is hidden"
    - "CronHealthBanner resumes polling when tab becomes visible"
    - "Non-critical polling uses doubled interval on slow network"
  artifacts:
    - path: "app/components/devices/thermostat/ThermostatCard.tsx"
      provides: "Thermostat polling via useAdaptivePolling"
      contains: "useAdaptivePolling"
    - path: "app/components/devices/lights/LightsCard.tsx"
      provides: "Lights polling via useAdaptivePolling"
      contains: "useAdaptivePolling"
    - path: "app/components/CronHealthBanner.tsx"
      provides: "Cron health polling via useAdaptivePolling with network awareness"
      contains: "useAdaptivePolling"
    - path: "lib/hooks/__tests__/useAdaptivePolling.integration.test.ts"
      provides: "Integration tests for network-aware interval adjustment"
      min_lines: 30
  key_links:
    - from: "app/components/devices/thermostat/ThermostatCard.tsx"
      to: "lib/hooks/useAdaptivePolling.ts"
      via: "import useAdaptivePolling"
      pattern: "import.*useAdaptivePolling"
    - from: "app/components/devices/lights/LightsCard.tsx"
      to: "lib/hooks/useAdaptivePolling.ts"
      via: "import useAdaptivePolling"
      pattern: "import.*useAdaptivePolling"
    - from: "app/components/CronHealthBanner.tsx"
      to: "lib/hooks/useAdaptivePolling.ts"
      via: "import useAdaptivePolling"
      pattern: "import.*useAdaptivePolling"
---

<objective>
Integrate useAdaptivePolling into ThermostatCard, LightsCard, and CronHealthBanner. These are non-critical polling consumers that should pause when tab is hidden and adjust frequency on slow networks.

Purpose: Reduce unnecessary API calls when user is not viewing the tab. CronHealthBanner also demonstrates network-aware interval adjustment (POLL-04).
Output: Three components updated to use centralized polling hook, plus integration tests.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-adaptive-polling/57-RESEARCH.md
@.planning/phases/57-adaptive-polling/57-01-SUMMARY.md
@app/components/devices/thermostat/ThermostatCard.tsx
@app/components/devices/lights/LightsCard.tsx
@app/components/CronHealthBanner.tsx
@lib/hooks/useAdaptivePolling.ts
@lib/hooks/useNetworkQuality.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace polling in ThermostatCard and LightsCard with useAdaptivePolling</name>
  <files>
    app/components/devices/thermostat/ThermostatCard.tsx
    app/components/devices/lights/LightsCard.tsx
  </files>
  <action>
**ThermostatCard** (`app/components/devices/thermostat/ThermostatCard.tsx`):

1. Add import: `import { useAdaptivePolling } from '@/lib/hooks/useAdaptivePolling';`
2. Remove the `pollingStartedRef` variable and its usage
3. Replace the existing polling useEffect (the one with `setInterval(fetchStatus, 30000)`) with:

```typescript
// Poll status every 30 seconds - pauses when tab hidden
useAdaptivePolling({
  callback: fetchStatus,
  interval: topology ? 30000 : null, // Only poll when connected (topology exists)
  alwaysActive: false, // Non-critical: pause when hidden
  immediate: true,
});
```

4. Keep all other useEffects unchanged (connection check, room status, etc.)
5. Do NOT change the `fetchStatus` function or any other logic

**LightsCard** (`app/components/devices/lights/LightsCard.tsx`):

1. Add import: `import { useAdaptivePolling } from '@/lib/hooks/useAdaptivePolling';`
2. Remove the `pollingStartedRef` variable and its usage
3. Replace the existing polling useEffect (the one with `setInterval(fetchData, 30000)`) with:

```typescript
// Poll data every 30 seconds - pauses when tab hidden
useAdaptivePolling({
  callback: fetchData,
  interval: connected ? 30000 : null, // Only poll when connected
  alwaysActive: false, // Non-critical: pause when hidden
  immediate: true,
});
```

4. Keep all other useEffects unchanged (connection check, pairing timer, room selection, etc.)
5. Do NOT change the `fetchData` function or any other logic
6. Keep `pairingTimerRef` - it's for pairing countdown, not polling

**IMPORTANT**: The `pollingStartedRef` guard was preventing duplicate intervals. `useAdaptivePolling` handles this internally via useEffect cleanup, so the guard is no longer needed. But verify that removing it doesn't cause issues by ensuring the hook's dependency array triggers cleanup correctly.
  </action>
  <verify>
Run existing tests to verify no regressions:
```bash
npm test -- --testPathPattern='(ThermostatCard|LightsCard)' --no-coverage
```
If no existing tests cover polling, verify TypeScript compiles:
```bash
npx tsc --noEmit 2>&1 | grep -E '(ThermostatCard|LightsCard)' | head -10
```
  </verify>
  <done>
ThermostatCard and LightsCard both use useAdaptivePolling for their 30s polling. Polling pauses when tab hidden, resumes when visible. pollingStartedRef guards removed. No functional regression.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace polling in CronHealthBanner with network-aware useAdaptivePolling</name>
  <files>
    app/components/CronHealthBanner.tsx
    lib/hooks/__tests__/useAdaptivePolling.integration.test.ts
  </files>
  <action>
**CronHealthBanner** (`app/components/CronHealthBanner.tsx`):

1. Add imports:
```typescript
import { useAdaptivePolling } from '@/lib/hooks/useAdaptivePolling';
import { useNetworkQuality } from '@/lib/hooks/useNetworkQuality';
```

2. Add inside the component:
```typescript
const networkQuality = useNetworkQuality();
```

3. Replace the FIRST useEffect (the one with `fetchCronHealth` and `setInterval(fetchCronHealth, 30000)`) with:
```typescript
// Fetch cron health data
const fetchCronHealth = useCallback(async () => {
  try {
    const snapshot = await get(ref(db, 'cronHealth/lastCall'));
    if (snapshot.exists()) {
      const lastCall = snapshot.val();
      setLastCallTime(lastCall);
    }
  } catch (error) {
    console.error('[CronHealthBanner] Error fetching cronHealth:', error);
  }
}, []);

// Network-aware polling: 30s on fast/unknown, 60s on slow
const cronInterval = networkQuality === 'slow' ? 60000 : 30000;

useAdaptivePolling({
  callback: fetchCronHealth,
  interval: cronInterval,
  alwaysActive: false, // Non-critical: pause when hidden
  immediate: true,
});
```

4. Replace the SECOND useEffect (the one with `checkCronHealth` and `setInterval(checkCronHealth, 30000)`) with:
```typescript
// Check staleness of cron data
const checkCronHealth = useCallback(() => {
  if (!lastCallTime) return;
  const lastCallDate = new Date(lastCallTime);
  const now = new Date();
  const diffMs = now.getTime() - lastCallDate.getTime();
  const diffMinutes = Math.floor(diffMs / 1000 / 60);
  setMinutesSinceLastCall(diffMinutes);
  setShowBanner(diffMinutes > 5);
}, [lastCallTime]);

useAdaptivePolling({
  callback: checkCronHealth,
  interval: 30000,
  alwaysActive: false,
  immediate: true,
});
```

5. Add `import { useCallback } from 'react'` to the existing React imports (add `useCallback` alongside `useState` and `useEffect`)
6. Remove `useEffect` from imports if no longer used directly

**Integration test** (`lib/hooks/__tests__/useAdaptivePolling.integration.test.ts`):

Write tests verifying that the network quality multiplier pattern works correctly:

```typescript
/**
 * Integration tests for useAdaptivePolling with network awareness
 * @jest-environment jsdom
 */
```

Test cases:
1. "uses base interval when network quality is fast" - verify 30s interval used
2. "doubles interval when network quality is slow" - verify 60s interval used
3. "uses base interval when network quality is unknown" - verify 30s interval used (unknown = don't penalize)
  </action>
  <verify>
Run:
```bash
npm test -- --testPathPattern='(CronHealthBanner|useAdaptivePolling\.integration)' --no-coverage
```
  </verify>
  <done>
CronHealthBanner uses useAdaptivePolling with network-aware interval (30s fast, 60s slow). Both intervals pause when tab hidden. Integration tests verify network quality multiplier pattern.
  </done>
</task>

</tasks>

<verification>
```bash
# Verify all updated components compile
npx tsc --noEmit 2>&1 | grep -E '(ThermostatCard|LightsCard|CronHealthBanner)' | head -10

# Run integration tests
npm test -- --testPathPattern='useAdaptivePolling\.integration' --no-coverage

# Verify useAdaptivePolling import in all updated files
grep -n 'useAdaptivePolling' app/components/devices/thermostat/ThermostatCard.tsx app/components/devices/lights/LightsCard.tsx app/components/CronHealthBanner.tsx

# Verify pollingStartedRef removed from ThermostatCard and LightsCard
grep -n 'pollingStartedRef' app/components/devices/thermostat/ThermostatCard.tsx app/components/devices/lights/LightsCard.tsx
# Expected: no matches
```
</verification>

<success_criteria>
- ThermostatCard polling pauses when tab hidden, resumes when visible
- LightsCard polling pauses when tab hidden, resumes when visible
- CronHealthBanner uses doubled interval (60s) on slow network
- pollingStartedRef removed from ThermostatCard and LightsCard
- All existing tests pass without regressions
- Integration tests for network-aware intervals pass
</success_criteria>

<output>
After completion, create `.planning/phases/57-adaptive-polling/57-02-SUMMARY.md`
</output>
