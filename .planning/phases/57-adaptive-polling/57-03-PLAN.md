---
phase: 57-adaptive-polling
plan: 03
type: execute
wave: 2
depends_on: ["57-01"]
files_modified:
  - app/components/devices/stove/StoveCard.tsx
  - lib/hooks/useDeviceStaleness.ts
  - lib/hooks/__tests__/useDeviceStaleness.test.ts
autonomous: true

must_haves:
  truths:
    - "Stove status polling NEVER pauses when tab hidden (safety-critical, alwaysActive:true)"
    - "Stove maintains its existing adaptive intervals (10s fallback, 15s on, 60s off)"
    - "useDeviceStaleness pauses its 5s polling when tab is hidden"
    - "Staleness indicator correctly shows when data age exceeds 2x expected refresh interval"
    - "StoveCard shows staleness badge when data is old AND tab is visible"
  artifacts:
    - path: "app/components/devices/stove/StoveCard.tsx"
      provides: "Stove polling preserving safety-critical behavior"
      contains: "useVisibility"
    - path: "lib/hooks/useDeviceStaleness.ts"
      provides: "Visibility-aware staleness monitoring"
      contains: "useVisibility"
    - path: "lib/hooks/__tests__/useDeviceStaleness.test.ts"
      provides: "Updated tests for visibility-aware staleness"
      min_lines: 50
  key_links:
    - from: "app/components/devices/stove/StoveCard.tsx"
      to: "lib/hooks/useVisibility.ts"
      via: "import useVisibility for staleness display"
      pattern: "import.*useVisibility"
    - from: "lib/hooks/useDeviceStaleness.ts"
      to: "lib/hooks/useVisibility.ts"
      via: "import useVisibility for pause when hidden"
      pattern: "import.*useVisibility"
---

<objective>
Integrate visibility awareness into StoveCard and useDeviceStaleness. StoveCard's safety-critical polling must NEVER pause, but its staleness display should be visibility-aware. useDeviceStaleness should pause its 5s IndexedDB polling when tab is hidden (non-critical monitoring).

Purpose: The stove is safety-critical - its polling must always run. But the staleness check hook (which polls IndexedDB, not the stove) can safely pause. The staleness badge should only show when the tab is visible.
Output: StoveCard with visibility-aware staleness display, useDeviceStaleness with visibility-based pause.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-adaptive-polling/57-RESEARCH.md
@.planning/phases/57-adaptive-polling/57-01-SUMMARY.md
@app/components/devices/stove/StoveCard.tsx
@lib/hooks/useDeviceStaleness.ts
@lib/hooks/__tests__/useDeviceStaleness.test.ts
@lib/hooks/useVisibility.ts
@lib/hooks/useAdaptivePolling.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add visibility awareness to useDeviceStaleness and update tests</name>
  <files>
    lib/hooks/useDeviceStaleness.ts
    lib/hooks/__tests__/useDeviceStaleness.test.ts
  </files>
  <action>
**useDeviceStaleness** (`lib/hooks/useDeviceStaleness.ts`):

The current hook polls IndexedDB every 5 seconds to check device data freshness. This is purely a UI concern and should pause when tab is hidden.

1. Add import: `import { useVisibility } from './useVisibility';`
2. Inside the hook, add: `const isVisible = useVisibility();`
3. Replace the existing `useEffect` with one that uses useAdaptivePolling pattern:

```typescript
import { useEffect, useState, useRef, useCallback } from 'react';
import { getDeviceStaleness, type StalenessInfo } from '@/lib/pwa/stalenessDetector';
import { useVisibility } from './useVisibility';

export function useDeviceStaleness(deviceId: string): StalenessInfo | null {
  const [staleness, setStaleness] = useState<StalenessInfo | null>(null);
  const isVisible = useVisibility();

  const fetchStaleness = useCallback(async () => {
    try {
      const info = await getDeviceStaleness(deviceId);
      setStaleness(info);
    } catch (error) {
      console.error(`[useDeviceStaleness] Error fetching staleness for ${deviceId}:`, error);
    }
  }, [deviceId]);

  useEffect(() => {
    // Don't poll when tab is hidden (staleness display is non-critical)
    if (!isVisible) return;

    // Fetch immediately when becoming visible
    fetchStaleness();

    // Poll every 5 seconds while visible
    const intervalId = setInterval(fetchStaleness, 5000);

    return () => {
      clearInterval(intervalId);
    };
  }, [deviceId, isVisible, fetchStaleness]);

  return staleness;
}
```

Key changes:
- Added `isVisible` dependency - effect re-runs when visibility changes
- When `!isVisible`, effect returns early (no interval set)
- When becoming visible again, fetches immediately then resumes 5s interval
- Extracted `fetchStaleness` to useCallback for stability

**Tests** (`lib/hooks/__tests__/useDeviceStaleness.test.ts`):

1. Add mock for useVisibility at top of file:
```typescript
jest.mock('../useVisibility', () => ({
  useVisibility: jest.fn(() => true), // Default: visible
}));
```

2. Import the mock: `import { useVisibility } from '../useVisibility';`

3. Add new test cases:

```typescript
it('pauses polling when tab is hidden', async () => {
  jest.mocked(useVisibility).mockReturnValue(false);
  // ... verify no interval fires
});

it('resumes polling when tab becomes visible', async () => {
  // Start hidden
  jest.mocked(useVisibility).mockReturnValue(false);
  const { rerender } = renderHook(() => useDeviceStaleness('stove'));

  // Become visible
  jest.mocked(useVisibility).mockReturnValue(true);
  rerender();

  // Should fetch immediately on visibility restore
  await waitFor(() => {
    expect(stalenessDetector.getDeviceStaleness).toHaveBeenCalled();
  });
});
```

4. Ensure existing tests still pass (they assume visible = true, which is the mock default)
  </action>
  <verify>
Run: `npm test -- --testPathPattern='lib/hooks/__tests__/useDeviceStaleness' --no-coverage`
All tests pass including new visibility-aware tests.
  </verify>
  <done>
useDeviceStaleness pauses its 5s polling when tab hidden, resumes with immediate fetch when visible. All existing and new tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add visibility-aware staleness display to StoveCard</name>
  <files>
    app/components/devices/stove/StoveCard.tsx
  </files>
  <action>
**CRITICAL**: StoveCard's existing polling mechanism is complex and safety-critical. Do NOT replace it with useAdaptivePolling. The stove uses a recursive setTimeout chain with Firebase fallback detection, adaptive intervals based on stove state (10s/15s/60s), and stale threshold logic. This is intentionally different from the simple setInterval pattern and must be preserved exactly as-is.

**What to change:**

1. Add import: `import { useVisibility } from '@/lib/hooks/useVisibility';`

2. Inside the component, add:
```typescript
const isVisible = useVisibility();
```

3. Find the existing staleness display section (around line 1099-1103 where `staleness?.cachedAt` is shown). Wrap it with visibility awareness so staleness badge only shows when:
   - Tab is visible (`isVisible === true`)
   - Data is actually stale (`staleness?.isStale === true`)

The existing code shows a text like "Ultimo aggiornamento: X secondi fa" near the bottom of StoveCard. This should continue to show when data is fresh as a timestamp, but add a visual staleness indicator (warning style) when data is stale AND tab is visible.

4. Add a staleness warning badge near the status display area (top of the card) when data is old:
```tsx
{isVisible && staleness?.isStale && (
  <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-xs font-medium bg-warning-900/30 text-warning-400 border border-warning-500/30 [html:not(.dark)_&]:bg-warning-100 [html:not(.dark)_&]:text-warning-700 [html:not(.dark)_&]:border-warning-300">
    Dati non aggiornati ({staleness.ageSeconds}s)
  </span>
)}
```

Place this badge near the connection status indicator or the "Ultimo aggiornamento" text - somewhere visible but not disruptive to the main stove status display.

5. **DO NOT TOUCH** the existing polling useEffect, the Firebase connection monitoring, the Firebase real-time listener, or the `pollingStartedRef` logic. These are all safety-critical and must remain exactly as they are.

**Why not use useAdaptivePolling here**: The stove's polling is a recursive setTimeout with complex conditionals (Firebase fallback mode, stale threshold adaptation, Firebase connection state). It already has its own adaptive behavior. Replacing it would risk breaking safety-critical functionality. The visibility awareness here is purely cosmetic (staleness display), not behavioral (polling control).
  </action>
  <verify>
Run existing StoveCard tests:
```bash
npm test -- --testPathPattern='StoveCard' --no-coverage
```

Verify useVisibility import added:
```bash
grep -n 'useVisibility' app/components/devices/stove/StoveCard.tsx
```

Verify polling logic untouched:
```bash
grep -n 'pollingStartedRef\|scheduleNextPoll\|usePollingFallback' app/components/devices/stove/StoveCard.tsx
# Should show same line numbers as before
```
  </verify>
  <done>
StoveCard displays staleness badge only when tab is visible AND data is stale. Existing safety-critical polling logic is completely untouched. pollingStartedRef, Firebase fallback, and adaptive setTimeout chain all preserved exactly as-is.
  </done>
</task>

</tasks>

<verification>
```bash
# Run all affected tests
npm test -- --testPathPattern='(useDeviceStaleness|StoveCard)' --no-coverage

# Verify StoveCard polling logic NOT changed (safety check)
grep -c 'scheduleNextPoll\|usePollingFallback\|pollingStartedRef' app/components/devices/stove/StoveCard.tsx
# Expected: same counts as before (3+ matches)

# Verify useVisibility imported in both files
grep 'useVisibility' app/components/devices/stove/StoveCard.tsx lib/hooks/useDeviceStaleness.ts

# Verify staleness display is visibility-gated
grep -A2 'isVisible.*staleness' app/components/devices/stove/StoveCard.tsx

# TypeScript check
npx tsc --noEmit 2>&1 | grep -E '(StoveCard|useDeviceStaleness)' | head -10
```
</verification>

<success_criteria>
- StoveCard's existing polling mechanism is COMPLETELY UNCHANGED (safety-critical)
- StoveCard shows staleness badge only when tab visible AND data stale
- useDeviceStaleness pauses its 5s IndexedDB polling when tab hidden
- useDeviceStaleness resumes polling with immediate fetch when tab visible
- All existing tests pass without regressions
- New staleness visibility tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/57-adaptive-polling/57-03-SUMMARY.md`
</output>
