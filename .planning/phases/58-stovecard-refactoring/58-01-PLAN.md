---
phase: 58-stovecard-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/stove/hooks/useStoveData.ts
  - app/components/devices/stove/hooks/useStoveCommands.ts
  - app/components/devices/stove/stoveStatusUtils.ts
  - __tests__/components/devices/stove/hooks/useStoveData.test.ts
  - __tests__/components/devices/stove/hooks/useStoveCommands.test.ts
autonomous: true

must_haves:
  truths:
    - "useStoveData hook encapsulates all polling, Firebase listeners, and stove state management"
    - "useStoveCommands hook encapsulates all command handlers (ignite, shutdown, setFan, setPower, modes, cleaning)"
    - "Status utility functions (getStatusInfo, getStatusDisplay) are importable from a separate module"
    - "Single polling loop guarantee preserved — only useStoveData contains polling/Firebase effects"
    - "useRetryableCommand integration preserved — all commands use Phase 55 retry infrastructure"
  artifacts:
    - path: "app/components/devices/stove/hooks/useStoveData.ts"
      provides: "All stove state, polling, Firebase listeners, derived state"
      exports: ["useStoveData"]
    - path: "app/components/devices/stove/hooks/useStoveCommands.ts"
      provides: "All command handlers with retry infrastructure"
      exports: ["useStoveCommands"]
    - path: "app/components/devices/stove/stoveStatusUtils.ts"
      provides: "Status mapping functions (getStatusInfo, getStatusDisplay, derived state helpers)"
      exports: ["getStatusInfo", "getStatusDisplay"]
  key_links:
    - from: "app/components/devices/stove/hooks/useStoveData.ts"
      to: "lib/hooks/useDeviceStaleness.ts"
      via: "hook composition"
      pattern: "useDeviceStaleness\\('stove'\\)"
    - from: "app/components/devices/stove/hooks/useStoveCommands.ts"
      to: "lib/hooks/useRetryableCommand.ts"
      via: "hook composition"
      pattern: "useRetryableCommand\\("
---

<objective>
Extract custom hooks (useStoveData, useStoveCommands) and status utility functions from the monolithic StoveCard.tsx into separate modules.

Purpose: This foundation enables the orchestrator pattern by separating state management and command logic from rendering. The hooks and utilities must be extracted first because all sub-components (Plan 02, 03) will depend on the data shapes they expose.

Output: 2 custom hooks + 1 utility module + tests, ready for sub-component integration.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-stovecard-refactoring/58-RESEARCH.md
@app/components/devices/stove/StoveCard.tsx
@lib/hooks/useRetryableCommand.ts
@lib/hooks/useDeviceStaleness.ts
@lib/hooks/useVisibility.ts
@lib/hooks/useOnlineStatus.ts
@lib/hooks/useBackgroundSync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract status utility functions and custom hooks</name>
  <files>
    app/components/devices/stove/stoveStatusUtils.ts
    app/components/devices/stove/hooks/useStoveData.ts
    app/components/devices/stove/hooks/useStoveCommands.ts
  </files>
  <action>
    Create directory structure: `app/components/devices/stove/hooks/` and `app/components/devices/stove/components/` (empty, for Plan 02-03).

    **1. stoveStatusUtils.ts** — Extract from StoveCard.tsx lines 593-886:
    - Export `getStatusInfo(status: string | null)` — returns the full status display object with colors, icon, animation flags. Copy the exact implementation from StoveCard.tsx (lines 594-750). Return type should be a `StoveStatusInfo` interface exported from this file.
    - Export `getStatusDisplay(status: string | null)` — returns CVA-aligned display props (variant, pulse, health, label). Copy exact implementation from lines 772-879. Return type: `StoveStatusDisplay` interface.
    - Export `getStatusGlow(variant: string)` — maps variant to glow shadow class. Copy from lines 756-766.
    - Export derived state helpers: `isStoveActive(status: string): boolean` (returns true if WORK or START), `isStoveOff(status: string): boolean` (returns true if OFF, ERROR, or WAIT).
    - All functions are PURE (no React hooks, no state) — just status string → display objects.

    **2. useStoveData.ts** — Extract all state + side effects from StoveCard.tsx:
    - Move ALL useState declarations from lines 59-88 into this hook.
    - Move ALL useRef declarations from lines 73, 88-94, 149.
    - Move data fetching functions: `fetchFanLevel` (lines 96-107), `fetchPowerLevel` (lines 109-120), `fetchSchedulerMode` (lines 122-138), `fetchMaintenanceStatus` (lines 140-147), `fetchStatusAndUpdate` (lines 151-231).
    - Move ALL useEffect hooks: adaptive polling (lines 241-294), Firebase connection monitoring (lines 297-318), Firebase real-time listener (lines 321-356), sandbox listeners (lines 358-414), background sync refresh (lines 234-238).
    - Import and call existing hooks internally: `useOnlineStatus`, `useBackgroundSync`, `useDeviceStaleness('stove')`, `useVisibility`, `useVersion` (from context).
    - Accept parameters: `checkVersion` function from VersionContext (passed by orchestrator since it comes from a context).
    - Accept parameters: `user` from Auth0 (passed by orchestrator since it comes from a context).
    - Return a flat object with ALL state values: `{ status, fanLevel, powerLevel, loading, refreshing, schedulerEnabled, semiManualMode, returnToAutoAt, nextScheduledAction, initialLoading, errorCode, errorDescription, maintenanceStatus, cleaningInProgress, sandboxMode, loadingMessage, isFirebaseConnected, usePollingFallback, isOnline, hasPendingCommands, pendingCommands, staleness, isVisible, isAccesa, isSpenta, needsMaintenance, statusInfo, statusDisplay, fetchStatusAndUpdate, setLoading, setLoadingMessage, setCleaningInProgress, setSchedulerEnabled, setSemiManualMode, setReturnToAutoAt, setNextScheduledAction, fetchMaintenanceStatus, fetchSchedulerMode }`.
    - CRITICAL: `alwaysActive: true` is NOT used here because StoveCard uses its own custom polling loop (lines 241-294), NOT useAdaptivePolling. Preserve the EXACT polling logic with the recursive setTimeout pattern, not useAdaptivePolling.
    - The hook must expose setters needed by useStoveCommands (setLoading, setLoadingMessage, etc.) since commands update UI state.

    **3. useStoveCommands.ts** — Extract all command handlers:
    - Accept parameter: an object with all setters and fetch functions from useStoveData return value (use Pick or a dedicated interface).
    - Accept parameter: `router` from useRouter (passed by orchestrator).
    - Accept parameter: `user` from Auth0 (for confirmCleaning).
    - Internally call `useRetryableCommand` 4 times (ignite, shutdown, setFan, setPower) — these hooks MUST be called at the top level of useStoveCommands (React hooks rules).
    - Move ALL command handlers: `handleIgnite` (494-510), `handleShutdown` (512-528), `handleFanChange` (422-451), `handlePowerChange` (453-482), `handleClearSemiManual` (530-538), `handleSetManualMode` (540-552), `handleSetAutomaticMode` (554-579), `handleConfirmCleaning` (581-591), `handleManualRefresh` (416-420).
    - Return object: `{ handleIgnite, handleShutdown, handleFanChange, handlePowerChange, handleClearSemiManual, handleSetManualMode, handleSetAutomaticMode, handleConfirmCleaning, handleManualRefresh, igniteCmd, shutdownCmd, setFanCmd, setPowerCmd }`.
    - The retryable command objects (igniteCmd, etc.) must be returned so the orchestrator can check `igniteCmd.isExecuting`, `igniteCmd.lastError`, etc.

    IMPORTANT: Do NOT modify StoveCard.tsx in this task. The hooks are created as standalone modules. StoveCard.tsx will be refactored to USE them in Plan 02/03.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (or only pre-existing errors)
    - All three files exist and export the documented interfaces
    - `grep -r "useAdaptivePolling" app/components/devices/stove/hooks/useStoveData.ts` returns NO matches (StoveCard uses custom polling, not useAdaptivePolling)
    - `grep -r "useRetryableCommand" app/components/devices/stove/hooks/useStoveCommands.ts` returns matches for 4 command types
  </verify>
  <done>
    useStoveData encapsulates all state/effects from StoveCard (polling, Firebase, staleness, sandbox). useStoveCommands encapsulates all command handlers with useRetryableCommand integration. stoveStatusUtils exports pure status mapping functions. No changes to StoveCard.tsx yet.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for extracted hooks and utilities</name>
  <files>
    __tests__/components/devices/stove/hooks/useStoveData.test.ts
    __tests__/components/devices/stove/hooks/useStoveCommands.test.ts
    __tests__/components/devices/stove/stoveStatusUtils.test.ts
  </files>
  <action>
    **1. stoveStatusUtils.test.ts** — Test pure utility functions:
    - Test `getStatusInfo` returns correct label/icon/colors for each status: WORK, OFF, START, STANDBY, WAIT, ERROR, ALARM, CLEAN, MODULATION, null, unknown string.
    - Test `getStatusDisplay` returns correct variant/pulse/health for same statuses.
    - Test `getStatusGlow` maps variants to expected shadow classes.
    - Test `isStoveActive` returns true for 'WORK PHASE 1' and 'STARTING UP', false for 'OFF' and 'ERROR'.
    - Test `isStoveOff` returns true for 'OFF', 'ERROR CODE 5', 'WAIT', false for 'WORK'.
    - These are pure function tests — no mocking needed, no renderHook.

    **2. useStoveData.test.ts** — Test hook behavior:
    - Mock all external dependencies: fetch (global), firebase/database (onValue, ref), @/lib/schedulerService, @/lib/maintenanceService, @/lib/sandboxService, @/lib/errorMonitor, @/lib/hooks/useOnlineStatus, @/lib/hooks/useBackgroundSync, @/lib/hooks/useDeviceStaleness, @/lib/hooks/useVisibility.
    - Use `renderHook` from @testing-library/react to test hook.
    - Test: hook returns initialLoading=true on first render.
    - Test: hook calls fetch(STOVE_ROUTES.status) on mount.
    - Test: hook sets status from API response StatusDescription field.
    - Test: hook returns isAccesa=true when status includes 'WORK'.
    - Test: hook returns isSpenta=true when status includes 'OFF'.
    - Test: Firebase onValue listener is registered for stove/state path.
    - Test: hook exposes fetchStatusAndUpdate function.

    **3. useStoveCommands.test.ts** — Test command handlers:
    - Mock useRetryableCommand to return { execute: jest.fn(), isExecuting: false, lastError: null, retry: jest.fn() }.
    - Mock @/lib/logService, @/lib/schedulerApiClient.
    - Test: handleIgnite calls igniteCmd.execute with STOVE_ROUTES.ignite.
    - Test: handleShutdown calls shutdownCmd.execute with STOVE_ROUTES.shutdown.
    - Test: handleFanChange calls setFanCmd.execute with correct level in body.
    - Test: handlePowerChange calls setPowerCmd.execute with correct level in body.
    - Test: handleSetManualMode calls fetch to /api/scheduler/update with enabled:false.
    - Test: handleSetAutomaticMode calls fetch to /api/scheduler/update with enabled:true.
    - Test: commands set loading state via provided setLoading callback.

    Run: `npx jest __tests__/components/devices/stove/ --no-coverage`
  </action>
  <verify>
    - `npx jest __tests__/components/devices/stove/ --no-coverage` — all tests pass
    - At least 7 tests for stoveStatusUtils (pure function coverage)
    - At least 7 tests for useStoveData (hook state/effects)
    - At least 7 tests for useStoveCommands (command handlers)
  </verify>
  <done>
    All extracted modules have unit tests covering core behaviors. Status utilities tested for all status variants. Hooks tested for initialization, data fetching, and command execution patterns.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (or only pre-existing errors)
2. `npx jest __tests__/components/devices/stove/ --no-coverage` — all tests green
3. Three new modules exist: stoveStatusUtils.ts, useStoveData.ts, useStoveCommands.ts
4. StoveCard.tsx is UNCHANGED (hooks ready but not wired in yet)
5. No new dependencies added (all imports from existing codebase)
</verification>

<success_criteria>
- Custom hooks and utilities extracted as standalone modules
- All tests passing
- Single polling loop logic preserved in useStoveData (custom setTimeout, NOT useAdaptivePolling)
- useRetryableCommand called 4x at top level of useStoveCommands
- StoveCard.tsx untouched — ready for Plan 02 to wire everything together
</success_criteria>

<output>
After completion, create `.planning/phases/58-stovecard-refactoring/58-01-SUMMARY.md`
</output>
