---
phase: 58-stovecard-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["58-01"]
files_modified:
  - app/components/devices/stove/components/StoveStatus.tsx
  - app/components/devices/stove/components/StovePrimaryActions.tsx
  - app/components/devices/stove/components/StoveBanners.tsx
  - app/components/devices/stove/StoveCard.tsx
  - __tests__/components/devices/stove/components/StoveStatus.test.tsx
  - __tests__/components/devices/stove/components/StovePrimaryActions.test.tsx
  - __tests__/components/devices/stove/components/StoveBanners.test.tsx
autonomous: true

must_haves:
  truths:
    - "StoveCard.tsx imports and calls useStoveData and useStoveCommands hooks instead of inline state/effects"
    - "StoveStatus renders the main status display box with icon, labels, fan/power info boxes, and staleness indicator"
    - "StovePrimaryActions renders ignite/shutdown buttons based on stove state and online status"
    - "StoveBanners renders error alert, maintenance banner, Firebase disconnection banner, pending commands banner, and retry error banner"
    - "All sub-components are purely presentational (props in, UI out, no useState/useEffect)"
  artifacts:
    - path: "app/components/devices/stove/components/StoveStatus.tsx"
      provides: "Status display box with icon, badges, info boxes, staleness"
      exports: ["default"]
    - path: "app/components/devices/stove/components/StovePrimaryActions.tsx"
      provides: "Ignite/shutdown action buttons"
      exports: ["default"]
    - path: "app/components/devices/stove/components/StoveBanners.tsx"
      provides: "Error, maintenance, Firebase, pending, retry banners"
      exports: ["default"]
    - path: "app/components/devices/stove/StoveCard.tsx"
      provides: "Orchestrator using hooks and sub-components"
      exports: ["default"]
  key_links:
    - from: "app/components/devices/stove/StoveCard.tsx"
      to: "app/components/devices/stove/hooks/useStoveData.ts"
      via: "hook import"
      pattern: "useStoveData\\("
    - from: "app/components/devices/stove/StoveCard.tsx"
      to: "app/components/devices/stove/hooks/useStoveCommands.ts"
      via: "hook import"
      pattern: "useStoveCommands\\("
    - from: "app/components/devices/stove/components/StoveStatus.tsx"
      to: "app/components/devices/stove/stoveStatusUtils.ts"
      via: "utility import"
      pattern: "getStatusInfo|getStatusDisplay"
---

<objective>
Extract StoveStatus, StovePrimaryActions, and StoveBanners as presentational sub-components, and refactor StoveCard.tsx to use the custom hooks from Plan 01.

Purpose: This is the main refactoring step â€” StoveCard.tsx goes from 1458 LOC monolith to an orchestrator that delegates rendering to sub-components. Three of six sub-components are extracted here (the visually largest sections).

Output: 3 presentational sub-components + partially refactored StoveCard orchestrator.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/58-stovecard-refactoring/58-RESEARCH.md
@.planning/phases/58-stovecard-refactoring/58-01-SUMMARY.md
@app/components/devices/stove/StoveCard.tsx
@app/components/devices/stove/hooks/useStoveData.ts
@app/components/devices/stove/hooks/useStoveCommands.ts
@app/components/devices/stove/stoveStatusUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StoveStatus, StovePrimaryActions, and StoveBanners presentational components</name>
  <files>
    app/components/devices/stove/components/StoveStatus.tsx
    app/components/devices/stove/components/StovePrimaryActions.tsx
    app/components/devices/stove/components/StoveBanners.tsx
  </files>
  <action>
    **1. StoveStatus.tsx** (~200 LOC) â€” Extract from StoveCard.tsx lines 1006-1118 (status display box):
    - Define `StoveStatusProps` interface:
      ```typescript
      interface StoveStatusProps {
        status: string;
        fanLevel: number | null;
        powerLevel: number | null;
        errorCode: number;
        sandboxMode: boolean;
        staleness: { isStale: boolean; cachedAt: string | null } | null;
        isVisible: boolean;
        statusInfo: ReturnType<typeof getStatusInfo>;  // from stoveStatusUtils
        statusDisplay: ReturnType<typeof getStatusDisplay>;
      }
      ```
    - 'use client' directive at top.
    - Import UI components: Badge, Heading, Text from '../../ui'.
    - Import formatDistanceToNow from 'date-fns' and { it } from 'date-fns/locale'.
    - Copy EXACT JSX from StoveCard.tsx lines 1006-1118 (the `<div className="mb-6 relative">` block containing sandbox badge, error badge, staleness badge, status display box with icon and info boxes, staleness indicator).
    - NO useState, NO useEffect â€” purely presentational.
    - Export as default function StoveStatus.

    **2. StovePrimaryActions.tsx** (~100 LOC) â€” Extract from StoveCard.tsx lines 1120-1185:
    - Define `StovePrimaryActionsProps` interface:
      ```typescript
      interface StovePrimaryActionsProps {
        isAccesa: boolean;
        isSpenta: boolean;
        isOnline: boolean;
        needsMaintenance: boolean;
        loading: boolean;
        igniteCmd: { isExecuting: boolean };
        shutdownCmd: { isExecuting: boolean };
        onIgnite: () => void;
        onShutdown: () => void;
      }
      ```
    - 'use client' directive.
    - Import Button from '../../ui/Button' and Text from '../../ui'.
    - Copy EXACT JSX from lines 1120-1185 (the primary action buttons: transitional state dual buttons, OFF=ACCENDI, ON=SPEGNI, offline fallback text).
    - Replace `handleIgnite` with `onIgnite` prop, `handleShutdown` with `onShutdown` prop.
    - NO useState, NO useEffect.
    - Export as default.

    **3. StoveBanners.tsx** (~120 LOC) â€” Extract banners from StoveCard.tsx:
    - Combine ALL banner sections into one component. Extract from lines 901-909 (ErrorAlert), 924-957 (maintenance banner), 960-969 (Firebase banner), 972-981 (pending commands banner), 1300-1323 (retry error banner).
    - Define `StoveBannersProps` interface:
      ```typescript
      interface StoveBannersProps {
        errorCode: number;
        errorDescription: string;
        needsMaintenance: boolean;
        maintenanceStatus: any;
        cleaningInProgress: boolean;
        isFirebaseConnected: boolean;
        hasPendingCommands: boolean;
        pendingCommands: any[];
        igniteCmd: { lastError: Error | null; retry: () => void };
        shutdownCmd: { lastError: Error | null; retry: () => void };
        setFanCmd: { lastError: Error | null; retry: () => void };
        setPowerCmd: { lastError: Error | null; retry: () => void };
        onConfirmCleaning: () => void;
        onNavigateToMaintenance: () => void;
      }
      ```
    - 'use client' directive.
    - Import ErrorAlert, Banner, Button, Text from appropriate UI paths.
    - Copy EXACT JSX for each banner section. Replace handler references with props.
    - The retry error banner (lines 1300-1323) renders only when any command has lastError.
    - NO useState, NO useEffect.
    - Export as default.

    CRITICAL: Preserve every Tailwind class, every spacing, every conditional exactly as in the original. These are JSX extractions, not redesigns.
  </action>
  <verify>
    - `npx tsc --noEmit` passes for all three new component files
    - Each component has 'use client' directive
    - `grep -r "useState\|useEffect" app/components/devices/stove/components/` returns NO matches (presentational only)
    - All three files exist with correct exports
  </verify>
  <done>
    Three presentational sub-components created with exact JSX from StoveCard. All are purely presentational (no state/effects). Props interfaces defined for type safety.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor StoveCard.tsx to use hooks and sub-components, add tests</name>
  <files>
    app/components/devices/stove/StoveCard.tsx
    __tests__/components/devices/stove/components/StoveStatus.test.tsx
    __tests__/components/devices/stove/components/StovePrimaryActions.test.tsx
    __tests__/components/devices/stove/components/StoveBanners.test.tsx
  </files>
  <action>
    **1. Refactor StoveCard.tsx** â€” Replace inline code with hook calls and sub-component rendering:

    - Remove ALL useState, useRef declarations (now in useStoveData).
    - Remove ALL data fetching functions (fetchFanLevel, fetchPowerLevel, etc. â€” now in useStoveData).
    - Remove ALL useEffect hooks (now in useStoveData).
    - Remove ALL command handlers (now in useStoveCommands).
    - Remove getStatusInfo, getStatusDisplay, getStatusGlow functions (now in stoveStatusUtils).
    - Remove derived state calculations (isAccesa, isSpenta, needsMaintenance â€” now returned by useStoveData).
    - Remove fanOptions, powerOptions arrays (move to StoveAdjustments in Plan 03 since only used there).

    - Add imports for useStoveData, useStoveCommands, stoveStatusUtils, and all three sub-components.
    - Import useRouter, useVersion, useUser at orchestrator level (they provide values to hooks).
    - Import ErrorBoundary from react-error-boundary + DeviceCardErrorBoundary from ErrorBoundary components.

    - Call hooks at top:
      ```typescript
      const router = useRouter();
      const { checkVersion } = useVersion();
      const { user } = useUser();
      const stoveData = useStoveData({ checkVersion, user });
      const commands = useStoveCommands({
        ...stoveData,  // spread all state + setters
        router,
        user,
      });
      ```

    - Render structure (preserving EXACT layout):
      ```
      if (stoveData.initialLoading) return <Skeleton.StovePanel />;
      return (
        <div className="space-y-4 sm:space-y-6">
          <LoadingOverlay show={stoveData.loading} message={stoveData.loadingMessage} icon="ðŸ”¥" />
          <StoveBanners {...bannerProps} />
          <Card variant="elevated" padding={false} className="overflow-visible transition-all duration-500">
            <div className="relative">
              <CardAccentBar colorTheme="ember" animated pulse={stoveData.isAccesa} size="md" />
              <div className="p-6 sm:p-8">
                {/* Inline maintenance/Firebase/pending banners that are INSIDE the card */}
                <StoveStatus {...statusProps} />
                <StovePrimaryActions {...actionProps} />
                {/* Mode control section â€” left inline for Plan 03 */}
                {stoveData.isOnline && ( <> ... mode control JSX stays inline for now ... </> )}
                {/* Retry banner stays inline for now (Plan 03 moves to StoveBanners or keeps inline) */}
                {/* Maintenance bar stays inline for now */}
                {/* Adjustments stay inline for now */}
              </div>
            </div>
          </Card>
        </div>
      );
      ```

    - IMPORTANT: The banners that appear OUTSIDE the Card (ErrorAlert at line 902) and the banners INSIDE the Card (maintenance, Firebase, pending at lines 924-981) have different visual placement. StoveBanners should be split into two render sections OR accept a `placement` prop. Looking at the JSX:
      - ErrorAlert is OUTSIDE the card (before `<Card>`)
      - Maintenance, Firebase, Pending banners are INSIDE the card's `<div className="p-6">` section
      - Retry error banner is also inside the card
      - Solution: Keep ErrorAlert as a direct render in orchestrator (it's just one line), and have StoveBanners handle only the inside-card banners. This avoids prop complexity.

    - Preserve the mode control, maintenance bar, adjustments, and cron health sections as INLINE JSX in StoveCard for now. Plan 03 will extract those. This keeps StoveCard at roughly 400-500 LOC after this plan (still significantly reduced from 1458).

    **2. Tests for sub-components:**

    - **StoveStatus.test.tsx**: Test renders status label, icon, fan/power info boxes, sandbox badge when sandboxMode=true, error badge when errorCode>0, staleness badge when isVisible+isStale.
    - **StovePrimaryActions.test.tsx**: Test shows ACCENDI when isSpenta=true, shows SPEGNI when isAccesa=true, shows both buttons in transitional state, shows offline message when isOnline=false, disables ACCENDI when needsMaintenance=true.
    - **StoveBanners.test.tsx**: Test renders maintenance banner when needsMaintenance=true, renders Firebase banner when isFirebaseConnected=false, renders pending banner when hasPendingCommands=true, renders retry banner when any command has lastError.

    Run: `npx jest __tests__/components/devices/stove/ --no-coverage`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx jest __tests__/components/devices/stove/ --no-coverage` â€” all tests pass (both Plan 01 and Plan 02 tests)
    - StoveCard.tsx now imports useStoveData and useStoveCommands at top
    - StoveCard.tsx no longer contains getStatusInfo or getStatusDisplay functions
    - StoveCard.tsx no longer contains fetchFanLevel, fetchPowerLevel, fetchSchedulerMode, fetchMaintenanceStatus functions
    - Sub-components render correctly with prop drilling from orchestrator
  </verify>
  <done>
    StoveCard.tsx refactored to use custom hooks. Three sub-components (StoveStatus, StovePrimaryActions, StoveBanners) render via props. Remaining sections (mode control, adjustments, maintenance bar) still inline â€” extracted in Plan 03. StoveCard reduced from 1458 to ~400-500 LOC.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx jest __tests__/components/devices/stove/ --no-coverage` â€” all tests green
3. StoveCard.tsx uses useStoveData and useStoveCommands hooks
4. Three presentational components exist with correct props interfaces
5. No useState/useEffect in sub-components (grep confirms)
6. ErrorAlert renders outside Card, other banners render inside Card (visual placement preserved)
</verification>

<success_criteria>
- StoveCard.tsx reduced to ~400-500 LOC (from 1458, further reduction in Plan 03)
- 3 presentational sub-components created with exact visual output
- Hooks wired in as single source of truth
- All existing tests still pass + new component tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/58-stovecard-refactoring/58-02-SUMMARY.md`
</output>
