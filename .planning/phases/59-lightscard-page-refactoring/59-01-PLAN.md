---
phase: 59-lightscard-page-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/components/devices/lights/hooks/useLightsData.ts
  - app/components/devices/lights/hooks/useLightsCommands.ts
  - __tests__/components/devices/lights/hooks/useLightsData.test.ts
  - __tests__/components/devices/lights/hooks/useLightsCommands.test.ts
autonomous: true

must_haves:
  truths:
    - "useLightsData hook encapsulates all 18 state variables, 2 refs, data fetching, polling, and derived state from LightsCard"
    - "useLightsCommands hook encapsulates all command handlers (room toggle, brightness, scene, all lights, pairing) with useRetryableCommand"
    - "Single polling loop guarantee: only useLightsData calls useAdaptivePolling"
    - "Both hooks have typed interfaces (params + return) following Phase 58 UseStoveDataReturn pattern"
  artifacts:
    - path: "app/components/devices/lights/hooks/useLightsData.ts"
      provides: "All LightsCard state management, polling, data fetching, derived state"
      exports: ["useLightsData", "UseLightsDataParams", "UseLightsDataReturn"]
    - path: "app/components/devices/lights/hooks/useLightsCommands.ts"
      provides: "All LightsCard command handlers with retry infrastructure"
      exports: ["useLightsCommands", "UseLightsCommandsParams", "UseLightsCommandsReturn"]
    - path: "__tests__/components/devices/lights/hooks/useLightsData.test.ts"
      provides: "Unit tests for useLightsData hook"
    - path: "__tests__/components/devices/lights/hooks/useLightsCommands.test.ts"
      provides: "Unit tests for useLightsCommands hook"
  key_links:
    - from: "app/components/devices/lights/hooks/useLightsData.ts"
      to: "@/lib/hooks/useAdaptivePolling"
      via: "useAdaptivePolling call with 30s interval"
      pattern: "useAdaptivePolling"
    - from: "app/components/devices/lights/hooks/useLightsCommands.ts"
      to: "@/lib/hooks/useRetryableCommand"
      via: "useRetryableCommand for hueRoomCmd and hueSceneCmd"
      pattern: "useRetryableCommand"
---

<objective>
Extract custom hooks from LightsCard.tsx following the Phase 58 orchestrator pattern.

Purpose: Create useLightsData (state + polling + data fetching) and useLightsCommands (command handlers + retry) as the foundation for the LightsCard refactoring. These hooks encapsulate all non-UI logic, enabling subsequent extraction of presentational sub-components.

Output: Two custom hooks with TypeScript interfaces and unit tests, ready for LightsCard orchestrator and sub-components to consume.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@app/components/devices/lights/LightsCard.tsx
@app/components/devices/stove/hooks/useStoveData.ts
@app/components/devices/stove/hooks/useStoveCommands.ts
@__tests__/components/devices/stove/hooks/useStoveData.test.ts
@__tests__/components/devices/stove/hooks/useStoveCommands.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useLightsData hook</name>
  <files>
    app/components/devices/lights/hooks/useLightsData.ts
    __tests__/components/devices/lights/hooks/useLightsData.test.ts
  </files>
  <action>
Create `app/components/devices/lights/hooks/useLightsData.ts` following the Phase 58 `useStoveData.ts` pattern.

**Interface design (follow UseStoveDataReturn pattern):**

```typescript
export interface UseLightsDataReturn {
  // Core state
  loading: boolean;
  error: string | null;
  connected: boolean;
  connectionMode: 'local' | 'remote' | 'hybrid' | 'disconnected' | null;
  remoteConnected: boolean;
  rooms: any[];
  lights: any[];
  scenes: any[];
  selectedRoomId: string | null;
  refreshing: boolean;
  loadingMessage: string;
  localBrightness: number | null;

  // Pairing state
  pairing: boolean;
  pairingStep: 'discovering' | 'waitingForButtonPress' | 'pairing' | 'success' | 'noLocalBridge' | 'selectBridge' | null;
  discoveredBridges: any[];
  selectedBridge: any;
  pairingCountdown: number;
  pairingError: string | null;

  // Derived state (computed from rooms/lights/scenes)
  selectedRoom: any;
  selectedRoomGroupedLightId: string | null;
  roomLights: any[];
  roomScenes: any[];
  effectiveLights: any[];
  hasColorLights: boolean;
  lightsOnCount: number;
  lightsOffCount: number;
  allLightsOn: boolean;
  allLightsOff: boolean;
  isRoomOn: boolean;
  totalLightsOn: number;
  totalLightsOff: number;
  allHouseLightsOn: boolean;
  allHouseLightsOff: boolean;
  hasAnyLights: boolean;
  avgBrightness: number;

  // Dynamic styling state
  roomColors: string[];
  roomOnBrightness: number;
  dynamicRoomStyle: Record<string, string> | null;
  contrastMode: 'light' | 'dark' | 'default';
  adaptive: AdaptiveClasses;

  // Actions
  setSelectedRoomId: (id: string | null) => void;
  setLocalBrightness: (val: number | null) => void;
  setError: (err: string | null) => void;
  setPairingError: (err: string | null) => void;
  setRefreshing: (val: boolean) => void;
  setLoadingMessage: (msg: string) => void;
  checkConnection: () => Promise<void>;
  fetchData: () => Promise<void>;
  handleRefresh: () => Promise<void>;

  // Pairing state setters (needed by commands hook)
  setPairing: (val: boolean) => void;
  setPairingStep: (step: UseLightsDataReturn['pairingStep']) => void;
  setDiscoveredBridges: (bridges: any[]) => void;
  setSelectedBridge: (bridge: any) => void;
  setPairingCountdown: (val: number) => void;
  pairingTimerRef: React.MutableRefObject<NodeJS.Timeout | null>;
}
```

**Extract from LightsCard.tsx lines 18-856:**
1. All 18 useState declarations (lines 20-43)
2. Both useRef declarations (lines 45-46)
3. useRetryableCommand hooks are NOT in this hook (they go in useLightsCommands) — BUT the hook should NOT call useRetryableCommand. Retry infrastructure belongs in commands hook.
4. useEffect for connection check on mount (lines 53-57)
5. useAdaptivePolling call with 30s interval (lines 60-65) — this is the SINGLE polling loop guarantee
6. useEffect for auto-select first room (lines 68-72)
7. All derived state computations:
   - selectedRoom (line 74)
   - getGroupedLightId helper function (lines 77-81)
   - selectedRoomGroupedLightId (line 83)
   - roomLights filtering (lines 88-93)
   - roomScenes filtering (lines 94-96)
   - hasColorLights (line 99)
   - serviceLights (lines 103-105)
   - effectiveLights (line 108)
   - lightsOnCount/lightsOffCount/allLightsOn/allLightsOff (lines 111-114)
   - totalLightsOn/totalLightsOff/allHouseLightsOn/allHouseLightsOff/hasAnyLights (lines 693-697)
   - avgBrightness (lines 699-701)
8. checkConnection function (lines 116-143)
9. fetchData function (lines 145-189)
10. handleRefresh function (lines 191-196)
11. Dynamic styling computations:
    - getLuminance (lines 704-708)
    - getContrastMode (lines 710-722)
    - getRoomLightColors (lines 725-746)
    - getRoomControlStyle (lines 751-784)
    - dynamicRoomStyle, contrastMode, adaptiveClasses definitions (lines 786-856)
12. Cleanup timer useEffect (lines 513-519)

**IMPORTANT patterns:**
- useAdaptivePolling receives `fetchData` as callback — fetchData must be defined BEFORE useAdaptivePolling call
- The polling interval is `connected ? 30000 : null` (only poll when connected)
- `alwaysActive: false` — non-critical, pause when tab hidden
- `immediate: true` — fetch immediately on mount
- Pairing timer cleanup on unmount

**DO NOT include:**
- Command handlers (handleRoomToggle, handleBrightnessChange, etc.) — those go in useLightsCommands
- JSX rendering — that goes in sub-components
- useRetryableCommand calls — those go in useLightsCommands

**Create tests** in `__tests__/components/devices/lights/hooks/useLightsData.test.ts`:
- Follow `__tests__/components/devices/stove/hooks/useStoveData.test.ts` pattern
- Test initial state values
- Test checkConnection success/failure paths
- Test fetchData success/error/reconnect paths
- Test derived state computation (allLightsOn, roomLights filtering, etc.)
- Test auto-select first room
- Test useAdaptivePolling is called with correct params
- Mock: fetch, useAdaptivePolling, useRetryableCommand (if imported)
  </action>
  <verify>
- `npx tsc --noEmit app/components/devices/lights/hooks/useLightsData.ts` passes
- Test file runs: `npx jest __tests__/components/devices/lights/hooks/useLightsData.test.ts --no-cache`
- Hook exports: UseLightsDataReturn interface, useLightsData function
- grep confirms single useAdaptivePolling call in the hook file
  </verify>
  <done>
useLightsData hook encapsulates all 18 state variables, polling via useAdaptivePolling, connection checking, data fetching, derived state, and dynamic styling from LightsCard. TypeScript interfaces match Phase 58 pattern. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useLightsCommands hook</name>
  <files>
    app/components/devices/lights/hooks/useLightsCommands.ts
    __tests__/components/devices/lights/hooks/useLightsCommands.test.ts
  </files>
  <action>
Create `app/components/devices/lights/hooks/useLightsCommands.ts` following the Phase 58 `useStoveCommands.ts` pattern.

**Interface design:**

```typescript
export interface UseLightsCommandsParams {
  lightsData: {
    setRefreshing: (val: boolean) => void;
    setLoadingMessage: (msg: string) => void;
    setError: (err: string | null) => void;
    fetchData: () => Promise<void>;
    rooms: any[];
    // Pairing state setters
    setPairing: (val: boolean) => void;
    setPairingStep: (step: any) => void;
    setDiscoveredBridges: (bridges: any[]) => void;
    setSelectedBridge: (bridge: any) => void;
    setPairingCountdown: (val: number) => void;
    setPairingError: (err: string | null) => void;
    pairingTimerRef: React.MutableRefObject<NodeJS.Timeout | null>;
    selectedBridge: any;
    checkConnection: () => Promise<void>;
    connected: boolean;
  };
  router: ReturnType<typeof useRouter>;
}

export interface UseLightsCommandsReturn {
  // Room commands
  handleRoomToggle: (roomId: string | null | undefined, on: boolean) => Promise<void>;
  handleBrightnessChange: (roomId: string | null | undefined, brightness: string) => Promise<void>;
  handleSceneActivate: (sceneId: string) => Promise<void>;
  handleAllLightsToggle: (on: boolean) => Promise<void>;

  // Remote/Pairing commands
  handleRemoteAuth: () => void;
  handleDisconnectRemote: () => Promise<void>;
  handleStartPairing: () => Promise<void>;
  handlePairWithBridge: (bridge: any) => Promise<void>;
  handleConfirmButtonPressed: () => void;
  handleSelectBridge: (bridge: any) => void;
  handleRetryPairing: () => void;
  handleCancelPairing: () => void;

  // Retry command objects (for error banners)
  hueRoomCmd: ReturnType<typeof useRetryableCommand>;
  hueSceneCmd: ReturnType<typeof useRetryableCommand>;
}
```

**Extract from LightsCard.tsx:**
1. useRetryableCommand calls (lines 49-50): `hueRoomCmd` and `hueSceneCmd`
2. handleRoomToggle (lines 198-221)
3. handleBrightnessChange (lines 223-248)
4. handleSceneActivate (lines 250-271)
5. handleAllLightsToggle (lines 276-306)
6. handleRemoteAuth (lines 312-317)
7. handleDisconnectRemote (lines 322-346)
8. handleStartPairing (lines 352-404)
9. handlePairWithBridge (lines 409-466)
10. handleConfirmButtonPressed (lines 471-475)
11. handleSelectBridge (lines 480-483)
12. handleRetryPairing (lines 488-496)
13. handleCancelPairing (lines 501-510)

**Pattern from Phase 58 useStoveCommands:**
- Hook receives `lightsData` object with only the setters/functions it needs (not the entire hook return)
- Command handlers access lightsData setters via params (e.g., `lightsData.setRefreshing(true)`)
- useRetryableCommand hooks MUST be called at top level of this hook (React hooks rules — one per command type)
- All command handlers use hueRoomCmd.execute or hueSceneCmd.execute for retry
- Pairing handlers don't use retry (discovery/pair are one-shot operations with manual retry)

**IMPORTANT:**
- handleAllLightsToggle needs access to `lightsData.rooms` to get all grouped_light IDs
- handlePairWithBridge uses `lightsData.pairingTimerRef` for countdown timer setInterval
- handleCancelPairing clears `lightsData.pairingTimerRef`
- handleConfirmButtonPressed calls handlePairWithBridge with `lightsData.selectedBridge`

**Create tests** in `__tests__/components/devices/lights/hooks/useLightsCommands.test.ts`:
- Follow `__tests__/components/devices/stove/hooks/useStoveCommands.test.ts` pattern
- Test handleRoomToggle calls hueRoomCmd.execute with correct URL/body
- Test handleBrightnessChange calls hueRoomCmd.execute with dimming body
- Test handleSceneActivate calls hueSceneCmd.execute with activate URL
- Test handleAllLightsToggle calls hueRoomCmd.execute for all rooms
- Test handleStartPairing fetches /api/hue/discover and sets step state
- Test handleCancelPairing clears all pairing state
- Test handleRemoteAuth redirects to /api/hue/remote/authorize
- Mock: fetch, useRetryableCommand, window.location
  </action>
  <verify>
- `npx tsc --noEmit app/components/devices/lights/hooks/useLightsCommands.ts` passes
- Test file runs: `npx jest __tests__/components/devices/lights/hooks/useLightsCommands.test.ts --no-cache`
- Hook exports: UseLightsCommandsReturn interface, useLightsCommands function
- grep confirms useRetryableCommand is called in this file (not in useLightsData)
  </verify>
  <done>
useLightsCommands hook encapsulates all 13 command/pairing handlers with useRetryableCommand integration for room/scene commands. TypeScript interfaces follow Phase 58 pattern. Tests pass.
  </done>
</task>

</tasks>

<verification>
1. Both hook files compile: `npx tsc --noEmit app/components/devices/lights/hooks/useLightsData.ts app/components/devices/lights/hooks/useLightsCommands.ts`
2. All tests pass: `npx jest __tests__/components/devices/lights/hooks/ --no-cache`
3. Single polling guarantee: `grep -c "useAdaptivePolling" app/components/devices/lights/hooks/useLightsData.ts` returns 1
4. useRetryableCommand only in commands hook: `grep -c "useRetryableCommand" app/components/devices/lights/hooks/useLightsCommands.ts` returns 2 (hueRoomCmd + hueSceneCmd)
5. LightsCard.tsx is NOT modified yet (hooks are created alongside, orchestrator refactoring happens in Plan 03)
</verification>

<success_criteria>
- useLightsData hook exists with all 18 state variables, polling, connection check, data fetching, derived state, and dynamic styling
- useLightsCommands hook exists with all 13 command handlers and useRetryableCommand for room/scene commands
- Both hooks have TypeScript interfaces (params + return types)
- Tests pass for both hooks
- No changes to existing LightsCard.tsx (backward compatible — hooks exist alongside)
</success_criteria>

<output>
After completion, create `.planning/phases/59-lightscard-page-refactoring/59-01-SUMMARY.md`
</output>
