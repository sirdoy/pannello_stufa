---
phase: 59-lightscard-page-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["59-01"]
files_modified:
  - app/components/devices/lights/components/LightsBanners.tsx
  - app/components/devices/lights/components/LightsHouseControl.tsx
  - app/components/devices/lights/components/LightsRoomControl.tsx
  - app/components/devices/lights/components/LightsScenes.tsx
  - app/components/devices/lights/components/PairingWizard.tsx
  - __tests__/components/devices/lights/components/LightsBanners.test.tsx
  - __tests__/components/devices/lights/components/LightsRoomControl.test.tsx
  - __tests__/components/devices/lights/components/LightsScenes.test.tsx
  - __tests__/components/devices/lights/components/PairingWizard.test.tsx
autonomous: true

must_haves:
  truths:
    - "LightsBanners renders error, pairing status, connection mode, and retry error banners based on props"
    - "LightsHouseControl renders whole-house on/off controls with mixed/all-on/all-off states"
    - "LightsRoomControl renders room on/off buttons, brightness slider with commit-on-release, and color link"
    - "LightsScenes renders horizontal-scroll scene grid with activation buttons"
    - "PairingWizard renders 5-step pairing flow: discovering, waitingForButtonPress, pairing, success, selectBridge, noLocalBridge"
    - "All sub-components are purely presentational (no useState for business state, no useEffect, no fetch calls)"
  artifacts:
    - path: "app/components/devices/lights/components/LightsBanners.tsx"
      provides: "Error banners, pairing banners, connection error banner"
    - path: "app/components/devices/lights/components/LightsHouseControl.tsx"
      provides: "Whole-house light toggle (mixed/all-on/all-off states)"
    - path: "app/components/devices/lights/components/LightsRoomControl.tsx"
      provides: "Room on/off, brightness slider, +/- buttons, color link"
    - path: "app/components/devices/lights/components/LightsScenes.tsx"
      provides: "Horizontal-scroll scene grid"
    - path: "app/components/devices/lights/components/PairingWizard.tsx"
      provides: "Multi-step pairing wizard (5 states)"
  key_links:
    - from: "app/components/devices/lights/components/LightsRoomControl.tsx"
      to: "useLightsData localBrightness"
      via: "props: localBrightness, setLocalBrightness, onBrightnessChange"
      pattern: "onValueCommit.*handleBrightnessChange"
    - from: "app/components/devices/lights/components/PairingWizard.tsx"
      to: "useLightsCommands pairing handlers"
      via: "props: onConfirmButtonPressed, onSelectBridge, onCancelPairing, onRemoteAuth"
      pattern: "onClick.*onConfirmButtonPressed"
---

<objective>
Extract 5 presentational sub-components from LightsCard.tsx JSX following Phase 58 pattern.

Purpose: Split the 1225 LOC LightsCard into focused, testable sub-components that receive all data via props. Each sub-component handles one visual concern. This is the middle step: hooks exist from Plan 01, orchestrator wiring happens in Plan 03.

Output: 5 presentational sub-components with TypeScript props interfaces and tests, covering all LightsCard JSX sections.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-lightscard-page-refactoring/59-01-SUMMARY.md
@app/components/devices/lights/LightsCard.tsx
@app/components/devices/stove/components/StoveBanners.tsx
@app/components/devices/stove/components/StovePrimaryActions.tsx
@app/components/devices/stove/components/StoveAdjustments.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LightsBanners, LightsHouseControl, and PairingWizard components</name>
  <files>
    app/components/devices/lights/components/LightsBanners.tsx
    app/components/devices/lights/components/LightsHouseControl.tsx
    app/components/devices/lights/components/PairingWizard.tsx
    __tests__/components/devices/lights/components/LightsBanners.test.tsx
    __tests__/components/devices/lights/components/PairingWizard.test.tsx
  </files>
  <action>
Create three presentational sub-components. ALL receive data via props — NO business state, NO useEffect, NO fetch.

**1. LightsBanners.tsx (~100 LOC)**

Extract banner construction logic from LightsCard.tsx lines 522-659. This component builds the `banners` array that DeviceCard consumes.

Props interface:
```typescript
interface LightsBannersProps {
  // Retry infrastructure errors
  hueRoomCmd: { lastError: Error | null; retry: () => void };
  hueSceneCmd: { lastError: Error | null; retry: () => void };
  // Pairing state
  pairing: boolean;
  pairingStep: string | null;
  pairingCountdown: number;
  pairingError: string | null;
  discoveredBridges: any[];
  selectedBridge: any;
  // Connection error
  error: string | null;
  // Callbacks
  onRemoteAuth: () => void;
  onCancelPairing: () => void;
  onConfirmButtonPressed: () => void;
  onSelectBridge: (bridge: any) => void;
  onRetryPairing: () => void;
  onDismissError: () => void;
  onDismissPairingError: () => void;
}
```

The component returns `banners` array (same format DeviceCard expects). Export a function `buildLightsBanners(props): BannerConfig[]` that the orchestrator can call to build the array, OR return it as a property. Alternatively, render Banner components directly if DeviceCard accepts children. Check how StoveBanners.tsx works — follow that pattern.

**IMPORTANT:** LightsCard passes `banners` as prop to DeviceCard. So LightsBanners should be a function that builds the banner array (not a component that renders JSX). Follow the pattern from StoveBanners if it builds banner data, or convert to component if StoveBanners renders JSX directly.

Actually, looking at LightsCard, the `banners` array is passed as a prop to `<DeviceCard banners={banners}>`. So this "component" is really a utility function that builds the banner config array. Name it `buildLightsBanners` and export as a function.

**2. LightsHouseControl.tsx (~80 LOC)**

Extract whole-house control from LightsCard.tsx lines 877-942.

Props interface:
```typescript
interface LightsHouseControlProps {
  hasAnyLights: boolean;
  totalLightsOn: number;
  totalLights: number;
  allHouseLightsOn: boolean;
  allHouseLightsOff: boolean;
  refreshing: boolean;
  onAllLightsToggle: (on: boolean) => void;
}
```

Renders the "Tutta la Casa" section with:
- Mixed state: show both "Tutte" and "Spegni" buttons
- All off: show "Accendi Tutte" ember button
- All on: show "Spegni Tutte" subtle button
- Counter: `{totalLightsOn}/{totalLights} accese`

**3. PairingWizard.tsx (~50 LOC)**

This is a thin component because the pairing flow is handled via banners (DeviceCard banner system), not inline JSX. The pairing wizard state (discovering, waitingForButtonPress, etc.) is already rendered as banners in LightsBanners. So PairingWizard is NOT needed as a separate component.

**REVISION:** Looking at LightsCard more carefully, pairing is rendered entirely via the `banners` array (lines 522-659). There is NO separate pairing wizard JSX section. So PairingWizard.tsx is NOT needed. The banner system handles all pairing UI.

Instead, create a **real** PairingWizard.tsx that the `buildLightsBanners` utility calls or that wraps the pairing banner configurations. Actually, the simplest approach: `buildLightsBanners` already handles all pairing-related banners. No separate PairingWizard component needed.

**Replace PairingWizard with** building the banners utility. The banners are the pairing wizard.

**Tests:**
- LightsBanners: Test that `buildLightsBanners` returns correct banner configs for each state (retry error, discovering, waitingForButtonPress, pairing, success, noLocalBridge, selectBridge, connection error, pairing error)
- LightsHouseControl: Test render for mixed/all-on/all-off states, button click handlers
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit app/components/devices/lights/components/LightsBanners.tsx app/components/devices/lights/components/LightsHouseControl.tsx`
- Tests pass: `npx jest __tests__/components/devices/lights/components/ --no-cache`
  </verify>
  <done>
LightsBanners utility builds banner config array for all error/pairing states. LightsHouseControl renders whole-house on/off controls. Both follow presentational pattern (props only, no business state). Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LightsRoomControl and LightsScenes components</name>
  <files>
    app/components/devices/lights/components/LightsRoomControl.tsx
    app/components/devices/lights/components/LightsScenes.tsx
    __tests__/components/devices/lights/components/LightsRoomControl.test.tsx
    __tests__/components/devices/lights/components/LightsScenes.test.tsx
  </files>
  <action>
Create two presentational sub-components for the main room control area and scenes section.

**1. LightsRoomControl.tsx (~250 LOC)**

Extract from LightsCard.tsx lines 955-1177. This is the largest sub-component because it contains the dynamic color-styled room control area.

Props interface:
```typescript
interface LightsRoomControlProps {
  // Room state
  selectedRoom: any;
  selectedRoomGroupedLightId: string | null;
  roomLights: any[];
  isRoomOn: boolean;
  // Light counts
  lightsOnCount: number;
  lightsOffCount: number;
  allLightsOn: boolean;
  allLightsOff: boolean;
  // Brightness
  avgBrightness: number;
  localBrightness: number | null;
  setLocalBrightness: (val: number | null) => void;
  // Dynamic styling
  dynamicRoomStyle: Record<string, string> | null;
  contrastMode: 'light' | 'dark' | 'default';
  adaptive: AdaptiveClasses;
  // Color support
  hasColorLights: boolean;
  // Loading state
  refreshing: boolean;
  // Callbacks
  onRoomToggle: (roomId: string | null | undefined, on: boolean) => void;
  onBrightnessChange: (roomId: string | null | undefined, brightness: string) => void;
  onNavigateToColors: () => void;
}
```

Renders (from LightsCard lines 958-1177):
- Dynamic color-styled container with `dynamicRoomStyle`
- ON badge (adaptive to background)
- Room name (if single light)
- Lights status summary (if multiple lights)
- On/Off buttons (mixed/all-on/all-off states with adaptive styling)
- Brightness control panel:
  - Brightness display value (localBrightness or avgBrightness)
  - Slider with commit-on-release pattern (onChange updates localBrightness, onValueCommit calls onBrightnessChange and resets localBrightness)
  - +/- ControlButtons for brightness steps
- Color control link (if hasColorLights)

**UI-local state allowed:** `localBrightness` and `setLocalBrightness` are passed as props from the orchestrator (managed in useLightsData hook). The slider's onChange updates localBrightness for smooth dragging, onValueCommit calls the API. This is the same pattern documented in research as "allowed slider local state".

**IMPORTANT:** The adaptive styling classes object (`adaptive`) is computed in useLightsData and passed as prop. The component uses `adaptive.heading`, `adaptive.buttonVariant`, `adaptive.buttonClass`, etc. to style elements based on room light colors.

**2. LightsScenes.tsx (~80 LOC)**

Extract from LightsCard.tsx lines 1179-1213.

Props interface:
```typescript
interface LightsScenesProps {
  roomScenes: any[];
  refreshing: boolean;
  onSceneActivate: (sceneId: string) => void;
}
```

Renders:
- Divider with "Scene" label
- Horizontal scroll container with snap-x
- Scene buttons: icon, name, onClick activates scene
- Scroll indicator text if >3 scenes

**Tests:**
- LightsRoomControl: Test render with room on/off, brightness slider commit-on-release pattern, adaptive styling application, color link visibility
- LightsScenes: Test render with scenes list, scene button click, scroll indicator for >3 scenes
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit app/components/devices/lights/components/LightsRoomControl.tsx app/components/devices/lights/components/LightsScenes.tsx`
- Tests pass: `npx jest __tests__/components/devices/lights/components/LightsRoomControl.test.tsx __tests__/components/devices/lights/components/LightsScenes.test.tsx --no-cache`
  </verify>
  <done>
LightsRoomControl renders the dynamic-styled room control area with brightness slider and adaptive styling. LightsScenes renders horizontal-scroll scene grid. Both are purely presentational with TypeScript props interfaces. Tests pass.
  </done>
</task>

</tasks>

<verification>
1. All component files compile: `npx tsc --noEmit app/components/devices/lights/components/*.tsx`
2. All tests pass: `npx jest __tests__/components/devices/lights/components/ --no-cache`
3. No component imports useAdaptivePolling, useRetryableCommand, or calls fetch()
4. No component has useState for business logic (localBrightness is UI-local, passed as prop from hook)
5. Each component has a TypeScript props interface
6. LightsCard.tsx is NOT modified yet (sub-components exist alongside, orchestrator wiring in Plan 03)
</verification>

<success_criteria>
- LightsBanners utility builds banner configs for all 9+ states (retry errors, pairing steps, connection error)
- LightsHouseControl renders whole-house on/off with 3 visual states
- LightsRoomControl renders dynamic-styled room controls with brightness slider and adaptive styling
- LightsScenes renders horizontal-scroll scene grid
- All components are presentational (props in -> UI out)
- All components have TypeScript props interfaces
- Tests pass for all components
</success_criteria>

<output>
After completion, create `.planning/phases/59-lightscard-page-refactoring/59-02-SUMMARY.md`
</output>
