---
phase: 60-critical-path-testing-token-cleanup
plan: 03
type: tdd
wave: 2
depends_on: ["60-01"]
files_modified:
  - lib/services/__tests__/tokenCleanupService.test.ts
autonomous: true

must_haves:
  truths:
    - "Token cleanup service has unit tests covering all code paths"
    - "Tests verify stale tokens (>90 days) are deleted"
    - "Tests verify active tokens (<90 days lastUsed) are preserved"
    - "Tests verify audit trail is logged to Firebase"
    - "Tests verify tokens with no timestamp are treated as stale"
    - "Tests verify error log cleanup (30-day retention)"
  artifacts:
    - path: "lib/services/__tests__/tokenCleanupService.test.ts"
      provides: "TDD tests for token cleanup service"
      contains: "describe.*cleanupStaleTokens"
  key_links:
    - from: "lib/services/__tests__/tokenCleanupService.test.ts"
      to: "lib/services/tokenCleanupService.ts"
      via: "import cleanupStaleTokens"
      pattern: "import.*cleanupStaleTokens.*tokenCleanupService"
---

<objective>
Create TDD unit tests for the token cleanup service extracted in Plan 01.

Purpose: TOKEN-02, TOKEN-03, TOKEN-04 require verified behavior: stale tokens deleted by delivery timestamp, active tokens preserved, audit trail logged. The extracted service is pure logic with Firebase as the only dependency, making it ideal for TDD. These tests validate the core token lifecycle requirements independently from the scheduler route.

Output: `lib/services/__tests__/tokenCleanupService.test.ts` with full coverage of cleanup logic.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/60-critical-path-testing-token-cleanup/60-01-SUMMARY.md
@lib/services/tokenCleanupService.ts
@lib/retry/__tests__/idempotencyManager.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TDD tests for cleanupStaleTokens</name>
  <files>lib/services/__tests__/tokenCleanupService.test.ts</files>
  <action>
Create `lib/services/__tests__/tokenCleanupService.test.ts` using TDD RED-GREEN-REFACTOR approach.

**Mock setup:**
```typescript
jest.mock('@/lib/firebaseAdmin');

import { cleanupStaleTokens } from '../tokenCleanupService';
import { getAdminDatabase, adminDbSet } from '@/lib/firebaseAdmin';

const mockAdminDbSet = jest.mocked(adminDbSet);
```

The key mock is `getAdminDatabase()` which returns a mock database object. Create a helper to build mock Firebase snapshots:

```typescript
function createMockDatabase(usersData: Record<string, any>, errorsData?: Record<string, any>) {
  const mockRef = jest.fn().mockImplementation((path: string) => ({
    once: jest.fn().mockImplementation(() => {
      if (path === 'users') {
        return Promise.resolve(createSnapshot(usersData));
      }
      if (path === 'notificationErrors') {
        return Promise.resolve(createSnapshot(errorsData || {}));
      }
      return Promise.resolve(createSnapshot({}));
    }),
    update: jest.fn().mockResolvedValue(undefined),
  }));

  jest.mocked(getAdminDatabase).mockReturnValue({ ref: mockRef } as any);
  return mockRef;
}

function createSnapshot(data: Record<string, any>) {
  const entries = Object.entries(data);
  return {
    exists: () => entries.length > 0,
    forEach: (callback: (snap: any) => void) => {
      entries.forEach(([key, value]) => {
        callback({
          key,
          val: () => value,
          child: (childPath: string) => ({
            val: () => {
              // Navigate nested path
              const parts = childPath.split('/');
              let current = value;
              for (const part of parts) {
                current = current?.[part];
              }
              return current ?? {};
            },
          }),
        });
      });
    },
  };
}
```

**Use fake timers** for deterministic time control:
```typescript
beforeEach(() => {
  jest.useFakeTimers();
  jest.setSystemTime(new Date('2026-02-13T12:00:00.000Z'));
  jest.clearAllMocks();
  jest.spyOn(console, 'log').mockImplementation(() => {});
  jest.spyOn(console, 'error').mockImplementation(() => {});
  mockAdminDbSet.mockResolvedValue(undefined as any);
});

afterEach(() => {
  jest.useRealTimers();
  jest.restoreAllMocks();
});
```

**Test cases:**

**`describe('cleanupStaleTokens')`:**

1. **`it('returns cleaned:true with zero removals when no users exist')`** — Empty users snapshot. Verify `{ cleaned: true, tokensRemoved: 0, tokensScanned: 0 }`.

2. **`it('preserves tokens with lastUsed within 90 days (TOKEN-04)')`** — User with token where `lastUsed: '2026-02-01T00:00:00Z'` (12 days ago). Verify `tokensRemoved: 0`, `tokensScanned: 1`. Verify NO update call to remove tokens.

3. **`it('deletes tokens with lastUsed older than 90 days (TOKEN-02)')`** — User with token where `lastUsed: '2025-10-01T00:00:00Z'` (135 days ago). Verify `tokensRemoved: 1`, verify `db.ref().update()` called with `null` for that token path.

4. **`it('uses createdAt as fallback when lastUsed is missing')`** — Token with only `createdAt: '2025-08-01T00:00:00Z'`. Verify token is deleted (old enough).

5. **`it('deletes tokens with no timestamp at all')`** — Token with neither `lastUsed` nor `createdAt`. Verify deleted.

6. **`it('handles multiple users with mixed token states')`** — User A has 2 tokens (1 stale, 1 active), User B has 1 stale token. Verify `tokensScanned: 3`, `tokensRemoved: 2`, active token preserved.

7. **`it('logs audit trail to Firebase tokenCleanupHistory (TOKEN-03)')`** — After cleanup with deletions, verify `adminDbSet` called with path matching `tokenCleanupHistory/` and data containing `{ timestamp, tokensScanned, tokensRemoved, deletedTokens: [...] }`. Verify `deletedTokens` array contains `userId`, `tokenKey`, `ageDays`.

8. **`it('cleans up error logs older than 30 days')`** — Add error entries: one from 45 days ago, one from 5 days ago. Verify only the 45-day-old error is deleted.

9. **`it('preserves recent error logs')`** — Error from 5 days ago. Verify not deleted.

10. **`it('returns cleaned:false with reason when exception occurs')`** — Mock `getAdminDatabase` to throw. Verify `{ cleaned: false, reason: 'exception', error: 'error message' }`.

11. **`it('performs batch update for multiple token deletions')`** — 3 stale tokens across 2 users. Verify single `db.ref().update()` call with all 3 paths set to `null`.

12. **`it('does not call update when no tokens need removal')`** — All tokens active. Verify `update()` not called for token paths.

**Run tests after writing each group** to verify RED-GREEN cycle. Since we're testing an already-implemented service (from Plan 01), the tests should pass immediately (GREEN). If any fail, adjust test expectations to match actual implementation.
  </action>
  <verify>
Run: `npx jest lib/services/__tests__/tokenCleanupService.test.ts --no-coverage`
All tests pass.
Then: `npx jest lib/services/__tests__/tokenCleanupService.test.ts --coverage --collectCoverageFrom='lib/services/tokenCleanupService.ts'`
Verify branch coverage > 80%.
  </verify>
  <done>
- Token cleanup service has 12+ test cases covering all code paths
- Stale token deletion verified (>90 days by lastUsed)
- Active token preservation verified (<90 days by lastUsed)
- Audit trail logging verified (tokenCleanupHistory path)
- Tokens with no timestamp treated as stale
- Error log cleanup verified (30-day retention)
- Exception handling verified
- All tests pass
  </done>
</task>

</tasks>

<verification>
1. `npx jest lib/services/__tests__/tokenCleanupService.test.ts --no-coverage` — all tests pass
2. Test file covers all code paths: stale detection, active preservation, audit trail, error handling
3. Coverage report shows high branch coverage on tokenCleanupService.ts
</verification>

<success_criteria>
- Token cleanup service test file exists with 12+ test cases
- All TOKEN requirements validated: staleness by delivery timestamp, active preservation, audit trail
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/60-critical-path-testing-token-cleanup/60-03-SUMMARY.md`
</output>
