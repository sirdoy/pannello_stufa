---
phase: 62-dashboard-card
plan: 02
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - app/components/devices/network/components/NetworkStatusBar.tsx
  - app/components/devices/network/components/NetworkBandwidth.tsx
  - app/components/devices/network/components/NetworkInfo.tsx
  - app/components/devices/network/NetworkCard.tsx
  - app/components/ui/Skeleton.tsx
  - app/page.tsx
  - app/components/devices/network/__tests__/NetworkCard.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees NetworkCard on dashboard with WAN online/offline full-width colored status bar at top"
    - "User sees bandwidth hero numbers (download/upload in Mbps) with mini sparkline trends"
    - "User sees connected device count in secondary info section"
    - "User sees network health indicator (excellent/good/degraded/poor)"
    - "User can click NetworkCard to navigate to /network page"
    - "User sees card-shaped skeleton during initial load"
    - "User sees stale indicator with 'Last updated X min ago' when Fritz!Box unreachable"
    - "NetworkCard uses sage (green/teal) color theme, distinct from other device cards"
  artifacts:
    - path: "app/components/devices/network/components/NetworkStatusBar.tsx"
      provides: "Full-width WAN status bar (green online, red offline)"
      min_lines: 20
    - path: "app/components/devices/network/components/NetworkBandwidth.tsx"
      provides: "Hero bandwidth numbers with Recharts sparklines"
      min_lines: 40
    - path: "app/components/devices/network/components/NetworkInfo.tsx"
      provides: "InfoBox grid with device count, uptime, health"
      min_lines: 20
    - path: "app/components/devices/network/NetworkCard.tsx"
      provides: "Orchestrator component assembling hooks + sub-components"
      exports: ["default"]
      min_lines: 40
    - path: "app/components/devices/network/__tests__/NetworkCard.test.tsx"
      provides: "Integration tests for NetworkCard rendering"
      min_lines: 60
  key_links:
    - from: "app/components/devices/network/NetworkCard.tsx"
      to: "app/components/devices/network/hooks/useNetworkData.ts"
      via: "import useNetworkData"
      pattern: "useNetworkData"
    - from: "app/components/devices/network/NetworkCard.tsx"
      to: "app/components/devices/network/hooks/useNetworkCommands.ts"
      via: "import useNetworkCommands"
      pattern: "useNetworkCommands"
    - from: "app/page.tsx"
      to: "app/components/devices/network/NetworkCard.tsx"
      via: "CARD_COMPONENTS registry"
      pattern: "network.*NetworkCard"
    - from: "app/components/devices/network/components/NetworkBandwidth.tsx"
      to: "recharts"
      via: "AreaChart import"
      pattern: "AreaChart|ResponsiveContainer"
---

<objective>
Create the NetworkCard UI: 3 presentational sub-components (NetworkStatusBar, NetworkBandwidth, NetworkInfo), the NetworkCard orchestrator, a Skeleton.NetworkCard variant, and integrate into the dashboard page.

Purpose: Delivers the user-facing NetworkCard with all visual elements per locked decisions: full-width WAN status bar, hero bandwidth numbers with sparklines, device count, health indicator, and clickable navigation to /network.

Output: Fully functional NetworkCard visible on the dashboard, following orchestrator pattern and green/teal (sage) theme.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-dashboard-card/62-RESEARCH.md
@.planning/phases/62-dashboard-card/62-01-SUMMARY.md

# Reference patterns (read these for implementation guidance)
@app/components/devices/stove/StoveCard.tsx
@app/components/devices/lights/LightsCard.tsx
@app/components/weather/WeatherCard.tsx
@app/components/ui/DeviceCard.tsx
@app/components/ui/SmartHomeCard.tsx
@app/components/ui/Skeleton.tsx
@app/components/ui/InfoBox.tsx
@app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create presentational sub-components and Skeleton</name>
  <files>
    app/components/devices/network/components/NetworkStatusBar.tsx
    app/components/devices/network/components/NetworkBandwidth.tsx
    app/components/devices/network/components/NetworkInfo.tsx
    app/components/ui/Skeleton.tsx
  </files>
  <action>
All three sub-components are PURE presentational (no state, no effects, no hooks). They receive props and render UI only. Use `'use client'` directive since they use client-side rendering context.

**NetworkStatusBar.tsx** ‚Äî Full-width WAN status bar (LOCKED DECISION: prominent full-width colored status bar at top):

Props:
```typescript
interface NetworkStatusBarProps {
  connected: boolean;
  stale: boolean;
  lastUpdated: number | null;
}
```

Implementation:
- Full-width bar at the top of the card content (before other sections)
- Green background when connected (`bg-emerald-500/20 border-emerald-500/30`), red when disconnected (`bg-red-500/20 border-red-500/30`)
- Left side: status icon (wifi/wifi-off from lucide-react) + text "Online" / "Offline"
- Right side: if stale, show "Aggiornato X min fa" using `formatDistanceToNow` from date-fns with Italian locale (`it`)
- Rounded corners, padding p-3, text-sm
- When disconnected, add subtle pulse animation on the icon

**NetworkBandwidth.tsx** ‚Äî Hero bandwidth display with sparklines (LOCKED DECISION: hero element, two big numbers, mini sparkline):

Props:
```typescript
interface NetworkBandwidthProps {
  bandwidth: BandwidthData | null;
  downloadHistory: SparklinePoint[];
  uploadHistory: SparklinePoint[];
}
```

Implementation:
- Two columns side by side (grid grid-cols-2 gap-4)
- Each column: large number (text-3xl font-bold), unit label "Mbps" (text-xs text-slate-400), direction label (Scaricamento/Caricamento)
- Below each number: mini sparkline using Recharts `AreaChart` inside `ResponsiveContainer`
  - Height: 40px
  - Download sparkline: emerald-400 stroke, emerald gradient fill
  - Upload sparkline: teal-400 stroke, teal gradient fill
  - No axes, no grid, no dots, no animation (`isAnimationActive={false}`)
  - `margin={{ top: 2, right: 0, bottom: 0, left: 0 }}`
  - Use unique gradient IDs to avoid SVG conflicts (e.g., `gradient-download-${useId()}`)
- If bandwidth is null: show "--" for numbers, no sparklines
- Unique gradient IDs: use React `useId()` hook for unique SVG gradient IDs

**NetworkInfo.tsx** ‚Äî Secondary info grid:

Props:
```typescript
interface NetworkInfoProps {
  activeDeviceCount: number;
  wan: WanData | null;
  health: NetworkHealthStatus;
}
```

Implementation:
- Grid layout: `grid grid-cols-3 gap-2.5`
- Use `InfoBox` component from design system (import from `@/app/components/ui`):
  1. InfoBox: icon="üì±", label="Dispositivi", value=activeDeviceCount, variant="sage"
  2. InfoBox: icon="üì∂", label="Salute", value=health label in Italian (Eccellente/Buona/Degradata/Scarsa)
  3. InfoBox: icon="‚è±Ô∏è", label="Uptime", value=formatted uptime (e.g., "2g 5h" for 2 days 5 hours, "3h 15m" for hours+minutes)
- Health label color: excellent=emerald, good=teal, degraded=amber, poor=red (via InfoBox valueColor prop or inline style)
- Uptime formatter: convert seconds to human-readable Italian format

**Skeleton.tsx** ‚Äî Add `Skeleton.NetworkCard` function:

Add to existing Skeleton.tsx file (which already has StovePanel, LightsCard, WeatherCard patterns). Follow the existing pattern structure.

```typescript
Skeleton.NetworkCard = function SkeletonNetworkCard() {
  return (
    <Card variant="elevated" padding={false} className="overflow-visible">
      <CardAccentBar colorTheme="sage" size="md" />
      <div className="p-5 sm:p-6">
        {/* Header skeleton */}
        <div className="flex items-center gap-3 mb-4">
          <SkeletonPulse className="w-8 h-8 rounded-lg" />
          <SkeletonPulse className="w-24 h-6 rounded" />
        </div>
        {/* Status bar skeleton */}
        <SkeletonPulse className="w-full h-10 rounded-lg mb-4" />
        {/* Bandwidth hero skeleton */}
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <SkeletonPulse className="w-20 h-8 rounded mb-2" />
            <SkeletonPulse className="w-full h-10 rounded" />
          </div>
          <div>
            <SkeletonPulse className="w-20 h-8 rounded mb-2" />
            <SkeletonPulse className="w-full h-10 rounded" />
          </div>
        </div>
        {/* Info boxes skeleton */}
        <div className="grid grid-cols-3 gap-2.5">
          <SkeletonPulse className="h-16 rounded-lg" />
          <SkeletonPulse className="h-16 rounded-lg" />
          <SkeletonPulse className="h-16 rounded-lg" />
        </div>
      </div>
    </Card>
  );
};
```

Follow the exact internal component naming pattern from existing skeletons. Import Card, CardAccentBar from the same module scope. Check how SkeletonPulse is defined in the existing Skeleton.tsx and use the same approach.
  </action>
  <verify>
Run `npx tsc --noEmit` on the new component files ‚Äî no type errors.
Visually inspect that components import from correct design system paths.
Check Skeleton.NetworkCard follows existing Skeleton.StovePanel/LightsCard/WeatherCard patterns.
  </verify>
  <done>
Three presentational sub-components (NetworkStatusBar, NetworkBandwidth, NetworkInfo) render all visual sections. Skeleton.NetworkCard provides loading state. All are pure presentational ‚Äî no state, no effects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NetworkCard orchestrator and integrate into dashboard</name>
  <files>
    app/components/devices/network/NetworkCard.tsx
    app/page.tsx
    app/components/devices/network/__tests__/NetworkCard.test.tsx
  </files>
  <action>
**NetworkCard.tsx** ‚Äî Orchestrator component following StoveCard/LightsCard pattern:

```typescript
'use client';

import { useRouter } from 'next/navigation';
import Skeleton from '../../ui/Skeleton';
import { SmartHomeCard, Badge, HealthIndicator } from '../../ui';
import { Heading } from '../../ui';
import CardAccentBar from '../../ui/CardAccentBar';
import Card from '../../ui/Card';
import { useNetworkData } from './hooks/useNetworkData';
import { useNetworkCommands } from './hooks/useNetworkCommands';
import NetworkStatusBar from './components/NetworkStatusBar';
import NetworkBandwidth from './components/NetworkBandwidth';
import NetworkInfo from './components/NetworkInfo';
```

Architecture:
1. Call `useNetworkData()` ‚Äî all state management
2. Call `useNetworkCommands({ router })` ‚Äî navigation
3. If `loading`, return `<Skeleton.NetworkCard />`
4. If `error?.type === 'setup'` (Fritz!Box not configured / TR-064 disabled): show a setup banner inside the card with message and guide link
5. Render using `SmartHomeCard` wrapper with `colorTheme="sage"`:

```tsx
export default function NetworkCard() {
  const router = useRouter();
  const networkData = useNetworkData();
  const commands = useNetworkCommands({ router });

  if (networkData.loading) {
    return <Skeleton.NetworkCard />;
  }

  // First-time use / TR-064 not enabled: show setup card
  if (networkData.error?.type === 'setup') {
    return (
      <SmartHomeCard icon="üì°" title="Rete" colorTheme="sage">
        <SmartHomeCard.Controls>
          <Banner variant="info" title="Configura Fritz!Box" ... />
        </SmartHomeCard.Controls>
      </SmartHomeCard>
    );
  }

  return (
    <div
      onClick={commands.navigateToNetwork}
      className="cursor-pointer transition-transform hover:scale-[1.01] active:scale-[0.99]"
      role="link"
      tabIndex={0}
      onKeyDown={(e) => e.key === 'Enter' && commands.navigateToNetwork()}
      aria-label="Vai alla pagina Rete"
    >
      <SmartHomeCard
        icon="üì°"
        title="Rete"
        colorTheme="sage"
        headerActions={
          <HealthIndicator
            status={networkData.healthMapped}
            size="sm"
            showIcon={true}
            label=""
          />
        }
      >
        {/* WAN Status Bar ‚Äî full width at top (LOCKED DECISION) */}
        <NetworkStatusBar
          connected={networkData.connected}
          stale={networkData.stale}
          lastUpdated={networkData.lastUpdated}
        />

        {/* Bandwidth Hero ‚Äî two big numbers + sparklines (LOCKED DECISION) */}
        <SmartHomeCard.Controls>
          <NetworkBandwidth
            bandwidth={networkData.bandwidth}
            downloadHistory={networkData.downloadHistory}
            uploadHistory={networkData.uploadHistory}
          />
        </SmartHomeCard.Controls>

        {/* Secondary Info ‚Äî device count, health, uptime */}
        <div className="mt-4">
          <NetworkInfo
            activeDeviceCount={networkData.activeDeviceCount}
            wan={networkData.wan}
            health={networkData.health}
          />
        </div>
      </SmartHomeCard>
    </div>
  );
}
```

Key details:
- Entire card is clickable (LOCKED DECISION: navigates to /network)
- Wrap in div with onClick, cursor-pointer, hover scale, keyboard accessible (role="link", tabIndex, onKeyDown)
- HealthIndicator in header actions area (right side of header)
- Status bar before controls section
- Bandwidth is the hero (LOCKED DECISION: primary visual element)
- Info grid below bandwidth

**app/page.tsx** ‚Äî Add NetworkCard to dashboard:

1. Add import: `import NetworkCard from './components/devices/network/NetworkCard';`
2. Add to CARD_COMPONENTS: `network: NetworkCard,`
3. Add to DEVICE_META: `network: { name: 'Rete', icon: 'üì°' },`

Note: 'network' is already in DEFAULT_DEVICE_ORDER in deviceTypes.ts (added in Phase 61), so it will appear in the dashboard grid automatically for users with default config.

**Tests ‚Äî NetworkCard.test.tsx:**

Mock modules:
- `./hooks/useNetworkData` ‚Äî return controlled mock data
- `./hooks/useNetworkCommands` ‚Äî return mock navigateToNetwork
- `next/navigation` ‚Äî mock useRouter
- `recharts` ‚Äî mock ResponsiveContainer and AreaChart (return simple divs)

Test cases:
1. **Shows skeleton when loading:** Mock useNetworkData with loading=true ‚Üí renders Skeleton.NetworkCard
2. **Shows setup banner when error.type='setup':** Mock with setup error ‚Üí renders "Configura Fritz!Box" text
3. **Displays WAN online status bar:** Mock with connected=true ‚Üí green status bar with "Online" text
4. **Displays WAN offline status bar:** Mock with connected=false ‚Üí red status bar with "Offline" text
5. **Displays bandwidth hero numbers:** Mock with bandwidth { download: 45.2, upload: 12.8 } ‚Üí renders "45.2" and "12.8" text
6. **Displays active device count:** Mock with activeDeviceCount=7 ‚Üí renders "7" in info section
7. **Displays health indicator:** Mock with healthMapped='ok' ‚Üí HealthIndicator rendered
8. **Shows stale indicator:** Mock with stale=true, lastUpdated=past timestamp ‚Üí renders "Aggiornato" text
9. **Handles click navigation:** Click card ‚Üí navigateToNetwork called
10. **Handles keyboard navigation:** Press Enter ‚Üí navigateToNetwork called
11. **Shows dashes when bandwidth is null:** Mock with bandwidth=null ‚Üí renders "--"
  </action>
  <verify>
Run `npx jest app/components/devices/network/__tests__/NetworkCard.test.tsx --no-coverage` ‚Äî all tests pass.
Run `npx tsc --noEmit app/components/devices/network/NetworkCard.tsx app/page.tsx` ‚Äî no type errors.
Check app/page.tsx has network entry in both CARD_COMPONENTS and DEVICE_META.
  </verify>
  <done>
NetworkCard orchestrator assembles hooks and sub-components. Dashboard page registers NetworkCard in CARD_COMPONENTS and DEVICE_META. Card is clickable, shows sage theme, displays all required data sections. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx jest app/components/devices/network/__tests__/ --no-coverage` ‚Äî all tests pass (hooks + components)
2. `npx tsc --noEmit` ‚Äî no type errors across all new and modified files
3. Dashboard page (app/page.tsx) includes network in CARD_COMPONENTS and DEVICE_META
4. Skeleton.NetworkCard exists in Skeleton.tsx
5. NetworkCard uses sage colorTheme (green/teal ‚Äî LOCKED DECISION)
6. WAN status bar is full-width at top of card (LOCKED DECISION)
7. Bandwidth numbers are the hero element (LOCKED DECISION)
8. Card is clickable and navigates to /network (LOCKED DECISION)
9. Stale indicator shows "Last updated X min ago" when Fritz!Box unreachable (LOCKED DECISION)
10. Loading state shows card-shaped skeleton (LOCKED DECISION)
</verification>

<success_criteria>
- NetworkCard renders on dashboard with sage (green/teal) theme
- Full-width WAN status bar at top: green when online, red when offline
- Hero bandwidth numbers (download/upload Mbps) with mini sparklines
- InfoBox grid showing device count, health, uptime
- HealthIndicator in card header
- Click anywhere on card navigates to /network
- Skeleton during initial load
- Stale indicator when data is old
- Setup banner when Fritz!Box not configured
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/62-dashboard-card/62-02-SUMMARY.md`
</output>
