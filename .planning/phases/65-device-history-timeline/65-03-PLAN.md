---
phase: 65-device-history-timeline
plan: 03
type: execute
wave: 2
depends_on: ["65-01"]
files_modified:
  - app/network/hooks/useDeviceHistory.ts
  - app/network/hooks/__tests__/useDeviceHistory.test.ts
  - app/network/components/DeviceHistoryTimeline.tsx
  - app/network/components/DeviceEventItem.tsx
  - app/network/__tests__/components/DeviceHistoryTimeline.test.tsx
  - app/network/page.tsx
  - app/network/__tests__/page.test.tsx
autonomous: true

must_haves:
  truths:
    - "User sees device connection/disconnection events as a chronological timeline"
    - "User can filter history to show events for a specific device"
    - "Timeline shows last 24h by default with option to expand to 7-day view"
    - "Events are grouped by date with Italian locale date headers"
    - "Connected events show green indicator, disconnected show neutral"
  artifacts:
    - path: "app/network/hooks/useDeviceHistory.ts"
      provides: "Hook for fetching and filtering device history events"
      exports: ["useDeviceHistory"]
    - path: "app/network/components/DeviceHistoryTimeline.tsx"
      provides: "Timeline component with date-grouped events"
      exports: ["default"]
    - path: "app/network/components/DeviceEventItem.tsx"
      provides: "Single event row with status badge and timestamp"
      exports: ["default"]
    - path: "app/network/page.tsx"
      provides: "Network page with timeline section integrated"
      contains: "DeviceHistoryTimeline"
  key_links:
    - from: "app/network/hooks/useDeviceHistory.ts"
      to: "/api/fritzbox/history"
      via: "fetch call with range and device params"
      pattern: "api/fritzbox/history"
    - from: "app/network/page.tsx"
      to: "app/network/components/DeviceHistoryTimeline.tsx"
      via: "component import and render"
      pattern: "DeviceHistoryTimeline"
    - from: "app/network/page.tsx"
      to: "app/network/hooks/useDeviceHistory.ts"
      via: "hook usage for data fetching"
      pattern: "useDeviceHistory"
---

<objective>
Build the timeline UI: useDeviceHistory hook, DeviceHistoryTimeline component with date grouping, DeviceEventItem component, device filter dropdown, and integrate into the /network page.

Purpose: This is the user-facing layer. Users see a vertical timeline of device connection/disconnection events, grouped by date with Italian locale headers. They can filter by device and change time range using the existing TimeRangeSelector pattern.

Output: Complete timeline section on the /network page with device history visualization and filtering.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-device-history-timeline/65-RESEARCH.md
@.planning/phases/65-device-history-timeline/65-01-SUMMARY.md

@app/network/page.tsx
@app/network/hooks/useBandwidthHistory.ts
@app/network/components/TimeRangeSelector.tsx
@app/network/components/BandwidthChart.tsx
@app/components/devices/network/types.ts
@app/components/ui/Select.tsx
@app/components/ui/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDeviceHistory hook, DeviceEventItem, and DeviceHistoryTimeline components</name>
  <files>
    app/network/hooks/useDeviceHistory.ts
    app/network/hooks/__tests__/useDeviceHistory.test.ts
    app/network/components/DeviceEventItem.tsx
    app/network/components/DeviceHistoryTimeline.tsx
    app/network/__tests__/components/DeviceHistoryTimeline.test.tsx
  </files>
  <action>
    **1. Create `app/network/hooks/useDeviceHistory.ts`:**

    Hook that fetches device history from `/api/fritzbox/history` endpoint.

    State:
    - `events: DeviceEvent[]` (from network types)
    - `timeRange: DeviceHistoryTimeRange` (default: `'24h'`)
    - `deviceFilter: string | null` (MAC address or null for all)
    - `isLoading: boolean` (true initially)

    `fetchEvents` callback:
    - Build URLSearchParams with `range` (always) and `device` (if set)
    - Fetch from `/api/fritzbox/history?${params}`
    - Parse response, check `data.success`, set events from `data.data.events`
    - Wrap in try/catch, set isLoading false in finally

    useEffect triggers `fetchEvents` when `timeRange` or `deviceFilter` changes.

    Return: `{ events, timeRange, setTimeRange, deviceFilter, setDeviceFilter, isLoading, isEmpty: events.length === 0, refresh: fetchEvents }`

    **2. Create `app/network/components/DeviceEventItem.tsx`:**

    Presentational component for a single timeline event.

    Props: `{ event: DeviceEvent }`

    Layout:
    - Horizontal flex row with gap-3
    - Left: Timeline dot (2x2 rounded-full). Green (`bg-sage-400`) for connected, neutral (`bg-slate-500`) for disconnected
    - Center: Device name (Text size sm, font-medium) + Badge (`variant="sage"` for connected, `variant="neutral"` for disconnected) showing "Connesso" / "Disconnesso"
    - Below name: Device IP (Text variant secondary, size xs, font-mono) + Time formatted as HH:mm:ss (date-fns `format`) + Relative time (date-fns `formatDistanceToNow` with `{ addSuffix: true, locale: it }`)

    Import `it` from `date-fns/locale/it` for Italian locale.

    **3. Create `app/network/components/DeviceHistoryTimeline.tsx`:**

    Container component that groups events by date and renders timeline.

    Props:
    ```typescript
    interface DeviceHistoryTimelineProps {
      events: DeviceEvent[];
      isLoading: boolean;
      isEmpty: boolean;
      timeRange: DeviceHistoryTimeRange;
      onTimeRangeChange: (range: DeviceHistoryTimeRange) => void;
      deviceFilter: string | null;
      onDeviceFilterChange: (mac: string | null) => void;
      devices: DeviceData[]; // For device filter dropdown
    }
    ```

    Layout:
    - Card variant="elevated" wrapper with p-4 sm:p-6
    - Header: Heading level 2 "Cronologia Dispositivi" + flex row with TimeRangeSelector (reuse from Phase 64 BUT create a local generic version that accepts DeviceHistoryTimeRange) + device filter Select dropdown
    - Device filter: Use design system Select component with options: `[{ value: 'all', label: 'Tutti i dispositivi' }, ...devices.map(d => ({ value: d.mac, label: d.name }))]`. On change, set filter to null if 'all' selected, otherwise the MAC value.
    - Loading state: Show "Caricamento cronologia..." text
    - Empty state: Show "Nessun evento nel periodo selezionato" centered text
    - Events: Group by date using `useMemo`. For each date group:
      - Sticky date header with Italian locale (date-fns `format` with `'EEEE, d MMMM yyyy'` and `{ locale: it }`)
      - Vertical timeline line: `pl-6 border-l-2 border-white/10`
      - Map events to DeviceEventItem components

    **Important:** The TimeRangeSelector from Phase 64 is typed to `BandwidthTimeRange`. Since `DeviceHistoryTimeRange` has the same values (`'1h' | '24h' | '7d'`), reuse the SAME TimeRangeSelector component by casting: `value={timeRange as BandwidthTimeRange}` and `onChange={(range) => onTimeRangeChange(range as DeviceHistoryTimeRange)}`. This avoids creating a duplicate component. Both types have identical values - they are structurally compatible.

    **4. Tests:**

    `app/network/hooks/__tests__/useDeviceHistory.test.ts`:
    - Mock global fetch
    - Test: initial fetch on mount calls /api/fritzbox/history?range=24h
    - Test: changing timeRange triggers re-fetch with new range param
    - Test: setting deviceFilter triggers re-fetch with device param
    - Test: failed fetch sets isLoading false, events empty
    - Test: isEmpty is true when events array empty

    `app/network/__tests__/components/DeviceHistoryTimeline.test.tsx`:
    - Test: renders loading state when isLoading=true
    - Test: renders empty state when isEmpty=true
    - Test: renders events grouped by date
    - Test: renders device filter dropdown with device names
    - Test: connected events show "Connesso" badge
    - Test: disconnected events show "Disconnesso" badge
  </action>
  <verify>
    ```bash
    npx jest app/network/hooks/__tests__/useDeviceHistory.test.ts app/network/__tests__/components/DeviceHistoryTimeline.test.tsx --verbose
    npx tsc --noEmit --project tsconfig.json 2>&1 | head -20
    ```
  </verify>
  <done>
    useDeviceHistory hook fetches and filters events. DeviceHistoryTimeline renders date-grouped events with Italian locale. DeviceEventItem shows status badges. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate DeviceHistoryTimeline into /network page</name>
  <files>
    app/network/page.tsx
    app/network/__tests__/page.test.tsx
  </files>
  <action>
    Modify `app/network/page.tsx` to add the timeline section:

    1. Import `useDeviceHistory` from `./hooks/useDeviceHistory`
    2. Import `DeviceHistoryTimeline` from `./components/DeviceHistoryTimeline`
    3. Add `const deviceHistory = useDeviceHistory();` in the component body
    4. Add timeline section BELOW the BandwidthChart in the page layout:

    ```tsx
    {/* Device History Timeline - below bandwidth chart */}
    <DeviceHistoryTimeline
      events={deviceHistory.events}
      isLoading={deviceHistory.isLoading}
      isEmpty={deviceHistory.isEmpty}
      timeRange={deviceHistory.timeRange}
      onTimeRangeChange={deviceHistory.setTimeRange}
      deviceFilter={deviceHistory.deviceFilter}
      onDeviceFilterChange={deviceHistory.setDeviceFilter}
      devices={networkData.devices}
    />
    ```

    The `devices` prop comes from `networkData.devices` (already available from useNetworkData hook) to populate the device filter dropdown.

    5. Add a skeleton placeholder in the loading guard for the timeline:
    ```tsx
    <Skeleton className="h-[300px] rounded-2xl" />
    ```

    Update `app/network/__tests__/page.test.tsx`:
    - Mock `./hooks/useDeviceHistory` module
    - Add mock return value matching useDeviceHistory interface
    - Test: DeviceHistoryTimeline renders on page
    - Test: DeviceHistoryTimeline receives correct props from hooks
    - Ensure existing page tests still pass (WanStatusCard, DeviceListTable, BandwidthChart)
  </action>
  <verify>
    ```bash
    npx jest app/network/__tests__/page.test.tsx --verbose
    npx tsc --noEmit --project tsconfig.json 2>&1 | head -20
    ```
  </verify>
  <done>
    DeviceHistoryTimeline integrated into /network page below BandwidthChart. Device filter populated from useNetworkData devices. Loading skeleton added. All page tests pass including existing ones.
  </done>
</task>

</tasks>

<verification>
```bash
npx jest app/network/ --verbose
npx tsc --noEmit --project tsconfig.json 2>&1 | head -20
```
</verification>

<success_criteria>
- DeviceHistoryTimeline visible on /network page below bandwidth chart
- Events grouped by date with Italian locale headers (EEEE, d MMMM yyyy)
- Connected events show green dot + "Connesso" badge
- Disconnected events show neutral dot + "Disconnesso" badge
- Device filter dropdown populated with device names from useNetworkData
- TimeRangeSelector controls time range (1h, 24h, 7d) with 24h default
- Loading and empty states display appropriate Italian messages
- All tests pass, zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/65-device-history-timeline/65-03-SUMMARY.md`
</output>
