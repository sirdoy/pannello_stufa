---
phase: 67-bandwidth-correlation
plan: 02
type: execute
wave: 2
depends_on: ["67-01"]
files_modified:
  - app/network/components/BandwidthCorrelationChart.tsx
  - app/network/components/CorrelationInsight.tsx
  - app/network/components/__tests__/BandwidthCorrelationChart.test.tsx
  - app/network/components/__tests__/CorrelationInsight.test.tsx
  - app/network/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees dual y-axis chart with bandwidth (left, Mbps) and power level (right, 1-5) on same timeline"
    - "Correlation chart and insight text only render when canTrackAnalytics() returns true"
    - "User sees Italian insight text explaining correlation strength (e.g., 'Correlazione forte negativa...')"
    - "User sees 'Stufa spenta' message when stove is off (no correlation data)"
    - "User sees 'Raccolta dati' progress when fewer than 30 paired points"
    - "Stove power level data is fetched independently via /api/stove/getPower endpoint"
  artifacts:
    - path: "app/network/components/BandwidthCorrelationChart.tsx"
      provides: "Dual y-axis ComposedChart with bandwidth line and power level line"
      min_lines: 80
    - path: "app/network/components/CorrelationInsight.tsx"
      provides: "Insight text display with coefficient and level indicator"
      min_lines: 30
    - path: "app/network/page.tsx"
      provides: "Updated orchestrator wiring correlation hook + consent gate"
      contains: "canTrackAnalytics"
  key_links:
    - from: "app/network/page.tsx"
      to: "app/network/hooks/useBandwidthCorrelation.ts"
      via: "import and invoke hook"
      pattern: "useBandwidthCorrelation"
    - from: "app/network/page.tsx"
      to: "lib/analyticsConsentService.ts"
      via: "import canTrackAnalytics"
      pattern: "canTrackAnalytics"
    - from: "app/network/page.tsx"
      to: "app/network/components/BandwidthCorrelationChart.tsx"
      via: "conditional render"
      pattern: "BandwidthCorrelationChart"
    - from: "app/network/page.tsx"
      to: "/api/stove/getPower"
      via: "fetch in useEffect for stove power level"
      pattern: "stove/getPower"
---

<objective>
Create the presentational components (dual y-axis chart + insight text) and wire them into the network page orchestrator with analytics consent gating. The page fetches stove power level independently and feeds both bandwidth and power data into the correlation hook.

Purpose: Completes the user-facing correlation feature — chart, insight text, consent gate, and orchestrator wiring.
Output: Working correlation visualization on /network page behind consent gate.
</objective>

<execution_context>
@/Users/federicomanfredi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/federicomanfredi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-bandwidth-correlation/67-RESEARCH.md
@.planning/phases/67-bandwidth-correlation/67-01-SUMMARY.md

# Existing patterns to replicate
@app/components/analytics/WeatherCorrelation.tsx
@app/network/components/BandwidthChart.tsx
@app/network/page.tsx
@lib/analyticsConsentService.ts
@app/analytics/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: BandwidthCorrelationChart + CorrelationInsight components with tests</name>
  <files>
    app/network/components/BandwidthCorrelationChart.tsx
    app/network/components/CorrelationInsight.tsx
    app/network/components/__tests__/BandwidthCorrelationChart.test.tsx
    app/network/components/__tests__/CorrelationInsight.test.tsx
  </files>
  <action>
**BandwidthCorrelationChart.tsx** — Dual y-axis chart using Recharts ComposedChart:

Props interface:
```typescript
interface BandwidthCorrelationChartProps {
  data: CorrelationDataPoint[];
  status: CorrelationStatus;
  pointCount: number;
  minPoints: number;
}
```

Implementation (follow WeatherCorrelation.tsx + BandwidthChart.tsx patterns exactly):
- Outer wrapper: `<div className="bg-slate-800/30 [html:not(.dark)_&]:bg-white rounded-2xl p-6">`
- Header with `<Heading level={2} size="lg">Correlazione Banda-Stufa</Heading>`
- **Empty states** (render INSTEAD of chart):
  - status='stove-off': "Stufa spenta — correlazione non disponibile" (Text variant="secondary")
  - status='collecting': "Raccolta dati: {pointCount}/{minPoints} punti" (Text variant="secondary")
  - status='insufficient': "Dati insufficienti per la correlazione" (Text variant="tertiary")
- **Chart** (status='ready' and data.length > 0):
  - `<ResponsiveContainer width="100%" height={300}>`
  - `<ComposedChart>` with margin={{ top: 10, right: 30, left: 0, bottom: 0 }}
  - CartesianGrid with strokeDasharray="3 3", opacity-10
  - XAxis dataKey="time" with tickFormatter using format(timestamp, 'HH:mm') from date-fns
  - Left YAxis yAxisId="left": label "Banda (Mbps)", domain auto
  - Right YAxis yAxisId="right": label "Potenza", domain={[0, 6]} (power 1-5, with margin)
  - Line yAxisId="left" dataKey="bandwidth" stroke="rgb(52, 211, 153)" (emerald-400), dot=false, isAnimationActive=false, name="Banda (Mbps)"
  - Line yAxisId="right" dataKey="powerLevel" stroke="#ed6f10" (ember), strokeWidth=2, dot=false, isAnimationActive=false, name="Potenza stufa", type="stepAfter" (power level is discrete, step chart is more accurate)
  - Custom tooltip showing time (HH:mm:ss), bandwidth (Mbps), power level
  - Legend with wrapperStyle fontSize 12px, iconType="line"
- Tooltip styling: same dark theme pattern as BandwidthChart.tsx CustomTooltip
- Colors: emerald-400 for bandwidth (consistent with BandwidthChart), ember (#ed6f10) for power level

**CorrelationInsight.tsx** — Insight text display:

Props interface:
```typescript
interface CorrelationInsightProps {
  insight: CorrelationInsight | null;
  status: CorrelationStatus;
}
```

Implementation:
- If insight is null or status !== 'ready', return null (don't render)
- Outer wrapper: `<div className="bg-slate-800/30 [html:not(.dark)_&]:bg-white rounded-2xl p-4">`
- Show insight.description as Text component
- Show coefficient value: "Coefficiente di Pearson: {r.toFixed(2)}" as Text variant="tertiary" size="sm"
- Show data context: "Calcolato su {dataPointCount} misurazioni ({activeHours.toFixed(1)}h di stufa attiva)" as Text variant="tertiary" size="sm"
- Color-code the insight level:
  - strong-positive/moderate-positive: text-emerald-400
  - none: text-slate-400
  - moderate-negative/strong-negative: text-ember-500

**Tests:**

`BandwidthCorrelationChart.test.tsx`:
- Renders heading "Correlazione Banda-Stufa"
- Shows "Stufa spenta" text when status='stove-off'
- Shows collecting text with point count when status='collecting'
- Renders ResponsiveContainer when status='ready' with data
- Does not render chart when data is empty

`CorrelationInsight.test.tsx`:
- Returns null when insight is null
- Returns null when status is not 'ready'
- Shows insight description text
- Shows Pearson coefficient formatted to 2 decimal places
- Shows data point count and active hours
  </action>
  <verify>
Run `npm test -- --testPathPattern="(BandwidthCorrelationChart|CorrelationInsight)" --watchAll=false` — all tests pass.
  </verify>
  <done>
BandwidthCorrelationChart renders dual y-axis ComposedChart with bandwidth (emerald) and power level (ember) lines. CorrelationInsight displays Italian description, coefficient, and data context. Both have correct empty states. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire correlation into network page orchestrator with consent gate</name>
  <files>
    app/network/page.tsx
  </files>
  <action>
Update `app/network/page.tsx` to integrate the correlation feature:

**Imports to add:**
```typescript
import { useState, useEffect, useCallback } from 'react'; // add useState if not present
import { useBandwidthCorrelation } from './hooks/useBandwidthCorrelation';
import { canTrackAnalytics, getConsentState } from '@/lib/analyticsConsentService';
import BandwidthCorrelationChart from './components/BandwidthCorrelationChart';
import CorrelationInsight from './components/CorrelationInsight';
import { Card, Heading, Text } from '@/app/components/ui'; // add Card if not already
import { STOVE_ROUTES } from '@/lib/routes';
```

**Inside NetworkPage component, add:**

1. Consent state (SSR-safe pattern from analytics/page.tsx):
```typescript
const [hasConsent, setHasConsent] = useState(false);
useEffect(() => {
  setHasConsent(canTrackAnalytics());
}, []);
```

2. Correlation hook:
```typescript
const correlation = useBandwidthCorrelation();
```

3. Stove power level polling (lightweight, independent):
```typescript
const stovePowerRef = useRef<number | null>(null);

useEffect(() => {
  if (!hasConsent) return; // Don't poll stove if no analytics consent

  const fetchPower = async () => {
    try {
      const res = await fetch(STOVE_ROUTES.getPower);
      const json = await res.json();
      const level = json?.Result ?? null;
      stovePowerRef.current = level;
    } catch {
      // Stove may be unreachable — fire-and-forget
      stovePowerRef.current = null;
    }
  };

  // Initial fetch
  fetchPower();

  // Poll every 30s (aligned with network data polling)
  const interval = setInterval(fetchPower, 30000);
  return () => clearInterval(interval);
}, [hasConsent]);
```

4. Feed data into correlation hook when bandwidth updates:
```typescript
// Wire bandwidth + stove power → correlation hook (only with consent)
useEffect(() => {
  if (!hasConsent || !networkData.bandwidth) return;

  correlation.addDataPoint(
    networkData.bandwidth.download,
    stovePowerRef.current,
    networkData.bandwidth.timestamp
  );
}, [networkData.bandwidth, hasConsent]); // eslint-disable-line react-hooks/exhaustive-deps
```

5. Add correlation section to JSX (after BandwidthChart, before DeviceHistoryTimeline):
```tsx
{/* Bandwidth-Stove Correlation (Phase 67, consent-gated) */}
{hasConsent && (
  <>
    <BandwidthCorrelationChart
      data={correlation.chartData}
      status={correlation.status}
      pointCount={correlation.pointCount}
      minPoints={correlation.minPoints}
    />
    <CorrelationInsight
      insight={correlation.insight}
      status={correlation.status}
    />
  </>
)}

{/* Consent denied state (only if user explicitly denied) */}
{!hasConsent && getConsentState() === 'denied' && (
  <Card variant="glass" padding={true} className="text-center">
    <Text variant="secondary" size="sm">
      Correlazione banda-stufa disponibile con il consenso analytics
    </Text>
  </Card>
)}
```

**Important:** Add `useRef` to the import from 'react' if not already there. Add `STOVE_ROUTES` import from `@/lib/routes`. Do NOT import useStoveData (too heavy, requires checkVersion/userId).

The stove power polling is intentionally lightweight (single GET to /api/stove/getPower every 30s) and completely independent from the stove page's full polling loop. It only runs when analytics consent is granted.
  </action>
  <verify>
Run `npx tsc --noEmit` — no TypeScript errors.
Run `npm test -- --testPathPattern="network/page" --watchAll=false` — existing page tests still pass (new components are behind consent gate, won't affect existing test mocks).
  </verify>
  <done>
Network page orchestrator:
- Checks analytics consent on mount (SSR-safe)
- Polls stove power level independently (30s interval, only with consent)
- Feeds bandwidth + power data into correlation hook on each bandwidth update
- Renders BandwidthCorrelationChart and CorrelationInsight behind consent gate
- Shows "consent required" Card when analytics denied
- No breaking changes to existing components
  </done>
</task>

</tasks>

<verification>
```bash
# All correlation tests pass
npm test -- --testPathPattern="(pearsonCorrelation|useBandwidthCorrelation|BandwidthCorrelationChart|CorrelationInsight)" --watchAll=false

# Existing network page tests still pass
npm test -- --testPathPattern="network" --watchAll=false

# TypeScript compiles cleanly
npx tsc --noEmit
```
</verification>

<success_criteria>
- Dual y-axis chart renders bandwidth (emerald) and power level (ember) on shared timeline
- Correlation feature gated behind canTrackAnalytics() — never renders without consent
- Italian insight text shows correlation strength description
- Empty states: "Stufa spenta", "Raccolta dati X/30", "Dati insufficienti"
- Stove power polling is lightweight and independent (30s interval, fire-and-forget)
- All tests pass, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/67-bandwidth-correlation/67-02-SUMMARY.md`
</output>
